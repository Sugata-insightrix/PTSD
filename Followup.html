<!DOCTYPE html>

<html lang="en">
<head><meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Followup</title><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.1.10/require.min.js"></script>
<style type="text/css">
    pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.highlight .hll { background-color: var(--jp-cell-editor-active-background) }
.highlight { background: var(--jp-cell-editor-background); color: var(--jp-mirror-editor-variable-color) }
.highlight .c { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment */
.highlight .err { color: var(--jp-mirror-editor-error-color) } /* Error */
.highlight .k { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword */
.highlight .o { color: var(--jp-mirror-editor-operator-color); font-weight: bold } /* Operator */
.highlight .p { color: var(--jp-mirror-editor-punctuation-color) } /* Punctuation */
.highlight .ch { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Hashbang */
.highlight .cm { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Multiline */
.highlight .cp { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Preproc */
.highlight .cpf { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.PreprocFile */
.highlight .c1 { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Single */
.highlight .cs { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Special */
.highlight .kc { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Pseudo */
.highlight .kr { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Type */
.highlight .m { color: var(--jp-mirror-editor-number-color) } /* Literal.Number */
.highlight .s { color: var(--jp-mirror-editor-string-color) } /* Literal.String */
.highlight .ow { color: var(--jp-mirror-editor-operator-color); font-weight: bold } /* Operator.Word */
.highlight .pm { color: var(--jp-mirror-editor-punctuation-color) } /* Punctuation.Marker */
.highlight .w { color: var(--jp-mirror-editor-variable-color) } /* Text.Whitespace */
.highlight .mb { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Bin */
.highlight .mf { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Float */
.highlight .mh { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Hex */
.highlight .mi { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Integer */
.highlight .mo { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Oct */
.highlight .sa { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Affix */
.highlight .sb { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Backtick */
.highlight .sc { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Char */
.highlight .dl { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Delimiter */
.highlight .sd { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Doc */
.highlight .s2 { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Double */
.highlight .se { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Escape */
.highlight .sh { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Heredoc */
.highlight .si { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Interpol */
.highlight .sx { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Other */
.highlight .sr { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Regex */
.highlight .s1 { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Single */
.highlight .ss { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Symbol */
.highlight .il { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Integer.Long */
  </style>
<style type="text/css">
/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/*
 * Mozilla scrollbar styling
 */

/* use standard opaque scrollbars for most nodes */
[data-jp-theme-scrollbars='true'] {
  scrollbar-color: rgb(var(--jp-scrollbar-thumb-color))
    var(--jp-scrollbar-background-color);
}

/* for code nodes, use a transparent style of scrollbar. These selectors
 * will match lower in the tree, and so will override the above */
[data-jp-theme-scrollbars='true'] .CodeMirror-hscrollbar,
[data-jp-theme-scrollbars='true'] .CodeMirror-vscrollbar {
  scrollbar-color: rgba(var(--jp-scrollbar-thumb-color), 0.5) transparent;
}

/* tiny scrollbar */

.jp-scrollbar-tiny {
  scrollbar-color: rgba(var(--jp-scrollbar-thumb-color), 0.5) transparent;
  scrollbar-width: thin;
}

/* tiny scrollbar */

.jp-scrollbar-tiny::-webkit-scrollbar,
.jp-scrollbar-tiny::-webkit-scrollbar-corner {
  background-color: transparent;
  height: 4px;
  width: 4px;
}

.jp-scrollbar-tiny::-webkit-scrollbar-thumb {
  background: rgba(var(--jp-scrollbar-thumb-color), 0.5);
}

.jp-scrollbar-tiny::-webkit-scrollbar-track:horizontal {
  border-left: 0 solid transparent;
  border-right: 0 solid transparent;
}

.jp-scrollbar-tiny::-webkit-scrollbar-track:vertical {
  border-top: 0 solid transparent;
  border-bottom: 0 solid transparent;
}

/*
 * Lumino
 */

.lm-ScrollBar[data-orientation='horizontal'] {
  min-height: 16px;
  max-height: 16px;
  min-width: 45px;
  border-top: 1px solid #a0a0a0;
}

.lm-ScrollBar[data-orientation='vertical'] {
  min-width: 16px;
  max-width: 16px;
  min-height: 45px;
  border-left: 1px solid #a0a0a0;
}

.lm-ScrollBar-button {
  background-color: #f0f0f0;
  background-position: center center;
  min-height: 15px;
  max-height: 15px;
  min-width: 15px;
  max-width: 15px;
}

.lm-ScrollBar-button:hover {
  background-color: #dadada;
}

.lm-ScrollBar-button.lm-mod-active {
  background-color: #cdcdcd;
}

.lm-ScrollBar-track {
  background: #f0f0f0;
}

.lm-ScrollBar-thumb {
  background: #cdcdcd;
}

.lm-ScrollBar-thumb:hover {
  background: #bababa;
}

.lm-ScrollBar-thumb.lm-mod-active {
  background: #a0a0a0;
}

.lm-ScrollBar[data-orientation='horizontal'] .lm-ScrollBar-thumb {
  height: 100%;
  min-width: 15px;
  border-left: 1px solid #a0a0a0;
  border-right: 1px solid #a0a0a0;
}

.lm-ScrollBar[data-orientation='vertical'] .lm-ScrollBar-thumb {
  width: 100%;
  min-height: 15px;
  border-top: 1px solid #a0a0a0;
  border-bottom: 1px solid #a0a0a0;
}

.lm-ScrollBar[data-orientation='horizontal']
  .lm-ScrollBar-button[data-action='decrement'] {
  background-image: var(--jp-icon-caret-left);
  background-size: 17px;
}

.lm-ScrollBar[data-orientation='horizontal']
  .lm-ScrollBar-button[data-action='increment'] {
  background-image: var(--jp-icon-caret-right);
  background-size: 17px;
}

.lm-ScrollBar[data-orientation='vertical']
  .lm-ScrollBar-button[data-action='decrement'] {
  background-image: var(--jp-icon-caret-up);
  background-size: 17px;
}

.lm-ScrollBar[data-orientation='vertical']
  .lm-ScrollBar-button[data-action='increment'] {
  background-image: var(--jp-icon-caret-down);
  background-size: 17px;
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Copyright (c) 2014-2017, PhosphorJS Contributors
|
| Distributed under the terms of the BSD 3-Clause License.
|
| The full license is in the file LICENSE, distributed with this software.
|----------------------------------------------------------------------------*/

.lm-Widget {
  box-sizing: border-box;
  position: relative;
  overflow: hidden;
}

.lm-Widget.lm-mod-hidden {
  display: none !important;
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

.lm-AccordionPanel[data-orientation='horizontal'] > .lm-AccordionPanel-title {
  /* Title is rotated for horizontal accordion panel using CSS */
  display: block;
  transform-origin: top left;
  transform: rotate(-90deg) translate(-100%);
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Copyright (c) 2014-2017, PhosphorJS Contributors
|
| Distributed under the terms of the BSD 3-Clause License.
|
| The full license is in the file LICENSE, distributed with this software.
|----------------------------------------------------------------------------*/

.lm-CommandPalette {
  display: flex;
  flex-direction: column;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.lm-CommandPalette-search {
  flex: 0 0 auto;
}

.lm-CommandPalette-content {
  flex: 1 1 auto;
  margin: 0;
  padding: 0;
  min-height: 0;
  overflow: auto;
  list-style-type: none;
}

.lm-CommandPalette-header {
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
}

.lm-CommandPalette-item {
  display: flex;
  flex-direction: row;
}

.lm-CommandPalette-itemIcon {
  flex: 0 0 auto;
}

.lm-CommandPalette-itemContent {
  flex: 1 1 auto;
  overflow: hidden;
}

.lm-CommandPalette-itemShortcut {
  flex: 0 0 auto;
}

.lm-CommandPalette-itemLabel {
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
}

.lm-close-icon {
  border: 1px solid transparent;
  background-color: transparent;
  position: absolute;
  z-index: 1;
  right: 3%;
  top: 0;
  bottom: 0;
  margin: auto;
  padding: 7px 0;
  display: none;
  vertical-align: middle;
  outline: 0;
  cursor: pointer;
}
.lm-close-icon:after {
  content: 'X';
  display: block;
  width: 15px;
  height: 15px;
  text-align: center;
  color: #000;
  font-weight: normal;
  font-size: 12px;
  cursor: pointer;
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Copyright (c) 2014-2017, PhosphorJS Contributors
|
| Distributed under the terms of the BSD 3-Clause License.
|
| The full license is in the file LICENSE, distributed with this software.
|----------------------------------------------------------------------------*/

.lm-DockPanel {
  z-index: 0;
}

.lm-DockPanel-widget {
  z-index: 0;
}

.lm-DockPanel-tabBar {
  z-index: 1;
}

.lm-DockPanel-handle {
  z-index: 2;
}

.lm-DockPanel-handle.lm-mod-hidden {
  display: none !important;
}

.lm-DockPanel-handle:after {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  content: '';
}

.lm-DockPanel-handle[data-orientation='horizontal'] {
  cursor: ew-resize;
}

.lm-DockPanel-handle[data-orientation='vertical'] {
  cursor: ns-resize;
}

.lm-DockPanel-handle[data-orientation='horizontal']:after {
  left: 50%;
  min-width: 8px;
  transform: translateX(-50%);
}

.lm-DockPanel-handle[data-orientation='vertical']:after {
  top: 50%;
  min-height: 8px;
  transform: translateY(-50%);
}

.lm-DockPanel-overlay {
  z-index: 3;
  box-sizing: border-box;
  pointer-events: none;
}

.lm-DockPanel-overlay.lm-mod-hidden {
  display: none !important;
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Copyright (c) 2014-2017, PhosphorJS Contributors
|
| Distributed under the terms of the BSD 3-Clause License.
|
| The full license is in the file LICENSE, distributed with this software.
|----------------------------------------------------------------------------*/

.lm-Menu {
  z-index: 10000;
  position: absolute;
  white-space: nowrap;
  overflow-x: hidden;
  overflow-y: auto;
  outline: none;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.lm-Menu-content {
  margin: 0;
  padding: 0;
  display: table;
  list-style-type: none;
}

.lm-Menu-item {
  display: table-row;
}

.lm-Menu-item.lm-mod-hidden,
.lm-Menu-item.lm-mod-collapsed {
  display: none !important;
}

.lm-Menu-itemIcon,
.lm-Menu-itemSubmenuIcon {
  display: table-cell;
  text-align: center;
}

.lm-Menu-itemLabel {
  display: table-cell;
  text-align: left;
}

.lm-Menu-itemShortcut {
  display: table-cell;
  text-align: right;
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Copyright (c) 2014-2017, PhosphorJS Contributors
|
| Distributed under the terms of the BSD 3-Clause License.
|
| The full license is in the file LICENSE, distributed with this software.
|----------------------------------------------------------------------------*/

.lm-MenuBar {
  outline: none;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.lm-MenuBar-content {
  margin: 0;
  padding: 0;
  display: flex;
  flex-direction: row;
  list-style-type: none;
}

.lm-MenuBar-item {
  box-sizing: border-box;
}

.lm-MenuBar-itemIcon,
.lm-MenuBar-itemLabel {
  display: inline-block;
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Copyright (c) 2014-2017, PhosphorJS Contributors
|
| Distributed under the terms of the BSD 3-Clause License.
|
| The full license is in the file LICENSE, distributed with this software.
|----------------------------------------------------------------------------*/

.lm-ScrollBar {
  display: flex;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.lm-ScrollBar[data-orientation='horizontal'] {
  flex-direction: row;
}

.lm-ScrollBar[data-orientation='vertical'] {
  flex-direction: column;
}

.lm-ScrollBar-button {
  box-sizing: border-box;
  flex: 0 0 auto;
}

.lm-ScrollBar-track {
  box-sizing: border-box;
  position: relative;
  overflow: hidden;
  flex: 1 1 auto;
}

.lm-ScrollBar-thumb {
  box-sizing: border-box;
  position: absolute;
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Copyright (c) 2014-2017, PhosphorJS Contributors
|
| Distributed under the terms of the BSD 3-Clause License.
|
| The full license is in the file LICENSE, distributed with this software.
|----------------------------------------------------------------------------*/

.lm-SplitPanel-child {
  z-index: 0;
}

.lm-SplitPanel-handle {
  z-index: 1;
}

.lm-SplitPanel-handle.lm-mod-hidden {
  display: none !important;
}

.lm-SplitPanel-handle:after {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  content: '';
}

.lm-SplitPanel[data-orientation='horizontal'] > .lm-SplitPanel-handle {
  cursor: ew-resize;
}

.lm-SplitPanel[data-orientation='vertical'] > .lm-SplitPanel-handle {
  cursor: ns-resize;
}

.lm-SplitPanel[data-orientation='horizontal'] > .lm-SplitPanel-handle:after {
  left: 50%;
  min-width: 8px;
  transform: translateX(-50%);
}

.lm-SplitPanel[data-orientation='vertical'] > .lm-SplitPanel-handle:after {
  top: 50%;
  min-height: 8px;
  transform: translateY(-50%);
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Copyright (c) 2014-2017, PhosphorJS Contributors
|
| Distributed under the terms of the BSD 3-Clause License.
|
| The full license is in the file LICENSE, distributed with this software.
|----------------------------------------------------------------------------*/

.lm-TabBar {
  display: flex;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.lm-TabBar[data-orientation='horizontal'] {
  flex-direction: row;
  align-items: flex-end;
}

.lm-TabBar[data-orientation='vertical'] {
  flex-direction: column;
  align-items: flex-end;
}

.lm-TabBar-content {
  margin: 0;
  padding: 0;
  display: flex;
  flex: 1 1 auto;
  list-style-type: none;
}

.lm-TabBar[data-orientation='horizontal'] > .lm-TabBar-content {
  flex-direction: row;
}

.lm-TabBar[data-orientation='vertical'] > .lm-TabBar-content {
  flex-direction: column;
}

.lm-TabBar-tab {
  display: flex;
  flex-direction: row;
  box-sizing: border-box;
  overflow: hidden;
  touch-action: none; /* Disable native Drag/Drop */
}

.lm-TabBar-tabIcon,
.lm-TabBar-tabCloseIcon {
  flex: 0 0 auto;
}

.lm-TabBar-tabLabel {
  flex: 1 1 auto;
  overflow: hidden;
  white-space: nowrap;
}

.lm-TabBar-tabInput {
  user-select: all;
  width: 100%;
  box-sizing: border-box;
}

.lm-TabBar-tab.lm-mod-hidden {
  display: none !important;
}

.lm-TabBar-addButton.lm-mod-hidden {
  display: none !important;
}

.lm-TabBar.lm-mod-dragging .lm-TabBar-tab {
  position: relative;
}

.lm-TabBar.lm-mod-dragging[data-orientation='horizontal'] .lm-TabBar-tab {
  left: 0;
  transition: left 150ms ease;
}

.lm-TabBar.lm-mod-dragging[data-orientation='vertical'] .lm-TabBar-tab {
  top: 0;
  transition: top 150ms ease;
}

.lm-TabBar.lm-mod-dragging .lm-TabBar-tab.lm-mod-dragging {
  transition: none;
}

.lm-TabBar-tabLabel .lm-TabBar-tabInput {
  user-select: all;
  width: 100%;
  box-sizing: border-box;
  background: inherit;
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Copyright (c) 2014-2017, PhosphorJS Contributors
|
| Distributed under the terms of the BSD 3-Clause License.
|
| The full license is in the file LICENSE, distributed with this software.
|----------------------------------------------------------------------------*/

.lm-TabPanel-tabBar {
  z-index: 1;
}

.lm-TabPanel-stackedPanel {
  z-index: 0;
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Copyright (c) 2014-2017, PhosphorJS Contributors
|
| Distributed under the terms of the BSD 3-Clause License.
|
| The full license is in the file LICENSE, distributed with this software.
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

.jp-Collapse {
  display: flex;
  flex-direction: column;
  align-items: stretch;
}

.jp-Collapse-header {
  padding: 1px 12px;
  background-color: var(--jp-layout-color1);
  border-bottom: solid var(--jp-border-width) var(--jp-border-color2);
  color: var(--jp-ui-font-color1);
  cursor: pointer;
  display: flex;
  align-items: center;
  font-size: var(--jp-ui-font-size0);
  font-weight: 600;
  text-transform: uppercase;
  user-select: none;
}

.jp-Collapser-icon {
  height: 16px;
}

.jp-Collapse-header-collapsed .jp-Collapser-icon {
  transform: rotate(-90deg);
  margin: auto 0;
}

.jp-Collapser-title {
  line-height: 25px;
}

.jp-Collapse-contents {
  padding: 0 12px;
  background-color: var(--jp-layout-color1);
  color: var(--jp-ui-font-color1);
  overflow: auto;
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/* This file was auto-generated by ensureUiComponents() in @jupyterlab/buildutils */

/**
 * (DEPRECATED) Support for consuming icons as CSS background images
 */

/* Icons urls */

:root {
  --jp-icon-add-above: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTQiIGhlaWdodD0iMTQiIHZpZXdCb3g9IjAgMCAxNCAxNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGcgY2xpcC1wYXRoPSJ1cmwoI2NsaXAwXzEzN18xOTQ5MikiPgo8cGF0aCBjbGFzcz0ianAtaWNvbjMiIGQ9Ik00Ljc1IDQuOTMwNjZINi42MjVWNi44MDU2NkM2LjYyNSA3LjAxMTkxIDYuNzkzNzUgNy4xODA2NiA3IDcuMTgwNjZDNy4yMDYyNSA3LjE4MDY2IDcuMzc1IDcuMDExOTEgNy4zNzUgNi44MDU2NlY0LjkzMDY2SDkuMjVDOS40NTYyNSA0LjkzMDY2IDkuNjI1IDQuNzYxOTEgOS42MjUgNC41NTU2NkM5LjYyNSA0LjM0OTQxIDkuNDU2MjUgNC4xODA2NiA5LjI1IDQuMTgwNjZINy4zNzVWMi4zMDU2NkM3LjM3NSAyLjA5OTQxIDcuMjA2MjUgMS45MzA2NiA3IDEuOTMwNjZDNi43OTM3NSAxLjkzMDY2IDYuNjI1IDIuMDk5NDEgNi42MjUgMi4zMDU2NlY0LjE4MDY2SDQuNzVDNC41NDM3NSA0LjE4MDY2IDQuMzc1IDQuMzQ5NDEgNC4zNzUgNC41NTU2NkM0LjM3NSA0Ljc2MTkxIDQuNTQzNzUgNC45MzA2NiA0Ljc1IDQuOTMwNjZaIiBmaWxsPSIjNjE2MTYxIiBzdHJva2U9IiM2MTYxNjEiIHN0cm9rZS13aWR0aD0iMC43Ii8+CjwvZz4KPHBhdGggY2xhc3M9ImpwLWljb24zIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIGNsaXAtcnVsZT0iZXZlbm9kZCIgZD0iTTExLjUgOS41VjExLjVMMi41IDExLjVWOS41TDExLjUgOS41Wk0xMiA4QzEyLjU1MjMgOCAxMyA4LjQ0NzcyIDEzIDlWMTJDMTMgMTIuNTUyMyAxMi41NTIzIDEzIDEyIDEzTDIgMTNDMS40NDc3MiAxMyAxIDEyLjU1MjMgMSAxMlY5QzEgOC40NDc3MiAxLjQ0NzcxIDggMiA4TDEyIDhaIiBmaWxsPSIjNjE2MTYxIi8+CjxkZWZzPgo8Y2xpcFBhdGggaWQ9ImNsaXAwXzEzN18xOTQ5MiI+CjxyZWN0IGNsYXNzPSJqcC1pY29uMyIgd2lkdGg9IjYiIGhlaWdodD0iNiIgZmlsbD0id2hpdGUiIHRyYW5zZm9ybT0ibWF0cml4KC0xIDAgMCAxIDEwIDEuNTU1NjYpIi8+CjwvY2xpcFBhdGg+CjwvZGVmcz4KPC9zdmc+Cg==);
  --jp-icon-add-below: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTQiIGhlaWdodD0iMTQiIHZpZXdCb3g9IjAgMCAxNCAxNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGcgY2xpcC1wYXRoPSJ1cmwoI2NsaXAwXzEzN18xOTQ5OCkiPgo8cGF0aCBjbGFzcz0ianAtaWNvbjMiIGQ9Ik05LjI1IDEwLjA2OTNMNy4zNzUgMTAuMDY5M0w3LjM3NSA4LjE5NDM0QzcuMzc1IDcuOTg4MDkgNy4yMDYyNSA3LjgxOTM0IDcgNy44MTkzNEM2Ljc5Mzc1IDcuODE5MzQgNi42MjUgNy45ODgwOSA2LjYyNSA4LjE5NDM0TDYuNjI1IDEwLjA2OTNMNC43NSAxMC4wNjkzQzQuNTQzNzUgMTAuMDY5MyA0LjM3NSAxMC4yMzgxIDQuMzc1IDEwLjQ0NDNDNC4zNzUgMTAuNjUwNiA0LjU0Mzc1IDEwLjgxOTMgNC43NSAxMC44MTkzTDYuNjI1IDEwLjgxOTNMNi42MjUgMTIuNjk0M0M2LjYyNSAxMi45MDA2IDYuNzkzNzUgMTMuMDY5MyA3IDEzLjA2OTNDNy4yMDYyNSAxMy4wNjkzIDcuMzc1IDEyLjkwMDYgNy4zNzUgMTIuNjk0M0w3LjM3NSAxMC44MTkzTDkuMjUgMTAuODE5M0M5LjQ1NjI1IDEwLjgxOTMgOS42MjUgMTAuNjUwNiA5LjYyNSAxMC40NDQzQzkuNjI1IDEwLjIzODEgOS40NTYyNSAxMC4wNjkzIDkuMjUgMTAuMDY5M1oiIGZpbGw9IiM2MTYxNjEiIHN0cm9rZT0iIzYxNjE2MSIgc3Ryb2tlLXdpZHRoPSIwLjciLz4KPC9nPgo8cGF0aCBjbGFzcz0ianAtaWNvbjMiIGZpbGwtcnVsZT0iZXZlbm9kZCIgY2xpcC1ydWxlPSJldmVub2RkIiBkPSJNMi41IDUuNUwyLjUgMy41TDExLjUgMy41TDExLjUgNS41TDIuNSA1LjVaTTIgN0MxLjQ0NzcyIDcgMSA2LjU1MjI4IDEgNkwxIDNDMSAyLjQ0NzcyIDEuNDQ3NzIgMiAyIDJMMTIgMkMxMi41NTIzIDIgMTMgMi40NDc3MiAxMyAzTDEzIDZDMTMgNi41NTIyOSAxMi41NTIzIDcgMTIgN0wyIDdaIiBmaWxsPSIjNjE2MTYxIi8+CjxkZWZzPgo8Y2xpcFBhdGggaWQ9ImNsaXAwXzEzN18xOTQ5OCI+CjxyZWN0IGNsYXNzPSJqcC1pY29uMyIgd2lkdGg9IjYiIGhlaWdodD0iNiIgZmlsbD0id2hpdGUiIHRyYW5zZm9ybT0ibWF0cml4KDEgMS43NDg0NmUtMDcgMS43NDg0NmUtMDcgLTEgNCAxMy40NDQzKSIvPgo8L2NsaXBQYXRoPgo8L2RlZnM+Cjwvc3ZnPgo=);
  --jp-icon-add: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTE5IDEzaC02djZoLTJ2LTZINXYtMmg2VjVoMnY2aDZ2MnoiLz4KICA8L2c+Cjwvc3ZnPgo=);
  --jp-icon-bell: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDE2IDE2IiB2ZXJzaW9uPSIxLjEiPgogICA8cGF0aCBjbGFzcz0ianAtaWNvbjIganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjMzMzMzMzIgogICAgICBkPSJtOCAwLjI5Yy0xLjQgMC0yLjcgMC43My0zLjYgMS44LTEuMiAxLjUtMS40IDMuNC0xLjUgNS4yLTAuMTggMi4yLTAuNDQgNC0yLjMgNS4zbDAuMjggMS4zaDVjMC4wMjYgMC42NiAwLjMyIDEuMSAwLjcxIDEuNSAwLjg0IDAuNjEgMiAwLjYxIDIuOCAwIDAuNTItMC40IDAuNi0xIDAuNzEtMS41aDVsMC4yOC0xLjNjLTEuOS0wLjk3LTIuMi0zLjMtMi4zLTUuMy0wLjEzLTEuOC0wLjI2LTMuNy0xLjUtNS4yLTAuODUtMS0yLjItMS44LTMuNi0xLjh6bTAgMS40YzAuODggMCAxLjkgMC41NSAyLjUgMS4zIDAuODggMS4xIDEuMSAyLjcgMS4yIDQuNCAwLjEzIDEuNyAwLjIzIDMuNiAxLjMgNS4yaC0xMGMxLjEtMS42IDEuMi0zLjQgMS4zLTUuMiAwLjEzLTEuNyAwLjMtMy4zIDEuMi00LjQgMC41OS0wLjcyIDEuNi0xLjMgMi41LTEuM3ptLTAuNzQgMTJoMS41Yy0wLjAwMTUgMC4yOCAwLjAxNSAwLjc5LTAuNzQgMC43OS0wLjczIDAuMDAxNi0wLjcyLTAuNTMtMC43NC0wLjc5eiIgLz4KPC9zdmc+Cg==);
  --jp-icon-bug-dot: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICAgIDxnIGNsYXNzPSJqcC1pY29uMyBqcC1pY29uLXNlbGVjdGFibGUiIGZpbGw9IiM2MTYxNjEiPgogICAgICAgIDxwYXRoIGZpbGwtcnVsZT0iZXZlbm9kZCIgY2xpcC1ydWxlPSJldmVub2RkIiBkPSJNMTcuMTkgOEgyMFYxMEgxNy45MUMxNy45NiAxMC4zMyAxOCAxMC42NiAxOCAxMVYxMkgyMFYxNEgxOC41SDE4VjE0LjAyNzVDMTUuNzUgMTQuMjc2MiAxNCAxNi4xODM3IDE0IDE4LjVDMTQgMTkuMjA4IDE0LjE2MzUgMTkuODc3OSAxNC40NTQ5IDIwLjQ3MzlDMTMuNzA2MyAyMC44MTE3IDEyLjg3NTcgMjEgMTIgMjFDOS43OCAyMSA3Ljg1IDE5Ljc5IDYuODEgMThINFYxNkg2LjA5QzYuMDQgMTUuNjcgNiAxNS4zNCA2IDE1VjE0SDRWMTJINlYxMUM2IDEwLjY2IDYuMDQgMTAuMzMgNi4wOSAxMEg0VjhINi44MUM3LjI2IDcuMjIgNy44OCA2LjU1IDguNjIgNi4wNEw3IDQuNDFMOC40MSAzTDEwLjU5IDUuMTdDMTEuMDQgNS4wNiAxMS41MSA1IDEyIDVDMTIuNDkgNSAxMi45NiA1LjA2IDEzLjQyIDUuMTdMMTUuNTkgM0wxNyA0LjQxTDE1LjM3IDYuMDRDMTYuMTIgNi41NSAxNi43NCA3LjIyIDE3LjE5IDhaTTEwIDE2SDE0VjE0SDEwVjE2Wk0xMCAxMkgxNFYxMEgxMFYxMloiIGZpbGw9IiM2MTYxNjEiLz4KICAgICAgICA8cGF0aCBkPSJNMjIgMTguNUMyMiAyMC40MzMgMjAuNDMzIDIyIDE4LjUgMjJDMTYuNTY3IDIyIDE1IDIwLjQzMyAxNSAxOC41QzE1IDE2LjU2NyAxNi41NjcgMTUgMTguNSAxNUMyMC40MzMgMTUgMjIgMTYuNTY3IDIyIDE4LjVaIiBmaWxsPSIjNjE2MTYxIi8+CiAgICA8L2c+Cjwvc3ZnPgo=);
  --jp-icon-bug: url(data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIxNiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyBjbGFzcz0ianAtaWNvbjMganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjNjE2MTYxIj4KICAgIDxwYXRoIGQ9Ik0yMCA4aC0yLjgxYy0uNDUtLjc4LTEuMDctMS40NS0xLjgyLTEuOTZMMTcgNC40MSAxNS41OSAzbC0yLjE3IDIuMTdDMTIuOTYgNS4wNiAxMi40OSA1IDEyIDVjLS40OSAwLS45Ni4wNi0xLjQxLjE3TDguNDEgMyA3IDQuNDFsMS42MiAxLjYzQzcuODggNi41NSA3LjI2IDcuMjIgNi44MSA4SDR2MmgyLjA5Yy0uMDUuMzMtLjA5LjY2LS4wOSAxdjFINHYyaDJ2MWMwIC4zNC4wNC42Ny4wOSAxSDR2MmgyLjgxYzEuMDQgMS43OSAyLjk3IDMgNS4xOSAzczQuMTUtMS4yMSA1LjE5LTNIMjB2LTJoLTIuMDljLjA1LS4zMy4wOS0uNjYuMDktMXYtMWgydi0yaC0ydi0xYzAtLjM0LS4wNC0uNjctLjA5LTFIMjBWOHptLTYgOGgtNHYtMmg0djJ6bTAtNGgtNHYtMmg0djJ6Ii8+CiAgPC9nPgo8L3N2Zz4K);
  --jp-icon-build: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIHZpZXdCb3g9IjAgMCAyNCAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTE0LjkgMTcuNDVDMTYuMjUgMTcuNDUgMTcuMzUgMTYuMzUgMTcuMzUgMTVDMTcuMzUgMTMuNjUgMTYuMjUgMTIuNTUgMTQuOSAxMi41NUMxMy41NCAxMi41NSAxMi40NSAxMy42NSAxMi40NSAxNUMxMi40NSAxNi4zNSAxMy41NCAxNy40NSAxNC45IDE3LjQ1Wk0yMC4xIDE1LjY4TDIxLjU4IDE2Ljg0QzIxLjcxIDE2Ljk1IDIxLjc1IDE3LjEzIDIxLjY2IDE3LjI5TDIwLjI2IDE5LjcxQzIwLjE3IDE5Ljg2IDIwIDE5LjkyIDE5LjgzIDE5Ljg2TDE4LjA5IDE5LjE2QzE3LjczIDE5LjQ0IDE3LjMzIDE5LjY3IDE2LjkxIDE5Ljg1TDE2LjY0IDIxLjdDMTYuNjIgMjEuODcgMTYuNDcgMjIgMTYuMyAyMkgxMy41QzEzLjMyIDIyIDEzLjE4IDIxLjg3IDEzLjE1IDIxLjdMMTIuODkgMTkuODVDMTIuNDYgMTkuNjcgMTIuMDcgMTkuNDQgMTEuNzEgMTkuMTZMOS45NjAwMiAxOS44NkM5LjgxMDAyIDE5LjkyIDkuNjIwMDIgMTkuODYgOS41NDAwMiAxOS43MUw4LjE0MDAyIDE3LjI5QzguMDUwMDIgMTcuMTMgOC4wOTAwMiAxNi45NSA4LjIyMDAyIDE2Ljg0TDkuNzAwMDIgMTUuNjhMOS42NTAwMSAxNUw5LjcwMDAyIDE0LjMxTDguMjIwMDIgMTMuMTZDOC4wOTAwMiAxMy4wNSA4LjA1MDAyIDEyLjg2IDguMTQwMDIgMTIuNzFMOS41NDAwMiAxMC4yOUM5LjYyMDAyIDEwLjEzIDkuODEwMDIgMTAuMDcgOS45NjAwMiAxMC4xM0wxMS43MSAxMC44NEMxMi4wNyAxMC41NiAxMi40NiAxMC4zMiAxMi44OSAxMC4xNUwxMy4xNSA4LjI4OTk4QzEzLjE4IDguMTI5OTggMTMuMzIgNy45OTk5OCAxMy41IDcuOTk5OThIMTYuM0MxNi40NyA3Ljk5OTk4IDE2LjYyIDguMTI5OTggMTYuNjQgOC4yODk5OEwxNi45MSAxMC4xNUMxNy4zMyAxMC4zMiAxNy43MyAxMC41NiAxOC4wOSAxMC44NEwxOS44MyAxMC4xM0MyMCAxMC4wNyAyMC4xNyAxMC4xMyAyMC4yNiAxMC4yOUwyMS42NiAxMi43MUMyMS43NSAxMi44NiAyMS43MSAxMy4wNSAyMS41OCAxMy4xNkwyMC4xIDE0LjMxTDIwLjE1IDE1TDIwLjEgMTUuNjhaIi8+CiAgICA8cGF0aCBkPSJNNy4zMjk2NiA3LjQ0NDU0QzguMDgzMSA3LjAwOTU0IDguMzM5MzIgNi4wNTMzMiA3LjkwNDMyIDUuMjk5ODhDNy40NjkzMiA0LjU0NjQzIDYuNTA4MSA0LjI4MTU2IDUuNzU0NjYgNC43MTY1NkM1LjM5MTc2IDQuOTI2MDggNS4xMjY5NSA1LjI3MTE4IDUuMDE4NDkgNS42NzU5NEM0LjkxMDA0IDYuMDgwNzEgNC45NjY4MiA2LjUxMTk4IDUuMTc2MzQgNi44NzQ4OEM1LjYxMTM0IDcuNjI4MzIgNi41NzYyMiA3Ljg3OTU0IDcuMzI5NjYgNy40NDQ1NFpNOS42NTcxOCA0Ljc5NTkzTDEwLjg2NzIgNC45NTE3OUMxMC45NjI4IDQuOTc3NDEgMTEuMDQwMiA1LjA3MTMzIDExLjAzODIgNS4xODc5M0wxMS4wMzg4IDYuOTg4OTNDMTEuMDQ1NSA3LjEwMDU0IDEwLjk2MTYgNy4xOTUxOCAxMC44NTUgNy4yMTA1NEw5LjY2MDAxIDcuMzgwODNMOS4yMzkxNSA4LjEzMTg4TDkuNjY5NjEgOS4yNTc0NUM5LjcwNzI5IDkuMzYyNzEgOS42NjkzNCA5LjQ3Njk5IDkuNTc0MDggOS41MzE5OUw4LjAxNTIzIDEwLjQzMkM3LjkxMTMxIDEwLjQ5MiA3Ljc5MzM3IDEwLjQ2NzcgNy43MjEwNSAxMC4zODI0TDYuOTg3NDggOS40MzE4OEw2LjEwOTMxIDkuNDMwODNMNS4zNDcwNCAxMC4zOTA1QzUuMjg5MDkgMTAuNDcwMiA1LjE3MzgzIDEwLjQ5MDUgNS4wNzE4NyAxMC40MzM5TDMuNTEyNDUgOS41MzI5M0MzLjQxMDQ5IDkuNDc2MzMgMy4zNzY0NyA5LjM1NzQxIDMuNDEwNzUgOS4yNTY3OUwzLjg2MzQ3IDguMTQwOTNMMy42MTc0OSA3Ljc3NDg4TDMuNDIzNDcgNy4zNzg4M0wyLjIzMDc1IDcuMjEyOTdDMi4xMjY0NyA3LjE5MjM1IDIuMDQwNDkgNy4xMDM0MiAyLjA0MjQ1IDYuOTg2ODJMMi4wNDE4NyA1LjE4NTgyQzIuMDQzODMgNS4wNjkyMiAyLjExOTA5IDQuOTc5NTggMi4yMTcwNCA0Ljk2OTIyTDMuNDIwNjUgNC43OTM5M0wzLjg2NzQ5IDQuMDI3ODhMMy40MTEwNSAyLjkxNzMxQzMuMzczMzcgMi44MTIwNCAzLjQxMTMxIDIuNjk3NzYgMy41MTUyMyAyLjYzNzc2TDUuMDc0MDggMS43Mzc3NkM1LjE2OTM0IDEuNjgyNzYgNS4yODcyOSAxLjcwNzA0IDUuMzU5NjEgMS43OTIzMUw2LjExOTE1IDIuNzI3ODhMNi45ODAwMSAyLjczODkzTDcuNzI0OTYgMS43ODkyMkM3Ljc5MTU2IDEuNzA0NTggNy45MTU0OCAxLjY3OTIyIDguMDA4NzkgMS43NDA4Mkw5LjU2ODIxIDIuNjQxODJDOS42NzAxNyAyLjY5ODQyIDkuNzEyODUgMi44MTIzNCA5LjY4NzIzIDIuOTA3OTdMOS4yMTcxOCA0LjAzMzgzTDkuNDYzMTYgNC4zOTk4OEw5LjY1NzE4IDQuNzk1OTNaIi8+CiAgPC9nPgo8L3N2Zz4K);
  --jp-icon-caret-down-empty-thin: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDIwIDIwIj4KCTxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSIgc2hhcGUtcmVuZGVyaW5nPSJnZW9tZXRyaWNQcmVjaXNpb24iPgoJCTxwb2x5Z29uIGNsYXNzPSJzdDEiIHBvaW50cz0iOS45LDEzLjYgMy42LDcuNCA0LjQsNi42IDkuOSwxMi4yIDE1LjQsNi43IDE2LjEsNy40ICIvPgoJPC9nPgo8L3N2Zz4K);
  --jp-icon-caret-down-empty: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDE4IDE4Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiIHNoYXBlLXJlbmRlcmluZz0iZ2VvbWV0cmljUHJlY2lzaW9uIj4KICAgIDxwYXRoIGQ9Ik01LjIsNS45TDksOS43bDMuOC0zLjhsMS4yLDEuMmwtNC45LDVsLTQuOS01TDUuMiw1Ljl6Ii8+CiAgPC9nPgo8L3N2Zz4K);
  --jp-icon-caret-down: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDE4IDE4Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiIHNoYXBlLXJlbmRlcmluZz0iZ2VvbWV0cmljUHJlY2lzaW9uIj4KICAgIDxwYXRoIGQ9Ik01LjIsNy41TDksMTEuMmwzLjgtMy44SDUuMnoiLz4KICA8L2c+Cjwvc3ZnPgo=);
  --jp-icon-caret-left: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDE4IDE4Ij4KCTxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSIgc2hhcGUtcmVuZGVyaW5nPSJnZW9tZXRyaWNQcmVjaXNpb24iPgoJCTxwYXRoIGQ9Ik0xMC44LDEyLjhMNy4xLDlsMy44LTMuOGwwLDcuNkgxMC44eiIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-caret-right: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDE4IDE4Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiIHNoYXBlLXJlbmRlcmluZz0iZ2VvbWV0cmljUHJlY2lzaW9uIj4KICAgIDxwYXRoIGQ9Ik03LjIsNS4yTDEwLjksOWwtMy44LDMuOFY1LjJINy4yeiIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-caret-up-empty-thin: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDIwIDIwIj4KCTxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSIgc2hhcGUtcmVuZGVyaW5nPSJnZW9tZXRyaWNQcmVjaXNpb24iPgoJCTxwb2x5Z29uIGNsYXNzPSJzdDEiIHBvaW50cz0iMTUuNCwxMy4zIDkuOSw3LjcgNC40LDEzLjIgMy42LDEyLjUgOS45LDYuMyAxNi4xLDEyLjYgIi8+Cgk8L2c+Cjwvc3ZnPgo=);
  --jp-icon-caret-up: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDE4IDE4Ij4KCTxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSIgc2hhcGUtcmVuZGVyaW5nPSJnZW9tZXRyaWNQcmVjaXNpb24iPgoJCTxwYXRoIGQ9Ik01LjIsMTAuNUw5LDYuOGwzLjgsMy44SDUuMnoiLz4KICA8L2c+Cjwvc3ZnPgo=);
  --jp-icon-case-sensitive: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDIwIDIwIj4KICA8ZyBjbGFzcz0ianAtaWNvbjIiIGZpbGw9IiM0MTQxNDEiPgogICAgPHJlY3QgeD0iMiIgeT0iMiIgd2lkdGg9IjE2IiBoZWlnaHQ9IjE2Ii8+CiAgPC9nPgogIDxnIGNsYXNzPSJqcC1pY29uLWFjY2VudDIiIGZpbGw9IiNGRkYiPgogICAgPHBhdGggZD0iTTcuNiw4aDAuOWwzLjUsOGgtMS4xTDEwLDE0SDZsLTAuOSwySDRMNy42LDh6IE04LDkuMUw2LjQsMTNoMy4yTDgsOS4xeiIvPgogICAgPHBhdGggZD0iTTE2LjYsOS44Yy0wLjIsMC4xLTAuNCwwLjEtMC43LDAuMWMtMC4yLDAtMC40LTAuMS0wLjYtMC4yYy0wLjEtMC4xLTAuMi0wLjQtMC4yLTAuNyBjLTAuMywwLjMtMC42LDAuNS0wLjksMC43Yy0wLjMsMC4xLTAuNywwLjItMS4xLDAuMmMtMC4zLDAtMC41LDAtMC43LTAuMWMtMC4yLTAuMS0wLjQtMC4yLTAuNi0wLjNjLTAuMi0wLjEtMC4zLTAuMy0wLjQtMC41IGMtMC4xLTAuMi0wLjEtMC40LTAuMS0wLjdjMC0wLjMsMC4xLTAuNiwwLjItMC44YzAuMS0wLjIsMC4zLTAuNCwwLjQtMC41QzEyLDcsMTIuMiw2LjksMTIuNSw2LjhjMC4yLTAuMSwwLjUtMC4xLDAuNy0wLjIgYzAuMy0wLjEsMC41LTAuMSwwLjctMC4xYzAuMiwwLDAuNC0wLjEsMC42LTAuMWMwLjIsMCwwLjMtMC4xLDAuNC0wLjJjMC4xLTAuMSwwLjItMC4yLDAuMi0wLjRjMC0xLTEuMS0xLTEuMy0xIGMtMC40LDAtMS40LDAtMS40LDEuMmgtMC45YzAtMC40LDAuMS0wLjcsMC4yLTFjMC4xLTAuMiwwLjMtMC40LDAuNS0wLjZjMC4yLTAuMiwwLjUtMC4zLDAuOC0wLjNDMTMuMyw0LDEzLjYsNCwxMy45LDQgYzAuMywwLDAuNSwwLDAuOCwwLjFjMC4zLDAsMC41LDAuMSwwLjcsMC4yYzAuMiwwLjEsMC40LDAuMywwLjUsMC41QzE2LDUsMTYsNS4yLDE2LDUuNnYyLjljMCwwLjIsMCwwLjQsMCwwLjUgYzAsMC4xLDAuMSwwLjIsMC4zLDAuMmMwLjEsMCwwLjIsMCwwLjMsMFY5Ljh6IE0xNS4yLDYuOWMtMS4yLDAuNi0zLjEsMC4yLTMuMSwxLjRjMCwxLjQsMy4xLDEsMy4xLTAuNVY2Ljl6Ii8+CiAgPC9nPgo8L3N2Zz4K);
  --jp-icon-check: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjNjE2MTYxIj4KICAgIDxwYXRoIGQ9Ik05IDE2LjE3TDQuODMgMTJsLTEuNDIgMS40MUw5IDE5IDIxIDdsLTEuNDEtMS40MXoiLz4KICA8L2c+Cjwvc3ZnPgo=);
  --jp-icon-circle-empty: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTEyIDJDNi40NyAyIDIgNi40NyAyIDEyczQuNDcgMTAgMTAgMTAgMTAtNC40NyAxMC0xMFMxNy41MyAyIDEyIDJ6bTAgMThjLTQuNDEgMC04LTMuNTktOC04czMuNTktOCA4LTggOCAzLjU5IDggOC0zLjU5IDgtOCA4eiIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-circle: url(data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMTggMTgiIHdpZHRoPSIxNiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPGNpcmNsZSBjeD0iOSIgY3k9IjkiIHI9IjgiLz4KICA8L2c+Cjwvc3ZnPgo=);
  --jp-icon-clear: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8bWFzayBpZD0iZG9udXRIb2xlIj4KICAgIDxyZWN0IHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgZmlsbD0id2hpdGUiIC8+CiAgICA8Y2lyY2xlIGN4PSIxMiIgY3k9IjEyIiByPSI4IiBmaWxsPSJibGFjayIvPgogIDwvbWFzaz4KCiAgPGcgY2xhc3M9ImpwLWljb24zIiBmaWxsPSIjNjE2MTYxIj4KICAgIDxyZWN0IGhlaWdodD0iMTgiIHdpZHRoPSIyIiB4PSIxMSIgeT0iMyIgdHJhbnNmb3JtPSJyb3RhdGUoMzE1LCAxMiwgMTIpIi8+CiAgICA8Y2lyY2xlIGN4PSIxMiIgY3k9IjEyIiByPSIxMCIgbWFzaz0idXJsKCNkb251dEhvbGUpIi8+CiAgPC9nPgo8L3N2Zz4K);
  --jp-icon-close: url(data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIxNiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyBjbGFzcz0ianAtaWNvbi1ub25lIGpwLWljb24tc2VsZWN0YWJsZS1pbnZlcnNlIGpwLWljb24zLWhvdmVyIiBmaWxsPSJub25lIj4KICAgIDxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjExIi8+CiAgPC9nPgoKICA8ZyBjbGFzcz0ianAtaWNvbjMganAtaWNvbi1zZWxlY3RhYmxlIGpwLWljb24tYWNjZW50Mi1ob3ZlciIgZmlsbD0iIzYxNjE2MSI+CiAgICA8cGF0aCBkPSJNMTkgNi40MUwxNy41OSA1IDEyIDEwLjU5IDYuNDEgNSA1IDYuNDEgMTAuNTkgMTIgNSAxNy41OSA2LjQxIDE5IDEyIDEzLjQxIDE3LjU5IDE5IDE5IDE3LjU5IDEzLjQxIDEyeiIvPgogIDwvZz4KCiAgPGcgY2xhc3M9ImpwLWljb24tbm9uZSBqcC1pY29uLWJ1c3kiIGZpbGw9Im5vbmUiPgogICAgPGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iNyIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-code-check: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjNjE2MTYxIiBzaGFwZS1yZW5kZXJpbmc9Imdlb21ldHJpY1ByZWNpc2lvbiI+CiAgICA8cGF0aCBkPSJNNi41OSwzLjQxTDIsOEw2LjU5LDEyLjZMOCwxMS4xOEw0LjgyLDhMOCw0LjgyTDYuNTksMy40MU0xMi40MSwzLjQxTDExLDQuODJMMTQuMTgsOEwxMSwxMS4xOEwxMi40MSwxMi42TDE3LDhMMTIuNDEsMy40MU0yMS41OSwxMS41OUwxMy41LDE5LjY4TDkuODMsMTZMOC40MiwxNy40MUwxMy41LDIyLjVMMjMsMTNMMjEuNTksMTEuNTlaIiAvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-code: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjIiIGhlaWdodD0iMjIiIHZpZXdCb3g9IjAgMCAyOCAyOCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KCTxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSI+CgkJPHBhdGggZD0iTTExLjQgMTguNkw2LjggMTRMMTEuNCA5LjRMMTAgOEw0IDE0TDEwIDIwTDExLjQgMTguNlpNMTYuNiAxOC42TDIxLjIgMTRMMTYuNiA5LjRMMTggOEwyNCAxNEwxOCAyMEwxNi42IDE4LjZWMTguNloiLz4KCTwvZz4KPC9zdmc+Cg==);
  --jp-icon-collapse-all: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICAgIDxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSI+CiAgICAgICAgPHBhdGgKICAgICAgICAgICAgZD0iTTggMmMxIDAgMTEgMCAxMiAwczIgMSAyIDJjMCAxIDAgMTEgMCAxMnMwIDItMiAyQzIwIDE0IDIwIDQgMjAgNFMxMCA0IDYgNGMwLTIgMS0yIDItMnoiIC8+CiAgICAgICAgPHBhdGgKICAgICAgICAgICAgZD0iTTE4IDhjMC0xLTEtMi0yLTJTNSA2IDQgNnMtMiAxLTIgMmMwIDEgMCAxMSAwIDEyczEgMiAyIDJjMSAwIDExIDAgMTIgMHMyLTEgMi0yYzAtMSAwLTExIDAtMTJ6bS0yIDB2MTJINFY4eiIgLz4KICAgICAgICA8cGF0aCBkPSJNNiAxM3YyaDh2LTJ6IiAvPgogICAgPC9nPgo8L3N2Zz4K);
  --jp-icon-console: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDIwMCAyMDAiPgogIDxnIGNsYXNzPSJqcC1jb25zb2xlLWljb24tYmFja2dyb3VuZC1jb2xvciBqcC1pY29uLXNlbGVjdGFibGUiIGZpbGw9IiMwMjg4RDEiPgogICAgPHBhdGggZD0iTTIwIDE5LjhoMTYwdjE1OS45SDIweiIvPgogIDwvZz4KICA8ZyBjbGFzcz0ianAtY29uc29sZS1pY29uLWNvbG9yIGpwLWljb24tc2VsZWN0YWJsZS1pbnZlcnNlIiBmaWxsPSIjZmZmIj4KICAgIDxwYXRoIGQ9Ik0xMDUgMTI3LjNoNDB2MTIuOGgtNDB6TTUxLjEgNzdMNzQgOTkuOWwtMjMuMyAyMy4zIDEwLjUgMTAuNSAyMy4zLTIzLjNMOTUgOTkuOSA4NC41IDg5LjQgNjEuNiA2Ni41eiIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-copy: url(data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMTggMTgiIHdpZHRoPSIxNiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTExLjksMUgzLjJDMi40LDEsMS43LDEuNywxLjcsMi41djEwLjJoMS41VjIuNWg4LjdWMXogTTE0LjEsMy45aC04Yy0wLjgsMC0xLjUsMC43LTEuNSwxLjV2MTAuMmMwLDAuOCwwLjcsMS41LDEuNSwxLjVoOCBjMC44LDAsMS41LTAuNywxLjUtMS41VjUuNEMxNS41LDQuNiwxNC45LDMuOSwxNC4xLDMuOXogTTE0LjEsMTUuNWgtOFY1LjRoOFYxNS41eiIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-copyright: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGVuYWJsZS1iYWNrZ3JvdW5kPSJuZXcgMCAwIDI0IDI0IiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIyNCI+CiAgPGcgY2xhc3M9ImpwLWljb24zIiBmaWxsPSIjNjE2MTYxIj4KICAgIDxwYXRoIGQ9Ik0xMS44OCw5LjE0YzEuMjgsMC4wNiwxLjYxLDEuMTUsMS42MywxLjY2aDEuNzljLTAuMDgtMS45OC0xLjQ5LTMuMTktMy40NS0zLjE5QzkuNjQsNy42MSw4LDksOCwxMi4xNCBjMCwxLjk0LDAuOTMsNC4yNCwzLjg0LDQuMjRjMi4yMiwwLDMuNDEtMS42NSwzLjQ0LTIuOTVoLTEuNzljLTAuMDMsMC41OS0wLjQ1LDEuMzgtMS42MywxLjQ0QzEwLjU1LDE0LjgzLDEwLDEzLjgxLDEwLDEyLjE0IEMxMCw5LjI1LDExLjI4LDkuMTYsMTEuODgsOS4xNHogTTEyLDJDNi40OCwyLDIsNi40OCwyLDEyczQuNDgsMTAsMTAsMTBzMTAtNC40OCwxMC0xMFMxNy41MiwyLDEyLDJ6IE0xMiwyMGMtNC40MSwwLTgtMy41OS04LTggczMuNTktOCw4LThzOCwzLjU5LDgsOFMxNi40MSwyMCwxMiwyMHoiLz4KICA8L2c+Cjwvc3ZnPgo=);
  --jp-icon-cut: url(data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIxNiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTkuNjQgNy42NGMuMjMtLjUuMzYtMS4wNS4zNi0xLjY0IDAtMi4yMS0xLjc5LTQtNC00UzIgMy43OSAyIDZzMS43OSA0IDQgNGMuNTkgMCAxLjE0LS4xMyAxLjY0LS4zNkwxMCAxMmwtMi4zNiAyLjM2QzcuMTQgMTQuMTMgNi41OSAxNCA2IDE0Yy0yLjIxIDAtNCAxLjc5LTQgNHMxLjc5IDQgNCA0IDQtMS43OSA0LTRjMC0uNTktLjEzLTEuMTQtLjM2LTEuNjRMMTIgMTRsNyA3aDN2LTFMOS42NCA3LjY0ek02IDhjLTEuMSAwLTItLjg5LTItMnMuOS0yIDItMiAyIC44OSAyIDItLjkgMi0yIDJ6bTAgMTJjLTEuMSAwLTItLjg5LTItMnMuOS0yIDItMiAyIC44OSAyIDItLjkgMi0yIDJ6bTYtNy41Yy0uMjggMC0uNS0uMjItLjUtLjVzLjIyLS41LjUtLjUuNS4yMi41LjUtLjIyLjUtLjUuNXpNMTkgM2wtNiA2IDIgMiA3LTdWM3oiLz4KICA8L2c+Cjwvc3ZnPgo=);
  --jp-icon-delete: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjE2cHgiIGhlaWdodD0iMTZweCI+CiAgICA8cGF0aCBkPSJNMCAwaDI0djI0SDB6IiBmaWxsPSJub25lIiAvPgogICAgPHBhdGggY2xhc3M9ImpwLWljb24zIiBmaWxsPSIjNjI2MjYyIiBkPSJNNiAxOWMwIDEuMS45IDIgMiAyaDhjMS4xIDAgMi0uOSAyLTJWN0g2djEyek0xOSA0aC0zLjVsLTEtMWgtNWwtMSAxSDV2MmgxNFY0eiIgLz4KPC9zdmc+Cg==);
  --jp-icon-download: url(data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIxNiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTE5IDloLTRWM0g5djZINWw3IDcgNy03ek01IDE4djJoMTR2LTJINXoiLz4KICA8L2c+Cjwvc3ZnPgo=);
  --jp-icon-duplicate: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTQiIGhlaWdodD0iMTQiIHZpZXdCb3g9IjAgMCAxNCAxNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggY2xhc3M9ImpwLWljb24zIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIGNsaXAtcnVsZT0iZXZlbm9kZCIgZD0iTTIuNzk5OTggMC44NzVIOC44OTU4MkM5LjIwMDYxIDAuODc1IDkuNDQ5OTggMS4xMzkxNCA5LjQ0OTk4IDEuNDYxOThDOS40NDk5OCAxLjc4NDgyIDkuMjAwNjEgMi4wNDg5NiA4Ljg5NTgyIDIuMDQ4OTZIMy4zNTQxNUMzLjA0OTM2IDIuMDQ4OTYgMi43OTk5OCAyLjMxMzEgMi43OTk5OCAyLjYzNTk0VjkuNjc5NjlDMi43OTk5OCAxMC4wMDI1IDIuNTUwNjEgMTAuMjY2NyAyLjI0NTgyIDEwLjI2NjdDMS45NDEwMyAxMC4yNjY3IDEuNjkxNjUgMTAuMDAyNSAxLjY5MTY1IDkuNjc5NjlWMi4wNDg5NkMxLjY5MTY1IDEuNDAzMjggMi4xOTA0IDAuODc1IDIuNzk5OTggMC44NzVaTTUuMzY2NjUgMTEuOVY0LjU1SDExLjA4MzNWMTEuOUg1LjM2NjY1Wk00LjE0MTY1IDQuMTQxNjdDNC4xNDE2NSAzLjY5MDYzIDQuNTA3MjggMy4zMjUgNC45NTgzMiAzLjMyNUgxMS40OTE3QzExLjk0MjcgMy4zMjUgMTIuMzA4MyAzLjY5MDYzIDEyLjMwODMgNC4xNDE2N1YxMi4zMDgzQzEyLjMwODMgMTIuNzU5NCAxMS45NDI3IDEzLjEyNSAxMS40OTE3IDEzLjEyNUg0Ljk1ODMyQzQuNTA3MjggMTMuMTI1IDQuMTQxNjUgMTIuNzU5NCA0LjE0MTY1IDEyLjMwODNWNC4xNDE2N1oiIGZpbGw9IiM2MTYxNjEiLz4KPHBhdGggY2xhc3M9ImpwLWljb24zIiBkPSJNOS40MzU3NCA4LjI2NTA3SDguMzY0MzFWOS4zMzY1QzguMzY0MzEgOS40NTQzNSA4LjI2Nzg4IDkuNTUwNzggOC4xNTAwMiA5LjU1MDc4QzguMDMyMTcgOS41NTA3OCA3LjkzNTc0IDkuNDU0MzUgNy45MzU3NCA5LjMzNjVWOC4yNjUwN0g2Ljg2NDMxQzYuNzQ2NDUgOC4yNjUwNyA2LjY1MDAyIDguMTY4NjQgNi42NTAwMiA4LjA1MDc4QzYuNjUwMDIgNy45MzI5MiA2Ljc0NjQ1IDcuODM2NSA2Ljg2NDMxIDcuODM2NUg3LjkzNTc0VjYuNzY1MDdDNy45MzU3NCA2LjY0NzIxIDguMDMyMTcgNi41NTA3OCA4LjE1MDAyIDYuNTUwNzhDOC4yNjc4OCA2LjU1MDc4IDguMzY0MzEgNi42NDcyMSA4LjM2NDMxIDYuNzY1MDdWNy44MzY1SDkuNDM1NzRDOS41NTM2IDcuODM2NSA5LjY1MDAyIDcuOTMyOTIgOS42NTAwMiA4LjA1MDc4QzkuNjUwMDIgOC4xNjg2NCA5LjU1MzYgOC4yNjUwNyA5LjQzNTc0IDguMjY1MDdaIiBmaWxsPSIjNjE2MTYxIiBzdHJva2U9IiM2MTYxNjEiIHN0cm9rZS13aWR0aD0iMC41Ii8+Cjwvc3ZnPgo=);
  --jp-icon-edit: url(data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIxNiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTMgMTcuMjVWMjFoMy43NUwxNy44MSA5Ljk0bC0zLjc1LTMuNzVMMyAxNy4yNXpNMjAuNzEgNy4wNGMuMzktLjM5LjM5LTEuMDIgMC0xLjQxbC0yLjM0LTIuMzRjLS4zOS0uMzktMS4wMi0uMzktMS40MSAwbC0xLjgzIDEuODMgMy43NSAzLjc1IDEuODMtMS44M3oiLz4KICA8L2c+Cjwvc3ZnPgo=);
  --jp-icon-ellipses: url(data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIxNiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPGNpcmNsZSBjeD0iNSIgY3k9IjEyIiByPSIyIi8+CiAgICA8Y2lyY2xlIGN4PSIxMiIgY3k9IjEyIiByPSIyIi8+CiAgICA8Y2lyY2xlIGN4PSIxOSIgY3k9IjEyIiByPSIyIi8+CiAgPC9nPgo8L3N2Zz4K);
  --jp-icon-error: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KPGcgY2xhc3M9ImpwLWljb24zIiBmaWxsPSIjNjE2MTYxIj48Y2lyY2xlIGN4PSIxMiIgY3k9IjE5IiByPSIyIi8+PHBhdGggZD0iTTEwIDNoNHYxMmgtNHoiLz48L2c+CjxwYXRoIGZpbGw9Im5vbmUiIGQ9Ik0wIDBoMjR2MjRIMHoiLz4KPC9zdmc+Cg==);
  --jp-icon-expand-all: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICAgIDxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSI+CiAgICAgICAgPHBhdGgKICAgICAgICAgICAgZD0iTTggMmMxIDAgMTEgMCAxMiAwczIgMSAyIDJjMCAxIDAgMTEgMCAxMnMwIDItMiAyQzIwIDE0IDIwIDQgMjAgNFMxMCA0IDYgNGMwLTIgMS0yIDItMnoiIC8+CiAgICAgICAgPHBhdGgKICAgICAgICAgICAgZD0iTTE4IDhjMC0xLTEtMi0yLTJTNSA2IDQgNnMtMiAxLTIgMmMwIDEgMCAxMSAwIDEyczEgMiAyIDJjMSAwIDExIDAgMTIgMHMyLTEgMi0yYzAtMSAwLTExIDAtMTJ6bS0yIDB2MTJINFY4eiIgLz4KICAgICAgICA8cGF0aCBkPSJNMTEgMTBIOXYzSDZ2MmgzdjNoMnYtM2gzdi0yaC0zeiIgLz4KICAgIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-extension: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTIwLjUgMTFIMTlWN2MwLTEuMS0uOS0yLTItMmgtNFYzLjVDMTMgMi4xMiAxMS44OCAxIDEwLjUgMVM4IDIuMTIgOCAzLjVWNUg0Yy0xLjEgMC0xLjk5LjktMS45OSAydjMuOEgzLjVjMS40OSAwIDIuNyAxLjIxIDIuNyAyLjdzLTEuMjEgMi43LTIuNyAyLjdIMlYyMGMwIDEuMS45IDIgMiAyaDMuOHYtMS41YzAtMS40OSAxLjIxLTIuNyAyLjctMi43IDEuNDkgMCAyLjcgMS4yMSAyLjcgMi43VjIySDE3YzEuMSAwIDItLjkgMi0ydi00aDEuNWMxLjM4IDAgMi41LTEuMTIgMi41LTIuNVMyMS44OCAxMSAyMC41IDExeiIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-fast-forward: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICAgIDxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSI+CiAgICAgICAgPHBhdGggZD0iTTQgMThsOC41LTZMNCA2djEyem05LTEydjEybDguNS02TDEzIDZ6Ii8+CiAgICA8L2c+Cjwvc3ZnPgo=);
  --jp-icon-file-upload: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTkgMTZoNnYtNmg0bC03LTctNyA3aDR6bS00IDJoMTR2Mkg1eiIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-file: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDIyIDIyIj4KICA8cGF0aCBjbGFzcz0ianAtaWNvbjMganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjNjE2MTYxIiBkPSJNMTkuMyA4LjJsLTUuNS01LjVjLS4zLS4zLS43LS41LTEuMi0uNUgzLjljLS44LjEtMS42LjktMS42IDEuOHYxNC4xYzAgLjkuNyAxLjYgMS42IDEuNmgxNC4yYy45IDAgMS42LS43IDEuNi0xLjZWOS40Yy4xLS41LS4xLS45LS40LTEuMnptLTUuOC0zLjNsMy40IDMuNmgtMy40VjQuOXptMy45IDEyLjdINC43Yy0uMSAwLS4yIDAtLjItLjJWNC43YzAtLjIuMS0uMy4yLS4zaDcuMnY0LjRzMCAuOC4zIDEuMWMuMy4zIDEuMS4zIDEuMS4zaDQuM3Y3LjJzLS4xLjItLjIuMnoiLz4KPC9zdmc+Cg==);
  --jp-icon-filter-dot: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiNGRkYiPgogICAgPHBhdGggZD0iTTE0LDEyVjE5Ljg4QzE0LjA0LDIwLjE4IDEzLjk0LDIwLjUgMTMuNzEsMjAuNzFDMTMuMzIsMjEuMSAxMi42OSwyMS4xIDEyLjMsMjAuNzFMMTAuMjksMTguN0MxMC4wNiwxOC40NyA5Ljk2LDE4LjE2IDEwLDE3Ljg3VjEySDkuOTdMNC4yMSw0LjYyQzMuODcsNC4xOSAzLjk1LDMuNTYgNC4zOCwzLjIyQzQuNTcsMy4wOCA0Ljc4LDMgNSwzVjNIMTlWM0MxOS4yMiwzIDE5LjQzLDMuMDggMTkuNjIsMy4yMkMyMC4wNSwzLjU2IDIwLjEzLDQuMTkgMTkuNzksNC42MkwxNC4wMywxMkgxNFoiIC8+CiAgPC9nPgogIDxnIGNsYXNzPSJqcC1pY29uLWRvdCIgZmlsbD0iI0ZGRiI+CiAgICA8Y2lyY2xlIGN4PSIxOCIgY3k9IjE3IiByPSIzIj48L2NpcmNsZT4KICA8L2c+Cjwvc3ZnPgo=);
  --jp-icon-filter-list: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTEwIDE4aDR2LTJoLTR2MnpNMyA2djJoMThWNkgzem0zIDdoMTJ2LTJINnYyeiIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-filter: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiNGRkYiPgogICAgPHBhdGggZD0iTTE0LDEyVjE5Ljg4QzE0LjA0LDIwLjE4IDEzLjk0LDIwLjUgMTMuNzEsMjAuNzFDMTMuMzIsMjEuMSAxMi42OSwyMS4xIDEyLjMsMjAuNzFMMTAuMjksMTguN0MxMC4wNiwxOC40NyA5Ljk2LDE4LjE2IDEwLDE3Ljg3VjEySDkuOTdMNC4yMSw0LjYyQzMuODcsNC4xOSAzLjk1LDMuNTYgNC4zOCwzLjIyQzQuNTcsMy4wOCA0Ljc4LDMgNSwzVjNIMTlWM0MxOS4yMiwzIDE5LjQzLDMuMDggMTkuNjIsMy4yMkMyMC4wNSwzLjU2IDIwLjEzLDQuMTkgMTkuNzksNC42MkwxNC4wMywxMkgxNFoiIC8+CiAgPC9nPgo8L3N2Zz4K);
  --jp-icon-folder-favorite: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjRweCIgdmlld0JveD0iMCAwIDI0IDI0IiB3aWR0aD0iMjRweCIgZmlsbD0iIzAwMDAwMCI+CiAgPHBhdGggZD0iTTAgMGgyNHYyNEgwVjB6IiBmaWxsPSJub25lIi8+PHBhdGggY2xhc3M9ImpwLWljb24zIGpwLWljb24tc2VsZWN0YWJsZSIgZmlsbD0iIzYxNjE2MSIgZD0iTTIwIDZoLThsLTItMkg0Yy0xLjEgMC0yIC45LTIgMnYxMmMwIDEuMS45IDIgMiAyaDE2YzEuMSAwIDItLjkgMi0yVjhjMC0xLjEtLjktMi0yLTJ6bS0yLjA2IDExTDE1IDE1LjI4IDEyLjA2IDE3bC43OC0zLjMzLTIuNTktMi4yNCAzLjQxLS4yOUwxNSA4bDEuMzQgMy4xNCAzLjQxLjI5LTIuNTkgMi4yNC43OCAzLjMzeiIvPgo8L3N2Zz4K);
  --jp-icon-folder: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8cGF0aCBjbGFzcz0ianAtaWNvbjMganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjNjE2MTYxIiBkPSJNMTAgNEg0Yy0xLjEgMC0xLjk5LjktMS45OSAyTDIgMThjMCAxLjEuOSAyIDIgMmgxNmMxLjEgMCAyLS45IDItMlY4YzAtMS4xLS45LTItMi0yaC04bC0yLTJ6Ii8+Cjwvc3ZnPgo=);
  --jp-icon-home: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjRweCIgdmlld0JveD0iMCAwIDI0IDI0IiB3aWR0aD0iMjRweCIgZmlsbD0iIzAwMDAwMCI+CiAgPHBhdGggZD0iTTAgMGgyNHYyNEgweiIgZmlsbD0ibm9uZSIvPjxwYXRoIGNsYXNzPSJqcC1pY29uMyBqcC1pY29uLXNlbGVjdGFibGUiIGZpbGw9IiM2MTYxNjEiIGQ9Ik0xMCAyMHYtNmg0djZoNXYtOGgzTDEyIDMgMiAxMmgzdjh6Ii8+Cjwvc3ZnPgo=);
  --jp-icon-html5: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDUxMiA1MTIiPgogIDxwYXRoIGNsYXNzPSJqcC1pY29uMCBqcC1pY29uLXNlbGVjdGFibGUiIGZpbGw9IiMwMDAiIGQ9Ik0xMDguNCAwaDIzdjIyLjhoMjEuMlYwaDIzdjY5aC0yM1Y0NmgtMjF2MjNoLTIzLjJNMjA2IDIzaC0yMC4zVjBoNjMuN3YyM0gyMjl2NDZoLTIzbTUzLjUtNjloMjQuMWwxNC44IDI0LjNMMzEzLjIgMGgyNC4xdjY5aC0yM1YzNC44bC0xNi4xIDI0LjgtMTYuMS0yNC44VjY5aC0yMi42bTg5LjItNjloMjN2NDYuMmgzMi42VjY5aC01NS42Ii8+CiAgPHBhdGggY2xhc3M9ImpwLWljb24tc2VsZWN0YWJsZSIgZmlsbD0iI2U0NGQyNiIgZD0iTTEwNy42IDQ3MWwtMzMtMzcwLjRoMzYyLjhsLTMzIDM3MC4yTDI1NS43IDUxMiIvPgogIDxwYXRoIGNsYXNzPSJqcC1pY29uLXNlbGVjdGFibGUiIGZpbGw9IiNmMTY1MjkiIGQ9Ik0yNTYgNDgwLjVWMTMxaDE0OC4zTDM3NiA0NDciLz4KICA8cGF0aCBjbGFzcz0ianAtaWNvbi1zZWxlY3RhYmxlLWludmVyc2UiIGZpbGw9IiNlYmViZWIiIGQ9Ik0xNDIgMTc2LjNoMTE0djQ1LjRoLTY0LjJsNC4yIDQ2LjVoNjB2NDUuM0gxNTQuNG0yIDIyLjhIMjAybDMuMiAzNi4zIDUwLjggMTMuNnY0Ny40bC05My4yLTI2Ii8+CiAgPHBhdGggY2xhc3M9ImpwLWljb24tc2VsZWN0YWJsZS1pbnZlcnNlIiBmaWxsPSIjZmZmIiBkPSJNMzY5LjYgMTc2LjNIMjU1Ljh2NDUuNGgxMDkuNm0tNC4xIDQ2LjVIMjU1Ljh2NDUuNGg1NmwtNS4zIDU5LTUwLjcgMTMuNnY0Ny4ybDkzLTI1LjgiLz4KPC9zdmc+Cg==);
  --jp-icon-image: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDIyIDIyIj4KICA8cGF0aCBjbGFzcz0ianAtaWNvbi1icmFuZDQganAtaWNvbi1zZWxlY3RhYmxlLWludmVyc2UiIGZpbGw9IiNGRkYiIGQ9Ik0yLjIgMi4yaDE3LjV2MTcuNUgyLjJ6Ii8+CiAgPHBhdGggY2xhc3M9ImpwLWljb24tYnJhbmQwIGpwLWljb24tc2VsZWN0YWJsZSIgZmlsbD0iIzNGNTFCNSIgZD0iTTIuMiAyLjJ2MTcuNWgxNy41bC4xLTE3LjVIMi4yem0xMi4xIDIuMmMxLjIgMCAyLjIgMSAyLjIgMi4ycy0xIDIuMi0yLjIgMi4yLTIuMi0xLTIuMi0yLjIgMS0yLjIgMi4yLTIuMnpNNC40IDE3LjZsMy4zLTguOCAzLjMgNi42IDIuMi0zLjIgNC40IDUuNEg0LjR6Ii8+Cjwvc3ZnPgo=);
  --jp-icon-info: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDUwLjk3OCA1MC45NzgiPgoJPGcgY2xhc3M9ImpwLWljb24zIiBmaWxsPSIjNjE2MTYxIj4KCQk8cGF0aCBkPSJNNDMuNTIsNy40NThDMzguNzExLDIuNjQ4LDMyLjMwNywwLDI1LjQ4OSwwQzE4LjY3LDAsMTIuMjY2LDIuNjQ4LDcuNDU4LDcuNDU4CgkJCWMtOS45NDMsOS45NDEtOS45NDMsMjYuMTE5LDAsMzYuMDYyYzQuODA5LDQuODA5LDExLjIxMiw3LjQ1NiwxOC4wMzEsNy40NThjMCwwLDAuMDAxLDAsMC4wMDIsMAoJCQljNi44MTYsMCwxMy4yMjEtMi42NDgsMTguMDI5LTcuNDU4YzQuODA5LTQuODA5LDcuNDU3LTExLjIxMiw3LjQ1Ny0xOC4wM0M1MC45NzcsMTguNjcsNDguMzI4LDEyLjI2Niw0My41Miw3LjQ1OHoKCQkJIE00Mi4xMDYsNDIuMTA1Yy00LjQzMiw0LjQzMS0xMC4zMzIsNi44NzItMTYuNjE1LDYuODcyaC0wLjAwMmMtNi4yODUtMC4wMDEtMTIuMTg3LTIuNDQxLTE2LjYxNy02Ljg3MgoJCQljLTkuMTYyLTkuMTYzLTkuMTYyLTI0LjA3MSwwLTMzLjIzM0MxMy4zMDMsNC40NCwxOS4yMDQsMiwyNS40ODksMmM2LjI4NCwwLDEyLjE4NiwyLjQ0LDE2LjYxNyw2Ljg3MgoJCQljNC40MzEsNC40MzEsNi44NzEsMTAuMzMyLDYuODcxLDE2LjYxN0M0OC45NzcsMzEuNzcyLDQ2LjUzNiwzNy42NzUsNDIuMTA2LDQyLjEwNXoiLz4KCQk8cGF0aCBkPSJNMjMuNTc4LDMyLjIxOGMtMC4wMjMtMS43MzQsMC4xNDMtMy4wNTksMC40OTYtMy45NzJjMC4zNTMtMC45MTMsMS4xMS0xLjk5NywyLjI3Mi0zLjI1MwoJCQljMC40NjgtMC41MzYsMC45MjMtMS4wNjIsMS4zNjctMS41NzVjMC42MjYtMC43NTMsMS4xMDQtMS40NzgsMS40MzYtMi4xNzVjMC4zMzEtMC43MDcsMC40OTUtMS41NDEsMC40OTUtMi41CgkJCWMwLTEuMDk2LTAuMjYtMi4wODgtMC43NzktMi45NzljLTAuNTY1LTAuODc5LTEuNTAxLTEuMzM2LTIuODA2LTEuMzY5Yy0xLjgwMiwwLjA1Ny0yLjk4NSwwLjY2Ny0zLjU1LDEuODMyCgkJCWMtMC4zMDEsMC41MzUtMC41MDMsMS4xNDEtMC42MDcsMS44MTRjLTAuMTM5LDAuNzA3LTAuMjA3LDEuNDMyLTAuMjA3LDIuMTc0aC0yLjkzN2MtMC4wOTEtMi4yMDgsMC40MDctNC4xMTQsMS40OTMtNS43MTkKCQkJYzEuMDYyLTEuNjQsMi44NTUtMi40ODEsNS4zNzgtMi41MjdjMi4xNiwwLjAyMywzLjg3NCwwLjYwOCw1LjE0MSwxLjc1OGMxLjI3OCwxLjE2LDEuOTI5LDIuNzY0LDEuOTUsNC44MTEKCQkJYzAsMS4xNDItMC4xMzcsMi4xMTEtMC40MSwyLjkxMWMtMC4zMDksMC44NDUtMC43MzEsMS41OTMtMS4yNjgsMi4yNDNjLTAuNDkyLDAuNjUtMS4wNjgsMS4zMTgtMS43MywyLjAwMgoJCQljLTAuNjUsMC42OTctMS4zMTMsMS40NzktMS45ODcsMi4zNDZjLTAuMjM5LDAuMzc3LTAuNDI5LDAuNzc3LTAuNTY1LDEuMTk5Yy0wLjE2LDAuOTU5LTAuMjE3LDEuOTUxLTAuMTcxLDIuOTc5CgkJCUMyNi41ODksMzIuMjE4LDIzLjU3OCwzMi4yMTgsMjMuNTc4LDMyLjIxOHogTTIzLjU3OCwzOC4yMnYtMy40ODRoMy4wNzZ2My40ODRIMjMuNTc4eiIvPgoJPC9nPgo8L3N2Zz4K);
  --jp-icon-inspector: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8cGF0aCBjbGFzcz0ianAtaW5zcGVjdG9yLWljb24tY29sb3IganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjNjE2MTYxIiBkPSJNMjAgNEg0Yy0xLjEgMC0xLjk5LjktMS45OSAyTDIgMThjMCAxLjEuOSAyIDIgMmgxNmMxLjEgMCAyLS45IDItMlY2YzAtMS4xLS45LTItMi0yem0tNSAxNEg0di00aDExdjR6bTAtNUg0VjloMTF2NHptNSA1aC00VjloNHY5eiIvPgo8L3N2Zz4K);
  --jp-icon-json: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDIyIDIyIj4KICA8ZyBjbGFzcz0ianAtanNvbi1pY29uLWNvbG9yIGpwLWljb24tc2VsZWN0YWJsZSIgZmlsbD0iI0Y5QTgyNSI+CiAgICA8cGF0aCBkPSJNMjAuMiAxMS44Yy0xLjYgMC0xLjcuNS0xLjcgMSAwIC40LjEuOS4xIDEuMy4xLjUuMS45LjEgMS4zIDAgMS43LTEuNCAyLjMtMy41IDIuM2gtLjl2LTEuOWguNWMxLjEgMCAxLjQgMCAxLjQtLjggMC0uMyAwLS42LS4xLTEgMC0uNC0uMS0uOC0uMS0xLjIgMC0xLjMgMC0xLjggMS4zLTItMS4zLS4yLTEuMy0uNy0xLjMtMiAwLS40LjEtLjguMS0xLjIuMS0uNC4xLS43LjEtMSAwLS44LS40LS43LTEuNC0uOGgtLjVWNC4xaC45YzIuMiAwIDMuNS43IDMuNSAyLjMgMCAuNC0uMS45LS4xIDEuMy0uMS41LS4xLjktLjEgMS4zIDAgLjUuMiAxIDEuNyAxdjEuOHpNMS44IDEwLjFjMS42IDAgMS43LS41IDEuNy0xIDAtLjQtLjEtLjktLjEtMS4zLS4xLS41LS4xLS45LS4xLTEuMyAwLTEuNiAxLjQtMi4zIDMuNS0yLjNoLjl2MS45aC0uNWMtMSAwLTEuNCAwLTEuNC44IDAgLjMgMCAuNi4xIDEgMCAuMi4xLjYuMSAxIDAgMS4zIDAgMS44LTEuMyAyQzYgMTEuMiA2IDExLjcgNiAxM2MwIC40LS4xLjgtLjEgMS4yLS4xLjMtLjEuNy0uMSAxIDAgLjguMy44IDEuNC44aC41djEuOWgtLjljLTIuMSAwLTMuNS0uNi0zLjUtMi4zIDAtLjQuMS0uOS4xLTEuMy4xLS41LjEtLjkuMS0xLjMgMC0uNS0uMi0xLTEuNy0xdi0xLjl6Ii8+CiAgICA8Y2lyY2xlIGN4PSIxMSIgY3k9IjEzLjgiIHI9IjIuMSIvPgogICAgPGNpcmNsZSBjeD0iMTEiIGN5PSI4LjIiIHI9IjIuMSIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-julia: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDMyNSAzMDAiPgogIDxnIGNsYXNzPSJqcC1icmFuZDAganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjY2IzYzMzIj4KICAgIDxwYXRoIGQ9Ik0gMTUwLjg5ODQzOCAyMjUgQyAxNTAuODk4NDM4IDI2Ni40MjE4NzUgMTE3LjMyMDMxMiAzMDAgNzUuODk4NDM4IDMwMCBDIDM0LjQ3NjU2MiAzMDAgMC44OTg0MzggMjY2LjQyMTg3NSAwLjg5ODQzOCAyMjUgQyAwLjg5ODQzOCAxODMuNTc4MTI1IDM0LjQ3NjU2MiAxNTAgNzUuODk4NDM4IDE1MCBDIDExNy4zMjAzMTIgMTUwIDE1MC44OTg0MzggMTgzLjU3ODEyNSAxNTAuODk4NDM4IDIyNSIvPgogIDwvZz4KICA8ZyBjbGFzcz0ianAtYnJhbmQwIGpwLWljb24tc2VsZWN0YWJsZSIgZmlsbD0iIzM4OTgyNiI+CiAgICA8cGF0aCBkPSJNIDIzNy41IDc1IEMgMjM3LjUgMTE2LjQyMTg3NSAyMDMuOTIxODc1IDE1MCAxNjIuNSAxNTAgQyAxMjEuMDc4MTI1IDE1MCA4Ny41IDExNi40MjE4NzUgODcuNSA3NSBDIDg3LjUgMzMuNTc4MTI1IDEyMS4wNzgxMjUgMCAxNjIuNSAwIEMgMjAzLjkyMTg3NSAwIDIzNy41IDMzLjU3ODEyNSAyMzcuNSA3NSIvPgogIDwvZz4KICA8ZyBjbGFzcz0ianAtYnJhbmQwIGpwLWljb24tc2VsZWN0YWJsZSIgZmlsbD0iIzk1NThiMiI+CiAgICA8cGF0aCBkPSJNIDMyNC4xMDE1NjIgMjI1IEMgMzI0LjEwMTU2MiAyNjYuNDIxODc1IDI5MC41MjM0MzggMzAwIDI0OS4xMDE1NjIgMzAwIEMgMjA3LjY3OTY4OCAzMDAgMTc0LjEwMTU2MiAyNjYuNDIxODc1IDE3NC4xMDE1NjIgMjI1IEMgMTc0LjEwMTU2MiAxODMuNTc4MTI1IDIwNy42Nzk2ODggMTUwIDI0OS4xMDE1NjIgMTUwIEMgMjkwLjUyMzQzOCAxNTAgMzI0LjEwMTU2MiAxODMuNTc4MTI1IDMyNC4xMDE1NjIgMjI1Ii8+CiAgPC9nPgo8L3N2Zz4K);
  --jp-icon-jupyter-favicon: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUyIiBoZWlnaHQ9IjE2NSIgdmlld0JveD0iMCAwIDE1MiAxNjUiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICAgPGcgY2xhc3M9ImpwLWp1cHl0ZXItaWNvbi1jb2xvciIgZmlsbD0iI0YzNzcyNiI+CiAgICA8cGF0aCB0cmFuc2Zvcm09InRyYW5zbGF0ZSgwLjA3ODk0NywgMTEwLjU4MjkyNykiIGQ9Ik03NS45NDIyODQyLDI5LjU4MDQ1NjEgQzQzLjMwMjM5NDcsMjkuNTgwNDU2MSAxNC43OTY3ODMyLDE3LjY1MzQ2MzQgMCwwIEM1LjUxMDgzMjExLDE1Ljg0MDY4MjkgMTUuNzgxNTM4OSwyOS41NjY3NzMyIDI5LjM5MDQ5NDcsMzkuMjc4NDE3MSBDNDIuOTk5Nyw0OC45ODk4NTM3IDU5LjI3MzcsNTQuMjA2NzgwNSA3NS45NjA1Nzg5LDU0LjIwNjc4MDUgQzkyLjY0NzQ1NzksNTQuMjA2NzgwNSAxMDguOTIxNDU4LDQ4Ljk4OTg1MzcgMTIyLjUzMDY2MywzOS4yNzg0MTcxIEMxMzYuMTM5NDUzLDI5LjU2Njc3MzIgMTQ2LjQxMDI4NCwxNS44NDA2ODI5IDE1MS45MjExNTgsMCBDMTM3LjA4Nzg2OCwxNy42NTM0NjM0IDEwOC41ODI1ODksMjkuNTgwNDU2MSA3NS45NDIyODQyLDI5LjU4MDQ1NjEgTDc1Ljk0MjI4NDIsMjkuNTgwNDU2MSBaIiAvPgogICAgPHBhdGggdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMC4wMzczNjgsIDAuNzA0ODc4KSIgZD0iTTc1Ljk3ODQ1NzksMjQuNjI2NDA3MyBDMTA4LjYxODc2MywyNC42MjY0MDczIDEzNy4xMjQ0NTgsMzYuNTUzNDQxNSAxNTEuOTIxMTU4LDU0LjIwNjc4MDUgQzE0Ni40MTAyODQsMzguMzY2MjIyIDEzNi4xMzk0NTMsMjQuNjQwMTMxNyAxMjIuNTMwNjYzLDE0LjkyODQ4NzggQzEwOC45MjE0NTgsNS4yMTY4NDM5IDkyLjY0NzQ1NzksMCA3NS45NjA1Nzg5LDAgQzU5LjI3MzcsMCA0Mi45OTk3LDUuMjE2ODQzOSAyOS4zOTA0OTQ3LDE0LjkyODQ4NzggQzE1Ljc4MTUzODksMjQuNjQwMTMxNyA1LjUxMDgzMjExLDM4LjM2NjIyMiAwLDU0LjIwNjc4MDUgQzE0LjgzMzA4MTYsMzYuNTg5OTI5MyA0My4zMzg1Njg0LDI0LjYyNjQwNzMgNzUuOTc4NDU3OSwyNC42MjY0MDczIEw3NS45Nzg0NTc5LDI0LjYyNjQwNzMgWiIgLz4KICA8L2c+Cjwvc3ZnPgo=);
  --jp-icon-jupyter: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzkiIGhlaWdodD0iNTEiIHZpZXdCb3g9IjAgMCAzOSA1MSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMTYzOCAtMjI4MSkiPgogICAgIDxnIGNsYXNzPSJqcC1qdXB5dGVyLWljb24tY29sb3IiIGZpbGw9IiNGMzc3MjYiPgogICAgICA8cGF0aCB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxNjM5Ljc0IDIzMTEuOTgpIiBkPSJNIDE4LjI2NDYgNy4xMzQxMUMgMTAuNDE0NSA3LjEzNDExIDMuNTU4NzIgNC4yNTc2IDAgMEMgMS4zMjUzOSAzLjgyMDQgMy43OTU1NiA3LjEzMDgxIDcuMDY4NiA5LjQ3MzAzQyAxMC4zNDE3IDExLjgxNTIgMTQuMjU1NyAxMy4wNzM0IDE4LjI2OSAxMy4wNzM0QyAyMi4yODIzIDEzLjA3MzQgMjYuMTk2MyAxMS44MTUyIDI5LjQ2OTQgOS40NzMwM0MgMzIuNzQyNCA3LjEzMDgxIDM1LjIxMjYgMy44MjA0IDM2LjUzOCAwQyAzMi45NzA1IDQuMjU3NiAyNi4xMTQ4IDcuMTM0MTEgMTguMjY0NiA3LjEzNDExWiIvPgogICAgICA8cGF0aCB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxNjM5LjczIDIyODUuNDgpIiBkPSJNIDE4LjI3MzMgNS45MzkzMUMgMjYuMTIzNSA1LjkzOTMxIDMyLjk3OTMgOC44MTU4MyAzNi41MzggMTMuMDczNEMgMzUuMjEyNiA5LjI1MzAzIDMyLjc0MjQgNS45NDI2MiAyOS40Njk0IDMuNjAwNEMgMjYuMTk2MyAxLjI1ODE4IDIyLjI4MjMgMCAxOC4yNjkgMEMgMTQuMjU1NyAwIDEwLjM0MTcgMS4yNTgxOCA3LjA2ODYgMy42MDA0QyAzLjc5NTU2IDUuOTQyNjIgMS4zMjUzOSA5LjI1MzAzIDAgMTMuMDczNEMgMy41Njc0NSA4LjgyNDYzIDEwLjQyMzIgNS45MzkzMSAxOC4yNzMzIDUuOTM5MzFaIi8+CiAgICA8L2c+CiAgICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgICA8cGF0aCB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxNjY5LjMgMjI4MS4zMSkiIGQ9Ik0gNS44OTM1MyAyLjg0NEMgNS45MTg4OSAzLjQzMTY1IDUuNzcwODUgNC4wMTM2NyA1LjQ2ODE1IDQuNTE2NDVDIDUuMTY1NDUgNS4wMTkyMiA0LjcyMTY4IDUuNDIwMTUgNC4xOTI5OSA1LjY2ODUxQyAzLjY2NDMgNS45MTY4OCAzLjA3NDQ0IDYuMDAxNTEgMi40OTgwNSA1LjkxMTcxQyAxLjkyMTY2IDUuODIxOSAxLjM4NDYzIDUuNTYxNyAwLjk1NDg5OCA1LjE2NDAxQyAwLjUyNTE3IDQuNzY2MzMgMC4yMjIwNTYgNC4yNDkwMyAwLjA4MzkwMzcgMy42Nzc1N0MgLTAuMDU0MjQ4MyAzLjEwNjExIC0wLjAyMTIzIDIuNTA2MTcgMC4xNzg3ODEgMS45NTM2NEMgMC4zNzg3OTMgMS40MDExIDAuNzM2ODA5IDAuOTIwODE3IDEuMjA3NTQgMC41NzM1MzhDIDEuNjc4MjYgMC4yMjYyNTkgMi4yNDA1NSAwLjAyNzU5MTkgMi44MjMyNiAwLjAwMjY3MjI5QyAzLjYwMzg5IC0wLjAzMDcxMTUgNC4zNjU3MyAwLjI0OTc4OSA0Ljk0MTQyIDAuNzgyNTUxQyA1LjUxNzExIDEuMzE1MzEgNS44NTk1NiAyLjA1Njc2IDUuODkzNTMgMi44NDRaIi8+CiAgICAgIDxwYXRoIHRyYW5zZm9ybT0idHJhbnNsYXRlKDE2MzkuOCAyMzIzLjgxKSIgZD0iTSA3LjQyNzg5IDMuNTgzMzhDIDcuNDYwMDggNC4zMjQzIDcuMjczNTUgNS4wNTgxOSA2Ljg5MTkzIDUuNjkyMTNDIDYuNTEwMzEgNi4zMjYwNyA1Ljk1MDc1IDYuODMxNTYgNS4yODQxMSA3LjE0NDZDIDQuNjE3NDcgNy40NTc2MyAzLjg3MzcxIDcuNTY0MTQgMy4xNDcwMiA3LjQ1MDYzQyAyLjQyMDMyIDcuMzM3MTIgMS43NDMzNiA3LjAwODcgMS4yMDE4NCA2LjUwNjk1QyAwLjY2MDMyOCA2LjAwNTIgMC4yNzg2MSA1LjM1MjY4IDAuMTA1MDE3IDQuNjMyMDJDIC0wLjA2ODU3NTcgMy45MTEzNSAtMC4wMjYyMzYxIDMuMTU0OTQgMC4yMjY2NzUgMi40NTg1NkMgMC40Nzk1ODcgMS43NjIxNyAwLjkzMTY5NyAxLjE1NzEzIDEuNTI1NzYgMC43MjAwMzNDIDIuMTE5ODMgMC4yODI5MzUgMi44MjkxNCAwLjAzMzQzOTUgMy41NjM4OSAwLjAwMzEzMzQ0QyA0LjU0NjY3IC0wLjAzNzQwMzMgNS41MDUyOSAwLjMxNjcwNiA2LjIyOTYxIDAuOTg3ODM1QyA2Ljk1MzkzIDEuNjU4OTYgNy4zODQ4NCAyLjU5MjM1IDcuNDI3ODkgMy41ODMzOEwgNy40Mjc4OSAzLjU4MzM4WiIvPgogICAgICA8cGF0aCB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxNjM4LjM2IDIyODYuMDYpIiBkPSJNIDIuMjc0NzEgNC4zOTYyOUMgMS44NDM2MyA0LjQxNTA4IDEuNDE2NzEgNC4zMDQ0NSAxLjA0Nzk5IDQuMDc4NDNDIDAuNjc5MjY4IDMuODUyNCAwLjM4NTMyOCAzLjUyMTE0IDAuMjAzMzcxIDMuMTI2NTZDIDAuMDIxNDEzNiAyLjczMTk4IC0wLjA0MDM3OTggMi4yOTE4MyAwLjAyNTgxMTYgMS44NjE4MUMgMC4wOTIwMDMxIDEuNDMxOCAwLjI4MzIwNCAxLjAzMTI2IDAuNTc1MjEzIDAuNzEwODgzQyAwLjg2NzIyMiAwLjM5MDUxIDEuMjQ2OTEgMC4xNjQ3MDggMS42NjYyMiAwLjA2MjA1OTJDIDIuMDg1NTMgLTAuMDQwNTg5NyAyLjUyNTYxIC0wLjAxNTQ3MTQgMi45MzA3NiAwLjEzNDIzNUMgMy4zMzU5MSAwLjI4Mzk0MSAzLjY4NzkyIDAuNTUxNTA1IDMuOTQyMjIgMC45MDMwNkMgNC4xOTY1MiAxLjI1NDYyIDQuMzQxNjkgMS42NzQzNiA0LjM1OTM1IDIuMTA5MTZDIDQuMzgyOTkgMi42OTEwNyA0LjE3Njc4IDMuMjU4NjkgMy43ODU5NyAzLjY4NzQ2QyAzLjM5NTE2IDQuMTE2MjQgMi44NTE2NiA0LjM3MTE2IDIuMjc0NzEgNC4zOTYyOUwgMi4yNzQ3MSA0LjM5NjI5WiIvPgogICAgPC9nPgogIDwvZz4+Cjwvc3ZnPgo=);
  --jp-icon-jupyterlab-wordmark: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIHZpZXdCb3g9IjAgMCAxODYwLjggNDc1Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjIiIGZpbGw9IiM0RTRFNEUiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDQ4MC4xMzY0MDEsIDY0LjI3MTQ5MykiPgogICAgPGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMC4wMDAwMDAsIDU4Ljg3NTU2NikiPgogICAgICA8ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgwLjA4NzYwMywgMC4xNDAyOTQpIj4KICAgICAgICA8cGF0aCBkPSJNLTQyNi45LDE2OS44YzAsNDguNy0zLjcsNjQuNy0xMy42LDc2LjRjLTEwLjgsMTAtMjUsMTUuNS0zOS43LDE1LjVsMy43LDI5IGMyMi44LDAuMyw0NC44LTcuOSw2MS45LTIzLjFjMTcuOC0xOC41LDI0LTQ0LjEsMjQtODMuM1YwSC00Mjd2MTcwLjFMLTQyNi45LDE2OS44TC00MjYuOSwxNjkuOHoiLz4KICAgICAgPC9nPgogICAgPC9nPgogICAgPGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTU1LjA0NTI5NiwgNTYuODM3MTA0KSI+CiAgICAgIDxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDEuNTYyNDUzLCAxLjc5OTg0MikiPgogICAgICAgIDxwYXRoIGQ9Ik0tMzEyLDE0OGMwLDIxLDAsMzkuNSwxLjcsNTUuNGgtMzEuOGwtMi4xLTMzLjNoLTAuOGMtNi43LDExLjYtMTYuNCwyMS4zLTI4LDI3LjkgYy0xMS42LDYuNi0yNC44LDEwLTM4LjIsOS44Yy0zMS40LDAtNjktMTcuNy02OS04OVYwaDM2LjR2MTEyLjdjMCwzOC43LDExLjYsNjQuNyw0NC42LDY0LjdjMTAuMy0wLjIsMjAuNC0zLjUsMjguOS05LjQgYzguNS01LjksMTUuMS0xNC4zLDE4LjktMjMuOWMyLjItNi4xLDMuMy0xMi41LDMuMy0xOC45VjAuMmgzNi40VjE0OEgtMzEyTC0zMTIsMTQ4eiIvPgogICAgICA8L2c+CiAgICA8L2c+CiAgICA8ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgzOTAuMDEzMzIyLCA1My40Nzk2MzgpIj4KICAgICAgPGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMS43MDY0NTgsIDAuMjMxNDI1KSI+CiAgICAgICAgPHBhdGggZD0iTS00NzguNiw3MS40YzAtMjYtMC44LTQ3LTEuNy02Ni43aDMyLjdsMS43LDM0LjhoMC44YzcuMS0xMi41LDE3LjUtMjIuOCwzMC4xLTI5LjcgYzEyLjUtNywyNi43LTEwLjMsNDEtOS44YzQ4LjMsMCw4NC43LDQxLjcsODQuNywxMDMuM2MwLDczLjEtNDMuNywxMDkuMi05MSwxMDkuMmMtMTIuMSwwLjUtMjQuMi0yLjItMzUtNy44IGMtMTAuOC01LjYtMTkuOS0xMy45LTI2LjYtMjQuMmgtMC44VjI5MWgtMzZ2LTIyMEwtNDc4LjYsNzEuNEwtNDc4LjYsNzEuNHogTS00NDIuNiwxMjUuNmMwLjEsNS4xLDAuNiwxMC4xLDEuNywxNS4xIGMzLDEyLjMsOS45LDIzLjMsMTkuOCwzMS4xYzkuOSw3LjgsMjIuMSwxMi4xLDM0LjcsMTIuMWMzOC41LDAsNjAuNy0zMS45LDYwLjctNzguNWMwLTQwLjctMjEuMS03NS42LTU5LjUtNzUuNiBjLTEyLjksMC40LTI1LjMsNS4xLTM1LjMsMTMuNGMtOS45LDguMy0xNi45LDE5LjctMTkuNiwzMi40Yy0xLjUsNC45LTIuMywxMC0yLjUsMTUuMVYxMjUuNkwtNDQyLjYsMTI1LjZMLTQ0Mi42LDEyNS42eiIvPgogICAgICA8L2c+CiAgICA8L2c+CiAgICA8ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSg2MDYuNzQwNzI2LCA1Ni44MzcxMDQpIj4KICAgICAgPGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMC43NTEyMjYsIDEuOTg5Mjk5KSI+CiAgICAgICAgPHBhdGggZD0iTS00NDAuOCwwbDQzLjcsMTIwLjFjNC41LDEzLjQsOS41LDI5LjQsMTIuOCw0MS43aDAuOGMzLjctMTIuMiw3LjktMjcuNywxMi44LTQyLjQgbDM5LjctMTE5LjJoMzguNUwtMzQ2LjksMTQ1Yy0yNiw2OS43LTQzLjcsMTA1LjQtNjguNiwxMjcuMmMtMTIuNSwxMS43LTI3LjksMjAtNDQuNiwyMy45bC05LjEtMzEuMSBjMTEuNy0zLjksMjIuNS0xMC4xLDMxLjgtMTguMWMxMy4yLTExLjEsMjMuNy0yNS4yLDMwLjYtNDEuMmMxLjUtMi44LDIuNS01LjcsMi45LTguOGMtMC4zLTMuMy0xLjItNi42LTIuNS05LjdMLTQ4MC4yLDAuMSBoMzkuN0wtNDQwLjgsMEwtNDQwLjgsMHoiLz4KICAgICAgPC9nPgogICAgPC9nPgogICAgPGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoODIyLjc0ODEwNCwgMC4wMDAwMDApIj4KICAgICAgPGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMS40NjQwNTAsIDAuMzc4OTE0KSI+CiAgICAgICAgPHBhdGggZD0iTS00MTMuNywwdjU4LjNoNTJ2MjguMmgtNTJWMTk2YzAsMjUsNywzOS41LDI3LjMsMzkuNWM3LjEsMC4xLDE0LjItMC43LDIxLjEtMi41IGwxLjcsMjcuN2MtMTAuMywzLjctMjEuMyw1LjQtMzIuMiw1Yy03LjMsMC40LTE0LjYtMC43LTIxLjMtMy40Yy02LjgtMi43LTEyLjktNi44LTE3LjktMTIuMWMtMTAuMy0xMC45LTE0LjEtMjktMTQuMS01Mi45IFY4Ni41aC0zMVY1OC4zaDMxVjkuNkwtNDEzLjcsMEwtNDEzLjcsMHoiLz4KICAgICAgPC9nPgogICAgPC9nPgogICAgPGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoOTc0LjQzMzI4NiwgNTMuNDc5NjM4KSI+CiAgICAgIDxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDAuOTkwMDM0LCAwLjYxMDMzOSkiPgogICAgICAgIDxwYXRoIGQ9Ik0tNDQ1LjgsMTEzYzAuOCw1MCwzMi4yLDcwLjYsNjguNiw3MC42YzE5LDAuNiwzNy45LTMsNTUuMy0xMC41bDYuMiwyNi40IGMtMjAuOSw4LjktNDMuNSwxMy4xLTY2LjIsMTIuNmMtNjEuNSwwLTk4LjMtNDEuMi05OC4zLTEwMi41Qy00ODAuMiw0OC4yLTQ0NC43LDAtMzg2LjUsMGM2NS4yLDAsODIuNyw1OC4zLDgyLjcsOTUuNyBjLTAuMSw1LjgtMC41LDExLjUtMS4yLDE3LjJoLTE0MC42SC00NDUuOEwtNDQ1LjgsMTEzeiBNLTMzOS4yLDg2LjZjMC40LTIzLjUtOS41LTYwLjEtNTAuNC02MC4xIGMtMzYuOCwwLTUyLjgsMzQuNC01NS43LDYwLjFILTMzOS4yTC0zMzkuMiw4Ni42TC0zMzkuMiw4Ni42eiIvPgogICAgICA8L2c+CiAgICA8L2c+CiAgICA8ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxMjAxLjk2MTA1OCwgNTMuNDc5NjM4KSI+CiAgICAgIDxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDEuMTc5NjQwLCAwLjcwNTA2OCkiPgogICAgICAgIDxwYXRoIGQ9Ik0tNDc4LjYsNjhjMC0yMy45LTAuNC00NC41LTEuNy02My40aDMxLjhsMS4yLDM5LjloMS43YzkuMS0yNy4zLDMxLTQ0LjUsNTUuMy00NC41IGMzLjUtMC4xLDcsMC40LDEwLjMsMS4ydjM0LjhjLTQuMS0wLjktOC4yLTEuMy0xMi40LTEuMmMtMjUuNiwwLTQzLjcsMTkuNy00OC43LDQ3LjRjLTEsNS43LTEuNiwxMS41LTEuNywxNy4ydjEwOC4zaC0zNlY2OCBMLTQ3OC42LDY4eiIvPgogICAgICA8L2c+CiAgICA8L2c+CiAgPC9nPgoKICA8ZyBjbGFzcz0ianAtaWNvbi13YXJuMCIgZmlsbD0iI0YzNzcyNiI+CiAgICA8cGF0aCBkPSJNMTM1Mi4zLDMyNi4yaDM3VjI4aC0zN1YzMjYuMnogTTE2MDQuOCwzMjYuMmMtMi41LTEzLjktMy40LTMxLjEtMy40LTQ4Ljd2LTc2IGMwLTQwLjctMTUuMS04My4xLTc3LjMtODMuMWMtMjUuNiwwLTUwLDcuMS02Ni44LDE4LjFsOC40LDI0LjRjMTQuMy05LjIsMzQtMTUuMSw1My0xNS4xYzQxLjYsMCw0Ni4yLDMwLjIsNDYuMiw0N3Y0LjIgYy03OC42LTAuNC0xMjIuMywyNi41LTEyMi4zLDc1LjZjMCwyOS40LDIxLDU4LjQsNjIuMiw1OC40YzI5LDAsNTAuOS0xNC4zLDYyLjItMzAuMmgxLjNsMi45LDI1LjZIMTYwNC44eiBNMTU2NS43LDI1Ny43IGMwLDMuOC0wLjgsOC0yLjEsMTEuOGMtNS45LDE3LjItMjIuNywzNC00OS4yLDM0Yy0xOC45LDAtMzQuOS0xMS4zLTM0LjktMzUuM2MwLTM5LjUsNDUuOC00Ni42LDg2LjItNDUuOFYyNTcuN3ogTTE2OTguNSwzMjYuMiBsMS43LTMzLjZoMS4zYzE1LjEsMjYuOSwzOC43LDM4LjIsNjguMSwzOC4yYzQ1LjQsMCw5MS4yLTM2LjEsOTEuMi0xMDguOGMwLjQtNjEuNy0zNS4zLTEwMy43LTg1LjctMTAzLjcgYy0zMi44LDAtNTYuMywxNC43LTY5LjMsMzcuNGgtMC44VjI4aC0zNi42djI0NS43YzAsMTguMS0wLjgsMzguNi0xLjcsNTIuNUgxNjk4LjV6IE0xNzA0LjgsMjA4LjJjMC01LjksMS4zLTEwLjksMi4xLTE1LjEgYzcuNi0yOC4xLDMxLjEtNDUuNCw1Ni4zLTQ1LjRjMzkuNSwwLDYwLjUsMzQuOSw2MC41LDc1LjZjMCw0Ni42LTIzLjEsNzguMS02MS44LDc4LjFjLTI2LjksMC00OC4zLTE3LjYtNTUuNS00My4zIGMtMC44LTQuMi0xLjctOC44LTEuNy0xMy40VjIwOC4yeiIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-kernel: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICAgIDxwYXRoIGNsYXNzPSJqcC1pY29uMiIgZmlsbD0iIzYxNjE2MSIgZD0iTTE1IDlIOXY2aDZWOXptLTIgNGgtMnYtMmgydjJ6bTgtMlY5aC0yVjdjMC0xLjEtLjktMi0yLTJoLTJWM2gtMnYyaC0yVjNIOXYySDdjLTEuMSAwLTIgLjktMiAydjJIM3YyaDJ2MkgzdjJoMnYyYzAgMS4xLjkgMiAyIDJoMnYyaDJ2LTJoMnYyaDJ2LTJoMmMxLjEgMCAyLS45IDItMnYtMmgydi0yaC0ydi0yaDJ6bS00IDZIN1Y3aDEwdjEweiIvPgo8L3N2Zz4K);
  --jp-icon-keyboard: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8cGF0aCBjbGFzcz0ianAtaWNvbjMganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjNjE2MTYxIiBkPSJNMjAgNUg0Yy0xLjEgMC0xLjk5LjktMS45OSAyTDIgMTdjMCAxLjEuOSAyIDIgMmgxNmMxLjEgMCAyLS45IDItMlY3YzAtMS4xLS45LTItMi0yem0tOSAzaDJ2MmgtMlY4em0wIDNoMnYyaC0ydi0yek04IDhoMnYySDhWOHptMCAzaDJ2Mkg4di0yem0tMSAySDV2LTJoMnYyem0wLTNINVY4aDJ2MnptOSA3SDh2LTJoOHYyem0wLTRoLTJ2LTJoMnYyem0wLTNoLTJWOGgydjJ6bTMgM2gtMnYtMmgydjJ6bTAtM2gtMlY4aDJ2MnoiLz4KPC9zdmc+Cg==);
  --jp-icon-launch: url(data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMzIgMzIiIHdpZHRoPSIzMiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyBjbGFzcz0ianAtaWNvbjMganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjNjE2MTYxIj4KICAgIDxwYXRoIGQ9Ik0yNiwyOEg2YTIuMDAyNywyLjAwMjcsMCwwLDEtMi0yVjZBMi4wMDI3LDIuMDAyNywwLDAsMSw2LDRIMTZWNkg2VjI2SDI2VjE2aDJWMjZBMi4wMDI3LDIuMDAyNywwLDAsMSwyNiwyOFoiLz4KICAgIDxwb2x5Z29uIHBvaW50cz0iMjAgMiAyMCA0IDI2LjU4NiA0IDE4IDEyLjU4NiAxOS40MTQgMTQgMjggNS40MTQgMjggMTIgMzAgMTIgMzAgMiAyMCAyIi8+CiAgPC9nPgo8L3N2Zz4K);
  --jp-icon-launcher: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8cGF0aCBjbGFzcz0ianAtaWNvbjMganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjNjE2MTYxIiBkPSJNMTkgMTlINVY1aDdWM0g1YTIgMiAwIDAwLTIgMnYxNGEyIDIgMCAwMDIgMmgxNGMxLjEgMCAyLS45IDItMnYtN2gtMnY3ek0xNCAzdjJoMy41OWwtOS44MyA5LjgzIDEuNDEgMS40MUwxOSA2LjQxVjEwaDJWM2gtN3oiLz4KPC9zdmc+Cg==);
  --jp-icon-line-form: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICAgIDxwYXRoIGZpbGw9IndoaXRlIiBkPSJNNS44OCA0LjEyTDEzLjc2IDEybC03Ljg4IDcuODhMOCAyMmwxMC0xMEw4IDJ6Ii8+Cjwvc3ZnPgo=);
  --jp-icon-link: url(data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIxNiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTMuOSAxMmMwLTEuNzEgMS4zOS0zLjEgMy4xLTMuMWg0VjdIN2MtMi43NiAwLTUgMi4yNC01IDVzMi4yNCA1IDUgNWg0di0xLjlIN2MtMS43MSAwLTMuMS0xLjM5LTMuMS0zLjF6TTggMTNoOHYtMkg4djJ6bTktNmgtNHYxLjloNGMxLjcxIDAgMy4xIDEuMzkgMy4xIDMuMXMtMS4zOSAzLjEtMy4xIDMuMWgtNFYxN2g0YzIuNzYgMCA1LTIuMjQgNS01cy0yLjI0LTUtNS01eiIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-list: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICAgIDxwYXRoIGNsYXNzPSJqcC1pY29uMiBqcC1pY29uLXNlbGVjdGFibGUiIGZpbGw9IiM2MTYxNjEiIGQ9Ik0xOSA1djE0SDVWNWgxNG0xLjEtMkgzLjljLS41IDAtLjkuNC0uOS45djE2LjJjMCAuNC40LjkuOS45aDE2LjJjLjQgMCAuOS0uNS45LS45VjMuOWMwLS41LS41LS45LS45LS45ek0xMSA3aDZ2MmgtNlY3em0wIDRoNnYyaC02di0yem0wIDRoNnYyaC02ek03IDdoMnYySDd6bTAgNGgydjJIN3ptMCA0aDJ2Mkg3eiIvPgo8L3N2Zz4K);
  --jp-icon-markdown: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDIyIDIyIj4KICA8cGF0aCBjbGFzcz0ianAtaWNvbi1jb250cmFzdDAganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjN0IxRkEyIiBkPSJNNSAxNC45aDEybC02LjEgNnptOS40LTYuOGMwLTEuMy0uMS0yLjktLjEtNC41LS40IDEuNC0uOSAyLjktMS4zIDQuM2wtMS4zIDQuM2gtMkw4LjUgNy45Yy0uNC0xLjMtLjctMi45LTEtNC4zLS4xIDEuNi0uMSAzLjItLjIgNC42TDcgMTIuNEg0LjhsLjctMTFoMy4zTDEwIDVjLjQgMS4yLjcgMi43IDEgMy45LjMtMS4yLjctMi42IDEtMy45bDEuMi0zLjdoMy4zbC42IDExaC0yLjRsLS4zLTQuMnoiLz4KPC9zdmc+Cg==);
  --jp-icon-move-down: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTQiIGhlaWdodD0iMTQiIHZpZXdCb3g9IjAgMCAxNCAxNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggY2xhc3M9ImpwLWljb24zIiBkPSJNMTIuNDcxIDcuNTI4OTlDMTIuNzYzMiA3LjIzNjg0IDEyLjc2MzIgNi43NjMxNiAxMi40NzEgNi40NzEwMVY2LjQ3MTAxQzEyLjE3OSA2LjE3OTA1IDExLjcwNTcgNi4xNzg4NCAxMS40MTM1IDYuNDcwNTRMNy43NSAxMC4xMjc1VjEuNzVDNy43NSAxLjMzNTc5IDcuNDE0MjEgMSA3IDFWMUM2LjU4NTc5IDEgNi4yNSAxLjMzNTc5IDYuMjUgMS43NVYxMC4xMjc1TDIuNTk3MjYgNi40NjgyMkMyLjMwMzM4IDYuMTczODEgMS44MjY0MSA2LjE3MzU5IDEuNTMyMjYgNi40Njc3NFY2LjQ2Nzc0QzEuMjM4MyA2Ljc2MTcgMS4yMzgzIDcuMjM4MyAxLjUzMjI2IDcuNTMyMjZMNi4yOTI4OSAxMi4yOTI5QzYuNjgzNDIgMTIuNjgzNCA3LjMxNjU4IDEyLjY4MzQgNy43MDcxMSAxMi4yOTI5TDEyLjQ3MSA3LjUyODk5WiIgZmlsbD0iIzYxNjE2MSIvPgo8L3N2Zz4K);
  --jp-icon-move-up: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTQiIGhlaWdodD0iMTQiIHZpZXdCb3g9IjAgMCAxNCAxNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggY2xhc3M9ImpwLWljb24zIiBkPSJNMS41Mjg5OSA2LjQ3MTAxQzEuMjM2ODQgNi43NjMxNiAxLjIzNjg0IDcuMjM2ODQgMS41Mjg5OSA3LjUyODk5VjcuNTI4OTlDMS44MjA5NSA3LjgyMDk1IDIuMjk0MjYgNy44MjExNiAyLjU4NjQ5IDcuNTI5NDZMNi4yNSAzLjg3MjVWMTIuMjVDNi4yNSAxMi42NjQyIDYuNTg1NzkgMTMgNyAxM1YxM0M3LjQxNDIxIDEzIDcuNzUgMTIuNjY0MiA3Ljc1IDEyLjI1VjMuODcyNUwxMS40MDI3IDcuNTMxNzhDMTEuNjk2NiA3LjgyNjE5IDEyLjE3MzYgNy44MjY0MSAxMi40Njc3IDcuNTMyMjZWNy41MzIyNkMxMi43NjE3IDcuMjM4MyAxMi43NjE3IDYuNzYxNyAxMi40Njc3IDYuNDY3NzRMNy43MDcxMSAxLjcwNzExQzcuMzE2NTggMS4zMTY1OCA2LjY4MzQyIDEuMzE2NTggNi4yOTI4OSAxLjcwNzExTDEuNTI4OTkgNi40NzEwMVoiIGZpbGw9IiM2MTYxNjEiLz4KPC9zdmc+Cg==);
  --jp-icon-new-folder: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTIwIDZoLThsLTItMkg0Yy0xLjExIDAtMS45OS44OS0xLjk5IDJMMiAxOGMwIDEuMTEuODkgMiAyIDJoMTZjMS4xMSAwIDItLjg5IDItMlY4YzAtMS4xMS0uODktMi0yLTJ6bS0xIDhoLTN2M2gtMnYtM2gtM3YtMmgzVjloMnYzaDN2MnoiLz4KICA8L2c+Cjwvc3ZnPgo=);
  --jp-icon-not-trusted: url(data:image/svg+xml;base64,PHN2ZyBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI1IDI1Ij4KICAgIDxwYXRoIGNsYXNzPSJqcC1pY29uMiIgc3Ryb2tlPSIjMzMzMzMzIiBzdHJva2Utd2lkdGg9IjIiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDMgMykiIGQ9Ik0xLjg2MDk0IDExLjQ0MDlDMC44MjY0NDggOC43NzAyNyAwLjg2Mzc3OSA2LjA1NzY0IDEuMjQ5MDcgNC4xOTkzMkMyLjQ4MjA2IDMuOTMzNDcgNC4wODA2OCAzLjQwMzQ3IDUuNjAxMDIgMi44NDQ5QzcuMjM1NDkgMi4yNDQ0IDguODU2NjYgMS41ODE1IDkuOTg3NiAxLjA5NTM5QzExLjA1OTcgMS41ODM0MSAxMi42MDk0IDIuMjQ0NCAxNC4yMTggMi44NDMzOUMxNS43NTAzIDMuNDEzOTQgMTcuMzk5NSAzLjk1MjU4IDE4Ljc1MzkgNC4yMTM4NUMxOS4xMzY0IDYuMDcxNzcgMTkuMTcwOSA4Ljc3NzIyIDE4LjEzOSAxMS40NDA5QzE3LjAzMDMgMTQuMzAzMiAxNC42NjY4IDE3LjE4NDQgOS45OTk5OSAxOC45MzU0QzUuMzMzMTkgMTcuMTg0NCAyLjk2OTY4IDE0LjMwMzIgMS44NjA5NCAxMS40NDA5WiIvPgogICAgPHBhdGggY2xhc3M9ImpwLWljb24yIiBzdHJva2U9IiMzMzMzMzMiIHN0cm9rZS13aWR0aD0iMiIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoOS4zMTU5MiA5LjMyMDMxKSIgZD0iTTcuMzY4NDIgMEwwIDcuMzY0NzkiLz4KICAgIDxwYXRoIGNsYXNzPSJqcC1pY29uMiIgc3Ryb2tlPSIjMzMzMzMzIiBzdHJva2Utd2lkdGg9IjIiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDkuMzE1OTIgMTYuNjgzNikgc2NhbGUoMSAtMSkiIGQ9Ik03LjM2ODQyIDBMMCA3LjM2NDc5Ii8+Cjwvc3ZnPgo=);
  --jp-icon-notebook: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDIyIDIyIj4KICA8ZyBjbGFzcz0ianAtbm90ZWJvb2staWNvbi1jb2xvciBqcC1pY29uLXNlbGVjdGFibGUiIGZpbGw9IiNFRjZDMDAiPgogICAgPHBhdGggZD0iTTE4LjcgMy4zdjE1LjRIMy4zVjMuM2gxNS40bTEuNS0xLjVIMS44djE4LjNoMTguM2wuMS0xOC4zeiIvPgogICAgPHBhdGggZD0iTTE2LjUgMTYuNWwtNS40LTQuMy01LjYgNC4zdi0xMWgxMXoiLz4KICA8L2c+Cjwvc3ZnPgo=);
  --jp-icon-numbering: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjIiIGhlaWdodD0iMjIiIHZpZXdCb3g9IjAgMCAyOCAyOCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KCTxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSI+CgkJPHBhdGggZD0iTTQgMTlINlYxOS41SDVWMjAuNUg2VjIxSDRWMjJIN1YxOEg0VjE5Wk01IDEwSDZWNkg0VjdINVYxMFpNNCAxM0g1LjhMNCAxNS4xVjE2SDdWMTVINS4yTDcgMTIuOVYxMkg0VjEzWk05IDdWOUgyM1Y3SDlaTTkgMjFIMjNWMTlIOVYyMVpNOSAxNUgyM1YxM0g5VjE1WiIvPgoJPC9nPgo8L3N2Zz4K);
  --jp-icon-offline-bolt: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjE2Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTEyIDIuMDJjLTUuNTEgMC05Ljk4IDQuNDctOS45OCA5Ljk4czQuNDcgOS45OCA5Ljk4IDkuOTggOS45OC00LjQ3IDkuOTgtOS45OFMxNy41MSAyLjAyIDEyIDIuMDJ6TTExLjQ4IDIwdi02LjI2SDhMMTMgNHY2LjI2aDMuMzVMMTEuNDggMjB6Ii8+CiAgPC9nPgo8L3N2Zz4K);
  --jp-icon-palette: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTE4IDEzVjIwSDRWNkg5LjAyQzkuMDcgNS4yOSA5LjI0IDQuNjIgOS41IDRINEMyLjkgNCAyIDQuOSAyIDZWMjBDMiAyMS4xIDIuOSAyMiA0IDIySDE4QzE5LjEgMjIgMjAgMjEuMSAyMCAyMFYxNUwxOCAxM1pNMTkuMyA4Ljg5QzE5Ljc0IDguMTkgMjAgNy4zOCAyMCA2LjVDMjAgNC4wMSAxNy45OSAyIDE1LjUgMkMxMy4wMSAyIDExIDQuMDEgMTEgNi41QzExIDguOTkgMTMuMDEgMTEgMTUuNDkgMTFDMTYuMzcgMTEgMTcuMTkgMTAuNzQgMTcuODggMTAuM0wyMSAxMy40MkwyMi40MiAxMkwxOS4zIDguODlaTTE1LjUgOUMxNC4xMiA5IDEzIDcuODggMTMgNi41QzEzIDUuMTIgMTQuMTIgNCAxNS41IDRDMTYuODggNCAxOCA1LjEyIDE4IDYuNUMxOCA3Ljg4IDE2Ljg4IDkgMTUuNSA5WiIvPgogICAgPHBhdGggZmlsbC1ydWxlPSJldmVub2RkIiBjbGlwLXJ1bGU9ImV2ZW5vZGQiIGQ9Ik00IDZIOS4wMTg5NEM5LjAwNjM5IDYuMTY1MDIgOSA2LjMzMTc2IDkgNi41QzkgOC44MTU3NyAxMC4yMTEgMTAuODQ4NyAxMi4wMzQzIDEySDlWMTRIMTZWMTIuOTgxMUMxNi41NzAzIDEyLjkzNzcgMTcuMTIgMTIuODIwNyAxNy42Mzk2IDEyLjYzOTZMMTggMTNWMjBINFY2Wk04IDhINlYxMEg4VjhaTTYgMTJIOFYxNEg2VjEyWk04IDE2SDZWMThIOFYxNlpNOSAxNkgxNlYxOEg5VjE2WiIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-paste: url(data:image/svg+xml;base64,PHN2ZyBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICAgIDxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSI+CiAgICAgICAgPHBhdGggZD0iTTE5IDJoLTQuMThDMTQuNC44NCAxMy4zIDAgMTIgMGMtMS4zIDAtMi40Ljg0LTIuODIgMkg1Yy0xLjEgMC0yIC45LTIgMnYxNmMwIDEuMS45IDIgMiAyaDE0YzEuMSAwIDItLjkgMi0yVjRjMC0xLjEtLjktMi0yLTJ6bS03IDBjLjU1IDAgMSAuNDUgMSAxcy0uNDUgMS0xIDEtMS0uNDUtMS0xIC40NS0xIDEtMXptNyAxOEg1VjRoMnYzaDEwVjRoMnYxNnoiLz4KICAgIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-pdf: url(data:image/svg+xml;base64,PHN2ZwogICB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMiAyMiIgd2lkdGg9IjE2Ij4KICAgIDxwYXRoIHRyYW5zZm9ybT0icm90YXRlKDQ1KSIgY2xhc3M9ImpwLWljb24tc2VsZWN0YWJsZSIgZmlsbD0iI0ZGMkEyQSIKICAgICAgIGQ9Im0gMjIuMzQ0MzY5LC0zLjAxNjM2NDIgaCA1LjYzODYwNCB2IDEuNTc5MjQzMyBoIC0zLjU0OTIyNyB2IDEuNTA4NjkyOTkgaCAzLjMzNzU3NiBWIDEuNjUwODE1NCBoIC0zLjMzNzU3NiB2IDMuNDM1MjYxMyBoIC0yLjA4OTM3NyB6IG0gLTcuMTM2NDQ0LDEuNTc5MjQzMyB2IDQuOTQzOTU0MyBoIDAuNzQ4OTIgcSAxLjI4MDc2MSwwIDEuOTUzNzAzLC0wLjYzNDk1MzUgMC42NzgzNjksLTAuNjM0OTUzNSAwLjY3ODM2OSwtMS44NDUxNjQxIDAsLTEuMjA0NzgzNTUgLTAuNjcyOTQyLC0xLjgzNDMxMDExIC0wLjY3Mjk0MiwtMC42Mjk1MjY1OSAtMS45NTkxMywtMC42Mjk1MjY1OSB6IG0gLTIuMDg5Mzc3LC0xLjU3OTI0MzMgaCAyLjIwMzM0MyBxIDEuODQ1MTY0LDAgMi43NDYwMzksMC4yNjU5MjA3IDAuOTA2MzAxLDAuMjYwNDkzNyAxLjU1MjEwOCwwLjg5MDAyMDMgMC41Njk4MywwLjU0ODEyMjMgMC44NDY2MDUsMS4yNjQ0ODAwNiAwLjI3Njc3NCwwLjcxNjM1NzgxIDAuMjc2Nzc0LDEuNjIyNjU4OTQgMCwwLjkxNzE1NTEgLTAuMjc2Nzc0LDEuNjM4OTM5OSAtMC4yNzY3NzUsMC43MTYzNTc4IC0wLjg0NjYwNSwxLjI2NDQ4IC0wLjY1MTIzNCwwLjYyOTUyNjYgLTEuNTYyOTYyLDAuODk1NDQ3MyAtMC45MTE3MjgsMC4yNjA0OTM3IC0yLjczNTE4NSwwLjI2MDQ5MzcgaCAtMi4yMDMzNDMgeiBtIC04LjE0NTg1NjUsMCBoIDMuNDY3ODIzIHEgMS41NDY2ODE2LDAgMi4zNzE1Nzg1LDAuNjg5MjIzIDAuODMwMzI0LDAuNjgzNzk2MSAwLjgzMDMyNCwxLjk1MzcwMzE0IDAsMS4yNzUzMzM5NyAtMC44MzAzMjQsMS45NjQ1NTcwNiBRIDkuOTg3MTk2MSwyLjI3NDkxNSA4LjQ0MDUxNDUsMi4yNzQ5MTUgSCA3LjA2MjA2ODQgViA1LjA4NjA3NjcgSCA0Ljk3MjY5MTUgWiBtIDIuMDg5Mzc2OSwxLjUxNDExOTkgdiAyLjI2MzAzOTQzIGggMS4xNTU5NDEgcSAwLjYwNzgxODgsMCAwLjkzODg2MjksLTAuMjkzMDU1NDcgMC4zMzEwNDQxLC0wLjI5ODQ4MjQxIDAuMzMxMDQ0MSwtMC44NDExNzc3MiAwLC0wLjU0MjY5NTMxIC0wLjMzMTA0NDEsLTAuODM1NzUwNzQgLTAuMzMxMDQ0MSwtMC4yOTMwNTU1IC0wLjkzODg2MjksLTAuMjkzMDU1NSB6IgovPgo8L3N2Zz4K);
  --jp-icon-python: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iLTEwIC0xMCAxMzEuMTYxMzYxNjk0MzM1OTQgMTMyLjM4ODk5OTkzODk2NDg0Ij4KICA8cGF0aCBjbGFzcz0ianAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjMzA2OTk4IiBkPSJNIDU0LjkxODc4NSw5LjE5Mjc0MjFlLTQgQyA1MC4zMzUxMzIsMC4wMjIyMTcyNyA0NS45NTc4NDYsMC40MTMxMzY5NyA0Mi4xMDYyODUsMS4wOTQ2NjkzIDMwLjc2MDA2OSwzLjA5OTE3MzEgMjguNzAwMDM2LDcuMjk0NzcxNCAyOC43MDAwMzUsMTUuMDMyMTY5IHYgMTAuMjE4NzUgaCAyNi44MTI1IHYgMy40MDYyNSBoIC0yNi44MTI1IC0xMC4wNjI1IGMgLTcuNzkyNDU5LDAgLTE0LjYxNTc1ODgsNC42ODM3MTcgLTE2Ljc0OTk5OTgsMTMuNTkzNzUgLTIuNDYxODE5OTgsMTAuMjEyOTY2IC0yLjU3MTAxNTA4LDE2LjU4NjAyMyAwLDI3LjI1IDEuOTA1OTI4Myw3LjkzNzg1MiA2LjQ1NzU0MzIsMTMuNTkzNzQ4IDE0LjI0OTk5OTgsMTMuNTkzNzUgaCA5LjIxODc1IHYgLTEyLjI1IGMgMCwtOC44NDk5MDIgNy42NTcxNDQsLTE2LjY1NjI0OCAxNi43NSwtMTYuNjU2MjUgaCAyNi43ODEyNSBjIDcuNDU0OTUxLDAgMTMuNDA2MjUzLC02LjEzODE2NCAxMy40MDYyNSwtMTMuNjI1IHYgLTI1LjUzMTI1IGMgMCwtNy4yNjYzMzg2IC02LjEyOTk4LC0xMi43MjQ3NzcxIC0xMy40MDYyNSwtMTMuOTM3NDk5NyBDIDY0LjI4MTU0OCwwLjMyNzk0Mzk3IDU5LjUwMjQzOCwtMC4wMjAzNzkwMyA1NC45MTg3ODUsOS4xOTI3NDIxZS00IFogbSAtMTQuNSw4LjIxODc1MDEyNTc5IGMgMi43Njk1NDcsMCA1LjAzMTI1LDIuMjk4NjQ1NiA1LjAzMTI1LDUuMTI0OTk5NiAtMmUtNiwyLjgxNjMzNiAtMi4yNjE3MDMsNS4wOTM3NSAtNS4wMzEyNSw1LjA5Mzc1IC0yLjc3OTQ3NiwtMWUtNiAtNS4wMzEyNSwtMi4yNzc0MTUgLTUuMDMxMjUsLTUuMDkzNzUgLTEwZS03LC0yLjgyNjM1MyAyLjI1MTc3NCwtNS4xMjQ5OTk2IDUuMDMxMjUsLTUuMTI0OTk5NiB6Ii8+CiAgPHBhdGggY2xhc3M9ImpwLWljb24tc2VsZWN0YWJsZSIgZmlsbD0iI2ZmZDQzYiIgZD0ibSA4NS42Mzc1MzUsMjguNjU3MTY5IHYgMTEuOTA2MjUgYyAwLDkuMjMwNzU1IC03LjgyNTg5NSwxNi45OTk5OTkgLTE2Ljc1LDE3IGggLTI2Ljc4MTI1IGMgLTcuMzM1ODMzLDAgLTEzLjQwNjI0OSw2LjI3ODQ4MyAtMTMuNDA2MjUsMTMuNjI1IHYgMjUuNTMxMjQ3IGMgMCw3LjI2NjM0NCA2LjMxODU4OCwxMS41NDAzMjQgMTMuNDA2MjUsMTMuNjI1MDA0IDguNDg3MzMxLDIuNDk1NjEgMTYuNjI2MjM3LDIuOTQ2NjMgMjYuNzgxMjUsMCA2Ljc1MDE1NSwtMS45NTQzOSAxMy40MDYyNTMsLTUuODg3NjEgMTMuNDA2MjUsLTEzLjYyNTAwNCBWIDg2LjUwMDkxOSBoIC0yNi43ODEyNSB2IC0zLjQwNjI1IGggMjYuNzgxMjUgMTMuNDA2MjU0IGMgNy43OTI0NjEsMCAxMC42OTYyNTEsLTUuNDM1NDA4IDEzLjQwNjI0MSwtMTMuNTkzNzUgMi43OTkzMywtOC4zOTg4ODYgMi42ODAyMiwtMTYuNDc1Nzc2IDAsLTI3LjI1IC0xLjkyNTc4LC03Ljc1NzQ0MSAtNS42MDM4NywtMTMuNTkzNzUgLTEzLjQwNjI0MSwtMTMuNTkzNzUgeiBtIC0xNS4wNjI1LDY0LjY1NjI1IGMgMi43Nzk0NzgsM2UtNiA1LjAzMTI1LDIuMjc3NDE3IDUuMDMxMjUsNS4wOTM3NDcgLTJlLTYsMi44MjYzNTQgLTIuMjUxNzc1LDUuMTI1MDA0IC01LjAzMTI1LDUuMTI1MDA0IC0yLjc2OTU1LDAgLTUuMDMxMjUsLTIuMjk4NjUgLTUuMDMxMjUsLTUuMTI1MDA0IDJlLTYsLTIuODE2MzMgMi4yNjE2OTcsLTUuMDkzNzQ3IDUuMDMxMjUsLTUuMDkzNzQ3IHoiLz4KPC9zdmc+Cg==);
  --jp-icon-r-kernel: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDIyIDIyIj4KICA8cGF0aCBjbGFzcz0ianAtaWNvbi1jb250cmFzdDMganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjMjE5NkYzIiBkPSJNNC40IDIuNWMxLjItLjEgMi45LS4zIDQuOS0uMyAyLjUgMCA0LjEuNCA1LjIgMS4zIDEgLjcgMS41IDEuOSAxLjUgMy41IDAgMi0xLjQgMy41LTIuOSA0LjEgMS4yLjQgMS43IDEuNiAyLjIgMyAuNiAxLjkgMSAzLjkgMS4zIDQuNmgtMy44Yy0uMy0uNC0uOC0xLjctMS4yLTMuN3MtMS4yLTIuNi0yLjYtMi42aC0uOXY2LjRINC40VjIuNXptMy43IDYuOWgxLjRjMS45IDAgMi45LS45IDIuOS0yLjNzLTEtMi4zLTIuOC0yLjNjLS43IDAtMS4zIDAtMS42LjJ2NC41aC4xdi0uMXoiLz4KPC9zdmc+Cg==);
  --jp-icon-react: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMTUwIDE1MCA1NDEuOSAyOTUuMyI+CiAgPGcgY2xhc3M9ImpwLWljb24tYnJhbmQyIGpwLWljb24tc2VsZWN0YWJsZSIgZmlsbD0iIzYxREFGQiI+CiAgICA8cGF0aCBkPSJNNjY2LjMgMjk2LjVjMC0zMi41LTQwLjctNjMuMy0xMDMuMS04Mi40IDE0LjQtNjMuNiA4LTExNC4yLTIwLjItMTMwLjQtNi41LTMuOC0xNC4xLTUuNi0yMi40LTUuNnYyMi4zYzQuNiAwIDguMy45IDExLjQgMi42IDEzLjYgNy44IDE5LjUgMzcuNSAxNC45IDc1LjctMS4xIDkuNC0yLjkgMTkuMy01LjEgMjkuNC0xOS42LTQuOC00MS04LjUtNjMuNS0xMC45LTEzLjUtMTguNS0yNy41LTM1LjMtNDEuNi01MCAzMi42LTMwLjMgNjMuMi00Ni45IDg0LTQ2LjlWNzhjLTI3LjUgMC02My41IDE5LjYtOTkuOSA1My42LTM2LjQtMzMuOC03Mi40LTUzLjItOTkuOS01My4ydjIyLjNjMjAuNyAwIDUxLjQgMTYuNSA4NCA0Ni42LTE0IDE0LjctMjggMzEuNC00MS4zIDQ5LjktMjIuNiAyLjQtNDQgNi4xLTYzLjYgMTEtMi4zLTEwLTQtMTkuNy01LjItMjktNC43LTM4LjIgMS4xLTY3LjkgMTQuNi03NS44IDMtMS44IDYuOS0yLjYgMTEuNS0yLjZWNzguNWMtOC40IDAtMTYgMS44LTIyLjYgNS42LTI4LjEgMTYuMi0zNC40IDY2LjctMTkuOSAxMzAuMS02Mi4yIDE5LjItMTAyLjcgNDkuOS0xMDIuNyA4Mi4zIDAgMzIuNSA0MC43IDYzLjMgMTAzLjEgODIuNC0xNC40IDYzLjYtOCAxMTQuMiAyMC4yIDEzMC40IDYuNSAzLjggMTQuMSA1LjYgMjIuNSA1LjYgMjcuNSAwIDYzLjUtMTkuNiA5OS45LTUzLjYgMzYuNCAzMy44IDcyLjQgNTMuMiA5OS45IDUzLjIgOC40IDAgMTYtMS44IDIyLjYtNS42IDI4LjEtMTYuMiAzNC40LTY2LjcgMTkuOS0xMzAuMSA2Mi0xOS4xIDEwMi41LTQ5LjkgMTAyLjUtODIuM3ptLTEzMC4yLTY2LjdjLTMuNyAxMi45LTguMyAyNi4yLTEzLjUgMzkuNS00LjEtOC04LjQtMTYtMTMuMS0yNC00LjYtOC05LjUtMTUuOC0xNC40LTIzLjQgMTQuMiAyLjEgMjcuOSA0LjcgNDEgNy45em0tNDUuOCAxMDYuNWMtNy44IDEzLjUtMTUuOCAyNi4zLTI0LjEgMzguMi0xNC45IDEuMy0zMCAyLTQ1LjIgMi0xNS4xIDAtMzAuMi0uNy00NS0xLjktOC4zLTExLjktMTYuNC0yNC42LTI0LjItMzgtNy42LTEzLjEtMTQuNS0yNi40LTIwLjgtMzkuOCA2LjItMTMuNCAxMy4yLTI2LjggMjAuNy0zOS45IDcuOC0xMy41IDE1LjgtMjYuMyAyNC4xLTM4LjIgMTQuOS0xLjMgMzAtMiA0NS4yLTIgMTUuMSAwIDMwLjIuNyA0NSAxLjkgOC4zIDExLjkgMTYuNCAyNC42IDI0LjIgMzggNy42IDEzLjEgMTQuNSAyNi40IDIwLjggMzkuOC02LjMgMTMuNC0xMy4yIDI2LjgtMjAuNyAzOS45em0zMi4zLTEzYzUuNCAxMy40IDEwIDI2LjggMTMuOCAzOS44LTEzLjEgMy4yLTI2LjkgNS45LTQxLjIgOCA0LjktNy43IDkuOC0xNS42IDE0LjQtMjMuNyA0LjYtOCA4LjktMTYuMSAxMy0yNC4xek00MjEuMiA0MzBjLTkuMy05LjYtMTguNi0yMC4zLTI3LjgtMzIgOSAuNCAxOC4yLjcgMjcuNS43IDkuNCAwIDE4LjctLjIgMjcuOC0uNy05IDExLjctMTguMyAyMi40LTI3LjUgMzJ6bS03NC40LTU4LjljLTE0LjItMi4xLTI3LjktNC43LTQxLTcuOSAzLjctMTIuOSA4LjMtMjYuMiAxMy41LTM5LjUgNC4xIDggOC40IDE2IDEzLjEgMjQgNC43IDggOS41IDE1LjggMTQuNCAyMy40ek00MjAuNyAxNjNjOS4zIDkuNiAxOC42IDIwLjMgMjcuOCAzMi05LS40LTE4LjItLjctMjcuNS0uNy05LjQgMC0xOC43LjItMjcuOC43IDktMTEuNyAxOC4zLTIyLjQgMjcuNS0zMnptLTc0IDU4LjljLTQuOSA3LjctOS44IDE1LjYtMTQuNCAyMy43LTQuNiA4LTguOSAxNi0xMyAyNC01LjQtMTMuNC0xMC0yNi44LTEzLjgtMzkuOCAxMy4xLTMuMSAyNi45LTUuOCA0MS4yLTcuOXptLTkwLjUgMTI1LjJjLTM1LjQtMTUuMS01OC4zLTM0LjktNTguMy01MC42IDAtMTUuNyAyMi45LTM1LjYgNTguMy01MC42IDguNi0zLjcgMTgtNyAyNy43LTEwLjEgNS43IDE5LjYgMTMuMiA0MCAyMi41IDYwLjktOS4yIDIwLjgtMTYuNiA0MS4xLTIyLjIgNjAuNi05LjktMy4xLTE5LjMtNi41LTI4LTEwLjJ6TTMxMCA0OTBjLTEzLjYtNy44LTE5LjUtMzcuNS0xNC45LTc1LjcgMS4xLTkuNCAyLjktMTkuMyA1LjEtMjkuNCAxOS42IDQuOCA0MSA4LjUgNjMuNSAxMC45IDEzLjUgMTguNSAyNy41IDM1LjMgNDEuNiA1MC0zMi42IDMwLjMtNjMuMiA0Ni45LTg0IDQ2LjktNC41LS4xLTguMy0xLTExLjMtMi43em0yMzcuMi03Ni4yYzQuNyAzOC4yLTEuMSA2Ny45LTE0LjYgNzUuOC0zIDEuOC02LjkgMi42LTExLjUgMi42LTIwLjcgMC01MS40LTE2LjUtODQtNDYuNiAxNC0xNC43IDI4LTMxLjQgNDEuMy00OS45IDIyLjYtMi40IDQ0LTYuMSA2My42LTExIDIuMyAxMC4xIDQuMSAxOS44IDUuMiAyOS4xem0zOC41LTY2LjdjLTguNiAzLjctMTggNy0yNy43IDEwLjEtNS43LTE5LjYtMTMuMi00MC0yMi41LTYwLjkgOS4yLTIwLjggMTYuNi00MS4xIDIyLjItNjAuNiA5LjkgMy4xIDE5LjMgNi41IDI4LjEgMTAuMiAzNS40IDE1LjEgNTguMyAzNC45IDU4LjMgNTAuNi0uMSAxNS43LTIzIDM1LjYtNTguNCA1MC42ek0zMjAuOCA3OC40eiIvPgogICAgPGNpcmNsZSBjeD0iNDIwLjkiIGN5PSIyOTYuNSIgcj0iNDUuNyIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-redo: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjE2Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgICA8cGF0aCBkPSJNMCAwaDI0djI0SDB6IiBmaWxsPSJub25lIi8+PHBhdGggZD0iTTE4LjQgMTAuNkMxNi41NSA4Ljk5IDE0LjE1IDggMTEuNSA4Yy00LjY1IDAtOC41OCAzLjAzLTkuOTYgNy4yMkwzLjkgMTZjMS4wNS0zLjE5IDQuMDUtNS41IDcuNi01LjUgMS45NSAwIDMuNzMuNzIgNS4xMiAxLjg4TDEzIDE2aDlWN2wtMy42IDMuNnoiLz4KICA8L2c+Cjwvc3ZnPgo=);
  --jp-icon-refresh: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDE4IDE4Ij4KICAgIDxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSI+CiAgICAgICAgPHBhdGggZD0iTTkgMTMuNWMtMi40OSAwLTQuNS0yLjAxLTQuNS00LjVTNi41MSA0LjUgOSA0LjVjMS4yNCAwIDIuMzYuNTIgMy4xNyAxLjMzTDEwIDhoNVYzbC0xLjc2IDEuNzZDMTIuMTUgMy42OCAxMC42NiAzIDkgMyA1LjY5IDMgMy4wMSA1LjY5IDMuMDEgOVM1LjY5IDE1IDkgMTVjMi45NyAwIDUuNDMtMi4xNiA1LjktNWgtMS41MmMtLjQ2IDItMi4yNCAzLjUtNC4zOCAzLjV6Ii8+CiAgICA8L2c+Cjwvc3ZnPgo=);
  --jp-icon-regex: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDIwIDIwIj4KICA8ZyBjbGFzcz0ianAtaWNvbjIiIGZpbGw9IiM0MTQxNDEiPgogICAgPHJlY3QgeD0iMiIgeT0iMiIgd2lkdGg9IjE2IiBoZWlnaHQ9IjE2Ii8+CiAgPC9nPgoKICA8ZyBjbGFzcz0ianAtaWNvbi1hY2NlbnQyIiBmaWxsPSIjRkZGIj4KICAgIDxjaXJjbGUgY2xhc3M9InN0MiIgY3g9IjUuNSIgY3k9IjE0LjUiIHI9IjEuNSIvPgogICAgPHJlY3QgeD0iMTIiIHk9IjQiIGNsYXNzPSJzdDIiIHdpZHRoPSIxIiBoZWlnaHQ9IjgiLz4KICAgIDxyZWN0IHg9IjguNSIgeT0iNy41IiB0cmFuc2Zvcm09Im1hdHJpeCgwLjg2NiAtMC41IDAuNSAwLjg2NiAtMi4zMjU1IDcuMzIxOSkiIGNsYXNzPSJzdDIiIHdpZHRoPSI4IiBoZWlnaHQ9IjEiLz4KICAgIDxyZWN0IHg9IjEyIiB5PSI0IiB0cmFuc2Zvcm09Im1hdHJpeCgwLjUgLTAuODY2IDAuODY2IDAuNSAtMC42Nzc5IDE0LjgyNTIpIiBjbGFzcz0ic3QyIiB3aWR0aD0iMSIgaGVpZ2h0PSI4Ii8+CiAgPC9nPgo8L3N2Zz4K);
  --jp-icon-run: url(data:image/svg+xml;base64,PHN2ZyBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICAgIDxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSI+CiAgICAgICAgPHBhdGggZD0iTTggNXYxNGwxMS03eiIvPgogICAgPC9nPgo8L3N2Zz4K);
  --jp-icon-running: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDUxMiA1MTIiPgogIDxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSI+CiAgICA8cGF0aCBkPSJNMjU2IDhDMTE5IDggOCAxMTkgOCAyNTZzMTExIDI0OCAyNDggMjQ4IDI0OC0xMTEgMjQ4LTI0OFMzOTMgOCAyNTYgOHptOTYgMzI4YzAgOC44LTcuMiAxNi0xNiAxNkgxNzZjLTguOCAwLTE2LTcuMi0xNi0xNlYxNzZjMC04LjggNy4yLTE2IDE2LTE2aDE2MGM4LjggMCAxNiA3LjIgMTYgMTZ2MTYweiIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-save: url(data:image/svg+xml;base64,PHN2ZyBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICAgIDxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSI+CiAgICAgICAgPHBhdGggZD0iTTE3IDNINWMtMS4xMSAwLTIgLjktMiAydjE0YzAgMS4xLjg5IDIgMiAyaDE0YzEuMSAwIDItLjkgMi0yVjdsLTQtNHptLTUgMTZjLTEuNjYgMC0zLTEuMzQtMy0zczEuMzQtMyAzLTMgMyAxLjM0IDMgMy0xLjM0IDMtMyAzem0zLTEwSDVWNWgxMHY0eiIvPgogICAgPC9nPgo8L3N2Zz4K);
  --jp-icon-search: url(data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMTggMTgiIHdpZHRoPSIxNiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTEyLjEsMTAuOWgtMC43bC0wLjItMC4yYzAuOC0wLjksMS4zLTIuMiwxLjMtMy41YzAtMy0yLjQtNS40LTUuNC01LjRTMS44LDQuMiwxLjgsNy4xczIuNCw1LjQsNS40LDUuNCBjMS4zLDAsMi41LTAuNSwzLjUtMS4zbDAuMiwwLjJ2MC43bDQuMSw0LjFsMS4yLTEuMkwxMi4xLDEwLjl6IE03LjEsMTAuOWMtMi4xLDAtMy43LTEuNy0zLjctMy43czEuNy0zLjcsMy43LTMuN3MzLjcsMS43LDMuNywzLjcgUzkuMiwxMC45LDcuMSwxMC45eiIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-settings: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8cGF0aCBjbGFzcz0ianAtaWNvbjMganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjNjE2MTYxIiBkPSJNMTkuNDMgMTIuOThjLjA0LS4zMi4wNy0uNjQuMDctLjk4cy0uMDMtLjY2LS4wNy0uOThsMi4xMS0xLjY1Yy4xOS0uMTUuMjQtLjQyLjEyLS42NGwtMi0zLjQ2Yy0uMTItLjIyLS4zOS0uMy0uNjEtLjIybC0yLjQ5IDFjLS41Mi0uNC0xLjA4LS43My0xLjY5LS45OGwtLjM4LTIuNjVBLjQ4OC40ODggMCAwMDE0IDJoLTRjLS4yNSAwLS40Ni4xOC0uNDkuNDJsLS4zOCAyLjY1Yy0uNjEuMjUtMS4xNy41OS0xLjY5Ljk4bC0yLjQ5LTFjLS4yMy0uMDktLjQ5IDAtLjYxLjIybC0yIDMuNDZjLS4xMy4yMi0uMDcuNDkuMTIuNjRsMi4xMSAxLjY1Yy0uMDQuMzItLjA3LjY1LS4wNy45OHMuMDMuNjYuMDcuOThsLTIuMTEgMS42NWMtLjE5LjE1LS4yNC40Mi0uMTIuNjRsMiAzLjQ2Yy4xMi4yMi4zOS4zLjYxLjIybDIuNDktMWMuNTIuNCAxLjA4LjczIDEuNjkuOThsLjM4IDIuNjVjLjAzLjI0LjI0LjQyLjQ5LjQyaDRjLjI1IDAgLjQ2LS4xOC40OS0uNDJsLjM4LTIuNjVjLjYxLS4yNSAxLjE3LS41OSAxLjY5LS45OGwyLjQ5IDFjLjIzLjA5LjQ5IDAgLjYxLS4yMmwyLTMuNDZjLjEyLS4yMi4wNy0uNDktLjEyLS42NGwtMi4xMS0xLjY1ek0xMiAxNS41Yy0xLjkzIDAtMy41LTEuNTctMy41LTMuNXMxLjU3LTMuNSAzLjUtMy41IDMuNSAxLjU3IDMuNSAzLjUtMS41NyAzLjUtMy41IDMuNXoiLz4KPC9zdmc+Cg==);
  --jp-icon-share: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIHZpZXdCb3g9IjAgMCAyNCAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTSAxOCAyIEMgMTYuMzU0OTkgMiAxNSAzLjM1NDk5MDQgMTUgNSBDIDE1IDUuMTkwOTUyOSAxNS4wMjE3OTEgNS4zNzcxMjI0IDE1LjA1NjY0MSA1LjU1ODU5MzggTCA3LjkyMTg3NSA5LjcyMDcwMzEgQyA3LjM5ODUzOTkgOS4yNzc4NTM5IDYuNzMyMDc3MSA5IDYgOSBDIDQuMzU0OTkwNCA5IDMgMTAuMzU0OTkgMyAxMiBDIDMgMTMuNjQ1MDEgNC4zNTQ5OTA0IDE1IDYgMTUgQyA2LjczMjA3NzEgMTUgNy4zOTg1Mzk5IDE0LjcyMjE0NiA3LjkyMTg3NSAxNC4yNzkyOTcgTCAxNS4wNTY2NDEgMTguNDM5NDUzIEMgMTUuMDIxNTU1IDE4LjYyMTUxNCAxNSAxOC44MDgzODYgMTUgMTkgQyAxNSAyMC42NDUwMSAxNi4zNTQ5OSAyMiAxOCAyMiBDIDE5LjY0NTAxIDIyIDIxIDIwLjY0NTAxIDIxIDE5IEMgMjEgMTcuMzU0OTkgMTkuNjQ1MDEgMTYgMTggMTYgQyAxNy4yNjc0OCAxNiAxNi42MDE1OTMgMTYuMjc5MzI4IDE2LjA3ODEyNSAxNi43MjI2NTYgTCA4Ljk0MzM1OTQgMTIuNTU4NTk0IEMgOC45NzgyMDk1IDEyLjM3NzEyMiA5IDEyLjE5MDk1MyA5IDEyIEMgOSAxMS44MDkwNDcgOC45NzgyMDk1IDExLjYyMjg3OCA4Ljk0MzM1OTQgMTEuNDQxNDA2IEwgMTYuMDc4MTI1IDcuMjc5Mjk2OSBDIDE2LjYwMTQ2IDcuNzIyMTQ2MSAxNy4yNjc5MjMgOCAxOCA4IEMgMTkuNjQ1MDEgOCAyMSA2LjY0NTAwOTYgMjEgNSBDIDIxIDMuMzU0OTkwNCAxOS42NDUwMSAyIDE4IDIgeiBNIDE4IDQgQyAxOC41NjQxMjkgNCAxOSA0LjQzNTg3MDYgMTkgNSBDIDE5IDUuNTY0MTI5NCAxOC41NjQxMjkgNiAxOCA2IEMgMTcuNDM1ODcxIDYgMTcgNS41NjQxMjk0IDE3IDUgQyAxNyA0LjQzNTg3MDYgMTcuNDM1ODcxIDQgMTggNCB6IE0gNiAxMSBDIDYuNTY0MTI5NCAxMSA3IDExLjQzNTg3MSA3IDEyIEMgNyAxMi41NjQxMjkgNi41NjQxMjk0IDEzIDYgMTMgQyA1LjQzNTg3MDYgMTMgNSAxMi41NjQxMjkgNSAxMiBDIDUgMTEuNDM1ODcxIDUuNDM1ODcwNiAxMSA2IDExIHogTSAxOCAxOCBDIDE4LjU2NDEyOSAxOCAxOSAxOC40MzU4NzEgMTkgMTkgQyAxOSAxOS41NjQxMjkgMTguNTY0MTI5IDIwIDE4IDIwIEMgMTcuNDM1ODcxIDIwIDE3IDE5LjU2NDEyOSAxNyAxOSBDIDE3IDE4LjQzNTg3MSAxNy40MzU4NzEgMTggMTggMTggeiIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-spreadsheet: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDIyIDIyIj4KICA8cGF0aCBjbGFzcz0ianAtaWNvbi1jb250cmFzdDEganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjNENBRjUwIiBkPSJNMi4yIDIuMnYxNy42aDE3LjZWMi4ySDIuMnptMTUuNCA3LjdoLTUuNVY0LjRoNS41djUuNXpNOS45IDQuNHY1LjVINC40VjQuNGg1LjV6bS01LjUgNy43aDUuNXY1LjVINC40di01LjV6bTcuNyA1LjV2LTUuNWg1LjV2NS41aC01LjV6Ii8+Cjwvc3ZnPgo=);
  --jp-icon-stop: url(data:image/svg+xml;base64,PHN2ZyBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICAgIDxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSI+CiAgICAgICAgPHBhdGggZD0iTTAgMGgyNHYyNEgweiIgZmlsbD0ibm9uZSIvPgogICAgICAgIDxwYXRoIGQ9Ik02IDZoMTJ2MTJINnoiLz4KICAgIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-tab: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTIxIDNIM2MtMS4xIDAtMiAuOS0yIDJ2MTRjMCAxLjEuOSAyIDIgMmgxOGMxLjEgMCAyLS45IDItMlY1YzAtMS4xLS45LTItMi0yem0wIDE2SDNWNWgxMHY0aDh2MTB6Ii8+CiAgPC9nPgo8L3N2Zz4K);
  --jp-icon-table-rows: url(data:image/svg+xml;base64,PHN2ZyBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICAgIDxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSI+CiAgICAgICAgPHBhdGggZD0iTTAgMGgyNHYyNEgweiIgZmlsbD0ibm9uZSIvPgogICAgICAgIDxwYXRoIGQ9Ik0yMSw4SDNWNGgxOFY4eiBNMjEsMTBIM3Y0aDE4VjEweiBNMjEsMTZIM3Y0aDE4VjE2eiIvPgogICAgPC9nPgo8L3N2Zz4K);
  --jp-icon-tag: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjgiIGhlaWdodD0iMjgiIHZpZXdCb3g9IjAgMCA0MyAyOCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KCTxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSI+CgkJPHBhdGggZD0iTTI4LjgzMzIgMTIuMzM0TDMyLjk5OTggMTYuNTAwN0wzNy4xNjY1IDEyLjMzNEgyOC44MzMyWiIvPgoJCTxwYXRoIGQ9Ik0xNi4yMDk1IDIxLjYxMDRDMTUuNjg3MyAyMi4xMjk5IDE0Ljg0NDMgMjIuMTI5OSAxNC4zMjQ4IDIxLjYxMDRMNi45ODI5IDE0LjcyNDVDNi41NzI0IDE0LjMzOTQgNi4wODMxMyAxMy42MDk4IDYuMDQ3ODYgMTMuMDQ4MkM1Ljk1MzQ3IDExLjUyODggNi4wMjAwMiA4LjYxOTQ0IDYuMDY2MjEgNy4wNzY5NUM2LjA4MjgxIDYuNTE0NzcgNi41NTU0OCA2LjA0MzQ3IDcuMTE4MDQgNi4wMzA1NUM5LjA4ODYzIDUuOTg0NzMgMTMuMjYzOCA1LjkzNTc5IDEzLjY1MTggNi4zMjQyNUwyMS43MzY5IDEzLjYzOUMyMi4yNTYgMTQuMTU4NSAyMS43ODUxIDE1LjQ3MjQgMjEuMjYyIDE1Ljk5NDZMMTYuMjA5NSAyMS42MTA0Wk05Ljc3NTg1IDguMjY1QzkuMzM1NTEgNy44MjU2NiA4LjYyMzUxIDcuODI1NjYgOC4xODI4IDguMjY1QzcuNzQzNDYgOC43MDU3MSA3Ljc0MzQ2IDkuNDE3MzMgOC4xODI4IDkuODU2NjdDOC42MjM4MiAxMC4yOTY0IDkuMzM1ODIgMTAuMjk2NCA5Ljc3NTg1IDkuODU2NjdDMTAuMjE1NiA5LjQxNzMzIDEwLjIxNTYgOC43MDUzMyA5Ljc3NTg1IDguMjY1WiIvPgoJPC9nPgo8L3N2Zz4K);
  --jp-icon-terminal: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0IiA+CiAgICA8cmVjdCBjbGFzcz0ianAtdGVybWluYWwtaWNvbi1iYWNrZ3JvdW5kLWNvbG9yIGpwLWljb24tc2VsZWN0YWJsZSIgd2lkdGg9IjIwIiBoZWlnaHQ9IjIwIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgyIDIpIiBmaWxsPSIjMzMzMzMzIi8+CiAgICA8cGF0aCBjbGFzcz0ianAtdGVybWluYWwtaWNvbi1jb2xvciBqcC1pY29uLXNlbGVjdGFibGUtaW52ZXJzZSIgZD0iTTUuMDU2NjQgOC43NjE3MkM1LjA1NjY0IDguNTk3NjYgNS4wMzEyNSA4LjQ1MzEyIDQuOTgwNDcgOC4zMjgxMkM0LjkzMzU5IDguMTk5MjIgNC44NTU0NyA4LjA4MjAzIDQuNzQ2MDkgNy45NzY1NkM0LjY0MDYyIDcuODcxMDkgNC41IDcuNzc1MzkgNC4zMjQyMiA3LjY4OTQ1QzQuMTUyMzQgNy41OTk2MSAzLjk0MzM2IDcuNTExNzIgMy42OTcyNyA3LjQyNTc4QzMuMzAyNzMgNy4yODUxNiAyLjk0MzM2IDcuMTM2NzIgMi42MTkxNCA2Ljk4MDQ3QzIuMjk0OTIgNi44MjQyMiAyLjAxNzU4IDYuNjQyNTggMS43ODcxMSA2LjQzNTU1QzEuNTYwNTUgNi4yMjg1MiAxLjM4NDc3IDUuOTg4MjggMS4yNTk3NyA1LjcxNDg0QzEuMTM0NzcgNS40Mzc1IDEuMDcyMjcgNS4xMDkzOCAxLjA3MjI3IDQuNzMwNDdDMS4wNzIyNyA0LjM5ODQ0IDEuMTI4OTEgNC4wOTU3IDEuMjQyMTkgMy44MjIyN0MxLjM1NTQ3IDMuNTQ0OTIgMS41MTU2MiAzLjMwNDY5IDEuNzIyNjYgMy4xMDE1NkMxLjkyOTY5IDIuODk4NDQgMi4xNzk2OSAyLjczNDM3IDIuNDcyNjYgMi42MDkzOEMyLjc2NTYyIDIuNDg0MzggMy4wOTE4IDIuNDA0MyAzLjQ1MTE3IDIuMzY5MTRWMS4xMDkzOEg0LjM4ODY3VjIuMzgwODZDNC43NDAyMyAyLjQyNzczIDUuMDU2NjQgMi41MjM0NCA1LjMzNzg5IDIuNjY3OTdDNS42MTkxNCAyLjgxMjUgNS44NTc0MiAzLjAwMTk1IDYuMDUyNzMgMy4yMzYzM0M2LjI1MTk1IDMuNDY2OCA2LjQwNDMgMy43NDAyMyA2LjUwOTc3IDQuMDU2NjRDNi42MTkxNCA0LjM2OTE0IDYuNjczODMgNC43MjA3IDYuNjczODMgNS4xMTEzM0g1LjA0NDkyQzUuMDQ0OTIgNC42Mzg2NyA0LjkzNzUgNC4yODEyNSA0LjcyMjY2IDQuMDM5MDZDNC41MDc4MSAzLjc5Mjk3IDQuMjE2OCAzLjY2OTkyIDMuODQ5NjEgMy42Njk5MkMzLjY1MDM5IDMuNjY5OTIgMy40NzY1NiAzLjY5NzI3IDMuMzI4MTIgMy43NTE5NUMzLjE4MzU5IDMuODAyNzMgMy4wNjQ0NSAzLjg3Njk1IDIuOTcwNyAzLjk3NDYxQzIuODc2OTUgNC4wNjgzNiAyLjgwNjY0IDQuMTc5NjkgMi43NTk3NyA0LjMwODU5QzIuNzE2OCA0LjQzNzUgMi42OTUzMSA0LjU3ODEyIDIuNjk1MzEgNC43MzA0N0MyLjY5NTMxIDQuODgyODEgMi43MTY4IDUuMDE5NTMgMi43NTk3NyA1LjE0MDYyQzIuODA2NjQgNS4yNTc4MSAyLjg4MjgxIDUuMzY3MTkgMi45ODgyOCA1LjQ2ODc1QzMuMDk3NjYgNS41NzAzMSAzLjI0MDIzIDUuNjY3OTcgMy40MTYwMiA1Ljc2MTcyQzMuNTkxOCA1Ljg1MTU2IDMuODEwNTUgNS45NDMzNiA0LjA3MjI3IDYuMDM3MTFDNC40NjY4IDYuMTg1NTUgNC44MjQyMiA2LjMzOTg0IDUuMTQ0NTMgNi41QzUuNDY0ODQgNi42NTYyNSA1LjczODI4IDYuODM5ODQgNS45NjQ4NCA3LjA1MDc4QzYuMTk1MzEgNy4yNTc4MSA2LjM3MTA5IDcuNSA2LjQ5MjE5IDcuNzc3MzRDNi42MTcxOSA4LjA1MDc4IDYuNjc5NjkgOC4zNzUgNi42Nzk2OSA4Ljc1QzYuNjc5NjkgOS4wOTM3NSA2LjYyMzA1IDkuNDA0MyA2LjUwOTc3IDkuNjgxNjRDNi4zOTY0OCA5Ljk1NTA4IDYuMjM0MzggMTAuMTkxNCA2LjAyMzQ0IDEwLjM5MDZDNS44MTI1IDEwLjU4OTggNS41NTg1OSAxMC43NSA1LjI2MTcyIDEwLjg3MTFDNC45NjQ4NCAxMC45ODgzIDQuNjMyODEgMTEuMDY0NSA0LjI2NTYyIDExLjA5OTZWMTIuMjQ4SDMuMzMzOThWMTEuMDk5NkMzLjAwMTk1IDExLjA2ODQgMi42Nzk2OSAxMC45OTYxIDIuMzY3MTkgMTAuODgyOEMyLjA1NDY5IDEwLjc2NTYgMS43NzczNCAxMC41OTc3IDEuNTM1MTYgMTAuMzc4OUMxLjI5Njg4IDEwLjE2MDIgMS4xMDU0NyA5Ljg4NDc3IDAuOTYwOTM4IDkuNTUyNzNDMC44MTY0MDYgOS4yMTY4IDAuNzQ0MTQxIDguODE0NDUgMC43NDQxNDEgOC4zNDU3SDIuMzc4OTFDMi4zNzg5MSA4LjYyNjk1IDIuNDE5OTIgOC44NjMyOCAyLjUwMTk1IDkuMDU0NjlDMi41ODM5OCA5LjI0MjE5IDIuNjg5NDUgOS4zOTI1OCAyLjgxODM2IDkuNTA1ODZDMi45NTExNyA5LjYxNTIzIDMuMTAxNTYgOS42OTMzNiAzLjI2OTUzIDkuNzQwMjNDMy40Mzc1IDkuNzg3MTEgMy42MDkzOCA5LjgxMDU1IDMuNzg1MTYgOS44MTA1NUM0LjIwMzEyIDkuODEwNTUgNC41MTk1MyA5LjcxMjg5IDQuNzM0MzggOS41MTc1OEM0Ljk0OTIyIDkuMzIyMjcgNS4wNTY2NCA5LjA3MDMxIDUuMDU2NjQgOC43NjE3MlpNMTMuNDE4IDEyLjI3MTVIOC4wNzQyMlYxMUgxMy40MThWMTIuMjcxNVoiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDMuOTUyNjQgNikiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPgo=);
  --jp-icon-text-editor: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8cGF0aCBjbGFzcz0ianAtdGV4dC1lZGl0b3ItaWNvbi1jb2xvciBqcC1pY29uLXNlbGVjdGFibGUiIGZpbGw9IiM2MTYxNjEiIGQ9Ik0xNSAxNUgzdjJoMTJ2LTJ6bTAtOEgzdjJoMTJWN3pNMyAxM2gxOHYtMkgzdjJ6bTAgOGgxOHYtMkgzdjJ6TTMgM3YyaDE4VjNIM3oiLz4KPC9zdmc+Cg==);
  --jp-icon-toc: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjNjE2MTYxIj4KICAgIDxwYXRoIGQ9Ik03LDVIMjFWN0g3VjVNNywxM1YxMUgyMVYxM0g3TTQsNC41QTEuNSwxLjUgMCAwLDEgNS41LDZBMS41LDEuNSAwIDAsMSA0LDcuNUExLjUsMS41IDAgMCwxIDIuNSw2QTEuNSwxLjUgMCAwLDEgNCw0LjVNNCwxMC41QTEuNSwxLjUgMCAwLDEgNS41LDEyQTEuNSwxLjUgMCAwLDEgNCwxMy41QTEuNSwxLjUgMCAwLDEgMi41LDEyQTEuNSwxLjUgMCAwLDEgNCwxMC41TTcsMTlWMTdIMjFWMTlIN000LDE2LjVBMS41LDEuNSAwIDAsMSA1LjUsMThBMS41LDEuNSAwIDAsMSA0LDE5LjVBMS41LDEuNSAwIDAsMSAyLjUsMThBMS41LDEuNSAwIDAsMSA0LDE2LjVaIiAvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-tree-view: url(data:image/svg+xml;base64,PHN2ZyBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICAgIDxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSI+CiAgICAgICAgPHBhdGggZD0iTTAgMGgyNHYyNEgweiIgZmlsbD0ibm9uZSIvPgogICAgICAgIDxwYXRoIGQ9Ik0yMiAxMVYzaC03djNIOVYzSDJ2OGg3VjhoMnYxMGg0djNoN3YtOGgtN3YzaC0yVjhoMnYzeiIvPgogICAgPC9nPgo8L3N2Zz4K);
  --jp-icon-trusted: url(data:image/svg+xml;base64,PHN2ZyBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI1Ij4KICAgIDxwYXRoIGNsYXNzPSJqcC1pY29uMiIgc3Ryb2tlPSIjMzMzMzMzIiBzdHJva2Utd2lkdGg9IjIiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDIgMykiIGQ9Ik0xLjg2MDk0IDExLjQ0MDlDMC44MjY0NDggOC43NzAyNyAwLjg2Mzc3OSA2LjA1NzY0IDEuMjQ5MDcgNC4xOTkzMkMyLjQ4MjA2IDMuOTMzNDcgNC4wODA2OCAzLjQwMzQ3IDUuNjAxMDIgMi44NDQ5QzcuMjM1NDkgMi4yNDQ0IDguODU2NjYgMS41ODE1IDkuOTg3NiAxLjA5NTM5QzExLjA1OTcgMS41ODM0MSAxMi42MDk0IDIuMjQ0NCAxNC4yMTggMi44NDMzOUMxNS43NTAzIDMuNDEzOTQgMTcuMzk5NSAzLjk1MjU4IDE4Ljc1MzkgNC4yMTM4NUMxOS4xMzY0IDYuMDcxNzcgMTkuMTcwOSA4Ljc3NzIyIDE4LjEzOSAxMS40NDA5QzE3LjAzMDMgMTQuMzAzMiAxNC42NjY4IDE3LjE4NDQgOS45OTk5OSAxOC45MzU0QzUuMzMzMiAxNy4xODQ0IDIuOTY5NjggMTQuMzAzMiAxLjg2MDk0IDExLjQ0MDlaIi8+CiAgICA8cGF0aCBjbGFzcz0ianAtaWNvbjIiIGZpbGw9IiMzMzMzMzMiIHN0cm9rZT0iIzMzMzMzMyIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoOCA5Ljg2NzE5KSIgZD0iTTIuODYwMTUgNC44NjUzNUwwLjcyNjU0OSAyLjk5OTU5TDAgMy42MzA0NUwyLjg2MDE1IDYuMTMxNTdMOCAwLjYzMDg3Mkw3LjI3ODU3IDBMMi44NjAxNSA0Ljg2NTM1WiIvPgo8L3N2Zz4K);
  --jp-icon-undo: url(data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIxNiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTEyLjUgOGMtMi42NSAwLTUuMDUuOTktNi45IDIuNkwyIDd2OWg5bC0zLjYyLTMuNjJjMS4zOS0xLjE2IDMuMTYtMS44OCA1LjEyLTEuODggMy41NCAwIDYuNTUgMi4zMSA3LjYgNS41bDIuMzctLjc4QzIxLjA4IDExLjAzIDE3LjE1IDggMTIuNSA4eiIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-user: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIHZpZXdCb3g9IjAgMCAyNCAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTE2IDdhNCA0IDAgMTEtOCAwIDQgNCAwIDAxOCAwek0xMiAxNGE3IDcgMCAwMC03IDdoMTRhNyA3IDAgMDAtNy03eiIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-users: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDM2IDI0IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgogPGcgY2xhc3M9ImpwLWljb24zIiB0cmFuc2Zvcm09Im1hdHJpeCgxLjczMjcgMCAwIDEuNzMyNyAtMy42MjgyIC4wOTk1NzcpIiBmaWxsPSIjNjE2MTYxIj4KICA8cGF0aCB0cmFuc2Zvcm09Im1hdHJpeCgxLjUsMCwwLDEuNSwwLC02KSIgZD0ibTEyLjE4NiA3LjUwOThjLTEuMDUzNSAwLTEuOTc1NyAwLjU2NjUtMi40Nzg1IDEuNDEwMiAwLjc1MDYxIDAuMzEyNzcgMS4zOTc0IDAuODI2NDggMS44NzMgMS40NzI3aDMuNDg2M2MwLTEuNTkyLTEuMjg4OS0yLjg4MjgtMi44ODA5LTIuODgyOHoiLz4KICA8cGF0aCBkPSJtMjAuNDY1IDIuMzg5NWEyLjE4ODUgMi4xODg1IDAgMCAxLTIuMTg4NCAyLjE4ODUgMi4xODg1IDIuMTg4NSAwIDAgMS0yLjE4ODUtMi4xODg1IDIuMTg4NSAyLjE4ODUgMCAwIDEgMi4xODg1LTIuMTg4NSAyLjE4ODUgMi4xODg1IDAgMCAxIDIuMTg4NCAyLjE4ODV6Ii8+CiAgPHBhdGggdHJhbnNmb3JtPSJtYXRyaXgoMS41LDAsMCwxLjUsMCwtNikiIGQ9Im0zLjU4OTggOC40MjE5Yy0xLjExMjYgMC0yLjAxMzcgMC45MDExMS0yLjAxMzcgMi4wMTM3aDIuODE0NWMwLjI2Nzk3LTAuMzczMDkgMC41OTA3LTAuNzA0MzUgMC45NTg5OC0wLjk3ODUyLTAuMzQ0MzMtMC42MTY4OC0xLjAwMzEtMS4wMzUyLTEuNzU5OC0xLjAzNTJ6Ii8+CiAgPHBhdGggZD0ibTYuOTE1NCA0LjYyM2ExLjUyOTQgMS41Mjk0IDAgMCAxLTEuNTI5NCAxLjUyOTQgMS41Mjk0IDEuNTI5NCAwIDAgMS0xLjUyOTQtMS41Mjk0IDEuNTI5NCAxLjUyOTQgMCAwIDEgMS41Mjk0LTEuNTI5NCAxLjUyOTQgMS41Mjk0IDAgMCAxIDEuNTI5NCAxLjUyOTR6Ii8+CiAgPHBhdGggZD0ibTYuMTM1IDEzLjUzNWMwLTMuMjM5MiAyLjYyNTktNS44NjUgNS44NjUtNS44NjUgMy4yMzkyIDAgNS44NjUgMi42MjU5IDUuODY1IDUuODY1eiIvPgogIDxjaXJjbGUgY3g9IjEyIiBjeT0iMy43Njg1IiByPSIyLjk2ODUiLz4KIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-vega: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDIyIDIyIj4KICA8ZyBjbGFzcz0ianAtaWNvbjEganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjMjEyMTIxIj4KICAgIDxwYXRoIGQ9Ik0xMC42IDUuNGwyLjItMy4ySDIuMnY3LjNsNC02LjZ6Ii8+CiAgICA8cGF0aCBkPSJNMTUuOCAyLjJsLTQuNCA2LjZMNyA2LjNsLTQuOCA4djUuNWgxNy42VjIuMmgtNHptLTcgMTUuNEg1LjV2LTQuNGgzLjN2NC40em00LjQgMEg5LjhWOS44aDMuNHY3Ljh6bTQuNCAwaC0zLjRWNi41aDMuNHYxMS4xeiIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-word: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDIwIDIwIj4KIDxnIGNsYXNzPSJqcC1pY29uMiIgZmlsbD0iIzQxNDE0MSI+CiAgPHJlY3QgeD0iMiIgeT0iMiIgd2lkdGg9IjE2IiBoZWlnaHQ9IjE2Ii8+CiA8L2c+CiA8ZyBjbGFzcz0ianAtaWNvbi1hY2NlbnQyIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSguNDMgLjA0MDEpIiBmaWxsPSIjZmZmIj4KICA8cGF0aCBkPSJtNC4xNCA4Ljc2cTAuMDY4Mi0xLjg5IDIuNDItMS44OSAxLjE2IDAgMS42OCAwLjQyIDAuNTY3IDAuNDEgMC41NjcgMS4xNnYzLjQ3cTAgMC40NjIgMC41MTQgMC40NjIgMC4xMDMgMCAwLjItMC4wMjMxdjAuNzE0cS0wLjM5OSAwLjEwMy0wLjY1MSAwLjEwMy0wLjQ1MiAwLTAuNjkzLTAuMjItMC4yMzEtMC4yLTAuMjg0LTAuNjYyLTAuOTU2IDAuODcyLTIgMC44NzItMC45MDMgMC0xLjQ3LTAuNDcyLTAuNTI1LTAuNDcyLTAuNTI1LTEuMjYgMC0wLjI2MiAwLjA0NTItMC40NzIgMC4wNTY3LTAuMjIgMC4xMTYtMC4zNzggMC4wNjgyLTAuMTY4IDAuMjMxLTAuMzA0IDAuMTU4LTAuMTQ3IDAuMjYyLTAuMjQyIDAuMTE2LTAuMDkxNCAwLjM2OC0wLjE2OCAwLjI2Mi0wLjA5MTQgMC4zOTktMC4xMjYgMC4xMzYtMC4wNDUyIDAuNDcyLTAuMTAzIDAuMzM2LTAuMDU3OCAwLjUwNC0wLjA3OTggMC4xNTgtMC4wMjMxIDAuNTY3LTAuMDc5OCAwLjU1Ni0wLjA2ODIgMC43NzctMC4yMjEgMC4yMi0wLjE1MiAwLjIyLTAuNDQxdi0wLjI1MnEwLTAuNDMtMC4zNTctMC42NjItMC4zMzYtMC4yMzEtMC45NzYtMC4yMzEtMC42NjIgMC0wLjk5OCAwLjI2Mi0wLjMzNiAwLjI1Mi0wLjM5OSAwLjc5OHptMS44OSAzLjY4cTAuNzg4IDAgMS4yNi0wLjQxIDAuNTA0LTAuNDIgMC41MDQtMC45MDN2LTEuMDVxLTAuMjg0IDAuMTM2LTAuODYxIDAuMjMxLTAuNTY3IDAuMDkxNC0wLjk4NyAwLjE1OC0wLjQyIDAuMDY4Mi0wLjc2NiAwLjMyNi0wLjMzNiAwLjI1Mi0wLjMzNiAwLjcwNHQwLjMwNCAwLjcwNCAwLjg2MSAwLjI1MnoiIHN0cm9rZS13aWR0aD0iMS4wNSIvPgogIDxwYXRoIGQ9Im0xMCA0LjU2aDAuOTQ1djMuMTVxMC42NTEtMC45NzYgMS44OS0wLjk3NiAxLjE2IDAgMS44OSAwLjg0IDAuNjgyIDAuODQgMC42ODIgMi4zMSAwIDEuNDctMC43MDQgMi40Mi0wLjcwNCAwLjg4Mi0xLjg5IDAuODgyLTEuMjYgMC0xLjg5LTEuMDJ2MC43NjZoLTAuODV6bTIuNjIgMy4wNHEtMC43NDYgMC0xLjE2IDAuNjQtMC40NTIgMC42My0wLjQ1MiAxLjY4IDAgMS4wNSAwLjQ1MiAxLjY4dDEuMTYgMC42M3EwLjc3NyAwIDEuMjYtMC42MyAwLjQ5NC0wLjY0IDAuNDk0LTEuNjggMC0xLjA1LTAuNDcyLTEuNjgtMC40NjItMC42NC0xLjI2LTAuNjR6IiBzdHJva2Utd2lkdGg9IjEuMDUiLz4KICA8cGF0aCBkPSJtMi43MyAxNS44IDEzLjYgMC4wMDgxYzAuMDA2OSAwIDAtMi42IDAtMi42IDAtMC4wMDc4LTEuMTUgMC0xLjE1IDAtMC4wMDY5IDAtMC4wMDgzIDEuNS0wLjAwODMgMS41LTJlLTMgLTAuMDAxNC0xMS4zLTAuMDAxNC0xMS4zLTAuMDAxNGwtMC4wMDU5Mi0xLjVjMC0wLjAwNzgtMS4xNyAwLjAwMTMtMS4xNyAwLjAwMTN6IiBzdHJva2Utd2lkdGg9Ii45NzUiLz4KIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-yaml: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDIyIDIyIj4KICA8ZyBjbGFzcz0ianAtaWNvbi1jb250cmFzdDIganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjRDgxQjYwIj4KICAgIDxwYXRoIGQ9Ik03LjIgMTguNnYtNS40TDMgNS42aDMuM2wxLjQgMy4xYy4zLjkuNiAxLjYgMSAyLjUuMy0uOC42LTEuNiAxLTIuNWwxLjQtMy4xaDMuNGwtNC40IDcuNnY1LjVsLTIuOS0uMXoiLz4KICAgIDxjaXJjbGUgY2xhc3M9InN0MCIgY3g9IjE3LjYiIGN5PSIxNi41IiByPSIyLjEiLz4KICAgIDxjaXJjbGUgY2xhc3M9InN0MCIgY3g9IjE3LjYiIGN5PSIxMSIgcj0iMi4xIi8+CiAgPC9nPgo8L3N2Zz4K);
}

/* Icon CSS class declarations */

.jp-AddAboveIcon {
  background-image: var(--jp-icon-add-above);
}

.jp-AddBelowIcon {
  background-image: var(--jp-icon-add-below);
}

.jp-AddIcon {
  background-image: var(--jp-icon-add);
}

.jp-BellIcon {
  background-image: var(--jp-icon-bell);
}

.jp-BugDotIcon {
  background-image: var(--jp-icon-bug-dot);
}

.jp-BugIcon {
  background-image: var(--jp-icon-bug);
}

.jp-BuildIcon {
  background-image: var(--jp-icon-build);
}

.jp-CaretDownEmptyIcon {
  background-image: var(--jp-icon-caret-down-empty);
}

.jp-CaretDownEmptyThinIcon {
  background-image: var(--jp-icon-caret-down-empty-thin);
}

.jp-CaretDownIcon {
  background-image: var(--jp-icon-caret-down);
}

.jp-CaretLeftIcon {
  background-image: var(--jp-icon-caret-left);
}

.jp-CaretRightIcon {
  background-image: var(--jp-icon-caret-right);
}

.jp-CaretUpEmptyThinIcon {
  background-image: var(--jp-icon-caret-up-empty-thin);
}

.jp-CaretUpIcon {
  background-image: var(--jp-icon-caret-up);
}

.jp-CaseSensitiveIcon {
  background-image: var(--jp-icon-case-sensitive);
}

.jp-CheckIcon {
  background-image: var(--jp-icon-check);
}

.jp-CircleEmptyIcon {
  background-image: var(--jp-icon-circle-empty);
}

.jp-CircleIcon {
  background-image: var(--jp-icon-circle);
}

.jp-ClearIcon {
  background-image: var(--jp-icon-clear);
}

.jp-CloseIcon {
  background-image: var(--jp-icon-close);
}

.jp-CodeCheckIcon {
  background-image: var(--jp-icon-code-check);
}

.jp-CodeIcon {
  background-image: var(--jp-icon-code);
}

.jp-CollapseAllIcon {
  background-image: var(--jp-icon-collapse-all);
}

.jp-ConsoleIcon {
  background-image: var(--jp-icon-console);
}

.jp-CopyIcon {
  background-image: var(--jp-icon-copy);
}

.jp-CopyrightIcon {
  background-image: var(--jp-icon-copyright);
}

.jp-CutIcon {
  background-image: var(--jp-icon-cut);
}

.jp-DeleteIcon {
  background-image: var(--jp-icon-delete);
}

.jp-DownloadIcon {
  background-image: var(--jp-icon-download);
}

.jp-DuplicateIcon {
  background-image: var(--jp-icon-duplicate);
}

.jp-EditIcon {
  background-image: var(--jp-icon-edit);
}

.jp-EllipsesIcon {
  background-image: var(--jp-icon-ellipses);
}

.jp-ErrorIcon {
  background-image: var(--jp-icon-error);
}

.jp-ExpandAllIcon {
  background-image: var(--jp-icon-expand-all);
}

.jp-ExtensionIcon {
  background-image: var(--jp-icon-extension);
}

.jp-FastForwardIcon {
  background-image: var(--jp-icon-fast-forward);
}

.jp-FileIcon {
  background-image: var(--jp-icon-file);
}

.jp-FileUploadIcon {
  background-image: var(--jp-icon-file-upload);
}

.jp-FilterDotIcon {
  background-image: var(--jp-icon-filter-dot);
}

.jp-FilterIcon {
  background-image: var(--jp-icon-filter);
}

.jp-FilterListIcon {
  background-image: var(--jp-icon-filter-list);
}

.jp-FolderFavoriteIcon {
  background-image: var(--jp-icon-folder-favorite);
}

.jp-FolderIcon {
  background-image: var(--jp-icon-folder);
}

.jp-HomeIcon {
  background-image: var(--jp-icon-home);
}

.jp-Html5Icon {
  background-image: var(--jp-icon-html5);
}

.jp-ImageIcon {
  background-image: var(--jp-icon-image);
}

.jp-InfoIcon {
  background-image: var(--jp-icon-info);
}

.jp-InspectorIcon {
  background-image: var(--jp-icon-inspector);
}

.jp-JsonIcon {
  background-image: var(--jp-icon-json);
}

.jp-JuliaIcon {
  background-image: var(--jp-icon-julia);
}

.jp-JupyterFaviconIcon {
  background-image: var(--jp-icon-jupyter-favicon);
}

.jp-JupyterIcon {
  background-image: var(--jp-icon-jupyter);
}

.jp-JupyterlabWordmarkIcon {
  background-image: var(--jp-icon-jupyterlab-wordmark);
}

.jp-KernelIcon {
  background-image: var(--jp-icon-kernel);
}

.jp-KeyboardIcon {
  background-image: var(--jp-icon-keyboard);
}

.jp-LaunchIcon {
  background-image: var(--jp-icon-launch);
}

.jp-LauncherIcon {
  background-image: var(--jp-icon-launcher);
}

.jp-LineFormIcon {
  background-image: var(--jp-icon-line-form);
}

.jp-LinkIcon {
  background-image: var(--jp-icon-link);
}

.jp-ListIcon {
  background-image: var(--jp-icon-list);
}

.jp-MarkdownIcon {
  background-image: var(--jp-icon-markdown);
}

.jp-MoveDownIcon {
  background-image: var(--jp-icon-move-down);
}

.jp-MoveUpIcon {
  background-image: var(--jp-icon-move-up);
}

.jp-NewFolderIcon {
  background-image: var(--jp-icon-new-folder);
}

.jp-NotTrustedIcon {
  background-image: var(--jp-icon-not-trusted);
}

.jp-NotebookIcon {
  background-image: var(--jp-icon-notebook);
}

.jp-NumberingIcon {
  background-image: var(--jp-icon-numbering);
}

.jp-OfflineBoltIcon {
  background-image: var(--jp-icon-offline-bolt);
}

.jp-PaletteIcon {
  background-image: var(--jp-icon-palette);
}

.jp-PasteIcon {
  background-image: var(--jp-icon-paste);
}

.jp-PdfIcon {
  background-image: var(--jp-icon-pdf);
}

.jp-PythonIcon {
  background-image: var(--jp-icon-python);
}

.jp-RKernelIcon {
  background-image: var(--jp-icon-r-kernel);
}

.jp-ReactIcon {
  background-image: var(--jp-icon-react);
}

.jp-RedoIcon {
  background-image: var(--jp-icon-redo);
}

.jp-RefreshIcon {
  background-image: var(--jp-icon-refresh);
}

.jp-RegexIcon {
  background-image: var(--jp-icon-regex);
}

.jp-RunIcon {
  background-image: var(--jp-icon-run);
}

.jp-RunningIcon {
  background-image: var(--jp-icon-running);
}

.jp-SaveIcon {
  background-image: var(--jp-icon-save);
}

.jp-SearchIcon {
  background-image: var(--jp-icon-search);
}

.jp-SettingsIcon {
  background-image: var(--jp-icon-settings);
}

.jp-ShareIcon {
  background-image: var(--jp-icon-share);
}

.jp-SpreadsheetIcon {
  background-image: var(--jp-icon-spreadsheet);
}

.jp-StopIcon {
  background-image: var(--jp-icon-stop);
}

.jp-TabIcon {
  background-image: var(--jp-icon-tab);
}

.jp-TableRowsIcon {
  background-image: var(--jp-icon-table-rows);
}

.jp-TagIcon {
  background-image: var(--jp-icon-tag);
}

.jp-TerminalIcon {
  background-image: var(--jp-icon-terminal);
}

.jp-TextEditorIcon {
  background-image: var(--jp-icon-text-editor);
}

.jp-TocIcon {
  background-image: var(--jp-icon-toc);
}

.jp-TreeViewIcon {
  background-image: var(--jp-icon-tree-view);
}

.jp-TrustedIcon {
  background-image: var(--jp-icon-trusted);
}

.jp-UndoIcon {
  background-image: var(--jp-icon-undo);
}

.jp-UserIcon {
  background-image: var(--jp-icon-user);
}

.jp-UsersIcon {
  background-image: var(--jp-icon-users);
}

.jp-VegaIcon {
  background-image: var(--jp-icon-vega);
}

.jp-WordIcon {
  background-image: var(--jp-icon-word);
}

.jp-YamlIcon {
  background-image: var(--jp-icon-yaml);
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/**
 * (DEPRECATED) Support for consuming icons as CSS background images
 */

.jp-Icon,
.jp-MaterialIcon {
  background-position: center;
  background-repeat: no-repeat;
  background-size: 16px;
  min-width: 16px;
  min-height: 16px;
}

.jp-Icon-cover {
  background-position: center;
  background-repeat: no-repeat;
  background-size: cover;
}

/**
 * (DEPRECATED) Support for specific CSS icon sizes
 */

.jp-Icon-16 {
  background-size: 16px;
  min-width: 16px;
  min-height: 16px;
}

.jp-Icon-18 {
  background-size: 18px;
  min-width: 18px;
  min-height: 18px;
}

.jp-Icon-20 {
  background-size: 20px;
  min-width: 20px;
  min-height: 20px;
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

.lm-TabBar .lm-TabBar-addButton {
  align-items: center;
  display: flex;
  padding: 4px;
  padding-bottom: 5px;
  margin-right: 1px;
  background-color: var(--jp-layout-color2);
}

.lm-TabBar .lm-TabBar-addButton:hover {
  background-color: var(--jp-layout-color1);
}

.lm-DockPanel-tabBar .lm-TabBar-tab {
  width: var(--jp-private-horizontal-tab-width);
}

.lm-DockPanel-tabBar .lm-TabBar-content {
  flex: unset;
}

.lm-DockPanel-tabBar[data-orientation='horizontal'] {
  flex: 1 1 auto;
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/**
 * Support for icons as inline SVG HTMLElements
 */

/* recolor the primary elements of an icon */
.jp-icon0[fill] {
  fill: var(--jp-inverse-layout-color0);
}

.jp-icon1[fill] {
  fill: var(--jp-inverse-layout-color1);
}

.jp-icon2[fill] {
  fill: var(--jp-inverse-layout-color2);
}

.jp-icon3[fill] {
  fill: var(--jp-inverse-layout-color3);
}

.jp-icon4[fill] {
  fill: var(--jp-inverse-layout-color4);
}

.jp-icon0[stroke] {
  stroke: var(--jp-inverse-layout-color0);
}

.jp-icon1[stroke] {
  stroke: var(--jp-inverse-layout-color1);
}

.jp-icon2[stroke] {
  stroke: var(--jp-inverse-layout-color2);
}

.jp-icon3[stroke] {
  stroke: var(--jp-inverse-layout-color3);
}

.jp-icon4[stroke] {
  stroke: var(--jp-inverse-layout-color4);
}

/* recolor the accent elements of an icon */
.jp-icon-accent0[fill] {
  fill: var(--jp-layout-color0);
}

.jp-icon-accent1[fill] {
  fill: var(--jp-layout-color1);
}

.jp-icon-accent2[fill] {
  fill: var(--jp-layout-color2);
}

.jp-icon-accent3[fill] {
  fill: var(--jp-layout-color3);
}

.jp-icon-accent4[fill] {
  fill: var(--jp-layout-color4);
}

.jp-icon-accent0[stroke] {
  stroke: var(--jp-layout-color0);
}

.jp-icon-accent1[stroke] {
  stroke: var(--jp-layout-color1);
}

.jp-icon-accent2[stroke] {
  stroke: var(--jp-layout-color2);
}

.jp-icon-accent3[stroke] {
  stroke: var(--jp-layout-color3);
}

.jp-icon-accent4[stroke] {
  stroke: var(--jp-layout-color4);
}

/* set the color of an icon to transparent */
.jp-icon-none[fill] {
  fill: none;
}

.jp-icon-none[stroke] {
  stroke: none;
}

/* brand icon colors. Same for light and dark */
.jp-icon-brand0[fill] {
  fill: var(--jp-brand-color0);
}

.jp-icon-brand1[fill] {
  fill: var(--jp-brand-color1);
}

.jp-icon-brand2[fill] {
  fill: var(--jp-brand-color2);
}

.jp-icon-brand3[fill] {
  fill: var(--jp-brand-color3);
}

.jp-icon-brand4[fill] {
  fill: var(--jp-brand-color4);
}

.jp-icon-brand0[stroke] {
  stroke: var(--jp-brand-color0);
}

.jp-icon-brand1[stroke] {
  stroke: var(--jp-brand-color1);
}

.jp-icon-brand2[stroke] {
  stroke: var(--jp-brand-color2);
}

.jp-icon-brand3[stroke] {
  stroke: var(--jp-brand-color3);
}

.jp-icon-brand4[stroke] {
  stroke: var(--jp-brand-color4);
}

/* warn icon colors. Same for light and dark */
.jp-icon-warn0[fill] {
  fill: var(--jp-warn-color0);
}

.jp-icon-warn1[fill] {
  fill: var(--jp-warn-color1);
}

.jp-icon-warn2[fill] {
  fill: var(--jp-warn-color2);
}

.jp-icon-warn3[fill] {
  fill: var(--jp-warn-color3);
}

.jp-icon-warn0[stroke] {
  stroke: var(--jp-warn-color0);
}

.jp-icon-warn1[stroke] {
  stroke: var(--jp-warn-color1);
}

.jp-icon-warn2[stroke] {
  stroke: var(--jp-warn-color2);
}

.jp-icon-warn3[stroke] {
  stroke: var(--jp-warn-color3);
}

/* icon colors that contrast well with each other and most backgrounds */
.jp-icon-contrast0[fill] {
  fill: var(--jp-icon-contrast-color0);
}

.jp-icon-contrast1[fill] {
  fill: var(--jp-icon-contrast-color1);
}

.jp-icon-contrast2[fill] {
  fill: var(--jp-icon-contrast-color2);
}

.jp-icon-contrast3[fill] {
  fill: var(--jp-icon-contrast-color3);
}

.jp-icon-contrast0[stroke] {
  stroke: var(--jp-icon-contrast-color0);
}

.jp-icon-contrast1[stroke] {
  stroke: var(--jp-icon-contrast-color1);
}

.jp-icon-contrast2[stroke] {
  stroke: var(--jp-icon-contrast-color2);
}

.jp-icon-contrast3[stroke] {
  stroke: var(--jp-icon-contrast-color3);
}

.jp-icon-dot[fill] {
  fill: var(--jp-warn-color0);
}

.jp-jupyter-icon-color[fill] {
  fill: var(--jp-jupyter-icon-color, var(--jp-warn-color0));
}

.jp-notebook-icon-color[fill] {
  fill: var(--jp-notebook-icon-color, var(--jp-warn-color0));
}

.jp-json-icon-color[fill] {
  fill: var(--jp-json-icon-color, var(--jp-warn-color1));
}

.jp-console-icon-color[fill] {
  fill: var(--jp-console-icon-color, white);
}

.jp-console-icon-background-color[fill] {
  fill: var(--jp-console-icon-background-color, var(--jp-brand-color1));
}

.jp-terminal-icon-color[fill] {
  fill: var(--jp-terminal-icon-color, var(--jp-layout-color2));
}

.jp-terminal-icon-background-color[fill] {
  fill: var(
    --jp-terminal-icon-background-color,
    var(--jp-inverse-layout-color2)
  );
}

.jp-text-editor-icon-color[fill] {
  fill: var(--jp-text-editor-icon-color, var(--jp-inverse-layout-color3));
}

.jp-inspector-icon-color[fill] {
  fill: var(--jp-inspector-icon-color, var(--jp-inverse-layout-color3));
}

/* CSS for icons in selected filebrowser listing items */
.jp-DirListing-item.jp-mod-selected .jp-icon-selectable[fill] {
  fill: #fff;
}

.jp-DirListing-item.jp-mod-selected .jp-icon-selectable-inverse[fill] {
  fill: var(--jp-brand-color1);
}

/* stylelint-disable selector-max-class, selector-max-compound-selectors */

/**
* TODO: come up with non css-hack solution for showing the busy icon on top
*  of the close icon
* CSS for complex behavior of close icon of tabs in the main area tabbar
*/
.lm-DockPanel-tabBar
  .lm-TabBar-tab.lm-mod-closable.jp-mod-dirty
  > .lm-TabBar-tabCloseIcon
  > :not(:hover)
  > .jp-icon3[fill] {
  fill: none;
}

.lm-DockPanel-tabBar
  .lm-TabBar-tab.lm-mod-closable.jp-mod-dirty
  > .lm-TabBar-tabCloseIcon
  > :not(:hover)
  > .jp-icon-busy[fill] {
  fill: var(--jp-inverse-layout-color3);
}

/* stylelint-enable selector-max-class, selector-max-compound-selectors */

/* CSS for icons in status bar */
#jp-main-statusbar .jp-mod-selected .jp-icon-selectable[fill] {
  fill: #fff;
}

#jp-main-statusbar .jp-mod-selected .jp-icon-selectable-inverse[fill] {
  fill: var(--jp-brand-color1);
}

/* special handling for splash icon CSS. While the theme CSS reloads during
   splash, the splash icon can loose theming. To prevent that, we set a
   default for its color variable */
:root {
  --jp-warn-color0: var(--md-orange-700);
}

/* not sure what to do with this one, used in filebrowser listing */
.jp-DragIcon {
  margin-right: 4px;
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/**
 * Support for alt colors for icons as inline SVG HTMLElements
 */

/* alt recolor the primary elements of an icon */
.jp-icon-alt .jp-icon0[fill] {
  fill: var(--jp-layout-color0);
}

.jp-icon-alt .jp-icon1[fill] {
  fill: var(--jp-layout-color1);
}

.jp-icon-alt .jp-icon2[fill] {
  fill: var(--jp-layout-color2);
}

.jp-icon-alt .jp-icon3[fill] {
  fill: var(--jp-layout-color3);
}

.jp-icon-alt .jp-icon4[fill] {
  fill: var(--jp-layout-color4);
}

.jp-icon-alt .jp-icon0[stroke] {
  stroke: var(--jp-layout-color0);
}

.jp-icon-alt .jp-icon1[stroke] {
  stroke: var(--jp-layout-color1);
}

.jp-icon-alt .jp-icon2[stroke] {
  stroke: var(--jp-layout-color2);
}

.jp-icon-alt .jp-icon3[stroke] {
  stroke: var(--jp-layout-color3);
}

.jp-icon-alt .jp-icon4[stroke] {
  stroke: var(--jp-layout-color4);
}

/* alt recolor the accent elements of an icon */
.jp-icon-alt .jp-icon-accent0[fill] {
  fill: var(--jp-inverse-layout-color0);
}

.jp-icon-alt .jp-icon-accent1[fill] {
  fill: var(--jp-inverse-layout-color1);
}

.jp-icon-alt .jp-icon-accent2[fill] {
  fill: var(--jp-inverse-layout-color2);
}

.jp-icon-alt .jp-icon-accent3[fill] {
  fill: var(--jp-inverse-layout-color3);
}

.jp-icon-alt .jp-icon-accent4[fill] {
  fill: var(--jp-inverse-layout-color4);
}

.jp-icon-alt .jp-icon-accent0[stroke] {
  stroke: var(--jp-inverse-layout-color0);
}

.jp-icon-alt .jp-icon-accent1[stroke] {
  stroke: var(--jp-inverse-layout-color1);
}

.jp-icon-alt .jp-icon-accent2[stroke] {
  stroke: var(--jp-inverse-layout-color2);
}

.jp-icon-alt .jp-icon-accent3[stroke] {
  stroke: var(--jp-inverse-layout-color3);
}

.jp-icon-alt .jp-icon-accent4[stroke] {
  stroke: var(--jp-inverse-layout-color4);
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

.jp-icon-hoverShow:not(:hover) .jp-icon-hoverShow-content {
  display: none !important;
}

/**
 * Support for hover colors for icons as inline SVG HTMLElements
 */

/**
 * regular colors
 */

/* recolor the primary elements of an icon */
.jp-icon-hover :hover .jp-icon0-hover[fill] {
  fill: var(--jp-inverse-layout-color0);
}

.jp-icon-hover :hover .jp-icon1-hover[fill] {
  fill: var(--jp-inverse-layout-color1);
}

.jp-icon-hover :hover .jp-icon2-hover[fill] {
  fill: var(--jp-inverse-layout-color2);
}

.jp-icon-hover :hover .jp-icon3-hover[fill] {
  fill: var(--jp-inverse-layout-color3);
}

.jp-icon-hover :hover .jp-icon4-hover[fill] {
  fill: var(--jp-inverse-layout-color4);
}

.jp-icon-hover :hover .jp-icon0-hover[stroke] {
  stroke: var(--jp-inverse-layout-color0);
}

.jp-icon-hover :hover .jp-icon1-hover[stroke] {
  stroke: var(--jp-inverse-layout-color1);
}

.jp-icon-hover :hover .jp-icon2-hover[stroke] {
  stroke: var(--jp-inverse-layout-color2);
}

.jp-icon-hover :hover .jp-icon3-hover[stroke] {
  stroke: var(--jp-inverse-layout-color3);
}

.jp-icon-hover :hover .jp-icon4-hover[stroke] {
  stroke: var(--jp-inverse-layout-color4);
}

/* recolor the accent elements of an icon */
.jp-icon-hover :hover .jp-icon-accent0-hover[fill] {
  fill: var(--jp-layout-color0);
}

.jp-icon-hover :hover .jp-icon-accent1-hover[fill] {
  fill: var(--jp-layout-color1);
}

.jp-icon-hover :hover .jp-icon-accent2-hover[fill] {
  fill: var(--jp-layout-color2);
}

.jp-icon-hover :hover .jp-icon-accent3-hover[fill] {
  fill: var(--jp-layout-color3);
}

.jp-icon-hover :hover .jp-icon-accent4-hover[fill] {
  fill: var(--jp-layout-color4);
}

.jp-icon-hover :hover .jp-icon-accent0-hover[stroke] {
  stroke: var(--jp-layout-color0);
}

.jp-icon-hover :hover .jp-icon-accent1-hover[stroke] {
  stroke: var(--jp-layout-color1);
}

.jp-icon-hover :hover .jp-icon-accent2-hover[stroke] {
  stroke: var(--jp-layout-color2);
}

.jp-icon-hover :hover .jp-icon-accent3-hover[stroke] {
  stroke: var(--jp-layout-color3);
}

.jp-icon-hover :hover .jp-icon-accent4-hover[stroke] {
  stroke: var(--jp-layout-color4);
}

/* set the color of an icon to transparent */
.jp-icon-hover :hover .jp-icon-none-hover[fill] {
  fill: none;
}

.jp-icon-hover :hover .jp-icon-none-hover[stroke] {
  stroke: none;
}

/**
 * inverse colors
 */

/* inverse recolor the primary elements of an icon */
.jp-icon-hover.jp-icon-alt :hover .jp-icon0-hover[fill] {
  fill: var(--jp-layout-color0);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon1-hover[fill] {
  fill: var(--jp-layout-color1);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon2-hover[fill] {
  fill: var(--jp-layout-color2);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon3-hover[fill] {
  fill: var(--jp-layout-color3);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon4-hover[fill] {
  fill: var(--jp-layout-color4);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon0-hover[stroke] {
  stroke: var(--jp-layout-color0);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon1-hover[stroke] {
  stroke: var(--jp-layout-color1);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon2-hover[stroke] {
  stroke: var(--jp-layout-color2);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon3-hover[stroke] {
  stroke: var(--jp-layout-color3);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon4-hover[stroke] {
  stroke: var(--jp-layout-color4);
}

/* inverse recolor the accent elements of an icon */
.jp-icon-hover.jp-icon-alt :hover .jp-icon-accent0-hover[fill] {
  fill: var(--jp-inverse-layout-color0);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon-accent1-hover[fill] {
  fill: var(--jp-inverse-layout-color1);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon-accent2-hover[fill] {
  fill: var(--jp-inverse-layout-color2);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon-accent3-hover[fill] {
  fill: var(--jp-inverse-layout-color3);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon-accent4-hover[fill] {
  fill: var(--jp-inverse-layout-color4);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon-accent0-hover[stroke] {
  stroke: var(--jp-inverse-layout-color0);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon-accent1-hover[stroke] {
  stroke: var(--jp-inverse-layout-color1);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon-accent2-hover[stroke] {
  stroke: var(--jp-inverse-layout-color2);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon-accent3-hover[stroke] {
  stroke: var(--jp-inverse-layout-color3);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon-accent4-hover[stroke] {
  stroke: var(--jp-inverse-layout-color4);
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

.jp-IFrame {
  width: 100%;
  height: 100%;
}

.jp-IFrame > iframe {
  border: none;
}

/*
When drag events occur, `lm-mod-override-cursor` is added to the body.
Because iframes steal all cursor events, the following two rules are necessary
to suppress pointer events while resize drags are occurring. There may be a
better solution to this problem.
*/
body.lm-mod-override-cursor .jp-IFrame {
  position: relative;
}

body.lm-mod-override-cursor .jp-IFrame::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: transparent;
}

/*-----------------------------------------------------------------------------
| Copyright (c) 2014-2016, Jupyter Development Team.
|
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

.jp-HoverBox {
  position: fixed;
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

.jp-FormGroup-content fieldset {
  border: none;
  padding: 0;
  min-width: 0;
  width: 100%;
}

/* stylelint-disable selector-max-type */

.jp-FormGroup-content fieldset .jp-inputFieldWrapper input,
.jp-FormGroup-content fieldset .jp-inputFieldWrapper select,
.jp-FormGroup-content fieldset .jp-inputFieldWrapper textarea {
  font-size: var(--jp-content-font-size2);
  border-color: var(--jp-input-border-color);
  border-style: solid;
  border-radius: var(--jp-border-radius);
  border-width: 1px;
  padding: 6px 8px;
  background: none;
  color: var(--jp-ui-font-color0);
  height: inherit;
}

.jp-FormGroup-content fieldset input[type='checkbox'] {
  position: relative;
  top: 2px;
  margin-left: 0;
}

.jp-FormGroup-content button.jp-mod-styled {
  cursor: pointer;
}

.jp-FormGroup-content .checkbox label {
  cursor: pointer;
  font-size: var(--jp-content-font-size1);
}

.jp-FormGroup-content .jp-root > fieldset > legend {
  display: none;
}

.jp-FormGroup-content .jp-root > fieldset > p {
  display: none;
}

/** copy of `input.jp-mod-styled:focus` style */
.jp-FormGroup-content fieldset input:focus,
.jp-FormGroup-content fieldset select:focus {
  -moz-outline-radius: unset;
  outline: var(--jp-border-width) solid var(--md-blue-500);
  outline-offset: -1px;
  box-shadow: inset 0 0 4px var(--md-blue-300);
}

.jp-FormGroup-content fieldset input:hover:not(:focus),
.jp-FormGroup-content fieldset select:hover:not(:focus) {
  background-color: var(--jp-border-color2);
}

/* stylelint-enable selector-max-type */

.jp-FormGroup-content .checkbox .field-description {
  /* Disable default description field for checkbox:
   because other widgets do not have description fields,
   we add descriptions to each widget on the field level.
  */
  display: none;
}

.jp-FormGroup-content #root__description {
  display: none;
}

.jp-FormGroup-content .jp-modifiedIndicator {
  width: 5px;
  background-color: var(--jp-brand-color2);
  margin-top: 0;
  margin-left: calc(var(--jp-private-settingeditor-modifier-indent) * -1);
  flex-shrink: 0;
}

.jp-FormGroup-content .jp-modifiedIndicator.jp-errorIndicator {
  background-color: var(--jp-error-color0);
  margin-right: 0.5em;
}

/* RJSF ARRAY style */

.jp-arrayFieldWrapper legend {
  font-size: var(--jp-content-font-size2);
  color: var(--jp-ui-font-color0);
  flex-basis: 100%;
  padding: 4px 0;
  font-weight: var(--jp-content-heading-font-weight);
  border-bottom: 1px solid var(--jp-border-color2);
}

.jp-arrayFieldWrapper .field-description {
  padding: 4px 0;
  white-space: pre-wrap;
}

.jp-arrayFieldWrapper .array-item {
  width: 100%;
  border: 1px solid var(--jp-border-color2);
  border-radius: 4px;
  margin: 4px;
}

.jp-ArrayOperations {
  display: flex;
  margin-left: 8px;
}

.jp-ArrayOperationsButton {
  margin: 2px;
}

.jp-ArrayOperationsButton .jp-icon3[fill] {
  fill: var(--jp-ui-font-color0);
}

button.jp-ArrayOperationsButton.jp-mod-styled:disabled {
  cursor: not-allowed;
  opacity: 0.5;
}

/* RJSF form validation error */

.jp-FormGroup-content .validationErrors {
  color: var(--jp-error-color0);
}

/* Hide panel level error as duplicated the field level error */
.jp-FormGroup-content .panel.errors {
  display: none;
}

/* RJSF normal content (settings-editor) */

.jp-FormGroup-contentNormal {
  display: flex;
  align-items: center;
  flex-wrap: wrap;
}

.jp-FormGroup-contentNormal .jp-FormGroup-contentItem {
  margin-left: 7px;
  color: var(--jp-ui-font-color0);
}

.jp-FormGroup-contentNormal .jp-FormGroup-description {
  flex-basis: 100%;
  padding: 4px 7px;
}

.jp-FormGroup-contentNormal .jp-FormGroup-default {
  flex-basis: 100%;
  padding: 4px 7px;
}

.jp-FormGroup-contentNormal .jp-FormGroup-fieldLabel {
  font-size: var(--jp-content-font-size1);
  font-weight: normal;
  min-width: 120px;
}

.jp-FormGroup-contentNormal fieldset:not(:first-child) {
  margin-left: 7px;
}

.jp-FormGroup-contentNormal .field-array-of-string .array-item {
  /* Display `jp-ArrayOperations` buttons side-by-side with content except
    for small screens where flex-wrap will place them one below the other.
  */
  display: flex;
  align-items: center;
  flex-wrap: wrap;
}

.jp-FormGroup-contentNormal .jp-objectFieldWrapper .form-group {
  padding: 2px 8px 2px var(--jp-private-settingeditor-modifier-indent);
  margin-top: 2px;
}

/* RJSF compact content (metadata-form) */

.jp-FormGroup-content.jp-FormGroup-contentCompact {
  width: 100%;
}

.jp-FormGroup-contentCompact .form-group {
  display: flex;
  padding: 0.5em 0.2em 0.5em 0;
}

.jp-FormGroup-contentCompact
  .jp-FormGroup-compactTitle
  .jp-FormGroup-description {
  font-size: var(--jp-ui-font-size1);
  color: var(--jp-ui-font-color2);
}

.jp-FormGroup-contentCompact .jp-FormGroup-fieldLabel {
  padding-bottom: 0.3em;
}

.jp-FormGroup-contentCompact .jp-inputFieldWrapper .form-control {
  width: 100%;
  box-sizing: border-box;
}

.jp-FormGroup-contentCompact .jp-arrayFieldWrapper .jp-FormGroup-compactTitle {
  padding-bottom: 7px;
}

.jp-FormGroup-contentCompact
  .jp-objectFieldWrapper
  .jp-objectFieldWrapper
  .form-group {
  padding: 2px 8px 2px var(--jp-private-settingeditor-modifier-indent);
  margin-top: 2px;
}

.jp-FormGroup-contentCompact ul.error-detail {
  margin-block-start: 0.5em;
  margin-block-end: 0.5em;
  padding-inline-start: 1em;
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

.jp-SidePanel {
  display: flex;
  flex-direction: column;
  min-width: var(--jp-sidebar-min-width);
  overflow-y: auto;
  color: var(--jp-ui-font-color1);
  background: var(--jp-layout-color1);
  font-size: var(--jp-ui-font-size1);
}

.jp-SidePanel-header {
  flex: 0 0 auto;
  display: flex;
  border-bottom: var(--jp-border-width) solid var(--jp-border-color2);
  font-size: var(--jp-ui-font-size0);
  font-weight: 600;
  letter-spacing: 1px;
  margin: 0;
  padding: 2px;
  text-transform: uppercase;
}

.jp-SidePanel-toolbar {
  flex: 0 0 auto;
}

.jp-SidePanel-content {
  flex: 1 1 auto;
}

.jp-SidePanel-toolbar,
.jp-AccordionPanel-toolbar {
  height: var(--jp-private-toolbar-height);
}

.jp-SidePanel-toolbar.jp-Toolbar-micro {
  display: none;
}

.lm-AccordionPanel .jp-AccordionPanel-title {
  box-sizing: border-box;
  line-height: 25px;
  margin: 0;
  display: flex;
  align-items: center;
  background: var(--jp-layout-color1);
  color: var(--jp-ui-font-color1);
  border-bottom: var(--jp-border-width) solid var(--jp-toolbar-border-color);
  box-shadow: var(--jp-toolbar-box-shadow);
  font-size: var(--jp-ui-font-size0);
}

.jp-AccordionPanel-title {
  cursor: pointer;
  user-select: none;
  -moz-user-select: none;
  -webkit-user-select: none;
  text-transform: uppercase;
}

.lm-AccordionPanel[data-orientation='horizontal'] > .jp-AccordionPanel-title {
  /* Title is rotated for horizontal accordion panel using CSS */
  display: block;
  transform-origin: top left;
  transform: rotate(-90deg) translate(-100%);
}

.jp-AccordionPanel-title .lm-AccordionPanel-titleLabel {
  user-select: none;
  text-overflow: ellipsis;
  white-space: nowrap;
  overflow: hidden;
}

.jp-AccordionPanel-title .lm-AccordionPanel-titleCollapser {
  transform: rotate(-90deg);
  margin: auto 0;
  height: 16px;
}

.jp-AccordionPanel-title.lm-mod-expanded .lm-AccordionPanel-titleCollapser {
  transform: rotate(0deg);
}

.lm-AccordionPanel .jp-AccordionPanel-toolbar {
  background: none;
  box-shadow: none;
  border: none;
  margin-left: auto;
}

.lm-AccordionPanel .lm-SplitPanel-handle:hover {
  background: var(--jp-layout-color3);
}

.jp-text-truncated {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/*-----------------------------------------------------------------------------
| Copyright (c) 2017, Jupyter Development Team.
|
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

.jp-Spinner {
  position: absolute;
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 10;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background: var(--jp-layout-color0);
  outline: none;
}

.jp-SpinnerContent {
  font-size: 10px;
  margin: 50px auto;
  text-indent: -9999em;
  width: 3em;
  height: 3em;
  border-radius: 50%;
  background: var(--jp-brand-color3);
  background: linear-gradient(
    to right,
    #f37626 10%,
    rgba(255, 255, 255, 0) 42%
  );
  position: relative;
  animation: load3 1s infinite linear, fadeIn 1s;
}

.jp-SpinnerContent::before {
  width: 50%;
  height: 50%;
  background: #f37626;
  border-radius: 100% 0 0;
  position: absolute;
  top: 0;
  left: 0;
  content: '';
}

.jp-SpinnerContent::after {
  background: var(--jp-layout-color0);
  width: 75%;
  height: 75%;
  border-radius: 50%;
  content: '';
  margin: auto;
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0;
  right: 0;
}

@keyframes fadeIn {
  0% {
    opacity: 0;
  }

  100% {
    opacity: 1;
  }
}

@keyframes load3 {
  0% {
    transform: rotate(0deg);
  }

  100% {
    transform: rotate(360deg);
  }
}

/*-----------------------------------------------------------------------------
| Copyright (c) 2014-2017, Jupyter Development Team.
|
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

button.jp-mod-styled {
  font-size: var(--jp-ui-font-size1);
  color: var(--jp-ui-font-color0);
  border: none;
  box-sizing: border-box;
  text-align: center;
  line-height: 32px;
  height: 32px;
  padding: 0 12px;
  letter-spacing: 0.8px;
  outline: none;
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
}

input.jp-mod-styled {
  background: var(--jp-input-background);
  height: 28px;
  box-sizing: border-box;
  border: var(--jp-border-width) solid var(--jp-border-color1);
  padding-left: 7px;
  padding-right: 7px;
  font-size: var(--jp-ui-font-size2);
  color: var(--jp-ui-font-color0);
  outline: none;
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
}

input[type='checkbox'].jp-mod-styled {
  appearance: checkbox;
  -webkit-appearance: checkbox;
  -moz-appearance: checkbox;
  height: auto;
}

input.jp-mod-styled:focus {
  border: var(--jp-border-width) solid var(--md-blue-500);
  box-shadow: inset 0 0 4px var(--md-blue-300);
}

.jp-select-wrapper {
  display: flex;
  position: relative;
  flex-direction: column;
  padding: 1px;
  background-color: var(--jp-layout-color1);
  box-sizing: border-box;
  margin-bottom: 12px;
}

.jp-select-wrapper:not(.multiple) {
  height: 28px;
}

.jp-select-wrapper.jp-mod-focused select.jp-mod-styled {
  border: var(--jp-border-width) solid var(--jp-input-active-border-color);
  box-shadow: var(--jp-input-box-shadow);
  background-color: var(--jp-input-active-background);
}

select.jp-mod-styled:hover {
  cursor: pointer;
  color: var(--jp-ui-font-color0);
  background-color: var(--jp-input-hover-background);
  box-shadow: inset 0 0 1px rgba(0, 0, 0, 0.5);
}

select.jp-mod-styled {
  flex: 1 1 auto;
  width: 100%;
  font-size: var(--jp-ui-font-size2);
  background: var(--jp-input-background);
  color: var(--jp-ui-font-color0);
  padding: 0 25px 0 8px;
  border: var(--jp-border-width) solid var(--jp-input-border-color);
  border-radius: 0;
  outline: none;
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
}

select.jp-mod-styled:not([multiple]) {
  height: 32px;
}

select.jp-mod-styled[multiple] {
  max-height: 200px;
  overflow-y: auto;
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

.jp-switch {
  display: flex;
  align-items: center;
  padding-left: 4px;
  padding-right: 4px;
  font-size: var(--jp-ui-font-size1);
  background-color: transparent;
  color: var(--jp-ui-font-color1);
  border: none;
  height: 20px;
}

.jp-switch:hover {
  background-color: var(--jp-layout-color2);
}

.jp-switch-label {
  margin-right: 5px;
  font-family: var(--jp-ui-font-family);
}

.jp-switch-track {
  cursor: pointer;
  background-color: var(--jp-switch-color, var(--jp-border-color1));
  -webkit-transition: 0.4s;
  transition: 0.4s;
  border-radius: 34px;
  height: 16px;
  width: 35px;
  position: relative;
}

.jp-switch-track::before {
  content: '';
  position: absolute;
  height: 10px;
  width: 10px;
  margin: 3px;
  left: 0;
  background-color: var(--jp-ui-inverse-font-color1);
  -webkit-transition: 0.4s;
  transition: 0.4s;
  border-radius: 50%;
}

.jp-switch[aria-checked='true'] .jp-switch-track {
  background-color: var(--jp-switch-true-position-color, var(--jp-warn-color0));
}

.jp-switch[aria-checked='true'] .jp-switch-track::before {
  /* track width (35) - margins (3 + 3) - thumb width (10) */
  left: 19px;
}

/*-----------------------------------------------------------------------------
| Copyright (c) 2014-2016, Jupyter Development Team.
|
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

:root {
  --jp-private-toolbar-height: calc(
    28px + var(--jp-border-width)
  ); /* leave 28px for content */
}

.jp-Toolbar {
  color: var(--jp-ui-font-color1);
  flex: 0 0 auto;
  display: flex;
  flex-direction: row;
  border-bottom: var(--jp-border-width) solid var(--jp-toolbar-border-color);
  box-shadow: var(--jp-toolbar-box-shadow);
  background: var(--jp-toolbar-background);
  min-height: var(--jp-toolbar-micro-height);
  padding: 2px;
  z-index: 8;
  overflow-x: hidden;
}

/* Toolbar items */

.jp-Toolbar > .jp-Toolbar-item.jp-Toolbar-spacer {
  flex-grow: 1;
  flex-shrink: 1;
}

.jp-Toolbar-item.jp-Toolbar-kernelStatus {
  display: inline-block;
  width: 32px;
  background-repeat: no-repeat;
  background-position: center;
  background-size: 16px;
}

.jp-Toolbar > .jp-Toolbar-item {
  flex: 0 0 auto;
  display: flex;
  padding-left: 1px;
  padding-right: 1px;
  font-size: var(--jp-ui-font-size1);
  line-height: var(--jp-private-toolbar-height);
  height: 100%;
}

/* Toolbar buttons */

/* This is the div we use to wrap the react component into a Widget */
div.jp-ToolbarButton {
  color: transparent;
  border: none;
  box-sizing: border-box;
  outline: none;
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  padding: 0;
  margin: 0;
}

button.jp-ToolbarButtonComponent {
  background: var(--jp-layout-color1);
  border: none;
  box-sizing: border-box;
  outline: none;
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  padding: 0 6px;
  margin: 0;
  height: 24px;
  border-radius: var(--jp-border-radius);
  display: flex;
  align-items: center;
  text-align: center;
  font-size: 14px;
  min-width: unset;
  min-height: unset;
}

button.jp-ToolbarButtonComponent:disabled {
  opacity: 0.4;
}

button.jp-ToolbarButtonComponent > span {
  padding: 0;
  flex: 0 0 auto;
}

button.jp-ToolbarButtonComponent .jp-ToolbarButtonComponent-label {
  font-size: var(--jp-ui-font-size1);
  line-height: 100%;
  padding-left: 2px;
  color: var(--jp-ui-font-color1);
  font-family: var(--jp-ui-font-family);
}

#jp-main-dock-panel[data-mode='single-document']
  .jp-MainAreaWidget
  > .jp-Toolbar.jp-Toolbar-micro {
  padding: 0;
  min-height: 0;
}

#jp-main-dock-panel[data-mode='single-document']
  .jp-MainAreaWidget
  > .jp-Toolbar {
  border: none;
  box-shadow: none;
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

.jp-WindowedPanel-outer {
  position: relative;
  overflow-y: auto;
}

.jp-WindowedPanel-inner {
  position: relative;
}

.jp-WindowedPanel-window {
  position: absolute;
  left: 0;
  right: 0;
  overflow: visible;
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/* Sibling imports */

body {
  color: var(--jp-ui-font-color1);
  font-size: var(--jp-ui-font-size1);
}

/* Disable native link decoration styles everywhere outside of dialog boxes */
a {
  text-decoration: unset;
  color: unset;
}

a:hover {
  text-decoration: unset;
  color: unset;
}

/* Accessibility for links inside dialog box text */
.jp-Dialog-content a {
  text-decoration: revert;
  color: var(--jp-content-link-color);
}

.jp-Dialog-content a:hover {
  text-decoration: revert;
}

/* Styles for ui-components */
.jp-Button {
  color: var(--jp-ui-font-color2);
  border-radius: var(--jp-border-radius);
  padding: 0 12px;
  font-size: var(--jp-ui-font-size1);

  /* Copy from blueprint 3 */
  display: inline-flex;
  flex-direction: row;
  border: none;
  cursor: pointer;
  align-items: center;
  justify-content: center;
  text-align: left;
  vertical-align: middle;
  min-height: 30px;
  min-width: 30px;
}

.jp-Button:disabled {
  cursor: not-allowed;
}

.jp-Button:empty {
  padding: 0 !important;
}

.jp-Button.jp-mod-small {
  min-height: 24px;
  min-width: 24px;
  font-size: 12px;
  padding: 0 7px;
}

/* Use our own theme for hover styles */
.jp-Button.jp-mod-minimal:hover {
  background-color: var(--jp-layout-color2);
}

.jp-Button.jp-mod-minimal {
  background: none;
}

.jp-InputGroup {
  display: block;
  position: relative;
}

.jp-InputGroup input {
  box-sizing: border-box;
  border: none;
  border-radius: 0;
  background-color: transparent;
  color: var(--jp-ui-font-color0);
  box-shadow: inset 0 0 0 var(--jp-border-width) var(--jp-input-border-color);
  padding-bottom: 0;
  padding-top: 0;
  padding-left: 10px;
  padding-right: 28px;
  position: relative;
  width: 100%;
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  font-size: 14px;
  font-weight: 400;
  height: 30px;
  line-height: 30px;
  outline: none;
  vertical-align: middle;
}

.jp-InputGroup input:focus {
  box-shadow: inset 0 0 0 var(--jp-border-width)
      var(--jp-input-active-box-shadow-color),
    inset 0 0 0 3px var(--jp-input-active-box-shadow-color);
}

.jp-InputGroup input:disabled {
  cursor: not-allowed;
  resize: block;
  background-color: var(--jp-layout-color2);
  color: var(--jp-ui-font-color2);
}

.jp-InputGroup input:disabled ~ span {
  cursor: not-allowed;
  color: var(--jp-ui-font-color2);
}

.jp-InputGroup input::placeholder,
input::placeholder {
  color: var(--jp-ui-font-color2);
}

.jp-InputGroupAction {
  position: absolute;
  bottom: 1px;
  right: 0;
  padding: 6px;
}

.jp-HTMLSelect.jp-DefaultStyle select {
  background-color: initial;
  border: none;
  border-radius: 0;
  box-shadow: none;
  color: var(--jp-ui-font-color0);
  display: block;
  font-size: var(--jp-ui-font-size1);
  font-family: var(--jp-ui-font-family);
  height: 24px;
  line-height: 14px;
  padding: 0 25px 0 10px;
  text-align: left;
  -moz-appearance: none;
  -webkit-appearance: none;
}

.jp-HTMLSelect.jp-DefaultStyle select:disabled {
  background-color: var(--jp-layout-color2);
  color: var(--jp-ui-font-color2);
  cursor: not-allowed;
  resize: block;
}

.jp-HTMLSelect.jp-DefaultStyle select:disabled ~ span {
  cursor: not-allowed;
}

/* Use our own theme for hover and option styles */
/* stylelint-disable-next-line selector-max-type */
.jp-HTMLSelect.jp-DefaultStyle select:hover,
.jp-HTMLSelect.jp-DefaultStyle select > option {
  background-color: var(--jp-layout-color2);
  color: var(--jp-ui-font-color0);
}

select {
  box-sizing: border-box;
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| Styles
|----------------------------------------------------------------------------*/

.jp-StatusBar-Widget {
  display: flex;
  align-items: center;
  background: var(--jp-layout-color2);
  min-height: var(--jp-statusbar-height);
  justify-content: space-between;
  padding: 0 10px;
}

.jp-StatusBar-Left {
  display: flex;
  align-items: center;
  flex-direction: row;
}

.jp-StatusBar-Middle {
  display: flex;
  align-items: center;
}

.jp-StatusBar-Right {
  display: flex;
  align-items: center;
  flex-direction: row-reverse;
}

.jp-StatusBar-Item {
  max-height: var(--jp-statusbar-height);
  margin: 0 2px;
  height: var(--jp-statusbar-height);
  white-space: nowrap;
  text-overflow: ellipsis;
  color: var(--jp-ui-font-color1);
  padding: 0 6px;
}

.jp-mod-highlighted:hover {
  background-color: var(--jp-layout-color3);
}

.jp-mod-clicked {
  background-color: var(--jp-brand-color1);
}

.jp-mod-clicked:hover {
  background-color: var(--jp-brand-color0);
}

.jp-mod-clicked .jp-StatusBar-TextItem {
  color: var(--jp-ui-inverse-font-color1);
}

.jp-StatusBar-HoverItem {
  box-shadow: '0px 4px 4px rgba(0, 0, 0, 0.25)';
}

.jp-StatusBar-TextItem {
  font-size: var(--jp-ui-font-size1);
  font-family: var(--jp-ui-font-family);
  line-height: 24px;
  color: var(--jp-ui-font-color1);
}

.jp-StatusBar-GroupItem {
  display: flex;
  align-items: center;
  flex-direction: row;
}

.jp-Statusbar-ProgressCircle svg {
  display: block;
  margin: 0 auto;
  width: 16px;
  height: 24px;
  align-self: normal;
}

.jp-Statusbar-ProgressCircle path {
  fill: var(--jp-inverse-layout-color3);
}

.jp-Statusbar-ProgressBar-progress-bar {
  height: 10px;
  width: 100px;
  border: solid 0.25px var(--jp-brand-color2);
  border-radius: 3px;
  overflow: hidden;
  align-self: center;
}

.jp-Statusbar-ProgressBar-progress-bar > div {
  background-color: var(--jp-brand-color2);
  background-image: linear-gradient(
    -45deg,
    rgba(255, 255, 255, 0.2) 25%,
    transparent 25%,
    transparent 50%,
    rgba(255, 255, 255, 0.2) 50%,
    rgba(255, 255, 255, 0.2) 75%,
    transparent 75%,
    transparent
  );
  background-size: 40px 40px;
  float: left;
  width: 0%;
  height: 100%;
  font-size: 12px;
  line-height: 14px;
  color: #fff;
  text-align: center;
  animation: jp-Statusbar-ExecutionTime-progress-bar 2s linear infinite;
}

.jp-Statusbar-ProgressBar-progress-bar p {
  color: var(--jp-ui-font-color1);
  font-family: var(--jp-ui-font-family);
  font-size: var(--jp-ui-font-size1);
  line-height: 10px;
  width: 100px;
}

@keyframes jp-Statusbar-ExecutionTime-progress-bar {
  0% {
    background-position: 0 0;
  }

  100% {
    background-position: 40px 40px;
  }
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| Variables
|----------------------------------------------------------------------------*/

:root {
  --jp-private-commandpalette-search-height: 28px;
}

/*-----------------------------------------------------------------------------
| Overall styles
|----------------------------------------------------------------------------*/

.lm-CommandPalette {
  padding-bottom: 0;
  color: var(--jp-ui-font-color1);
  background: var(--jp-layout-color1);

  /* This is needed so that all font sizing of children done in ems is
   * relative to this base size */
  font-size: var(--jp-ui-font-size1);
}

/*-----------------------------------------------------------------------------
| Modal variant
|----------------------------------------------------------------------------*/

.jp-ModalCommandPalette {
  position: absolute;
  z-index: 10000;
  top: 38px;
  left: 30%;
  margin: 0;
  padding: 4px;
  width: 40%;
  box-shadow: var(--jp-elevation-z4);
  border-radius: 4px;
  background: var(--jp-layout-color0);
}

.jp-ModalCommandPalette .lm-CommandPalette {
  max-height: 40vh;
}

.jp-ModalCommandPalette .lm-CommandPalette .lm-close-icon::after {
  display: none;
}

.jp-ModalCommandPalette .lm-CommandPalette .lm-CommandPalette-header {
  display: none;
}

.jp-ModalCommandPalette .lm-CommandPalette .lm-CommandPalette-item {
  margin-left: 4px;
  margin-right: 4px;
}

.jp-ModalCommandPalette
  .lm-CommandPalette
  .lm-CommandPalette-item.lm-mod-disabled {
  display: none;
}

/*-----------------------------------------------------------------------------
| Search
|----------------------------------------------------------------------------*/

.lm-CommandPalette-search {
  padding: 4px;
  background-color: var(--jp-layout-color1);
  z-index: 2;
}

.lm-CommandPalette-wrapper {
  overflow: overlay;
  padding: 0 9px;
  background-color: var(--jp-input-active-background);
  height: 30px;
  box-shadow: inset 0 0 0 var(--jp-border-width) var(--jp-input-border-color);
}

.lm-CommandPalette.lm-mod-focused .lm-CommandPalette-wrapper {
  box-shadow: inset 0 0 0 1px var(--jp-input-active-box-shadow-color),
    inset 0 0 0 3px var(--jp-input-active-box-shadow-color);
}

.jp-SearchIconGroup {
  color: white;
  background-color: var(--jp-brand-color1);
  position: absolute;
  top: 4px;
  right: 4px;
  padding: 5px 5px 1px;
}

.jp-SearchIconGroup svg {
  height: 20px;
  width: 20px;
}

.jp-SearchIconGroup .jp-icon3[fill] {
  fill: var(--jp-layout-color0);
}

.lm-CommandPalette-input {
  background: transparent;
  width: calc(100% - 18px);
  float: left;
  border: none;
  outline: none;
  font-size: var(--jp-ui-font-size1);
  color: var(--jp-ui-font-color0);
  line-height: var(--jp-private-commandpalette-search-height);
}

.lm-CommandPalette-input::-webkit-input-placeholder,
.lm-CommandPalette-input::-moz-placeholder,
.lm-CommandPalette-input:-ms-input-placeholder {
  color: var(--jp-ui-font-color2);
  font-size: var(--jp-ui-font-size1);
}

/*-----------------------------------------------------------------------------
| Results
|----------------------------------------------------------------------------*/

.lm-CommandPalette-header:first-child {
  margin-top: 0;
}

.lm-CommandPalette-header {
  border-bottom: solid var(--jp-border-width) var(--jp-border-color2);
  color: var(--jp-ui-font-color1);
  cursor: pointer;
  display: flex;
  font-size: var(--jp-ui-font-size0);
  font-weight: 600;
  letter-spacing: 1px;
  margin-top: 8px;
  padding: 8px 0 8px 12px;
  text-transform: uppercase;
}

.lm-CommandPalette-header.lm-mod-active {
  background: var(--jp-layout-color2);
}

.lm-CommandPalette-header > mark {
  background-color: transparent;
  font-weight: bold;
  color: var(--jp-ui-font-color1);
}

.lm-CommandPalette-item {
  padding: 4px 12px 4px 4px;
  color: var(--jp-ui-font-color1);
  font-size: var(--jp-ui-font-size1);
  font-weight: 400;
  display: flex;
}

.lm-CommandPalette-item.lm-mod-disabled {
  color: var(--jp-ui-font-color2);
}

.lm-CommandPalette-item.lm-mod-active {
  color: var(--jp-ui-inverse-font-color1);
  background: var(--jp-brand-color1);
}

.lm-CommandPalette-item.lm-mod-active .lm-CommandPalette-itemLabel > mark {
  color: var(--jp-ui-inverse-font-color0);
}

.lm-CommandPalette-item.lm-mod-active .jp-icon-selectable[fill] {
  fill: var(--jp-layout-color0);
}

.lm-CommandPalette-item.lm-mod-active:hover:not(.lm-mod-disabled) {
  color: var(--jp-ui-inverse-font-color1);
  background: var(--jp-brand-color1);
}

.lm-CommandPalette-item:hover:not(.lm-mod-active):not(.lm-mod-disabled) {
  background: var(--jp-layout-color2);
}

.lm-CommandPalette-itemContent {
  overflow: hidden;
}

.lm-CommandPalette-itemLabel > mark {
  color: var(--jp-ui-font-color0);
  background-color: transparent;
  font-weight: bold;
}

.lm-CommandPalette-item.lm-mod-disabled mark {
  color: var(--jp-ui-font-color2);
}

.lm-CommandPalette-item .lm-CommandPalette-itemIcon {
  margin: 0 4px 0 0;
  position: relative;
  width: 16px;
  top: 2px;
  flex: 0 0 auto;
}

.lm-CommandPalette-item.lm-mod-disabled .lm-CommandPalette-itemIcon {
  opacity: 0.6;
}

.lm-CommandPalette-item .lm-CommandPalette-itemShortcut {
  flex: 0 0 auto;
}

.lm-CommandPalette-itemCaption {
  display: none;
}

.lm-CommandPalette-content {
  background-color: var(--jp-layout-color1);
}

.lm-CommandPalette-content:empty::after {
  content: 'No results';
  margin: auto;
  margin-top: 20px;
  width: 100px;
  display: block;
  font-size: var(--jp-ui-font-size2);
  font-family: var(--jp-ui-font-family);
  font-weight: lighter;
}

.lm-CommandPalette-emptyMessage {
  text-align: center;
  margin-top: 24px;
  line-height: 1.32;
  padding: 0 8px;
  color: var(--jp-content-font-color3);
}

/*-----------------------------------------------------------------------------
| Copyright (c) 2014-2017, Jupyter Development Team.
|
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

.jp-Dialog {
  position: absolute;
  z-index: 10000;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  top: 0;
  left: 0;
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  background: var(--jp-dialog-background);
}

.jp-Dialog-content {
  display: flex;
  flex-direction: column;
  margin-left: auto;
  margin-right: auto;
  background: var(--jp-layout-color1);
  padding: 24px 24px 12px;
  min-width: 300px;
  min-height: 150px;
  max-width: 1000px;
  max-height: 500px;
  box-sizing: border-box;
  box-shadow: var(--jp-elevation-z20);
  word-wrap: break-word;
  border-radius: var(--jp-border-radius);

  /* This is needed so that all font sizing of children done in ems is
   * relative to this base size */
  font-size: var(--jp-ui-font-size1);
  color: var(--jp-ui-font-color1);
  resize: both;
}

.jp-Dialog-content.jp-Dialog-content-small {
  max-width: 500px;
}

.jp-Dialog-button {
  overflow: visible;
}

button.jp-Dialog-button:focus {
  outline: 1px solid var(--jp-brand-color1);
  outline-offset: 4px;
  -moz-outline-radius: 0;
}

button.jp-Dialog-button:focus::-moz-focus-inner {
  border: 0;
}

button.jp-Dialog-button.jp-mod-styled.jp-mod-accept:focus,
button.jp-Dialog-button.jp-mod-styled.jp-mod-warn:focus,
button.jp-Dialog-button.jp-mod-styled.jp-mod-reject:focus {
  outline-offset: 4px;
  -moz-outline-radius: 0;
}

button.jp-Dialog-button.jp-mod-styled.jp-mod-accept:focus {
  outline: 1px solid var(--jp-accept-color-normal, var(--jp-brand-color1));
}

button.jp-Dialog-button.jp-mod-styled.jp-mod-warn:focus {
  outline: 1px solid var(--jp-warn-color-normal, var(--jp-error-color1));
}

button.jp-Dialog-button.jp-mod-styled.jp-mod-reject:focus {
  outline: 1px solid var(--jp-reject-color-normal, var(--md-grey-600));
}

button.jp-Dialog-close-button {
  padding: 0;
  height: 100%;
  min-width: unset;
  min-height: unset;
}

.jp-Dialog-header {
  display: flex;
  justify-content: space-between;
  flex: 0 0 auto;
  padding-bottom: 12px;
  font-size: var(--jp-ui-font-size3);
  font-weight: 400;
  color: var(--jp-ui-font-color1);
}

.jp-Dialog-body {
  display: flex;
  flex-direction: column;
  flex: 1 1 auto;
  font-size: var(--jp-ui-font-size1);
  background: var(--jp-layout-color1);
  color: var(--jp-ui-font-color1);
  overflow: auto;
}

.jp-Dialog-footer {
  display: flex;
  flex-direction: row;
  justify-content: flex-end;
  align-items: center;
  flex: 0 0 auto;
  margin-left: -12px;
  margin-right: -12px;
  padding: 12px;
}

.jp-Dialog-checkbox {
  padding-right: 5px;
}

.jp-Dialog-checkbox > input:focus-visible {
  outline: 1px solid var(--jp-input-active-border-color);
  outline-offset: 1px;
}

.jp-Dialog-spacer {
  flex: 1 1 auto;
}

.jp-Dialog-title {
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
}

.jp-Dialog-body > .jp-select-wrapper {
  width: 100%;
}

.jp-Dialog-body > button {
  padding: 0 16px;
}

.jp-Dialog-body > label {
  line-height: 1.4;
  color: var(--jp-ui-font-color0);
}

.jp-Dialog-button.jp-mod-styled:not(:last-child) {
  margin-right: 12px;
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

.jp-Input-Boolean-Dialog {
  flex-direction: row-reverse;
  align-items: end;
  width: 100%;
}

.jp-Input-Boolean-Dialog > label {
  flex: 1 1 auto;
}

/*-----------------------------------------------------------------------------
| Copyright (c) 2014-2016, Jupyter Development Team.
|
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

.jp-MainAreaWidget > :focus {
  outline: none;
}

.jp-MainAreaWidget .jp-MainAreaWidget-error {
  padding: 6px;
}

.jp-MainAreaWidget .jp-MainAreaWidget-error > pre {
  width: auto;
  padding: 10px;
  background: var(--jp-error-color3);
  border: var(--jp-border-width) solid var(--jp-error-color1);
  border-radius: var(--jp-border-radius);
  color: var(--jp-ui-font-color1);
  font-size: var(--jp-ui-font-size1);
  white-space: pre-wrap;
  word-wrap: break-word;
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

/**
 * google-material-color v1.2.6
 * https://github.com/danlevan/google-material-color
 */
:root {
  --md-red-50: #ffebee;
  --md-red-100: #ffcdd2;
  --md-red-200: #ef9a9a;
  --md-red-300: #e57373;
  --md-red-400: #ef5350;
  --md-red-500: #f44336;
  --md-red-600: #e53935;
  --md-red-700: #d32f2f;
  --md-red-800: #c62828;
  --md-red-900: #b71c1c;
  --md-red-A100: #ff8a80;
  --md-red-A200: #ff5252;
  --md-red-A400: #ff1744;
  --md-red-A700: #d50000;
  --md-pink-50: #fce4ec;
  --md-pink-100: #f8bbd0;
  --md-pink-200: #f48fb1;
  --md-pink-300: #f06292;
  --md-pink-400: #ec407a;
  --md-pink-500: #e91e63;
  --md-pink-600: #d81b60;
  --md-pink-700: #c2185b;
  --md-pink-800: #ad1457;
  --md-pink-900: #880e4f;
  --md-pink-A100: #ff80ab;
  --md-pink-A200: #ff4081;
  --md-pink-A400: #f50057;
  --md-pink-A700: #c51162;
  --md-purple-50: #f3e5f5;
  --md-purple-100: #e1bee7;
  --md-purple-200: #ce93d8;
  --md-purple-300: #ba68c8;
  --md-purple-400: #ab47bc;
  --md-purple-500: #9c27b0;
  --md-purple-600: #8e24aa;
  --md-purple-700: #7b1fa2;
  --md-purple-800: #6a1b9a;
  --md-purple-900: #4a148c;
  --md-purple-A100: #ea80fc;
  --md-purple-A200: #e040fb;
  --md-purple-A400: #d500f9;
  --md-purple-A700: #a0f;
  --md-deep-purple-50: #ede7f6;
  --md-deep-purple-100: #d1c4e9;
  --md-deep-purple-200: #b39ddb;
  --md-deep-purple-300: #9575cd;
  --md-deep-purple-400: #7e57c2;
  --md-deep-purple-500: #673ab7;
  --md-deep-purple-600: #5e35b1;
  --md-deep-purple-700: #512da8;
  --md-deep-purple-800: #4527a0;
  --md-deep-purple-900: #311b92;
  --md-deep-purple-A100: #b388ff;
  --md-deep-purple-A200: #7c4dff;
  --md-deep-purple-A400: #651fff;
  --md-deep-purple-A700: #6200ea;
  --md-indigo-50: #e8eaf6;
  --md-indigo-100: #c5cae9;
  --md-indigo-200: #9fa8da;
  --md-indigo-300: #7986cb;
  --md-indigo-400: #5c6bc0;
  --md-indigo-500: #3f51b5;
  --md-indigo-600: #3949ab;
  --md-indigo-700: #303f9f;
  --md-indigo-800: #283593;
  --md-indigo-900: #1a237e;
  --md-indigo-A100: #8c9eff;
  --md-indigo-A200: #536dfe;
  --md-indigo-A400: #3d5afe;
  --md-indigo-A700: #304ffe;
  --md-blue-50: #e3f2fd;
  --md-blue-100: #bbdefb;
  --md-blue-200: #90caf9;
  --md-blue-300: #64b5f6;
  --md-blue-400: #42a5f5;
  --md-blue-500: #2196f3;
  --md-blue-600: #1e88e5;
  --md-blue-700: #1976d2;
  --md-blue-800: #1565c0;
  --md-blue-900: #0d47a1;
  --md-blue-A100: #82b1ff;
  --md-blue-A200: #448aff;
  --md-blue-A400: #2979ff;
  --md-blue-A700: #2962ff;
  --md-light-blue-50: #e1f5fe;
  --md-light-blue-100: #b3e5fc;
  --md-light-blue-200: #81d4fa;
  --md-light-blue-300: #4fc3f7;
  --md-light-blue-400: #29b6f6;
  --md-light-blue-500: #03a9f4;
  --md-light-blue-600: #039be5;
  --md-light-blue-700: #0288d1;
  --md-light-blue-800: #0277bd;
  --md-light-blue-900: #01579b;
  --md-light-blue-A100: #80d8ff;
  --md-light-blue-A200: #40c4ff;
  --md-light-blue-A400: #00b0ff;
  --md-light-blue-A700: #0091ea;
  --md-cyan-50: #e0f7fa;
  --md-cyan-100: #b2ebf2;
  --md-cyan-200: #80deea;
  --md-cyan-300: #4dd0e1;
  --md-cyan-400: #26c6da;
  --md-cyan-500: #00bcd4;
  --md-cyan-600: #00acc1;
  --md-cyan-700: #0097a7;
  --md-cyan-800: #00838f;
  --md-cyan-900: #006064;
  --md-cyan-A100: #84ffff;
  --md-cyan-A200: #18ffff;
  --md-cyan-A400: #00e5ff;
  --md-cyan-A700: #00b8d4;
  --md-teal-50: #e0f2f1;
  --md-teal-100: #b2dfdb;
  --md-teal-200: #80cbc4;
  --md-teal-300: #4db6ac;
  --md-teal-400: #26a69a;
  --md-teal-500: #009688;
  --md-teal-600: #00897b;
  --md-teal-700: #00796b;
  --md-teal-800: #00695c;
  --md-teal-900: #004d40;
  --md-teal-A100: #a7ffeb;
  --md-teal-A200: #64ffda;
  --md-teal-A400: #1de9b6;
  --md-teal-A700: #00bfa5;
  --md-green-50: #e8f5e9;
  --md-green-100: #c8e6c9;
  --md-green-200: #a5d6a7;
  --md-green-300: #81c784;
  --md-green-400: #66bb6a;
  --md-green-500: #4caf50;
  --md-green-600: #43a047;
  --md-green-700: #388e3c;
  --md-green-800: #2e7d32;
  --md-green-900: #1b5e20;
  --md-green-A100: #b9f6ca;
  --md-green-A200: #69f0ae;
  --md-green-A400: #00e676;
  --md-green-A700: #00c853;
  --md-light-green-50: #f1f8e9;
  --md-light-green-100: #dcedc8;
  --md-light-green-200: #c5e1a5;
  --md-light-green-300: #aed581;
  --md-light-green-400: #9ccc65;
  --md-light-green-500: #8bc34a;
  --md-light-green-600: #7cb342;
  --md-light-green-700: #689f38;
  --md-light-green-800: #558b2f;
  --md-light-green-900: #33691e;
  --md-light-green-A100: #ccff90;
  --md-light-green-A200: #b2ff59;
  --md-light-green-A400: #76ff03;
  --md-light-green-A700: #64dd17;
  --md-lime-50: #f9fbe7;
  --md-lime-100: #f0f4c3;
  --md-lime-200: #e6ee9c;
  --md-lime-300: #dce775;
  --md-lime-400: #d4e157;
  --md-lime-500: #cddc39;
  --md-lime-600: #c0ca33;
  --md-lime-700: #afb42b;
  --md-lime-800: #9e9d24;
  --md-lime-900: #827717;
  --md-lime-A100: #f4ff81;
  --md-lime-A200: #eeff41;
  --md-lime-A400: #c6ff00;
  --md-lime-A700: #aeea00;
  --md-yellow-50: #fffde7;
  --md-yellow-100: #fff9c4;
  --md-yellow-200: #fff59d;
  --md-yellow-300: #fff176;
  --md-yellow-400: #ffee58;
  --md-yellow-500: #ffeb3b;
  --md-yellow-600: #fdd835;
  --md-yellow-700: #fbc02d;
  --md-yellow-800: #f9a825;
  --md-yellow-900: #f57f17;
  --md-yellow-A100: #ffff8d;
  --md-yellow-A200: #ff0;
  --md-yellow-A400: #ffea00;
  --md-yellow-A700: #ffd600;
  --md-amber-50: #fff8e1;
  --md-amber-100: #ffecb3;
  --md-amber-200: #ffe082;
  --md-amber-300: #ffd54f;
  --md-amber-400: #ffca28;
  --md-amber-500: #ffc107;
  --md-amber-600: #ffb300;
  --md-amber-700: #ffa000;
  --md-amber-800: #ff8f00;
  --md-amber-900: #ff6f00;
  --md-amber-A100: #ffe57f;
  --md-amber-A200: #ffd740;
  --md-amber-A400: #ffc400;
  --md-amber-A700: #ffab00;
  --md-orange-50: #fff3e0;
  --md-orange-100: #ffe0b2;
  --md-orange-200: #ffcc80;
  --md-orange-300: #ffb74d;
  --md-orange-400: #ffa726;
  --md-orange-500: #ff9800;
  --md-orange-600: #fb8c00;
  --md-orange-700: #f57c00;
  --md-orange-800: #ef6c00;
  --md-orange-900: #e65100;
  --md-orange-A100: #ffd180;
  --md-orange-A200: #ffab40;
  --md-orange-A400: #ff9100;
  --md-orange-A700: #ff6d00;
  --md-deep-orange-50: #fbe9e7;
  --md-deep-orange-100: #ffccbc;
  --md-deep-orange-200: #ffab91;
  --md-deep-orange-300: #ff8a65;
  --md-deep-orange-400: #ff7043;
  --md-deep-orange-500: #ff5722;
  --md-deep-orange-600: #f4511e;
  --md-deep-orange-700: #e64a19;
  --md-deep-orange-800: #d84315;
  --md-deep-orange-900: #bf360c;
  --md-deep-orange-A100: #ff9e80;
  --md-deep-orange-A200: #ff6e40;
  --md-deep-orange-A400: #ff3d00;
  --md-deep-orange-A700: #dd2c00;
  --md-brown-50: #efebe9;
  --md-brown-100: #d7ccc8;
  --md-brown-200: #bcaaa4;
  --md-brown-300: #a1887f;
  --md-brown-400: #8d6e63;
  --md-brown-500: #795548;
  --md-brown-600: #6d4c41;
  --md-brown-700: #5d4037;
  --md-brown-800: #4e342e;
  --md-brown-900: #3e2723;
  --md-grey-50: #fafafa;
  --md-grey-100: #f5f5f5;
  --md-grey-200: #eee;
  --md-grey-300: #e0e0e0;
  --md-grey-400: #bdbdbd;
  --md-grey-500: #9e9e9e;
  --md-grey-600: #757575;
  --md-grey-700: #616161;
  --md-grey-800: #424242;
  --md-grey-900: #212121;
  --md-blue-grey-50: #eceff1;
  --md-blue-grey-100: #cfd8dc;
  --md-blue-grey-200: #b0bec5;
  --md-blue-grey-300: #90a4ae;
  --md-blue-grey-400: #78909c;
  --md-blue-grey-500: #607d8b;
  --md-blue-grey-600: #546e7a;
  --md-blue-grey-700: #455a64;
  --md-blue-grey-800: #37474f;
  --md-blue-grey-900: #263238;
}

/*-----------------------------------------------------------------------------
| Copyright (c) 2014-2017, Jupyter Development Team.
|
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| RenderedText
|----------------------------------------------------------------------------*/

:root {
  /* This is the padding value to fill the gaps between lines containing spans with background color. */
  --jp-private-code-span-padding: calc(
    (var(--jp-code-line-height) - 1) * var(--jp-code-font-size) / 2
  );
}

.jp-RenderedText {
  text-align: left;
  padding-left: var(--jp-code-padding);
  line-height: var(--jp-code-line-height);
  font-family: var(--jp-code-font-family);
}

.jp-RenderedText pre,
.jp-RenderedJavaScript pre,
.jp-RenderedHTMLCommon pre {
  color: var(--jp-content-font-color1);
  font-size: var(--jp-code-font-size);
  border: none;
  margin: 0;
  padding: 0;
}

.jp-RenderedText pre a:link {
  text-decoration: none;
  color: var(--jp-content-link-color);
}

.jp-RenderedText pre a:hover {
  text-decoration: underline;
  color: var(--jp-content-link-color);
}

.jp-RenderedText pre a:visited {
  text-decoration: none;
  color: var(--jp-content-link-color);
}

/* console foregrounds and backgrounds */
.jp-RenderedText pre .ansi-black-fg {
  color: #3e424d;
}

.jp-RenderedText pre .ansi-red-fg {
  color: #e75c58;
}

.jp-RenderedText pre .ansi-green-fg {
  color: #00a250;
}

.jp-RenderedText pre .ansi-yellow-fg {
  color: #ddb62b;
}

.jp-RenderedText pre .ansi-blue-fg {
  color: #208ffb;
}

.jp-RenderedText pre .ansi-magenta-fg {
  color: #d160c4;
}

.jp-RenderedText pre .ansi-cyan-fg {
  color: #60c6c8;
}

.jp-RenderedText pre .ansi-white-fg {
  color: #c5c1b4;
}

.jp-RenderedText pre .ansi-black-bg {
  background-color: #3e424d;
  padding: var(--jp-private-code-span-padding) 0;
}

.jp-RenderedText pre .ansi-red-bg {
  background-color: #e75c58;
  padding: var(--jp-private-code-span-padding) 0;
}

.jp-RenderedText pre .ansi-green-bg {
  background-color: #00a250;
  padding: var(--jp-private-code-span-padding) 0;
}

.jp-RenderedText pre .ansi-yellow-bg {
  background-color: #ddb62b;
  padding: var(--jp-private-code-span-padding) 0;
}

.jp-RenderedText pre .ansi-blue-bg {
  background-color: #208ffb;
  padding: var(--jp-private-code-span-padding) 0;
}

.jp-RenderedText pre .ansi-magenta-bg {
  background-color: #d160c4;
  padding: var(--jp-private-code-span-padding) 0;
}

.jp-RenderedText pre .ansi-cyan-bg {
  background-color: #60c6c8;
  padding: var(--jp-private-code-span-padding) 0;
}

.jp-RenderedText pre .ansi-white-bg {
  background-color: #c5c1b4;
  padding: var(--jp-private-code-span-padding) 0;
}

.jp-RenderedText pre .ansi-black-intense-fg {
  color: #282c36;
}

.jp-RenderedText pre .ansi-red-intense-fg {
  color: #b22b31;
}

.jp-RenderedText pre .ansi-green-intense-fg {
  color: #007427;
}

.jp-RenderedText pre .ansi-yellow-intense-fg {
  color: #b27d12;
}

.jp-RenderedText pre .ansi-blue-intense-fg {
  color: #0065ca;
}

.jp-RenderedText pre .ansi-magenta-intense-fg {
  color: #a03196;
}

.jp-RenderedText pre .ansi-cyan-intense-fg {
  color: #258f8f;
}

.jp-RenderedText pre .ansi-white-intense-fg {
  color: #a1a6b2;
}

.jp-RenderedText pre .ansi-black-intense-bg {
  background-color: #282c36;
  padding: var(--jp-private-code-span-padding) 0;
}

.jp-RenderedText pre .ansi-red-intense-bg {
  background-color: #b22b31;
  padding: var(--jp-private-code-span-padding) 0;
}

.jp-RenderedText pre .ansi-green-intense-bg {
  background-color: #007427;
  padding: var(--jp-private-code-span-padding) 0;
}

.jp-RenderedText pre .ansi-yellow-intense-bg {
  background-color: #b27d12;
  padding: var(--jp-private-code-span-padding) 0;
}

.jp-RenderedText pre .ansi-blue-intense-bg {
  background-color: #0065ca;
  padding: var(--jp-private-code-span-padding) 0;
}

.jp-RenderedText pre .ansi-magenta-intense-bg {
  background-color: #a03196;
  padding: var(--jp-private-code-span-padding) 0;
}

.jp-RenderedText pre .ansi-cyan-intense-bg {
  background-color: #258f8f;
  padding: var(--jp-private-code-span-padding) 0;
}

.jp-RenderedText pre .ansi-white-intense-bg {
  background-color: #a1a6b2;
  padding: var(--jp-private-code-span-padding) 0;
}

.jp-RenderedText pre .ansi-default-inverse-fg {
  color: var(--jp-ui-inverse-font-color0);
}

.jp-RenderedText pre .ansi-default-inverse-bg {
  background-color: var(--jp-inverse-layout-color0);
  padding: var(--jp-private-code-span-padding) 0;
}

.jp-RenderedText pre .ansi-bold {
  font-weight: bold;
}

.jp-RenderedText pre .ansi-underline {
  text-decoration: underline;
}

.jp-RenderedText[data-mime-type='application/vnd.jupyter.stderr'] {
  background: var(--jp-rendermime-error-background);
  padding-top: var(--jp-code-padding);
}

/*-----------------------------------------------------------------------------
| RenderedLatex
|----------------------------------------------------------------------------*/

.jp-RenderedLatex {
  color: var(--jp-content-font-color1);
  font-size: var(--jp-content-font-size1);
  line-height: var(--jp-content-line-height);
}

/* Left-justify outputs.*/
.jp-OutputArea-output.jp-RenderedLatex {
  padding: var(--jp-code-padding);
  text-align: left;
}

/*-----------------------------------------------------------------------------
| RenderedHTML
|----------------------------------------------------------------------------*/

.jp-RenderedHTMLCommon {
  color: var(--jp-content-font-color1);
  font-family: var(--jp-content-font-family);
  font-size: var(--jp-content-font-size1);
  line-height: var(--jp-content-line-height);

  /* Give a bit more R padding on Markdown text to keep line lengths reasonable */
  padding-right: 20px;
}

.jp-RenderedHTMLCommon em {
  font-style: italic;
}

.jp-RenderedHTMLCommon strong {
  font-weight: bold;
}

.jp-RenderedHTMLCommon u {
  text-decoration: underline;
}

.jp-RenderedHTMLCommon a:link {
  text-decoration: none;
  color: var(--jp-content-link-color);
}

.jp-RenderedHTMLCommon a:hover {
  text-decoration: underline;
  color: var(--jp-content-link-color);
}

.jp-RenderedHTMLCommon a:visited {
  text-decoration: none;
  color: var(--jp-content-link-color);
}

/* Headings */

.jp-RenderedHTMLCommon h1,
.jp-RenderedHTMLCommon h2,
.jp-RenderedHTMLCommon h3,
.jp-RenderedHTMLCommon h4,
.jp-RenderedHTMLCommon h5,
.jp-RenderedHTMLCommon h6 {
  line-height: var(--jp-content-heading-line-height);
  font-weight: var(--jp-content-heading-font-weight);
  font-style: normal;
  margin: var(--jp-content-heading-margin-top) 0
    var(--jp-content-heading-margin-bottom) 0;
}

.jp-RenderedHTMLCommon h1:first-child,
.jp-RenderedHTMLCommon h2:first-child,
.jp-RenderedHTMLCommon h3:first-child,
.jp-RenderedHTMLCommon h4:first-child,
.jp-RenderedHTMLCommon h5:first-child,
.jp-RenderedHTMLCommon h6:first-child {
  margin-top: calc(0.5 * var(--jp-content-heading-margin-top));
}

.jp-RenderedHTMLCommon h1:last-child,
.jp-RenderedHTMLCommon h2:last-child,
.jp-RenderedHTMLCommon h3:last-child,
.jp-RenderedHTMLCommon h4:last-child,
.jp-RenderedHTMLCommon h5:last-child,
.jp-RenderedHTMLCommon h6:last-child {
  margin-bottom: calc(0.5 * var(--jp-content-heading-margin-bottom));
}

.jp-RenderedHTMLCommon h1 {
  font-size: var(--jp-content-font-size5);
}

.jp-RenderedHTMLCommon h2 {
  font-size: var(--jp-content-font-size4);
}

.jp-RenderedHTMLCommon h3 {
  font-size: var(--jp-content-font-size3);
}

.jp-RenderedHTMLCommon h4 {
  font-size: var(--jp-content-font-size2);
}

.jp-RenderedHTMLCommon h5 {
  font-size: var(--jp-content-font-size1);
}

.jp-RenderedHTMLCommon h6 {
  font-size: var(--jp-content-font-size0);
}

/* Lists */

/* stylelint-disable selector-max-type, selector-max-compound-selectors */

.jp-RenderedHTMLCommon ul:not(.list-inline),
.jp-RenderedHTMLCommon ol:not(.list-inline) {
  padding-left: 2em;
}

.jp-RenderedHTMLCommon ul {
  list-style: disc;
}

.jp-RenderedHTMLCommon ul ul {
  list-style: square;
}

.jp-RenderedHTMLCommon ul ul ul {
  list-style: circle;
}

.jp-RenderedHTMLCommon ol {
  list-style: decimal;
}

.jp-RenderedHTMLCommon ol ol {
  list-style: upper-alpha;
}

.jp-RenderedHTMLCommon ol ol ol {
  list-style: lower-alpha;
}

.jp-RenderedHTMLCommon ol ol ol ol {
  list-style: lower-roman;
}

.jp-RenderedHTMLCommon ol ol ol ol ol {
  list-style: decimal;
}

.jp-RenderedHTMLCommon ol,
.jp-RenderedHTMLCommon ul {
  margin-bottom: 1em;
}

.jp-RenderedHTMLCommon ul ul,
.jp-RenderedHTMLCommon ul ol,
.jp-RenderedHTMLCommon ol ul,
.jp-RenderedHTMLCommon ol ol {
  margin-bottom: 0;
}

/* stylelint-enable selector-max-type, selector-max-compound-selectors */

.jp-RenderedHTMLCommon hr {
  color: var(--jp-border-color2);
  background-color: var(--jp-border-color1);
  margin-top: 1em;
  margin-bottom: 1em;
}

.jp-RenderedHTMLCommon > pre {
  margin: 1.5em 2em;
}

.jp-RenderedHTMLCommon pre,
.jp-RenderedHTMLCommon code {
  border: 0;
  background-color: var(--jp-layout-color0);
  color: var(--jp-content-font-color1);
  font-family: var(--jp-code-font-family);
  font-size: inherit;
  line-height: var(--jp-code-line-height);
  padding: 0;
  white-space: pre-wrap;
}

.jp-RenderedHTMLCommon :not(pre) > code {
  background-color: var(--jp-layout-color2);
  padding: 1px 5px;
}

/* Tables */

.jp-RenderedHTMLCommon table {
  border-collapse: collapse;
  border-spacing: 0;
  border: none;
  color: var(--jp-ui-font-color1);
  font-size: var(--jp-ui-font-size1);
  table-layout: fixed;
  margin-left: auto;
  margin-bottom: 1em;
  margin-right: auto;
}

.jp-RenderedHTMLCommon thead {
  border-bottom: var(--jp-border-width) solid var(--jp-border-color1);
  vertical-align: bottom;
}

.jp-RenderedHTMLCommon td,
.jp-RenderedHTMLCommon th,
.jp-RenderedHTMLCommon tr {
  vertical-align: middle;
  padding: 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}

.jp-RenderedMarkdown.jp-RenderedHTMLCommon td,
.jp-RenderedMarkdown.jp-RenderedHTMLCommon th {
  max-width: none;
}

:not(.jp-RenderedMarkdown).jp-RenderedHTMLCommon td,
:not(.jp-RenderedMarkdown).jp-RenderedHTMLCommon th,
:not(.jp-RenderedMarkdown).jp-RenderedHTMLCommon tr {
  text-align: right;
}

.jp-RenderedHTMLCommon th {
  font-weight: bold;
}

.jp-RenderedHTMLCommon tbody tr:nth-child(odd) {
  background: var(--jp-layout-color0);
}

.jp-RenderedHTMLCommon tbody tr:nth-child(even) {
  background: var(--jp-rendermime-table-row-background);
}

.jp-RenderedHTMLCommon tbody tr:hover {
  background: var(--jp-rendermime-table-row-hover-background);
}

.jp-RenderedHTMLCommon p {
  text-align: left;
  margin: 0;
  margin-bottom: 1em;
}

.jp-RenderedHTMLCommon img {
  -moz-force-broken-image-icon: 1;
}

/* Restrict to direct children as other images could be nested in other content. */
.jp-RenderedHTMLCommon > img {
  display: block;
  margin-left: 0;
  margin-right: 0;
  margin-bottom: 1em;
}

/* Change color behind transparent images if they need it... */
[data-jp-theme-light='false'] .jp-RenderedImage img.jp-needs-light-background {
  background-color: var(--jp-inverse-layout-color1);
}

[data-jp-theme-light='true'] .jp-RenderedImage img.jp-needs-dark-background {
  background-color: var(--jp-inverse-layout-color1);
}

.jp-RenderedHTMLCommon img,
.jp-RenderedImage img,
.jp-RenderedHTMLCommon svg,
.jp-RenderedSVG svg {
  max-width: 100%;
  height: auto;
}

.jp-RenderedHTMLCommon img.jp-mod-unconfined,
.jp-RenderedImage img.jp-mod-unconfined,
.jp-RenderedHTMLCommon svg.jp-mod-unconfined,
.jp-RenderedSVG svg.jp-mod-unconfined {
  max-width: none;
}

.jp-RenderedHTMLCommon .alert {
  padding: var(--jp-notebook-padding);
  border: var(--jp-border-width) solid transparent;
  border-radius: var(--jp-border-radius);
  margin-bottom: 1em;
}

.jp-RenderedHTMLCommon .alert-info {
  color: var(--jp-info-color0);
  background-color: var(--jp-info-color3);
  border-color: var(--jp-info-color2);
}

.jp-RenderedHTMLCommon .alert-info hr {
  border-color: var(--jp-info-color3);
}

.jp-RenderedHTMLCommon .alert-info > p:last-child,
.jp-RenderedHTMLCommon .alert-info > ul:last-child {
  margin-bottom: 0;
}

.jp-RenderedHTMLCommon .alert-warning {
  color: var(--jp-warn-color0);
  background-color: var(--jp-warn-color3);
  border-color: var(--jp-warn-color2);
}

.jp-RenderedHTMLCommon .alert-warning hr {
  border-color: var(--jp-warn-color3);
}

.jp-RenderedHTMLCommon .alert-warning > p:last-child,
.jp-RenderedHTMLCommon .alert-warning > ul:last-child {
  margin-bottom: 0;
}

.jp-RenderedHTMLCommon .alert-success {
  color: var(--jp-success-color0);
  background-color: var(--jp-success-color3);
  border-color: var(--jp-success-color2);
}

.jp-RenderedHTMLCommon .alert-success hr {
  border-color: var(--jp-success-color3);
}

.jp-RenderedHTMLCommon .alert-success > p:last-child,
.jp-RenderedHTMLCommon .alert-success > ul:last-child {
  margin-bottom: 0;
}

.jp-RenderedHTMLCommon .alert-danger {
  color: var(--jp-error-color0);
  background-color: var(--jp-error-color3);
  border-color: var(--jp-error-color2);
}

.jp-RenderedHTMLCommon .alert-danger hr {
  border-color: var(--jp-error-color3);
}

.jp-RenderedHTMLCommon .alert-danger > p:last-child,
.jp-RenderedHTMLCommon .alert-danger > ul:last-child {
  margin-bottom: 0;
}

.jp-RenderedHTMLCommon blockquote {
  margin: 1em 2em;
  padding: 0 1em;
  border-left: 5px solid var(--jp-border-color2);
}

a.jp-InternalAnchorLink {
  visibility: hidden;
  margin-left: 8px;
  color: var(--md-blue-800);
}

h1:hover .jp-InternalAnchorLink,
h2:hover .jp-InternalAnchorLink,
h3:hover .jp-InternalAnchorLink,
h4:hover .jp-InternalAnchorLink,
h5:hover .jp-InternalAnchorLink,
h6:hover .jp-InternalAnchorLink {
  visibility: visible;
}

.jp-RenderedHTMLCommon kbd {
  background-color: var(--jp-rendermime-table-row-background);
  border: 1px solid var(--jp-border-color0);
  border-bottom-color: var(--jp-border-color2);
  border-radius: 3px;
  box-shadow: inset 0 -1px 0 rgba(0, 0, 0, 0.25);
  display: inline-block;
  font-size: var(--jp-ui-font-size0);
  line-height: 1em;
  padding: 0.2em 0.5em;
}

/* Most direct children of .jp-RenderedHTMLCommon have a margin-bottom of 1.0.
 * At the bottom of cells this is a bit too much as there is also spacing
 * between cells. Going all the way to 0 gets too tight between markdown and
 * code cells.
 */
.jp-RenderedHTMLCommon > *:last-child {
  margin-bottom: 0.5em;
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Copyright (c) 2014-2017, PhosphorJS Contributors
|
| Distributed under the terms of the BSD 3-Clause License.
|
| The full license is in the file LICENSE, distributed with this software.
|----------------------------------------------------------------------------*/

.lm-cursor-backdrop {
  position: fixed;
  width: 200px;
  height: 200px;
  margin-top: -100px;
  margin-left: -100px;
  will-change: transform;
  z-index: 100;
}

.lm-mod-drag-image {
  will-change: transform;
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

.jp-lineFormSearch {
  padding: 4px 12px;
  background-color: var(--jp-layout-color2);
  box-shadow: var(--jp-toolbar-box-shadow);
  z-index: 2;
  font-size: var(--jp-ui-font-size1);
}

.jp-lineFormCaption {
  font-size: var(--jp-ui-font-size0);
  line-height: var(--jp-ui-font-size1);
  margin-top: 4px;
  color: var(--jp-ui-font-color0);
}

.jp-baseLineForm {
  border: none;
  border-radius: 0;
  position: absolute;
  background-size: 16px;
  background-repeat: no-repeat;
  background-position: center;
  outline: none;
}

.jp-lineFormButtonContainer {
  top: 4px;
  right: 8px;
  height: 24px;
  padding: 0 12px;
  width: 12px;
}

.jp-lineFormButtonIcon {
  top: 0;
  right: 0;
  background-color: var(--jp-brand-color1);
  height: 100%;
  width: 100%;
  box-sizing: border-box;
  padding: 4px 6px;
}

.jp-lineFormButton {
  top: 0;
  right: 0;
  background-color: transparent;
  height: 100%;
  width: 100%;
  box-sizing: border-box;
}

.jp-lineFormWrapper {
  overflow: hidden;
  padding: 0 8px;
  border: 1px solid var(--jp-border-color0);
  background-color: var(--jp-input-active-background);
  height: 22px;
}

.jp-lineFormWrapperFocusWithin {
  border: var(--jp-border-width) solid var(--md-blue-500);
  box-shadow: inset 0 0 4px var(--md-blue-300);
}

.jp-lineFormInput {
  background: transparent;
  width: 200px;
  height: 100%;
  border: none;
  outline: none;
  color: var(--jp-ui-font-color0);
  line-height: 28px;
}

/*-----------------------------------------------------------------------------
| Copyright (c) 2014-2016, Jupyter Development Team.
|
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

.jp-JSONEditor {
  display: flex;
  flex-direction: column;
  width: 100%;
}

.jp-JSONEditor-host {
  flex: 1 1 auto;
  border: var(--jp-border-width) solid var(--jp-input-border-color);
  border-radius: 0;
  background: var(--jp-layout-color0);
  min-height: 50px;
  padding: 1px;
}

.jp-JSONEditor.jp-mod-error .jp-JSONEditor-host {
  border-color: red;
  outline-color: red;
}

.jp-JSONEditor-header {
  display: flex;
  flex: 1 0 auto;
  padding: 0 0 0 12px;
}

.jp-JSONEditor-header label {
  flex: 0 0 auto;
}

.jp-JSONEditor-commitButton {
  height: 16px;
  width: 16px;
  background-size: 18px;
  background-repeat: no-repeat;
  background-position: center;
}

.jp-JSONEditor-host.jp-mod-focused {
  background-color: var(--jp-input-active-background);
  border: 1px solid var(--jp-input-active-border-color);
  box-shadow: var(--jp-input-box-shadow);
}

.jp-Editor.jp-mod-dropTarget {
  border: var(--jp-border-width) solid var(--jp-input-active-border-color);
  box-shadow: var(--jp-input-box-shadow);
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/
.jp-DocumentSearch-input {
  border: none;
  outline: none;
  color: var(--jp-ui-font-color0);
  font-size: var(--jp-ui-font-size1);
  background-color: var(--jp-layout-color0);
  font-family: var(--jp-ui-font-family);
  padding: 2px 1px;
  resize: none;
}

.jp-DocumentSearch-overlay {
  position: absolute;
  background-color: var(--jp-toolbar-background);
  border-bottom: var(--jp-border-width) solid var(--jp-toolbar-border-color);
  border-left: var(--jp-border-width) solid var(--jp-toolbar-border-color);
  top: 0;
  right: 0;
  z-index: 7;
  min-width: 405px;
  padding: 2px;
  font-size: var(--jp-ui-font-size1);

  --jp-private-document-search-button-height: 20px;
}

.jp-DocumentSearch-overlay button {
  background-color: var(--jp-toolbar-background);
  outline: 0;
}

.jp-DocumentSearch-overlay button:hover {
  background-color: var(--jp-layout-color2);
}

.jp-DocumentSearch-overlay button:active {
  background-color: var(--jp-layout-color3);
}

.jp-DocumentSearch-overlay-row {
  display: flex;
  align-items: center;
  margin-bottom: 2px;
}

.jp-DocumentSearch-button-content {
  display: inline-block;
  cursor: pointer;
  box-sizing: border-box;
  width: 100%;
  height: 100%;
}

.jp-DocumentSearch-button-content svg {
  width: 100%;
  height: 100%;
}

.jp-DocumentSearch-input-wrapper {
  border: var(--jp-border-width) solid var(--jp-border-color0);
  display: flex;
  background-color: var(--jp-layout-color0);
  margin: 2px;
}

.jp-DocumentSearch-input-wrapper:focus-within {
  border-color: var(--jp-cell-editor-active-border-color);
}

.jp-DocumentSearch-toggle-wrapper,
.jp-DocumentSearch-button-wrapper {
  all: initial;
  overflow: hidden;
  display: inline-block;
  border: none;
  box-sizing: border-box;
}

.jp-DocumentSearch-toggle-wrapper {
  width: 14px;
  height: 14px;
}

.jp-DocumentSearch-button-wrapper {
  width: var(--jp-private-document-search-button-height);
  height: var(--jp-private-document-search-button-height);
}

.jp-DocumentSearch-toggle-wrapper:focus,
.jp-DocumentSearch-button-wrapper:focus {
  outline: var(--jp-border-width) solid
    var(--jp-cell-editor-active-border-color);
  outline-offset: -1px;
}

.jp-DocumentSearch-toggle-wrapper,
.jp-DocumentSearch-button-wrapper,
.jp-DocumentSearch-button-content:focus {
  outline: none;
}

.jp-DocumentSearch-toggle-placeholder {
  width: 5px;
}

.jp-DocumentSearch-input-button::before {
  display: block;
  padding-top: 100%;
}

.jp-DocumentSearch-input-button-off {
  opacity: var(--jp-search-toggle-off-opacity);
}

.jp-DocumentSearch-input-button-off:hover {
  opacity: var(--jp-search-toggle-hover-opacity);
}

.jp-DocumentSearch-input-button-on {
  opacity: var(--jp-search-toggle-on-opacity);
}

.jp-DocumentSearch-index-counter {
  padding-left: 10px;
  padding-right: 10px;
  user-select: none;
  min-width: 35px;
  display: inline-block;
}

.jp-DocumentSearch-up-down-wrapper {
  display: inline-block;
  padding-right: 2px;
  margin-left: auto;
  white-space: nowrap;
}

.jp-DocumentSearch-spacer {
  margin-left: auto;
}

.jp-DocumentSearch-up-down-wrapper button {
  outline: 0;
  border: none;
  width: var(--jp-private-document-search-button-height);
  height: var(--jp-private-document-search-button-height);
  vertical-align: middle;
  margin: 1px 5px 2px;
}

.jp-DocumentSearch-up-down-button:hover {
  background-color: var(--jp-layout-color2);
}

.jp-DocumentSearch-up-down-button:active {
  background-color: var(--jp-layout-color3);
}

.jp-DocumentSearch-filter-button {
  border-radius: var(--jp-border-radius);
}

.jp-DocumentSearch-filter-button:hover {
  background-color: var(--jp-layout-color2);
}

.jp-DocumentSearch-filter-button-enabled {
  background-color: var(--jp-layout-color2);
}

.jp-DocumentSearch-filter-button-enabled:hover {
  background-color: var(--jp-layout-color3);
}

.jp-DocumentSearch-search-options {
  padding: 0 8px;
  margin-left: 3px;
  width: 100%;
  display: grid;
  justify-content: start;
  grid-template-columns: 1fr 1fr;
  align-items: center;
  justify-items: stretch;
}

.jp-DocumentSearch-search-filter-disabled {
  color: var(--jp-ui-font-color2);
}

.jp-DocumentSearch-search-filter {
  display: flex;
  align-items: center;
  user-select: none;
}

.jp-DocumentSearch-regex-error {
  color: var(--jp-error-color0);
}

.jp-DocumentSearch-replace-button-wrapper {
  overflow: hidden;
  display: inline-block;
  box-sizing: border-box;
  border: var(--jp-border-width) solid var(--jp-border-color0);
  margin: auto 2px;
  padding: 1px 4px;
  height: calc(var(--jp-private-document-search-button-height) + 2px);
}

.jp-DocumentSearch-replace-button-wrapper:focus {
  border: var(--jp-border-width) solid var(--jp-cell-editor-active-border-color);
}

.jp-DocumentSearch-replace-button {
  display: inline-block;
  text-align: center;
  cursor: pointer;
  box-sizing: border-box;
  color: var(--jp-ui-font-color1);

  /* height - 2 * (padding of wrapper) */
  line-height: calc(var(--jp-private-document-search-button-height) - 2px);
  width: 100%;
  height: 100%;
}

.jp-DocumentSearch-replace-button:focus {
  outline: none;
}

.jp-DocumentSearch-replace-wrapper-class {
  margin-left: 14px;
  display: flex;
}

.jp-DocumentSearch-replace-toggle {
  border: none;
  background-color: var(--jp-toolbar-background);
  border-radius: var(--jp-border-radius);
}

.jp-DocumentSearch-replace-toggle:hover {
  background-color: var(--jp-layout-color2);
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

.cm-editor {
  line-height: var(--jp-code-line-height);
  font-size: var(--jp-code-font-size);
  font-family: var(--jp-code-font-family);
  border: 0;
  border-radius: 0;
  height: auto;

  /* Changed to auto to autogrow */
}

.cm-editor pre {
  padding: 0 var(--jp-code-padding);
}

.jp-CodeMirrorEditor[data-type='inline'] .cm-dialog {
  background-color: var(--jp-layout-color0);
  color: var(--jp-content-font-color1);
}

.jp-CodeMirrorEditor {
  cursor: text;
}

/* When zoomed out 67% and 33% on a screen of 1440 width x 900 height */
@media screen and (min-width: 2138px) and (max-width: 4319px) {
  .jp-CodeMirrorEditor[data-type='inline'] .cm-cursor {
    border-left: var(--jp-code-cursor-width1) solid
      var(--jp-editor-cursor-color);
  }
}

/* When zoomed out less than 33% */
@media screen and (min-width: 4320px) {
  .jp-CodeMirrorEditor[data-type='inline'] .cm-cursor {
    border-left: var(--jp-code-cursor-width2) solid
      var(--jp-editor-cursor-color);
  }
}

.cm-editor.jp-mod-readOnly .cm-cursor {
  display: none;
}

.jp-CollaboratorCursor {
  border-left: 5px solid transparent;
  border-right: 5px solid transparent;
  border-top: none;
  border-bottom: 3px solid;
  background-clip: content-box;
  margin-left: -5px;
  margin-right: -5px;
}

.cm-searching,
.cm-searching span {
  /* `.cm-searching span`: we need to override syntax highlighting */
  background-color: var(--jp-search-unselected-match-background-color);
  color: var(--jp-search-unselected-match-color);
}

.cm-searching::selection,
.cm-searching span::selection {
  background-color: var(--jp-search-unselected-match-background-color);
  color: var(--jp-search-unselected-match-color);
}

.jp-current-match > .cm-searching,
.jp-current-match > .cm-searching span,
.cm-searching > .jp-current-match,
.cm-searching > .jp-current-match span {
  background-color: var(--jp-search-selected-match-background-color);
  color: var(--jp-search-selected-match-color);
}

.jp-current-match > .cm-searching::selection,
.cm-searching > .jp-current-match::selection,
.jp-current-match > .cm-searching span::selection {
  background-color: var(--jp-search-selected-match-background-color);
  color: var(--jp-search-selected-match-color);
}

.cm-trailingspace {
  background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAFCAYAAAB4ka1VAAAAsElEQVQIHQGlAFr/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA7+r3zKmT0/+pk9P/7+r3zAAAAAAAAAAABAAAAAAAAAAA6OPzM+/q9wAAAAAA6OPzMwAAAAAAAAAAAgAAAAAAAAAAGR8NiRQaCgAZIA0AGR8NiQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQyoYJ/SY80UAAAAASUVORK5CYII=);
  background-position: center left;
  background-repeat: repeat-x;
}

.jp-CollaboratorCursor-hover {
  position: absolute;
  z-index: 1;
  transform: translateX(-50%);
  color: white;
  border-radius: 3px;
  padding-left: 4px;
  padding-right: 4px;
  padding-top: 1px;
  padding-bottom: 1px;
  text-align: center;
  font-size: var(--jp-ui-font-size1);
  white-space: nowrap;
}

.jp-CodeMirror-ruler {
  border-left: 1px dashed var(--jp-border-color2);
}

/* Styles for shared cursors (remote cursor locations and selected ranges) */
.jp-CodeMirrorEditor .cm-ySelectionCaret {
  position: relative;
  border-left: 1px solid black;
  margin-left: -1px;
  margin-right: -1px;
  box-sizing: border-box;
}

.jp-CodeMirrorEditor .cm-ySelectionCaret > .cm-ySelectionInfo {
  white-space: nowrap;
  position: absolute;
  top: -1.15em;
  padding-bottom: 0.05em;
  left: -1px;
  font-size: 0.95em;
  font-family: var(--jp-ui-font-family);
  font-weight: bold;
  line-height: normal;
  user-select: none;
  color: white;
  padding-left: 2px;
  padding-right: 2px;
  z-index: 101;
  transition: opacity 0.3s ease-in-out;
}

.jp-CodeMirrorEditor .cm-ySelectionInfo {
  transition-delay: 0.7s;
  opacity: 0;
}

.jp-CodeMirrorEditor .cm-ySelectionCaret:hover > .cm-ySelectionInfo {
  opacity: 1;
  transition-delay: 0s;
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

.jp-MimeDocument {
  outline: none;
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| Variables
|----------------------------------------------------------------------------*/

:root {
  --jp-private-filebrowser-button-height: 28px;
  --jp-private-filebrowser-button-width: 48px;
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

.jp-FileBrowser .jp-SidePanel-content {
  display: flex;
  flex-direction: column;
}

.jp-FileBrowser-toolbar.jp-Toolbar {
  flex-wrap: wrap;
  row-gap: 12px;
  border-bottom: none;
  height: auto;
  margin: 8px 12px 0;
  box-shadow: none;
  padding: 0;
  justify-content: flex-start;
}

.jp-FileBrowser-Panel {
  flex: 1 1 auto;
  display: flex;
  flex-direction: column;
}

.jp-BreadCrumbs {
  flex: 0 0 auto;
  margin: 8px 12px;
}

.jp-BreadCrumbs-item {
  margin: 0 2px;
  padding: 0 2px;
  border-radius: var(--jp-border-radius);
  cursor: pointer;
}

.jp-BreadCrumbs-item:hover {
  background-color: var(--jp-layout-color2);
}

.jp-BreadCrumbs-item:first-child {
  margin-left: 0;
}

.jp-BreadCrumbs-item.jp-mod-dropTarget {
  background-color: var(--jp-brand-color2);
  opacity: 0.7;
}

/*-----------------------------------------------------------------------------
| Buttons
|----------------------------------------------------------------------------*/

.jp-FileBrowser-toolbar > .jp-Toolbar-item {
  flex: 0 0 auto;
  padding-left: 0;
  padding-right: 2px;
  align-items: center;
  height: unset;
}

.jp-FileBrowser-toolbar > .jp-Toolbar-item .jp-ToolbarButtonComponent {
  width: 40px;
}

/*-----------------------------------------------------------------------------
| Other styles
|----------------------------------------------------------------------------*/

.jp-FileDialog.jp-mod-conflict input {
  color: var(--jp-error-color1);
}

.jp-FileDialog .jp-new-name-title {
  margin-top: 12px;
}

.jp-LastModified-hidden {
  display: none;
}

.jp-FileSize-hidden {
  display: none;
}

.jp-FileBrowser .lm-AccordionPanel > h3:first-child {
  display: none;
}

/*-----------------------------------------------------------------------------
| DirListing
|----------------------------------------------------------------------------*/

.jp-DirListing {
  flex: 1 1 auto;
  display: flex;
  flex-direction: column;
  outline: 0;
}

.jp-DirListing-header {
  flex: 0 0 auto;
  display: flex;
  flex-direction: row;
  align-items: center;
  overflow: hidden;
  border-top: var(--jp-border-width) solid var(--jp-border-color2);
  border-bottom: var(--jp-border-width) solid var(--jp-border-color1);
  box-shadow: var(--jp-toolbar-box-shadow);
  z-index: 2;
}

.jp-DirListing-headerItem {
  padding: 4px 12px 2px;
  font-weight: 500;
}

.jp-DirListing-headerItem:hover {
  background: var(--jp-layout-color2);
}

.jp-DirListing-headerItem.jp-id-name {
  flex: 1 0 84px;
}

.jp-DirListing-headerItem.jp-id-modified {
  flex: 0 0 112px;
  border-left: var(--jp-border-width) solid var(--jp-border-color2);
  text-align: right;
}

.jp-DirListing-headerItem.jp-id-filesize {
  flex: 0 0 75px;
  border-left: var(--jp-border-width) solid var(--jp-border-color2);
  text-align: right;
}

.jp-id-narrow {
  display: none;
  flex: 0 0 5px;
  padding: 4px;
  border-left: var(--jp-border-width) solid var(--jp-border-color2);
  text-align: right;
  color: var(--jp-border-color2);
}

.jp-DirListing-narrow .jp-id-narrow {
  display: block;
}

.jp-DirListing-narrow .jp-id-modified,
.jp-DirListing-narrow .jp-DirListing-itemModified {
  display: none;
}

.jp-DirListing-headerItem.jp-mod-selected {
  font-weight: 600;
}

/* increase specificity to override bundled default */
.jp-DirListing-content {
  flex: 1 1 auto;
  margin: 0;
  padding: 0;
  list-style-type: none;
  overflow: auto;
  background-color: var(--jp-layout-color1);
}

.jp-DirListing-content mark {
  color: var(--jp-ui-font-color0);
  background-color: transparent;
  font-weight: bold;
}

.jp-DirListing-content .jp-DirListing-item.jp-mod-selected mark {
  color: var(--jp-ui-inverse-font-color0);
}

/* Style the directory listing content when a user drops a file to upload */
.jp-DirListing.jp-mod-native-drop .jp-DirListing-content {
  outline: 5px dashed rgba(128, 128, 128, 0.5);
  outline-offset: -10px;
  cursor: copy;
}

.jp-DirListing-item {
  display: flex;
  flex-direction: row;
  align-items: center;
  padding: 4px 12px;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.jp-DirListing-checkboxWrapper {
  /* Increases hit area of checkbox. */
  padding: 4px;
}

.jp-DirListing-header
  .jp-DirListing-checkboxWrapper
  + .jp-DirListing-headerItem {
  padding-left: 4px;
}

.jp-DirListing-content .jp-DirListing-checkboxWrapper {
  position: relative;
  left: -4px;
  margin: -4px 0 -4px -8px;
}

.jp-DirListing-checkboxWrapper.jp-mod-visible {
  visibility: visible;
}

/* For devices that support hovering, hide checkboxes until hovered, selected...
*/
@media (hover: hover) {
  .jp-DirListing-checkboxWrapper {
    visibility: hidden;
  }

  .jp-DirListing-item:hover .jp-DirListing-checkboxWrapper,
  .jp-DirListing-item.jp-mod-selected .jp-DirListing-checkboxWrapper {
    visibility: visible;
  }
}

.jp-DirListing-item[data-is-dot] {
  opacity: 75%;
}

.jp-DirListing-item.jp-mod-selected {
  color: var(--jp-ui-inverse-font-color1);
  background: var(--jp-brand-color1);
}

.jp-DirListing-item.jp-mod-dropTarget {
  background: var(--jp-brand-color3);
}

.jp-DirListing-item:hover:not(.jp-mod-selected) {
  background: var(--jp-layout-color2);
}

.jp-DirListing-itemIcon {
  flex: 0 0 20px;
  margin-right: 4px;
}

.jp-DirListing-itemText {
  flex: 1 0 64px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  user-select: none;
}

.jp-DirListing-itemText:focus {
  outline-width: 2px;
  outline-color: var(--jp-inverse-layout-color1);
  outline-style: solid;
  outline-offset: 1px;
}

.jp-DirListing-item.jp-mod-selected .jp-DirListing-itemText:focus {
  outline-color: var(--jp-layout-color1);
}

.jp-DirListing-itemModified {
  flex: 0 0 125px;
  text-align: right;
}

.jp-DirListing-itemFileSize {
  flex: 0 0 90px;
  text-align: right;
}

.jp-DirListing-editor {
  flex: 1 0 64px;
  outline: none;
  border: none;
  color: var(--jp-ui-font-color1);
  background-color: var(--jp-layout-color1);
}

.jp-DirListing-item.jp-mod-running .jp-DirListing-itemIcon::before {
  color: var(--jp-success-color1);
  content: '\25CF';
  font-size: 8px;
  position: absolute;
  left: -8px;
}

.jp-DirListing-item.jp-mod-running.jp-mod-selected
  .jp-DirListing-itemIcon::before {
  color: var(--jp-ui-inverse-font-color1);
}

.jp-DirListing-item.lm-mod-drag-image,
.jp-DirListing-item.jp-mod-selected.lm-mod-drag-image {
  font-size: var(--jp-ui-font-size1);
  padding-left: 4px;
  margin-left: 4px;
  width: 160px;
  background-color: var(--jp-ui-inverse-font-color2);
  box-shadow: var(--jp-elevation-z2);
  border-radius: 0;
  color: var(--jp-ui-font-color1);
  transform: translateX(-40%) translateY(-58%);
}

.jp-Document {
  min-width: 120px;
  min-height: 120px;
  outline: none;
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| Main OutputArea
| OutputArea has a list of Outputs
|----------------------------------------------------------------------------*/

.jp-OutputArea {
  overflow-y: auto;
}

.jp-OutputArea-child {
  display: table;
  table-layout: fixed;
  width: 100%;
  overflow: hidden;
}

.jp-OutputPrompt {
  width: var(--jp-cell-prompt-width);
  color: var(--jp-cell-outprompt-font-color);
  font-family: var(--jp-cell-prompt-font-family);
  padding: var(--jp-code-padding);
  letter-spacing: var(--jp-cell-prompt-letter-spacing);
  line-height: var(--jp-code-line-height);
  font-size: var(--jp-code-font-size);
  border: var(--jp-border-width) solid transparent;
  opacity: var(--jp-cell-prompt-opacity);

  /* Right align prompt text, don't wrap to handle large prompt numbers */
  text-align: right;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;

  /* Disable text selection */
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.jp-OutputArea-prompt {
  display: table-cell;
  vertical-align: top;
}

.jp-OutputArea-output {
  display: table-cell;
  width: 100%;
  height: auto;
  overflow: auto;
  user-select: text;
  -moz-user-select: text;
  -webkit-user-select: text;
  -ms-user-select: text;
}

.jp-OutputArea .jp-RenderedText {
  padding-left: 1ch;
}

/**
 * Prompt overlay.
 */

.jp-OutputArea-promptOverlay {
  position: absolute;
  top: 0;
  width: var(--jp-cell-prompt-width);
  height: 100%;
  opacity: 0.5;
}

.jp-OutputArea-promptOverlay:hover {
  background: var(--jp-layout-color2);
  box-shadow: inset 0 0 1px var(--jp-inverse-layout-color0);
  cursor: zoom-out;
}

.jp-mod-outputsScrolled .jp-OutputArea-promptOverlay:hover {
  cursor: zoom-in;
}

/**
 * Isolated output.
 */
.jp-OutputArea-output.jp-mod-isolated {
  width: 100%;
  display: block;
}

/*
When drag events occur, `lm-mod-override-cursor` is added to the body.
Because iframes steal all cursor events, the following two rules are necessary
to suppress pointer events while resize drags are occurring. There may be a
better solution to this problem.
*/
body.lm-mod-override-cursor .jp-OutputArea-output.jp-mod-isolated {
  position: relative;
}

body.lm-mod-override-cursor .jp-OutputArea-output.jp-mod-isolated::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: transparent;
}

/* pre */

.jp-OutputArea-output pre {
  border: none;
  margin: 0;
  padding: 0;
  overflow-x: auto;
  overflow-y: auto;
  word-break: break-all;
  word-wrap: break-word;
  white-space: pre-wrap;
}

/* tables */

.jp-OutputArea-output.jp-RenderedHTMLCommon table {
  margin-left: 0;
  margin-right: 0;
}

/* description lists */

.jp-OutputArea-output dl,
.jp-OutputArea-output dt,
.jp-OutputArea-output dd {
  display: block;
}

.jp-OutputArea-output dl {
  width: 100%;
  overflow: hidden;
  padding: 0;
  margin: 0;
}

.jp-OutputArea-output dt {
  font-weight: bold;
  float: left;
  width: 20%;
  padding: 0;
  margin: 0;
}

.jp-OutputArea-output dd {
  float: left;
  width: 80%;
  padding: 0;
  margin: 0;
}

.jp-TrimmedOutputs pre {
  background: var(--jp-layout-color3);
  font-size: calc(var(--jp-code-font-size) * 1.4);
  text-align: center;
  text-transform: uppercase;
}

/* Hide the gutter in case of
 *  - nested output areas (e.g. in the case of output widgets)
 *  - mirrored output areas
 */
.jp-OutputArea .jp-OutputArea .jp-OutputArea-prompt {
  display: none;
}

/* Hide empty lines in the output area, for instance due to cleared widgets */
.jp-OutputArea-prompt:empty {
  padding: 0;
  border: 0;
}

/*-----------------------------------------------------------------------------
| executeResult is added to any Output-result for the display of the object
| returned by a cell
|----------------------------------------------------------------------------*/

.jp-OutputArea-output.jp-OutputArea-executeResult {
  margin-left: 0;
  width: 100%;
}

/* Text output with the Out[] prompt needs a top padding to match the
 * alignment of the Out[] prompt itself.
 */
.jp-OutputArea-executeResult .jp-RenderedText.jp-OutputArea-output {
  padding-top: var(--jp-code-padding);
  border-top: var(--jp-border-width) solid transparent;
}

/*-----------------------------------------------------------------------------
| The Stdin output
|----------------------------------------------------------------------------*/

.jp-Stdin-prompt {
  color: var(--jp-content-font-color0);
  padding-right: var(--jp-code-padding);
  vertical-align: baseline;
  flex: 0 0 auto;
}

.jp-Stdin-input {
  font-family: var(--jp-code-font-family);
  font-size: inherit;
  color: inherit;
  background-color: inherit;
  width: 42%;
  min-width: 200px;

  /* make sure input baseline aligns with prompt */
  vertical-align: baseline;

  /* padding + margin = 0.5em between prompt and cursor */
  padding: 0 0.25em;
  margin: 0 0.25em;
  flex: 0 0 70%;
}

.jp-Stdin-input::placeholder {
  opacity: 0;
}

.jp-Stdin-input:focus {
  box-shadow: none;
}

.jp-Stdin-input:focus::placeholder {
  opacity: 1;
}

/*-----------------------------------------------------------------------------
| Output Area View
|----------------------------------------------------------------------------*/

.jp-LinkedOutputView .jp-OutputArea {
  height: 100%;
  display: block;
}

.jp-LinkedOutputView .jp-OutputArea-output:only-child {
  height: 100%;
}

/*-----------------------------------------------------------------------------
| Printing
|----------------------------------------------------------------------------*/

@media print {
  .jp-OutputArea-child {
    break-inside: avoid-page;
  }
}

/*-----------------------------------------------------------------------------
| Mobile
|----------------------------------------------------------------------------*/
@media only screen and (max-width: 760px) {
  .jp-OutputPrompt {
    display: table-row;
    text-align: left;
  }

  .jp-OutputArea-child .jp-OutputArea-output {
    display: table-row;
    margin-left: var(--jp-notebook-padding);
  }
}

/* Trimmed outputs warning */
.jp-TrimmedOutputs > a {
  margin: 10px;
  text-decoration: none;
  cursor: pointer;
}

.jp-TrimmedOutputs > a:hover {
  text-decoration: none;
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| Table of Contents
|----------------------------------------------------------------------------*/

:root {
  --jp-private-toc-active-width: 4px;
}

.jp-TableOfContents {
  display: flex;
  flex-direction: column;
  background: var(--jp-layout-color1);
  color: var(--jp-ui-font-color1);
  font-size: var(--jp-ui-font-size1);
  height: 100%;
}

.jp-TableOfContents-placeholder {
  text-align: center;
}

.jp-TableOfContents-placeholderContent {
  color: var(--jp-content-font-color2);
  padding: 8px;
}

.jp-TableOfContents-placeholderContent > h3 {
  margin-bottom: var(--jp-content-heading-margin-bottom);
}

.jp-TableOfContents .jp-SidePanel-content {
  overflow-y: auto;
}

.jp-TableOfContents-tree {
  margin: 4px;
}

.jp-TableOfContents ol {
  list-style-type: none;
}

/* stylelint-disable-next-line selector-max-type */
.jp-TableOfContents li > ol {
  /* Align left border with triangle icon center */
  padding-left: 11px;
}

.jp-TableOfContents-content {
  /* left margin for the active heading indicator */
  margin: 0 0 0 var(--jp-private-toc-active-width);
  padding: 0;
  background-color: var(--jp-layout-color1);
}

.jp-tocItem {
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.jp-tocItem-heading {
  display: flex;
  cursor: pointer;
}

.jp-tocItem-heading:hover {
  background-color: var(--jp-layout-color2);
}

.jp-tocItem-content {
  display: block;
  padding: 4px 0;
  white-space: nowrap;
  text-overflow: ellipsis;
  overflow-x: hidden;
}

.jp-tocItem-collapser {
  height: 20px;
  margin: 2px 2px 0;
  padding: 0;
  background: none;
  border: none;
  cursor: pointer;
}

.jp-tocItem-collapser:hover {
  background-color: var(--jp-layout-color3);
}

/* Active heading indicator */

.jp-tocItem-heading::before {
  content: ' ';
  background: transparent;
  width: var(--jp-private-toc-active-width);
  height: 24px;
  position: absolute;
  left: 0;
  border-radius: var(--jp-border-radius);
}

.jp-tocItem-heading.jp-tocItem-active::before {
  background-color: var(--jp-brand-color1);
}

.jp-tocItem-heading:hover.jp-tocItem-active::before {
  background: var(--jp-brand-color0);
  opacity: 1;
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

.jp-Collapser {
  flex: 0 0 var(--jp-cell-collapser-width);
  padding: 0;
  margin: 0;
  border: none;
  outline: none;
  background: transparent;
  border-radius: var(--jp-border-radius);
  opacity: 1;
}

.jp-Collapser-child {
  display: block;
  width: 100%;
  box-sizing: border-box;

  /* height: 100% doesn't work because the height of its parent is computed from content */
  position: absolute;
  top: 0;
  bottom: 0;
}

/*-----------------------------------------------------------------------------
| Printing
|----------------------------------------------------------------------------*/

/*
Hiding collapsers in print mode.

Note: input and output wrappers have "display: block" propery in print mode.
*/

@media print {
  .jp-Collapser {
    display: none;
  }
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| Header/Footer
|----------------------------------------------------------------------------*/

/* Hidden by zero height by default */
.jp-CellHeader,
.jp-CellFooter {
  height: 0;
  width: 100%;
  padding: 0;
  margin: 0;
  border: none;
  outline: none;
  background: transparent;
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| Input
|----------------------------------------------------------------------------*/

/* All input areas */
.jp-InputArea {
  display: table;
  table-layout: fixed;
  width: 100%;
  overflow: hidden;
}

.jp-InputArea-editor {
  display: table-cell;
  overflow: hidden;
  vertical-align: top;

  /* This is the non-active, default styling */
  border: var(--jp-border-width) solid var(--jp-cell-editor-border-color);
  border-radius: 0;
  background: var(--jp-cell-editor-background);
}

.jp-InputPrompt {
  display: table-cell;
  vertical-align: top;
  width: var(--jp-cell-prompt-width);
  color: var(--jp-cell-inprompt-font-color);
  font-family: var(--jp-cell-prompt-font-family);
  padding: var(--jp-code-padding);
  letter-spacing: var(--jp-cell-prompt-letter-spacing);
  opacity: var(--jp-cell-prompt-opacity);
  line-height: var(--jp-code-line-height);
  font-size: var(--jp-code-font-size);
  border: var(--jp-border-width) solid transparent;

  /* Right align prompt text, don't wrap to handle large prompt numbers */
  text-align: right;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;

  /* Disable text selection */
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

/*-----------------------------------------------------------------------------
| Mobile
|----------------------------------------------------------------------------*/
@media only screen and (max-width: 760px) {
  .jp-InputArea-editor {
    display: table-row;
    margin-left: var(--jp-notebook-padding);
  }

  .jp-InputPrompt {
    display: table-row;
    text-align: left;
  }
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| Placeholder
|----------------------------------------------------------------------------*/

.jp-Placeholder {
  display: table;
  table-layout: fixed;
  width: 100%;
}

.jp-Placeholder-prompt {
  display: table-cell;
  box-sizing: border-box;
}

.jp-Placeholder-content {
  display: table-cell;
  padding: 4px 6px;
  border: 1px solid transparent;
  border-radius: 0;
  background: none;
  box-sizing: border-box;
  cursor: pointer;
}

.jp-Placeholder-contentContainer {
  display: flex;
}

.jp-Placeholder-content:hover,
.jp-InputPlaceholder > .jp-Placeholder-content:hover {
  border-color: var(--jp-layout-color3);
}

.jp-Placeholder-content .jp-MoreHorizIcon {
  width: 32px;
  height: 16px;
  border: 1px solid transparent;
  border-radius: var(--jp-border-radius);
}

.jp-Placeholder-content .jp-MoreHorizIcon:hover {
  border: 1px solid var(--jp-border-color1);
  box-shadow: 0 0 2px 0 rgba(0, 0, 0, 0.25);
  background-color: var(--jp-layout-color0);
}

.jp-PlaceholderText {
  white-space: nowrap;
  overflow-x: hidden;
  color: var(--jp-inverse-layout-color3);
  font-family: var(--jp-code-font-family);
}

.jp-InputPlaceholder > .jp-Placeholder-content {
  border-color: var(--jp-cell-editor-border-color);
  background: var(--jp-cell-editor-background);
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| Private CSS variables
|----------------------------------------------------------------------------*/

:root {
  --jp-private-cell-scrolling-output-offset: 5px;
}

/*-----------------------------------------------------------------------------
| Cell
|----------------------------------------------------------------------------*/

.jp-Cell {
  padding: var(--jp-cell-padding);
  margin: 0;
  border: none;
  outline: none;
  background: transparent;
}

/*-----------------------------------------------------------------------------
| Common input/output
|----------------------------------------------------------------------------*/

.jp-Cell-inputWrapper,
.jp-Cell-outputWrapper {
  display: flex;
  flex-direction: row;
  padding: 0;
  margin: 0;

  /* Added to reveal the box-shadow on the input and output collapsers. */
  overflow: visible;
}

/* Only input/output areas inside cells */
.jp-Cell-inputArea,
.jp-Cell-outputArea {
  flex: 1 1 auto;
}

/*-----------------------------------------------------------------------------
| Collapser
|----------------------------------------------------------------------------*/

/* Make the output collapser disappear when there is not output, but do so
 * in a manner that leaves it in the layout and preserves its width.
 */
.jp-Cell.jp-mod-noOutputs .jp-Cell-outputCollapser {
  border: none !important;
  background: transparent !important;
}

.jp-Cell:not(.jp-mod-noOutputs) .jp-Cell-outputCollapser {
  min-height: var(--jp-cell-collapser-min-height);
}

/*-----------------------------------------------------------------------------
| Output
|----------------------------------------------------------------------------*/

/* Put a space between input and output when there IS output */
.jp-Cell:not(.jp-mod-noOutputs) .jp-Cell-outputWrapper {
  margin-top: 5px;
}

.jp-CodeCell.jp-mod-outputsScrolled .jp-Cell-outputArea {
  overflow-y: auto;
  max-height: 24em;
  margin-left: var(--jp-private-cell-scrolling-output-offset);
  resize: vertical;
}

.jp-CodeCell.jp-mod-outputsScrolled .jp-Cell-outputArea[style*='height'] {
  max-height: unset;
}

.jp-CodeCell.jp-mod-outputsScrolled .jp-Cell-outputArea::after {
  content: ' ';
  box-shadow: inset 0 0 6px 2px rgb(0 0 0 / 30%);
  width: 100%;
  height: 100%;
  position: sticky;
  bottom: 0;
  top: 0;
  margin-top: -50%;
  float: left;
  display: block;
  pointer-events: none;
}

.jp-CodeCell.jp-mod-outputsScrolled .jp-OutputArea-child {
  padding-top: 6px;
}

.jp-CodeCell.jp-mod-outputsScrolled .jp-OutputArea-prompt {
  width: calc(
    var(--jp-cell-prompt-width) - var(--jp-private-cell-scrolling-output-offset)
  );
}

.jp-CodeCell.jp-mod-outputsScrolled .jp-OutputArea-promptOverlay {
  left: calc(-1 * var(--jp-private-cell-scrolling-output-offset));
}

/*-----------------------------------------------------------------------------
| CodeCell
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| MarkdownCell
|----------------------------------------------------------------------------*/

.jp-MarkdownOutput {
  display: table-cell;
  width: 100%;
  margin-top: 0;
  margin-bottom: 0;
  padding-left: var(--jp-code-padding);
}

.jp-MarkdownOutput.jp-RenderedHTMLCommon {
  overflow: auto;
}

/* collapseHeadingButton (show always if hiddenCellsButton is _not_ shown) */
.jp-collapseHeadingButton {
  display: flex;
  min-height: var(--jp-cell-collapser-min-height);
  font-size: var(--jp-code-font-size);
  position: absolute;
  background-color: transparent;
  background-size: 25px;
  background-repeat: no-repeat;
  background-position-x: center;
  background-position-y: top;
  background-image: var(--jp-icon-caret-down);
  right: 0;
  top: 0;
  bottom: 0;
}

.jp-collapseHeadingButton.jp-mod-collapsed {
  background-image: var(--jp-icon-caret-right);
}

/*
 set the container font size to match that of content
 so that the nested collapse buttons have the right size
*/
.jp-MarkdownCell .jp-InputPrompt {
  font-size: var(--jp-content-font-size1);
}

/*
  Align collapseHeadingButton with cell top header
  The font sizes are identical to the ones in packages/rendermime/style/base.css
*/
.jp-mod-rendered .jp-collapseHeadingButton[data-heading-level='1'] {
  font-size: var(--jp-content-font-size5);
  background-position-y: calc(0.3 * var(--jp-content-font-size5));
}

.jp-mod-rendered .jp-collapseHeadingButton[data-heading-level='2'] {
  font-size: var(--jp-content-font-size4);
  background-position-y: calc(0.3 * var(--jp-content-font-size4));
}

.jp-mod-rendered .jp-collapseHeadingButton[data-heading-level='3'] {
  font-size: var(--jp-content-font-size3);
  background-position-y: calc(0.3 * var(--jp-content-font-size3));
}

.jp-mod-rendered .jp-collapseHeadingButton[data-heading-level='4'] {
  font-size: var(--jp-content-font-size2);
  background-position-y: calc(0.3 * var(--jp-content-font-size2));
}

.jp-mod-rendered .jp-collapseHeadingButton[data-heading-level='5'] {
  font-size: var(--jp-content-font-size1);
  background-position-y: top;
}

.jp-mod-rendered .jp-collapseHeadingButton[data-heading-level='6'] {
  font-size: var(--jp-content-font-size0);
  background-position-y: top;
}

/* collapseHeadingButton (show only on (hover,active) if hiddenCellsButton is shown) */
.jp-Notebook.jp-mod-showHiddenCellsButton .jp-collapseHeadingButton {
  display: none;
}

.jp-Notebook.jp-mod-showHiddenCellsButton
  :is(.jp-MarkdownCell:hover, .jp-mod-active)
  .jp-collapseHeadingButton {
  display: flex;
}

/* showHiddenCellsButton (only show if jp-mod-showHiddenCellsButton is set, which
is a consequence of the showHiddenCellsButton option in Notebook Settings)*/
.jp-Notebook.jp-mod-showHiddenCellsButton .jp-showHiddenCellsButton {
  margin-left: calc(var(--jp-cell-prompt-width) + 2 * var(--jp-code-padding));
  margin-top: var(--jp-code-padding);
  border: 1px solid var(--jp-border-color2);
  background-color: var(--jp-border-color3) !important;
  color: var(--jp-content-font-color0) !important;
  display: flex;
}

.jp-Notebook.jp-mod-showHiddenCellsButton .jp-showHiddenCellsButton:hover {
  background-color: var(--jp-border-color2) !important;
}

.jp-showHiddenCellsButton {
  display: none;
}

/*-----------------------------------------------------------------------------
| Printing
|----------------------------------------------------------------------------*/

/*
Using block instead of flex to allow the use of the break-inside CSS property for
cell outputs.
*/

@media print {
  .jp-Cell-inputWrapper,
  .jp-Cell-outputWrapper {
    display: block;
  }
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| Variables
|----------------------------------------------------------------------------*/

:root {
  --jp-notebook-toolbar-padding: 2px 5px 2px 2px;
}

/*-----------------------------------------------------------------------------

/*-----------------------------------------------------------------------------
| Styles
|----------------------------------------------------------------------------*/

.jp-NotebookPanel-toolbar {
  padding: var(--jp-notebook-toolbar-padding);

  /* disable paint containment from lumino 2.0 default strict CSS containment */
  contain: style size !important;
}

.jp-Toolbar-item.jp-Notebook-toolbarCellType .jp-select-wrapper.jp-mod-focused {
  border: none;
  box-shadow: none;
}

.jp-Notebook-toolbarCellTypeDropdown select {
  height: 24px;
  font-size: var(--jp-ui-font-size1);
  line-height: 14px;
  border-radius: 0;
  display: block;
}

.jp-Notebook-toolbarCellTypeDropdown span {
  top: 5px !important;
}

.jp-Toolbar-responsive-popup {
  position: absolute;
  height: fit-content;
  display: flex;
  flex-direction: row;
  flex-wrap: wrap;
  justify-content: flex-end;
  border-bottom: var(--jp-border-width) solid var(--jp-toolbar-border-color);
  box-shadow: var(--jp-toolbar-box-shadow);
  background: var(--jp-toolbar-background);
  min-height: var(--jp-toolbar-micro-height);
  padding: var(--jp-notebook-toolbar-padding);
  z-index: 1;
  right: 0;
  top: 0;
}

.jp-Toolbar > .jp-Toolbar-responsive-opener {
  margin-left: auto;
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| Variables
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------

/*-----------------------------------------------------------------------------
| Styles
|----------------------------------------------------------------------------*/

.jp-Notebook-ExecutionIndicator {
  position: relative;
  display: inline-block;
  height: 100%;
  z-index: 9997;
}

.jp-Notebook-ExecutionIndicator-tooltip {
  visibility: hidden;
  height: auto;
  width: max-content;
  width: -moz-max-content;
  background-color: var(--jp-layout-color2);
  color: var(--jp-ui-font-color1);
  text-align: justify;
  border-radius: 6px;
  padding: 0 5px;
  position: fixed;
  display: table;
}

.jp-Notebook-ExecutionIndicator-tooltip.up {
  transform: translateX(-50%) translateY(-100%) translateY(-32px);
}

.jp-Notebook-ExecutionIndicator-tooltip.down {
  transform: translateX(calc(-100% + 16px)) translateY(5px);
}

.jp-Notebook-ExecutionIndicator-tooltip.hidden {
  display: none;
}

.jp-Notebook-ExecutionIndicator:hover .jp-Notebook-ExecutionIndicator-tooltip {
  visibility: visible;
}

.jp-Notebook-ExecutionIndicator span {
  font-size: var(--jp-ui-font-size1);
  font-family: var(--jp-ui-font-family);
  color: var(--jp-ui-font-color1);
  line-height: 24px;
  display: block;
}

.jp-Notebook-ExecutionIndicator-progress-bar {
  display: flex;
  justify-content: center;
  height: 100%;
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

/*
 * Execution indicator
 */
.jp-tocItem-content::after {
  content: '';

  /* Must be identical to form a circle */
  width: 12px;
  height: 12px;
  background: none;
  border: none;
  position: absolute;
  right: 0;
}

.jp-tocItem-content[data-running='0']::after {
  border-radius: 50%;
  border: var(--jp-border-width) solid var(--jp-inverse-layout-color3);
  background: none;
}

.jp-tocItem-content[data-running='1']::after {
  border-radius: 50%;
  border: var(--jp-border-width) solid var(--jp-inverse-layout-color3);
  background-color: var(--jp-inverse-layout-color3);
}

.jp-tocItem-content[data-running='0'],
.jp-tocItem-content[data-running='1'] {
  margin-right: 12px;
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

.jp-Notebook-footer {
  height: 27px;
  margin-left: calc(
    var(--jp-cell-prompt-width) + var(--jp-cell-collapser-width) +
      var(--jp-cell-padding)
  );
  width: calc(
    100% -
      (
        var(--jp-cell-prompt-width) + var(--jp-cell-collapser-width) +
          var(--jp-cell-padding) + var(--jp-cell-padding)
      )
  );
  border: var(--jp-border-width) solid var(--jp-cell-editor-border-color);
  color: var(--jp-ui-font-color3);
  margin-top: 6px;
  background: none;
  cursor: pointer;
}

.jp-Notebook-footer:focus {
  border-color: var(--jp-cell-editor-active-border-color);
}

/* For devices that support hovering, hide footer until hover */
@media (hover: hover) {
  .jp-Notebook-footer {
    opacity: 0;
  }

  .jp-Notebook-footer:focus,
  .jp-Notebook-footer:hover {
    opacity: 1;
  }
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| Imports
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| CSS variables
|----------------------------------------------------------------------------*/

:root {
  --jp-side-by-side-output-size: 1fr;
  --jp-side-by-side-resized-cell: var(--jp-side-by-side-output-size);
  --jp-private-notebook-dragImage-width: 304px;
  --jp-private-notebook-dragImage-height: 36px;
  --jp-private-notebook-selected-color: var(--md-blue-400);
  --jp-private-notebook-active-color: var(--md-green-400);
}

/*-----------------------------------------------------------------------------
| Notebook
|----------------------------------------------------------------------------*/

/* stylelint-disable selector-max-class */

.jp-NotebookPanel {
  display: block;
  height: 100%;
}

.jp-NotebookPanel.jp-Document {
  min-width: 240px;
  min-height: 120px;
}

.jp-Notebook {
  padding: var(--jp-notebook-padding);
  outline: none;
  overflow: auto;
  background: var(--jp-layout-color0);
}

.jp-Notebook.jp-mod-scrollPastEnd::after {
  display: block;
  content: '';
  min-height: var(--jp-notebook-scroll-padding);
}

.jp-MainAreaWidget-ContainStrict .jp-Notebook * {
  contain: strict;
}

.jp-Notebook .jp-Cell {
  overflow: visible;
}

.jp-Notebook .jp-Cell .jp-InputPrompt {
  cursor: move;
}

/*-----------------------------------------------------------------------------
| Notebook state related styling
|
| The notebook and cells each have states, here are the possibilities:
|
| - Notebook
|   - Command
|   - Edit
| - Cell
|   - None
|   - Active (only one can be active)
|   - Selected (the cells actions are applied to)
|   - Multiselected (when multiple selected, the cursor)
|   - No outputs
|----------------------------------------------------------------------------*/

/* Command or edit modes */

.jp-Notebook .jp-Cell:not(.jp-mod-active) .jp-InputPrompt {
  opacity: var(--jp-cell-prompt-not-active-opacity);
  color: var(--jp-cell-prompt-not-active-font-color);
}

.jp-Notebook .jp-Cell:not(.jp-mod-active) .jp-OutputPrompt {
  opacity: var(--jp-cell-prompt-not-active-opacity);
  color: var(--jp-cell-prompt-not-active-font-color);
}

/* cell is active */
.jp-Notebook .jp-Cell.jp-mod-active .jp-Collapser {
  background: var(--jp-brand-color1);
}

/* cell is dirty */
.jp-Notebook .jp-Cell.jp-mod-dirty .jp-InputPrompt {
  color: var(--jp-warn-color1);
}

.jp-Notebook .jp-Cell.jp-mod-dirty .jp-InputPrompt::before {
  color: var(--jp-warn-color1);
  content: '';
}

.jp-Notebook .jp-Cell.jp-mod-active.jp-mod-dirty .jp-Collapser {
  background: var(--jp-warn-color1);
}

/* collapser is hovered */
.jp-Notebook .jp-Cell .jp-Collapser:hover {
  box-shadow: var(--jp-elevation-z2);
  background: var(--jp-brand-color1);
  opacity: var(--jp-cell-collapser-not-active-hover-opacity);
}

/* cell is active and collapser is hovered */
.jp-Notebook .jp-Cell.jp-mod-active .jp-Collapser:hover {
  background: var(--jp-brand-color0);
  opacity: 1;
}

/* Command mode */

.jp-Notebook.jp-mod-commandMode .jp-Cell.jp-mod-selected {
  background: var(--jp-notebook-multiselected-color);
}

.jp-Notebook.jp-mod-commandMode
  .jp-Cell.jp-mod-active.jp-mod-selected:not(.jp-mod-multiSelected) {
  background: transparent;
}

/* Edit mode */

.jp-Notebook.jp-mod-editMode .jp-Cell.jp-mod-active .jp-InputArea-editor {
  border: var(--jp-border-width) solid var(--jp-cell-editor-active-border-color);
  box-shadow: var(--jp-input-box-shadow);
  background-color: var(--jp-cell-editor-active-background);
}

/*-----------------------------------------------------------------------------
| Notebook drag and drop
|----------------------------------------------------------------------------*/

.jp-Notebook-cell.jp-mod-dropSource {
  opacity: 0.5;
}

.jp-Notebook-cell.jp-mod-dropTarget,
.jp-Notebook.jp-mod-commandMode
  .jp-Notebook-cell.jp-mod-active.jp-mod-selected.jp-mod-dropTarget {
  border-top-color: var(--jp-private-notebook-selected-color);
  border-top-style: solid;
  border-top-width: 2px;
}

.jp-dragImage {
  display: block;
  flex-direction: row;
  width: var(--jp-private-notebook-dragImage-width);
  height: var(--jp-private-notebook-dragImage-height);
  border: var(--jp-border-width) solid var(--jp-cell-editor-border-color);
  background: var(--jp-cell-editor-background);
  overflow: visible;
}

.jp-dragImage-singlePrompt {
  box-shadow: 2px 2px 4px 0 rgba(0, 0, 0, 0.12);
}

.jp-dragImage .jp-dragImage-content {
  flex: 1 1 auto;
  z-index: 2;
  font-size: var(--jp-code-font-size);
  font-family: var(--jp-code-font-family);
  line-height: var(--jp-code-line-height);
  padding: var(--jp-code-padding);
  border: var(--jp-border-width) solid var(--jp-cell-editor-border-color);
  background: var(--jp-cell-editor-background-color);
  color: var(--jp-content-font-color3);
  text-align: left;
  margin: 4px 4px 4px 0;
}

.jp-dragImage .jp-dragImage-prompt {
  flex: 0 0 auto;
  min-width: 36px;
  color: var(--jp-cell-inprompt-font-color);
  padding: var(--jp-code-padding);
  padding-left: 12px;
  font-family: var(--jp-cell-prompt-font-family);
  letter-spacing: var(--jp-cell-prompt-letter-spacing);
  line-height: 1.9;
  font-size: var(--jp-code-font-size);
  border: var(--jp-border-width) solid transparent;
}

.jp-dragImage-multipleBack {
  z-index: -1;
  position: absolute;
  height: 32px;
  width: 300px;
  top: 8px;
  left: 8px;
  background: var(--jp-layout-color2);
  border: var(--jp-border-width) solid var(--jp-input-border-color);
  box-shadow: 2px 2px 4px 0 rgba(0, 0, 0, 0.12);
}

/*-----------------------------------------------------------------------------
| Cell toolbar
|----------------------------------------------------------------------------*/

.jp-NotebookTools {
  display: block;
  min-width: var(--jp-sidebar-min-width);
  color: var(--jp-ui-font-color1);
  background: var(--jp-layout-color1);

  /* This is needed so that all font sizing of children done in ems is
    * relative to this base size */
  font-size: var(--jp-ui-font-size1);
  overflow: auto;
}

.jp-ActiveCellTool {
  padding: 12px 0;
  display: flex;
}

.jp-ActiveCellTool-Content {
  flex: 1 1 auto;
}

.jp-ActiveCellTool .jp-ActiveCellTool-CellContent {
  background: var(--jp-cell-editor-background);
  border: var(--jp-border-width) solid var(--jp-cell-editor-border-color);
  border-radius: 0;
  min-height: 29px;
}

.jp-ActiveCellTool .jp-InputPrompt {
  min-width: calc(var(--jp-cell-prompt-width) * 0.75);
}

.jp-ActiveCellTool-CellContent > pre {
  padding: 5px 4px;
  margin: 0;
  white-space: normal;
}

.jp-MetadataEditorTool {
  flex-direction: column;
  padding: 12px 0;
}

.jp-RankedPanel > :not(:first-child) {
  margin-top: 12px;
}

.jp-KeySelector select.jp-mod-styled {
  font-size: var(--jp-ui-font-size1);
  color: var(--jp-ui-font-color0);
  border: var(--jp-border-width) solid var(--jp-border-color1);
}

.jp-KeySelector label,
.jp-MetadataEditorTool label,
.jp-NumberSetter label {
  line-height: 1.4;
}

.jp-NotebookTools .jp-select-wrapper {
  margin-top: 4px;
  margin-bottom: 0;
}

.jp-NumberSetter input {
  width: 100%;
  margin-top: 4px;
}

.jp-NotebookTools .jp-Collapse {
  margin-top: 16px;
}

/*-----------------------------------------------------------------------------
| Presentation Mode (.jp-mod-presentationMode)
|----------------------------------------------------------------------------*/

.jp-mod-presentationMode .jp-Notebook {
  --jp-content-font-size1: var(--jp-content-presentation-font-size1);
  --jp-code-font-size: var(--jp-code-presentation-font-size);
}

.jp-mod-presentationMode .jp-Notebook .jp-Cell .jp-InputPrompt,
.jp-mod-presentationMode .jp-Notebook .jp-Cell .jp-OutputPrompt {
  flex: 0 0 110px;
}

/*-----------------------------------------------------------------------------
| Side-by-side Mode (.jp-mod-sideBySide)
|----------------------------------------------------------------------------*/
.jp-mod-sideBySide.jp-Notebook .jp-Notebook-cell {
  margin-top: 3em;
  margin-bottom: 3em;
  margin-left: 5%;
  margin-right: 5%;
}

.jp-mod-sideBySide.jp-Notebook .jp-CodeCell {
  display: grid;
  grid-template-columns: minmax(0, 1fr) min-content minmax(
      0,
      var(--jp-side-by-side-output-size)
    );
  grid-template-rows: auto minmax(0, 1fr) auto;
  grid-template-areas:
    'header header header'
    'input handle output'
    'footer footer footer';
}

.jp-mod-sideBySide.jp-Notebook .jp-CodeCell.jp-mod-resizedCell {
  grid-template-columns: minmax(0, 1fr) min-content minmax(
      0,
      var(--jp-side-by-side-resized-cell)
    );
}

.jp-mod-sideBySide.jp-Notebook .jp-CodeCell .jp-CellHeader {
  grid-area: header;
}

.jp-mod-sideBySide.jp-Notebook .jp-CodeCell .jp-Cell-inputWrapper {
  grid-area: input;
}

.jp-mod-sideBySide.jp-Notebook .jp-CodeCell .jp-Cell-outputWrapper {
  /* overwrite the default margin (no vertical separation needed in side by side move */
  margin-top: 0;
  grid-area: output;
}

.jp-mod-sideBySide.jp-Notebook .jp-CodeCell .jp-CellFooter {
  grid-area: footer;
}

.jp-mod-sideBySide.jp-Notebook .jp-CodeCell .jp-CellResizeHandle {
  grid-area: handle;
  user-select: none;
  display: block;
  height: 100%;
  cursor: ew-resize;
  padding: 0 var(--jp-cell-padding);
}

.jp-mod-sideBySide.jp-Notebook .jp-CodeCell .jp-CellResizeHandle::after {
  content: '';
  display: block;
  background: var(--jp-border-color2);
  height: 100%;
  width: 5px;
}

.jp-mod-sideBySide.jp-Notebook
  .jp-CodeCell.jp-mod-resizedCell
  .jp-CellResizeHandle::after {
  background: var(--jp-border-color0);
}

.jp-CellResizeHandle {
  display: none;
}

/*-----------------------------------------------------------------------------
| Placeholder
|----------------------------------------------------------------------------*/

.jp-Cell-Placeholder {
  padding-left: 55px;
}

.jp-Cell-Placeholder-wrapper {
  background: #fff;
  border: 1px solid;
  border-color: #e5e6e9 #dfe0e4 #d0d1d5;
  border-radius: 4px;
  -webkit-border-radius: 4px;
  margin: 10px 15px;
}

.jp-Cell-Placeholder-wrapper-inner {
  padding: 15px;
  position: relative;
}

.jp-Cell-Placeholder-wrapper-body {
  background-repeat: repeat;
  background-size: 50% auto;
}

.jp-Cell-Placeholder-wrapper-body div {
  background: #f6f7f8;
  background-image: -webkit-linear-gradient(
    left,
    #f6f7f8 0%,
    #edeef1 20%,
    #f6f7f8 40%,
    #f6f7f8 100%
  );
  background-repeat: no-repeat;
  background-size: 800px 104px;
  height: 104px;
  position: absolute;
  right: 15px;
  left: 15px;
  top: 15px;
}

div.jp-Cell-Placeholder-h1 {
  top: 20px;
  height: 20px;
  left: 15px;
  width: 150px;
}

div.jp-Cell-Placeholder-h2 {
  left: 15px;
  top: 50px;
  height: 10px;
  width: 100px;
}

div.jp-Cell-Placeholder-content-1,
div.jp-Cell-Placeholder-content-2,
div.jp-Cell-Placeholder-content-3 {
  left: 15px;
  right: 15px;
  height: 10px;
}

div.jp-Cell-Placeholder-content-1 {
  top: 100px;
}

div.jp-Cell-Placeholder-content-2 {
  top: 120px;
}

div.jp-Cell-Placeholder-content-3 {
  top: 140px;
}

</style>
<style type="text/css">
/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/*
The following CSS variables define the main, public API for styling JupyterLab.
These variables should be used by all plugins wherever possible. In other
words, plugins should not define custom colors, sizes, etc unless absolutely
necessary. This enables users to change the visual theme of JupyterLab
by changing these variables.

Many variables appear in an ordered sequence (0,1,2,3). These sequences
are designed to work well together, so for example, `--jp-border-color1` should
be used with `--jp-layout-color1`. The numbers have the following meanings:

* 0: super-primary, reserved for special emphasis
* 1: primary, most important under normal situations
* 2: secondary, next most important under normal situations
* 3: tertiary, next most important under normal situations

Throughout JupyterLab, we are mostly following principles from Google's
Material Design when selecting colors. We are not, however, following
all of MD as it is not optimized for dense, information rich UIs.
*/

:root {
  /* Elevation
   *
   * We style box-shadows using Material Design's idea of elevation. These particular numbers are taken from here:
   *
   * https://github.com/material-components/material-components-web
   * https://material-components-web.appspot.com/elevation.html
   */

  --jp-shadow-base-lightness: 0;
  --jp-shadow-umbra-color: rgba(
    var(--jp-shadow-base-lightness),
    var(--jp-shadow-base-lightness),
    var(--jp-shadow-base-lightness),
    0.2
  );
  --jp-shadow-penumbra-color: rgba(
    var(--jp-shadow-base-lightness),
    var(--jp-shadow-base-lightness),
    var(--jp-shadow-base-lightness),
    0.14
  );
  --jp-shadow-ambient-color: rgba(
    var(--jp-shadow-base-lightness),
    var(--jp-shadow-base-lightness),
    var(--jp-shadow-base-lightness),
    0.12
  );
  --jp-elevation-z0: none;
  --jp-elevation-z1: 0 2px 1px -1px var(--jp-shadow-umbra-color),
    0 1px 1px 0 var(--jp-shadow-penumbra-color),
    0 1px 3px 0 var(--jp-shadow-ambient-color);
  --jp-elevation-z2: 0 3px 1px -2px var(--jp-shadow-umbra-color),
    0 2px 2px 0 var(--jp-shadow-penumbra-color),
    0 1px 5px 0 var(--jp-shadow-ambient-color);
  --jp-elevation-z4: 0 2px 4px -1px var(--jp-shadow-umbra-color),
    0 4px 5px 0 var(--jp-shadow-penumbra-color),
    0 1px 10px 0 var(--jp-shadow-ambient-color);
  --jp-elevation-z6: 0 3px 5px -1px var(--jp-shadow-umbra-color),
    0 6px 10px 0 var(--jp-shadow-penumbra-color),
    0 1px 18px 0 var(--jp-shadow-ambient-color);
  --jp-elevation-z8: 0 5px 5px -3px var(--jp-shadow-umbra-color),
    0 8px 10px 1px var(--jp-shadow-penumbra-color),
    0 3px 14px 2px var(--jp-shadow-ambient-color);
  --jp-elevation-z12: 0 7px 8px -4px var(--jp-shadow-umbra-color),
    0 12px 17px 2px var(--jp-shadow-penumbra-color),
    0 5px 22px 4px var(--jp-shadow-ambient-color);
  --jp-elevation-z16: 0 8px 10px -5px var(--jp-shadow-umbra-color),
    0 16px 24px 2px var(--jp-shadow-penumbra-color),
    0 6px 30px 5px var(--jp-shadow-ambient-color);
  --jp-elevation-z20: 0 10px 13px -6px var(--jp-shadow-umbra-color),
    0 20px 31px 3px var(--jp-shadow-penumbra-color),
    0 8px 38px 7px var(--jp-shadow-ambient-color);
  --jp-elevation-z24: 0 11px 15px -7px var(--jp-shadow-umbra-color),
    0 24px 38px 3px var(--jp-shadow-penumbra-color),
    0 9px 46px 8px var(--jp-shadow-ambient-color);

  /* Borders
   *
   * The following variables, specify the visual styling of borders in JupyterLab.
   */

  --jp-border-width: 1px;
  --jp-border-color0: var(--md-grey-400);
  --jp-border-color1: var(--md-grey-400);
  --jp-border-color2: var(--md-grey-300);
  --jp-border-color3: var(--md-grey-200);
  --jp-inverse-border-color: var(--md-grey-600);
  --jp-border-radius: 2px;

  /* UI Fonts
   *
   * The UI font CSS variables are used for the typography all of the JupyterLab
   * user interface elements that are not directly user generated content.
   *
   * The font sizing here is done assuming that the body font size of --jp-ui-font-size1
   * is applied to a parent element. When children elements, such as headings, are sized
   * in em all things will be computed relative to that body size.
   */

  --jp-ui-font-scale-factor: 1.2;
  --jp-ui-font-size0: 0.83333em;
  --jp-ui-font-size1: 13px; /* Base font size */
  --jp-ui-font-size2: 1.2em;
  --jp-ui-font-size3: 1.44em;
  --jp-ui-font-family: system-ui, -apple-system, blinkmacsystemfont, 'Segoe UI',
    helvetica, arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji',
    'Segoe UI Symbol';

  /*
   * Use these font colors against the corresponding main layout colors.
   * In a light theme, these go from dark to light.
   */

  /* Defaults use Material Design specification */
  --jp-ui-font-color0: rgba(0, 0, 0, 1);
  --jp-ui-font-color1: rgba(0, 0, 0, 0.87);
  --jp-ui-font-color2: rgba(0, 0, 0, 0.54);
  --jp-ui-font-color3: rgba(0, 0, 0, 0.38);

  /*
   * Use these against the brand/accent/warn/error colors.
   * These will typically go from light to darker, in both a dark and light theme.
   */

  --jp-ui-inverse-font-color0: rgba(255, 255, 255, 1);
  --jp-ui-inverse-font-color1: rgba(255, 255, 255, 1);
  --jp-ui-inverse-font-color2: rgba(255, 255, 255, 0.7);
  --jp-ui-inverse-font-color3: rgba(255, 255, 255, 0.5);

  /* Content Fonts
   *
   * Content font variables are used for typography of user generated content.
   *
   * The font sizing here is done assuming that the body font size of --jp-content-font-size1
   * is applied to a parent element. When children elements, such as headings, are sized
   * in em all things will be computed relative to that body size.
   */

  --jp-content-line-height: 1.6;
  --jp-content-font-scale-factor: 1.2;
  --jp-content-font-size0: 0.83333em;
  --jp-content-font-size1: 14px; /* Base font size */
  --jp-content-font-size2: 1.2em;
  --jp-content-font-size3: 1.44em;
  --jp-content-font-size4: 1.728em;
  --jp-content-font-size5: 2.0736em;

  /* This gives a magnification of about 125% in presentation mode over normal. */
  --jp-content-presentation-font-size1: 17px;
  --jp-content-heading-line-height: 1;
  --jp-content-heading-margin-top: 1.2em;
  --jp-content-heading-margin-bottom: 0.8em;
  --jp-content-heading-font-weight: 500;

  /* Defaults use Material Design specification */
  --jp-content-font-color0: rgba(0, 0, 0, 1);
  --jp-content-font-color1: rgba(0, 0, 0, 0.87);
  --jp-content-font-color2: rgba(0, 0, 0, 0.54);
  --jp-content-font-color3: rgba(0, 0, 0, 0.38);
  --jp-content-link-color: var(--md-blue-900);
  --jp-content-font-family: system-ui, -apple-system, blinkmacsystemfont,
    'Segoe UI', helvetica, arial, sans-serif, 'Apple Color Emoji',
    'Segoe UI Emoji', 'Segoe UI Symbol';

  /*
   * Code Fonts
   *
   * Code font variables are used for typography of code and other monospaces content.
   */

  --jp-code-font-size: 13px;
  --jp-code-line-height: 1.3077; /* 17px for 13px base */
  --jp-code-padding: 5px; /* 5px for 13px base, codemirror highlighting needs integer px value */
  --jp-code-font-family-default: menlo, consolas, 'DejaVu Sans Mono', monospace;
  --jp-code-font-family: var(--jp-code-font-family-default);

  /* This gives a magnification of about 125% in presentation mode over normal. */
  --jp-code-presentation-font-size: 16px;

  /* may need to tweak cursor width if you change font size */
  --jp-code-cursor-width0: 1.4px;
  --jp-code-cursor-width1: 2px;
  --jp-code-cursor-width2: 4px;

  /* Layout
   *
   * The following are the main layout colors use in JupyterLab. In a light
   * theme these would go from light to dark.
   */

  --jp-layout-color0: white;
  --jp-layout-color1: white;
  --jp-layout-color2: var(--md-grey-200);
  --jp-layout-color3: var(--md-grey-400);
  --jp-layout-color4: var(--md-grey-600);

  /* Inverse Layout
   *
   * The following are the inverse layout colors use in JupyterLab. In a light
   * theme these would go from dark to light.
   */

  --jp-inverse-layout-color0: #111;
  --jp-inverse-layout-color1: var(--md-grey-900);
  --jp-inverse-layout-color2: var(--md-grey-800);
  --jp-inverse-layout-color3: var(--md-grey-700);
  --jp-inverse-layout-color4: var(--md-grey-600);

  /* Brand/accent */

  --jp-brand-color0: var(--md-blue-900);
  --jp-brand-color1: var(--md-blue-700);
  --jp-brand-color2: var(--md-blue-300);
  --jp-brand-color3: var(--md-blue-100);
  --jp-brand-color4: var(--md-blue-50);
  --jp-accent-color0: var(--md-green-900);
  --jp-accent-color1: var(--md-green-700);
  --jp-accent-color2: var(--md-green-300);
  --jp-accent-color3: var(--md-green-100);

  /* State colors (warn, error, success, info) */

  --jp-warn-color0: var(--md-orange-900);
  --jp-warn-color1: var(--md-orange-700);
  --jp-warn-color2: var(--md-orange-300);
  --jp-warn-color3: var(--md-orange-100);
  --jp-error-color0: var(--md-red-900);
  --jp-error-color1: var(--md-red-700);
  --jp-error-color2: var(--md-red-300);
  --jp-error-color3: var(--md-red-100);
  --jp-success-color0: var(--md-green-900);
  --jp-success-color1: var(--md-green-700);
  --jp-success-color2: var(--md-green-300);
  --jp-success-color3: var(--md-green-100);
  --jp-info-color0: var(--md-cyan-900);
  --jp-info-color1: var(--md-cyan-700);
  --jp-info-color2: var(--md-cyan-300);
  --jp-info-color3: var(--md-cyan-100);

  /* Cell specific styles */

  --jp-cell-padding: 5px;
  --jp-cell-collapser-width: 8px;
  --jp-cell-collapser-min-height: 20px;
  --jp-cell-collapser-not-active-hover-opacity: 0.6;
  --jp-cell-editor-background: var(--md-grey-100);
  --jp-cell-editor-border-color: var(--md-grey-300);
  --jp-cell-editor-box-shadow: inset 0 0 2px var(--md-blue-300);
  --jp-cell-editor-active-background: var(--jp-layout-color0);
  --jp-cell-editor-active-border-color: var(--jp-brand-color1);
  --jp-cell-prompt-width: 64px;
  --jp-cell-prompt-font-family: var(--jp-code-font-family-default);
  --jp-cell-prompt-letter-spacing: 0;
  --jp-cell-prompt-opacity: 1;
  --jp-cell-prompt-not-active-opacity: 0.5;
  --jp-cell-prompt-not-active-font-color: var(--md-grey-700);

  /* A custom blend of MD grey and blue 600
   * See https://meyerweb.com/eric/tools/color-blend/#546E7A:1E88E5:5:hex */
  --jp-cell-inprompt-font-color: #307fc1;

  /* A custom blend of MD grey and orange 600
   * https://meyerweb.com/eric/tools/color-blend/#546E7A:F4511E:5:hex */
  --jp-cell-outprompt-font-color: #bf5b3d;

  /* Notebook specific styles */

  --jp-notebook-padding: 10px;
  --jp-notebook-select-background: var(--jp-layout-color1);
  --jp-notebook-multiselected-color: var(--md-blue-50);

  /* The scroll padding is calculated to fill enough space at the bottom of the
  notebook to show one single-line cell (with appropriate padding) at the top
  when the notebook is scrolled all the way to the bottom. We also subtract one
  pixel so that no scrollbar appears if we have just one single-line cell in the
  notebook. This padding is to enable a 'scroll past end' feature in a notebook.
  */
  --jp-notebook-scroll-padding: calc(
    100% - var(--jp-code-font-size) * var(--jp-code-line-height) -
      var(--jp-code-padding) - var(--jp-cell-padding) - 1px
  );

  /* Rendermime styles */

  --jp-rendermime-error-background: #fdd;
  --jp-rendermime-table-row-background: var(--md-grey-100);
  --jp-rendermime-table-row-hover-background: var(--md-light-blue-50);

  /* Dialog specific styles */

  --jp-dialog-background: rgba(0, 0, 0, 0.25);

  /* Console specific styles */

  --jp-console-padding: 10px;

  /* Toolbar specific styles */

  --jp-toolbar-border-color: var(--jp-border-color1);
  --jp-toolbar-micro-height: 8px;
  --jp-toolbar-background: var(--jp-layout-color1);
  --jp-toolbar-box-shadow: 0 0 2px 0 rgba(0, 0, 0, 0.24);
  --jp-toolbar-header-margin: 4px 4px 0 4px;
  --jp-toolbar-active-background: var(--md-grey-300);

  /* Statusbar specific styles */

  --jp-statusbar-height: 24px;

  /* Input field styles */

  --jp-input-box-shadow: inset 0 0 2px var(--md-blue-300);
  --jp-input-active-background: var(--jp-layout-color1);
  --jp-input-hover-background: var(--jp-layout-color1);
  --jp-input-background: var(--md-grey-100);
  --jp-input-border-color: var(--jp-inverse-border-color);
  --jp-input-active-border-color: var(--jp-brand-color1);
  --jp-input-active-box-shadow-color: rgba(19, 124, 189, 0.3);

  /* General editor styles */

  --jp-editor-selected-background: #d9d9d9;
  --jp-editor-selected-focused-background: #d7d4f0;
  --jp-editor-cursor-color: var(--jp-ui-font-color0);

  /* Code mirror specific styles */

  --jp-mirror-editor-keyword-color: #008000;
  --jp-mirror-editor-atom-color: #88f;
  --jp-mirror-editor-number-color: #080;
  --jp-mirror-editor-def-color: #00f;
  --jp-mirror-editor-variable-color: var(--md-grey-900);
  --jp-mirror-editor-variable-2-color: rgb(0, 54, 109);
  --jp-mirror-editor-variable-3-color: #085;
  --jp-mirror-editor-punctuation-color: #05a;
  --jp-mirror-editor-property-color: #05a;
  --jp-mirror-editor-operator-color: #a2f;
  --jp-mirror-editor-comment-color: #408080;
  --jp-mirror-editor-string-color: #ba2121;
  --jp-mirror-editor-string-2-color: #708;
  --jp-mirror-editor-meta-color: #a2f;
  --jp-mirror-editor-qualifier-color: #555;
  --jp-mirror-editor-builtin-color: #008000;
  --jp-mirror-editor-bracket-color: #997;
  --jp-mirror-editor-tag-color: #170;
  --jp-mirror-editor-attribute-color: #00c;
  --jp-mirror-editor-header-color: blue;
  --jp-mirror-editor-quote-color: #090;
  --jp-mirror-editor-link-color: #00c;
  --jp-mirror-editor-error-color: #f00;
  --jp-mirror-editor-hr-color: #999;

  /*
    RTC user specific colors.
    These colors are used for the cursor, username in the editor,
    and the icon of the user.
  */

  --jp-collaborator-color1: #ffad8e;
  --jp-collaborator-color2: #dac83d;
  --jp-collaborator-color3: #72dd76;
  --jp-collaborator-color4: #00e4d0;
  --jp-collaborator-color5: #45d4ff;
  --jp-collaborator-color6: #e2b1ff;
  --jp-collaborator-color7: #ff9de6;

  /* Vega extension styles */

  --jp-vega-background: white;

  /* Sidebar-related styles */

  --jp-sidebar-min-width: 250px;

  /* Search-related styles */

  --jp-search-toggle-off-opacity: 0.5;
  --jp-search-toggle-hover-opacity: 0.8;
  --jp-search-toggle-on-opacity: 1;
  --jp-search-selected-match-background-color: rgb(245, 200, 0);
  --jp-search-selected-match-color: black;
  --jp-search-unselected-match-background-color: var(
    --jp-inverse-layout-color0
  );
  --jp-search-unselected-match-color: var(--jp-ui-inverse-font-color0);

  /* Icon colors that work well with light or dark backgrounds */
  --jp-icon-contrast-color0: var(--md-purple-600);
  --jp-icon-contrast-color1: var(--md-green-600);
  --jp-icon-contrast-color2: var(--md-pink-600);
  --jp-icon-contrast-color3: var(--md-blue-600);

  /* Button colors */
  --jp-accept-color-normal: var(--md-blue-700);
  --jp-accept-color-hover: var(--md-blue-800);
  --jp-accept-color-active: var(--md-blue-900);
  --jp-warn-color-normal: var(--md-red-700);
  --jp-warn-color-hover: var(--md-red-800);
  --jp-warn-color-active: var(--md-red-900);
  --jp-reject-color-normal: var(--md-grey-600);
  --jp-reject-color-hover: var(--md-grey-700);
  --jp-reject-color-active: var(--md-grey-800);

  /* File or activity icons and switch semantic variables */
  --jp-jupyter-icon-color: #f37626;
  --jp-notebook-icon-color: #f37626;
  --jp-json-icon-color: var(--md-orange-700);
  --jp-console-icon-background-color: var(--md-blue-700);
  --jp-console-icon-color: white;
  --jp-terminal-icon-background-color: var(--md-grey-800);
  --jp-terminal-icon-color: var(--md-grey-200);
  --jp-text-editor-icon-color: var(--md-grey-700);
  --jp-inspector-icon-color: var(--md-grey-700);
  --jp-switch-color: var(--md-grey-400);
  --jp-switch-true-position-color: var(--md-orange-900);
}
</style>
<style type="text/css">
/* Force rendering true colors when outputing to pdf */
* {
  -webkit-print-color-adjust: exact;
}

/* Misc */
a.anchor-link {
  display: none;
}

/* Input area styling */
.jp-InputArea {
  overflow: hidden;
}

.jp-InputArea-editor {
  overflow: hidden;
}

.cm-editor.cm-s-jupyter .highlight pre {
/* weird, but --jp-code-padding defined to be 5px but 4px horizontal padding is hardcoded for pre.cm-line */
  padding: var(--jp-code-padding) 4px;
  margin: 0;

  font-family: inherit;
  font-size: inherit;
  line-height: inherit;
  color: inherit;

}

.jp-OutputArea-output pre {
  line-height: inherit;
  font-family: inherit;
}

.jp-RenderedText pre {
  color: var(--jp-content-font-color1);
  font-size: var(--jp-code-font-size);
}

/* Hiding the collapser by default */
.jp-Collapser {
  display: none;
}

@page {
    margin: 0.5in; /* Margin for each printed piece of paper */
}

@media print {
  .jp-Cell-inputWrapper,
  .jp-Cell-outputWrapper {
    display: block;
  }
}
</style>
<!-- Load mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS_CHTML-full,Safe"> </script>
<!-- MathJax configuration -->
<script type="text/x-mathjax-config">
    init_mathjax = function() {
        if (window.MathJax) {
        // MathJax loaded
            MathJax.Hub.Config({
                TeX: {
                    equationNumbers: {
                    autoNumber: "AMS",
                    useLabelIds: true
                    }
                },
                tex2jax: {
                    inlineMath: [ ['$','$'], ["\\(","\\)"] ],
                    displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
                    processEscapes: true,
                    processEnvironments: true
                },
                displayAlign: 'center',
                CommonHTML: {
                    linebreaks: {
                    automatic: true
                    }
                }
            });

            MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
        }
    }
    init_mathjax();
    </script>
<!-- End of mathjax configuration --><script type="module">
  document.addEventListener("DOMContentLoaded", async () => {
    const diagrams = document.querySelectorAll(".jp-Mermaid > pre.mermaid");
    // do not load mermaidjs if not needed
    if (!diagrams.length) {
      return;
    }
    const mermaid = (await import("https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.7.0/mermaid.esm.min.mjs")).default;
    const parser = new DOMParser();

    mermaid.initialize({
      maxTextSize: 100000,
      maxEdges: 100000,
      startOnLoad: false,
      fontFamily: window
        .getComputedStyle(document.body)
        .getPropertyValue("--jp-ui-font-family"),
      theme: document.querySelector("body[data-jp-theme-light='true']")
        ? "default"
        : "dark",
    });

    let _nextMermaidId = 0;

    function makeMermaidImage(svg) {
      const img = document.createElement("img");
      const doc = parser.parseFromString(svg, "image/svg+xml");
      const svgEl = doc.querySelector("svg");
      const { maxWidth } = svgEl?.style || {};
      const firstTitle = doc.querySelector("title");
      const firstDesc = doc.querySelector("desc");

      img.setAttribute("src", `data:image/svg+xml,${encodeURIComponent(svg)}`);
      if (maxWidth) {
        img.width = parseInt(maxWidth);
      }
      if (firstTitle) {
        img.setAttribute("alt", firstTitle.textContent);
      }
      if (firstDesc) {
        const caption = document.createElement("figcaption");
        caption.className = "sr-only";
        caption.textContent = firstDesc.textContent;
        return [img, caption];
      }
      return [img];
    }

    async function makeMermaidError(text) {
      let errorMessage = "";
      try {
        await mermaid.parse(text);
      } catch (err) {
        errorMessage = `${err}`;
      }

      const result = document.createElement("details");
      result.className = 'jp-RenderedMermaid-Details';
      const summary = document.createElement("summary");
      summary.className = 'jp-RenderedMermaid-Summary';
      const pre = document.createElement("pre");
      const code = document.createElement("code");
      code.innerText = text;
      pre.appendChild(code);
      summary.appendChild(pre);
      result.appendChild(summary);

      const warning = document.createElement("pre");
      warning.innerText = errorMessage;
      result.appendChild(warning);
      return [result];
    }

    async function renderOneMarmaid(src) {
      const id = `jp-mermaid-${_nextMermaidId++}`;
      const parent = src.parentNode;
      let raw = src.textContent.trim();
      const el = document.createElement("div");
      el.style.visibility = "hidden";
      document.body.appendChild(el);
      let results = null;
      let output = null;
      try {
        let { svg } = await mermaid.render(id, raw, el);
        svg = cleanMermaidSvg(svg);
        results = makeMermaidImage(svg);
        output = document.createElement("figure");
        results.map(output.appendChild, output);
      } catch (err) {
        parent.classList.add("jp-mod-warning");
        results = await makeMermaidError(raw);
        output = results[0];
      } finally {
        el.remove();
      }
      parent.classList.add("jp-RenderedMermaid");
      parent.appendChild(output);
    }


    /**
     * Post-process to ensure mermaid diagrams contain only valid SVG and XHTML.
     */
    function cleanMermaidSvg(svg) {
      return svg.replace(RE_VOID_ELEMENT, replaceVoidElement);
    }


    /**
     * A regular expression for all void elements, which may include attributes and
     * a slash.
     *
     * @see https://developer.mozilla.org/en-US/docs/Glossary/Void_element
     *
     * Of these, only `<br>` is generated by Mermaid in place of `\n`,
     * but _any_ "malformed" tag will break the SVG rendering entirely.
     */
    const RE_VOID_ELEMENT =
      /<\s*(area|base|br|col|embed|hr|img|input|link|meta|param|source|track|wbr)\s*([^>]*?)\s*>/gi;

    /**
     * Ensure a void element is closed with a slash, preserving any attributes.
     */
    function replaceVoidElement(match, tag, rest) {
      rest = rest.trim();
      if (!rest.endsWith('/')) {
        rest = `${rest} /`;
      }
      return `<${tag} ${rest}>`;
    }

    void Promise.all([...diagrams].map(renderOneMarmaid));
  });
</script>
<style>
  .jp-Mermaid:not(.jp-RenderedMermaid) {
    display: none;
  }

  .jp-RenderedMermaid {
    overflow: auto;
    display: flex;
  }

  .jp-RenderedMermaid.jp-mod-warning {
    width: auto;
    padding: 0.5em;
    margin-top: 0.5em;
    border: var(--jp-border-width) solid var(--jp-warn-color2);
    border-radius: var(--jp-border-radius);
    color: var(--jp-ui-font-color1);
    font-size: var(--jp-ui-font-size1);
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  .jp-RenderedMermaid figure {
    margin: 0;
    overflow: auto;
    max-width: 100%;
  }

  .jp-RenderedMermaid img {
    max-width: 100%;
  }

  .jp-RenderedMermaid-Details > pre {
    margin-top: 1em;
  }

  .jp-RenderedMermaid-Summary {
    color: var(--jp-warn-color2);
  }

  .jp-RenderedMermaid:not(.jp-mod-warning) pre {
    display: none;
  }

  .jp-RenderedMermaid-Summary > pre {
    display: inline-block;
    white-space: normal;
  }
</style>
<!-- End of mermaid configuration --></head>
<body class="jp-Notebook" data-jp-theme-light="true" data-jp-theme-name="JupyterLab Light">
<main><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=1023c4a7-a378-4ac2-a88e-fecc9a59d765">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[1]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Current directory:"</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Current directory: C:\Windows\System32
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=94d11789-0791-4756-b0f1-6142b2653f27">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h1 id="DML:">DML:<a class="anchor-link" href="#DML:"></a></h1>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=e6c90a93-4b16-4ed0-b2e7-985448b2fdb3">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[2]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">"ignore"</span><span class="p">)</span>  <span class="c1"># optional</span>

<span class="c1"># Option 1 (recommended)</span>
<span class="n">new_path</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">"D:\Work\PTSD_Followup\DML"</span>

<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">new_path</span><span class="p">)</span>  <span class="c1"># Change working directory</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Changed to:"</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Changed to: D:\Work\PTSD_Followup\DML
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=2b2ef094-c824-4279-b898-719c211cc4a8">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[3]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">r</span><span class="s2">"data_baseline.csv"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=d590acf7-a693-4000-8042-e96cddf95f3e">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[4]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># Check missing values for each variable</span>
<span class="n">missing_summary</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC_missing'</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD_missing'</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
    <span class="s1">'Bipolar_and_Mood_disorder_missing'</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">'Bipolar_and_Mood_disorder'</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER_missing'</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
    <span class="s1">'total_rows'</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"Missing values summary:"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">missing_summary</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Missing values summary:
DIAGNOSIS_PSYCHOTIC_missing: 2484
DIAGNOSIS_ANXIETY_OCD_missing: 2484
Bipolar_and_Mood_disorder_missing: 2484
DIAGNOSIS_EATING_DISORDER_missing: 2484
total_rows: 6125
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=56024911-29cb-4f8b-993f-c1bd2223f19b">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[5]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Define the mental health variables</span>
<span class="n">mental_health_vars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span> 
                      <span class="s1">'Bipolar_and_Mood_disorder'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">]</span>

<span class="c1"># Check patients with missing data on any of the 4 variables</span>
<span class="n">df</span><span class="p">[</span><span class="s1">'has_missing'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">mental_health_vars</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Summary of missing pattern</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Missing data pattern:"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">'has_missing'</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Patients with missing data: </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="s1">'has_missing'</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Patients with complete data: </span><span class="si">{</span><span class="p">(</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s1">'has_missing'</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
Missing data pattern:
has_missing
False    3641
True     2484
Name: count, dtype: int64
Patients with missing data: 2484
Patients with complete data: 3641
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=35c8499f-923c-41f2-b652-3f73e7694412">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[6]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Store original count before filtering</span>
<span class="n">original_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="c1"># Filter to keep only complete cases (this modifies df)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">mental_health_vars</span><span class="p">)</span>

<span class="c1"># Get the count after filtering</span>
<span class="n">complete_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="c1"># Calculate excluded count</span>
<span class="n">excluded_count</span> <span class="o">=</span> <span class="n">original_count</span> <span class="o">-</span> <span class="n">complete_count</span>

<span class="c1"># Verify the counts</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Dataset summary:"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Original dataset: </span><span class="si">{</span><span class="n">original_count</span><span class="si">}</span><span class="s2"> observations"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Complete cases: </span><span class="si">{</span><span class="n">complete_count</span><span class="si">}</span><span class="s2"> observations"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Excluded (missing): </span><span class="si">{</span><span class="n">excluded_count</span><span class="si">}</span><span class="s2"> observations"</span><span class="p">)</span>

<span class="c1"># Remove the temporary column (if it exists)</span>
<span class="k">if</span> <span class="s1">'has_missing'</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">'has_missing'</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
Dataset summary:
Original dataset: 6125 observations
Complete cases: 3641 observations
Excluded (missing): 2484 observations
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=a7b06ffb-57fe-4c65-ab21-abcc8b612e6c">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[7]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Check the 4 variables you filtered on (should be 0 missing)</span>
<span class="n">mental_health_vars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span> 
                      <span class="s1">'Bipolar_and_Mood_disorder'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Missing values in mental health variables:"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">mental_health_vars</span><span class="p">:</span>
    <span class="n">missing</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
Missing values in mental health variables:
DIAGNOSIS_PSYCHOTIC: 0
DIAGNOSIS_ANXIETY_OCD: 0
Bipolar_and_Mood_disorder: 0
DIAGNOSIS_EATING_DISORDER: 0
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=7383c16b-bf42-43cd-9e4b-3db434a0a41b">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[8]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Step 1: Identify columns by prefix</span>
<span class="n">cat_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'CAT_'</span><span class="p">)]</span>
<span class="n">subcat_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'SUBCAT_'</span><span class="p">)]</span>
<span class="n">subsubcat_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'SubSubCat_'</span><span class="p">)]</span>

<span class="c1"># Step 2: Print counts</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Number of CAT_ columns: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cat_cols</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Number of SUBCAT_ columns: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">subcat_cols</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Number of SubSubCat_ columns: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">subsubcat_cols</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># Step 3: Column-wise sums</span>
<span class="n">cat_sums</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">cat_cols</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">subcat_sums</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">subcat_cols</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">subsubcat_sums</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">subsubcat_cols</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Step 4: Convert to DataFrames</span>
<span class="n">cat_df</span> <span class="o">=</span> <span class="n">cat_sums</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">cat_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'Column'</span><span class="p">,</span> <span class="s1">'Sum'</span><span class="p">]</span>

<span class="n">subcat_df</span> <span class="o">=</span> <span class="n">subcat_sums</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">subcat_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'Column'</span><span class="p">,</span> <span class="s1">'Sum'</span><span class="p">]</span>

<span class="n">subsubcat_df</span> <span class="o">=</span> <span class="n">subsubcat_sums</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">subsubcat_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'Column'</span><span class="p">,</span> <span class="s1">'Sum'</span><span class="p">]</span>

<span class="c1"># Step 5: Write to Excel</span>
<span class="k">with</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelWriter</span><span class="p">(</span><span class="s2">"category_column_sums.xlsx"</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
    <span class="n">cat_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="s2">"CAT_Sums"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">subcat_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="s2">"SUBCAT_Sums"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">subsubcat_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="s2">"SubSubCat_Sums"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">" Exported to 'category_column_sums.xlsx'"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Number of CAT_ columns: 23
Number of SUBCAT_ columns: 42
Number of SubSubCat_ columns: 243
 Exported to 'category_column_sums.xlsx'
</pre>
</div>
</div>
</div>
</div>
</div>These below CAT, SUBCAT, and SubSubCat are do not have more than 30 treatment groups.
Hence, we will not consider these onces.

CAT_Anticonceptiva
CAT_Immunomodulerende_middelen
CAT_Migrainemiddelen
CAT_Stemmingsstabilisatoren
CAT_Salicylaat
CAT_Alcoholverslaving
CAT_Spierrelaxantia
CAT_Parkinson


SUBCAT_Anticonceptiva_klassiek
SUBCAT_Anti_epileptica_GABA_analogon
SUBCAT_Antipsychotica_Klassiek
SUBCAT_calciumantagonisten
SUBCAT_Paracetamol_overig_combinatie
SUBCAT_stemm_Lithiumzouten
SUBCAT_ACE_remmer
SUBCAT_Paracetamol_salycilaat_combinatiepreparaat
SUBCAT_Corticosteroiden
SUBCAT_Anti_epileptica_Benzodiazepine
SUBCAT_psychostimulans_overige
SUBCAT_Anti_epileptica_overig
SUBCAT_Immunomodulerend_Coxibs
SUBCAT_Interleukine_remmers
SUBCAT_Clonidine
SUBCAT_TNF_alpha_blockers
SUBCAT_Antihypertensiva_ARBs
SUBCAT_Aminosalicylaten
SUBCAT_Selectieve_immunosuppresiva
SUBCAT_MAO_remmers
SUBCAT_stemm_benzamide
SUBCAT_Antihypertensiva_centraal_aangrijpend
SUBCAT_DMARDs
SUBCAT_calcineurineremmers
SUBCAT_ADHD_klassiek
SUBCAT_Combinatiepreparaten
SUBCAT_Systemische_betablokkers



SubSubCat_Nortriptyline
SubSubCat_pil
SubSubCat_Aripiprazol
SubSubCat_Dexamfetamine
SubSubCat_Pregabaline
SubSubCat_Trazodon
SubSubCat_Oxycodon
SubSubCat_Diclofenac
SubSubCat_Risperidon
SubSubCat_Metoprolol
SubSubCat_Naproxen
SubSubCat_Antidepressiva_overige
SubSubCat_Ibuprofen
SubSubCat_Morfine
SubSubCat_Desloratadine
SubSubCat_Lithium
SubSubCat_Paracetamol_ascorbinezuur
SubSubCat_Duloxetine
SubSubCat_Amlodipine
SubSubCat_Fluvoxamine
SubSubCat_Acrivastine
SubSubCat_Propranolol
SubSubCat_Haloperidol
SubSubCat_Valpronezuur
SubSubCat_Lamotrigine
SubSubCat_Pipamperon
SubSubCat_Clomipramine
SubSubCat_Lormetazepam
SubSubCat_Midazolam
SubSubCat_Clonazepam
SubSubCat_Fexofenadine
SubSubCat_Levocetirizine
SubSubCat_Nicardipine
SubSubCat_Acetylsalicylzuur_paracetamol_coffene
SubSubCat_Pethidine
SubSubCat_Fentanyl
SubSubCat_Atomoxetine
SubSubCat_Prazepam
SubSubCat_Doxepine
SubSubCat_Enalapril
SubSubCat_Gabapentine
SubSubCat_Loratadine
SubSubCat_Bisoprolol
SubSubCat_Nitrazepam
SubSubCat_Cetirizine
SubSubCat_Levetiracetam
SubSubCat_clonidine
SubSubCat_celecoxib
SubSubCat_Etoricoxib
SubSubCat_Buspiron
SubSubCat_Lisinopril
SubSubCat_Prednison
SubSubCat_Ustekinumab
SubSubCat_Meclozine
SubSubCat_Perindopril
SubSubCat_Maprotiline
SubSubCat_Flurazepam
SubSubCat_chloorprotixeen
SubSubCat_Imipramine
SubSubCat_Vedolizumab
SubSubCat_Ebastine
SubSubCat_Clorazepinezuur
SubSubCat_Clozapine
SubSubCat_Sertindol
SubSubCat_Carbamazepine
SubSubCat_Prednisolon
SubSubCat_Antihypertensiva_ARBs
SubSubCat_Rupatadine
SubSubCat_Mesalazine
SubSubCat_Nabumeton
SubSubCat_Nebivolol
SubSubCat_Vigabatrine
SubSubCat_Eculizumab
SubSubCat_Certolizumab_pegol
SubSubCat_Adalimumab
SubSubCat_Tocilizumab
SubSubCat_safinamide
SubSubCat_Hydrocortison
SubSubCat_Ramipril
SubSubCat_Methylprednisolon
SubSubCat_Satralizumab
SubSubCat_Sulpiride
SubSubCat_Moclobemide
SubSubCat_Clevidipine
SubSubCat_Atenolol
SubSubCat_Dupilumab
SubSubCat_Clemastine
SubSubCat_Brivaracetam
SubSubCat_Lercanidipine
SubSubCat_Etanercept
SubSubCat_Meloxicam
SubSubCat_Nifedipine
SubSubCat_Fosinopril
SubSubCat_Infliximab
SubSubCat_Barnidipine
SubSubCat_Tofacitinib
SubSubCat_Mycofenolaatmofetil
SubSubCat_Mycofenolzuur
SubSubCat_Ravulizumab
SubSubCat_Sirolimus
SubSubCat_Thymocytenglobuline
SubSubCat_Anakinra
SubSubCat_Upadacitinib
SubSubCat_Basiliximab
SubSubCat_Bimekizumab
SubSubCat_Leflunomide
SubSubCat_Canakinumab
SubSubCat_Guselkumab
SubSubCat_Brodalumab
SubSubCat_Apremilast
SubSubCat_Filgotinib
SubSubCat_Everolimus
SubSubCat_Belimumab
SubSubCat_Belatacept
SubSubCat_Baricitinib
SubSubCat_Abatacept
SubSubCat_Golimumab
SubSubCat_Olsalazine
SubSubCat_Sulfasalazine
SubSubCat_Thalidomide
SubSubCat_Pomalidomide
SubSubCat_Pirfenidon
SubSubCat_Risankizumab
SubSubCat_Lenalidomide
SubSubCat_Ixekizumab
SubSubCat_Aceclofenac
SubSubCat_Sarilumab
SubSubCat_Secukinumab
SubSubCat_Methotrexaat
SubSubCat_Corticosteroiden
SubSubCat_hypnotica_Benzodiazepine
SubSubCat_Paracetamol_propyfenazon_coffene
SubSubCat_Paracetamol_coffene_ascorbinezuur
SubSubCat_Paracetamol_coffene
SubSubCat_Tiaprofeenzuur
SubSubCat_Piroxicam
SubSubCat_Metamizol
SubSubCat_Indometacine
SubSubCat_Flurbiprofen
SubSubCat_Fenylbutazon
SubSubCat_Dexketoprofen
SubSubCat_Tapentadol
SubSubCat_Sufentanil
SubSubCat_Remifentanil
SubSubCat_Piritramide
SubSubCat_Nalbufine
SubSubCat_Hydromorfon
SubSubCat_Buprenorfine
SubSubCat_Alfentanil
SubSubCat_Tacrolimus
SubSubCat_Pimecrolimus
SubSubCat_Ciclosporine
SubSubCat_Tralokinumab
SubSubCat_Tildrakizumab
SubSubCat_Siltuximab
SubSubCat_Azathioprine
SubSubCat_fluspirileen
SubSubCat_Parecoxib
SubSubCat_Bromazepam
SubSubCat_Primidon
SubSubCat_Perampanel
SubSubCat_Oxcarbazepine
SubSubCat_Lacosamide
SubSubCat_Fenobarbital
SubSubCat_Felbamaat
SubSubCat_Ethosuximide
SubSubCat_Chloralhydraat
SubSubCat_Fenytone
SubSubCat_Remimazolam
SubSubCat_Flunitrazepam
SubSubCat_Clobazam
SubSubCat_Brotizolam
SubSubCat_Hydroxyzine
SubSubCat_Triamcinolonhexacetonide
SubSubCat_Selegiline
SubSubCat_Rasagiline
SubSubCat_Dosulepine
SubSubCat_Tiapride
SubSubCat_Paliperidon
SubSubCat_Lurasidon
SubSubCat_Cariprazine
SubSubCat_Brexpiprazol
SubSubCat_Amisulpride
SubSubCat_periciazine
SubSubCat_pimozide
SubSubCat_Broomperidol
SubSubCat_Zuclopentixol
SubSubCat_Rufinamide
SubSubCat_Stiripentol
SubSubCat_Zonisamide
SubSubCat_Chloorcyclizine
SubSubCat_Triamcinolonacetonide
SubSubCat_Fludrocortison
SubSubCat_Dexamethason
SubSubCat_Cortison
SubSubCat_Moxonidine
SubSubCat_Methyldopa
SubSubCat_Guanfacine
SubSubCat_Clonidine
SubSubCat_Nimodipine
SubSubCat_Lacidipine
SubSubCat_Felodipine
SubSubCat_Zofenopril
SubSubCat_Captopril
SubSubCat_Benazepril
SubSubCat_Sotalol
SubSubCat_Landiolol
SubSubCat_Labetalol
SubSubCat_Esmolol
SubSubCat_Celiprolol
SubSubCat_Carvedilol
SubSubCat_Acebutolol
SubSubCat_Oxomemazine
SubSubCat_Mizolastine
SubSubCat_Ketotifen
SubSubCat_Doxylamine
SubSubCat_Dimetindeen
SubSubCat_Cyclizine
SubSubCat_ADHD
SubSubCat_Tramadol
SubSubCat_Loprazolam
SubSubCat_Alprazolam
SubSubCat_promethazine
SubSubCat_Paroxetine
SubSubCat_Zolpidem
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=71cfb8f5-7ba0-4bde-96b6-42e631f07681">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="CAT-analysis:">CAT analysis:<a class="anchor-link" href="#CAT-analysis:"></a></h2>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=5b9a3959-6c9a-436a-8be2-dac4f16454f8">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[9]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Import all necessary packages</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="c1"># For visualization and future steps</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="kn">from</span> <span class="nn">sklearn.experimental</span> <span class="kn">import</span> <span class="n">enable_iterative_imputer</span>  <span class="c1"># Needed to enable the experimental feature</span>
<span class="kn">from</span> <span class="nn">sklearn.impute</span> <span class="kn">import</span> <span class="n">IterativeImputer</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=7c4a4a00-1c01-4e2b-a5e6-6c123e0b6bc2">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[10]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Check basic structure</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Shape of dataset:"</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Sample columns:"</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[:</span><span class="mi">10</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Missing values:</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>

<span class="c1"># Remove duplicate rows</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>

<span class="c1"># Confirm shape after removing duplicates</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Shape after removing duplicates:"</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Shape of dataset: (3641, 465)

Sample columns: ['CIN5', 'StartDatum', 'BEH_MOD', 'BEHDAGEN_GEPLAND', 'AANTAL_PCL', 'TOESTWO', 'BEH_AFG', 'TK', 'MM_CAPS_IN', 'MM_CAPS_TK']

Missing values:
 Ecriterium_TK    3641
Eernst_TK        3641
Daantal_FU       3641
Dcriterium_FU    3641
Cernst_FU        3641
Caantal_FU       3641
Ccriterium_FU    3641
Bernst_FU        3641
Baantal_FU       3641
Bcriterium_FU    3641
dtype: int64
Shape after removing duplicates: (3641, 465)
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=dd7bb726-0877-4969-81b3-998a6663feba">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[11]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pyreadstat</span>

<span class="c1"># Load gender info</span>
<span class="n">gender_df</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">pyreadstat</span><span class="o">.</span><span class="n">read_sav</span><span class="p">(</span><span class="s2">"SDV_IN_Gender_2019_2024.sav"</span><span class="p">)</span>

<span class="c1"># Just extract SDV_SEXE column and append to df</span>
<span class="n">df</span><span class="p">[</span><span class="s2">"SDV_SEXE"</span><span class="p">]</span> <span class="o">=</span> <span class="n">gender_df</span><span class="p">[</span><span class="s2">"SDV_SEXE"</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Optional: map to labels</span>
<span class="n">gender_map</span> <span class="o">=</span> <span class="p">{</span><span class="mf">1.0</span><span class="p">:</span> <span class="s2">"Male"</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">:</span> <span class="s2">"Female"</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">:</span> <span class="s2">"Other"</span><span class="p">}</span>
<span class="n">df</span><span class="p">[</span><span class="s2">"gender_label"</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">"SDV_SEXE"</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">gender_map</span><span class="p">)</span>

<span class="c1"># Done! Check a sample</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s2">"SDV_SEXE"</span><span class="p">,</span> <span class="s2">"gender_label"</span><span class="p">]]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>SDV_SEXE  gender_label
2.0       Female          2750
1.0       Male             862
3.0       Other             29
Name: count, dtype: int64
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=e8e32268-4eb2-4ab8-9323-586bd306dd5c">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[12]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Assuming 'gender' and 'SDV_SEXE' columns are in df</span>

<span class="c1"># Gender dummy variables</span>
<span class="n">df</span><span class="p">[</span><span class="s1">'gender_1'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">'gender'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">'gender_2'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">'gender'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># SDV_SEXE dummy variables</span>
<span class="n">df</span><span class="p">[</span><span class="s1">'SDV_SEXE_1'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">'SDV_SEXE'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">'SDV_SEXE_2'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">'SDV_SEXE'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">'SDV_SEXE_3'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">'SDV_SEXE'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># Create binary columns</span>
<span class="n">df</span><span class="p">[</span><span class="s1">'ethnicity_Dutch'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">'ethnicity'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">'ethnicity_other'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">'ethnicity'</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=2a30c922-0ef4-4623-9a37-b49ce14d1995">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[13]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Columns manually identified for removal (example set from the R script)</span>
<span class="n">cols_to_drop</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'gender'</span><span class="p">,</span> <span class="s1">'ethnicity'</span><span class="p">,</span> <span class="s1">'CIN5'</span><span class="p">,</span> <span class="s1">'SDV_SEXE'</span><span class="p">,</span> <span class="s1">'StartDatum'</span><span class="p">,</span> <span class="s1">'STARTDATUM'</span><span class="p">,</span> <span class="s1">'DROPOUT_EARLYCOMPLETER'</span><span class="p">,</span> <span class="s1">'TOEST_WO'</span><span class="p">,</span>
    <span class="s1">'depressie_IN'</span><span class="p">,</span> <span class="s1">'TERUGKOMER'</span><span class="p">,</span> <span class="s1">'VROEGK_ST'</span><span class="p">,</span> <span class="s1">'gender_label'</span><span class="p">,</span>
    <span class="s1">'depr_m_psychose_huid'</span><span class="p">,</span> <span class="s1">'depr_z_psychose_huid'</span><span class="p">,</span> <span class="s1">'depr_z_psychose_verl'</span><span class="p">,</span>
    <span class="s1">'depr_m_psychose_verl'</span><span class="p">,</span> <span class="s1">'CAPS5score_followup'</span><span class="p">,</span> <span class="s1">'CAPS5_DAT_IN'</span>
<span class="p">]</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols_to_drop</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Remaining columns:"</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Remaining columns: 458
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=2928476d-1477-4f94-aef1-2ba57cc90110">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[14]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="k">if</span> <span class="s1">'BEH_DAGEN'</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">'BEH_DAGEN'</span><span class="p">:</span> <span class="s1">'treatmentdurationdays'</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=44379251-fbb1-422d-af00-1695e5bf3d52">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[15]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Clean and standardize column names</span>
<span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
    <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s2">"\.+"</span><span class="p">,</span> <span class="s2">"_"</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s2">"[^a-zA-Z0-9_]"</span><span class="p">,</span> <span class="s2">""</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">" "</span><span class="p">,</span> <span class="s2">"_"</span><span class="p">)</span>
    <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=dc51f23a-e5ac-4736-a4e1-815cffd05783">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[16]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Preview key outcome variables</span>
<span class="n">outcome_vars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'CAPS5Score_TK'</span><span class="p">]</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">outcome_vars</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2"> missing"</span><span class="p">)</span>

<span class="c1"># Calculate change score</span>
<span class="k">if</span> <span class="s1">'CAPS5score_baseline'</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s1">'CAPS5Score_TK'</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">'caps5_change_baseline'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">'CAPS5Score_TK'</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">'CAPS5score_baseline'</span><span class="p">]</span> 
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>CAPS5score_baseline: 0 missing
CAPS5Score_TK: 0 missing
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=16955012-06c6-42d3-b91d-e103338584f2">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[17]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Define exceptions to keep</span>
<span class="n">protected_cols</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">"DIAGNOSIS_ANXIETY_OCD"</span><span class="p">,</span>
    <span class="s2">"DIAGNOSIS_PSYCHOTIC"</span><span class="p">,</span>
    <span class="s2">"DIAGNOSIS_EATING_DISORDER"</span><span class="p">,</span>
    <span class="s2">"DIAGNOSIS_SUBSTANCE_DISORDER"</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"EB_NON_TF_THERAPY"</span><span class="p">,</span> <span class="s2">"OTHER_TREATM_APPROACH"</span><span class="p">,</span> <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s1">'SUBCAT_Selectieve_immunosuppresiva'</span><span class="p">,</span> <span class="s1">'treatmentdurationdays'</span><span class="p">,</span>
<span class="s1">'SUBCAT_Corticosteroiden'</span><span class="p">,</span>
<span class="s1">'SUBCAT_Immunomodulerend_Coxibs'</span><span class="p">,</span>
<span class="s1">'SUBCAT_Aminosalicylaten'</span><span class="p">,</span>
<span class="s1">'SUBCAT_calcineurineremmers'</span><span class="p">,</span>
<span class="s1">'SUBCAT_Anti_epileptica_Benzodiazepine'</span><span class="p">,</span>
<span class="s1">'SUBCAT_Paracetamol_overig_combinatie'</span><span class="p">,</span> <span class="s1">'SUBCAT_MAO_remmers'</span><span class="p">,</span> <span class="s1">'SUBCAT_psychostimulans_overige'</span><span class="p">,</span> <span class="s1">'SUBCAT_Interleukine_remmers'</span>

<span class="p">]</span>


<span class="c1"># ----------------------------------------</span>
<span class="c1"># 1. Drop columns with &gt;95% missing values (except protected)</span>
<span class="n">thresh_missing</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.95</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
<span class="n">missing_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">-</span> <span class="n">thresh_missing</span><span class="p">)]</span>
<span class="n">missing_cols_to_drop</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">missing_cols</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">protected_cols</span><span class="p">]</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">missing_cols_to_drop</span><span class="p">)</span>

<span class="c1"># ----------------------------------------</span>
<span class="c1"># 2. Drop near-zero variance columns (except protected)</span>
<span class="n">low_variance_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">(</span><span class="n">dropna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">protected_cols</span><span class="p">]</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">low_variance_cols</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=fab9270e-9e84-4999-9cf9-6d3d6781c224">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[18]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">"cleaned_data_baseline.csv"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">" Step 1 Complete: Cleaned dataset saved."</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre> Step 1 Complete: Cleaned dataset saved.
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=e3195492-0a77-4727-9370-4b8616218575">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[19]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Target variables:</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>CAPS5score_baseline:    PTSD severity before treatment
CAPS5Score_TK:      	PTSD severity after treatment (post test)
Derived:                caps5_change_baseline	(pre - post)<div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=4f3559c4-6bf8-402a-8739-050a016c5cea">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[20]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="ch">#!pip install scikit-learn</span>
<span class="c1"># !pip install fancyimpute</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=0cf58d99-d747-4ac5-b4b1-c481572459c7">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[21]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.impute</span> <span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span> <span class="nn">fancyimpute</span> <span class="kn">import</span> <span class="n">IterativeImputer</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">LabelEncoder</span><span class="p">,</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span> <span class="nn">sklearn.compose</span> <span class="kn">import</span> <span class="n">ColumnTransformer</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=291e0886-8be9-4f10-b65a-8c8d8771cf9c">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[22]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Load the cleaned dataset from Step 1</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">"cleaned_data_baseline.csv"</span><span class="p">)</span>

<span class="c1"># Quick check</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>(3641, 194)
DIAGNOSIS_ANXIETY_OCD           float64
DIAGNOSIS_SMOKING               float64
DIAGNOSIS_EATING_DISORDER       float64
DIAGNOSIS_STEMMING_BIPOL        float64
DIAGNOSIS_SUBSTANCE_DISORDER    float64
DIAGNOSIS_PSYCHOTIC             float64
DIAGNOSIS_SUICIDALITY           float64
DIAGNOSIS_SEXUAL_TRAUMA         float64
DIAGNOSIS_CHILDHOOD_TRAUMA        int64
DIAGNOSIS_CPTSD                 float64
dtype: object
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=a7040b25-e2fc-4cff-a371-36f3cee7839b">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[23]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Separate Numerical and Categorical Variables</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=5dd82f05-926b-4e42-a049-7d46e4e47dbd">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[24]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Identify numerical and categorical columns</span>
<span class="n">numerical_cols</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">'float64'</span><span class="p">,</span> <span class="s1">'int64'</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">categorical_cols</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">'object'</span><span class="p">,</span> <span class="s1">'category'</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Numerical Columns: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">numerical_cols</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Categorical Columns: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">categorical_cols</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Numerical Columns: 194
Categorical Columns: 0
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=390faf58-9c35-4b4a-aae8-0414079eadf6">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[25]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># Check missing values for each variable</span>
<span class="n">missing_summary</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC_missing'</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD_missing'</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
    <span class="s1">'Bipolar_and_Mood_disorder_missing'</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">'Bipolar_and_Mood_disorder'</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER_missing'</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
    <span class="s1">'total_rows'</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"Missing values summary:"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">missing_summary</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Missing values summary:
DIAGNOSIS_PSYCHOTIC_missing: 0
DIAGNOSIS_ANXIETY_OCD_missing: 0
Bipolar_and_Mood_disorder_missing: 0
DIAGNOSIS_EATING_DISORDER_missing: 0
total_rows: 3641
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=385a9df4-734c-415d-b062-b081dbaa4ac2">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[26]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Define the mental health variables</span>
<span class="n">mental_health_vars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span> 
                      <span class="s1">'Bipolar_and_Mood_disorder'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">]</span>

<span class="c1"># Check patients with missing data on any of the 4 variables</span>
<span class="n">df</span><span class="p">[</span><span class="s1">'has_missing'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">mental_health_vars</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Summary of missing pattern</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Missing data pattern:"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">'has_missing'</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Patients with missing data: </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="s1">'has_missing'</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Patients with complete data: </span><span class="si">{</span><span class="p">(</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s1">'has_missing'</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
Missing data pattern:
has_missing
False    3641
Name: count, dtype: int64
Patients with missing data: 0
Patients with complete data: 3641
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=d47a76d6-1775-4b55-8e71-33d91d2e143e">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[27]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Store original count before filtering</span>
<span class="n">original_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="c1"># Filter to keep only complete cases (this modifies df)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">mental_health_vars</span><span class="p">)</span>

<span class="c1"># Get the count after filtering</span>
<span class="n">complete_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="c1"># Calculate excluded count</span>
<span class="n">excluded_count</span> <span class="o">=</span> <span class="n">original_count</span> <span class="o">-</span> <span class="n">complete_count</span>

<span class="c1"># Verify the counts</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Dataset summary:"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Original dataset: </span><span class="si">{</span><span class="n">original_count</span><span class="si">}</span><span class="s2"> observations"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Complete cases: </span><span class="si">{</span><span class="n">complete_count</span><span class="si">}</span><span class="s2"> observations"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Excluded (missing): </span><span class="si">{</span><span class="n">excluded_count</span><span class="si">}</span><span class="s2"> observations"</span><span class="p">)</span>

<span class="c1"># Remove the temporary column (if it exists)</span>
<span class="k">if</span> <span class="s1">'has_missing'</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">'has_missing'</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
Dataset summary:
Original dataset: 3641 observations
Complete cases: 3641 observations
Excluded (missing): 0 observations
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=12d763e9-d4ac-4652-87f0-522d8025a981">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[28]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Check the 4 variables you filtered on (should be 0 missing)</span>
<span class="n">mental_health_vars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span> 
                      <span class="s1">'Bipolar_and_Mood_disorder'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Missing values in mental health variables:"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">mental_health_vars</span><span class="p">:</span>
    <span class="n">missing</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
Missing values in mental health variables:
DIAGNOSIS_PSYCHOTIC: 0
DIAGNOSIS_ANXIETY_OCD: 0
Bipolar_and_Mood_disorder: 0
DIAGNOSIS_EATING_DISORDER: 0
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=77aec19c-15a1-4dd9-902f-f7ee0de6f6a2">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[29]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 3641 entries, 0 to 3640
Columns: 194 entries, DIAGNOSIS_ANXIETY_OCD to ethnicity_other
dtypes: float64(11), int64(183)
memory usage: 5.4 MB
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=e23db7c4-d773-4df1-9681-382a86a4d940">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[30]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Save the fully prepared data</span>
<span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">"final_prepared_data.csv"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">" Step 2 Complete: Final prepared dataset saved as 'final_prepared_data.csv'."</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre> Step 2 Complete: Final prepared dataset saved as 'final_prepared_data.csv'.
</pre>
</div>
</div>
</div>
</div>
</div>Define Features, Treatment, and Outcome


 X = Covariates

 T = Treatment Variable (e.g., use of antidepressants CAT_Antidepressiva)

 Y = Target Outcome (caps5_change_baseline)MICE IMputation:<div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=0cc519e7-8480-41c8-9a15-956044ac1b04">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[31]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.experimental</span> <span class="kn">import</span> <span class="n">enable_iterative_imputer</span>  <span class="c1"># noqa</span>
<span class="kn">from</span> <span class="nn">sklearn.impute</span> <span class="kn">import</span> <span class="n">IterativeImputer</span>

<span class="c1"># ========== CONFIG ==========</span>
<span class="n">save_folder</span> <span class="o">=</span> <span class="s2">"imputed_data"</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">n_imputations</span> <span class="o">=</span> <span class="mi">5</span>

<span class="c1"># ========== LOAD ==========</span>
<span class="c1"># Ensure df is already defined</span>
<span class="k">assert</span> <span class="s1">'df'</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">(),</span> <span class="s2">"Please load the original DataFrame as `df` before running this script."</span>

<span class="c1"># ========== IDENTIFY NUMERIC COLUMNS ==========</span>
<span class="n">numeric_cols</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">'float64'</span><span class="p">,</span> <span class="s1">'int64'</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="c1"># ========== STEP 1: MICE IMPUTATION ==========</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"="</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"STEP 1: MICE IMPUTATION"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"="</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>

<span class="n">imputed_dfs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_imputations</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">=== Running MICE Imputation: Dataset </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> ==="</span><span class="p">)</span>
    <span class="c1">#  NEW instance with different seed AND sample_posterior=True for randomness</span>
    <span class="n">mice_imputer</span> <span class="o">=</span> <span class="n">IterativeImputer</span><span class="p">(</span>
        <span class="n">max_iter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="o">+</span><span class="n">i</span><span class="p">,</span>  <span class="c1"># Different base to avoid low numbers</span>
        <span class="n">sample_posterior</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1">#  KEY: This adds randomness!</span>
        <span class="n">n_nearest_features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">initial_strategy</span><span class="o">=</span><span class="s1">'mean'</span>
    <span class="p">)</span>
    <span class="c1"># Fit-transform on numeric columns</span>
    <span class="n">imputed_array</span> <span class="o">=</span> <span class="n">mice_imputer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">numeric_cols</span><span class="p">])</span>
    <span class="c1"># Replace numeric columns in a copy of the original df</span>
    <span class="n">df_imputed</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df_imputed</span><span class="p">[</span><span class="n">numeric_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">imputed_array</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">numeric_cols</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="c1"># Append to list</span>
    <span class="n">imputed_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_imputed</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Completed imputation </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># ========== STEP 2: ROUNDING ==========</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"="</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"STEP 2: ROUNDING NUMERIC COLUMNS"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"="</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">round_all_numeric_columns_all_imputations</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">rounded_dfs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
        <span class="n">df_copy</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">numeric_cols</span> <span class="o">=</span> <span class="n">df_copy</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span>
        <span class="n">df_copy</span><span class="p">[</span><span class="n">numeric_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_copy</span><span class="p">[</span><span class="n">numeric_cols</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">decimals</span><span class="p">)</span>
        <span class="n">rounded_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_copy</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Imputation </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: Rounded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">numeric_cols</span><span class="p">)</span><span class="si">}</span><span class="s2"> numeric columns to </span><span class="si">{</span><span class="n">decimals</span><span class="si">}</span><span class="s2"> decimal place(s)."</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rounded_dfs</span>

<span class="c1"># Apply rounding to all imputed datasets</span>
<span class="n">imputed_dfs</span> <span class="o">=</span> <span class="n">round_all_numeric_columns_all_imputations</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">)</span>

<span class="c1"># ========== STEP 3: SAVE FINAL DATASETS ==========</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"="</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"STEP 3: SAVING FINAL DATASETS"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"="</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df_imputed</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
    <span class="c1"># Save outputs</span>
    <span class="n">pkl_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">save_folder</span><span class="si">}</span><span class="s2">/df_imputed_final_imp</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.pkl"</span>
    <span class="n">csv_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">save_folder</span><span class="si">}</span><span class="s2">/df_imputed_final_imp</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.csv"</span>
    <span class="n">excel_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">save_folder</span><span class="si">}</span><span class="s2">/df_imputed_final_imp</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.xlsx"</span>
    
    <span class="n">df_imputed</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="n">pkl_path</span><span class="p">)</span>
    <span class="n">df_imputed</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">df_imputed</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">excel_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Saved files for imputation </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">:"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"    </span><span class="si">{</span><span class="n">pkl_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"    </span><span class="si">{</span><span class="n">csv_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"    </span><span class="si">{</span><span class="n">excel_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># ========== STEP 4: VERIFY DATASETS ARE DIFFERENT ==========</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"="</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"STEP 4: VERIFYING DATASET DIFFERENCES"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"="</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">check_imputation_differences</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Check if imputed datasets are actually different from each other"""</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"  Only one dataset - cannot check differences"</span><span class="p">)</span>
        <span class="k">return</span>
    
    <span class="c1"># Get numeric columns that had missing values originally</span>
    <span class="n">numeric_cols</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span>
    <span class="n">missing_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">numeric_cols</span> <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()]</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">missing_cols</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"  No missing values found in original data"</span><span class="p">)</span>
        <span class="k">return</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Checking differences in </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">missing_cols</span><span class="p">)</span><span class="si">}</span><span class="s2"> columns that had missing values..."</span><span class="p">)</span>
    
    <span class="n">differences_found</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">missing_cols</span><span class="p">[:</span><span class="mi">3</span><span class="p">]:</span>  <span class="c1"># Check first 3 columns with missing values</span>
        <span class="c1"># Compare first two datasets for this column</span>
        <span class="n">values_1</span> <span class="o">=</span> <span class="n">imputed_dfs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">values_2</span> <span class="o">=</span> <span class="n">imputed_dfs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">values_1</span><span class="p">,</span> <span class="n">values_2</span><span class="p">):</span>
            <span class="n">differences_found</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># Count how many values are different</span>
            <span class="n">diff_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">values_1</span> <span class="o">!=</span> <span class="n">values_2</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Column '</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">': </span><span class="si">{</span><span class="n">diff_count</span><span class="si">}</span><span class="s2"> different values between datasets 1 &amp; 2"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Column '</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">': IDENTICAL values between datasets 1 &amp; 2"</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">differences_found</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> SUCCESS: Datasets show proper variability!"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">  WARNING: Datasets appear identical - check random_state implementation"</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">differences_found</span>

<span class="c1"># Run the check</span>
<span class="n">check_imputation_differences</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"="</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">" MICE IMPUTATION COMPLETE!"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"="</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Created </span><span class="si">{</span><span class="n">n_imputations</span><span class="si">}</span><span class="s2"> imputed datasets"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Applied rounding to all numeric columns"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Saved files in: </span><span class="si">{</span><span class="n">save_folder</span><span class="si">}</span><span class="s2">/"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"="</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>==================================================
STEP 1: MICE IMPUTATION
==================================================

=== Running MICE Imputation: Dataset 1 ===
 Completed imputation 1

=== Running MICE Imputation: Dataset 2 ===
 Completed imputation 2

=== Running MICE Imputation: Dataset 3 ===
 Completed imputation 3

=== Running MICE Imputation: Dataset 4 ===
 Completed imputation 4

=== Running MICE Imputation: Dataset 5 ===
 Completed imputation 5

==================================================
STEP 2: ROUNDING NUMERIC COLUMNS
==================================================
 Imputation 1: Rounded 194 numeric columns to 0 decimal place(s).
 Imputation 2: Rounded 194 numeric columns to 0 decimal place(s).
 Imputation 3: Rounded 194 numeric columns to 0 decimal place(s).
 Imputation 4: Rounded 194 numeric columns to 0 decimal place(s).
 Imputation 5: Rounded 194 numeric columns to 0 decimal place(s).

==================================================
STEP 3: SAVING FINAL DATASETS
==================================================
 Saved files for imputation 1:
    imputed_data/df_imputed_final_imp1.pkl
    imputed_data/df_imputed_final_imp1.csv
    imputed_data/df_imputed_final_imp1.xlsx
 Saved files for imputation 2:
    imputed_data/df_imputed_final_imp2.pkl
    imputed_data/df_imputed_final_imp2.csv
    imputed_data/df_imputed_final_imp2.xlsx
 Saved files for imputation 3:
    imputed_data/df_imputed_final_imp3.pkl
    imputed_data/df_imputed_final_imp3.csv
    imputed_data/df_imputed_final_imp3.xlsx
 Saved files for imputation 4:
    imputed_data/df_imputed_final_imp4.pkl
    imputed_data/df_imputed_final_imp4.csv
    imputed_data/df_imputed_final_imp4.xlsx
 Saved files for imputation 5:
    imputed_data/df_imputed_final_imp5.pkl
    imputed_data/df_imputed_final_imp5.csv
    imputed_data/df_imputed_final_imp5.xlsx

==================================================
STEP 4: VERIFYING DATASET DIFFERENCES
==================================================
 Checking differences in 4 columns that had missing values...
 Column 'DIAGNOSIS_SMOKING': 34 different values between datasets 1 &amp; 2
 Column 'DIAGNOSIS_SEXUAL_TRAUMA': 12 different values between datasets 1 &amp; 2
 Column 'DIAGNOSIS_CPTSD': 20 different values between datasets 1 &amp; 2

 SUCCESS: Datasets show proper variability!

==================================================
 MICE IMPUTATION COMPLETE!
==================================================
 Created 5 imputed datasets
 Applied rounding to all numeric columns
 Saved files in: imputed_data/
==================================================
</pre>
</div>
</div>
</div>
</div>
</div>Imputation check:<div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=e4b4bd5c-a5ad-4fb8-9f74-620e4d2d14cc">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[32]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># ========== METHOD 1: QUICK CHECK - Compare first 2 datasets ==========</span>
<span class="k">def</span> <span class="nf">quick_difference_check</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Quick check to see if first two datasets are different"""</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Need at least 2 datasets to compare"</span><span class="p">)</span>
        <span class="k">return</span>
    
    <span class="n">df1</span> <span class="o">=</span> <span class="n">imputed_dfs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">df2</span> <span class="o">=</span> <span class="n">imputed_dfs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="c1"># Check if dataframes are identical</span>
    <span class="n">are_identical</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">df2</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Dataset 1 vs Dataset 2: </span><span class="si">{</span><span class="s1">'IDENTICAL '</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">are_identical</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">'DIFFERENT '</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">are_identical</span><span class="p">:</span>
        <span class="c1"># Count different values</span>
        <span class="n">numeric_cols</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span>
        <span class="n">total_diff</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">numeric_cols</span><span class="p">:</span>
            <span class="n">diff_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">!=</span> <span class="n">df2</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">diff_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">total_diff</span> <span class="o">+=</span> <span class="n">diff_count</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  '</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">': </span><span class="si">{</span><span class="n">diff_count</span><span class="si">}</span><span class="s2"> different values"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Total different values: </span><span class="si">{</span><span class="n">total_diff</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># ========== METHOD 2: DETAILED CHECK - All pairwise comparisons ==========</span>
<span class="k">def</span> <span class="nf">detailed_difference_check</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Check differences between all pairs of datasets"""</span>
    <span class="n">n_datasets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">=== Checking all </span><span class="si">{</span><span class="n">n_datasets</span><span class="si">}</span><span class="s2"> datasets ==="</span><span class="p">)</span>
    
    <span class="n">numeric_cols</span> <span class="o">=</span> <span class="n">imputed_dfs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_datasets</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_datasets</span><span class="p">):</span>
            <span class="n">are_identical</span> <span class="o">=</span> <span class="n">imputed_dfs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Dataset </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> vs Dataset </span><span class="si">{</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="s1">'IDENTICAL '</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">are_identical</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">'DIFFERENT '</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># ========== METHOD 3: FOCUS ON ORIGINALLY MISSING VALUES ==========</span>
<span class="k">def</span> <span class="nf">check_missing_value_differences</span><span class="p">(</span><span class="n">original_df</span><span class="p">,</span> <span class="n">imputed_dfs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Check differences only in originally missing positions"""</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">=== Checking differences in originally missing positions ==="</span><span class="p">)</span>
    
    <span class="n">numeric_cols</span> <span class="o">=</span> <span class="n">original_df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span>
    
    <span class="n">differences_found</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">numeric_cols</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">original_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">missing_mask</span> <span class="o">=</span> <span class="n">original_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Column '</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">' (</span><span class="si">{</span><span class="n">missing_mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2"> missing values):"</span><span class="p">)</span>
            
            <span class="c1"># Compare imputed values at missing positions</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">imp1_values</span> <span class="o">=</span> <span class="n">imputed_dfs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">missing_mask</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span>
                <span class="n">imp2_values</span> <span class="o">=</span> <span class="n">imputed_dfs</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">missing_mask</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span>
                
                <span class="n">are_same</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">imp1_values</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">imp2_values</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">are_same</span><span class="p">:</span>
                    <span class="n">differences_found</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">diff_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">imp1_values</span><span class="o">.</span><span class="n">values</span> <span class="o">!=</span> <span class="n">imp2_values</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Dataset </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">diff_count</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">imp1_values</span><span class="p">)</span><span class="si">}</span><span class="s2"> different imputed values "</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Dataset </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="si">}</span><span class="s2">: IDENTICAL imputed values "</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">differences_found</span>

<span class="c1"># ========== METHOD 4: SAMPLE VALUES FROM EACH DATASET ==========</span>
<span class="k">def</span> <span class="nf">show_sample_imputed_values</span><span class="p">(</span><span class="n">original_df</span><span class="p">,</span> <span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Show sample imputed values from each dataset"""</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">=== Sample imputed values (first </span><span class="si">{</span><span class="n">n_samples</span><span class="si">}</span><span class="s2"> missing positions) ==="</span><span class="p">)</span>
    
    <span class="n">numeric_cols</span> <span class="o">=</span> <span class="n">original_df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span>
    
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">numeric_cols</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">original_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">missing_positions</span> <span class="o">=</span> <span class="n">original_df</span><span class="p">[</span><span class="n">original_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="n">n_samples</span><span class="p">]</span>
            
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Column '</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">' at positions </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">missing_positions</span><span class="p">)</span><span class="si">}</span><span class="s2">:"</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df_imp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
                <span class="n">values</span> <span class="o">=</span> <span class="n">df_imp</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">missing_positions</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Dataset </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">values</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># ========== RUN ALL CHECKS ==========</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"="</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"CHECKING IMPUTATION DIFFERENCES"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"="</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>

<span class="c1"># Method 1: Quick check</span>
<span class="n">quick_difference_check</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">)</span>

<span class="c1"># Method 2: All pairwise comparisons  </span>
<span class="n">detailed_difference_check</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">)</span>

<span class="c1"># Method 3: Focus on originally missing values (assumes 'df' is your original dataframe)</span>
<span class="k">if</span> <span class="s1">'df'</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
    <span class="n">differences_found</span> <span class="o">=</span> <span class="n">check_missing_value_differences</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">imputed_dfs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">differences_found</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> SUCCESS: Found differences in imputed values!"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> WARNING: No differences found in imputed values!"</span><span class="p">)</span>

<span class="c1"># Method 4: Show sample values</span>
<span class="k">if</span> <span class="s1">'df'</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
    <span class="n">show_sample_imputed_values</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>============================================================
CHECKING IMPUTATION DIFFERENCES
============================================================
Dataset 1 vs Dataset 2: DIFFERENT 
  'DIAGNOSIS_SMOKING': 34 different values
  'DIAGNOSIS_SEXUAL_TRAUMA': 12 different values
  'DIAGNOSIS_CPTSD': 20 different values
  'treatmentdurationdays': 1129 different values
  Total different values: 1195

=== Checking all 5 datasets ===
Dataset 1 vs Dataset 2: DIFFERENT 
Dataset 1 vs Dataset 3: DIFFERENT 
Dataset 1 vs Dataset 4: DIFFERENT 
Dataset 1 vs Dataset 5: DIFFERENT 
Dataset 2 vs Dataset 3: DIFFERENT 
Dataset 2 vs Dataset 4: DIFFERENT 
Dataset 2 vs Dataset 5: DIFFERENT 
Dataset 3 vs Dataset 4: DIFFERENT 
Dataset 3 vs Dataset 5: DIFFERENT 
Dataset 4 vs Dataset 5: DIFFERENT 

=== Checking differences in originally missing positions ===

Column 'DIAGNOSIS_SMOKING' (64 missing values):
  Dataset 1 vs 2: 34/64 different imputed values 
  Dataset 2 vs 3: 35/64 different imputed values 
  Dataset 3 vs 4: 33/64 different imputed values 
  Dataset 4 vs 5: 35/64 different imputed values 

Column 'DIAGNOSIS_SEXUAL_TRAUMA' (29 missing values):
  Dataset 1 vs 2: 12/29 different imputed values 
  Dataset 2 vs 3: 14/29 different imputed values 
  Dataset 3 vs 4: 13/29 different imputed values 
  Dataset 4 vs 5: 16/29 different imputed values 

Column 'DIAGNOSIS_CPTSD' (51 missing values):
  Dataset 1 vs 2: 20/51 different imputed values 
  Dataset 2 vs 3: 24/51 different imputed values 
  Dataset 3 vs 4: 30/51 different imputed values 
  Dataset 4 vs 5: 23/51 different imputed values 

Column 'treatmentdurationdays' (1412 missing values):
  Dataset 1 vs 2: 1129/1412 different imputed values 
  Dataset 2 vs 3: 1148/1412 different imputed values 
  Dataset 3 vs 4: 1177/1412 different imputed values 
  Dataset 4 vs 5: 1143/1412 different imputed values 

 SUCCESS: Found differences in imputed values!

=== Sample imputed values (first 3 missing positions) ===

Column 'DIAGNOSIS_SMOKING' at positions [5, 7, 57]:
  Dataset 1: [-1.  0.  1.]
  Dataset 2: [ 0. -1.  1.]
  Dataset 3: [ 0. -0.  1.]
  Dataset 4: [ 1. -1.  1.]
  Dataset 5: [0. 0. 0.]

Column 'DIAGNOSIS_SEXUAL_TRAUMA' at positions [29, 30, 31]:
  Dataset 1: [1. 1. 1.]
  Dataset 2: [1. 1. 1.]
  Dataset 3: [1. 2. 0.]
  Dataset 4: [0. 1. 0.]
  Dataset 5: [0. 1. 1.]

Column 'DIAGNOSIS_CPTSD' at positions [7, 57, 216]:
  Dataset 1: [0. 1. 1.]
  Dataset 2: [1. 1. 1.]
  Dataset 3: [1. 1. 1.]
  Dataset 4: [0. 1. 1.]
  Dataset 5: [0. 1. 1.]

Column 'treatmentdurationdays' at positions [0, 1, 6]:
  Dataset 1: [3. 6. 2.]
  Dataset 2: [3. 4. 5.]
  Dataset 3: [3. 3. 3.]
  Dataset 4: [3. 4. 4.]
  Dataset 5: [5. 4. 1.]
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=ab0b31cd-485d-43af-aa6b-2c74bfabed76">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[33]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">imputed_folder</span> <span class="o">=</span> <span class="s2">"imputed_data"</span>
<span class="n">n_imputations</span> <span class="o">=</span> <span class="mi">5</span>

<span class="c1"># Lists to hold DataFrames and Y vectors</span>
<span class="n">imputed_dfs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">Y_list</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_imputations</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">imputed_folder</span><span class="si">}</span><span class="s2">/df_imputed_final_imp</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.pkl"</span>
    
    <span class="c1"># Load imputed DataFrame</span>
    <span class="n">df_imp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
    <span class="n">imputed_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_imp</span><span class="p">)</span>

    <span class="c1"># Define Y for this imputation</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="s2">"caps5_change_baseline"</span><span class="p">]</span>
    <span class="n">Y_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Y for imputation </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> defined. Sample values:"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Y for imputation 1 defined. Sample values:
0   -41.0
1   -15.0
2   -46.0
3   -41.0
4   -20.0
Name: caps5_change_baseline, dtype: float64
Y for imputation 2 defined. Sample values:
0   -41.0
1   -15.0
2   -46.0
3   -41.0
4   -20.0
Name: caps5_change_baseline, dtype: float64
Y for imputation 3 defined. Sample values:
0   -41.0
1   -15.0
2   -46.0
3   -41.0
4   -20.0
Name: caps5_change_baseline, dtype: float64
Y for imputation 4 defined. Sample values:
0   -41.0
1   -15.0
2   -46.0
3   -41.0
4   -20.0
Name: caps5_change_baseline, dtype: float64
Y for imputation 5 defined. Sample values:
0   -41.0
1   -15.0
2   -46.0
3   -41.0
4   -20.0
Name: caps5_change_baseline, dtype: float64
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=2d30451e-4ae5-433b-94a0-946273af517f">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[34]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">covariates_CAT_ADHD</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'CAT_Anti_epileptica'</span><span class="p">,</span> <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span> <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span> <span class="s1">'CAT_Opioden'</span><span class="p">,</span>
    <span class="s1">'CAT_Z_drugs'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SMOKING'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span>
    <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"EB_NON_TF_THERAPY"</span><span class="p">,</span> <span class="s2">"OTHER_TREATM_APPROACH"</span><span class="p">,</span> <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_CAT_Aceetanilidederivaten</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'CAT_Anti_epileptica'</span><span class="p">,</span> <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span> <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span> <span class="s1">'CAT_Opioden'</span><span class="p">,</span> <span class="s1">'CAT_Z_drugs'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SMOKING'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"EB_NON_TF_THERAPY"</span><span class="p">,</span> <span class="s2">"OTHER_TREATM_APPROACH"</span><span class="p">,</span> <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_CAT_Z_drugs</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'CAT_Anti_epileptica'</span><span class="p">,</span> <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span> <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span> <span class="s1">'CAT_Opioden'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SMOKING'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"EB_NON_TF_THERAPY"</span><span class="p">,</span> <span class="s2">"OTHER_TREATM_APPROACH"</span><span class="p">,</span> <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_CAT_Opioden</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'CAT_Anti_epileptica'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span> <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span> <span class="s1">'CAT_Z_drugs'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SMOKING'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"EB_NON_TF_THERAPY"</span><span class="p">,</span> <span class="s2">"OTHER_TREATM_APPROACH"</span><span class="p">,</span> <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_CAT_NSAIDs</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'CAT_Anti_epileptica'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span> <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span> <span class="s1">'CAT_Opioden'</span><span class="p">,</span> <span class="s1">'CAT_Z_drugs'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SMOKING'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"EB_NON_TF_THERAPY"</span><span class="p">,</span> <span class="s2">"OTHER_TREATM_APPROACH"</span><span class="p">,</span> <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>



<span class="n">covariates_CAT_Benzodiazepine</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'CAT_Anti_epileptica'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span> <span class="s1">'CAT_Opioden'</span><span class="p">,</span> <span class="s1">'CAT_Z_drugs'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SMOKING'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"EB_NON_TF_THERAPY"</span><span class="p">,</span> <span class="s2">"OTHER_TREATM_APPROACH"</span><span class="p">,</span> <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_CAT_Antihypertensiva</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'CAT_Anti_epileptica'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span> <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span> <span class="s1">'CAT_Opioden'</span><span class="p">,</span> <span class="s1">'CAT_Z_drugs'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SMOKING'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"EB_NON_TF_THERAPY"</span><span class="p">,</span> <span class="s2">"OTHER_TREATM_APPROACH"</span><span class="p">,</span> <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_CAT_Antihistaminica</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'CAT_Anti_epileptica'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span> <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span> <span class="s1">'CAT_Opioden'</span><span class="p">,</span> <span class="s1">'CAT_Z_drugs'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SMOKING'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"EB_NON_TF_THERAPY"</span><span class="p">,</span> <span class="s2">"OTHER_TREATM_APPROACH"</span><span class="p">,</span> <span class="s2">"Bipolar_and_Mood_disorder"</span>
<span class="p">]</span>


<span class="n">covariates_CAT_Anti_epileptica</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span> <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span> <span class="s1">'CAT_Opioden'</span><span class="p">,</span> <span class="s1">'CAT_Z_drugs'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SMOKING'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"EB_NON_TF_THERAPY"</span><span class="p">,</span> <span class="s2">"OTHER_TREATM_APPROACH"</span><span class="p">,</span> <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_CAT_Antidepressiva</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'CAT_Anti_epileptica'</span><span class="p">,</span> <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span> <span class="s1">'CAT_Opioden'</span><span class="p">,</span> <span class="s1">'CAT_Z_drugs'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SMOKING'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"EB_NON_TF_THERAPY"</span><span class="p">,</span> <span class="s2">"OTHER_TREATM_APPROACH"</span><span class="p">,</span> <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_CAT_Antipsychotica</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'CAT_Anti_epileptica'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span> <span class="s1">'CAT_Opioden'</span><span class="p">,</span> <span class="s1">'CAT_Z_drugs'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SMOKING'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"EB_NON_TF_THERAPY"</span><span class="p">,</span> <span class="s2">"OTHER_TREATM_APPROACH"</span><span class="p">,</span> <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_CAT_ALL_PSYCHOTROPICS_EXCL_BENZO</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span> <span class="s1">'CAT_Anticonceptiva'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SMOKING'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"EB_NON_TF_THERAPY"</span><span class="p">,</span> <span class="s2">"OTHER_TREATM_APPROACH"</span><span class="p">,</span> <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span> <span class="s1">'CAT_Z_drugs'</span><span class="p">,</span> <span class="s1">'CAT_Anticonceptiva'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SMOKING'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"EB_NON_TF_THERAPY"</span><span class="p">,</span> <span class="s2">"OTHER_TREATM_APPROACH"</span><span class="p">,</span> <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_CAT_ALL_PSYCHOTROPICS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SMOKING'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"EB_NON_TF_THERAPY"</span><span class="p">,</span> <span class="s2">"OTHER_TREATM_APPROACH"</span><span class="p">,</span> <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_CAT_ALL</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SMOKING'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span>
    <span class="s1">'age'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"EB_NON_TF_THERAPY"</span><span class="p">,</span> <span class="s2">"OTHER_TREATM_APPROACH"</span><span class="p">,</span> <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=7887112f-e4d1-4beb-b93b-1d96a34cf5c4">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[35]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="c1"># This finds all variables that start with covariates_CAT_ or covariates_cat_</span>
<span class="n">final_covariates_map</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<span class="n">final_covariates_map</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
    <span class="n">var</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"covariates_"</span><span class="p">,</span> <span class="s2">""</span><span class="p">):</span> <span class="n">val</span>
    <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"covariates_cat_"</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
<span class="p">})</span>

<span class="c1"># Show detected group names</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Groups found:"</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
<span class="n">medication_groups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">medication_groups</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Groups found: ['CAT_ADHD', 'CAT_Aceetanilidederivaten', 'CAT_Z_drugs', 'CAT_Opioden', 'CAT_NSAIDs', 'CAT_Benzodiazepine', 'CAT_Antihypertensiva', 'CAT_Antihistaminica', 'CAT_Anti_epileptica', 'CAT_Antidepressiva', 'CAT_Antipsychotica', 'CAT_ALL_PSYCHOTROPICS_EXCL_BENZO', 'CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS', 'CAT_ALL_PSYCHOTROPICS', 'CAT_ALL']
['CAT_ADHD', 'CAT_Aceetanilidederivaten', 'CAT_Z_drugs', 'CAT_Opioden', 'CAT_NSAIDs', 'CAT_Benzodiazepine', 'CAT_Antihypertensiva', 'CAT_Antihistaminica', 'CAT_Anti_epileptica', 'CAT_Antidepressiva', 'CAT_Antipsychotica', 'CAT_ALL_PSYCHOTROPICS_EXCL_BENZO', 'CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS', 'CAT_ALL_PSYCHOTROPICS', 'CAT_ALL']
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=ef0586b8-17ca-4e92-acc8-b137bd4e98a7">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[36]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>


<span class="k">def</span> <span class="nf">run_all_CAT_group_models</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Runs downstream analysis for each CAT medication group using imputed datasets.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - imputed_dfs: list of 5 imputed DataFrames (from df_imputed_final_imp1.pkl ... imp5.pkl)</span>
<span class="sd">    </span>
<span class="sd">    Notes:</span>
<span class="sd">    - Covariate lists must be defined as global variables: covariates_cat_&lt;group&gt;</span>
<span class="sd">    - Outputs are saved in: outputs/CAT_&lt;GROUP&gt;/</span>
<span class="sd">    """</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">" Starting analysis for all CAT groups"</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">var_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"covariates_cat_"</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">globals</span><span class="p">()[</span><span class="n">var_name</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">group_name</span> <span class="o">=</span> <span class="n">var_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"covariates_"</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
            <span class="n">group_name</span> <span class="o">=</span> <span class="n">group_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"_"</span><span class="p">,</span> <span class="s2">" "</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">" "</span><span class="p">,</span> <span class="s2">"_"</span><span class="p">)</span>  <span class="c1"># e.g., cat_z_drugs  Cat_Z_Drugs</span>
            <span class="n">group_name</span> <span class="o">=</span> <span class="n">group_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"Cat_"</span><span class="p">,</span> <span class="s2">"CAT_"</span><span class="p">)</span>  <span class="c1"># force prefix to uppercase</span>

            <span class="n">covariates</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()[</span><span class="n">var_name</span><span class="p">]</span>
            <span class="n">output_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"outputs/</span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">"</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Processing </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">..."</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">df_imp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   Using imputation </span><span class="si">{</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

                <span class="c1"># Define X and Y</span>
                <span class="n">X</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span>
                <span class="n">Y</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="s2">"caps5_change_baseline"</span><span class="p">]</span>

                <span class="c1"># === Save X and Y as placeholder (replace with modeling later)</span>
                <span class="n">X</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/X_imp</span><span class="si">{</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.csv"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">Y</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"Y"</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/Y_imp</span><span class="si">{</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.csv"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Done: </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> All CAT group analyses complete."</span><span class="p">)</span>

<span class="c1"># ========= STEP 4: Execute ========= #</span>
<span class="n">run_all_CAT_group_models</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre> Starting analysis for all CAT groups

 Processing CAT_Adhd...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: CAT_Adhd

 Processing CAT_Aceetanilidederivaten...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: CAT_Aceetanilidederivaten

 Processing CAT_Z_Drugs...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: CAT_Z_Drugs

 Processing CAT_Opioden...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: CAT_Opioden

 Processing CAT_Nsaids...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: CAT_Nsaids

 Processing CAT_Benzodiazepine...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: CAT_Benzodiazepine

 Processing CAT_Antihypertensiva...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: CAT_Antihypertensiva

 Processing CAT_Antihistaminica...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: CAT_Antihistaminica

 Processing CAT_Anti_Epileptica...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: CAT_Anti_Epileptica

 Processing CAT_Antidepressiva...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: CAT_Antidepressiva

 Processing CAT_Antipsychotica...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: CAT_Antipsychotica

 Processing CAT_All_Psychotropics_Excl_Benzo...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: CAT_All_Psychotropics_Excl_Benzo

 Processing CAT_All_Psychotropics_Excl_Sedatives_Hypnotics...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: CAT_All_Psychotropics_Excl_Sedatives_Hypnotics

 Processing CAT_All_Psychotropics...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: CAT_All_Psychotropics

 Processing CAT_All...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: CAT_All

 All CAT group analyses complete.
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=964aaa15-0261-4194-b3ea-3d42c6e093d9">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[37]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">treatment_var</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">treatment_var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Imp </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">:  Not found in columns."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">treated</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">control</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Imp </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: Treated = </span><span class="si">{</span><span class="n">treated</span><span class="si">}</span><span class="s2">, Control = </span><span class="si">{</span><span class="n">control</span><span class="si">}</span><span class="s2">, Missing = </span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 CAT_ADHD
  Imp 1: Treated = 56, Control = 3585, Missing = 0
  Imp 2: Treated = 56, Control = 3585, Missing = 0
  Imp 3: Treated = 56, Control = 3585, Missing = 0
  Imp 4: Treated = 56, Control = 3585, Missing = 0
  Imp 5: Treated = 56, Control = 3585, Missing = 0

 CAT_Aceetanilidederivaten
  Imp 1: Treated = 50, Control = 3591, Missing = 0
  Imp 2: Treated = 50, Control = 3591, Missing = 0
  Imp 3: Treated = 50, Control = 3591, Missing = 0
  Imp 4: Treated = 50, Control = 3591, Missing = 0
  Imp 5: Treated = 50, Control = 3591, Missing = 0

 CAT_Z_drugs
  Imp 1: Treated = 57, Control = 3584, Missing = 0
  Imp 2: Treated = 57, Control = 3584, Missing = 0
  Imp 3: Treated = 57, Control = 3584, Missing = 0
  Imp 4: Treated = 57, Control = 3584, Missing = 0
  Imp 5: Treated = 57, Control = 3584, Missing = 0

 CAT_Opioden
  Imp 1: Treated = 54, Control = 3587, Missing = 0
  Imp 2: Treated = 54, Control = 3587, Missing = 0
  Imp 3: Treated = 54, Control = 3587, Missing = 0
  Imp 4: Treated = 54, Control = 3587, Missing = 0
  Imp 5: Treated = 54, Control = 3587, Missing = 0

 CAT_NSAIDs
  Imp 1: Treated = 37, Control = 3604, Missing = 0
  Imp 2: Treated = 37, Control = 3604, Missing = 0
  Imp 3: Treated = 37, Control = 3604, Missing = 0
  Imp 4: Treated = 37, Control = 3604, Missing = 0
  Imp 5: Treated = 37, Control = 3604, Missing = 0

 CAT_Benzodiazepine
  Imp 1: Treated = 396, Control = 3245, Missing = 0
  Imp 2: Treated = 396, Control = 3245, Missing = 0
  Imp 3: Treated = 396, Control = 3245, Missing = 0
  Imp 4: Treated = 396, Control = 3245, Missing = 0
  Imp 5: Treated = 396, Control = 3245, Missing = 0

 CAT_Antihypertensiva
  Imp 1: Treated = 45, Control = 3596, Missing = 0
  Imp 2: Treated = 45, Control = 3596, Missing = 0
  Imp 3: Treated = 45, Control = 3596, Missing = 0
  Imp 4: Treated = 45, Control = 3596, Missing = 0
  Imp 5: Treated = 45, Control = 3596, Missing = 0

 CAT_Antihistaminica
  Imp 1: Treated = 56, Control = 3585, Missing = 0
  Imp 2: Treated = 56, Control = 3585, Missing = 0
  Imp 3: Treated = 56, Control = 3585, Missing = 0
  Imp 4: Treated = 56, Control = 3585, Missing = 0
  Imp 5: Treated = 56, Control = 3585, Missing = 0

 CAT_Anti_epileptica
  Imp 1: Treated = 84, Control = 3557, Missing = 0
  Imp 2: Treated = 84, Control = 3557, Missing = 0
  Imp 3: Treated = 84, Control = 3557, Missing = 0
  Imp 4: Treated = 84, Control = 3557, Missing = 0
  Imp 5: Treated = 84, Control = 3557, Missing = 0

 CAT_Antidepressiva
  Imp 1: Treated = 636, Control = 3005, Missing = 0
  Imp 2: Treated = 636, Control = 3005, Missing = 0
  Imp 3: Treated = 636, Control = 3005, Missing = 0
  Imp 4: Treated = 636, Control = 3005, Missing = 0
  Imp 5: Treated = 636, Control = 3005, Missing = 0

 CAT_Antipsychotica
  Imp 1: Treated = 268, Control = 3373, Missing = 0
  Imp 2: Treated = 268, Control = 3373, Missing = 0
  Imp 3: Treated = 268, Control = 3373, Missing = 0
  Imp 4: Treated = 268, Control = 3373, Missing = 0
  Imp 5: Treated = 268, Control = 3373, Missing = 0

 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO
  Imp 1: Treated = 869, Control = 2772, Missing = 0
  Imp 2: Treated = 869, Control = 2772, Missing = 0
  Imp 3: Treated = 869, Control = 2772, Missing = 0
  Imp 4: Treated = 869, Control = 2772, Missing = 0
  Imp 5: Treated = 869, Control = 2772, Missing = 0

 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS
  Imp 1: Treated = 846, Control = 2795, Missing = 0
  Imp 2: Treated = 846, Control = 2795, Missing = 0
  Imp 3: Treated = 846, Control = 2795, Missing = 0
  Imp 4: Treated = 846, Control = 2795, Missing = 0
  Imp 5: Treated = 846, Control = 2795, Missing = 0

 CAT_ALL_PSYCHOTROPICS
  Imp 1: Treated = 1031, Control = 2610, Missing = 0
  Imp 2: Treated = 1031, Control = 2610, Missing = 0
  Imp 3: Treated = 1031, Control = 2610, Missing = 0
  Imp 4: Treated = 1031, Control = 2610, Missing = 0
  Imp 5: Treated = 1031, Control = 2610, Missing = 0

 CAT_ALL
  Imp 1: Treated = 1072, Control = 2569, Missing = 0
  Imp 2: Treated = 1072, Control = 2569, Missing = 0
  Imp 3: Treated = 1072, Control = 2569, Missing = 0
  Imp 4: Treated = 1072, Control = 2569, Missing = 0
  Imp 5: Treated = 1072, Control = 2569, Missing = 0
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=556179f5-ba78-4e8d-ac27-5632bc5aaf4e">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[38]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">from</span> <span class="nn">statsmodels.stats.outliers_influence</span> <span class="kn">import</span> <span class="n">variance_inflation_factor</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="c1">#  VIF computation function</span>
<span class="k">def</span> <span class="nf">compute_vif</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">has_constant</span><span class="o">=</span><span class="s1">'add'</span><span class="p">)</span>
    <span class="n">vif_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">vif_df</span><span class="p">[</span><span class="s2">"variable"</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span>
    <span class="n">vif_df</span><span class="p">[</span><span class="s2">"VIF"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">variance_inflation_factor</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
    <span class="k">return</span> <span class="n">vif_df</span>

<span class="c1">#  Process each group</span>
<span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Processing VIF for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  No covariates found for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
        <span class="k">continue</span>

    <span class="n">covariates</span> <span class="o">=</span> <span class="n">final_covariates_map</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
    <span class="n">vif_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df_imp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">vif_df</span> <span class="o">=</span> <span class="n">compute_vif</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="n">vif_df</span><span class="p">[</span><span class="s2">"imputation"</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">vif_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vif_df</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"    Failed on imputation </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">vif_list</span><span class="p">:</span>
        <span class="n">all_vif</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">vif_list</span><span class="p">)</span>
        <span class="n">pooled_vif</span> <span class="o">=</span> <span class="n">all_vif</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">"variable"</span><span class="p">)[</span><span class="s2">"VIF"</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">pooled_vif</span> <span class="o">=</span> <span class="n">pooled_vif</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">"VIF"</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"outputs"</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">pooled_vif</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"pooled_vif.csv"</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Saved: </span><span class="si">{</span><span class="n">output_folder</span><span class="si">}</span><span class="s2">/pooled_vif.csv"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Skipped </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: No valid imputations."</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Processing VIF for CAT_ADHD
  Saved: outputs\CAT_ADHD/pooled_vif.csv

 Processing VIF for CAT_Aceetanilidederivaten
  Saved: outputs\CAT_Aceetanilidederivaten/pooled_vif.csv

 Processing VIF for CAT_Z_drugs
  Saved: outputs\CAT_Z_drugs/pooled_vif.csv

 Processing VIF for CAT_Opioden
  Saved: outputs\CAT_Opioden/pooled_vif.csv

 Processing VIF for CAT_NSAIDs
  Saved: outputs\CAT_NSAIDs/pooled_vif.csv

 Processing VIF for CAT_Benzodiazepine
  Saved: outputs\CAT_Benzodiazepine/pooled_vif.csv

 Processing VIF for CAT_Antihypertensiva
  Saved: outputs\CAT_Antihypertensiva/pooled_vif.csv

 Processing VIF for CAT_Antihistaminica
  Saved: outputs\CAT_Antihistaminica/pooled_vif.csv

 Processing VIF for CAT_Anti_epileptica
  Saved: outputs\CAT_Anti_epileptica/pooled_vif.csv

 Processing VIF for CAT_Antidepressiva
  Saved: outputs\CAT_Antidepressiva/pooled_vif.csv

 Processing VIF for CAT_Antipsychotica
  Saved: outputs\CAT_Antipsychotica/pooled_vif.csv

 Processing VIF for CAT_ALL_PSYCHOTROPICS_EXCL_BENZO
  Saved: outputs\CAT_ALL_PSYCHOTROPICS_EXCL_BENZO/pooled_vif.csv

 Processing VIF for CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS
  Saved: outputs\CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS/pooled_vif.csv

 Processing VIF for CAT_ALL_PSYCHOTROPICS
  Saved: outputs\CAT_ALL_PSYCHOTROPICS/pooled_vif.csv

 Processing VIF for CAT_ALL
  Saved: outputs\CAT_ALL/pooled_vif.csv
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=5c8f0127-0657-483c-9469-c4d67267d7cb">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[39]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">xgboost</span> <span class="kn">import</span> <span class="n">XGBClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">roc_curve</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>

<span class="c1"># ---------- PS Estimation Function ----------</span>
<span class="k">def</span> <span class="nf">run_xgboost_ps_modeling</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Running PS estimation for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No covariates found for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"outputs"</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">covariates</span> <span class="o">=</span> <span class="n">final_covariates_map</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
        <span class="n">ps_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">auc_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df_imp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_imp</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> not found in imputed dataset </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">X</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>

            <span class="c1"># Drop missing treatment rows</span>
            <span class="n">valid_idx</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">index</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>

            <span class="c1"># Train-test split for ROC</span>
            <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">T_train</span><span class="p">,</span> <span class="n">T_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
                <span class="n">X</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
            <span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">XGBClassifier</span><span class="p">(</span><span class="n">use_label_encoder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eval_metric</span><span class="o">=</span><span class="s1">'logloss'</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
                <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">T_train</span><span class="p">)</span>

                <span class="n">ps_scores</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">ps_matrix</span><span class="p">[</span><span class="sa">f</span><span class="s2">"ps_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">ps_scores</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">valid_idx</span><span class="p">)</span>

                <span class="c1"># ROC &amp; AUC</span>
                <span class="n">auc</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">T_test</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">auc_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">auc</span><span class="p">)</span>

                <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">T_test</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">"AUC = </span><span class="si">{</span><span class="n">auc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'k--'</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"False Positive Rate"</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"True Positive Rate"</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"ROC Curve - </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> (Imp </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">)"</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"roc_curve_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.png"</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   Imp </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: AUC = </span><span class="si">{</span><span class="n">auc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, ROC saved."</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> (imp </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Save AUCs and Composite PS</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ps_matrix</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="c1"># Fill NaN rows (from dropped subjects in some imputations) with mean</span>
            <span class="n">ps_matrix</span><span class="p">[</span><span class="s2">"composite_ps"</span><span class="p">]</span> <span class="o">=</span> <span class="n">ps_matrix</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ps_matrix</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"propensity_scores.xlsx"</span><span class="p">))</span>

            <span class="n">auc_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s2">"imputation"</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">"imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">auc_list</span><span class="p">))],</span>
                <span class="s2">"AUC"</span><span class="p">:</span> <span class="n">auc_list</span>
            <span class="p">})</span>
            <span class="n">auc_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">auc_df</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"mean"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">auc_list</span><span class="p">)</span> <span class="k">if</span> <span class="n">auc_list</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span>
            <span class="n">auc_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"auc_scores.xlsx"</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Composite PS + AUC saved for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No valid PS scores generated for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># ---------- Run ----------</span>
<span class="n">run_xgboost_ps_modeling</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre> Running PS estimation for CAT_ADHD
   Imp 1: AUC = 0.705, ROC saved.
   Imp 2: AUC = 0.678, ROC saved.
   Imp 3: AUC = 0.675, ROC saved.
   Imp 4: AUC = 0.751, ROC saved.
   Imp 5: AUC = 0.635, ROC saved.
 Composite PS + AUC saved for CAT_ADHD
 Running PS estimation for CAT_Aceetanilidederivaten
   Imp 1: AUC = 0.725, ROC saved.
   Imp 2: AUC = 0.774, ROC saved.
   Imp 3: AUC = 0.726, ROC saved.
   Imp 4: AUC = 0.786, ROC saved.
   Imp 5: AUC = 0.759, ROC saved.
 Composite PS + AUC saved for CAT_Aceetanilidederivaten
 Running PS estimation for CAT_Z_drugs
   Imp 1: AUC = 0.746, ROC saved.
   Imp 2: AUC = 0.724, ROC saved.
   Imp 3: AUC = 0.699, ROC saved.
   Imp 4: AUC = 0.712, ROC saved.
   Imp 5: AUC = 0.702, ROC saved.
 Composite PS + AUC saved for CAT_Z_drugs
 Running PS estimation for CAT_Opioden
   Imp 1: AUC = 0.772, ROC saved.
   Imp 2: AUC = 0.800, ROC saved.
   Imp 3: AUC = 0.809, ROC saved.
   Imp 4: AUC = 0.791, ROC saved.
   Imp 5: AUC = 0.794, ROC saved.
 Composite PS + AUC saved for CAT_Opioden
 Running PS estimation for CAT_NSAIDs
   Imp 1: AUC = 0.676, ROC saved.
   Imp 2: AUC = 0.668, ROC saved.
   Imp 3: AUC = 0.683, ROC saved.
   Imp 4: AUC = 0.700, ROC saved.
   Imp 5: AUC = 0.654, ROC saved.
 Composite PS + AUC saved for CAT_NSAIDs
 Running PS estimation for CAT_Benzodiazepine
   Imp 1: AUC = 0.764, ROC saved.
   Imp 2: AUC = 0.736, ROC saved.
   Imp 3: AUC = 0.754, ROC saved.
   Imp 4: AUC = 0.763, ROC saved.
   Imp 5: AUC = 0.763, ROC saved.
 Composite PS + AUC saved for CAT_Benzodiazepine
 Running PS estimation for CAT_Antihypertensiva
   Imp 1: AUC = 0.783, ROC saved.
   Imp 2: AUC = 0.766, ROC saved.
   Imp 3: AUC = 0.759, ROC saved.
   Imp 4: AUC = 0.752, ROC saved.
   Imp 5: AUC = 0.734, ROC saved.
 Composite PS + AUC saved for CAT_Antihypertensiva
 Running PS estimation for CAT_Antihistaminica
   Imp 1: AUC = 0.798, ROC saved.
   Imp 2: AUC = 0.793, ROC saved.
   Imp 3: AUC = 0.789, ROC saved.
   Imp 4: AUC = 0.771, ROC saved.
   Imp 5: AUC = 0.761, ROC saved.
 Composite PS + AUC saved for CAT_Antihistaminica
 Running PS estimation for CAT_Anti_epileptica
   Imp 1: AUC = 0.727, ROC saved.
   Imp 2: AUC = 0.775, ROC saved.
   Imp 3: AUC = 0.746, ROC saved.
   Imp 4: AUC = 0.784, ROC saved.
   Imp 5: AUC = 0.742, ROC saved.
 Composite PS + AUC saved for CAT_Anti_epileptica
 Running PS estimation for CAT_Antidepressiva
   Imp 1: AUC = 0.788, ROC saved.
   Imp 2: AUC = 0.771, ROC saved.
   Imp 3: AUC = 0.780, ROC saved.
   Imp 4: AUC = 0.779, ROC saved.
   Imp 5: AUC = 0.793, ROC saved.
 Composite PS + AUC saved for CAT_Antidepressiva
 Running PS estimation for CAT_Antipsychotica
   Imp 1: AUC = 0.801, ROC saved.
   Imp 2: AUC = 0.805, ROC saved.
   Imp 3: AUC = 0.821, ROC saved.
   Imp 4: AUC = 0.803, ROC saved.
   Imp 5: AUC = 0.821, ROC saved.
 Composite PS + AUC saved for CAT_Antipsychotica
 Running PS estimation for CAT_ALL_PSYCHOTROPICS_EXCL_BENZO
   Imp 1: AUC = 0.772, ROC saved.
   Imp 2: AUC = 0.776, ROC saved.
   Imp 3: AUC = 0.771, ROC saved.
   Imp 4: AUC = 0.768, ROC saved.
   Imp 5: AUC = 0.771, ROC saved.
 Composite PS + AUC saved for CAT_ALL_PSYCHOTROPICS_EXCL_BENZO
 Running PS estimation for CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS
   Imp 1: AUC = 0.783, ROC saved.
   Imp 2: AUC = 0.779, ROC saved.
   Imp 3: AUC = 0.781, ROC saved.
   Imp 4: AUC = 0.769, ROC saved.
   Imp 5: AUC = 0.780, ROC saved.
 Composite PS + AUC saved for CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS
 Running PS estimation for CAT_ALL_PSYCHOTROPICS
   Imp 1: AUC = 0.773, ROC saved.
   Imp 2: AUC = 0.770, ROC saved.
   Imp 3: AUC = 0.772, ROC saved.
   Imp 4: AUC = 0.759, ROC saved.
   Imp 5: AUC = 0.775, ROC saved.
 Composite PS + AUC saved for CAT_ALL_PSYCHOTROPICS
 Running PS estimation for CAT_ALL
   Imp 1: AUC = 0.779, ROC saved.
   Imp 2: AUC = 0.785, ROC saved.
   Imp 3: AUC = 0.779, ROC saved.
   Imp 4: AUC = 0.775, ROC saved.
   Imp 5: AUC = 0.786, ROC saved.
 Composite PS + AUC saved for CAT_ALL
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=6b7ac931-822f-4b4a-b79e-62211e9b032c">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[40]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">xgboost</span> <span class="kn">import</span> <span class="n">XGBClassifier</span>

<span class="k">def</span> <span class="nf">compute_feature_importance</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Computing feature importance for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No covariates found for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">covariates</span> <span class="o">=</span> <span class="n">final_covariates_map</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
        <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"outputs"</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">importance_df_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df_imp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_imp</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> not in imputed dataset </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">X</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>

            <span class="c1"># Drop NaNs in treatment</span>
            <span class="n">valid_idx</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">index</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">XGBClassifier</span><span class="p">(</span><span class="n">use_label_encoder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eval_metric</span><span class="o">=</span><span class="s1">'logloss'</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
                <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>

                <span class="c1"># Get feature importance</span>
                <span class="n">importances</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_booster</span><span class="p">()</span><span class="o">.</span><span class="n">get_score</span><span class="p">(</span><span class="n">importance_type</span><span class="o">=</span><span class="s1">'gain'</span><span class="p">)</span>
                <span class="n">df_feat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">importances</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">'index'</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">"imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">])</span>
                <span class="n">df_feat</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">'feature'</span>
                <span class="n">importance_df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_feat</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   Error during modeling: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">importance_df_list</span><span class="p">:</span>
            <span class="c1"># Combine and average</span>
            <span class="n">all_feat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">importance_df_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">all_feat</span><span class="p">[</span><span class="s2">"mean_importance"</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_feat</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Filter top 30 non-zero</span>
            <span class="n">non_zero</span> <span class="o">=</span> <span class="n">all_feat</span><span class="p">[</span><span class="n">all_feat</span><span class="p">[</span><span class="s2">"mean_importance"</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">top30</span> <span class="o">=</span> <span class="n">non_zero</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">"mean_importance"</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>

            <span class="c1"># Save to CSV</span>
            <span class="n">top30</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"feature_importance.csv"</span><span class="p">))</span>

            <span class="c1"># Plot</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top30</span><span class="o">.</span><span class="n">index</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">top30</span><span class="p">[</span><span class="s2">"mean_importance"</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># plot top  bottom</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Mean Gain Importance"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Top 30 Feature Importance - </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"feature_importance_top30.png"</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Saved feature importance plot and CSV for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No valid models for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1">#  Run</span>
<span class="n">compute_feature_importance</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Computing feature importance for CAT_ADHD
 Saved feature importance plot and CSV for CAT_ADHD

 Computing feature importance for CAT_Aceetanilidederivaten
 Saved feature importance plot and CSV for CAT_Aceetanilidederivaten

 Computing feature importance for CAT_Z_drugs
 Saved feature importance plot and CSV for CAT_Z_drugs

 Computing feature importance for CAT_Opioden
 Saved feature importance plot and CSV for CAT_Opioden

 Computing feature importance for CAT_NSAIDs
 Saved feature importance plot and CSV for CAT_NSAIDs

 Computing feature importance for CAT_Benzodiazepine
 Saved feature importance plot and CSV for CAT_Benzodiazepine

 Computing feature importance for CAT_Antihypertensiva
 Saved feature importance plot and CSV for CAT_Antihypertensiva

 Computing feature importance for CAT_Antihistaminica
 Saved feature importance plot and CSV for CAT_Antihistaminica

 Computing feature importance for CAT_Anti_epileptica
 Saved feature importance plot and CSV for CAT_Anti_epileptica

 Computing feature importance for CAT_Antidepressiva
 Saved feature importance plot and CSV for CAT_Antidepressiva

 Computing feature importance for CAT_Antipsychotica
 Saved feature importance plot and CSV for CAT_Antipsychotica

 Computing feature importance for CAT_ALL_PSYCHOTROPICS_EXCL_BENZO
 Saved feature importance plot and CSV for CAT_ALL_PSYCHOTROPICS_EXCL_BENZO

 Computing feature importance for CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS
 Saved feature importance plot and CSV for CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS

 Computing feature importance for CAT_ALL_PSYCHOTROPICS
 Saved feature importance plot and CSV for CAT_ALL_PSYCHOTROPICS

 Computing feature importance for CAT_ALL
 Saved feature importance plot and CSV for CAT_ALL
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=151ba168-9ae5-400a-a2cd-0485a8a7c5a1">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[41]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="k">def</span> <span class="nf">compute_trimmed_clipped_iptw</span><span class="p">(</span><span class="n">ps_df</span><span class="p">,</span> <span class="n">treatment</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">clip_max</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">keep_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">ps_df</span> <span class="o">&gt;</span> <span class="n">lower</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ps_df</span> <span class="o">&lt;</span> <span class="n">upper</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ps_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">ps</span> <span class="o">=</span> <span class="n">ps_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">lower</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">1e-6</span><span class="p">)</span>  <span class="c1"># avoid div by zero</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">keep_mask</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">ps</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="n">w</span><span class="p">[</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">treatment</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">ps</span><span class="p">[</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">treatment</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="n">w</span><span class="p">[</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">treatment</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ps</span><span class="p">[</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">treatment</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)])</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">upper</span><span class="o">=</span><span class="n">clip_max</span><span class="p">)</span>
        <span class="n">weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">apply_rubins_rule_to_iptw</span><span class="p">(</span><span class="n">iptw_matrix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Given an IPTW matrix (n rows  M imputations), return Rubins rule pooled mean, SD, SE.</span>
<span class="sd">    """</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">q_bar</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">u_bar</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">total_var</span> <span class="o">=</span> <span class="n">u_bar</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">M</span><span class="p">)</span> <span class="o">*</span> <span class="n">B</span>
    <span class="n">total_se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">total_var</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">q_bar</span><span class="p">,</span> <span class="n">u_bar</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">total_se</span>


<span class="k">def</span> <span class="nf">run_trim_clip_save_all</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Processing IPTW + trimming + clipping for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"outputs"</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">ps_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"propensity_scores.xlsx"</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ps_path</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Missing PS file: </span><span class="si">{</span><span class="n">ps_path</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ps_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">ps_path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">ps_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">ps_all</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"ps_imp"</span><span class="p">)]</span>
            <span class="n">composite_index</span> <span class="o">=</span> <span class="n">ps_all</span><span class="o">.</span><span class="n">index</span>

            <span class="c1"># Get treatment from one imputed dataset</span>
            <span class="n">T_full</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">imputed_dfs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">T_full</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">composite_index</span><span class="p">,</span> <span class="n">group</span><span class="p">]</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="n">T_full</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Treatment column </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> not found in any imputed dataset."</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Compute IPTW matrix (shape: n  M)</span>
            <span class="n">iptw_matrix</span> <span class="o">=</span> <span class="n">compute_trimmed_clipped_iptw</span><span class="p">(</span><span class="n">ps_all</span><span class="p">[</span><span class="n">ps_cols</span><span class="p">],</span> <span class="n">T_full</span><span class="p">)</span>
            <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">"iptw_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iptw_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>

            <span class="c1"># Apply Rubins Rule for mean, SD, SE</span>
            <span class="n">iptw_matrix</span><span class="p">[</span><span class="s2">"iptw_mean"</span><span class="p">],</span> <span class="n">iptw_matrix</span><span class="p">[</span><span class="s2">"iptw_sd"</span><span class="p">],</span> <span class="n">iptw_matrix</span><span class="p">[</span><span class="s2">"iptw_se"</span><span class="p">]</span> <span class="o">=</span> <span class="n">apply_rubins_rule_to_iptw</span><span class="p">(</span>
                <span class="n">iptw_matrix</span><span class="p">[[</span><span class="sa">f</span><span class="s2">"iptw_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iptw_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]]</span>
            <span class="p">)</span>

            <span class="c1"># Save IPTW matrix separately</span>
            <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"iptw_weights.xlsx"</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Saved IPTW weights for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

            <span class="c1"># Save trimmed &amp; clipped imputed datasets with IPTW</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">imputed_dfs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">trimmed_idx</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="n">needed_cols</span> <span class="o">=</span> <span class="n">final_covariates_map</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">group</span><span class="p">,</span> <span class="s2">"caps5_change_baseline"</span><span class="p">]</span>

                <span class="c1"># Select only necessary columns</span>
                <span class="n">df_trimmed</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">trimmed_idx</span><span class="p">,</span> <span class="n">needed_cols</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">df_trimmed</span><span class="p">[</span><span class="s2">"iptw"</span><span class="p">]</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="p">[</span><span class="sa">f</span><span class="s2">"iptw_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">trimmed_idx</span><span class="p">]</span>

                <span class="c1">#  DROP rows with missing IPTW values</span>
                <span class="n">before</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_trimmed</span><span class="p">)</span>
                <span class="n">df_trimmed</span> <span class="o">=</span> <span class="n">df_trimmed</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">"iptw"</span><span class="p">])</span>
                <span class="n">after</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_trimmed</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"     Retained </span><span class="si">{</span><span class="n">after</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">before</span><span class="si">}</span><span class="s2"> rows after IPTW NaN drop."</span><span class="p">)</span>

                <span class="c1"># Save to .pkl</span>
                <span class="n">df_trimmed</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"trimmed_data_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.pkl"</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   Saved trimmed dataset: </span><span class="si">{</span><span class="n">output_folder</span><span class="si">}</span><span class="s2">/trimmed_data_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.*"</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>


<span class="n">run_trim_clip_save_all</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Processing IPTW + trimming + clipping for CAT_ADHD
 Saved IPTW weights for CAT_ADHD
     Retained 108/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ADHD/trimmed_data_imp1.*
     Retained 97/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ADHD/trimmed_data_imp2.*
     Retained 107/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ADHD/trimmed_data_imp3.*
     Retained 100/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ADHD/trimmed_data_imp4.*
     Retained 104/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ADHD/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for CAT_Aceetanilidederivaten
 Saved IPTW weights for CAT_Aceetanilidederivaten
     Retained 73/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Aceetanilidederivaten/trimmed_data_imp1.*
     Retained 71/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Aceetanilidederivaten/trimmed_data_imp2.*
     Retained 73/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Aceetanilidederivaten/trimmed_data_imp3.*
     Retained 72/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Aceetanilidederivaten/trimmed_data_imp4.*
     Retained 68/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Aceetanilidederivaten/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for CAT_Z_drugs
 Saved IPTW weights for CAT_Z_drugs
     Retained 103/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Z_drugs/trimmed_data_imp1.*
     Retained 101/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Z_drugs/trimmed_data_imp2.*
     Retained 103/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Z_drugs/trimmed_data_imp3.*
     Retained 104/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Z_drugs/trimmed_data_imp4.*
     Retained 104/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Z_drugs/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for CAT_Opioden
 Saved IPTW weights for CAT_Opioden
     Retained 92/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Opioden/trimmed_data_imp1.*
     Retained 94/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Opioden/trimmed_data_imp2.*
     Retained 91/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Opioden/trimmed_data_imp3.*
     Retained 97/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Opioden/trimmed_data_imp4.*
     Retained 94/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Opioden/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for CAT_NSAIDs
 Saved IPTW weights for CAT_NSAIDs
     Retained 65/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_NSAIDs/trimmed_data_imp1.*
     Retained 63/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_NSAIDs/trimmed_data_imp2.*
     Retained 66/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_NSAIDs/trimmed_data_imp3.*
     Retained 68/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_NSAIDs/trimmed_data_imp4.*
     Retained 62/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_NSAIDs/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for CAT_Benzodiazepine
 Saved IPTW weights for CAT_Benzodiazepine
     Retained 1037/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Benzodiazepine/trimmed_data_imp1.*
     Retained 1038/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Benzodiazepine/trimmed_data_imp2.*
     Retained 984/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Benzodiazepine/trimmed_data_imp3.*
     Retained 1105/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Benzodiazepine/trimmed_data_imp4.*
     Retained 1028/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Benzodiazepine/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for CAT_Antihypertensiva
 Saved IPTW weights for CAT_Antihypertensiva
     Retained 85/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antihypertensiva/trimmed_data_imp1.*
     Retained 84/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antihypertensiva/trimmed_data_imp2.*
     Retained 79/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antihypertensiva/trimmed_data_imp3.*
     Retained 85/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antihypertensiva/trimmed_data_imp4.*
     Retained 85/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antihypertensiva/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for CAT_Antihistaminica
 Saved IPTW weights for CAT_Antihistaminica
     Retained 92/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antihistaminica/trimmed_data_imp1.*
     Retained 86/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antihistaminica/trimmed_data_imp2.*
     Retained 100/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antihistaminica/trimmed_data_imp3.*
     Retained 89/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antihistaminica/trimmed_data_imp4.*
     Retained 87/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antihistaminica/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for CAT_Anti_epileptica
 Saved IPTW weights for CAT_Anti_epileptica
     Retained 130/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Anti_epileptica/trimmed_data_imp1.*
     Retained 135/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Anti_epileptica/trimmed_data_imp2.*
     Retained 142/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Anti_epileptica/trimmed_data_imp3.*
     Retained 150/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Anti_epileptica/trimmed_data_imp4.*
     Retained 143/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Anti_epileptica/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for CAT_Antidepressiva
 Saved IPTW weights for CAT_Antidepressiva
     Retained 1593/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antidepressiva/trimmed_data_imp1.*
     Retained 1608/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antidepressiva/trimmed_data_imp2.*
     Retained 1587/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antidepressiva/trimmed_data_imp3.*
     Retained 1602/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antidepressiva/trimmed_data_imp4.*
     Retained 1653/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antidepressiva/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for CAT_Antipsychotica
 Saved IPTW weights for CAT_Antipsychotica
     Retained 591/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antipsychotica/trimmed_data_imp1.*
     Retained 645/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antipsychotica/trimmed_data_imp2.*
     Retained 626/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antipsychotica/trimmed_data_imp3.*
     Retained 630/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antipsychotica/trimmed_data_imp4.*
     Retained 612/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antipsychotica/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for CAT_ALL_PSYCHOTROPICS_EXCL_BENZO
 Saved IPTW weights for CAT_ALL_PSYCHOTROPICS_EXCL_BENZO
     Retained 1951/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL_PSYCHOTROPICS_EXCL_BENZO/trimmed_data_imp1.*
     Retained 1903/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL_PSYCHOTROPICS_EXCL_BENZO/trimmed_data_imp2.*
     Retained 1959/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL_PSYCHOTROPICS_EXCL_BENZO/trimmed_data_imp3.*
     Retained 1980/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL_PSYCHOTROPICS_EXCL_BENZO/trimmed_data_imp4.*
     Retained 1923/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL_PSYCHOTROPICS_EXCL_BENZO/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS
 Saved IPTW weights for CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS
     Retained 1928/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS/trimmed_data_imp1.*
     Retained 1991/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS/trimmed_data_imp2.*
     Retained 1918/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS/trimmed_data_imp3.*
     Retained 1955/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS/trimmed_data_imp4.*
     Retained 1845/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for CAT_ALL_PSYCHOTROPICS
 Saved IPTW weights for CAT_ALL_PSYCHOTROPICS
     Retained 2296/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL_PSYCHOTROPICS/trimmed_data_imp1.*
     Retained 2249/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL_PSYCHOTROPICS/trimmed_data_imp2.*
     Retained 2343/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL_PSYCHOTROPICS/trimmed_data_imp3.*
     Retained 2296/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL_PSYCHOTROPICS/trimmed_data_imp4.*
     Retained 2295/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL_PSYCHOTROPICS/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for CAT_ALL
 Saved IPTW weights for CAT_ALL
     Retained 2303/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL/trimmed_data_imp1.*
     Retained 2242/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL/trimmed_data_imp2.*
     Retained 2279/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL/trimmed_data_imp3.*
     Retained 2290/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL/trimmed_data_imp4.*
     Retained 2354/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL/trimmed_data_imp5.*
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=40ee9f71-87cb-49de-93a7-6ec93070579f">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[42]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="k">def</span> <span class="nf">plot_ps_overlap_all_groups</span><span class="p">(</span><span class="n">medication_groups</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Plotting PS overlap for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="n">folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"outputs"</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">ps_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">"propensity_scores.xlsx"</span><span class="p">)</span>
        <span class="n">iptw_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">"iptw_weights.xlsx"</span><span class="p">)</span>
        <span class="n">trimmed_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">"trimmed_data_imp1.pkl"</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ps_file</span><span class="p">,</span> <span class="n">iptw_file</span><span class="p">,</span> <span class="n">trimmed_file</span><span class="p">]):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Missing required files for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ps_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">ps_file</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">iptw_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">iptw_file</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">trimmed_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">trimmed_file</span><span class="p">)</span>

            <span class="c1"># Extract</span>
            <span class="n">ps</span> <span class="o">=</span> <span class="n">ps_df</span><span class="p">[</span><span class="s2">"composite_ps"</span><span class="p">]</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">trimmed_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">iptw_df</span><span class="p">[</span><span class="s2">"iptw_mean"</span><span class="p">]</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">trimmed_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">trimmed_df</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>

            <span class="c1"># Masks to remove NaNs</span>
            <span class="n">treated_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ps</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">w</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
            <span class="n">control_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ps</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">w</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>

            <span class="n">treated</span> <span class="o">=</span> <span class="n">ps</span><span class="p">[</span><span class="n">treated_mask</span><span class="p">]</span>
            <span class="n">treated_w</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="n">treated_mask</span><span class="p">]</span>

            <span class="n">control</span> <span class="o">=</span> <span class="n">ps</span><span class="p">[</span><span class="n">control_mask</span><span class="p">]</span>
            <span class="n">control_w</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="n">control_mask</span><span class="p">]</span>

            <span class="c1"># === Unweighted Plot ===</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">([</span><span class="n">treated</span><span class="p">,</span> <span class="n">control</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="p">[</span><span class="s2">"Treated"</span><span class="p">,</span> <span class="s2">"Control"</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Unweighted PS Overlap - </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Composite Propensity Score"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"Count"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">"ps_overlap_unweighted.png"</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="c1"># === Weighted Plot ===</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">([</span><span class="n">treated</span><span class="p">,</span> <span class="n">control</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="p">[</span><span class="n">treated_w</span><span class="p">,</span> <span class="n">control_w</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="p">[</span><span class="s2">"Treated"</span><span class="p">,</span> <span class="s2">"Control"</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Weighted PS Overlap - </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Composite Propensity Score"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"Weighted Count"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">"ps_overlap_weighted.png"</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Saved unweighted and weighted PS plots for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error processing </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1">#  Run</span>
<span class="n">plot_ps_overlap_all_groups</span><span class="p">(</span><span class="n">medication_groups</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Plotting PS overlap for CAT_ADHD
 Saved unweighted and weighted PS plots for CAT_ADHD

 Plotting PS overlap for CAT_Aceetanilidederivaten
 Saved unweighted and weighted PS plots for CAT_Aceetanilidederivaten

 Plotting PS overlap for CAT_Z_drugs
 Saved unweighted and weighted PS plots for CAT_Z_drugs

 Plotting PS overlap for CAT_Opioden
 Saved unweighted and weighted PS plots for CAT_Opioden

 Plotting PS overlap for CAT_NSAIDs
 Saved unweighted and weighted PS plots for CAT_NSAIDs

 Plotting PS overlap for CAT_Benzodiazepine
 Saved unweighted and weighted PS plots for CAT_Benzodiazepine

 Plotting PS overlap for CAT_Antihypertensiva
 Saved unweighted and weighted PS plots for CAT_Antihypertensiva

 Plotting PS overlap for CAT_Antihistaminica
 Saved unweighted and weighted PS plots for CAT_Antihistaminica

 Plotting PS overlap for CAT_Anti_epileptica
 Saved unweighted and weighted PS plots for CAT_Anti_epileptica

 Plotting PS overlap for CAT_Antidepressiva
 Saved unweighted and weighted PS plots for CAT_Antidepressiva

 Plotting PS overlap for CAT_Antipsychotica
 Saved unweighted and weighted PS plots for CAT_Antipsychotica

 Plotting PS overlap for CAT_ALL_PSYCHOTROPICS_EXCL_BENZO
 Saved unweighted and weighted PS plots for CAT_ALL_PSYCHOTROPICS_EXCL_BENZO

 Plotting PS overlap for CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS
 Saved unweighted and weighted PS plots for CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS

 Plotting PS overlap for CAT_ALL_PSYCHOTROPICS
 Saved unweighted and weighted PS plots for CAT_ALL_PSYCHOTROPICS

 Plotting PS overlap for CAT_ALL
 Saved unweighted and weighted PS plots for CAT_ALL
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=de65729a-8951-4439-a512-fdbd8bc123fc">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[43]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># Set up base output folder</span>
<span class="n">output_base</span> <span class="o">=</span> <span class="s2">"outputs"</span>
<span class="n">ps_file</span> <span class="o">=</span> <span class="s2">"propensity_scores.xlsx"</span>
<span class="n">iptw_file</span> <span class="o">=</span> <span class="s2">"iptw_weights.xlsx"</span>
<span class="n">trimmed_data_file</span> <span class="o">=</span> <span class="s2">"trimmed_data_imp1.pkl"</span>

<span class="c1"># Collect all treatment group folders</span>
<span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">medication_groups</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">g</span><span class="p">))]</span>

<span class="c1"># Generate 4-panel overlap plots</span>
<span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
    <span class="n">group_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Load trimmed treatment info</span>
        <span class="n">trimmed_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="n">trimmed_data_file</span><span class="p">))</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">trimmed_df</span><span class="o">.</span><span class="n">index</span>

        <span class="c1"># Fix: case-insensitive match for treatment variable</span>
        <span class="n">possible_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">trimmed_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">group</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">possible_cols</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Treatment variable </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> not found in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">, skipping."</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">treatment_var</span> <span class="o">=</span> <span class="n">possible_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">trimmed_df</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span>

        <span class="c1"># Load composite PS (aligned to trimmed_df index)</span>
        <span class="n">ps_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="n">ps_file</span><span class="p">),</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">'composite_ps'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ps_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Composite column missing in </span><span class="si">{</span><span class="n">ps_file</span><span class="si">}</span><span class="s2">, skipping </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">."</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">ps</span> <span class="o">=</span> <span class="n">ps_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s1">'composite_ps'</span><span class="p">]</span>

        <span class="c1"># Load IPTW weights (aligned to trimmed_df index)</span>
        <span class="n">weights_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="n">iptw_file</span><span class="p">),</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">'iptw_mean'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">weights_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" IPTW weight column missing in </span><span class="si">{</span><span class="n">iptw_file</span><span class="si">}</span><span class="s2">, skipping </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">."</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">weights_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s1">'iptw_mean'</span><span class="p">]</span>

        <span class="c1"># Prepare 4 datasets</span>
        <span class="n">raw_treated</span> <span class="o">=</span> <span class="n">ps</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">raw_control</span> <span class="o">=</span> <span class="n">ps</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">weighted_treated</span> <span class="o">=</span> <span class="p">(</span><span class="n">ps</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">],</span> <span class="n">weights</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">weighted_control</span> <span class="o">=</span> <span class="p">(</span><span class="n">ps</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">],</span> <span class="n">weights</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Create plot</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Propensity Score Distribution - </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">raw_treated</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'blue'</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Raw Treated"</span><span class="p">)</span>

        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">raw_control</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'green'</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Raw Control"</span><span class="p">)</span>

        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">weighted_treated</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weighted_treated</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'blue'</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Weighted Treated"</span><span class="p">)</span>

        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">weighted_control</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weighted_control</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'green'</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Weighted Control"</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="o">.</span><span class="n">flat</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Propensity Score"</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Count"</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">])</span>

        <span class="c1"># Save figure</span>
        <span class="n">plot_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"four_panel_overlap_</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">.png"</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_path</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Saved: </span><span class="si">{</span><span class="n">plot_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>  Saved: outputs\CAT_ADHD\four_panel_overlap_CAT_ADHD.png
  Saved: outputs\CAT_Aceetanilidederivaten\four_panel_overlap_CAT_Aceetanilidederivaten.png
  Saved: outputs\CAT_Z_drugs\four_panel_overlap_CAT_Z_drugs.png
  Saved: outputs\CAT_Opioden\four_panel_overlap_CAT_Opioden.png
  Saved: outputs\CAT_NSAIDs\four_panel_overlap_CAT_NSAIDs.png
  Saved: outputs\CAT_Benzodiazepine\four_panel_overlap_CAT_Benzodiazepine.png
  Saved: outputs\CAT_Antihypertensiva\four_panel_overlap_CAT_Antihypertensiva.png
  Saved: outputs\CAT_Antihistaminica\four_panel_overlap_CAT_Antihistaminica.png
  Saved: outputs\CAT_Anti_epileptica\four_panel_overlap_CAT_Anti_epileptica.png
  Saved: outputs\CAT_Antidepressiva\four_panel_overlap_CAT_Antidepressiva.png
  Saved: outputs\CAT_Antipsychotica\four_panel_overlap_CAT_Antipsychotica.png
  Saved: outputs\CAT_ALL_PSYCHOTROPICS_EXCL_BENZO\four_panel_overlap_CAT_ALL_PSYCHOTROPICS_EXCL_BENZO.png
  Saved: outputs\CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS\four_panel_overlap_CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS.png
  Saved: outputs\CAT_ALL_PSYCHOTROPICS\four_panel_overlap_CAT_ALL_PSYCHOTROPICS.png
  Saved: outputs\CAT_ALL\four_panel_overlap_CAT_ALL.png
</pre>
</div>
</div>
</div>
</div>
</div># ATT calculation:<div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=a4f41948-593f-43dd-b58e-821d6545c844">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[44]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Weighted:</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=d2314df2-9945-4767-82df-24455dedfe58">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[45]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">GradientBoostingRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">r2_score</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">KFold</span>
<span class="kn">from</span> <span class="nn">econml.dml</span> <span class="kn">import</span> <span class="n">LinearDML</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">t</span><span class="p">,</span> <span class="n">probplot</span>
<span class="kn">import</span> <span class="nn">xgboost</span> <span class="k">as</span> <span class="nn">xgb</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Configuration</span>
<span class="c1"># -----------------------------</span>
<span class="n">n_repeats</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">seeds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span>
<span class="n">imputations</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">output_folder</span> <span class="o">=</span> <span class="s2">"outputs"</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Diagnostic Plotting Function</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">create_diagnostic_plots</span><span class="p">(</span><span class="n">residuals_data</span><span class="p">,</span> <span class="n">fitted_data</span><span class="p">,</span> <span class="n">group_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Create 4 diagnostic plots for model validation"""</span>
    <span class="n">plots_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"plots"</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">plots_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Flatten the collected data</span>
    <span class="n">all_residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">residuals_data</span><span class="p">)</span>
    <span class="n">all_fitted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">fitted_data</span><span class="p">)</span>
    
    <span class="c1"># Create figure with 2x2 subplots</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Diagnostic Plots - </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">'bold'</span><span class="p">)</span>
    
    <span class="c1"># 1. Residuals vs Fitted</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">all_fitted</span><span class="p">,</span> <span class="n">all_residuals</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Fitted Values'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Residuals'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Residuals vs Fitted'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># 2. QQ Plot</span>
    <span class="n">probplot</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s2">"norm"</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Q-Q Plot (Normal)'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># 3. Residual Histogram</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'skyblue'</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">'black'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Residuals'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Density'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Residual Distribution'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># 4. Scale-Location Plot</span>
    <span class="n">sqrt_abs_residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">))</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">all_fitted</span><span class="p">,</span> <span class="n">sqrt_abs_residuals</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Fitted Values'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'|Residuals|'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Scale-Location Plot'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    
    <span class="c1"># Save plot</span>
    <span class="n">plot_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plots_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s1">.png'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_filename</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">'tight'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Diagnostic plots saved for </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Rubin's Rule</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">rubins_pool</span><span class="p">(</span><span class="n">estimates</span><span class="p">,</span> <span class="n">ses</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">estimates</span><span class="p">)</span>
    <span class="n">q_bar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">estimates</span><span class="p">)</span>
    <span class="n">u_bar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">ses</span><span class="p">))</span>
    <span class="n">b_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">estimates</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">total_var</span> <span class="o">=</span> <span class="n">u_bar</span> <span class="o">+</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">b_m</span><span class="p">)</span>
    <span class="n">total_se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">total_var</span><span class="p">)</span>
    <span class="n">ci_lower</span> <span class="o">=</span> <span class="n">q_bar</span> <span class="o">-</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">total_se</span>
    <span class="n">ci_upper</span> <span class="o">=</span> <span class="n">q_bar</span> <span class="o">+</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">total_se</span>
    <span class="n">p_value</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">q_bar</span> <span class="o">/</span> <span class="n">total_se</span><span class="p">),</span> <span class="n">df</span><span class="o">=</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">rounded_p</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">p_value</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">formatted_p</span> <span class="o">=</span> <span class="s2">"&lt; 0.00001"</span> <span class="k">if</span> <span class="n">rounded_p</span> <span class="o">&lt;=</span> <span class="mf">0.00001</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">rounded_p</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">return</span> <span class="n">q_bar</span><span class="p">,</span> <span class="n">total_se</span><span class="p">,</span> <span class="n">ci_lower</span><span class="p">,</span> <span class="n">ci_upper</span><span class="p">,</span> <span class="n">formatted_p</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># SMD + Variance Ratio</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">calculate_smd_vr</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
    <span class="n">treated</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">control</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">w_treated</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">w_control</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">smd</span><span class="p">,</span> <span class="n">vr</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m1</span><span class="p">,</span> <span class="n">m0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">treated</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">w_treated</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">control</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">w_control</span><span class="p">)</span>
            <span class="n">s1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">((</span><span class="n">treated</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">-</span> <span class="n">m1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w_treated</span><span class="p">))</span>
            <span class="n">s0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">((</span><span class="n">control</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">-</span> <span class="n">m0</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w_control</span><span class="p">))</span>
            <span class="n">pooled_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">s1</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">s0</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">smd</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">m1</span> <span class="o">-</span> <span class="n">m0</span><span class="p">)</span> <span class="o">/</span> <span class="n">pooled_sd</span> <span class="k">if</span> <span class="n">pooled_sd</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">vr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s1</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">s0</span><span class="o">**</span><span class="mi">2</span> <span class="k">if</span> <span class="n">s0</span><span class="o">**</span><span class="mi">2</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">smd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">vr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">smd</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">vr</span><span class="p">)</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># DML Main Loop</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">run_dml_with_trimmed_data</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="p">):</span>
    <span class="n">att_results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">balance_results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">covariates</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Running DML for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">group_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">group_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">best_result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">best_se</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">"inf"</span><span class="p">)</span>
        
        <span class="c1"># Initialize lists to collect residuals and fitted values for diagnostic plots</span>
        <span class="n">group_residuals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">group_fitted</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="n">seeds</span><span class="p">:</span>
            <span class="n">att_list</span><span class="p">,</span> <span class="n">se_list</span><span class="p">,</span> <span class="n">r2_list</span><span class="p">,</span> <span class="n">rmse_list</span><span class="p">,</span> <span class="n">smd_list</span><span class="p">,</span> <span class="n">vr_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">imp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">imputations</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"trimmed_data_imp</span><span class="si">{</span><span class="n">imp</span><span class="si">}</span><span class="s2">.pkl"</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">or</span> <span class="s2">"iptw"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">T</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
                <span class="n">Y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">"caps5_change_baseline"</span><span class="p">]</span>
                <span class="n">W</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">"iptw"</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">repeat</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_repeats</span><span class="p">):</span>
                    <span class="n">kf</span> <span class="o">=</span> <span class="n">KFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span> <span class="o">+</span> <span class="n">repeat</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">train_idx</span><span class="p">,</span> <span class="n">test_idx</span> <span class="ow">in</span> <span class="n">kf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">X_train</span><span class="p">,</span> <span class="n">T_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">W_train</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span>
                                <span class="n">T</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span>
                                <span class="n">Y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span>
                                <span class="n">W</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span>
                            <span class="p">)</span>

                            <span class="n">model_y</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
                            <span class="n">model_t</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                        <span class="n">use_label_encoder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eval_metric</span><span class="o">=</span><span class="s2">"logloss"</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>

                            <span class="n">dml</span> <span class="o">=</span> <span class="n">LinearDML</span><span class="p">(</span><span class="n">model_y</span><span class="o">=</span><span class="n">model_y</span><span class="p">,</span> <span class="n">model_t</span><span class="o">=</span><span class="n">model_t</span><span class="p">,</span> <span class="n">discrete_treatment</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                            <span class="n">cv</span><span class="o">=</span><span class="n">KFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">),</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
                            <span class="n">dml</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Y_train</span><span class="p">,</span> <span class="n">T_train</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">X_train</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="n">W_train</span><span class="p">)</span>

                            <span class="n">tau</span> <span class="o">=</span> <span class="n">dml</span><span class="o">.</span><span class="n">effect</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
                            <span class="n">att</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span>
                            <span class="n">influence</span> <span class="o">=</span> <span class="n">tau</span> <span class="o">-</span> <span class="n">att</span>
                            <span class="n">se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">influence</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">tau</span><span class="p">))</span>

                            <span class="n">att_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">att</span><span class="p">)</span>
                            <span class="n">se_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">se</span><span class="p">)</span>

                            <span class="n">Y_pred</span> <span class="o">=</span> <span class="n">model_y</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="n">W_train</span><span class="p">)</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
                            <span class="n">residuals</span> <span class="o">=</span> <span class="n">Y_train</span> <span class="o">-</span> <span class="n">Y_pred</span>
                            <span class="n">rmse</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_pred</span><span class="p">,</span> <span class="n">squared</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                            <span class="n">r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_pred</span><span class="p">)</span>
                            <span class="n">r2_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
                            <span class="n">rmse_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rmse</span><span class="p">)</span>
                            
                            <span class="c1"># Collect residuals and fitted values for diagnostic plots</span>
                            <span class="n">group_residuals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">residuals</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                            <span class="n">group_fitted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Y_pred</span><span class="p">)</span>

                            <span class="n">smd</span><span class="p">,</span> <span class="n">vr</span> <span class="o">=</span> <span class="n">calculate_smd_vr</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">T_train</span><span class="p">,</span> <span class="n">W_train</span><span class="p">)</span>
                            <span class="n">smd_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smd</span><span class="p">)</span>
                            <span class="n">vr_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vr</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">, seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">, imp </span><span class="si">{</span><span class="n">imp</span><span class="si">}</span><span class="s2">, rep </span><span class="si">{</span><span class="n">repeat</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">att_list</span><span class="p">:</span>
                <span class="n">att</span><span class="p">,</span> <span class="n">se</span><span class="p">,</span> <span class="n">ci_l</span><span class="p">,</span> <span class="n">ci_u</span><span class="p">,</span> <span class="n">p_val</span> <span class="o">=</span> <span class="n">rubins_pool</span><span class="p">(</span><span class="n">att_list</span><span class="p">,</span> <span class="n">se_list</span><span class="p">)</span>
                <span class="n">avg_r2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">r2_list</span><span class="p">)</span>
                <span class="n">avg_rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rmse_list</span><span class="p">)</span>
                <span class="n">avg_smd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">smd_list</span><span class="p">)</span>
                <span class="n">avg_vr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">vr_list</span><span class="p">)</span>

                <span class="n">balance_results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">"group"</span><span class="p">:</span> <span class="n">group</span><span class="p">,</span> <span class="s2">"seed"</span><span class="p">:</span> <span class="n">seed</span><span class="p">,</span> <span class="s2">"smd"</span><span class="p">:</span> <span class="n">avg_smd</span><span class="p">,</span> <span class="s2">"vr"</span><span class="p">:</span> <span class="n">avg_vr</span>
                <span class="p">})</span>

                <span class="k">if</span> <span class="n">se</span> <span class="o">&lt;</span> <span class="n">best_se</span><span class="p">:</span>
                    <span class="n">best_se</span> <span class="o">=</span> <span class="n">se</span>
                    <span class="n">best_result</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">"group"</span><span class="p">:</span> <span class="n">group</span><span class="p">,</span> <span class="s2">"seed"</span><span class="p">:</span> <span class="n">seed</span><span class="p">,</span> <span class="s2">"att"</span><span class="p">:</span> <span class="n">att</span><span class="p">,</span> <span class="s2">"se"</span><span class="p">:</span> <span class="n">se</span><span class="p">,</span>
                        <span class="s2">"ci_lower"</span><span class="p">:</span> <span class="n">ci_l</span><span class="p">,</span> <span class="s2">"ci_upper"</span><span class="p">:</span> <span class="n">ci_u</span><span class="p">,</span> <span class="s2">"p_value"</span><span class="p">:</span> <span class="n">p_val</span><span class="p">,</span>
                        <span class="s2">"r2"</span><span class="p">:</span> <span class="n">avg_r2</span><span class="p">,</span> <span class="s2">"rmse"</span><span class="p">:</span> <span class="n">avg_rmse</span>
                    <span class="p">}</span>

                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> | Seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">: ATT = </span><span class="si">{</span><span class="n">att</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, SE = </span><span class="si">{</span><span class="n">se</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, p = </span><span class="si">{</span><span class="n">p_val</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No valid results for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> | Seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Create diagnostic plots for this group</span>
        <span class="k">if</span> <span class="n">group_residuals</span> <span class="ow">and</span> <span class="n">group_fitted</span><span class="p">:</span>
            <span class="n">create_diagnostic_plots</span><span class="p">(</span><span class="n">group_residuals</span><span class="p">,</span> <span class="n">group_fitted</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">best_result</span><span class="p">:</span>
            <span class="n">att_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">best_result</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Best result for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">  Seed </span><span class="si">{</span><span class="n">best_result</span><span class="p">[</span><span class="s1">'seed'</span><span class="p">]</span><span class="si">}</span><span class="s2"> | SE = </span><span class="si">{</span><span class="n">best_result</span><span class="p">[</span><span class="s1">'se'</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="c1"># Save final output</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">att_results</span><span class="p">)</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">"dml_rubin_summary_cats.xlsx"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">balance_results</span><span class="p">)</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">"smd_vr_summary_cats.xlsx"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> All summary files saved."</span><span class="p">)</span>

<span class="n">run_dml_with_trimmed_data</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Running DML for CAT_ADHD
 CAT_ADHD | Seed 1: ATT = 1.2397, SE = 6.8200, p = 0.85613
 CAT_ADHD | Seed 2: ATT = 1.0542, SE = 4.5240, p = 0.81623
 CAT_ADHD | Seed 3: ATT = 1.5099, SE = 4.1519, p = 0.71688
 CAT_ADHD | Seed 4: ATT = 0.5644, SE = 4.3396, p = 0.89678
 CAT_ADHD | Seed 5: ATT = 1.0534, SE = 4.3665, p = 0.80987
 CAT_ADHD | Seed 6: ATT = 0.9717, SE = 5.1615, p = 0.85105
 CAT_ADHD | Seed 7: ATT = 0.4021, SE = 4.4526, p = 0.92822
 CAT_ADHD | Seed 8: ATT = 1.3008, SE = 5.2249, p = 0.80390
 CAT_ADHD | Seed 9: ATT = 0.4596, SE = 5.6194, p = 0.93498
 CAT_ADHD | Seed 10: ATT = 0.7922, SE = 4.1617, p = 0.84942
 Diagnostic plots saved for CAT_ADHD
 Best result for CAT_ADHD  Seed 3 | SE = 4.1519

 Running DML for CAT_Aceetanilidederivaten
 CAT_Aceetanilidederivaten | Seed 1: ATT = 1.2488, SE = 5.2711, p = 0.81322
 CAT_Aceetanilidederivaten | Seed 2: ATT = 1.2627, SE = 4.9976, p = 0.80106
 CAT_Aceetanilidederivaten | Seed 3: ATT = 1.0622, SE = 5.3644, p = 0.84344
 CAT_Aceetanilidederivaten | Seed 4: ATT = 1.9898, SE = 5.6774, p = 0.72672
 CAT_Aceetanilidederivaten | Seed 5: ATT = 1.3893, SE = 6.3578, p = 0.82747
 CAT_Aceetanilidederivaten | Seed 6: ATT = 1.1894, SE = 5.6943, p = 0.83497
 CAT_Aceetanilidederivaten | Seed 7: ATT = 1.0065, SE = 5.4010, p = 0.85256
 CAT_Aceetanilidederivaten | Seed 8: ATT = 1.2191, SE = 5.4568, p = 0.82368
 CAT_Aceetanilidederivaten | Seed 9: ATT = 0.7507, SE = 5.5238, p = 0.89217
 CAT_Aceetanilidederivaten | Seed 10: ATT = 0.8017, SE = 6.2285, p = 0.89785
 Diagnostic plots saved for CAT_Aceetanilidederivaten
 Best result for CAT_Aceetanilidederivaten  Seed 2 | SE = 4.9976

 Running DML for CAT_Z_drugs
 CAT_Z_drugs | Seed 1: ATT = 4.3864, SE = 4.1416, p = 0.29213
 CAT_Z_drugs | Seed 2: ATT = 4.4270, SE = 4.2567, p = 0.30086
 CAT_Z_drugs | Seed 3: ATT = 4.3088, SE = 4.8799, p = 0.37939
 CAT_Z_drugs | Seed 4: ATT = 3.8424, SE = 4.5543, p = 0.40088
 CAT_Z_drugs | Seed 5: ATT = 4.2215, SE = 5.1842, p = 0.41742
 CAT_Z_drugs | Seed 6: ATT = 4.0267, SE = 4.4930, p = 0.37232
 CAT_Z_drugs | Seed 7: ATT = 3.8418, SE = 5.2509, p = 0.46612
 CAT_Z_drugs | Seed 8: ATT = 4.4595, SE = 4.2071, p = 0.29172
 CAT_Z_drugs | Seed 9: ATT = 4.3388, SE = 4.6932, p = 0.35748
 CAT_Z_drugs | Seed 10: ATT = 4.0097, SE = 5.4015, p = 0.45964
 Diagnostic plots saved for CAT_Z_drugs
 Best result for CAT_Z_drugs  Seed 1 | SE = 4.1416

 Running DML for CAT_Opioden
 CAT_Opioden | Seed 1: ATT = 4.0693, SE = 4.8407, p = 0.40257
 CAT_Opioden | Seed 2: ATT = 4.5005, SE = 5.3258, p = 0.40013
 CAT_Opioden | Seed 3: ATT = 4.1958, SE = 4.3366, p = 0.33564
 CAT_Opioden | Seed 4: ATT = 3.9487, SE = 4.7029, p = 0.40314
 CAT_Opioden | Seed 5: ATT = 4.3587, SE = 4.6683, p = 0.35274
 CAT_Opioden | Seed 6: ATT = 4.1139, SE = 4.5220, p = 0.36517
 CAT_Opioden | Seed 7: ATT = 4.1148, SE = 4.2603, p = 0.33646
 CAT_Opioden | Seed 8: ATT = 4.4443, SE = 4.8451, p = 0.36122
 CAT_Opioden | Seed 9: ATT = 4.3168, SE = 4.2902, p = 0.31677
 CAT_Opioden | Seed 10: ATT = 4.5252, SE = 5.3339, p = 0.39827
 Diagnostic plots saved for CAT_Opioden
 Best result for CAT_Opioden  Seed 7 | SE = 4.2603

 Running DML for CAT_NSAIDs
 CAT_NSAIDs | Seed 1: ATT = 4.4268, SE = 5.4180, p = 0.41586
 CAT_NSAIDs | Seed 2: ATT = 4.2226, SE = 5.8859, p = 0.47481
 CAT_NSAIDs | Seed 3: ATT = 4.1298, SE = 6.1718, p = 0.50496
 CAT_NSAIDs | Seed 4: ATT = 3.7619, SE = 5.8035, p = 0.51835
 CAT_NSAIDs | Seed 5: ATT = 5.0570, SE = 6.0422, p = 0.40464
 CAT_NSAIDs | Seed 6: ATT = 4.4886, SE = 5.5095, p = 0.41719
 CAT_NSAIDs | Seed 7: ATT = 4.3988, SE = 5.3397, p = 0.41204
 CAT_NSAIDs | Seed 8: ATT = 4.0738, SE = 6.3203, p = 0.52071
 CAT_NSAIDs | Seed 9: ATT = 4.5370, SE = 6.3793, p = 0.47863
 CAT_NSAIDs | Seed 10: ATT = 4.2460, SE = 5.8957, p = 0.47311
 Diagnostic plots saved for CAT_NSAIDs
 Best result for CAT_NSAIDs  Seed 7 | SE = 5.3397

 Running DML for CAT_Benzodiazepine
 CAT_Benzodiazepine | Seed 1: ATT = -0.2558, SE = 0.9627, p = 0.79098
 CAT_Benzodiazepine | Seed 2: ATT = -0.2672, SE = 0.9231, p = 0.77281
 CAT_Benzodiazepine | Seed 3: ATT = -0.2483, SE = 0.8837, p = 0.77934
 CAT_Benzodiazepine | Seed 4: ATT = -0.3068, SE = 0.9126, p = 0.73745
 CAT_Benzodiazepine | Seed 5: ATT = -0.1797, SE = 0.8420, p = 0.83145
 CAT_Benzodiazepine | Seed 6: ATT = -0.4079, SE = 1.0038, p = 0.68535
 CAT_Benzodiazepine | Seed 7: ATT = -0.3509, SE = 0.9855, p = 0.72257
 CAT_Benzodiazepine | Seed 8: ATT = -0.3092, SE = 0.9809, p = 0.75325
 CAT_Benzodiazepine | Seed 9: ATT = -0.3217, SE = 0.9604, p = 0.73833
 CAT_Benzodiazepine | Seed 10: ATT = -0.2992, SE = 1.0070, p = 0.76695
 Diagnostic plots saved for CAT_Benzodiazepine
 Best result for CAT_Benzodiazepine  Seed 5 | SE = 0.8420

 Running DML for CAT_Antihypertensiva
 CAT_Antihypertensiva | Seed 1: ATT = -1.3355, SE = 4.1276, p = 0.74696
 CAT_Antihypertensiva | Seed 2: ATT = -1.4657, SE = 4.0243, p = 0.71647
 CAT_Antihypertensiva | Seed 3: ATT = -1.7286, SE = 4.2162, p = 0.68270
 CAT_Antihypertensiva | Seed 4: ATT = -1.4511, SE = 3.9191, p = 0.71197
 CAT_Antihypertensiva | Seed 5: ATT = -1.2701, SE = 3.9168, p = 0.74642
 CAT_Antihypertensiva | Seed 6: ATT = -1.5945, SE = 4.3657, p = 0.71572
 CAT_Antihypertensiva | Seed 7: ATT = -1.1495, SE = 3.9985, p = 0.77435
 CAT_Antihypertensiva | Seed 8: ATT = -1.7411, SE = 4.2259, p = 0.68122
 CAT_Antihypertensiva | Seed 9: ATT = -1.2409, SE = 4.3100, p = 0.77401
 CAT_Antihypertensiva | Seed 10: ATT = -1.2731, SE = 3.9092, p = 0.74537
 Diagnostic plots saved for CAT_Antihypertensiva
 Best result for CAT_Antihypertensiva  Seed 10 | SE = 3.9092

 Running DML for CAT_Antihistaminica
 CAT_Antihistaminica | Seed 1: ATT = 1.0494, SE = 3.5695, p = 0.76938
 CAT_Antihistaminica | Seed 2: ATT = 0.9492, SE = 6.3918, p = 0.88225
 CAT_Antihistaminica | Seed 3: ATT = 1.4944, SE = 3.9914, p = 0.70890
 CAT_Antihistaminica | Seed 4: ATT = 1.3157, SE = 4.0198, p = 0.74414
 CAT_Antihistaminica | Seed 5: ATT = 1.0048, SE = 3.7039, p = 0.78674
 CAT_Antihistaminica | Seed 6: ATT = 0.8490, SE = 3.3619, p = 0.80116
 CAT_Antihistaminica | Seed 7: ATT = 1.5276, SE = 3.9651, p = 0.70088
 CAT_Antihistaminica | Seed 8: ATT = 1.4281, SE = 3.4583, p = 0.68053
 CAT_Antihistaminica | Seed 9: ATT = 1.2404, SE = 4.2479, p = 0.77089
 CAT_Antihistaminica | Seed 10: ATT = 0.5803, SE = 3.7209, p = 0.87639
 Diagnostic plots saved for CAT_Antihistaminica
 Best result for CAT_Antihistaminica  Seed 6 | SE = 3.3619

 Running DML for CAT_Anti_epileptica
 CAT_Anti_epileptica | Seed 1: ATT = 4.0682, SE = 3.0481, p = 0.18505
 CAT_Anti_epileptica | Seed 2: ATT = 4.1659, SE = 2.9182, p = 0.15657
 CAT_Anti_epileptica | Seed 3: ATT = 4.3967, SE = 2.9044, p = 0.13326
 CAT_Anti_epileptica | Seed 4: ATT = 4.1300, SE = 2.9061, p = 0.15842
 CAT_Anti_epileptica | Seed 5: ATT = 3.6379, SE = 2.8515, p = 0.20501
 CAT_Anti_epileptica | Seed 6: ATT = 4.1544, SE = 2.9276, p = 0.15902
 CAT_Anti_epileptica | Seed 7: ATT = 4.5752, SE = 3.4405, p = 0.18664
 CAT_Anti_epileptica | Seed 8: ATT = 4.1149, SE = 3.2270, p = 0.20524
 CAT_Anti_epileptica | Seed 9: ATT = 3.8860, SE = 2.8143, p = 0.17046
 CAT_Anti_epileptica | Seed 10: ATT = 4.2798, SE = 3.4812, p = 0.22184
 Diagnostic plots saved for CAT_Anti_epileptica
 Best result for CAT_Anti_epileptica  Seed 9 | SE = 2.8143

 Running DML for CAT_Antidepressiva
 CAT_Antidepressiva | Seed 1: ATT = 0.9173, SE = 0.5764, p = 0.11471
 CAT_Antidepressiva | Seed 2: ATT = 0.9669, SE = 0.6308, p = 0.12850
 CAT_Antidepressiva | Seed 3: ATT = 0.9513, SE = 0.6497, p = 0.14633
 CAT_Antidepressiva | Seed 4: ATT = 0.9039, SE = 0.6570, p = 0.17199
 CAT_Antidepressiva | Seed 5: ATT = 0.9679, SE = 0.5964, p = 0.10777
 CAT_Antidepressiva | Seed 6: ATT = 0.9517, SE = 0.5624, p = 0.09374
 CAT_Antidepressiva | Seed 7: ATT = 0.9071, SE = 0.5716, p = 0.11575
 CAT_Antidepressiva | Seed 8: ATT = 0.9479, SE = 0.5834, p = 0.10736
 CAT_Antidepressiva | Seed 9: ATT = 0.9443, SE = 0.5745, p = 0.10341
 CAT_Antidepressiva | Seed 10: ATT = 0.9688, SE = 0.6184, p = 0.12036
 Diagnostic plots saved for CAT_Antidepressiva
 Best result for CAT_Antidepressiva  Seed 6 | SE = 0.5624

 Running DML for CAT_Antipsychotica
 CAT_Antipsychotica | Seed 1: ATT = 0.0602, SE = 1.3384, p = 0.96423
 CAT_Antipsychotica | Seed 2: ATT = 0.0118, SE = 1.1681, p = 0.99197
 CAT_Antipsychotica | Seed 3: ATT = 0.0513, SE = 1.2220, p = 0.96663
 CAT_Antipsychotica | Seed 4: ATT = 0.0583, SE = 1.3256, p = 0.96503
 CAT_Antipsychotica | Seed 5: ATT = -0.0859, SE = 1.2940, p = 0.94722
 CAT_Antipsychotica | Seed 6: ATT = -0.0261, SE = 1.3829, p = 0.98496
 CAT_Antipsychotica | Seed 7: ATT = 0.0927, SE = 1.2925, p = 0.94294
 CAT_Antipsychotica | Seed 8: ATT = 0.0984, SE = 1.1501, p = 0.93201
 CAT_Antipsychotica | Seed 9: ATT = 0.0237, SE = 1.2384, p = 0.98478
 CAT_Antipsychotica | Seed 10: ATT = 0.0685, SE = 1.1863, p = 0.95409
 Diagnostic plots saved for CAT_Antipsychotica
 Best result for CAT_Antipsychotica  Seed 8 | SE = 1.1501

 Running DML for CAT_ALL_PSYCHOTROPICS_EXCL_BENZO
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 1: ATT = 2.1013, SE = 0.8390, p = 0.01390
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 2: ATT = 2.0745, SE = 0.7779, p = 0.00895
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 3: ATT = 2.0548, SE = 0.8415, p = 0.01639
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 4: ATT = 2.1236, SE = 0.8545, p = 0.01463
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 5: ATT = 2.0215, SE = 0.7890, p = 0.01191
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 6: ATT = 2.1132, SE = 0.7610, p = 0.00656
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 7: ATT = 2.1050, SE = 0.7209, p = 0.00433
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 8: ATT = 2.0591, SE = 0.7544, p = 0.00751
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 9: ATT = 2.0591, SE = 0.7822, p = 0.00984
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 10: ATT = 2.1015, SE = 0.8038, p = 0.01033
 Diagnostic plots saved for CAT_ALL_PSYCHOTROPICS_EXCL_BENZO
 Best result for CAT_ALL_PSYCHOTROPICS_EXCL_BENZO  Seed 7 | SE = 0.7209

 Running DML for CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 1: ATT = 1.7484, SE = 0.5952, p = 0.00411
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 2: ATT = 1.6990, SE = 0.6119, p = 0.00657
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 3: ATT = 1.6970, SE = 0.6355, p = 0.00886
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 4: ATT = 1.7111, SE = 0.6322, p = 0.00801
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 5: ATT = 1.7845, SE = 0.6662, p = 0.00866
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 6: ATT = 1.7150, SE = 0.6870, p = 0.01420
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 7: ATT = 1.7247, SE = 0.6196, p = 0.00644
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 8: ATT = 1.7094, SE = 0.6491, p = 0.00980
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 9: ATT = 1.7295, SE = 0.6573, p = 0.00986
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 10: ATT = 1.7005, SE = 0.6696, p = 0.01265
 Diagnostic plots saved for CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS
 Best result for CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS  Seed 1 | SE = 0.5952

 Running DML for CAT_ALL_PSYCHOTROPICS
 CAT_ALL_PSYCHOTROPICS | Seed 1: ATT = 2.2116, SE = 0.6231, p = 0.00059
 CAT_ALL_PSYCHOTROPICS | Seed 2: ATT = 2.2051, SE = 0.5700, p = 0.00020
 CAT_ALL_PSYCHOTROPICS | Seed 3: ATT = 2.1709, SE = 0.6135, p = 0.00061
 CAT_ALL_PSYCHOTROPICS | Seed 4: ATT = 2.1973, SE = 0.6261, p = 0.00068
 CAT_ALL_PSYCHOTROPICS | Seed 5: ATT = 2.1975, SE = 0.6225, p = 0.00063
 CAT_ALL_PSYCHOTROPICS | Seed 6: ATT = 2.2259, SE = 0.6456, p = 0.00083
 CAT_ALL_PSYCHOTROPICS | Seed 7: ATT = 2.2151, SE = 0.6266, p = 0.00062
 CAT_ALL_PSYCHOTROPICS | Seed 8: ATT = 2.1577, SE = 0.7036, p = 0.00279
 CAT_ALL_PSYCHOTROPICS | Seed 9: ATT = 2.2173, SE = 0.6011, p = 0.00037
 CAT_ALL_PSYCHOTROPICS | Seed 10: ATT = 2.2728, SE = 0.6043, p = 0.00029
 Diagnostic plots saved for CAT_ALL_PSYCHOTROPICS
 Best result for CAT_ALL_PSYCHOTROPICS  Seed 2 | SE = 0.5700

 Running DML for CAT_ALL
 CAT_ALL | Seed 1: ATT = 2.1911, SE = 0.6865, p = 0.00189
 CAT_ALL | Seed 2: ATT = 2.1396, SE = 0.6691, p = 0.00186
 CAT_ALL | Seed 3: ATT = 2.1674, SE = 0.5976, p = 0.00046
 CAT_ALL | Seed 4: ATT = 2.2021, SE = 0.6310, p = 0.00072
 CAT_ALL | Seed 5: ATT = 2.1853, SE = 0.6112, p = 0.00054
 CAT_ALL | Seed 6: ATT = 2.1492, SE = 0.5949, p = 0.00048
 CAT_ALL | Seed 7: ATT = 2.1953, SE = 0.6116, p = 0.00052
 CAT_ALL | Seed 8: ATT = 2.1618, SE = 0.6114, p = 0.00062
 CAT_ALL | Seed 9: ATT = 2.2230, SE = 0.6640, p = 0.00115
 CAT_ALL | Seed 10: ATT = 2.1913, SE = 0.5782, p = 0.00026
 Diagnostic plots saved for CAT_ALL
 Best result for CAT_ALL  Seed 10 | SE = 0.5782

 All summary files saved.
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=f18c032f-2250-4dc4-90ec-85ac7faa6f84">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[46]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Unweighted:</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=f2a2f7f2-1ca7-4fe4-a039-2c0ce9ba9a4a">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[47]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">GradientBoostingRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">r2_score</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">KFold</span>
<span class="kn">from</span> <span class="nn">econml.dml</span> <span class="kn">import</span> <span class="n">LinearDML</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">t</span><span class="p">,</span> <span class="n">probplot</span>
<span class="kn">import</span> <span class="nn">xgboost</span> <span class="k">as</span> <span class="nn">xgb</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Configuration</span>
<span class="c1"># -----------------------------</span>
<span class="n">n_repeats</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">seeds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span>
<span class="n">imputations</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">output_folder</span> <span class="o">=</span> <span class="s2">"outputs"</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Plotting Functions</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">create_diagnostic_plots</span><span class="p">(</span><span class="n">residuals_data</span><span class="p">,</span> <span class="n">group_name</span><span class="p">,</span> <span class="n">output_folder</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Create diagnostic plots for each group"""</span>
    <span class="n">plots_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"plots"</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">plots_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="n">all_residuals</span> <span class="o">=</span> <span class="n">residuals_data</span><span class="p">[</span><span class="s1">'residuals'</span><span class="p">]</span>
    <span class="n">all_fitted</span> <span class="o">=</span> <span class="n">residuals_data</span><span class="p">[</span><span class="s1">'fitted'</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>
    
    <span class="c1"># Create figure with subplots</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Diagnostic Plots - </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">'bold'</span><span class="p">)</span>
    
    <span class="c1"># 1. Residuals vs Fitted</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">all_fitted</span><span class="p">,</span> <span class="n">all_residuals</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Fitted Values'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Residuals'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Residuals vs Fitted'</span><span class="p">)</span>
    
    <span class="c1"># 2. QQ Plot</span>
    <span class="n">probplot</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s2">"norm"</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'QQ Plot (Normal)'</span><span class="p">)</span>
    
    <span class="c1"># 3. Histogram of Residuals</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">'black'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Residuals'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Frequency'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Residual Distribution'</span><span class="p">)</span>
    
    <span class="c1"># 4. Scale-Location Plot</span>
    <span class="n">sqrt_abs_resid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">))</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">all_fitted</span><span class="p">,</span> <span class="n">sqrt_abs_resid</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Fitted Values'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'|Residuals|'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Scale-Location Plot'</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plots_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s1">_unweighted.png'</span><span class="p">),</span> 
                <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">'tight'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Rubin's Rule</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">rubins_pool</span><span class="p">(</span><span class="n">estimates</span><span class="p">,</span> <span class="n">ses</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">estimates</span><span class="p">)</span>
    <span class="n">q_bar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">estimates</span><span class="p">)</span>
    <span class="n">u_bar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">ses</span><span class="p">))</span>
    <span class="n">b_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">estimates</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">total_var</span> <span class="o">=</span> <span class="n">u_bar</span> <span class="o">+</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">b_m</span><span class="p">)</span>
    <span class="n">total_se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">total_var</span><span class="p">)</span>
    <span class="n">ci_lower</span> <span class="o">=</span> <span class="n">q_bar</span> <span class="o">-</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">total_se</span>
    <span class="n">ci_upper</span> <span class="o">=</span> <span class="n">q_bar</span> <span class="o">+</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">total_se</span>
    <span class="n">p_value</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">q_bar</span> <span class="o">/</span> <span class="n">total_se</span><span class="p">),</span> <span class="n">df</span><span class="o">=</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">rounded_p</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">p_value</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">formatted_p</span> <span class="o">=</span> <span class="s2">"&lt; 0.00001"</span> <span class="k">if</span> <span class="n">rounded_p</span> <span class="o">&lt;=</span> <span class="mf">0.00001</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">rounded_p</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">return</span> <span class="n">q_bar</span><span class="p">,</span> <span class="n">total_se</span><span class="p">,</span> <span class="n">ci_lower</span><span class="p">,</span> <span class="n">ci_upper</span><span class="p">,</span> <span class="n">formatted_p</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># SMD + Variance Ratio</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">calculate_smd_vr</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
    <span class="n">treated</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">control</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">smd</span><span class="p">,</span> <span class="n">vr</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m1</span><span class="p">,</span> <span class="n">m0</span> <span class="o">=</span> <span class="n">treated</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">control</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">s1</span><span class="p">,</span> <span class="n">s0</span> <span class="o">=</span> <span class="n">treated</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span> <span class="n">control</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
            <span class="n">pooled_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">s1</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">s0</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">smd</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">m1</span> <span class="o">-</span> <span class="n">m0</span><span class="p">)</span> <span class="o">/</span> <span class="n">pooled_sd</span> <span class="k">if</span> <span class="n">pooled_sd</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">vr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s1</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">s0</span><span class="o">**</span><span class="mi">2</span> <span class="k">if</span> <span class="n">s0</span><span class="o">**</span><span class="mi">2</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">smd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">vr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">smd</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">vr</span><span class="p">)</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># DML Main Loop</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">run_dml_with_trimmed_data</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="p">):</span>
    <span class="n">att_results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">balance_results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">covariates</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Running DML for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">group_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">group_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">best_result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">best_se</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">"inf"</span><span class="p">)</span>
        
        <span class="c1"># Initialize residuals collection for this group</span>
        <span class="n">group_residuals_data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'residuals'</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">'fitted'</span><span class="p">:</span> <span class="p">[]}</span>

        <span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="n">seeds</span><span class="p">:</span>
            <span class="n">att_list</span><span class="p">,</span> <span class="n">se_list</span><span class="p">,</span> <span class="n">r2_list</span><span class="p">,</span> <span class="n">rmse_list</span><span class="p">,</span> <span class="n">smd_list</span><span class="p">,</span> <span class="n">vr_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">imp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">imputations</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"trimmed_data_imp</span><span class="si">{</span><span class="n">imp</span><span class="si">}</span><span class="s2">.pkl"</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">T</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
                <span class="n">Y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">"caps5_change_baseline"</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">repeat</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_repeats</span><span class="p">):</span>
                    <span class="n">kf</span> <span class="o">=</span> <span class="n">KFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span> <span class="o">+</span> <span class="n">repeat</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">train_idx</span><span class="p">,</span> <span class="n">test_idx</span> <span class="ow">in</span> <span class="n">kf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">X_train</span><span class="p">,</span> <span class="n">T_train</span><span class="p">,</span> <span class="n">Y_train</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span>
                                <span class="n">T</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span>
                                <span class="n">Y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span>
                            <span class="p">)</span>

                            <span class="n">model_y</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
                            <span class="n">model_t</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                        <span class="n">use_label_encoder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eval_metric</span><span class="o">=</span><span class="s2">"logloss"</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>

                            <span class="n">dml</span> <span class="o">=</span> <span class="n">LinearDML</span><span class="p">(</span><span class="n">model_y</span><span class="o">=</span><span class="n">model_y</span><span class="p">,</span> <span class="n">model_t</span><span class="o">=</span><span class="n">model_t</span><span class="p">,</span> <span class="n">discrete_treatment</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                            <span class="n">cv</span><span class="o">=</span><span class="n">KFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">),</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
                            <span class="n">dml</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Y_train</span><span class="p">,</span> <span class="n">T_train</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">X_train</span><span class="p">)</span>

                            <span class="n">tau</span> <span class="o">=</span> <span class="n">dml</span><span class="o">.</span><span class="n">effect</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
                            <span class="n">att</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span>
                            <span class="n">influence</span> <span class="o">=</span> <span class="n">tau</span> <span class="o">-</span> <span class="n">att</span>
                            <span class="n">se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">influence</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">tau</span><span class="p">))</span>

                            <span class="n">att_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">att</span><span class="p">)</span>
                            <span class="n">se_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">se</span><span class="p">)</span>

                            <span class="n">Y_pred</span> <span class="o">=</span> <span class="n">model_y</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">)</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
                            <span class="n">residuals</span> <span class="o">=</span> <span class="n">Y_train</span> <span class="o">-</span> <span class="n">Y_pred</span>
                            
                            <span class="c1"># Collect residuals and fitted values for plotting</span>
                            <span class="n">group_residuals_data</span><span class="p">[</span><span class="s1">'residuals'</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">residuals</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                            <span class="n">group_residuals_data</span><span class="p">[</span><span class="s1">'fitted'</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">Y_pred</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                            
                            <span class="n">rmse</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_pred</span><span class="p">,</span> <span class="n">squared</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                            <span class="n">r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_pred</span><span class="p">)</span>
                            <span class="n">r2_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
                            <span class="n">rmse_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rmse</span><span class="p">)</span>

                            <span class="n">smd</span><span class="p">,</span> <span class="n">vr</span> <span class="o">=</span> <span class="n">calculate_smd_vr</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">T_train</span><span class="p">)</span>
                            <span class="n">smd_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smd</span><span class="p">)</span>
                            <span class="n">vr_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vr</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">, seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">, imp </span><span class="si">{</span><span class="n">imp</span><span class="si">}</span><span class="s2">, rep </span><span class="si">{</span><span class="n">repeat</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">att_list</span><span class="p">:</span>
                <span class="n">att</span><span class="p">,</span> <span class="n">se</span><span class="p">,</span> <span class="n">ci_l</span><span class="p">,</span> <span class="n">ci_u</span><span class="p">,</span> <span class="n">p_val</span> <span class="o">=</span> <span class="n">rubins_pool</span><span class="p">(</span><span class="n">att_list</span><span class="p">,</span> <span class="n">se_list</span><span class="p">)</span>
                <span class="n">avg_r2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">r2_list</span><span class="p">)</span>
                <span class="n">avg_rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rmse_list</span><span class="p">)</span>
                <span class="n">avg_smd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">smd_list</span><span class="p">)</span>
                <span class="n">avg_vr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">vr_list</span><span class="p">)</span>

                <span class="n">balance_results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">"group"</span><span class="p">:</span> <span class="n">group</span><span class="p">,</span> <span class="s2">"seed"</span><span class="p">:</span> <span class="n">seed</span><span class="p">,</span> <span class="s2">"smd"</span><span class="p">:</span> <span class="n">avg_smd</span><span class="p">,</span> <span class="s2">"vr"</span><span class="p">:</span> <span class="n">avg_vr</span>
                <span class="p">})</span>

                <span class="k">if</span> <span class="n">se</span> <span class="o">&lt;</span> <span class="n">best_se</span><span class="p">:</span>
                    <span class="n">best_se</span> <span class="o">=</span> <span class="n">se</span>
                    <span class="n">best_result</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">"group"</span><span class="p">:</span> <span class="n">group</span><span class="p">,</span> <span class="s2">"seed"</span><span class="p">:</span> <span class="n">seed</span><span class="p">,</span> <span class="s2">"att"</span><span class="p">:</span> <span class="n">att</span><span class="p">,</span> <span class="s2">"se"</span><span class="p">:</span> <span class="n">se</span><span class="p">,</span>
                        <span class="s2">"ci_lower"</span><span class="p">:</span> <span class="n">ci_l</span><span class="p">,</span> <span class="s2">"ci_upper"</span><span class="p">:</span> <span class="n">ci_u</span><span class="p">,</span> <span class="s2">"p_value"</span><span class="p">:</span> <span class="n">p_val</span><span class="p">,</span>
                        <span class="s2">"r2"</span><span class="p">:</span> <span class="n">avg_r2</span><span class="p">,</span> <span class="s2">"rmse"</span><span class="p">:</span> <span class="n">avg_rmse</span>
                    <span class="p">}</span>

                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> | Seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">: ATT = </span><span class="si">{</span><span class="n">att</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, SE = </span><span class="si">{</span><span class="n">se</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, p = </span><span class="si">{</span><span class="n">p_val</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No valid results for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> | Seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">best_result</span><span class="p">:</span>
            <span class="n">att_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">best_result</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Best result for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">  Seed </span><span class="si">{</span><span class="n">best_result</span><span class="p">[</span><span class="s1">'seed'</span><span class="p">]</span><span class="si">}</span><span class="s2"> | SE = </span><span class="si">{</span><span class="n">best_result</span><span class="p">[</span><span class="s1">'se'</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        
        <span class="c1"># Create diagnostic plots for this group</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Creating diagnostic plots for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">..."</span><span class="p">)</span>
        <span class="n">create_diagnostic_plots</span><span class="p">(</span><span class="n">group_residuals_data</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">output_folder</span><span class="p">)</span>

    <span class="c1"># Save final output</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">att_results</span><span class="p">)</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">"dml_rubin_summary_cats_unweighted.xlsx"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">balance_results</span><span class="p">)</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">"smd_vr_summary_cats_unweighted.xlsx"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> All summary files saved."</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">" All diagnostic plots saved in outputs/plots/ folder."</span><span class="p">)</span>

<span class="n">run_dml_with_trimmed_data</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Running DML for CAT_ADHD
 CAT_ADHD | Seed 1: ATT = 0.8440, SE = 6.2964, p = 0.89364
 CAT_ADHD | Seed 2: ATT = 0.7459, SE = 4.2234, p = 0.86017
 CAT_ADHD | Seed 3: ATT = 1.2770, SE = 3.7945, p = 0.73718
 CAT_ADHD | Seed 4: ATT = 0.7159, SE = 4.4720, p = 0.87314
 CAT_ADHD | Seed 5: ATT = 1.0250, SE = 3.8135, p = 0.78866
 CAT_ADHD | Seed 6: ATT = 0.5006, SE = 3.7074, p = 0.89287
 CAT_ADHD | Seed 7: ATT = 0.0798, SE = 3.8549, p = 0.98352
 CAT_ADHD | Seed 8: ATT = 0.7182, SE = 4.5271, p = 0.87427
 CAT_ADHD | Seed 9: ATT = 0.1170, SE = 5.4994, p = 0.98307
 CAT_ADHD | Seed 10: ATT = 0.2875, SE = 3.6759, p = 0.93782
 Best result for CAT_ADHD  Seed 10 | SE = 3.6759
 Creating diagnostic plots for CAT_ADHD...

 Running DML for CAT_Aceetanilidederivaten
 CAT_Aceetanilidederivaten | Seed 1: ATT = 1.0870, SE = 4.7858, p = 0.82079
 CAT_Aceetanilidederivaten | Seed 2: ATT = 1.1156, SE = 4.7204, p = 0.81366
 CAT_Aceetanilidederivaten | Seed 3: ATT = 1.0095, SE = 4.7491, p = 0.83210
 CAT_Aceetanilidederivaten | Seed 4: ATT = 1.8887, SE = 4.9016, p = 0.70083
 CAT_Aceetanilidederivaten | Seed 5: ATT = 1.6114, SE = 5.8611, p = 0.78394
 CAT_Aceetanilidederivaten | Seed 6: ATT = 1.1481, SE = 5.5415, p = 0.83630
 CAT_Aceetanilidederivaten | Seed 7: ATT = 1.1509, SE = 4.9250, p = 0.81572
 CAT_Aceetanilidederivaten | Seed 8: ATT = 1.0254, SE = 5.3079, p = 0.84722
 CAT_Aceetanilidederivaten | Seed 9: ATT = 0.7010, SE = 5.5954, p = 0.90055
 CAT_Aceetanilidederivaten | Seed 10: ATT = 0.3668, SE = 5.3451, p = 0.94543
 Best result for CAT_Aceetanilidederivaten  Seed 2 | SE = 4.7204
 Creating diagnostic plots for CAT_Aceetanilidederivaten...

 Running DML for CAT_Z_drugs
 CAT_Z_drugs | Seed 1: ATT = 4.8711, SE = 3.8033, p = 0.20327
 CAT_Z_drugs | Seed 2: ATT = 5.2359, SE = 3.8964, p = 0.18210
 CAT_Z_drugs | Seed 3: ATT = 4.9614, SE = 3.9146, p = 0.20799
 CAT_Z_drugs | Seed 4: ATT = 4.7155, SE = 3.9916, p = 0.24029
 CAT_Z_drugs | Seed 5: ATT = 5.0371, SE = 4.1162, p = 0.22396
 CAT_Z_drugs | Seed 6: ATT = 4.7214, SE = 3.8276, p = 0.22030
 CAT_Z_drugs | Seed 7: ATT = 4.6979, SE = 3.8576, p = 0.22618
 CAT_Z_drugs | Seed 8: ATT = 5.0734, SE = 4.1021, p = 0.21909
 CAT_Z_drugs | Seed 9: ATT = 5.0096, SE = 4.0153, p = 0.21511
 CAT_Z_drugs | Seed 10: ATT = 5.2174, SE = 3.8319, p = 0.17642
 Best result for CAT_Z_drugs  Seed 1 | SE = 3.8033
 Creating diagnostic plots for CAT_Z_drugs...

 Running DML for CAT_Opioden
 CAT_Opioden | Seed 1: ATT = 3.4059, SE = 4.5277, p = 0.45370
 CAT_Opioden | Seed 2: ATT = 3.4840, SE = 4.9420, p = 0.48248
 CAT_Opioden | Seed 3: ATT = 3.2090, SE = 4.0009, p = 0.42443
 CAT_Opioden | Seed 4: ATT = 3.5201, SE = 4.1388, p = 0.39710
 CAT_Opioden | Seed 5: ATT = 3.4288, SE = 4.0959, p = 0.40454
 CAT_Opioden | Seed 6: ATT = 3.3403, SE = 4.4777, p = 0.45743
 CAT_Opioden | Seed 7: ATT = 3.7460, SE = 4.9379, p = 0.44988
 CAT_Opioden | Seed 8: ATT = 3.6649, SE = 4.3467, p = 0.40117
 CAT_Opioden | Seed 9: ATT = 3.5630, SE = 4.3789, p = 0.41778
 CAT_Opioden | Seed 10: ATT = 3.8025, SE = 5.0065, p = 0.44936
 Best result for CAT_Opioden  Seed 3 | SE = 4.0009
 Creating diagnostic plots for CAT_Opioden...

 Running DML for CAT_NSAIDs
 CAT_NSAIDs | Seed 1: ATT = 4.1411, SE = 5.0745, p = 0.41643
 CAT_NSAIDs | Seed 2: ATT = 4.0797, SE = 5.7626, p = 0.48064
 CAT_NSAIDs | Seed 3: ATT = 3.8663, SE = 5.9327, p = 0.51611
 CAT_NSAIDs | Seed 4: ATT = 3.9439, SE = 5.6379, p = 0.48586
 CAT_NSAIDs | Seed 5: ATT = 4.7712, SE = 5.3174, p = 0.37175
 CAT_NSAIDs | Seed 6: ATT = 4.1711, SE = 5.1717, p = 0.42187
 CAT_NSAIDs | Seed 7: ATT = 4.3983, SE = 4.9664, p = 0.37798
 CAT_NSAIDs | Seed 8: ATT = 4.2261, SE = 5.8642, p = 0.47281
 CAT_NSAIDs | Seed 9: ATT = 4.0229, SE = 5.8190, p = 0.49097
 CAT_NSAIDs | Seed 10: ATT = 4.3372, SE = 5.7692, p = 0.45396
 Best result for CAT_NSAIDs  Seed 7 | SE = 4.9664
 Creating diagnostic plots for CAT_NSAIDs...

 Running DML for CAT_Benzodiazepine
 CAT_Benzodiazepine | Seed 1: ATT = 0.4717, SE = 0.7004, p = 0.50225
 CAT_Benzodiazepine | Seed 2: ATT = 0.4812, SE = 0.7300, p = 0.51126
 CAT_Benzodiazepine | Seed 3: ATT = 0.5149, SE = 0.7216, p = 0.47719
 CAT_Benzodiazepine | Seed 4: ATT = 0.5189, SE = 0.7030, p = 0.46218
 CAT_Benzodiazepine | Seed 5: ATT = 0.6246, SE = 0.6235, p = 0.31896
 CAT_Benzodiazepine | Seed 6: ATT = 0.5044, SE = 0.7612, p = 0.50910
 CAT_Benzodiazepine | Seed 7: ATT = 0.4422, SE = 0.7452, p = 0.55429
 CAT_Benzodiazepine | Seed 8: ATT = 0.4790, SE = 0.7564, p = 0.52803
 CAT_Benzodiazepine | Seed 9: ATT = 0.4530, SE = 0.8051, p = 0.57494
 CAT_Benzodiazepine | Seed 10: ATT = 0.5046, SE = 0.7469, p = 0.50087
 Best result for CAT_Benzodiazepine  Seed 5 | SE = 0.6235
 Creating diagnostic plots for CAT_Benzodiazepine...

 Running DML for CAT_Antihypertensiva
 CAT_Antihypertensiva | Seed 1: ATT = -1.7503, SE = 4.2030, p = 0.67800
 CAT_Antihypertensiva | Seed 2: ATT = -1.8144, SE = 3.9829, p = 0.64972
 CAT_Antihypertensiva | Seed 3: ATT = -1.9672, SE = 4.2522, p = 0.64465
 CAT_Antihypertensiva | Seed 4: ATT = -1.6376, SE = 4.0504, p = 0.68687
 CAT_Antihypertensiva | Seed 5: ATT = -1.5603, SE = 3.8613, p = 0.68701
 CAT_Antihypertensiva | Seed 6: ATT = -1.7881, SE = 4.2602, p = 0.67560
 CAT_Antihypertensiva | Seed 7: ATT = -1.3792, SE = 4.1883, p = 0.74261
 CAT_Antihypertensiva | Seed 8: ATT = -2.0593, SE = 4.3412, p = 0.63629
 CAT_Antihypertensiva | Seed 9: ATT = -1.3219, SE = 4.3990, p = 0.76442
 CAT_Antihypertensiva | Seed 10: ATT = -1.4304, SE = 4.0085, p = 0.72197
 Best result for CAT_Antihypertensiva  Seed 5 | SE = 3.8613
 Creating diagnostic plots for CAT_Antihypertensiva...

 Running DML for CAT_Antihistaminica
 CAT_Antihistaminica | Seed 1: ATT = 0.9667, SE = 3.3815, p = 0.77557
 CAT_Antihistaminica | Seed 2: ATT = 0.6290, SE = 7.0443, p = 0.92904
 CAT_Antihistaminica | Seed 3: ATT = 1.0670, SE = 3.7085, p = 0.77417
 CAT_Antihistaminica | Seed 4: ATT = 0.9146, SE = 3.6576, p = 0.80306
 CAT_Antihistaminica | Seed 5: ATT = 0.8015, SE = 3.5876, p = 0.82367
 CAT_Antihistaminica | Seed 6: ATT = 0.3679, SE = 3.2909, p = 0.91122
 CAT_Antihistaminica | Seed 7: ATT = 0.9410, SE = 3.5020, p = 0.78872
 CAT_Antihistaminica | Seed 8: ATT = 1.1560, SE = 3.5133, p = 0.74282
 CAT_Antihistaminica | Seed 9: ATT = 1.1829, SE = 3.9204, p = 0.76350
 CAT_Antihistaminica | Seed 10: ATT = 0.4400, SE = 3.7146, p = 0.90595
 Best result for CAT_Antihistaminica  Seed 6 | SE = 3.2909
 Creating diagnostic plots for CAT_Antihistaminica...

 Running DML for CAT_Anti_epileptica
 CAT_Anti_epileptica | Seed 1: ATT = 4.0588, SE = 3.0075, p = 0.18023
 CAT_Anti_epileptica | Seed 2: ATT = 4.0624, SE = 2.6093, p = 0.12269
 CAT_Anti_epileptica | Seed 3: ATT = 4.2944, SE = 2.7447, p = 0.12086
 CAT_Anti_epileptica | Seed 4: ATT = 4.1411, SE = 2.7847, p = 0.14017
 CAT_Anti_epileptica | Seed 5: ATT = 3.4740, SE = 2.7290, p = 0.20600
 CAT_Anti_epileptica | Seed 6: ATT = 4.1687, SE = 2.9746, p = 0.16422
 CAT_Anti_epileptica | Seed 7: ATT = 4.5314, SE = 3.2611, p = 0.16779
 CAT_Anti_epileptica | Seed 8: ATT = 4.0855, SE = 3.1291, p = 0.19469
 CAT_Anti_epileptica | Seed 9: ATT = 3.8342, SE = 2.6123, p = 0.14534
 CAT_Anti_epileptica | Seed 10: ATT = 3.8513, SE = 3.0544, p = 0.21031
 Best result for CAT_Anti_epileptica  Seed 2 | SE = 2.6093
 Creating diagnostic plots for CAT_Anti_epileptica...

 Running DML for CAT_Antidepressiva
 CAT_Antidepressiva | Seed 1: ATT = 0.8586, SE = 0.4313, p = 0.04924
 CAT_Antidepressiva | Seed 2: ATT = 0.8367, SE = 0.4935, p = 0.09315
 CAT_Antidepressiva | Seed 3: ATT = 0.8599, SE = 0.4848, p = 0.07918
 CAT_Antidepressiva | Seed 4: ATT = 0.8115, SE = 0.5183, p = 0.12066
 CAT_Antidepressiva | Seed 5: ATT = 0.9109, SE = 0.5173, p = 0.08136
 CAT_Antidepressiva | Seed 6: ATT = 0.8775, SE = 0.4997, p = 0.08214
 CAT_Antidepressiva | Seed 7: ATT = 0.8605, SE = 0.4758, p = 0.07356
 CAT_Antidepressiva | Seed 8: ATT = 0.8817, SE = 0.4414, p = 0.04852
 CAT_Antidepressiva | Seed 9: ATT = 0.8510, SE = 0.4754, p = 0.07652
 CAT_Antidepressiva | Seed 10: ATT = 0.8854, SE = 0.4820, p = 0.06925
 Best result for CAT_Antidepressiva  Seed 1 | SE = 0.4313
 Creating diagnostic plots for CAT_Antidepressiva...

 Running DML for CAT_Antipsychotica
 CAT_Antipsychotica | Seed 1: ATT = 1.7390, SE = 0.9568, p = 0.07217
 CAT_Antipsychotica | Seed 2: ATT = 1.5959, SE = 1.0096, p = 0.11713
 CAT_Antipsychotica | Seed 3: ATT = 1.6835, SE = 1.0146, p = 0.10020
 CAT_Antipsychotica | Seed 4: ATT = 1.6944, SE = 1.1081, p = 0.12942
 CAT_Antipsychotica | Seed 5: ATT = 1.6399, SE = 1.0092, p = 0.10734
 CAT_Antipsychotica | Seed 6: ATT = 1.6533, SE = 1.0238, p = 0.10953
 CAT_Antipsychotica | Seed 7: ATT = 1.7587, SE = 0.9686, p = 0.07245
 CAT_Antipsychotica | Seed 8: ATT = 1.7576, SE = 0.9604, p = 0.07025
 CAT_Antipsychotica | Seed 9: ATT = 1.7272, SE = 0.9557, p = 0.07376
 CAT_Antipsychotica | Seed 10: ATT = 1.6961, SE = 0.8781, p = 0.05627
 Best result for CAT_Antipsychotica  Seed 10 | SE = 0.8781
 Creating diagnostic plots for CAT_Antipsychotica...

 Running DML for CAT_ALL_PSYCHOTROPICS_EXCL_BENZO
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 1: ATT = 2.0000, SE = 0.4162, p = &lt; 0.00001
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 2: ATT = 2.0092, SE = 0.4350, p = &lt; 0.00001
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 3: ATT = 1.9741, SE = 0.4697, p = 0.00006
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 4: ATT = 2.0084, SE = 0.4660, p = 0.00004
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 5: ATT = 1.9440, SE = 0.4643, p = 0.00006
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 6: ATT = 2.0040, SE = 0.4320, p = &lt; 0.00001
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 7: ATT = 1.9688, SE = 0.4296, p = &lt; 0.00001
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 8: ATT = 1.9732, SE = 0.4105, p = &lt; 0.00001
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 9: ATT = 1.9818, SE = 0.4325, p = &lt; 0.00001
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 10: ATT = 2.0156, SE = 0.4704, p = 0.00004
 Best result for CAT_ALL_PSYCHOTROPICS_EXCL_BENZO  Seed 8 | SE = 0.4105
 Creating diagnostic plots for CAT_ALL_PSYCHOTROPICS_EXCL_BENZO...

 Running DML for CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 1: ATT = 1.5306, SE = 0.4260, p = 0.00051
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 2: ATT = 1.4968, SE = 0.4594, p = 0.00154
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 3: ATT = 1.4945, SE = 0.4639, p = 0.00172
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 4: ATT = 1.5273, SE = 0.4399, p = 0.00077
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 5: ATT = 1.5309, SE = 0.4697, p = 0.00153
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 6: ATT = 1.4993, SE = 0.4675, p = 0.00181
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 7: ATT = 1.5315, SE = 0.4330, p = 0.00062
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 8: ATT = 1.5262, SE = 0.4351, p = 0.00068
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 9: ATT = 1.4931, SE = 0.4794, p = 0.00241
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 10: ATT = 1.5040, SE = 0.4838, p = 0.00245
 Best result for CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS  Seed 1 | SE = 0.4260
 Creating diagnostic plots for CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS...

 Running DML for CAT_ALL_PSYCHOTROPICS
 CAT_ALL_PSYCHOTROPICS | Seed 1: ATT = 2.4070, SE = 0.4444, p = &lt; 0.00001
 CAT_ALL_PSYCHOTROPICS | Seed 2: ATT = 2.3691, SE = 0.4179, p = &lt; 0.00001
 CAT_ALL_PSYCHOTROPICS | Seed 3: ATT = 2.3710, SE = 0.4766, p = &lt; 0.00001
 CAT_ALL_PSYCHOTROPICS | Seed 4: ATT = 2.3925, SE = 0.4535, p = &lt; 0.00001
 CAT_ALL_PSYCHOTROPICS | Seed 5: ATT = 2.3997, SE = 0.4929, p = &lt; 0.00001
 CAT_ALL_PSYCHOTROPICS | Seed 6: ATT = 2.4153, SE = 0.4851, p = &lt; 0.00001
 CAT_ALL_PSYCHOTROPICS | Seed 7: ATT = 2.3995, SE = 0.4832, p = &lt; 0.00001
 CAT_ALL_PSYCHOTROPICS | Seed 8: ATT = 2.3896, SE = 0.5323, p = 0.00002
 CAT_ALL_PSYCHOTROPICS | Seed 9: ATT = 2.4174, SE = 0.4669, p = &lt; 0.00001
 CAT_ALL_PSYCHOTROPICS | Seed 10: ATT = 2.4291, SE = 0.4708, p = &lt; 0.00001
 Best result for CAT_ALL_PSYCHOTROPICS  Seed 2 | SE = 0.4179
 Creating diagnostic plots for CAT_ALL_PSYCHOTROPICS...

 Running DML for CAT_ALL
 CAT_ALL | Seed 1: ATT = 2.8504, SE = 0.4388, p = &lt; 0.00001
 CAT_ALL | Seed 2: ATT = 2.8122, SE = 0.4884, p = &lt; 0.00001
 CAT_ALL | Seed 3: ATT = 2.8553, SE = 0.4198, p = &lt; 0.00001
 CAT_ALL | Seed 4: ATT = 2.8736, SE = 0.4717, p = &lt; 0.00001
 CAT_ALL | Seed 5: ATT = 2.8358, SE = 0.4612, p = &lt; 0.00001
 CAT_ALL | Seed 6: ATT = 2.8431, SE = 0.4355, p = &lt; 0.00001
 CAT_ALL | Seed 7: ATT = 2.8423, SE = 0.4591, p = &lt; 0.00001
 CAT_ALL | Seed 8: ATT = 2.8703, SE = 0.4391, p = &lt; 0.00001
 CAT_ALL | Seed 9: ATT = 2.8945, SE = 0.4766, p = &lt; 0.00001
 CAT_ALL | Seed 10: ATT = 2.8613, SE = 0.4538, p = &lt; 0.00001
 Best result for CAT_ALL  Seed 3 | SE = 0.4198
 Creating diagnostic plots for CAT_ALL...

 All summary files saved.
 All diagnostic plots saved in outputs/plots/ folder.
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=5d6cc497-ddbb-4668-86ee-8e5a2872b2bb">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[48]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">sem</span><span class="p">,</span> <span class="n">ttest_ind</span>

<span class="c1"># ----------------------------------</span>
<span class="c1"># File paths</span>
<span class="c1"># ----------------------------------</span>
<span class="n">output_base</span> <span class="o">=</span> <span class="s2">"outputs"</span>
<span class="n">att_file</span> <span class="o">=</span> <span class="s2">"dml_rubin_summary_cats.xlsx"</span>
<span class="n">trimmed_file</span> <span class="o">=</span> <span class="s2">"trimmed_data_imp1.pkl"</span>
<span class="n">auc_file</span> <span class="o">=</span> <span class="s2">"auc_scores.xlsx"</span>  <span class="c1"># NEW</span>

<span class="c1"># ----------------------------------</span>
<span class="c1"># Load ATT Summary</span>
<span class="c1"># ----------------------------------</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">att_file</span><span class="p">):</span>
    <span class="n">att_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">att_file</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">" ATT summary file not found: dml_rubin_summary_cats.xlsx"</span><span class="p">)</span>

<span class="n">summary_rows</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># ----------------------------------</span>
<span class="c1"># Loop over medication groups</span>
<span class="c1"># ----------------------------------</span>
<span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">medication_groups</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">g</span><span class="p">))]</span>

<span class="k">for</span> <span class="n">med</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">group_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">med</span><span class="p">)</span>

        <span class="c1"># Load trimmed data</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="n">trimmed_file</span><span class="p">))</span>

        <span class="c1"># Detect treatment column</span>
        <span class="n">treatment_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">med</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">treatment_cols</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Treatment column </span><span class="si">{</span><span class="n">med</span><span class="si">}</span><span class="s2"> not found in trimmed data. Skipping."</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">treatment_var</span> <span class="o">=</span> <span class="n">treatment_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Extract treatment and outcome</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">"caps5_change_baseline"</span><span class="p">]</span>

        <span class="c1"># Treated and control stats</span>
        <span class="n">treated</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">control</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>

        <span class="n">mean_treat</span> <span class="o">=</span> <span class="n">treated</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">se_treat</span> <span class="o">=</span> <span class="n">sem</span><span class="p">(</span><span class="n">treated</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">treated</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">mean_ctrl</span> <span class="o">=</span> <span class="n">control</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">se_ctrl</span> <span class="o">=</span> <span class="n">sem</span><span class="p">(</span><span class="n">control</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">control</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Cohen's d (unadjusted)</span>
        <span class="n">pooled_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">treated</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">control</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">cohen_d</span> <span class="o">=</span> <span class="p">(</span><span class="n">mean_treat</span> <span class="o">-</span> <span class="n">mean_ctrl</span><span class="p">)</span> <span class="o">/</span> <span class="n">pooled_sd</span> <span class="k">if</span> <span class="n">pooled_sd</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># E-value (unadjusted)</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">mean_treat</span> <span class="o">-</span> <span class="n">mean_ctrl</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">delta</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">mean_ctrl</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">mean_ctrl</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Unadjusted p-value</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">t_stat</span><span class="p">,</span> <span class="n">p_val</span> <span class="o">=</span> <span class="n">ttest_ind</span><span class="p">(</span><span class="n">treated</span><span class="p">,</span> <span class="n">control</span><span class="p">,</span> <span class="n">equal_var</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nan_policy</span><span class="o">=</span><span class="s2">"omit"</span><span class="p">)</span>
            <span class="n">rounded_p</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">p_val</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="n">formatted_p</span> <span class="o">=</span> <span class="s2">"&lt; 0.00001"</span> <span class="k">if</span> <span class="n">rounded_p</span> <span class="o">&lt;</span> <span class="mf">0.00001</span> <span class="k">else</span> <span class="n">rounded_p</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">formatted_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># AUC from new auc_scores.xlsx file</span>
        <span class="n">auc_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">auc_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="n">auc_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">auc_path</span><span class="p">):</span>
            <span class="n">auc_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">auc_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">"AUC"</span> <span class="ow">in</span> <span class="n">auc_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">auc_val</span> <span class="o">=</span> <span class="n">auc_df</span><span class="p">[</span><span class="s2">"AUC"</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="c1"># Adjusted stats from Rubin summary</span>
        <span class="n">att_row</span> <span class="o">=</span> <span class="n">att_df</span><span class="p">[</span><span class="n">att_df</span><span class="p">[</span><span class="s2">"group"</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">med</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">att_row</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">att</span> <span class="o">=</span> <span class="n">att_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"att"</span><span class="p">]</span>
            <span class="n">att_se</span> <span class="o">=</span> <span class="n">att_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"se"</span><span class="p">]</span>
            <span class="n">att_p_val</span> <span class="o">=</span> <span class="n">att_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"p_value"</span><span class="p">]</span>
            <span class="n">r2</span> <span class="o">=</span> <span class="n">att_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"r2"</span><span class="p">]</span>
            <span class="n">rmse</span> <span class="o">=</span> <span class="n">att_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"rmse"</span><span class="p">]</span>
            <span class="n">seed</span> <span class="o">=</span> <span class="n">att_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"seed"</span><span class="p">]</span> <span class="k">if</span> <span class="s2">"seed"</span> <span class="ow">in</span> <span class="n">att_row</span><span class="o">.</span><span class="n">columns</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>   <span class="c1"># Seed change</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">rounded_att_p</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">att_p_val</span><span class="p">),</span> <span class="mi">5</span><span class="p">)</span>
                <span class="n">formatted_att_p</span> <span class="o">=</span> <span class="s2">"&lt; 0.00001"</span> <span class="k">if</span> <span class="n">rounded_att_p</span> <span class="o">&lt;</span> <span class="mf">0.00001</span> <span class="k">else</span> <span class="n">rounded_att_p</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">formatted_att_p</span> <span class="o">=</span> <span class="n">att_p_val</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">att</span><span class="p">,</span> <span class="n">att_se</span><span class="p">,</span> <span class="n">formatted_att_p</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">rmse</span><span class="p">,</span> <span class="n">seed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>  <span class="c1"># Seed change</span>

        <span class="c1"># Append full row</span>
        <span class="n">summary_rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">'Medication Group'</span><span class="p">:</span> <span class="n">med</span><span class="p">,</span>
            <span class="s1">'Mean Treated'</span><span class="p">:</span> <span class="n">mean_treat</span><span class="p">,</span>
            <span class="s1">'SE Treated'</span><span class="p">:</span> <span class="n">se_treat</span><span class="p">,</span>
            <span class="s1">'Mean Control'</span><span class="p">:</span> <span class="n">mean_ctrl</span><span class="p">,</span>
            <span class="s1">'SE Control'</span><span class="p">:</span> <span class="n">se_ctrl</span><span class="p">,</span>
            <span class="s1">'Cohen d'</span><span class="p">:</span> <span class="n">cohen_d</span><span class="p">,</span>
            <span class="s1">'E (Unadjusted)'</span><span class="p">:</span> <span class="n">E</span><span class="p">,</span>
            <span class="s1">'n Treated'</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">treated</span><span class="p">),</span>
            <span class="s1">'n Control'</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">control</span><span class="p">),</span>
            <span class="c1">#'Unadjusted p-value': formatted_p,</span>
            <span class="s1">'ATT Estimate'</span><span class="p">:</span> <span class="n">att</span><span class="p">,</span>
            <span class="s1">'ATT SE (Robust)'</span><span class="p">:</span> <span class="n">att_se</span><span class="p">,</span>
            <span class="s1">'ATT p-value'</span><span class="p">:</span> <span class="n">formatted_att_p</span><span class="p">,</span>
            <span class="s1">'R'</span><span class="p">:</span> <span class="n">r2</span><span class="p">,</span>
            <span class="s1">'RMSE'</span><span class="p">:</span> <span class="n">rmse</span><span class="p">,</span>
            <span class="s1">'AUC'</span><span class="p">:</span> <span class="n">auc_val</span><span class="p">,</span>
            <span class="s1">'Seed'</span><span class="p">:</span> <span class="n">seed</span>  <span class="c1"># Seed change</span>
        <span class="p">})</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error in </span><span class="si">{</span><span class="n">med</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># ----------------------------------</span>
<span class="c1"># Save final summary</span>
<span class="c1"># ----------------------------------</span>
<span class="n">summary_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">summary_rows</span><span class="p">)</span>
<span class="n">summary_df</span> <span class="o">=</span> <span class="n">summary_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">"Medication Group"</span><span class="p">)</span>
<span class="n">summary_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">"Final_ATT_Summary_Cat.xlsx"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">" Final_ATT_Summary_Cat saved.xlsx"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre> Final_ATT_Summary_Cat saved.xlsx
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=1e88cd42-b49e-4ff7-ac7d-c1e6be654c51">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[49]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.backends.backend_pdf</span> <span class="kn">import</span> <span class="n">PdfPages</span>

<span class="c1">#  Load the final summary table</span>
<span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s2">"Final_ATT_Summary_Cat.xlsx"</span><span class="p">)</span>

<span class="c1">#  Parse DML p-values (handle "&lt; 0.00001")</span>
<span class="k">def</span> <span class="nf">parse_pval</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">"&lt;"</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.000001</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

<span class="n">final_df</span><span class="p">[</span><span class="s1">'ATT p-value'</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="s1">'ATT p-value'</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">parse_pval</span><span class="p">)</span>

<span class="c1">#  Plot settings</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>

<span class="c1">#  Plotting function for a single medication group</span>
<span class="k">def</span> <span class="nf">plot_single_group</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    
    <span class="n">bars1</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="o">-</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">'Mean Control'</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> 
                   <span class="n">yerr</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">'SE Control'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">'Control'</span><span class="p">,</span> <span class="n">hatch</span><span class="o">=</span><span class="s1">'//'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">bars2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="o">+</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">'Mean Treated'</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> 
                   <span class="n">yerr</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">'SE Treated'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">'Treated'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'steelblue'</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

    <span class="n">label</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">"ATT = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'ATT Estimate'</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span>
        <span class="sa">f</span><span class="s2">"d = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'Cohen d'</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, p = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'ATT p-value'</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span>
        <span class="sa">f</span><span class="s2">"nT = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'n Treated'</span><span class="p">]</span><span class="si">}</span><span class="s2">, nC = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'n Control'</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span>
        <span class="sa">f</span><span class="s2">"E = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'E (Unadjusted)'</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%"</span>
    <span class="p">)</span>
    <span class="n">max_y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">'Mean Control'</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">'Mean Treated'</span><span class="p">])</span> <span class="o">+</span> <span class="mf">1.5</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_y</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">'center'</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">'bottom'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'#FFD700'</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'black'</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="o">-</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">+</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">'Control'</span><span class="p">,</span> <span class="s1">'Treated'</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Group: </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'Medication Group'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">'bold'</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"CAPS5 Change Score"</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="n">max_y</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">fig</span>

<span class="c1">#  Generate and save all plots into a multi-page PDF</span>
<span class="k">with</span> <span class="n">PdfPages</span><span class="p">(</span><span class="s2">"dml_att_barplot_cat.pdf"</span><span class="p">)</span> <span class="k">as</span> <span class="n">pdf</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">final_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_single_group</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="n">pdf</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">'tight'</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">" dml_att_barplot_cat saved.xlsx"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre> dml_att_barplot_cat saved.xlsx
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=8d7f3256-bb44-495c-a2fb-023d82a82611">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[50]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Love plot:</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=0fecd847-e224-4613-b4e9-5de8a3e77d73">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[51]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="c1"># ----------------------------------------</span>
<span class="c1"># Functions to calculate balance</span>
<span class="c1"># ----------------------------------------</span>
<span class="k">def</span> <span class="nf">calculate_smd</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">w1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">w2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">weighted_mean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span> <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">weighted_var</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">m</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
    
    <span class="n">m1</span> <span class="o">=</span> <span class="n">weighted_mean</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">w1</span><span class="p">)</span> <span class="k">if</span> <span class="n">w1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
    <span class="n">m2</span> <span class="o">=</span> <span class="n">weighted_mean</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span> <span class="k">if</span> <span class="n">w2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">weighted_var</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">w1</span><span class="p">)</span> <span class="k">if</span> <span class="n">w1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">weighted_var</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span> <span class="k">if</span> <span class="n">w2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">pooled_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">v1</span> <span class="o">+</span> <span class="n">v2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">m1</span> <span class="o">-</span> <span class="n">m2</span><span class="p">)</span> <span class="o">/</span> <span class="n">pooled_sd</span> <span class="k">if</span> <span class="n">pooled_sd</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">variance_ratio</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">w1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">w2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">weighted_var</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">m</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
    
    <span class="n">v1</span> <span class="o">=</span> <span class="n">weighted_var</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">w1</span><span class="p">)</span> <span class="k">if</span> <span class="n">w1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">weighted_var</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span> <span class="k">if</span> <span class="n">w2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">v1</span> <span class="o">/</span> <span class="n">v2</span><span class="p">,</span> <span class="n">v2</span> <span class="o">/</span> <span class="n">v1</span><span class="p">)</span> <span class="k">if</span> <span class="n">v1</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">v2</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>

<span class="c1"># ----------------------------------------</span>
<span class="c1"># Setup</span>
<span class="c1"># ----------------------------------------</span>
<span class="n">output_base</span> <span class="o">=</span> <span class="s2">"outputs"</span>
<span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">output_base</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">g</span><span class="p">))]</span>

<span class="c1"># Create a case-insensitive mapping</span>
<span class="n">final_covariates_map_lower</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="c1"># ----------------------------------------</span>
<span class="c1"># Main Loop</span>
<span class="c1"># ----------------------------------------</span>
<span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">group</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_covariates_map_lower</span><span class="p">:</span>
        <span class="k">continue</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Processing </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">..."</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">group_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">covariates</span> <span class="o">=</span> <span class="n">final_covariates_map_lower</span><span class="p">[</span><span class="n">group</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        
        <span class="n">column_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="s2">"trimmed_data_imp1.pkl"</span><span class="p">))</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">group</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">column_name</span> <span class="o">=</span> <span class="n">col</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">column_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Column not found for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">, skipping."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">smd_unw_all</span><span class="p">,</span> <span class="n">smd_w_all</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">vr_unw_all</span><span class="p">,</span> <span class="n">vr_w_all</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
            <span class="n">df_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"trimmed_data_imp</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.pkl"</span><span class="p">)</span>
            <span class="n">iptw_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="s2">"iptw_weights.xlsx"</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">df_path</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">iptw_path</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Missing data for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> imp</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, skipping."</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">df_path</span><span class="p">)</span>
            <span class="n">iptw_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">iptw_path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span>
            <span class="n">W</span> <span class="o">=</span> <span class="n">iptw_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s2">"iptw_mean"</span><span class="p">]</span>

            <span class="n">smd_unw_i</span><span class="p">,</span> <span class="n">smd_w_i</span><span class="p">,</span> <span class="n">vr_unw_i</span><span class="p">,</span> <span class="n">vr_w_i</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">cov</span> <span class="ow">in</span> <span class="n">covariates</span><span class="p">:</span>
                <span class="n">x1</span><span class="p">,</span> <span class="n">x0</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cov</span><span class="p">],</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cov</span><span class="p">]</span>
                <span class="n">w1</span><span class="p">,</span> <span class="n">w0</span> <span class="o">=</span> <span class="n">W</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">],</span> <span class="n">W</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>

                <span class="n">su</span> <span class="o">=</span> <span class="n">calculate_smd</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x0</span><span class="p">)</span>
                <span class="n">sw</span> <span class="o">=</span> <span class="n">calculate_smd</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">w0</span><span class="p">)</span>

                <span class="n">vu</span> <span class="o">=</span> <span class="n">variance_ratio</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x0</span><span class="p">)</span> <span class="k">if</span> <span class="n">cov</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">]</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">vw</span> <span class="o">=</span> <span class="n">variance_ratio</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">w0</span><span class="p">)</span> <span class="k">if</span> <span class="n">cov</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">]</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

                <span class="n">smd_unw_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">su</span><span class="p">)</span>
                <span class="n">smd_w_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sw</span><span class="p">)</span>
                <span class="n">vr_unw_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vu</span><span class="p">)</span>
                <span class="n">vr_w_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vw</span><span class="p">)</span>

            <span class="n">smd_unw_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smd_unw_i</span><span class="p">)</span>
            <span class="n">smd_w_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smd_w_i</span><span class="p">)</span>
            <span class="n">vr_unw_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vr_unw_i</span><span class="p">)</span>
            <span class="n">vr_w_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vr_w_i</span><span class="p">)</span>

        <span class="n">smd_unw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">smd_unw_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">smd_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">smd_w_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">vr_unw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">vr_unw_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">vr_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">vr_w_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">severity</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sw</span> <span class="ow">in</span> <span class="n">smd_w</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sw</span> <span class="o">&lt;=</span> <span class="mf">0.1</span><span class="p">:</span>
                <span class="n">severity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"Good"</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">sw</span> <span class="o">&lt;=</span> <span class="mf">0.2</span><span class="p">:</span>
                <span class="n">severity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"Moderate"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">severity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"Poor"</span><span class="p">)</span>

        <span class="n">covariate_names</span> <span class="o">=</span> <span class="n">covariates</span>
        <span class="n">numeric_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s2">"Covariate"</span><span class="p">:</span> <span class="n">covariate_names</span><span class="p">,</span>
            <span class="s2">"SMD_Unweighted"</span><span class="p">:</span> <span class="n">smd_unw</span><span class="p">,</span>
            <span class="s2">"SMD_Weighted"</span><span class="p">:</span> <span class="n">smd_w</span><span class="p">,</span>
            <span class="s2">"Imbalance_Severity"</span><span class="p">:</span> <span class="n">severity</span><span class="p">,</span>
            <span class="s2">"VR_Unweighted"</span><span class="p">:</span> <span class="n">vr_unw</span><span class="p">,</span>
            <span class="s2">"VR_Weighted"</span><span class="p">:</span> <span class="n">vr_w</span>
        <span class="p">})</span>

        <span class="n">numeric_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"covariate_balance_table_</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">.xlsx"</span><span class="p">)</span>
        <span class="n">numeric_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">numeric_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Exported numeric summary to: </span><span class="si">{</span><span class="n">numeric_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># -------------------------</span>
        <span class="c1"># Plot</span>
        <span class="c1"># -------------------------</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">covariates</span>
        <span class="n">y_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.45</span><span class="p">))</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">smd_unw</span><span class="p">,</span> <span class="n">y_pos</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Unweighted"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">smd_w</span><span class="p">,</span> <span class="n">y_pos</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'blue'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Weighted"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Threshold 0.1"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'black'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Threshold 0.2"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">smd_unw</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">smd_w</span><span class="p">),</span> <span class="mf">0.25</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">y_pos</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Standardized Mean Differences (SMD)"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">"upper right"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">vr_mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">cov</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">]</span> <span class="k">for</span> <span class="n">cov</span> <span class="ow">in</span> <span class="n">covariates</span><span class="p">]</span>
        <span class="n">filtered_y</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vr_mask</span><span class="p">)</span> <span class="k">if</span> <span class="n">b</span><span class="p">]</span>
        <span class="n">filtered_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">filtered_y</span><span class="p">]</span>
        <span class="n">filtered_vr_unw</span> <span class="o">=</span> <span class="p">[</span><span class="n">vr_unw</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">filtered_y</span><span class="p">]</span>
        <span class="n">filtered_vr_w</span> <span class="o">=</span> <span class="p">[</span><span class="n">vr_w</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">filtered_y</span><span class="p">]</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">filtered_vr_unw</span><span class="p">,</span> <span class="n">filtered_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'blue'</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">'o'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Unweighted"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">filtered_vr_w</span><span class="p">,</span> <span class="n">filtered_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">'x'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Weighted"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">filtered_vr_unw</span> <span class="o">+</span> <span class="n">filtered_vr_w</span> <span class="o">+</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">])</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">filtered_y</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">filtered_labels</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Variance Ratio (VR)"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Covariate Balance for </span><span class="si">{</span><span class="n">group</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'CAT_'</span><span class="p">,</span><span class="w"> </span><span class="s1">''</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">'bold'</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.96</span><span class="p">])</span>
        <span class="n">plot_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"love_plot_</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">.pdf"</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Saved love plot: </span><span class="si">{</span><span class="n">plot_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Max weighted SMD for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">smd_w</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Processing CAT_Aceetanilidederivaten...
 Exported numeric summary to: outputs\CAT_Aceetanilidederivaten\covariate_balance_table_CAT_Aceetanilidederivaten.xlsx
 Saved love plot: outputs\CAT_Aceetanilidederivaten\love_plot_CAT_Aceetanilidederivaten.pdf
 Max weighted SMD for CAT_Aceetanilidederivaten: 0.516

 Processing CAT_Adhd...
 Exported numeric summary to: outputs\CAT_Adhd\covariate_balance_table_CAT_Adhd.xlsx
 Saved love plot: outputs\CAT_Adhd\love_plot_CAT_Adhd.pdf
 Max weighted SMD for CAT_Adhd: 0.489

 Processing CAT_All...
 Exported numeric summary to: outputs\CAT_All\covariate_balance_table_CAT_All.xlsx
 Saved love plot: outputs\CAT_All\love_plot_CAT_All.pdf
 Max weighted SMD for CAT_All: 0.233

 Processing CAT_All_Psychotropics...
 Exported numeric summary to: outputs\CAT_All_Psychotropics\covariate_balance_table_CAT_All_Psychotropics.xlsx
 Saved love plot: outputs\CAT_All_Psychotropics\love_plot_CAT_All_Psychotropics.pdf
 Max weighted SMD for CAT_All_Psychotropics: 0.202

 Processing CAT_All_Psychotropics_Excl_Benzo...
 Exported numeric summary to: outputs\CAT_All_Psychotropics_Excl_Benzo\covariate_balance_table_CAT_All_Psychotropics_Excl_Benzo.xlsx
 Saved love plot: outputs\CAT_All_Psychotropics_Excl_Benzo\love_plot_CAT_All_Psychotropics_Excl_Benzo.pdf
 Max weighted SMD for CAT_All_Psychotropics_Excl_Benzo: 0.196

 Processing CAT_All_Psychotropics_Excl_Sedatives_Hypnotics...
 Exported numeric summary to: outputs\CAT_All_Psychotropics_Excl_Sedatives_Hypnotics\covariate_balance_table_CAT_All_Psychotropics_Excl_Sedatives_Hypnotics.xlsx
 Saved love plot: outputs\CAT_All_Psychotropics_Excl_Sedatives_Hypnotics\love_plot_CAT_All_Psychotropics_Excl_Sedatives_Hypnotics.pdf
 Max weighted SMD for CAT_All_Psychotropics_Excl_Sedatives_Hypnotics: 0.197

 Processing CAT_Antidepressiva...
 Exported numeric summary to: outputs\CAT_Antidepressiva\covariate_balance_table_CAT_Antidepressiva.xlsx
 Saved love plot: outputs\CAT_Antidepressiva\love_plot_CAT_Antidepressiva.pdf
 Max weighted SMD for CAT_Antidepressiva: 0.128

 Processing CAT_Antihistaminica...
 Exported numeric summary to: outputs\CAT_Antihistaminica\covariate_balance_table_CAT_Antihistaminica.xlsx
 Saved love plot: outputs\CAT_Antihistaminica\love_plot_CAT_Antihistaminica.pdf
 Max weighted SMD for CAT_Antihistaminica: 0.331

 Processing CAT_Antihypertensiva...
 Exported numeric summary to: outputs\CAT_Antihypertensiva\covariate_balance_table_CAT_Antihypertensiva.xlsx
 Saved love plot: outputs\CAT_Antihypertensiva\love_plot_CAT_Antihypertensiva.pdf
 Max weighted SMD for CAT_Antihypertensiva: 0.311

 Processing CAT_Antipsychotica...
 Exported numeric summary to: outputs\CAT_Antipsychotica\covariate_balance_table_CAT_Antipsychotica.xlsx
 Saved love plot: outputs\CAT_Antipsychotica\love_plot_CAT_Antipsychotica.pdf
 Max weighted SMD for CAT_Antipsychotica: 0.223

 Processing CAT_Anti_Epileptica...
 Exported numeric summary to: outputs\CAT_Anti_Epileptica\covariate_balance_table_CAT_Anti_Epileptica.xlsx
 Saved love plot: outputs\CAT_Anti_Epileptica\love_plot_CAT_Anti_Epileptica.pdf
 Max weighted SMD for CAT_Anti_Epileptica: 0.312

 Processing CAT_Benzodiazepine...
 Exported numeric summary to: outputs\CAT_Benzodiazepine\covariate_balance_table_CAT_Benzodiazepine.xlsx
 Saved love plot: outputs\CAT_Benzodiazepine\love_plot_CAT_Benzodiazepine.pdf
 Max weighted SMD for CAT_Benzodiazepine: 0.163

 Processing CAT_Nsaids...
 Exported numeric summary to: outputs\CAT_Nsaids\covariate_balance_table_CAT_Nsaids.xlsx
 Saved love plot: outputs\CAT_Nsaids\love_plot_CAT_Nsaids.pdf
 Max weighted SMD for CAT_Nsaids: 0.414

 Processing CAT_Opioden...
 Exported numeric summary to: outputs\CAT_Opioden\covariate_balance_table_CAT_Opioden.xlsx
 Saved love plot: outputs\CAT_Opioden\love_plot_CAT_Opioden.pdf
 Max weighted SMD for CAT_Opioden: 0.401

 Processing CAT_Z_Drugs...
 Exported numeric summary to: outputs\CAT_Z_Drugs\covariate_balance_table_CAT_Z_Drugs.xlsx
 Saved love plot: outputs\CAT_Z_Drugs\love_plot_CAT_Z_Drugs.pdf
 Max weighted SMD for CAT_Z_Drugs: 0.392
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=04a3ba94-b9c5-49bf-8daa-ecee013104ac">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[52]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Heatmap:</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=1f9d0b67-ec65-431f-a804-f0af2bc85c96">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[53]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="c1">#-----------------------------</span>
<span class="c1"># Generate heatmaps</span>
<span class="c1"># -------------------------------</span>
<span class="k">for</span> <span class="n">treatment_var</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">========== Creating Heatmap for </span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s2"> =========="</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">'outputs'</span><span class="p">,</span> <span class="n">treatment_var</span><span class="p">)</span>
        <span class="n">balance_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'covariate_balance_table_</span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s1">.xlsx'</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">balance_path</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Balance file not found: </span><span class="si">{</span><span class="n">balance_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">balance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">balance_path</span><span class="p">)</span>

        <span class="c1">#  Use finalized covariates + 'Propensity Score'</span>
        <span class="n">covariates</span> <span class="o">=</span> <span class="n">final_covariates_map</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">'Propensity Score'</span><span class="p">]</span>
        <span class="n">balance_df</span> <span class="o">=</span> <span class="n">balance_df</span><span class="p">[</span><span class="n">balance_df</span><span class="p">[</span><span class="s1">'Covariate'</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">covariates</span><span class="p">)]</span>

        <span class="c1">#  Check for CAPS5score_baseline</span>
        <span class="n">highlight_caps</span> <span class="o">=</span> <span class="s1">'CAPS5score_baseline'</span> <span class="ow">in</span> <span class="n">balance_df</span><span class="p">[</span><span class="s1">'Covariate'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="c1">#  Format for heatmap</span>
        <span class="n">heatmap_df</span> <span class="o">=</span> <span class="n">balance_df</span><span class="p">[[</span><span class="s1">'Covariate'</span><span class="p">,</span> <span class="s1">'SMD_Unweighted'</span><span class="p">,</span> <span class="s1">'SMD_Weighted'</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">heatmap_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'Covariate'</span><span class="p">,</span> <span class="s1">'Unweighted'</span><span class="p">,</span> <span class="s1">'Weighted'</span><span class="p">]</span>
        <span class="n">heatmap_df</span> <span class="o">=</span> <span class="n">heatmap_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">'Covariate'</span><span class="p">)</span>
        <span class="n">heatmap_df</span> <span class="o">=</span> <span class="n">heatmap_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">'Unweighted'</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1">#  Plot</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">heatmap_df</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.35</span><span class="p">)))</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span>
            <span class="n">heatmap_df</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="s2">"coolwarm"</span><span class="p">,</span>
            <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">fmt</span><span class="o">=</span><span class="s2">".2f"</span><span class="p">,</span>
            <span class="n">linewidths</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
            <span class="n">linecolor</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span>
            <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">"label"</span><span class="p">:</span> <span class="s2">"Standardized Mean Difference"</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Covariate Balance Heatmap (Rubin IPTW)</span><span class="se">\n</span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">'bold'</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Condition"</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"Covariate"</span><span class="p">)</span>

        <span class="c1">#  Bold CAPS5score_baseline if present</span>
        <span class="k">if</span> <span class="n">highlight_caps</span><span class="p">:</span>
            <span class="n">ylabels</span> <span class="o">=</span> <span class="p">[</span><span class="n">label</span><span class="o">.</span><span class="n">get_text</span><span class="p">()</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span>
                <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2"> "</span> <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="s1">'CAPS5score_baseline'</span> <span class="k">else</span> <span class="n">label</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ylabels</span>
            <span class="p">])</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="c1">#  Save image</span>
        <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'heatmap_smd_</span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s1">.png'</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Heatmap saved: </span><span class="si">{</span><span class="n">save_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error processing </span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
========== Creating Heatmap for CAT_ADHD ==========
 Heatmap saved: outputs\CAT_ADHD\heatmap_smd_CAT_ADHD.png

========== Creating Heatmap for CAT_Aceetanilidederivaten ==========
 Heatmap saved: outputs\CAT_Aceetanilidederivaten\heatmap_smd_CAT_Aceetanilidederivaten.png

========== Creating Heatmap for CAT_Z_drugs ==========
 Heatmap saved: outputs\CAT_Z_drugs\heatmap_smd_CAT_Z_drugs.png

========== Creating Heatmap for CAT_Opioden ==========
 Heatmap saved: outputs\CAT_Opioden\heatmap_smd_CAT_Opioden.png

========== Creating Heatmap for CAT_NSAIDs ==========
 Heatmap saved: outputs\CAT_NSAIDs\heatmap_smd_CAT_NSAIDs.png

========== Creating Heatmap for CAT_Benzodiazepine ==========
 Heatmap saved: outputs\CAT_Benzodiazepine\heatmap_smd_CAT_Benzodiazepine.png

========== Creating Heatmap for CAT_Antihypertensiva ==========
 Heatmap saved: outputs\CAT_Antihypertensiva\heatmap_smd_CAT_Antihypertensiva.png

========== Creating Heatmap for CAT_Antihistaminica ==========
 Heatmap saved: outputs\CAT_Antihistaminica\heatmap_smd_CAT_Antihistaminica.png

========== Creating Heatmap for CAT_Anti_epileptica ==========
 Heatmap saved: outputs\CAT_Anti_epileptica\heatmap_smd_CAT_Anti_epileptica.png

========== Creating Heatmap for CAT_Antidepressiva ==========
 Heatmap saved: outputs\CAT_Antidepressiva\heatmap_smd_CAT_Antidepressiva.png

========== Creating Heatmap for CAT_Antipsychotica ==========
 Heatmap saved: outputs\CAT_Antipsychotica\heatmap_smd_CAT_Antipsychotica.png

========== Creating Heatmap for CAT_ALL_PSYCHOTROPICS_EXCL_BENZO ==========
 Heatmap saved: outputs\CAT_ALL_PSYCHOTROPICS_EXCL_BENZO\heatmap_smd_CAT_ALL_PSYCHOTROPICS_EXCL_BENZO.png

========== Creating Heatmap for CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS ==========
 Heatmap saved: outputs\CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS\heatmap_smd_CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS.png

========== Creating Heatmap for CAT_ALL_PSYCHOTROPICS ==========
 Heatmap saved: outputs\CAT_ALL_PSYCHOTROPICS\heatmap_smd_CAT_ALL_PSYCHOTROPICS.png

========== Creating Heatmap for CAT_ALL ==========
 Heatmap saved: outputs\CAT_ALL\heatmap_smd_CAT_ALL.png
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=a05acf0f-8311-4c39-b99e-780b7f48d835">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span> 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=f68fb1c3-430a-4ff8-893d-7f2a9f3c2c2c">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="Subcat-analysis:">Subcat analysis:<a class="anchor-link" href="#Subcat-analysis:"></a></h2>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=2a961590-c301-4cfd-a108-fd1559a81ed2">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[54]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">covariates_SUBCAT_Antipsychotica_atypisch</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span> <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SUBCAT_TCA</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SUBCAT_SSRI</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SUBCAT_SNRI</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_SUBCAT_Tetracyclische_antidepressiva</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SUBCAT_Antidepressiva_overige</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SUBCAT_Systemische_antihistaminica</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span> <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_SUBCAT_anxiolytica_Benzodiazepine</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SUBCAT_hypnotica_Benzodiazepine</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_SUBCAT_Amfetaminen</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span> <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span>
    <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_SUBCAT_Paracetamol_mono</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span> <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_SUBCAT_Anti_epileptica_stemmingsstabilisatoren</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span> 
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SUBCAT_Opioden</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SUBCAT_Z_drugs</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span> <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SUBCAT_NSAIDs</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=1d14a89b-45eb-4260-bee8-4594d9f4e39e">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[55]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="c1"># This finds all variables that start with covariates_SUBCAT_</span>
<span class="n">final_covariates_map</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<span class="n">final_covariates_map</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
    <span class="n">var</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"covariates_"</span><span class="p">,</span> <span class="s2">""</span><span class="p">):</span> <span class="n">val</span>
    <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"covariates_subcat_"</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
<span class="p">})</span>

<span class="c1"># Show detected group names</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Groups found:"</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
<span class="n">medication_groups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">medication_groups</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Groups found: ['SUBCAT_Antipsychotica_atypisch', 'SUBCAT_TCA', 'SUBCAT_SSRI', 'SUBCAT_SNRI', 'SUBCAT_Tetracyclische_antidepressiva', 'SUBCAT_Antidepressiva_overige', 'SUBCAT_Systemische_antihistaminica', 'SUBCAT_anxiolytica_Benzodiazepine', 'SUBCAT_hypnotica_Benzodiazepine', 'SUBCAT_Amfetaminen', 'SUBCAT_Paracetamol_mono', 'SUBCAT_Anti_epileptica_stemmingsstabilisatoren', 'SUBCAT_Opioden', 'SUBCAT_Z_drugs', 'SUBCAT_NSAIDs']
['SUBCAT_Antipsychotica_atypisch', 'SUBCAT_TCA', 'SUBCAT_SSRI', 'SUBCAT_SNRI', 'SUBCAT_Tetracyclische_antidepressiva', 'SUBCAT_Antidepressiva_overige', 'SUBCAT_Systemische_antihistaminica', 'SUBCAT_anxiolytica_Benzodiazepine', 'SUBCAT_hypnotica_Benzodiazepine', 'SUBCAT_Amfetaminen', 'SUBCAT_Paracetamol_mono', 'SUBCAT_Anti_epileptica_stemmingsstabilisatoren', 'SUBCAT_Opioden', 'SUBCAT_Z_drugs', 'SUBCAT_NSAIDs']
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=b68dcdf5-6a5d-4fba-9d5e-0ff3ae44f705">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[56]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>


<span class="k">def</span> <span class="nf">run_all_SUBCAT_group_models</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Runs downstream analysis for each SUBCAT medisubcation group using imputed datasets.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - imputed_dfs: list of 5 imputed DataFrames (from df_imputed_final_imp1.pkl ... imp5.pkl)</span>
<span class="sd">    </span>
<span class="sd">    Notes:</span>
<span class="sd">    - Covariate lists must be defined as global variables: covariates_subcat_&lt;group&gt;</span>
<span class="sd">    - Outputs are saved in: outputs/SUBCAT_&lt;GROUP&gt;/</span>
<span class="sd">    """</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">" Starting analysis for all SUBCAT groups"</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">var_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"covariates_subcat_"</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">globals</span><span class="p">()[</span><span class="n">var_name</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">group_name</span> <span class="o">=</span> <span class="n">var_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"covariates_"</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
            <span class="n">group_name</span> <span class="o">=</span> <span class="n">group_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"_"</span><span class="p">,</span> <span class="s2">" "</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">" "</span><span class="p">,</span> <span class="s2">"_"</span><span class="p">)</span>  <span class="c1"># e.g., subcat_z_drugs  Subcat_Z_Drugs</span>
            <span class="n">group_name</span> <span class="o">=</span> <span class="n">group_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"Subcat_"</span><span class="p">,</span> <span class="s2">"SUBCAT_"</span><span class="p">)</span>  <span class="c1"># force prefix to uppercase</span>

            <span class="n">covariates</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()[</span><span class="n">var_name</span><span class="p">]</span>
            <span class="n">output_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"outputs/</span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">"</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Processing </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">..."</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">df_imp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   Using imputation </span><span class="si">{</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

                <span class="c1"># Define X and Y</span>
                <span class="n">X</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span>
                <span class="n">Y</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="s2">"caps5_change_baseline"</span><span class="p">]</span>

                <span class="c1"># === Save X and Y as placeholder (replace with modeling later)</span>
                <span class="n">X</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/X_imp</span><span class="si">{</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.csv"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">Y</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"Y"</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/Y_imp</span><span class="si">{</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.csv"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Done: </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> All SUBCAT group analyses complete."</span><span class="p">)</span>

<span class="c1"># ========= STEP 4: Execute ========= #</span>
<span class="n">run_all_SUBCAT_group_models</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre> Starting analysis for all SUBCAT groups

 Processing SUBCAT_Antipsychotica_Atypisch...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBCAT_Antipsychotica_Atypisch

 Processing SUBCAT_Tca...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBCAT_Tca

 Processing SUBCAT_Ssri...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBCAT_Ssri

 Processing SUBCAT_Snri...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBCAT_Snri

 Processing SUBCAT_Tetracyclische_Antidepressiva...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBCAT_Tetracyclische_Antidepressiva

 Processing SUBCAT_Antidepressiva_Overige...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBCAT_Antidepressiva_Overige

 Processing SUBCAT_Systemische_Antihistaminica...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBCAT_Systemische_Antihistaminica

 Processing SUBCAT_Anxiolytica_Benzodiazepine...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBCAT_Anxiolytica_Benzodiazepine

 Processing SUBCAT_Hypnotica_Benzodiazepine...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBCAT_Hypnotica_Benzodiazepine

 Processing SUBCAT_Amfetaminen...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBCAT_Amfetaminen

 Processing SUBCAT_Paracetamol_Mono...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBCAT_Paracetamol_Mono

 Processing SUBCAT_Anti_Epileptica_Stemmingsstabilisatoren...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBCAT_Anti_Epileptica_Stemmingsstabilisatoren

 Processing SUBCAT_Opioden...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBCAT_Opioden

 Processing SUBCAT_Z_Drugs...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBCAT_Z_Drugs

 Processing SUBCAT_Nsaids...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBCAT_Nsaids

 All SUBCAT group analyses complete.
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=40cd90ed-a540-4498-92a6-58c70ad1d441">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[57]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">treatment_var</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">treatment_var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Imp </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">:  Not found in columns."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">treated</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">control</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Imp </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: Treated = </span><span class="si">{</span><span class="n">treated</span><span class="si">}</span><span class="s2">, Control = </span><span class="si">{</span><span class="n">control</span><span class="si">}</span><span class="s2">, Missing = </span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 SUBCAT_Antipsychotica_atypisch
  Imp 1: Treated = 256, Control = 3385, Missing = 0
  Imp 2: Treated = 256, Control = 3385, Missing = 0
  Imp 3: Treated = 256, Control = 3385, Missing = 0
  Imp 4: Treated = 256, Control = 3385, Missing = 0
  Imp 5: Treated = 256, Control = 3385, Missing = 0

 SUBCAT_TCA
  Imp 1: Treated = 86, Control = 3555, Missing = 0
  Imp 2: Treated = 86, Control = 3555, Missing = 0
  Imp 3: Treated = 86, Control = 3555, Missing = 0
  Imp 4: Treated = 86, Control = 3555, Missing = 0
  Imp 5: Treated = 86, Control = 3555, Missing = 0

 SUBCAT_SSRI
  Imp 1: Treated = 396, Control = 3245, Missing = 0
  Imp 2: Treated = 396, Control = 3245, Missing = 0
  Imp 3: Treated = 396, Control = 3245, Missing = 0
  Imp 4: Treated = 396, Control = 3245, Missing = 0
  Imp 5: Treated = 396, Control = 3245, Missing = 0

 SUBCAT_SNRI
  Imp 1: Treated = 82, Control = 3559, Missing = 0
  Imp 2: Treated = 82, Control = 3559, Missing = 0
  Imp 3: Treated = 82, Control = 3559, Missing = 0
  Imp 4: Treated = 82, Control = 3559, Missing = 0
  Imp 5: Treated = 82, Control = 3559, Missing = 0

 SUBCAT_Tetracyclische_antidepressiva
  Imp 1: Treated = 87, Control = 3554, Missing = 0
  Imp 2: Treated = 87, Control = 3554, Missing = 0
  Imp 3: Treated = 87, Control = 3554, Missing = 0
  Imp 4: Treated = 87, Control = 3554, Missing = 0
  Imp 5: Treated = 87, Control = 3554, Missing = 0

 SUBCAT_Antidepressiva_overige
  Imp 1: Treated = 42, Control = 3599, Missing = 0
  Imp 2: Treated = 42, Control = 3599, Missing = 0
  Imp 3: Treated = 42, Control = 3599, Missing = 0
  Imp 4: Treated = 42, Control = 3599, Missing = 0
  Imp 5: Treated = 42, Control = 3599, Missing = 0

 SUBCAT_Systemische_antihistaminica
  Imp 1: Treated = 56, Control = 3585, Missing = 0
  Imp 2: Treated = 56, Control = 3585, Missing = 0
  Imp 3: Treated = 56, Control = 3585, Missing = 0
  Imp 4: Treated = 56, Control = 3585, Missing = 0
  Imp 5: Treated = 56, Control = 3585, Missing = 0

 SUBCAT_anxiolytica_Benzodiazepine
  Imp 1: Treated = 311, Control = 3330, Missing = 0
  Imp 2: Treated = 311, Control = 3330, Missing = 0
  Imp 3: Treated = 311, Control = 3330, Missing = 0
  Imp 4: Treated = 311, Control = 3330, Missing = 0
  Imp 5: Treated = 311, Control = 3330, Missing = 0

 SUBCAT_hypnotica_Benzodiazepine
  Imp 1: Treated = 132, Control = 3509, Missing = 0
  Imp 2: Treated = 132, Control = 3509, Missing = 0
  Imp 3: Treated = 132, Control = 3509, Missing = 0
  Imp 4: Treated = 132, Control = 3509, Missing = 0
  Imp 5: Treated = 132, Control = 3509, Missing = 0

 SUBCAT_Amfetaminen
  Imp 1: Treated = 52, Control = 3589, Missing = 0
  Imp 2: Treated = 52, Control = 3589, Missing = 0
  Imp 3: Treated = 52, Control = 3589, Missing = 0
  Imp 4: Treated = 52, Control = 3589, Missing = 0
  Imp 5: Treated = 52, Control = 3589, Missing = 0

 SUBCAT_Paracetamol_mono
  Imp 1: Treated = 43, Control = 3598, Missing = 0
  Imp 2: Treated = 43, Control = 3598, Missing = 0
  Imp 3: Treated = 43, Control = 3598, Missing = 0
  Imp 4: Treated = 43, Control = 3598, Missing = 0
  Imp 5: Treated = 43, Control = 3598, Missing = 0

 SUBCAT_Anti_epileptica_stemmingsstabilisatoren
  Imp 1: Treated = 57, Control = 3584, Missing = 0
  Imp 2: Treated = 57, Control = 3584, Missing = 0
  Imp 3: Treated = 57, Control = 3584, Missing = 0
  Imp 4: Treated = 57, Control = 3584, Missing = 0
  Imp 5: Treated = 57, Control = 3584, Missing = 0

 SUBCAT_Opioden
  Imp 1: Treated = 54, Control = 3587, Missing = 0
  Imp 2: Treated = 54, Control = 3587, Missing = 0
  Imp 3: Treated = 54, Control = 3587, Missing = 0
  Imp 4: Treated = 54, Control = 3587, Missing = 0
  Imp 5: Treated = 54, Control = 3587, Missing = 0

 SUBCAT_Z_drugs
  Imp 1: Treated = 57, Control = 3584, Missing = 0
  Imp 2: Treated = 57, Control = 3584, Missing = 0
  Imp 3: Treated = 57, Control = 3584, Missing = 0
  Imp 4: Treated = 57, Control = 3584, Missing = 0
  Imp 5: Treated = 57, Control = 3584, Missing = 0

 SUBCAT_NSAIDs
  Imp 1: Treated = 37, Control = 3604, Missing = 0
  Imp 2: Treated = 37, Control = 3604, Missing = 0
  Imp 3: Treated = 37, Control = 3604, Missing = 0
  Imp 4: Treated = 37, Control = 3604, Missing = 0
  Imp 5: Treated = 37, Control = 3604, Missing = 0
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=d57b3c56-b77b-40db-a63c-026f92d9214e">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[58]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">from</span> <span class="nn">statsmodels.stats.outliers_influence</span> <span class="kn">import</span> <span class="n">variance_inflation_factor</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="c1">#  VIF computation function</span>
<span class="k">def</span> <span class="nf">compute_vif</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">has_constant</span><span class="o">=</span><span class="s1">'add'</span><span class="p">)</span>
    <span class="n">vif_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">vif_df</span><span class="p">[</span><span class="s2">"variable"</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span>
    <span class="n">vif_df</span><span class="p">[</span><span class="s2">"VIF"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">variance_inflation_factor</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
    <span class="k">return</span> <span class="n">vif_df</span>

<span class="c1">#  Process each group</span>
<span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Processing VIF for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  No covariates found for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
        <span class="k">continue</span>

    <span class="n">covariates</span> <span class="o">=</span> <span class="n">final_covariates_map</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
    <span class="n">vif_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df_imp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">vif_df</span> <span class="o">=</span> <span class="n">compute_vif</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="n">vif_df</span><span class="p">[</span><span class="s2">"imputation"</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">vif_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vif_df</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"    Failed on imputation </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">vif_list</span><span class="p">:</span>
        <span class="n">all_vif</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">vif_list</span><span class="p">)</span>
        <span class="n">pooled_vif</span> <span class="o">=</span> <span class="n">all_vif</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">"variable"</span><span class="p">)[</span><span class="s2">"VIF"</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">pooled_vif</span> <span class="o">=</span> <span class="n">pooled_vif</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">"VIF"</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"outputs"</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">pooled_vif</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"pooled_vif.csv"</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Saved: </span><span class="si">{</span><span class="n">output_folder</span><span class="si">}</span><span class="s2">/pooled_vif.csv"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Skipped </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: No valid imputations."</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Processing VIF for SUBCAT_Antipsychotica_atypisch
  Saved: outputs\SUBCAT_Antipsychotica_atypisch/pooled_vif.csv

 Processing VIF for SUBCAT_TCA
  Saved: outputs\SUBCAT_TCA/pooled_vif.csv

 Processing VIF for SUBCAT_SSRI
  Saved: outputs\SUBCAT_SSRI/pooled_vif.csv

 Processing VIF for SUBCAT_SNRI
  Saved: outputs\SUBCAT_SNRI/pooled_vif.csv

 Processing VIF for SUBCAT_Tetracyclische_antidepressiva
  Saved: outputs\SUBCAT_Tetracyclische_antidepressiva/pooled_vif.csv

 Processing VIF for SUBCAT_Antidepressiva_overige
  Saved: outputs\SUBCAT_Antidepressiva_overige/pooled_vif.csv

 Processing VIF for SUBCAT_Systemische_antihistaminica
  Saved: outputs\SUBCAT_Systemische_antihistaminica/pooled_vif.csv

 Processing VIF for SUBCAT_anxiolytica_Benzodiazepine
  Saved: outputs\SUBCAT_anxiolytica_Benzodiazepine/pooled_vif.csv

 Processing VIF for SUBCAT_hypnotica_Benzodiazepine
  Saved: outputs\SUBCAT_hypnotica_Benzodiazepine/pooled_vif.csv

 Processing VIF for SUBCAT_Amfetaminen
  Saved: outputs\SUBCAT_Amfetaminen/pooled_vif.csv

 Processing VIF for SUBCAT_Paracetamol_mono
  Saved: outputs\SUBCAT_Paracetamol_mono/pooled_vif.csv

 Processing VIF for SUBCAT_Anti_epileptica_stemmingsstabilisatoren
  Saved: outputs\SUBCAT_Anti_epileptica_stemmingsstabilisatoren/pooled_vif.csv

 Processing VIF for SUBCAT_Opioden
  Saved: outputs\SUBCAT_Opioden/pooled_vif.csv

 Processing VIF for SUBCAT_Z_drugs
  Saved: outputs\SUBCAT_Z_drugs/pooled_vif.csv

 Processing VIF for SUBCAT_NSAIDs
  Saved: outputs\SUBCAT_NSAIDs/pooled_vif.csv
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=7dc544c6-0815-4712-ac03-b378443452b7">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[59]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">xgboost</span> <span class="kn">import</span> <span class="n">XGBClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">roc_curve</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>

<span class="c1"># ---------- PS Estimation Function ----------</span>
<span class="k">def</span> <span class="nf">run_xgboost_ps_modeling</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Running PS estimation for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No covariates found for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"outputs"</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">covariates</span> <span class="o">=</span> <span class="n">final_covariates_map</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
        <span class="n">ps_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">auc_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df_imp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_imp</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> not found in imputed dataset </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">X</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>

            <span class="c1"># Drop missing treatment rows</span>
            <span class="n">valid_idx</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">index</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>

            <span class="c1"># Train-test split for ROC</span>
            <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">T_train</span><span class="p">,</span> <span class="n">T_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
                <span class="n">X</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
            <span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">XGBClassifier</span><span class="p">(</span><span class="n">use_label_encoder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eval_metric</span><span class="o">=</span><span class="s1">'logloss'</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
                <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">T_train</span><span class="p">)</span>

                <span class="n">ps_scores</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">ps_matrix</span><span class="p">[</span><span class="sa">f</span><span class="s2">"ps_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">ps_scores</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">valid_idx</span><span class="p">)</span>

                <span class="c1"># ROC &amp; AUC</span>
                <span class="n">auc</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">T_test</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">auc_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">auc</span><span class="p">)</span>

                <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">T_test</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">"AUC = </span><span class="si">{</span><span class="n">auc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'k--'</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"False Positive Rate"</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"True Positive Rate"</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"ROC Curve - </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> (Imp </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">)"</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"roc_curve_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.png"</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   Imp </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: AUC = </span><span class="si">{</span><span class="n">auc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, ROC saved."</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> (imp </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Save AUCs and Composite PS</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ps_matrix</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="c1"># Fill NaN rows (from dropped subjects in some imputations) with mean</span>
            <span class="n">ps_matrix</span><span class="p">[</span><span class="s2">"composite_ps"</span><span class="p">]</span> <span class="o">=</span> <span class="n">ps_matrix</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ps_matrix</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"propensity_scores.xlsx"</span><span class="p">))</span>

            <span class="n">auc_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s2">"imputation"</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">"imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">auc_list</span><span class="p">))],</span>
                <span class="s2">"AUC"</span><span class="p">:</span> <span class="n">auc_list</span>
            <span class="p">})</span>
            <span class="n">auc_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">auc_df</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"mean"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">auc_list</span><span class="p">)</span> <span class="k">if</span> <span class="n">auc_list</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span>
            <span class="n">auc_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"auc_scores.xlsx"</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Composite PS + AUC saved for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No valid PS scores generated for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># ---------- Run ----------</span>
<span class="n">run_xgboost_ps_modeling</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre> Running PS estimation for SUBCAT_Antipsychotica_atypisch
   Imp 1: AUC = 0.998, ROC saved.
   Imp 2: AUC = 0.998, ROC saved.
   Imp 3: AUC = 0.998, ROC saved.
   Imp 4: AUC = 0.998, ROC saved.
   Imp 5: AUC = 0.998, ROC saved.
 Composite PS + AUC saved for SUBCAT_Antipsychotica_atypisch
 Running PS estimation for SUBCAT_TCA
   Imp 1: AUC = 0.581, ROC saved.
   Imp 2: AUC = 0.579, ROC saved.
   Imp 3: AUC = 0.590, ROC saved.
   Imp 4: AUC = 0.599, ROC saved.
   Imp 5: AUC = 0.589, ROC saved.
 Composite PS + AUC saved for SUBCAT_TCA
 Running PS estimation for SUBCAT_SSRI
   Imp 1: AUC = 0.659, ROC saved.
   Imp 2: AUC = 0.663, ROC saved.
   Imp 3: AUC = 0.660, ROC saved.
   Imp 4: AUC = 0.657, ROC saved.
   Imp 5: AUC = 0.661, ROC saved.
 Composite PS + AUC saved for SUBCAT_SSRI
 Running PS estimation for SUBCAT_SNRI
   Imp 1: AUC = 0.684, ROC saved.
   Imp 2: AUC = 0.671, ROC saved.
   Imp 3: AUC = 0.649, ROC saved.
   Imp 4: AUC = 0.656, ROC saved.
   Imp 5: AUC = 0.680, ROC saved.
 Composite PS + AUC saved for SUBCAT_SNRI
 Running PS estimation for SUBCAT_Tetracyclische_antidepressiva
   Imp 1: AUC = 0.587, ROC saved.
   Imp 2: AUC = 0.543, ROC saved.
   Imp 3: AUC = 0.564, ROC saved.
   Imp 4: AUC = 0.578, ROC saved.
   Imp 5: AUC = 0.603, ROC saved.
 Composite PS + AUC saved for SUBCAT_Tetracyclische_antidepressiva
 Running PS estimation for SUBCAT_Antidepressiva_overige
   Imp 1: AUC = 0.451, ROC saved.
   Imp 2: AUC = 0.465, ROC saved.
   Imp 3: AUC = 0.522, ROC saved.
   Imp 4: AUC = 0.557, ROC saved.
   Imp 5: AUC = 0.505, ROC saved.
 Composite PS + AUC saved for SUBCAT_Antidepressiva_overige
 Running PS estimation for SUBCAT_Systemische_antihistaminica
   Imp 1: AUC = 0.661, ROC saved.
   Imp 2: AUC = 0.665, ROC saved.
   Imp 3: AUC = 0.613, ROC saved.
   Imp 4: AUC = 0.663, ROC saved.
   Imp 5: AUC = 0.632, ROC saved.
 Composite PS + AUC saved for SUBCAT_Systemische_antihistaminica
 Running PS estimation for SUBCAT_anxiolytica_Benzodiazepine
   Imp 1: AUC = 0.707, ROC saved.
   Imp 2: AUC = 0.719, ROC saved.
   Imp 3: AUC = 0.701, ROC saved.
   Imp 4: AUC = 0.716, ROC saved.
   Imp 5: AUC = 0.689, ROC saved.
 Composite PS + AUC saved for SUBCAT_anxiolytica_Benzodiazepine
 Running PS estimation for SUBCAT_hypnotica_Benzodiazepine
   Imp 1: AUC = 0.573, ROC saved.
   Imp 2: AUC = 0.573, ROC saved.
   Imp 3: AUC = 0.631, ROC saved.
   Imp 4: AUC = 0.601, ROC saved.
   Imp 5: AUC = 0.600, ROC saved.
 Composite PS + AUC saved for SUBCAT_hypnotica_Benzodiazepine
 Running PS estimation for SUBCAT_Amfetaminen
   Imp 1: AUC = 0.535, ROC saved.
   Imp 2: AUC = 0.553, ROC saved.
   Imp 3: AUC = 0.523, ROC saved.
   Imp 4: AUC = 0.579, ROC saved.
   Imp 5: AUC = 0.533, ROC saved.
 Composite PS + AUC saved for SUBCAT_Amfetaminen
 Running PS estimation for SUBCAT_Paracetamol_mono
   Imp 1: AUC = 0.589, ROC saved.
   Imp 2: AUC = 0.589, ROC saved.
   Imp 3: AUC = 0.656, ROC saved.
   Imp 4: AUC = 0.622, ROC saved.
   Imp 5: AUC = 0.631, ROC saved.
 Composite PS + AUC saved for SUBCAT_Paracetamol_mono
 Running PS estimation for SUBCAT_Anti_epileptica_stemmingsstabilisatoren
   Imp 1: AUC = 0.664, ROC saved.
   Imp 2: AUC = 0.674, ROC saved.
   Imp 3: AUC = 0.714, ROC saved.
   Imp 4: AUC = 0.684, ROC saved.
   Imp 5: AUC = 0.674, ROC saved.
 Composite PS + AUC saved for SUBCAT_Anti_epileptica_stemmingsstabilisatoren
 Running PS estimation for SUBCAT_Opioden
   Imp 1: AUC = 0.621, ROC saved.
   Imp 2: AUC = 0.630, ROC saved.
   Imp 3: AUC = 0.640, ROC saved.
   Imp 4: AUC = 0.702, ROC saved.
   Imp 5: AUC = 0.662, ROC saved.
 Composite PS + AUC saved for SUBCAT_Opioden
 Running PS estimation for SUBCAT_Z_drugs
   Imp 1: AUC = 0.558, ROC saved.
   Imp 2: AUC = 0.634, ROC saved.
   Imp 3: AUC = 0.570, ROC saved.
   Imp 4: AUC = 0.561, ROC saved.
   Imp 5: AUC = 0.605, ROC saved.
 Composite PS + AUC saved for SUBCAT_Z_drugs
 Running PS estimation for SUBCAT_NSAIDs
   Imp 1: AUC = 0.545, ROC saved.
   Imp 2: AUC = 0.567, ROC saved.
   Imp 3: AUC = 0.594, ROC saved.
   Imp 4: AUC = 0.601, ROC saved.
   Imp 5: AUC = 0.563, ROC saved.
 Composite PS + AUC saved for SUBCAT_NSAIDs
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=47524442-ca28-4f91-9a75-b6d770877c44">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[60]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">xgboost</span> <span class="kn">import</span> <span class="n">XGBClassifier</span>

<span class="k">def</span> <span class="nf">compute_feature_importance</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Computing feature importance for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No covariates found for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">covariates</span> <span class="o">=</span> <span class="n">final_covariates_map</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
        <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"outputs"</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">importance_df_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df_imp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_imp</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> not in imputed dataset </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">X</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>

            <span class="c1"># Drop NaNs in treatment</span>
            <span class="n">valid_idx</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">index</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">XGBClassifier</span><span class="p">(</span><span class="n">use_label_encoder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eval_metric</span><span class="o">=</span><span class="s1">'logloss'</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
                <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>

                <span class="c1"># Get feature importance</span>
                <span class="n">importances</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_booster</span><span class="p">()</span><span class="o">.</span><span class="n">get_score</span><span class="p">(</span><span class="n">importance_type</span><span class="o">=</span><span class="s1">'gain'</span><span class="p">)</span>
                <span class="n">df_feat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">importances</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">'index'</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">"imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">])</span>
                <span class="n">df_feat</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">'feature'</span>
                <span class="n">importance_df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_feat</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   Error during modeling: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">importance_df_list</span><span class="p">:</span>
            <span class="c1"># Combine and average</span>
            <span class="n">all_feat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">importance_df_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">all_feat</span><span class="p">[</span><span class="s2">"mean_importance"</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_feat</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Filter top 30 non-zero</span>
            <span class="n">non_zero</span> <span class="o">=</span> <span class="n">all_feat</span><span class="p">[</span><span class="n">all_feat</span><span class="p">[</span><span class="s2">"mean_importance"</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">top30</span> <span class="o">=</span> <span class="n">non_zero</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">"mean_importance"</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>

            <span class="c1"># Save to CSV</span>
            <span class="n">top30</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"feature_importance.csv"</span><span class="p">))</span>

            <span class="c1"># Plot</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top30</span><span class="o">.</span><span class="n">index</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">top30</span><span class="p">[</span><span class="s2">"mean_importance"</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># plot top  bottom</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Mean Gain Importance"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Top 30 Feature Importance - </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"feature_importance_top30.png"</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Saved feature importance plot and CSV for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No valid models for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1">#  Run</span>
<span class="n">compute_feature_importance</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Computing feature importance for SUBCAT_Antipsychotica_atypisch
 Saved feature importance plot and CSV for SUBCAT_Antipsychotica_atypisch

 Computing feature importance for SUBCAT_TCA
 Saved feature importance plot and CSV for SUBCAT_TCA

 Computing feature importance for SUBCAT_SSRI
 Saved feature importance plot and CSV for SUBCAT_SSRI

 Computing feature importance for SUBCAT_SNRI
 Saved feature importance plot and CSV for SUBCAT_SNRI

 Computing feature importance for SUBCAT_Tetracyclische_antidepressiva
 Saved feature importance plot and CSV for SUBCAT_Tetracyclische_antidepressiva

 Computing feature importance for SUBCAT_Antidepressiva_overige
 Saved feature importance plot and CSV for SUBCAT_Antidepressiva_overige

 Computing feature importance for SUBCAT_Systemische_antihistaminica
 Saved feature importance plot and CSV for SUBCAT_Systemische_antihistaminica

 Computing feature importance for SUBCAT_anxiolytica_Benzodiazepine
 Saved feature importance plot and CSV for SUBCAT_anxiolytica_Benzodiazepine

 Computing feature importance for SUBCAT_hypnotica_Benzodiazepine
 Saved feature importance plot and CSV for SUBCAT_hypnotica_Benzodiazepine

 Computing feature importance for SUBCAT_Amfetaminen
 Saved feature importance plot and CSV for SUBCAT_Amfetaminen

 Computing feature importance for SUBCAT_Paracetamol_mono
 Saved feature importance plot and CSV for SUBCAT_Paracetamol_mono

 Computing feature importance for SUBCAT_Anti_epileptica_stemmingsstabilisatoren
 Saved feature importance plot and CSV for SUBCAT_Anti_epileptica_stemmingsstabilisatoren

 Computing feature importance for SUBCAT_Opioden
 Saved feature importance plot and CSV for SUBCAT_Opioden

 Computing feature importance for SUBCAT_Z_drugs
 Saved feature importance plot and CSV for SUBCAT_Z_drugs

 Computing feature importance for SUBCAT_NSAIDs
 Saved feature importance plot and CSV for SUBCAT_NSAIDs
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=bd7b6712-1c60-44d2-96a3-f57274cc0cf1">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[61]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="k">def</span> <span class="nf">compute_trimmed_clipped_iptw</span><span class="p">(</span><span class="n">ps_df</span><span class="p">,</span> <span class="n">treatment</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">clip_max</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">keep_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">ps_df</span> <span class="o">&gt;</span> <span class="n">lower</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ps_df</span> <span class="o">&lt;</span> <span class="n">upper</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ps_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">ps</span> <span class="o">=</span> <span class="n">ps_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">lower</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">1e-6</span><span class="p">)</span>  <span class="c1"># avoid div by zero</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">keep_mask</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">ps</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="n">w</span><span class="p">[</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">treatment</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">ps</span><span class="p">[</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">treatment</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="n">w</span><span class="p">[</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">treatment</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ps</span><span class="p">[</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">treatment</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)])</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">upper</span><span class="o">=</span><span class="n">clip_max</span><span class="p">)</span>
        <span class="n">weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">apply_rubins_rule_to_iptw</span><span class="p">(</span><span class="n">iptw_matrix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Given an IPTW matrix (n rows  M imputations), return Rubins rule pooled mean, SD, SE.</span>
<span class="sd">    """</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">q_bar</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">u_bar</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">total_var</span> <span class="o">=</span> <span class="n">u_bar</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">M</span><span class="p">)</span> <span class="o">*</span> <span class="n">B</span>
    <span class="n">total_se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">total_var</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">q_bar</span><span class="p">,</span> <span class="n">u_bar</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">total_se</span>


<span class="k">def</span> <span class="nf">run_trim_clip_save_all</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Processing IPTW + trimming + clipping for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"outputs"</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">ps_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"propensity_scores.xlsx"</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ps_path</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Missing PS file: </span><span class="si">{</span><span class="n">ps_path</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ps_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">ps_path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">ps_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">ps_all</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"ps_imp"</span><span class="p">)]</span>
            <span class="n">composite_index</span> <span class="o">=</span> <span class="n">ps_all</span><span class="o">.</span><span class="n">index</span>

            <span class="c1"># Get treatment from one imputed dataset</span>
            <span class="n">T_full</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">imputed_dfs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">T_full</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">composite_index</span><span class="p">,</span> <span class="n">group</span><span class="p">]</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="n">T_full</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Treatment column </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> not found in any imputed dataset."</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Compute IPTW matrix (shape: n  M)</span>
            <span class="n">iptw_matrix</span> <span class="o">=</span> <span class="n">compute_trimmed_clipped_iptw</span><span class="p">(</span><span class="n">ps_all</span><span class="p">[</span><span class="n">ps_cols</span><span class="p">],</span> <span class="n">T_full</span><span class="p">)</span>
            <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">"iptw_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iptw_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>

            <span class="c1"># Apply Rubins Rule for mean, SD, SE</span>
            <span class="n">iptw_matrix</span><span class="p">[</span><span class="s2">"iptw_mean"</span><span class="p">],</span> <span class="n">iptw_matrix</span><span class="p">[</span><span class="s2">"iptw_sd"</span><span class="p">],</span> <span class="n">iptw_matrix</span><span class="p">[</span><span class="s2">"iptw_se"</span><span class="p">]</span> <span class="o">=</span> <span class="n">apply_rubins_rule_to_iptw</span><span class="p">(</span>
                <span class="n">iptw_matrix</span><span class="p">[[</span><span class="sa">f</span><span class="s2">"iptw_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iptw_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]]</span>
            <span class="p">)</span>

            <span class="c1"># Save IPTW matrix separately</span>
            <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"iptw_weights.xlsx"</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Saved IPTW weights for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

            <span class="c1"># Save trimmed &amp; clipped imputed datasets with IPTW</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">imputed_dfs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">trimmed_idx</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="n">needed_cols</span> <span class="o">=</span> <span class="n">final_covariates_map</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">group</span><span class="p">,</span> <span class="s2">"caps5_change_baseline"</span><span class="p">]</span>

                <span class="c1"># Select only necessary columns</span>
                <span class="n">df_trimmed</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">trimmed_idx</span><span class="p">,</span> <span class="n">needed_cols</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">df_trimmed</span><span class="p">[</span><span class="s2">"iptw"</span><span class="p">]</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="p">[</span><span class="sa">f</span><span class="s2">"iptw_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">trimmed_idx</span><span class="p">]</span>

                <span class="c1">#  DROP rows with missing IPTW values</span>
                <span class="n">before</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_trimmed</span><span class="p">)</span>
                <span class="n">df_trimmed</span> <span class="o">=</span> <span class="n">df_trimmed</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">"iptw"</span><span class="p">])</span>
                <span class="n">after</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_trimmed</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"     Retained </span><span class="si">{</span><span class="n">after</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">before</span><span class="si">}</span><span class="s2"> rows after IPTW NaN drop."</span><span class="p">)</span>

                <span class="c1"># Save to .pkl</span>
                <span class="n">df_trimmed</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"trimmed_data_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.pkl"</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   Saved trimmed dataset: </span><span class="si">{</span><span class="n">output_folder</span><span class="si">}</span><span class="s2">/trimmed_data_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.*"</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>


<span class="n">run_trim_clip_save_all</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Processing IPTW + trimming + clipping for SUBCAT_Antipsychotica_atypisch
 Saved IPTW weights for SUBCAT_Antipsychotica_atypisch
     Retained 35/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Antipsychotica_atypisch/trimmed_data_imp1.*
     Retained 34/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Antipsychotica_atypisch/trimmed_data_imp2.*
     Retained 37/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Antipsychotica_atypisch/trimmed_data_imp3.*
     Retained 33/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Antipsychotica_atypisch/trimmed_data_imp4.*
     Retained 33/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Antipsychotica_atypisch/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SUBCAT_TCA
 Saved IPTW weights for SUBCAT_TCA
     Retained 182/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_TCA/trimmed_data_imp1.*
     Retained 182/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_TCA/trimmed_data_imp2.*
     Retained 179/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_TCA/trimmed_data_imp3.*
     Retained 182/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_TCA/trimmed_data_imp4.*
     Retained 176/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_TCA/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SUBCAT_SSRI
 Saved IPTW weights for SUBCAT_SSRI
     Retained 1212/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_SSRI/trimmed_data_imp1.*
     Retained 1210/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_SSRI/trimmed_data_imp2.*
     Retained 1245/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_SSRI/trimmed_data_imp3.*
     Retained 1234/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_SSRI/trimmed_data_imp4.*
     Retained 1224/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_SSRI/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SUBCAT_SNRI
 Saved IPTW weights for SUBCAT_SNRI
     Retained 167/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_SNRI/trimmed_data_imp1.*
     Retained 175/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_SNRI/trimmed_data_imp2.*
     Retained 163/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_SNRI/trimmed_data_imp3.*
     Retained 151/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_SNRI/trimmed_data_imp4.*
     Retained 191/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_SNRI/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SUBCAT_Tetracyclische_antidepressiva
 Saved IPTW weights for SUBCAT_Tetracyclische_antidepressiva
     Retained 180/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Tetracyclische_antidepressiva/trimmed_data_imp1.*
     Retained 180/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Tetracyclische_antidepressiva/trimmed_data_imp2.*
     Retained 196/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Tetracyclische_antidepressiva/trimmed_data_imp3.*
     Retained 195/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Tetracyclische_antidepressiva/trimmed_data_imp4.*
     Retained 177/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Tetracyclische_antidepressiva/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SUBCAT_Antidepressiva_overige
 Saved IPTW weights for SUBCAT_Antidepressiva_overige
     Retained 72/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Antidepressiva_overige/trimmed_data_imp1.*
     Retained 84/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Antidepressiva_overige/trimmed_data_imp2.*
     Retained 79/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Antidepressiva_overige/trimmed_data_imp3.*
     Retained 76/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Antidepressiva_overige/trimmed_data_imp4.*
     Retained 77/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Antidepressiva_overige/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SUBCAT_Systemische_antihistaminica
 Saved IPTW weights for SUBCAT_Systemische_antihistaminica
     Retained 114/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Systemische_antihistaminica/trimmed_data_imp1.*
     Retained 118/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Systemische_antihistaminica/trimmed_data_imp2.*
     Retained 116/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Systemische_antihistaminica/trimmed_data_imp3.*
     Retained 113/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Systemische_antihistaminica/trimmed_data_imp4.*
     Retained 120/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Systemische_antihistaminica/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SUBCAT_anxiolytica_Benzodiazepine
 Saved IPTW weights for SUBCAT_anxiolytica_Benzodiazepine
     Retained 909/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_anxiolytica_Benzodiazepine/trimmed_data_imp1.*
     Retained 889/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_anxiolytica_Benzodiazepine/trimmed_data_imp2.*
     Retained 893/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_anxiolytica_Benzodiazepine/trimmed_data_imp3.*
     Retained 902/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_anxiolytica_Benzodiazepine/trimmed_data_imp4.*
     Retained 893/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_anxiolytica_Benzodiazepine/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SUBCAT_hypnotica_Benzodiazepine
 Saved IPTW weights for SUBCAT_hypnotica_Benzodiazepine
     Retained 325/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_hypnotica_Benzodiazepine/trimmed_data_imp1.*
     Retained 358/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_hypnotica_Benzodiazepine/trimmed_data_imp2.*
     Retained 333/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_hypnotica_Benzodiazepine/trimmed_data_imp3.*
     Retained 321/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_hypnotica_Benzodiazepine/trimmed_data_imp4.*
     Retained 335/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_hypnotica_Benzodiazepine/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SUBCAT_Amfetaminen
 Saved IPTW weights for SUBCAT_Amfetaminen
     Retained 109/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Amfetaminen/trimmed_data_imp1.*
     Retained 103/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Amfetaminen/trimmed_data_imp2.*
     Retained 112/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Amfetaminen/trimmed_data_imp3.*
     Retained 110/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Amfetaminen/trimmed_data_imp4.*
     Retained 103/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Amfetaminen/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SUBCAT_Paracetamol_mono
 Saved IPTW weights for SUBCAT_Paracetamol_mono
     Retained 72/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Paracetamol_mono/trimmed_data_imp1.*
     Retained 79/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Paracetamol_mono/trimmed_data_imp2.*
     Retained 70/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Paracetamol_mono/trimmed_data_imp3.*
     Retained 65/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Paracetamol_mono/trimmed_data_imp4.*
     Retained 72/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Paracetamol_mono/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SUBCAT_Anti_epileptica_stemmingsstabilisatoren
 Saved IPTW weights for SUBCAT_Anti_epileptica_stemmingsstabilisatoren
     Retained 93/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Anti_epileptica_stemmingsstabilisatoren/trimmed_data_imp1.*
     Retained 99/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Anti_epileptica_stemmingsstabilisatoren/trimmed_data_imp2.*
     Retained 93/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Anti_epileptica_stemmingsstabilisatoren/trimmed_data_imp3.*
     Retained 93/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Anti_epileptica_stemmingsstabilisatoren/trimmed_data_imp4.*
     Retained 99/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Anti_epileptica_stemmingsstabilisatoren/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SUBCAT_Opioden
 Saved IPTW weights for SUBCAT_Opioden
     Retained 98/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Opioden/trimmed_data_imp1.*
     Retained 117/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Opioden/trimmed_data_imp2.*
     Retained 102/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Opioden/trimmed_data_imp3.*
     Retained 121/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Opioden/trimmed_data_imp4.*
     Retained 110/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Opioden/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SUBCAT_Z_drugs
 Saved IPTW weights for SUBCAT_Z_drugs
     Retained 124/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Z_drugs/trimmed_data_imp1.*
     Retained 120/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Z_drugs/trimmed_data_imp2.*
     Retained 121/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Z_drugs/trimmed_data_imp3.*
     Retained 119/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Z_drugs/trimmed_data_imp4.*
     Retained 118/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Z_drugs/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SUBCAT_NSAIDs
 Saved IPTW weights for SUBCAT_NSAIDs
     Retained 78/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_NSAIDs/trimmed_data_imp1.*
     Retained 84/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_NSAIDs/trimmed_data_imp2.*
     Retained 78/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_NSAIDs/trimmed_data_imp3.*
     Retained 78/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_NSAIDs/trimmed_data_imp4.*
     Retained 76/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_NSAIDs/trimmed_data_imp5.*
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=8132b1b6-2315-4d56-9728-4f4c73cde88e">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[62]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="k">def</span> <span class="nf">plot_ps_overlap_all_groups</span><span class="p">(</span><span class="n">medication_groups</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Plotting PS overlap for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="n">folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"outputs"</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">ps_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">"propensity_scores.xlsx"</span><span class="p">)</span>
        <span class="n">iptw_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">"iptw_weights.xlsx"</span><span class="p">)</span>
        <span class="n">trimmed_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">"trimmed_data_imp1.pkl"</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ps_file</span><span class="p">,</span> <span class="n">iptw_file</span><span class="p">,</span> <span class="n">trimmed_file</span><span class="p">]):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Missing required files for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ps_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">ps_file</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">iptw_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">iptw_file</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">trimmed_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">trimmed_file</span><span class="p">)</span>

            <span class="c1"># Extract</span>
            <span class="n">ps</span> <span class="o">=</span> <span class="n">ps_df</span><span class="p">[</span><span class="s2">"composite_ps"</span><span class="p">]</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">trimmed_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">iptw_df</span><span class="p">[</span><span class="s2">"iptw_mean"</span><span class="p">]</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">trimmed_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">trimmed_df</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>

            <span class="c1"># Masks to remove NaNs</span>
            <span class="n">treated_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ps</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">w</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
            <span class="n">control_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ps</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">w</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>

            <span class="n">treated</span> <span class="o">=</span> <span class="n">ps</span><span class="p">[</span><span class="n">treated_mask</span><span class="p">]</span>
            <span class="n">treated_w</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="n">treated_mask</span><span class="p">]</span>

            <span class="n">control</span> <span class="o">=</span> <span class="n">ps</span><span class="p">[</span><span class="n">control_mask</span><span class="p">]</span>
            <span class="n">control_w</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="n">control_mask</span><span class="p">]</span>

            <span class="c1"># === Unweighted Plot ===</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">([</span><span class="n">treated</span><span class="p">,</span> <span class="n">control</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="p">[</span><span class="s2">"Treated"</span><span class="p">,</span> <span class="s2">"Control"</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Unweighted PS Overlap - </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Composite Propensity Score"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"Count"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">"ps_overlap_unweighted.png"</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="c1"># === Weighted Plot ===</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">([</span><span class="n">treated</span><span class="p">,</span> <span class="n">control</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="p">[</span><span class="n">treated_w</span><span class="p">,</span> <span class="n">control_w</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="p">[</span><span class="s2">"Treated"</span><span class="p">,</span> <span class="s2">"Control"</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Weighted PS Overlap - </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Composite Propensity Score"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"Weighted Count"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">"ps_overlap_weighted.png"</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Saved unweighted and weighted PS plots for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error processing </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1">#  Run</span>
<span class="n">plot_ps_overlap_all_groups</span><span class="p">(</span><span class="n">medication_groups</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Plotting PS overlap for SUBCAT_Antipsychotica_atypisch
 Saved unweighted and weighted PS plots for SUBCAT_Antipsychotica_atypisch

 Plotting PS overlap for SUBCAT_TCA
 Saved unweighted and weighted PS plots for SUBCAT_TCA

 Plotting PS overlap for SUBCAT_SSRI
 Saved unweighted and weighted PS plots for SUBCAT_SSRI

 Plotting PS overlap for SUBCAT_SNRI
 Saved unweighted and weighted PS plots for SUBCAT_SNRI

 Plotting PS overlap for SUBCAT_Tetracyclische_antidepressiva
 Saved unweighted and weighted PS plots for SUBCAT_Tetracyclische_antidepressiva

 Plotting PS overlap for SUBCAT_Antidepressiva_overige
 Saved unweighted and weighted PS plots for SUBCAT_Antidepressiva_overige

 Plotting PS overlap for SUBCAT_Systemische_antihistaminica
 Saved unweighted and weighted PS plots for SUBCAT_Systemische_antihistaminica

 Plotting PS overlap for SUBCAT_anxiolytica_Benzodiazepine
 Saved unweighted and weighted PS plots for SUBCAT_anxiolytica_Benzodiazepine

 Plotting PS overlap for SUBCAT_hypnotica_Benzodiazepine
 Saved unweighted and weighted PS plots for SUBCAT_hypnotica_Benzodiazepine

 Plotting PS overlap for SUBCAT_Amfetaminen
 Saved unweighted and weighted PS plots for SUBCAT_Amfetaminen

 Plotting PS overlap for SUBCAT_Paracetamol_mono
 Saved unweighted and weighted PS plots for SUBCAT_Paracetamol_mono

 Plotting PS overlap for SUBCAT_Anti_epileptica_stemmingsstabilisatoren
 Saved unweighted and weighted PS plots for SUBCAT_Anti_epileptica_stemmingsstabilisatoren

 Plotting PS overlap for SUBCAT_Opioden
 Saved unweighted and weighted PS plots for SUBCAT_Opioden

 Plotting PS overlap for SUBCAT_Z_drugs
 Saved unweighted and weighted PS plots for SUBCAT_Z_drugs

 Plotting PS overlap for SUBCAT_NSAIDs
 Saved unweighted and weighted PS plots for SUBCAT_NSAIDs
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=08914d6c-189b-423c-8f41-c47cdac5c0cd">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[63]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># Set up base output folder</span>
<span class="n">output_base</span> <span class="o">=</span> <span class="s2">"outputs"</span>
<span class="n">ps_file</span> <span class="o">=</span> <span class="s2">"propensity_scores.xlsx"</span>
<span class="n">iptw_file</span> <span class="o">=</span> <span class="s2">"iptw_weights.xlsx"</span>
<span class="n">trimmed_data_file</span> <span class="o">=</span> <span class="s2">"trimmed_data_imp1.pkl"</span>

<span class="c1"># Collect all treatment group folders</span>
<span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">medication_groups</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">g</span><span class="p">))]</span>


<span class="c1"># Generate 4-panel overlap plots</span>
<span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
    <span class="n">group_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Load trimmed treatment info</span>
        <span class="n">trimmed_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="n">trimmed_data_file</span><span class="p">))</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">trimmed_df</span><span class="o">.</span><span class="n">index</span>

        <span class="c1"># Fix: case-insensitive match for treatment variable</span>
        <span class="n">possible_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">trimmed_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">group</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">possible_cols</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Treatment variable </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> not found in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">, skipping."</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">treatment_var</span> <span class="o">=</span> <span class="n">possible_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">trimmed_df</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span>

        <span class="c1"># Load composite PS (aligned to trimmed_df index)</span>
        <span class="n">ps_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="n">ps_file</span><span class="p">),</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">'composite_ps'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ps_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Composite column missing in </span><span class="si">{</span><span class="n">ps_file</span><span class="si">}</span><span class="s2">, skipping </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">."</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">ps</span> <span class="o">=</span> <span class="n">ps_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s1">'composite_ps'</span><span class="p">]</span>

        <span class="c1"># Load IPTW weights (aligned to trimmed_df index)</span>
        <span class="n">weights_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="n">iptw_file</span><span class="p">),</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">'iptw_mean'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">weights_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" IPTW weight column missing in </span><span class="si">{</span><span class="n">iptw_file</span><span class="si">}</span><span class="s2">, skipping </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">."</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">weights_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s1">'iptw_mean'</span><span class="p">]</span>

        <span class="c1"># Prepare 4 datasets</span>
        <span class="n">raw_treated</span> <span class="o">=</span> <span class="n">ps</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">raw_control</span> <span class="o">=</span> <span class="n">ps</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">weighted_treated</span> <span class="o">=</span> <span class="p">(</span><span class="n">ps</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">],</span> <span class="n">weights</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">weighted_control</span> <span class="o">=</span> <span class="p">(</span><span class="n">ps</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">],</span> <span class="n">weights</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Create plot</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Propensity Score Distribution - </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">raw_treated</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'blue'</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Raw Treated"</span><span class="p">)</span>

        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">raw_control</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'green'</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Raw Control"</span><span class="p">)</span>

        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">weighted_treated</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weighted_treated</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'blue'</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Weighted Treated"</span><span class="p">)</span>

        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">weighted_control</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weighted_control</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'green'</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Weighted Control"</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="o">.</span><span class="n">flat</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Propensity Score"</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Count"</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">])</span>

        <span class="c1"># Save figure</span>
        <span class="n">plot_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"four_panel_overlap_</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">.png"</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_path</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Saved: </span><span class="si">{</span><span class="n">plot_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>  Saved: outputs\SUBCAT_Antipsychotica_atypisch\four_panel_overlap_SUBCAT_Antipsychotica_atypisch.png
  Saved: outputs\SUBCAT_TCA\four_panel_overlap_SUBCAT_TCA.png
  Saved: outputs\SUBCAT_SSRI\four_panel_overlap_SUBCAT_SSRI.png
  Saved: outputs\SUBCAT_SNRI\four_panel_overlap_SUBCAT_SNRI.png
  Saved: outputs\SUBCAT_Tetracyclische_antidepressiva\four_panel_overlap_SUBCAT_Tetracyclische_antidepressiva.png
  Saved: outputs\SUBCAT_Antidepressiva_overige\four_panel_overlap_SUBCAT_Antidepressiva_overige.png
  Saved: outputs\SUBCAT_Systemische_antihistaminica\four_panel_overlap_SUBCAT_Systemische_antihistaminica.png
  Saved: outputs\SUBCAT_anxiolytica_Benzodiazepine\four_panel_overlap_SUBCAT_anxiolytica_Benzodiazepine.png
  Saved: outputs\SUBCAT_hypnotica_Benzodiazepine\four_panel_overlap_SUBCAT_hypnotica_Benzodiazepine.png
  Saved: outputs\SUBCAT_Amfetaminen\four_panel_overlap_SUBCAT_Amfetaminen.png
  Saved: outputs\SUBCAT_Paracetamol_mono\four_panel_overlap_SUBCAT_Paracetamol_mono.png
  Saved: outputs\SUBCAT_Anti_epileptica_stemmingsstabilisatoren\four_panel_overlap_SUBCAT_Anti_epileptica_stemmingsstabilisatoren.png
  Saved: outputs\SUBCAT_Opioden\four_panel_overlap_SUBCAT_Opioden.png
  Saved: outputs\SUBCAT_Z_drugs\four_panel_overlap_SUBCAT_Z_drugs.png
  Saved: outputs\SUBCAT_NSAIDs\four_panel_overlap_SUBCAT_NSAIDs.png
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=c052e9d8-ca61-4770-893d-15ed4c07b221">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[64]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># ATT calculation:</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=fb6aafea-bc26-4052-979e-60c7518866f1">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[65]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Weighted:</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=378a97b3-6606-48f7-b72e-8b3612b25dfb">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[66]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">GradientBoostingRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">r2_score</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">KFold</span>
<span class="kn">from</span> <span class="nn">econml.dml</span> <span class="kn">import</span> <span class="n">LinearDML</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">t</span><span class="p">,</span> <span class="n">probplot</span>
<span class="kn">import</span> <span class="nn">xgboost</span> <span class="k">as</span> <span class="nn">xgb</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Configuration</span>
<span class="c1"># -----------------------------</span>
<span class="n">n_repeats</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">seeds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span>
<span class="n">imputations</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">output_folder</span> <span class="o">=</span> <span class="s2">"outputs"</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Diagnostic Plotting Function</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">create_diagnostic_plots</span><span class="p">(</span><span class="n">residuals_data</span><span class="p">,</span> <span class="n">fitted_data</span><span class="p">,</span> <span class="n">group_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Create 4 diagnostic plots for model validation"""</span>
    <span class="n">plots_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"plots"</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">plots_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Flatten the collected data</span>
    <span class="n">all_residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">residuals_data</span><span class="p">)</span>
    <span class="n">all_fitted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">fitted_data</span><span class="p">)</span>
    
    <span class="c1"># Create figure with 2x2 subplots</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Diagnostic Plots - </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">'bold'</span><span class="p">)</span>
    
    <span class="c1"># 1. Residuals vs Fitted</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">all_fitted</span><span class="p">,</span> <span class="n">all_residuals</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Fitted Values'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Residuals'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Residuals vs Fitted'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># 2. QQ Plot</span>
    <span class="n">probplot</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s2">"norm"</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Q-Q Plot (Normal)'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># 3. Residual Histogram</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'skyblue'</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">'black'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Residuals'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Density'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Residual Distribution'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># 4. Scale-Location Plot</span>
    <span class="n">sqrt_abs_residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">))</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">all_fitted</span><span class="p">,</span> <span class="n">sqrt_abs_residuals</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Fitted Values'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'|Residuals|'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Scale-Location Plot'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    
    <span class="c1"># Save plot</span>
    <span class="n">plot_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plots_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s1">.png'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_filename</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">'tight'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Diagnostic plots saved for </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Rubin's Rule</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">rubins_pool</span><span class="p">(</span><span class="n">estimates</span><span class="p">,</span> <span class="n">ses</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">estimates</span><span class="p">)</span>
    <span class="n">q_bar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">estimates</span><span class="p">)</span>
    <span class="n">u_bar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">ses</span><span class="p">))</span>
    <span class="n">b_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">estimates</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">total_var</span> <span class="o">=</span> <span class="n">u_bar</span> <span class="o">+</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">b_m</span><span class="p">)</span>
    <span class="n">total_se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">total_var</span><span class="p">)</span>
    <span class="n">ci_lower</span> <span class="o">=</span> <span class="n">q_bar</span> <span class="o">-</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">total_se</span>
    <span class="n">ci_upper</span> <span class="o">=</span> <span class="n">q_bar</span> <span class="o">+</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">total_se</span>
    <span class="n">p_value</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">q_bar</span> <span class="o">/</span> <span class="n">total_se</span><span class="p">),</span> <span class="n">df</span><span class="o">=</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">rounded_p</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">p_value</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">formatted_p</span> <span class="o">=</span> <span class="s2">"&lt; 0.00001"</span> <span class="k">if</span> <span class="n">rounded_p</span> <span class="o">&lt;=</span> <span class="mf">0.00001</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">rounded_p</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">return</span> <span class="n">q_bar</span><span class="p">,</span> <span class="n">total_se</span><span class="p">,</span> <span class="n">ci_lower</span><span class="p">,</span> <span class="n">ci_upper</span><span class="p">,</span> <span class="n">formatted_p</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># SMD + Variance Ratio</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">calculate_smd_vr</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
    <span class="n">treated</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">control</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">w_treated</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">w_control</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">smd</span><span class="p">,</span> <span class="n">vr</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m1</span><span class="p">,</span> <span class="n">m0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">treated</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">w_treated</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">control</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">w_control</span><span class="p">)</span>
            <span class="n">s1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">((</span><span class="n">treated</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">-</span> <span class="n">m1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w_treated</span><span class="p">))</span>
            <span class="n">s0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">((</span><span class="n">control</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">-</span> <span class="n">m0</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w_control</span><span class="p">))</span>
            <span class="n">pooled_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">s1</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">s0</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">smd</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">m1</span> <span class="o">-</span> <span class="n">m0</span><span class="p">)</span> <span class="o">/</span> <span class="n">pooled_sd</span> <span class="k">if</span> <span class="n">pooled_sd</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">vr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s1</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">s0</span><span class="o">**</span><span class="mi">2</span> <span class="k">if</span> <span class="n">s0</span><span class="o">**</span><span class="mi">2</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">smd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">vr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">smd</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">vr</span><span class="p">)</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># DML Main Loop</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">run_dml_with_trimmed_data</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="p">):</span>
    <span class="n">att_results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">balance_results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">covariates</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Running DML for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">group_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">group_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">best_result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">best_se</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">"inf"</span><span class="p">)</span>
        
        <span class="c1"># Initialize lists to collect residuals and fitted values for diagnostic plots</span>
        <span class="n">group_residuals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">group_fitted</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="n">seeds</span><span class="p">:</span>
            <span class="n">att_list</span><span class="p">,</span> <span class="n">se_list</span><span class="p">,</span> <span class="n">r2_list</span><span class="p">,</span> <span class="n">rmse_list</span><span class="p">,</span> <span class="n">smd_list</span><span class="p">,</span> <span class="n">vr_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">imp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">imputations</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"trimmed_data_imp</span><span class="si">{</span><span class="n">imp</span><span class="si">}</span><span class="s2">.pkl"</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">or</span> <span class="s2">"iptw"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">T</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
                <span class="n">Y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">"caps5_change_baseline"</span><span class="p">]</span>
                <span class="n">W</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">"iptw"</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">repeat</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_repeats</span><span class="p">):</span>
                    <span class="n">kf</span> <span class="o">=</span> <span class="n">KFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span> <span class="o">+</span> <span class="n">repeat</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">train_idx</span><span class="p">,</span> <span class="n">test_idx</span> <span class="ow">in</span> <span class="n">kf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">X_train</span><span class="p">,</span> <span class="n">T_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">W_train</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span>
                                <span class="n">T</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span>
                                <span class="n">Y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span>
                                <span class="n">W</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span>
                            <span class="p">)</span>

                            <span class="n">model_y</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
                            <span class="n">model_t</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                        <span class="n">use_label_encoder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eval_metric</span><span class="o">=</span><span class="s2">"logloss"</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>

                            <span class="n">dml</span> <span class="o">=</span> <span class="n">LinearDML</span><span class="p">(</span><span class="n">model_y</span><span class="o">=</span><span class="n">model_y</span><span class="p">,</span> <span class="n">model_t</span><span class="o">=</span><span class="n">model_t</span><span class="p">,</span> <span class="n">discrete_treatment</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                            <span class="n">cv</span><span class="o">=</span><span class="n">KFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">),</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
                            <span class="n">dml</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Y_train</span><span class="p">,</span> <span class="n">T_train</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">X_train</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="n">W_train</span><span class="p">)</span>

                            <span class="n">tau</span> <span class="o">=</span> <span class="n">dml</span><span class="o">.</span><span class="n">effect</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
                            <span class="n">att</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span>
                            <span class="n">influence</span> <span class="o">=</span> <span class="n">tau</span> <span class="o">-</span> <span class="n">att</span>
                            <span class="n">se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">influence</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">tau</span><span class="p">))</span>

                            <span class="n">att_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">att</span><span class="p">)</span>
                            <span class="n">se_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">se</span><span class="p">)</span>

                            <span class="n">Y_pred</span> <span class="o">=</span> <span class="n">model_y</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="n">W_train</span><span class="p">)</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
                            <span class="n">residuals</span> <span class="o">=</span> <span class="n">Y_train</span> <span class="o">-</span> <span class="n">Y_pred</span>
                            <span class="n">rmse</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_pred</span><span class="p">,</span> <span class="n">squared</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                            <span class="n">r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_pred</span><span class="p">)</span>
                            <span class="n">r2_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
                            <span class="n">rmse_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rmse</span><span class="p">)</span>
                            
                            <span class="c1"># Collect residuals and fitted values for diagnostic plots</span>
                            <span class="n">group_residuals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">residuals</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                            <span class="n">group_fitted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Y_pred</span><span class="p">)</span>

                            <span class="n">smd</span><span class="p">,</span> <span class="n">vr</span> <span class="o">=</span> <span class="n">calculate_smd_vr</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">T_train</span><span class="p">,</span> <span class="n">W_train</span><span class="p">)</span>
                            <span class="n">smd_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smd</span><span class="p">)</span>
                            <span class="n">vr_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vr</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">, seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">, imp </span><span class="si">{</span><span class="n">imp</span><span class="si">}</span><span class="s2">, rep </span><span class="si">{</span><span class="n">repeat</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">att_list</span><span class="p">:</span>
                <span class="n">att</span><span class="p">,</span> <span class="n">se</span><span class="p">,</span> <span class="n">ci_l</span><span class="p">,</span> <span class="n">ci_u</span><span class="p">,</span> <span class="n">p_val</span> <span class="o">=</span> <span class="n">rubins_pool</span><span class="p">(</span><span class="n">att_list</span><span class="p">,</span> <span class="n">se_list</span><span class="p">)</span>
                <span class="n">avg_r2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">r2_list</span><span class="p">)</span>
                <span class="n">avg_rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rmse_list</span><span class="p">)</span>
                <span class="n">avg_smd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">smd_list</span><span class="p">)</span>
                <span class="n">avg_vr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">vr_list</span><span class="p">)</span>

                <span class="n">balance_results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">"group"</span><span class="p">:</span> <span class="n">group</span><span class="p">,</span> <span class="s2">"seed"</span><span class="p">:</span> <span class="n">seed</span><span class="p">,</span> <span class="s2">"smd"</span><span class="p">:</span> <span class="n">avg_smd</span><span class="p">,</span> <span class="s2">"vr"</span><span class="p">:</span> <span class="n">avg_vr</span>
                <span class="p">})</span>

                <span class="k">if</span> <span class="n">se</span> <span class="o">&lt;</span> <span class="n">best_se</span><span class="p">:</span>
                    <span class="n">best_se</span> <span class="o">=</span> <span class="n">se</span>
                    <span class="n">best_result</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">"group"</span><span class="p">:</span> <span class="n">group</span><span class="p">,</span> <span class="s2">"seed"</span><span class="p">:</span> <span class="n">seed</span><span class="p">,</span> <span class="s2">"att"</span><span class="p">:</span> <span class="n">att</span><span class="p">,</span> <span class="s2">"se"</span><span class="p">:</span> <span class="n">se</span><span class="p">,</span>
                        <span class="s2">"ci_lower"</span><span class="p">:</span> <span class="n">ci_l</span><span class="p">,</span> <span class="s2">"ci_upper"</span><span class="p">:</span> <span class="n">ci_u</span><span class="p">,</span> <span class="s2">"p_value"</span><span class="p">:</span> <span class="n">p_val</span><span class="p">,</span>
                        <span class="s2">"r2"</span><span class="p">:</span> <span class="n">avg_r2</span><span class="p">,</span> <span class="s2">"rmse"</span><span class="p">:</span> <span class="n">avg_rmse</span>
                    <span class="p">}</span>

                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> | Seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">: ATT = </span><span class="si">{</span><span class="n">att</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, SE = </span><span class="si">{</span><span class="n">se</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, p = </span><span class="si">{</span><span class="n">p_val</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No valid results for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> | Seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Create diagnostic plots for this group</span>
        <span class="k">if</span> <span class="n">group_residuals</span> <span class="ow">and</span> <span class="n">group_fitted</span><span class="p">:</span>
            <span class="n">create_diagnostic_plots</span><span class="p">(</span><span class="n">group_residuals</span><span class="p">,</span> <span class="n">group_fitted</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">best_result</span><span class="p">:</span>
            <span class="n">att_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">best_result</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Best result for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">  Seed </span><span class="si">{</span><span class="n">best_result</span><span class="p">[</span><span class="s1">'seed'</span><span class="p">]</span><span class="si">}</span><span class="s2"> | SE = </span><span class="si">{</span><span class="n">best_result</span><span class="p">[</span><span class="s1">'se'</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="c1"># Save final output</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">att_results</span><span class="p">)</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">"dml_rubin_summary_subcats.xlsx"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">balance_results</span><span class="p">)</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">"smd_vr_summary_subcats.xlsx"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> All summary files saved."</span><span class="p">)</span>

<span class="n">run_dml_with_trimmed_data</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Running DML for SUBCAT_Antipsychotica_atypisch
 SUBCAT_Antipsychotica_atypisch | Seed 1: ATT = -5.1498, SE = 28.2389, p = 0.85567
 SUBCAT_Antipsychotica_atypisch | Seed 2: ATT = -6.5718, SE = 21.0024, p = 0.75501
 SUBCAT_Antipsychotica_atypisch | Seed 3: ATT = -1.6032, SE = 20.7904, p = 0.93869
 Error in SUBCAT_Antipsychotica_atypisch, seed 4, imp 4, rep 1: Provided crossfit folds contain training splits that don't contain all treatments
 SUBCAT_Antipsychotica_atypisch | Seed 4: ATT = -0.7934, SE = 25.9293, p = 0.97565
 SUBCAT_Antipsychotica_atypisch | Seed 5: ATT = -2.8155, SE = 25.7896, p = 0.91329
 SUBCAT_Antipsychotica_atypisch | Seed 6: ATT = -6.9556, SE = 20.4718, p = 0.73475
 SUBCAT_Antipsychotica_atypisch | Seed 7: ATT = -0.9481, SE = 21.1366, p = 0.96431
 SUBCAT_Antipsychotica_atypisch | Seed 8: ATT = -5.9887, SE = 27.0640, p = 0.82533
 SUBCAT_Antipsychotica_atypisch | Seed 9: ATT = -2.5909, SE = 23.9344, p = 0.91402
 SUBCAT_Antipsychotica_atypisch | Seed 10: ATT = -3.4696, SE = 20.8469, p = 0.86816
 Diagnostic plots saved for SUBCAT_Antipsychotica_atypisch
 Best result for SUBCAT_Antipsychotica_atypisch  Seed 6 | SE = 20.4718

 Running DML for SUBCAT_TCA
 SUBCAT_TCA | Seed 1: ATT = 4.4039, SE = 2.7725, p = 0.11538
 SUBCAT_TCA | Seed 2: ATT = 4.8658, SE = 2.6190, p = 0.06616
 SUBCAT_TCA | Seed 3: ATT = 4.1655, SE = 2.5574, p = 0.10653
 SUBCAT_TCA | Seed 4: ATT = 4.1878, SE = 2.5871, p = 0.10869
 SUBCAT_TCA | Seed 5: ATT = 4.2668, SE = 2.8392, p = 0.13607
 SUBCAT_TCA | Seed 6: ATT = 4.3825, SE = 2.6911, p = 0.10660
 SUBCAT_TCA | Seed 7: ATT = 4.3466, SE = 2.7126, p = 0.11226
 SUBCAT_TCA | Seed 8: ATT = 4.1183, SE = 2.3432, p = 0.08192
 SUBCAT_TCA | Seed 9: ATT = 4.4263, SE = 2.6785, p = 0.10160
 SUBCAT_TCA | Seed 10: ATT = 4.2316, SE = 2.5425, p = 0.09920
 Diagnostic plots saved for SUBCAT_TCA
 Best result for SUBCAT_TCA  Seed 8 | SE = 2.3432

 Running DML for SUBCAT_SSRI
 SUBCAT_SSRI | Seed 1: ATT = 0.0030, SE = 1.0014, p = 0.99765
 SUBCAT_SSRI | Seed 2: ATT = -0.0533, SE = 0.9291, p = 0.95440
 SUBCAT_SSRI | Seed 3: ATT = -0.0333, SE = 0.9759, p = 0.97281
 SUBCAT_SSRI | Seed 4: ATT = 0.0837, SE = 1.0668, p = 0.93759
 SUBCAT_SSRI | Seed 5: ATT = 0.0451, SE = 1.0118, p = 0.96451
 SUBCAT_SSRI | Seed 6: ATT = 0.0113, SE = 1.0794, p = 0.99167
 SUBCAT_SSRI | Seed 7: ATT = 0.0766, SE = 0.9642, p = 0.93685
 SUBCAT_SSRI | Seed 8: ATT = -0.0804, SE = 1.1219, p = 0.94299
 SUBCAT_SSRI | Seed 9: ATT = 0.0299, SE = 0.9919, p = 0.97604
 SUBCAT_SSRI | Seed 10: ATT = 0.0244, SE = 0.9764, p = 0.98013
 Diagnostic plots saved for SUBCAT_SSRI
 Best result for SUBCAT_SSRI  Seed 2 | SE = 0.9291

 Running DML for SUBCAT_SNRI
 SUBCAT_SNRI | Seed 1: ATT = 2.1416, SE = 2.4346, p = 0.38118
 SUBCAT_SNRI | Seed 2: ATT = 2.2063, SE = 2.5624, p = 0.39130
 SUBCAT_SNRI | Seed 3: ATT = 2.3383, SE = 2.5045, p = 0.35275
 SUBCAT_SNRI | Seed 4: ATT = 2.2573, SE = 2.4624, p = 0.36153
 SUBCAT_SNRI | Seed 5: ATT = 2.4274, SE = 2.2762, p = 0.28883
 SUBCAT_SNRI | Seed 6: ATT = 2.1571, SE = 2.3235, p = 0.35547
 SUBCAT_SNRI | Seed 7: ATT = 2.4042, SE = 2.3494, p = 0.30864
 SUBCAT_SNRI | Seed 8: ATT = 2.2728, SE = 2.4103, p = 0.34801
 SUBCAT_SNRI | Seed 9: ATT = 2.2198, SE = 2.3373, p = 0.34455
 SUBCAT_SNRI | Seed 10: ATT = 2.0483, SE = 2.5894, p = 0.43083
 Diagnostic plots saved for SUBCAT_SNRI
 Best result for SUBCAT_SNRI  Seed 5 | SE = 2.2762

 Running DML for SUBCAT_Tetracyclische_antidepressiva
 SUBCAT_Tetracyclische_antidepressiva | Seed 1: ATT = 8.0458, SE = 2.5311, p = 0.00197
 SUBCAT_Tetracyclische_antidepressiva | Seed 2: ATT = 7.6498, SE = 2.6390, p = 0.00461
 SUBCAT_Tetracyclische_antidepressiva | Seed 3: ATT = 7.5835, SE = 2.6577, p = 0.00527
 SUBCAT_Tetracyclische_antidepressiva | Seed 4: ATT = 7.5832, SE = 2.5444, p = 0.00362
 SUBCAT_Tetracyclische_antidepressiva | Seed 5: ATT = 7.7894, SE = 2.3083, p = 0.00106
 SUBCAT_Tetracyclische_antidepressiva | Seed 6: ATT = 7.7070, SE = 2.5864, p = 0.00363
 SUBCAT_Tetracyclische_antidepressiva | Seed 7: ATT = 7.8261, SE = 2.3351, p = 0.00114
 SUBCAT_Tetracyclische_antidepressiva | Seed 8: ATT = 7.8230, SE = 2.3800, p = 0.00140
 SUBCAT_Tetracyclische_antidepressiva | Seed 9: ATT = 7.9141, SE = 2.1888, p = 0.00047
 SUBCAT_Tetracyclische_antidepressiva | Seed 10: ATT = 7.7042, SE = 2.5539, p = 0.00325
 Diagnostic plots saved for SUBCAT_Tetracyclische_antidepressiva
 Best result for SUBCAT_Tetracyclische_antidepressiva  Seed 9 | SE = 2.1888

 Running DML for SUBCAT_Antidepressiva_overige
 SUBCAT_Antidepressiva_overige | Seed 1: ATT = 4.1073, SE = 3.3445, p = 0.22233
 SUBCAT_Antidepressiva_overige | Seed 2: ATT = 3.7512, SE = 3.9298, p = 0.34212
 SUBCAT_Antidepressiva_overige | Seed 3: ATT = 3.4551, SE = 3.7447, p = 0.35843
 SUBCAT_Antidepressiva_overige | Seed 4: ATT = 3.4559, SE = 4.0780, p = 0.39880
 SUBCAT_Antidepressiva_overige | Seed 5: ATT = 3.3261, SE = 4.2700, p = 0.43787
 SUBCAT_Antidepressiva_overige | Seed 6: ATT = 3.6969, SE = 4.0541, p = 0.36405
 SUBCAT_Antidepressiva_overige | Seed 7: ATT = 3.2536, SE = 5.7847, p = 0.57508
 SUBCAT_Antidepressiva_overige | Seed 8: ATT = 4.0226, SE = 4.8699, p = 0.41079
 SUBCAT_Antidepressiva_overige | Seed 9: ATT = 3.8293, SE = 3.8166, p = 0.31814
 SUBCAT_Antidepressiva_overige | Seed 10: ATT = 3.5321, SE = 4.0111, p = 0.38067
 Diagnostic plots saved for SUBCAT_Antidepressiva_overige
 Best result for SUBCAT_Antidepressiva_overige  Seed 1 | SE = 3.3445

 Running DML for SUBCAT_Systemische_antihistaminica
 SUBCAT_Systemische_antihistaminica | Seed 1: ATT = -0.0232, SE = 2.9635, p = 0.99377
 SUBCAT_Systemische_antihistaminica | Seed 2: ATT = 0.1005, SE = 3.0806, p = 0.97404
 SUBCAT_Systemische_antihistaminica | Seed 3: ATT = 0.0452, SE = 2.7279, p = 0.98682
 SUBCAT_Systemische_antihistaminica | Seed 4: ATT = 0.0427, SE = 2.8307, p = 0.98799
 SUBCAT_Systemische_antihistaminica | Seed 5: ATT = 0.0576, SE = 2.5805, p = 0.98223
 SUBCAT_Systemische_antihistaminica | Seed 6: ATT = 0.1662, SE = 2.9886, p = 0.95577
 SUBCAT_Systemische_antihistaminica | Seed 7: ATT = 0.6297, SE = 3.1487, p = 0.84190
 SUBCAT_Systemische_antihistaminica | Seed 8: ATT = 0.1598, SE = 3.1290, p = 0.95937
 SUBCAT_Systemische_antihistaminica | Seed 9: ATT = 0.2930, SE = 3.0993, p = 0.92487
 SUBCAT_Systemische_antihistaminica | Seed 10: ATT = -0.1780, SE = 2.9258, p = 0.95161
 Diagnostic plots saved for SUBCAT_Systemische_antihistaminica
 Best result for SUBCAT_Systemische_antihistaminica  Seed 5 | SE = 2.5805

 Running DML for SUBCAT_anxiolytica_Benzodiazepine
 SUBCAT_anxiolytica_Benzodiazepine | Seed 1: ATT = 0.8948, SE = 1.0559, p = 0.39880
 SUBCAT_anxiolytica_Benzodiazepine | Seed 2: ATT = 0.9013, SE = 1.0266, p = 0.38208
 SUBCAT_anxiolytica_Benzodiazepine | Seed 3: ATT = 0.9068, SE = 1.1156, p = 0.41826
 SUBCAT_anxiolytica_Benzodiazepine | Seed 4: ATT = 0.9618, SE = 1.0336, p = 0.35434
 SUBCAT_anxiolytica_Benzodiazepine | Seed 5: ATT = 0.9488, SE = 1.1172, p = 0.39779
 SUBCAT_anxiolytica_Benzodiazepine | Seed 6: ATT = 1.0315, SE = 1.1161, p = 0.35765
 SUBCAT_anxiolytica_Benzodiazepine | Seed 7: ATT = 0.9052, SE = 1.0940, p = 0.40997
 SUBCAT_anxiolytica_Benzodiazepine | Seed 8: ATT = 0.9488, SE = 1.0438, p = 0.36554
 SUBCAT_anxiolytica_Benzodiazepine | Seed 9: ATT = 0.9411, SE = 1.0341, p = 0.36501
 SUBCAT_anxiolytica_Benzodiazepine | Seed 10: ATT = 0.9013, SE = 1.1488, p = 0.43462
 Diagnostic plots saved for SUBCAT_anxiolytica_Benzodiazepine
 Best result for SUBCAT_anxiolytica_Benzodiazepine  Seed 2 | SE = 1.0266

 Running DML for SUBCAT_hypnotica_Benzodiazepine
 SUBCAT_hypnotica_Benzodiazepine | Seed 1: ATT = -0.8876, SE = 2.3188, p = 0.70268
 SUBCAT_hypnotica_Benzodiazepine | Seed 2: ATT = -0.9398, SE = 2.3162, p = 0.68580
 SUBCAT_hypnotica_Benzodiazepine | Seed 3: ATT = -0.8547, SE = 2.1950, p = 0.69783
 SUBCAT_hypnotica_Benzodiazepine | Seed 4: ATT = -0.9029, SE = 2.1561, p = 0.67630
 SUBCAT_hypnotica_Benzodiazepine | Seed 5: ATT = -0.7930, SE = 2.2089, p = 0.72037
 SUBCAT_hypnotica_Benzodiazepine | Seed 6: ATT = -0.9124, SE = 2.3028, p = 0.69282
 SUBCAT_hypnotica_Benzodiazepine | Seed 7: ATT = -1.1329, SE = 2.0571, p = 0.58308
 SUBCAT_hypnotica_Benzodiazepine | Seed 8: ATT = -0.8858, SE = 2.1821, p = 0.68567
 SUBCAT_hypnotica_Benzodiazepine | Seed 9: ATT = -0.8958, SE = 2.2028, p = 0.68513
 SUBCAT_hypnotica_Benzodiazepine | Seed 10: ATT = -0.9823, SE = 2.2110, p = 0.65780
 Diagnostic plots saved for SUBCAT_hypnotica_Benzodiazepine
 Best result for SUBCAT_hypnotica_Benzodiazepine  Seed 7 | SE = 2.0571

 Running DML for SUBCAT_Amfetaminen
 SUBCAT_Amfetaminen | Seed 1: ATT = 2.8911, SE = 3.2881, p = 0.38139
 SUBCAT_Amfetaminen | Seed 2: ATT = 2.7887, SE = 2.9649, p = 0.34921
 SUBCAT_Amfetaminen | Seed 3: ATT = 3.0738, SE = 3.1603, p = 0.33310
 SUBCAT_Amfetaminen | Seed 4: ATT = 3.0650, SE = 3.0985, p = 0.32498
 SUBCAT_Amfetaminen | Seed 5: ATT = 2.8903, SE = 3.4658, p = 0.40630
 SUBCAT_Amfetaminen | Seed 6: ATT = 3.2659, SE = 3.5195, p = 0.35569
 SUBCAT_Amfetaminen | Seed 7: ATT = 2.8207, SE = 3.2111, p = 0.38185
 SUBCAT_Amfetaminen | Seed 8: ATT = 2.8113, SE = 3.3831, p = 0.40798
 SUBCAT_Amfetaminen | Seed 9: ATT = 2.9437, SE = 3.6059, p = 0.41627
 SUBCAT_Amfetaminen | Seed 10: ATT = 2.7787, SE = 3.2504, p = 0.39469
 Diagnostic plots saved for SUBCAT_Amfetaminen
 Best result for SUBCAT_Amfetaminen  Seed 2 | SE = 2.9649

 Running DML for SUBCAT_Paracetamol_mono
 SUBCAT_Paracetamol_mono | Seed 1: ATT = 2.4099, SE = 4.4288, p = 0.58757
 SUBCAT_Paracetamol_mono | Seed 2: ATT = 2.3358, SE = 5.1319, p = 0.64999
 SUBCAT_Paracetamol_mono | Seed 3: ATT = 2.6478, SE = 5.6137, p = 0.63820
 SUBCAT_Paracetamol_mono | Seed 4: ATT = 2.1962, SE = 5.1595, p = 0.67129
 SUBCAT_Paracetamol_mono | Seed 5: ATT = 2.6045, SE = 4.1405, p = 0.53078
 SUBCAT_Paracetamol_mono | Seed 6: ATT = 2.2797, SE = 4.5391, p = 0.61661
 SUBCAT_Paracetamol_mono | Seed 7: ATT = 3.6467, SE = 11.4939, p = 0.75170
 SUBCAT_Paracetamol_mono | Seed 8: ATT = 2.1486, SE = 5.7442, p = 0.70917
 SUBCAT_Paracetamol_mono | Seed 9: ATT = 2.1795, SE = 5.1523, p = 0.67320
 SUBCAT_Paracetamol_mono | Seed 10: ATT = 2.3577, SE = 5.2390, p = 0.65367
 Diagnostic plots saved for SUBCAT_Paracetamol_mono
 Best result for SUBCAT_Paracetamol_mono  Seed 5 | SE = 4.1405

 Running DML for SUBCAT_Anti_epileptica_stemmingsstabilisatoren
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 1: ATT = 5.7899, SE = 3.7992, p = 0.13071
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 2: ATT = 5.4897, SE = 3.8789, p = 0.16013
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 3: ATT = 5.5909, SE = 4.2529, p = 0.19167
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 4: ATT = 6.0850, SE = 4.2538, p = 0.15573
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 5: ATT = 5.8834, SE = 3.7916, p = 0.12392
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 6: ATT = 5.4646, SE = 4.0451, p = 0.17980
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 7: ATT = 5.2603, SE = 3.7998, p = 0.16936
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 8: ATT = 5.3987, SE = 4.0146, p = 0.18177
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 9: ATT = 5.6336, SE = 3.5890, p = 0.11968
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 10: ATT = 5.3065, SE = 3.9319, p = 0.18023
 Diagnostic plots saved for SUBCAT_Anti_epileptica_stemmingsstabilisatoren
 Best result for SUBCAT_Anti_epileptica_stemmingsstabilisatoren  Seed 9 | SE = 3.5890

 Running DML for SUBCAT_Opioden
 SUBCAT_Opioden | Seed 1: ATT = 2.8341, SE = 3.6689, p = 0.44168
 SUBCAT_Opioden | Seed 2: ATT = 2.8541, SE = 4.8000, p = 0.55347
 SUBCAT_Opioden | Seed 3: ATT = 2.6857, SE = 3.2678, p = 0.41313
 SUBCAT_Opioden | Seed 4: ATT = 2.9107, SE = 3.3508, p = 0.38714
 SUBCAT_Opioden | Seed 5: ATT = 2.7305, SE = 3.6078, p = 0.45096
 SUBCAT_Opioden | Seed 6: ATT = 2.8173, SE = 3.3080, p = 0.39645
 SUBCAT_Opioden | Seed 7: ATT = 2.4828, SE = 3.3214, p = 0.45653
 SUBCAT_Opioden | Seed 8: ATT = 2.7032, SE = 3.5791, p = 0.45188
 SUBCAT_Opioden | Seed 9: ATT = 2.6240, SE = 3.2418, p = 0.42021
 SUBCAT_Opioden | Seed 10: ATT = 2.6295, SE = 3.3356, p = 0.43239
 Diagnostic plots saved for SUBCAT_Opioden
 Best result for SUBCAT_Opioden  Seed 9 | SE = 3.2418

 Running DML for SUBCAT_Z_drugs
 SUBCAT_Z_drugs | Seed 1: ATT = 6.9286, SE = 3.1513, p = 0.03023
 SUBCAT_Z_drugs | Seed 2: ATT = 7.2073, SE = 3.4349, p = 0.03843
 SUBCAT_Z_drugs | Seed 3: ATT = 7.0873, SE = 3.3264, p = 0.03560
 SUBCAT_Z_drugs | Seed 4: ATT = 6.9114, SE = 3.3611, p = 0.04238
 SUBCAT_Z_drugs | Seed 5: ATT = 7.3823, SE = 3.0447, p = 0.01714
 SUBCAT_Z_drugs | Seed 6: ATT = 6.9468, SE = 3.0047, p = 0.02285
 SUBCAT_Z_drugs | Seed 7: ATT = 6.9232, SE = 3.3494, p = 0.04135
 SUBCAT_Z_drugs | Seed 8: ATT = 6.7629, SE = 3.2375, p = 0.03928
 SUBCAT_Z_drugs | Seed 9: ATT = 7.0054, SE = 2.8950, p = 0.01735
 SUBCAT_Z_drugs | Seed 10: ATT = 6.7507, SE = 3.0462, p = 0.02897
 Diagnostic plots saved for SUBCAT_Z_drugs
 Best result for SUBCAT_Z_drugs  Seed 9 | SE = 2.8950

 Running DML for SUBCAT_NSAIDs
 SUBCAT_NSAIDs | Seed 1: ATT = -0.2015, SE = 4.0578, p = 0.96050
 SUBCAT_NSAIDs | Seed 2: ATT = 0.2090, SE = 4.7751, p = 0.96518
 SUBCAT_NSAIDs | Seed 3: ATT = -0.1254, SE = 4.9956, p = 0.98002
 SUBCAT_NSAIDs | Seed 4: ATT = -0.1347, SE = 4.1402, p = 0.97412
 SUBCAT_NSAIDs | Seed 5: ATT = 0.1150, SE = 4.0893, p = 0.97763
 SUBCAT_NSAIDs | Seed 6: ATT = 0.1477, SE = 4.6692, p = 0.97483
 SUBCAT_NSAIDs | Seed 7: ATT = 0.4890, SE = 4.6321, p = 0.91613
 SUBCAT_NSAIDs | Seed 8: ATT = -0.4631, SE = 4.5971, p = 0.91997
 SUBCAT_NSAIDs | Seed 9: ATT = 0.2550, SE = 4.7780, p = 0.95754
 SUBCAT_NSAIDs | Seed 10: ATT = 0.1100, SE = 4.2210, p = 0.97927
 Diagnostic plots saved for SUBCAT_NSAIDs
 Best result for SUBCAT_NSAIDs  Seed 1 | SE = 4.0578

 All summary files saved.
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=5c415b70-f8a1-4cb5-ae0a-de4ff06d2ed2">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[67]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Unweighted:</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=994ef029-9b41-45cd-a72f-d2fca16504ad">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[68]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">GradientBoostingRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">r2_score</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">KFold</span>
<span class="kn">from</span> <span class="nn">econml.dml</span> <span class="kn">import</span> <span class="n">LinearDML</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">t</span><span class="p">,</span> <span class="n">probplot</span>
<span class="kn">import</span> <span class="nn">xgboost</span> <span class="k">as</span> <span class="nn">xgb</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Configuration</span>
<span class="c1"># -----------------------------</span>
<span class="n">n_repeats</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">seeds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span>
<span class="n">imputations</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">output_folder</span> <span class="o">=</span> <span class="s2">"outputs"</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Plotting Functions</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">create_diagnostic_plots</span><span class="p">(</span><span class="n">residuals_data</span><span class="p">,</span> <span class="n">group_name</span><span class="p">,</span> <span class="n">output_folder</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Create diagnostic plots for each group"""</span>
    <span class="n">plots_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"plots"</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">plots_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="n">all_residuals</span> <span class="o">=</span> <span class="n">residuals_data</span><span class="p">[</span><span class="s1">'residuals'</span><span class="p">]</span>
    <span class="n">all_fitted</span> <span class="o">=</span> <span class="n">residuals_data</span><span class="p">[</span><span class="s1">'fitted'</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>
    
    <span class="c1"># Create figure with subplots</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Diagnostic Plots - </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">'bold'</span><span class="p">)</span>
    
    <span class="c1"># 1. Residuals vs Fitted</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">all_fitted</span><span class="p">,</span> <span class="n">all_residuals</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Fitted Values'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Residuals'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Residuals vs Fitted'</span><span class="p">)</span>
    
    <span class="c1"># 2. QQ Plot</span>
    <span class="n">probplot</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s2">"norm"</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'QQ Plot (Normal)'</span><span class="p">)</span>
    
    <span class="c1"># 3. Histogram of Residuals</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">'black'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Residuals'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Frequency'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Residual Distribution'</span><span class="p">)</span>
    
    <span class="c1"># 4. Scale-Location Plot</span>
    <span class="n">sqrt_abs_resid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">))</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">all_fitted</span><span class="p">,</span> <span class="n">sqrt_abs_resid</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Fitted Values'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'|Residuals|'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Scale-Location Plot'</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plots_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s1">_unweighted.png'</span><span class="p">),</span> 
                <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">'tight'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Rubin's Rule</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">rubins_pool</span><span class="p">(</span><span class="n">estimates</span><span class="p">,</span> <span class="n">ses</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">estimates</span><span class="p">)</span>
    <span class="n">q_bar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">estimates</span><span class="p">)</span>
    <span class="n">u_bar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">ses</span><span class="p">))</span>
    <span class="n">b_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">estimates</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">total_var</span> <span class="o">=</span> <span class="n">u_bar</span> <span class="o">+</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">b_m</span><span class="p">)</span>
    <span class="n">total_se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">total_var</span><span class="p">)</span>
    <span class="n">ci_lower</span> <span class="o">=</span> <span class="n">q_bar</span> <span class="o">-</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">total_se</span>
    <span class="n">ci_upper</span> <span class="o">=</span> <span class="n">q_bar</span> <span class="o">+</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">total_se</span>
    <span class="n">p_value</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">q_bar</span> <span class="o">/</span> <span class="n">total_se</span><span class="p">),</span> <span class="n">df</span><span class="o">=</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">rounded_p</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">p_value</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">formatted_p</span> <span class="o">=</span> <span class="s2">"&lt; 0.00001"</span> <span class="k">if</span> <span class="n">rounded_p</span> <span class="o">&lt;=</span> <span class="mf">0.00001</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">rounded_p</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">return</span> <span class="n">q_bar</span><span class="p">,</span> <span class="n">total_se</span><span class="p">,</span> <span class="n">ci_lower</span><span class="p">,</span> <span class="n">ci_upper</span><span class="p">,</span> <span class="n">formatted_p</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># SMD + Variance Ratio</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">calculate_smd_vr</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
    <span class="n">treated</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">control</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">smd</span><span class="p">,</span> <span class="n">vr</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m1</span><span class="p">,</span> <span class="n">m0</span> <span class="o">=</span> <span class="n">treated</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">control</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">s1</span><span class="p">,</span> <span class="n">s0</span> <span class="o">=</span> <span class="n">treated</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span> <span class="n">control</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
            <span class="n">pooled_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">s1</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">s0</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">smd</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">m1</span> <span class="o">-</span> <span class="n">m0</span><span class="p">)</span> <span class="o">/</span> <span class="n">pooled_sd</span> <span class="k">if</span> <span class="n">pooled_sd</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">vr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s1</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">s0</span><span class="o">**</span><span class="mi">2</span> <span class="k">if</span> <span class="n">s0</span><span class="o">**</span><span class="mi">2</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">smd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">vr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">smd</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">vr</span><span class="p">)</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># DML Main Loop</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">run_dml_with_trimmed_data</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="p">):</span>
    <span class="n">att_results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">balance_results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">covariates</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Running DML for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">group_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">group_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">best_result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">best_se</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">"inf"</span><span class="p">)</span>
        
        <span class="c1"># Initialize residuals collection for this group</span>
        <span class="n">group_residuals_data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'residuals'</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">'fitted'</span><span class="p">:</span> <span class="p">[]}</span>

        <span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="n">seeds</span><span class="p">:</span>
            <span class="n">att_list</span><span class="p">,</span> <span class="n">se_list</span><span class="p">,</span> <span class="n">r2_list</span><span class="p">,</span> <span class="n">rmse_list</span><span class="p">,</span> <span class="n">smd_list</span><span class="p">,</span> <span class="n">vr_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">imp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">imputations</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"trimmed_data_imp</span><span class="si">{</span><span class="n">imp</span><span class="si">}</span><span class="s2">.pkl"</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">T</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
                <span class="n">Y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">"caps5_change_baseline"</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">repeat</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_repeats</span><span class="p">):</span>
                    <span class="n">kf</span> <span class="o">=</span> <span class="n">KFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span> <span class="o">+</span> <span class="n">repeat</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">train_idx</span><span class="p">,</span> <span class="n">test_idx</span> <span class="ow">in</span> <span class="n">kf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">X_train</span><span class="p">,</span> <span class="n">T_train</span><span class="p">,</span> <span class="n">Y_train</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span>
                                <span class="n">T</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span>
                                <span class="n">Y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span>
                            <span class="p">)</span>

                            <span class="n">model_y</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
                            <span class="n">model_t</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                        <span class="n">use_label_encoder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eval_metric</span><span class="o">=</span><span class="s2">"logloss"</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>

                            <span class="n">dml</span> <span class="o">=</span> <span class="n">LinearDML</span><span class="p">(</span><span class="n">model_y</span><span class="o">=</span><span class="n">model_y</span><span class="p">,</span> <span class="n">model_t</span><span class="o">=</span><span class="n">model_t</span><span class="p">,</span> <span class="n">discrete_treatment</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                            <span class="n">cv</span><span class="o">=</span><span class="n">KFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">),</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
                            <span class="n">dml</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Y_train</span><span class="p">,</span> <span class="n">T_train</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">X_train</span><span class="p">)</span>

                            <span class="n">tau</span> <span class="o">=</span> <span class="n">dml</span><span class="o">.</span><span class="n">effect</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
                            <span class="n">att</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span>
                            <span class="n">influence</span> <span class="o">=</span> <span class="n">tau</span> <span class="o">-</span> <span class="n">att</span>
                            <span class="n">se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">influence</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">tau</span><span class="p">))</span>

                            <span class="n">att_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">att</span><span class="p">)</span>
                            <span class="n">se_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">se</span><span class="p">)</span>

                            <span class="n">Y_pred</span> <span class="o">=</span> <span class="n">model_y</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">)</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
                            <span class="n">residuals</span> <span class="o">=</span> <span class="n">Y_train</span> <span class="o">-</span> <span class="n">Y_pred</span>
                            
                            <span class="c1"># Collect residuals and fitted values for plotting</span>
                            <span class="n">group_residuals_data</span><span class="p">[</span><span class="s1">'residuals'</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">residuals</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                            <span class="n">group_residuals_data</span><span class="p">[</span><span class="s1">'fitted'</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">Y_pred</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                            
                            <span class="n">rmse</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_pred</span><span class="p">,</span> <span class="n">squared</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                            <span class="n">r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_pred</span><span class="p">)</span>
                            <span class="n">r2_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
                            <span class="n">rmse_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rmse</span><span class="p">)</span>

                            <span class="n">smd</span><span class="p">,</span> <span class="n">vr</span> <span class="o">=</span> <span class="n">calculate_smd_vr</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">T_train</span><span class="p">)</span>
                            <span class="n">smd_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smd</span><span class="p">)</span>
                            <span class="n">vr_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vr</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">, seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">, imp </span><span class="si">{</span><span class="n">imp</span><span class="si">}</span><span class="s2">, rep </span><span class="si">{</span><span class="n">repeat</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">att_list</span><span class="p">:</span>
                <span class="n">att</span><span class="p">,</span> <span class="n">se</span><span class="p">,</span> <span class="n">ci_l</span><span class="p">,</span> <span class="n">ci_u</span><span class="p">,</span> <span class="n">p_val</span> <span class="o">=</span> <span class="n">rubins_pool</span><span class="p">(</span><span class="n">att_list</span><span class="p">,</span> <span class="n">se_list</span><span class="p">)</span>
                <span class="n">avg_r2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">r2_list</span><span class="p">)</span>
                <span class="n">avg_rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rmse_list</span><span class="p">)</span>
                <span class="n">avg_smd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">smd_list</span><span class="p">)</span>
                <span class="n">avg_vr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">vr_list</span><span class="p">)</span>

                <span class="n">balance_results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">"group"</span><span class="p">:</span> <span class="n">group</span><span class="p">,</span> <span class="s2">"seed"</span><span class="p">:</span> <span class="n">seed</span><span class="p">,</span> <span class="s2">"smd"</span><span class="p">:</span> <span class="n">avg_smd</span><span class="p">,</span> <span class="s2">"vr"</span><span class="p">:</span> <span class="n">avg_vr</span>
                <span class="p">})</span>

                <span class="k">if</span> <span class="n">se</span> <span class="o">&lt;</span> <span class="n">best_se</span><span class="p">:</span>
                    <span class="n">best_se</span> <span class="o">=</span> <span class="n">se</span>
                    <span class="n">best_result</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">"group"</span><span class="p">:</span> <span class="n">group</span><span class="p">,</span> <span class="s2">"seed"</span><span class="p">:</span> <span class="n">seed</span><span class="p">,</span> <span class="s2">"att"</span><span class="p">:</span> <span class="n">att</span><span class="p">,</span> <span class="s2">"se"</span><span class="p">:</span> <span class="n">se</span><span class="p">,</span>
                        <span class="s2">"ci_lower"</span><span class="p">:</span> <span class="n">ci_l</span><span class="p">,</span> <span class="s2">"ci_upper"</span><span class="p">:</span> <span class="n">ci_u</span><span class="p">,</span> <span class="s2">"p_value"</span><span class="p">:</span> <span class="n">p_val</span><span class="p">,</span>
                        <span class="s2">"r2"</span><span class="p">:</span> <span class="n">avg_r2</span><span class="p">,</span> <span class="s2">"rmse"</span><span class="p">:</span> <span class="n">avg_rmse</span>
                    <span class="p">}</span>

                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> | Seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">: ATT = </span><span class="si">{</span><span class="n">att</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, SE = </span><span class="si">{</span><span class="n">se</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, p = </span><span class="si">{</span><span class="n">p_val</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No valid results for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> | Seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">best_result</span><span class="p">:</span>
            <span class="n">att_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">best_result</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Best result for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">  Seed </span><span class="si">{</span><span class="n">best_result</span><span class="p">[</span><span class="s1">'seed'</span><span class="p">]</span><span class="si">}</span><span class="s2"> | SE = </span><span class="si">{</span><span class="n">best_result</span><span class="p">[</span><span class="s1">'se'</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        
        <span class="c1"># Create diagnostic plots for this group</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Creating diagnostic plots for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">..."</span><span class="p">)</span>
        <span class="n">create_diagnostic_plots</span><span class="p">(</span><span class="n">group_residuals_data</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">output_folder</span><span class="p">)</span>

    <span class="c1"># Save final output</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">att_results</span><span class="p">)</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">"dml_rubin_summary_subcats_unweighted.xlsx"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">balance_results</span><span class="p">)</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">"smd_vr_summary_subcats_unweighted.xlsx"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> All summary files saved."</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">" All diagnostic plots saved in outputs/plots/ folder."</span><span class="p">)</span>

<span class="n">run_dml_with_trimmed_data</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Running DML for SUBCAT_Antipsychotica_atypisch
 SUBCAT_Antipsychotica_atypisch | Seed 1: ATT = -4.2073, SE = 23.1669, p = 0.85626
 SUBCAT_Antipsychotica_atypisch | Seed 2: ATT = -6.0681, SE = 19.0543, p = 0.75081
 SUBCAT_Antipsychotica_atypisch | Seed 3: ATT = -2.4963, SE = 17.3770, p = 0.88607
 Error in SUBCAT_Antipsychotica_atypisch, seed 4, imp 4, rep 1: Provided crossfit folds contain training splits that don't contain all treatments
 SUBCAT_Antipsychotica_atypisch | Seed 4: ATT = -1.7639, SE = 20.1717, p = 0.93050
 SUBCAT_Antipsychotica_atypisch | Seed 5: ATT = -4.5334, SE = 20.9473, p = 0.82911
 SUBCAT_Antipsychotica_atypisch | Seed 6: ATT = -6.2645, SE = 16.2650, p = 0.70095
 SUBCAT_Antipsychotica_atypisch | Seed 7: ATT = -1.9969, SE = 17.6485, p = 0.91014
 SUBCAT_Antipsychotica_atypisch | Seed 8: ATT = -7.3821, SE = 19.3397, p = 0.70350
 SUBCAT_Antipsychotica_atypisch | Seed 9: ATT = -3.8757, SE = 19.1949, p = 0.84040
 SUBCAT_Antipsychotica_atypisch | Seed 10: ATT = -4.1216, SE = 18.3820, p = 0.82305
 Best result for SUBCAT_Antipsychotica_atypisch  Seed 6 | SE = 16.2650
 Creating diagnostic plots for SUBCAT_Antipsychotica_atypisch...

 Running DML for SUBCAT_TCA
 SUBCAT_TCA | Seed 1: ATT = 2.7047, SE = 2.5395, p = 0.28943
 SUBCAT_TCA | Seed 2: ATT = 2.9537, SE = 2.3451, p = 0.21080
 SUBCAT_TCA | Seed 3: ATT = 2.4007, SE = 2.3497, p = 0.30942
 SUBCAT_TCA | Seed 4: ATT = 2.3664, SE = 2.3632, p = 0.31909
 SUBCAT_TCA | Seed 5: ATT = 2.5222, SE = 2.4027, p = 0.29639
 SUBCAT_TCA | Seed 6: ATT = 2.5271, SE = 2.4219, p = 0.29929
 SUBCAT_TCA | Seed 7: ATT = 2.5017, SE = 2.3376, p = 0.28713
 SUBCAT_TCA | Seed 8: ATT = 2.2469, SE = 2.1195, p = 0.29169
 SUBCAT_TCA | Seed 9: ATT = 2.5309, SE = 2.4198, p = 0.29816
 SUBCAT_TCA | Seed 10: ATT = 2.3350, SE = 2.1161, p = 0.27249
 Best result for SUBCAT_TCA  Seed 10 | SE = 2.1161
 Creating diagnostic plots for SUBCAT_TCA...

 Running DML for SUBCAT_SSRI
 SUBCAT_SSRI | Seed 1: ATT = 0.4663, SE = 0.7324, p = 0.52580
 SUBCAT_SSRI | Seed 2: ATT = 0.4406, SE = 0.6629, p = 0.50784
 SUBCAT_SSRI | Seed 3: ATT = 0.4062, SE = 0.7249, p = 0.57646
 SUBCAT_SSRI | Seed 4: ATT = 0.4484, SE = 0.7302, p = 0.54057
 SUBCAT_SSRI | Seed 5: ATT = 0.4327, SE = 0.6975, p = 0.53650
 SUBCAT_SSRI | Seed 6: ATT = 0.3763, SE = 0.7570, p = 0.62026
 SUBCAT_SSRI | Seed 7: ATT = 0.4404, SE = 0.6393, p = 0.49250
 SUBCAT_SSRI | Seed 8: ATT = 0.4082, SE = 0.7819, p = 0.60275
 SUBCAT_SSRI | Seed 9: ATT = 0.4588, SE = 0.7368, p = 0.53487
 SUBCAT_SSRI | Seed 10: ATT = 0.4340, SE = 0.7230, p = 0.54966
 Best result for SUBCAT_SSRI  Seed 7 | SE = 0.6393
 Creating diagnostic plots for SUBCAT_SSRI...

 Running DML for SUBCAT_SNRI
 SUBCAT_SNRI | Seed 1: ATT = 3.0762, SE = 2.3170, p = 0.18733
 SUBCAT_SNRI | Seed 2: ATT = 3.0659, SE = 2.4245, p = 0.20901
 SUBCAT_SNRI | Seed 3: ATT = 3.1785, SE = 2.2706, p = 0.16468
 SUBCAT_SNRI | Seed 4: ATT = 3.0993, SE = 2.1922, p = 0.16056
 SUBCAT_SNRI | Seed 5: ATT = 3.2149, SE = 2.2560, p = 0.15730
 SUBCAT_SNRI | Seed 6: ATT = 3.0076, SE = 2.1294, p = 0.16095
 SUBCAT_SNRI | Seed 7: ATT = 3.2099, SE = 2.3231, p = 0.17017
 SUBCAT_SNRI | Seed 8: ATT = 2.9730, SE = 2.2497, p = 0.18937
 SUBCAT_SNRI | Seed 9: ATT = 2.9305, SE = 2.3061, p = 0.20680
 SUBCAT_SNRI | Seed 10: ATT = 2.9722, SE = 2.4277, p = 0.22375
 Best result for SUBCAT_SNRI  Seed 6 | SE = 2.1294
 Creating diagnostic plots for SUBCAT_SNRI...

 Running DML for SUBCAT_Tetracyclische_antidepressiva
 SUBCAT_Tetracyclische_antidepressiva | Seed 1: ATT = 7.1850, SE = 2.3099, p = 0.00244
 SUBCAT_Tetracyclische_antidepressiva | Seed 2: ATT = 7.0037, SE = 2.1859, p = 0.00182
 SUBCAT_Tetracyclische_antidepressiva | Seed 3: ATT = 6.8369, SE = 2.3242, p = 0.00407
 SUBCAT_Tetracyclische_antidepressiva | Seed 4: ATT = 6.9288, SE = 2.3668, p = 0.00424
 SUBCAT_Tetracyclische_antidepressiva | Seed 5: ATT = 7.1314, SE = 2.1009, p = 0.00099
 SUBCAT_Tetracyclische_antidepressiva | Seed 6: ATT = 6.8981, SE = 2.0555, p = 0.00112
 SUBCAT_Tetracyclische_antidepressiva | Seed 7: ATT = 7.0828, SE = 2.0735, p = 0.00092
 SUBCAT_Tetracyclische_antidepressiva | Seed 8: ATT = 7.1483, SE = 1.9948, p = 0.00053
 SUBCAT_Tetracyclische_antidepressiva | Seed 9: ATT = 7.1713, SE = 1.9691, p = 0.00043
 SUBCAT_Tetracyclische_antidepressiva | Seed 10: ATT = 7.1036, SE = 2.1248, p = 0.00117
 Best result for SUBCAT_Tetracyclische_antidepressiva  Seed 9 | SE = 1.9691
 Creating diagnostic plots for SUBCAT_Tetracyclische_antidepressiva...

 Running DML for SUBCAT_Antidepressiva_overige
 SUBCAT_Antidepressiva_overige | Seed 1: ATT = 4.9132, SE = 3.2476, p = 0.13350
 SUBCAT_Antidepressiva_overige | Seed 2: ATT = 4.6955, SE = 3.6977, p = 0.20713
 SUBCAT_Antidepressiva_overige | Seed 3: ATT = 4.1713, SE = 3.5547, p = 0.24342
 SUBCAT_Antidepressiva_overige | Seed 4: ATT = 4.2369, SE = 3.6429, p = 0.24760
 SUBCAT_Antidepressiva_overige | Seed 5: ATT = 4.0172, SE = 4.2073, p = 0.34199
 SUBCAT_Antidepressiva_overige | Seed 6: ATT = 4.5054, SE = 3.8947, p = 0.25014
 SUBCAT_Antidepressiva_overige | Seed 7: ATT = 4.1744, SE = 5.0853, p = 0.41368
 SUBCAT_Antidepressiva_overige | Seed 8: ATT = 4.7389, SE = 3.9618, p = 0.23450
 SUBCAT_Antidepressiva_overige | Seed 9: ATT = 4.4605, SE = 3.7106, p = 0.23220
 SUBCAT_Antidepressiva_overige | Seed 10: ATT = 4.2180, SE = 3.8644, p = 0.27771
 Best result for SUBCAT_Antidepressiva_overige  Seed 1 | SE = 3.2476
 Creating diagnostic plots for SUBCAT_Antidepressiva_overige...

 Running DML for SUBCAT_Systemische_antihistaminica
 SUBCAT_Systemische_antihistaminica | Seed 1: ATT = 1.0330, SE = 2.8672, p = 0.71941
 SUBCAT_Systemische_antihistaminica | Seed 2: ATT = 0.9728, SE = 2.8286, p = 0.73164
 SUBCAT_Systemische_antihistaminica | Seed 3: ATT = 1.1198, SE = 2.5248, p = 0.65835
 SUBCAT_Systemische_antihistaminica | Seed 4: ATT = 0.9746, SE = 2.7869, p = 0.72730
 SUBCAT_Systemische_antihistaminica | Seed 5: ATT = 1.1207, SE = 2.6826, p = 0.67701
 SUBCAT_Systemische_antihistaminica | Seed 6: ATT = 1.2523, SE = 3.0329, p = 0.68058
 SUBCAT_Systemische_antihistaminica | Seed 7: ATT = 1.4646, SE = 2.9982, p = 0.62628
 SUBCAT_Systemische_antihistaminica | Seed 8: ATT = 1.1253, SE = 2.8903, p = 0.69786
 SUBCAT_Systemische_antihistaminica | Seed 9: ATT = 1.2658, SE = 2.8633, p = 0.65940
 SUBCAT_Systemische_antihistaminica | Seed 10: ATT = 0.9449, SE = 2.8365, p = 0.73975
 Best result for SUBCAT_Systemische_antihistaminica  Seed 3 | SE = 2.5248
 Creating diagnostic plots for SUBCAT_Systemische_antihistaminica...

 Running DML for SUBCAT_anxiolytica_Benzodiazepine
 SUBCAT_anxiolytica_Benzodiazepine | Seed 1: ATT = 0.9580, SE = 0.7943, p = 0.23066
 SUBCAT_anxiolytica_Benzodiazepine | Seed 2: ATT = 0.9911, SE = 0.7392, p = 0.18304
 SUBCAT_anxiolytica_Benzodiazepine | Seed 3: ATT = 0.8900, SE = 0.8124, p = 0.27595
 SUBCAT_anxiolytica_Benzodiazepine | Seed 4: ATT = 0.9665, SE = 0.8030, p = 0.23161
 SUBCAT_anxiolytica_Benzodiazepine | Seed 5: ATT = 0.9538, SE = 0.8188, p = 0.24689
 SUBCAT_anxiolytica_Benzodiazepine | Seed 6: ATT = 1.0141, SE = 0.8728, p = 0.24806
 SUBCAT_anxiolytica_Benzodiazepine | Seed 7: ATT = 0.9015, SE = 0.7852, p = 0.25368
 SUBCAT_anxiolytica_Benzodiazepine | Seed 8: ATT = 0.9662, SE = 0.7154, p = 0.17991
 SUBCAT_anxiolytica_Benzodiazepine | Seed 9: ATT = 1.0195, SE = 0.7511, p = 0.17777
 SUBCAT_anxiolytica_Benzodiazepine | Seed 10: ATT = 0.9599, SE = 0.8541, p = 0.26378
 Best result for SUBCAT_anxiolytica_Benzodiazepine  Seed 8 | SE = 0.7154
 Creating diagnostic plots for SUBCAT_anxiolytica_Benzodiazepine...

 Running DML for SUBCAT_hypnotica_Benzodiazepine
 SUBCAT_hypnotica_Benzodiazepine | Seed 1: ATT = -1.7908, SE = 1.7561, p = 0.31032
 SUBCAT_hypnotica_Benzodiazepine | Seed 2: ATT = -1.7809, SE = 1.7194, p = 0.30283
 SUBCAT_hypnotica_Benzodiazepine | Seed 3: ATT = -1.6747, SE = 1.6448, p = 0.31108
 SUBCAT_hypnotica_Benzodiazepine | Seed 4: ATT = -1.8146, SE = 1.7754, p = 0.30924
 SUBCAT_hypnotica_Benzodiazepine | Seed 5: ATT = -1.7364, SE = 1.6723, p = 0.30162
 SUBCAT_hypnotica_Benzodiazepine | Seed 6: ATT = -1.7141, SE = 1.7478, p = 0.32913
 SUBCAT_hypnotica_Benzodiazepine | Seed 7: ATT = -2.0014, SE = 1.6033, p = 0.21487
 SUBCAT_hypnotica_Benzodiazepine | Seed 8: ATT = -1.8427, SE = 1.6495, p = 0.26665
 SUBCAT_hypnotica_Benzodiazepine | Seed 9: ATT = -1.7140, SE = 1.7976, p = 0.34265
 SUBCAT_hypnotica_Benzodiazepine | Seed 10: ATT = -1.7859, SE = 1.6807, p = 0.29054
 Best result for SUBCAT_hypnotica_Benzodiazepine  Seed 7 | SE = 1.6033
 Creating diagnostic plots for SUBCAT_hypnotica_Benzodiazepine...

 Running DML for SUBCAT_Amfetaminen
 SUBCAT_Amfetaminen | Seed 1: ATT = 1.5597, SE = 2.9610, p = 0.59956
 SUBCAT_Amfetaminen | Seed 2: ATT = 1.5269, SE = 2.7811, p = 0.58422
 SUBCAT_Amfetaminen | Seed 3: ATT = 1.6044, SE = 2.9134, p = 0.58308
 SUBCAT_Amfetaminen | Seed 4: ATT = 1.6749, SE = 2.7658, p = 0.54620
 SUBCAT_Amfetaminen | Seed 5: ATT = 1.6166, SE = 3.0739, p = 0.60013
 SUBCAT_Amfetaminen | Seed 6: ATT = 1.9996, SE = 3.3959, p = 0.55731
 SUBCAT_Amfetaminen | Seed 7: ATT = 1.5022, SE = 3.0055, p = 0.61830
 SUBCAT_Amfetaminen | Seed 8: ATT = 1.5544, SE = 3.1108, p = 0.61842
 SUBCAT_Amfetaminen | Seed 9: ATT = 1.6474, SE = 3.3976, p = 0.62883
 SUBCAT_Amfetaminen | Seed 10: ATT = 1.4706, SE = 3.2134, p = 0.64821
 Best result for SUBCAT_Amfetaminen  Seed 4 | SE = 2.7658
 Creating diagnostic plots for SUBCAT_Amfetaminen...

 Running DML for SUBCAT_Paracetamol_mono
 SUBCAT_Paracetamol_mono | Seed 1: ATT = 2.4576, SE = 4.4287, p = 0.58020
 SUBCAT_Paracetamol_mono | Seed 2: ATT = 2.3736, SE = 4.5817, p = 0.60557
 SUBCAT_Paracetamol_mono | Seed 3: ATT = 2.6876, SE = 5.1305, p = 0.60155
 SUBCAT_Paracetamol_mono | Seed 4: ATT = 2.3937, SE = 5.2573, p = 0.64988
 SUBCAT_Paracetamol_mono | Seed 5: ATT = 2.7132, SE = 4.1045, p = 0.51013
 SUBCAT_Paracetamol_mono | Seed 6: ATT = 2.1699, SE = 4.3312, p = 0.61749
 SUBCAT_Paracetamol_mono | Seed 7: ATT = 3.2555, SE = 6.6632, p = 0.62621
 SUBCAT_Paracetamol_mono | Seed 8: ATT = 2.1528, SE = 4.6004, p = 0.64084
 SUBCAT_Paracetamol_mono | Seed 9: ATT = 2.3174, SE = 4.7271, p = 0.62504
 SUBCAT_Paracetamol_mono | Seed 10: ATT = 2.4962, SE = 4.9962, p = 0.61845
 Best result for SUBCAT_Paracetamol_mono  Seed 5 | SE = 4.1045
 Creating diagnostic plots for SUBCAT_Paracetamol_mono...

 Running DML for SUBCAT_Anti_epileptica_stemmingsstabilisatoren
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 1: ATT = 6.0996, SE = 3.6697, p = 0.09965
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 2: ATT = 5.6163, SE = 3.8589, p = 0.14872
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 3: ATT = 5.7675, SE = 4.4255, p = 0.19552
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 4: ATT = 6.0971, SE = 3.7563, p = 0.10774
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 5: ATT = 6.0483, SE = 3.5846, p = 0.09470
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 6: ATT = 5.6503, SE = 3.9982, p = 0.16073
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 7: ATT = 5.4432, SE = 3.7841, p = 0.15346
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 8: ATT = 5.4828, SE = 3.8168, p = 0.15402
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 9: ATT = 5.8921, SE = 3.4220, p = 0.08822
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 10: ATT = 5.5179, SE = 4.1594, p = 0.18770
 Best result for SUBCAT_Anti_epileptica_stemmingsstabilisatoren  Seed 9 | SE = 3.4220
 Creating diagnostic plots for SUBCAT_Anti_epileptica_stemmingsstabilisatoren...

 Running DML for SUBCAT_Opioden
 SUBCAT_Opioden | Seed 1: ATT = 2.9917, SE = 3.4241, p = 0.38439
 SUBCAT_Opioden | Seed 2: ATT = 2.9404, SE = 4.4764, p = 0.51279
 SUBCAT_Opioden | Seed 3: ATT = 2.8184, SE = 3.2095, p = 0.38199
 SUBCAT_Opioden | Seed 4: ATT = 3.1833, SE = 3.2866, p = 0.33512
 SUBCAT_Opioden | Seed 5: ATT = 2.9369, SE = 3.3338, p = 0.38048
 SUBCAT_Opioden | Seed 6: ATT = 2.9273, SE = 3.1313, p = 0.35214
 SUBCAT_Opioden | Seed 7: ATT = 2.7524, SE = 3.2006, p = 0.39188
 SUBCAT_Opioden | Seed 8: ATT = 2.9990, SE = 3.4316, p = 0.38427
 SUBCAT_Opioden | Seed 9: ATT = 2.6634, SE = 3.0092, p = 0.37826
 SUBCAT_Opioden | Seed 10: ATT = 2.6123, SE = 3.2801, p = 0.42771
 Best result for SUBCAT_Opioden  Seed 9 | SE = 3.0092
 Creating diagnostic plots for SUBCAT_Opioden...

 Running DML for SUBCAT_Z_drugs
 SUBCAT_Z_drugs | Seed 1: ATT = 7.4010, SE = 3.0605, p = 0.01742
 SUBCAT_Z_drugs | Seed 2: ATT = 7.4947, SE = 2.7902, p = 0.00848
 SUBCAT_Z_drugs | Seed 3: ATT = 7.2397, SE = 3.1160, p = 0.02220
 SUBCAT_Z_drugs | Seed 4: ATT = 7.1443, SE = 3.0540, p = 0.02133
 SUBCAT_Z_drugs | Seed 5: ATT = 7.6474, SE = 2.8888, p = 0.00944
 SUBCAT_Z_drugs | Seed 6: ATT = 7.3758, SE = 2.8618, p = 0.01143
 SUBCAT_Z_drugs | Seed 7: ATT = 7.1233, SE = 3.1847, p = 0.02755
 SUBCAT_Z_drugs | Seed 8: ATT = 7.1183, SE = 3.0556, p = 0.02186
 SUBCAT_Z_drugs | Seed 9: ATT = 7.3154, SE = 2.8136, p = 0.01075
 SUBCAT_Z_drugs | Seed 10: ATT = 6.9875, SE = 2.7827, p = 0.01366
 Best result for SUBCAT_Z_drugs  Seed 10 | SE = 2.7827
 Creating diagnostic plots for SUBCAT_Z_drugs...

 Running DML for SUBCAT_NSAIDs
 SUBCAT_NSAIDs | Seed 1: ATT = -0.2694, SE = 4.3582, p = 0.95084
 SUBCAT_NSAIDs | Seed 2: ATT = -0.0451, SE = 5.1562, p = 0.99304
 SUBCAT_NSAIDs | Seed 3: ATT = -0.1935, SE = 4.7976, p = 0.96790
 SUBCAT_NSAIDs | Seed 4: ATT = -0.2127, SE = 4.3330, p = 0.96095
 SUBCAT_NSAIDs | Seed 5: ATT = 0.0407, SE = 4.6405, p = 0.99302
 SUBCAT_NSAIDs | Seed 6: ATT = -0.0284, SE = 4.8871, p = 0.99537
 SUBCAT_NSAIDs | Seed 7: ATT = 0.1418, SE = 4.7352, p = 0.97618
 SUBCAT_NSAIDs | Seed 8: ATT = -0.3245, SE = 4.6968, p = 0.94506
 SUBCAT_NSAIDs | Seed 9: ATT = 0.0519, SE = 4.8475, p = 0.99148
 SUBCAT_NSAIDs | Seed 10: ATT = 0.0147, SE = 4.7361, p = 0.99753
 Best result for SUBCAT_NSAIDs  Seed 4 | SE = 4.3330
 Creating diagnostic plots for SUBCAT_NSAIDs...

 All summary files saved.
 All diagnostic plots saved in outputs/plots/ folder.
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=ea3a88b2-9215-46c0-8fd2-b0251e58352e">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[69]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">sem</span><span class="p">,</span> <span class="n">ttest_ind</span>

<span class="c1"># ----------------------------------</span>
<span class="c1"># File paths</span>
<span class="c1"># ----------------------------------</span>
<span class="n">output_base</span> <span class="o">=</span> <span class="s2">"outputs"</span>
<span class="n">att_file</span> <span class="o">=</span> <span class="s2">"dml_rubin_summary_subcats.xlsx"</span>
<span class="n">trimmed_file</span> <span class="o">=</span> <span class="s2">"trimmed_data_imp1.pkl"</span>
<span class="n">auc_file</span> <span class="o">=</span> <span class="s2">"auc_scores.xlsx"</span>  

<span class="c1"># ----------------------------------</span>
<span class="c1"># Load ATT Summary</span>
<span class="c1"># ----------------------------------</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">att_file</span><span class="p">):</span>
    <span class="n">att_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">att_file</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">" ATT summary file not found: dml_rubin_summary_subcats.xlsx"</span><span class="p">)</span>

<span class="n">summary_rows</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># ----------------------------------</span>
<span class="c1"># Loop over medication groups</span>
<span class="c1"># ----------------------------------</span>
<span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">medication_groups</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">g</span><span class="p">))]</span>

<span class="k">for</span> <span class="n">med</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">group_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">med</span><span class="p">)</span>

        <span class="c1"># Load trimmed data</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="n">trimmed_file</span><span class="p">))</span>

        <span class="c1"># Detect treatment column</span>
        <span class="n">treatment_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">med</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">treatment_cols</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Treatment column </span><span class="si">{</span><span class="n">med</span><span class="si">}</span><span class="s2"> not found in trimmed data. Skipping."</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">treatment_var</span> <span class="o">=</span> <span class="n">treatment_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Extract treatment and outcome</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">"caps5_change_baseline"</span><span class="p">]</span>

        <span class="c1"># Treated and control stats</span>
        <span class="n">treated</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">control</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>

        <span class="n">mean_treat</span> <span class="o">=</span> <span class="n">treated</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">se_treat</span> <span class="o">=</span> <span class="n">sem</span><span class="p">(</span><span class="n">treated</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">treated</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">mean_ctrl</span> <span class="o">=</span> <span class="n">control</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">se_ctrl</span> <span class="o">=</span> <span class="n">sem</span><span class="p">(</span><span class="n">control</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">control</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Cohen's d (unadjusted)</span>
        <span class="n">pooled_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">treated</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">control</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">cohen_d</span> <span class="o">=</span> <span class="p">(</span><span class="n">mean_treat</span> <span class="o">-</span> <span class="n">mean_ctrl</span><span class="p">)</span> <span class="o">/</span> <span class="n">pooled_sd</span> <span class="k">if</span> <span class="n">pooled_sd</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># E-value (unadjusted)</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">mean_treat</span> <span class="o">-</span> <span class="n">mean_ctrl</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">delta</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">mean_ctrl</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">mean_ctrl</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Unadjusted p-value</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">t_stat</span><span class="p">,</span> <span class="n">p_val</span> <span class="o">=</span> <span class="n">ttest_ind</span><span class="p">(</span><span class="n">treated</span><span class="p">,</span> <span class="n">control</span><span class="p">,</span> <span class="n">equal_var</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nan_policy</span><span class="o">=</span><span class="s2">"omit"</span><span class="p">)</span>
            <span class="n">rounded_p</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">p_val</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="n">formatted_p</span> <span class="o">=</span> <span class="s2">"&lt; 0.00001"</span> <span class="k">if</span> <span class="n">rounded_p</span> <span class="o">&lt;</span> <span class="mf">0.00001</span> <span class="k">else</span> <span class="n">rounded_p</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">formatted_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># AUC from new auc_scores.xlsx file</span>
        <span class="n">auc_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">auc_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="n">auc_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">auc_path</span><span class="p">):</span>
            <span class="n">auc_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">auc_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">"AUC"</span> <span class="ow">in</span> <span class="n">auc_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">auc_val</span> <span class="o">=</span> <span class="n">auc_df</span><span class="p">[</span><span class="s2">"AUC"</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="c1"># Adjusted stats from Rubin summary</span>
        <span class="n">att_row</span> <span class="o">=</span> <span class="n">att_df</span><span class="p">[</span><span class="n">att_df</span><span class="p">[</span><span class="s2">"group"</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">med</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">att_row</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">att</span> <span class="o">=</span> <span class="n">att_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"att"</span><span class="p">]</span>
            <span class="n">att_se</span> <span class="o">=</span> <span class="n">att_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"se"</span><span class="p">]</span>
            <span class="n">att_p_val</span> <span class="o">=</span> <span class="n">att_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"p_value"</span><span class="p">]</span>
            <span class="n">r2</span> <span class="o">=</span> <span class="n">att_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"r2"</span><span class="p">]</span>
            <span class="n">rmse</span> <span class="o">=</span> <span class="n">att_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"rmse"</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">rounded_att_p</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">att_p_val</span><span class="p">),</span> <span class="mi">5</span><span class="p">)</span>
                <span class="n">formatted_att_p</span> <span class="o">=</span> <span class="s2">"&lt; 0.00001"</span> <span class="k">if</span> <span class="n">rounded_att_p</span> <span class="o">&lt;</span> <span class="mf">0.00001</span> <span class="k">else</span> <span class="n">rounded_att_p</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">formatted_att_p</span> <span class="o">=</span> <span class="n">att_p_val</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">att</span><span class="p">,</span> <span class="n">att_se</span><span class="p">,</span> <span class="n">formatted_att_p</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Append full row</span>
        <span class="n">summary_rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">'Medication Group'</span><span class="p">:</span> <span class="n">med</span><span class="p">,</span>
            <span class="s1">'Mean Treated'</span><span class="p">:</span> <span class="n">mean_treat</span><span class="p">,</span>
            <span class="s1">'SE Treated'</span><span class="p">:</span> <span class="n">se_treat</span><span class="p">,</span>
            <span class="s1">'Mean Control'</span><span class="p">:</span> <span class="n">mean_ctrl</span><span class="p">,</span>
            <span class="s1">'SE Control'</span><span class="p">:</span> <span class="n">se_ctrl</span><span class="p">,</span>
            <span class="s1">'Cohen d'</span><span class="p">:</span> <span class="n">cohen_d</span><span class="p">,</span>
            <span class="s1">'E (Unadjusted)'</span><span class="p">:</span> <span class="n">E</span><span class="p">,</span>
            <span class="s1">'n Treated'</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">treated</span><span class="p">),</span>
            <span class="s1">'n Control'</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">control</span><span class="p">),</span>
            <span class="c1">#'Unadjusted p-value': formatted_p,</span>
            <span class="s1">'ATT Estimate'</span><span class="p">:</span> <span class="n">att</span><span class="p">,</span>
            <span class="s1">'ATT SE (Robust)'</span><span class="p">:</span> <span class="n">att_se</span><span class="p">,</span>
            <span class="s1">'ATT p-value'</span><span class="p">:</span> <span class="n">formatted_att_p</span><span class="p">,</span>
            <span class="s1">'R'</span><span class="p">:</span> <span class="n">r2</span><span class="p">,</span>
            <span class="s1">'RMSE'</span><span class="p">:</span> <span class="n">rmse</span><span class="p">,</span>
            <span class="s1">'AUC'</span><span class="p">:</span> <span class="n">auc_val</span>
        <span class="p">})</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error in </span><span class="si">{</span><span class="n">med</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># ----------------------------------</span>
<span class="c1"># Save final summary</span>
<span class="c1"># ----------------------------------</span>
<span class="n">summary_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">summary_rows</span><span class="p">)</span>
<span class="n">summary_df</span> <span class="o">=</span> <span class="n">summary_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">"Medication Group"</span><span class="p">)</span>
<span class="n">summary_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">"Final_ATT_Summary_SubCat.xlsx"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">" Final_ATT_Summary_SubCat saved"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre> Final_ATT_Summary_SubCat saved
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=fd753254-1fa1-4c8e-8a3c-cbec86b6169a">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[70]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.backends.backend_pdf</span> <span class="kn">import</span> <span class="n">PdfPages</span>

<span class="c1">#  Load the final summary table</span>
<span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s2">"Final_ATT_Summary_SubCat.xlsx"</span><span class="p">)</span>

<span class="c1">#  Parse DML p-values (handle "&lt; 0.00001")</span>
<span class="k">def</span> <span class="nf">parse_pval</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">"&lt;"</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.000001</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

<span class="n">final_df</span><span class="p">[</span><span class="s1">'ATT p-value'</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="s1">'ATT p-value'</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">parse_pval</span><span class="p">)</span>

<span class="c1">#  Plot settings</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>

<span class="c1">#  Plotting function for a single medication group</span>
<span class="k">def</span> <span class="nf">plot_single_group</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    
    <span class="n">bars1</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="o">-</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">'Mean Control'</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> 
                   <span class="n">yerr</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">'SE Control'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">'Control'</span><span class="p">,</span> <span class="n">hatch</span><span class="o">=</span><span class="s1">'//'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">bars2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="o">+</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">'Mean Treated'</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> 
                   <span class="n">yerr</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">'SE Treated'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">'Treated'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'steelblue'</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

    <span class="n">label</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">"ATT = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'ATT Estimate'</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span>
        <span class="sa">f</span><span class="s2">"d = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'Cohen d'</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, p = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'ATT p-value'</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span>
        <span class="sa">f</span><span class="s2">"nT = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'n Treated'</span><span class="p">]</span><span class="si">}</span><span class="s2">, nC = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'n Control'</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span>
        <span class="sa">f</span><span class="s2">"E = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'E (Unadjusted)'</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%"</span>
    <span class="p">)</span>
    <span class="n">max_y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">'Mean Control'</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">'Mean Treated'</span><span class="p">])</span> <span class="o">+</span> <span class="mf">1.5</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_y</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">'center'</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">'bottom'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'#FFD700'</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'black'</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="o">-</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">+</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">'Control'</span><span class="p">,</span> <span class="s1">'Treated'</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Group: </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'Medication Group'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">'bold'</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"CAPS5 Change Score"</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="n">max_y</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">fig</span>

<span class="c1">#  Generate and save all plots into a multi-page PDF</span>
<span class="k">with</span> <span class="n">PdfPages</span><span class="p">(</span><span class="s2">"dml_att_barplot_subcat.pdf"</span><span class="p">)</span> <span class="k">as</span> <span class="n">pdf</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">final_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_single_group</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="n">pdf</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">'tight'</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">" dml_att_barplot_subcat saved"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre> dml_att_barplot_subcat saved
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=808a2609-b153-43da-9068-afb6bbf09dd9">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[71]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Love plot:</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=9ba20ca3-c1b5-4c2b-a48b-f90d8b1734fe">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[72]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="c1"># ----------------------------------------</span>
<span class="c1"># Functions to calculate balance</span>
<span class="c1"># ----------------------------------------</span>
<span class="k">def</span> <span class="nf">calculate_smd</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">w1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">w2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">weighted_mean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span> <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">weighted_var</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">m</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
    
    <span class="n">m1</span> <span class="o">=</span> <span class="n">weighted_mean</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">w1</span><span class="p">)</span> <span class="k">if</span> <span class="n">w1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
    <span class="n">m2</span> <span class="o">=</span> <span class="n">weighted_mean</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span> <span class="k">if</span> <span class="n">w2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">weighted_var</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">w1</span><span class="p">)</span> <span class="k">if</span> <span class="n">w1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">weighted_var</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span> <span class="k">if</span> <span class="n">w2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">pooled_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">v1</span> <span class="o">+</span> <span class="n">v2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">m1</span> <span class="o">-</span> <span class="n">m2</span><span class="p">)</span> <span class="o">/</span> <span class="n">pooled_sd</span> <span class="k">if</span> <span class="n">pooled_sd</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">variance_ratio</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">w1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">w2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">weighted_var</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">m</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
    
    <span class="n">v1</span> <span class="o">=</span> <span class="n">weighted_var</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">w1</span><span class="p">)</span> <span class="k">if</span> <span class="n">w1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">weighted_var</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span> <span class="k">if</span> <span class="n">w2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">v1</span> <span class="o">/</span> <span class="n">v2</span><span class="p">,</span> <span class="n">v2</span> <span class="o">/</span> <span class="n">v1</span><span class="p">)</span> <span class="k">if</span> <span class="n">v1</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">v2</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>

<span class="c1"># ----------------------------------------</span>
<span class="c1"># Setup</span>
<span class="c1"># ----------------------------------------</span>
<span class="n">output_base</span> <span class="o">=</span> <span class="s2">"outputs"</span>
<span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">output_base</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">g</span><span class="p">))]</span>

<span class="c1"># Create a case-insensitive mapping</span>
<span class="n">final_covariates_map_lower</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="c1"># ----------------------------------------</span>
<span class="c1"># Main Loop</span>
<span class="c1"># ----------------------------------------</span>
<span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">group</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_covariates_map_lower</span><span class="p">:</span>
        <span class="k">continue</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Processing </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">..."</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">group_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">covariates</span> <span class="o">=</span> <span class="n">final_covariates_map_lower</span><span class="p">[</span><span class="n">group</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        
        <span class="n">column_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="s2">"trimmed_data_imp1.pkl"</span><span class="p">))</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">group</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">column_name</span> <span class="o">=</span> <span class="n">col</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">column_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Column not found for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">, skipping."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">smd_unw_all</span><span class="p">,</span> <span class="n">smd_w_all</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">vr_unw_all</span><span class="p">,</span> <span class="n">vr_w_all</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
            <span class="n">df_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"trimmed_data_imp</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.pkl"</span><span class="p">)</span>
            <span class="n">iptw_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="s2">"iptw_weights.xlsx"</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">df_path</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">iptw_path</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Missing data for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> imp</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, skipping."</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">df_path</span><span class="p">)</span>
            <span class="n">iptw_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">iptw_path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span>
            <span class="n">W</span> <span class="o">=</span> <span class="n">iptw_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s2">"iptw_mean"</span><span class="p">]</span>

            <span class="n">smd_unw_i</span><span class="p">,</span> <span class="n">smd_w_i</span><span class="p">,</span> <span class="n">vr_unw_i</span><span class="p">,</span> <span class="n">vr_w_i</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">cov</span> <span class="ow">in</span> <span class="n">covariates</span><span class="p">:</span>
                <span class="n">x1</span><span class="p">,</span> <span class="n">x0</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cov</span><span class="p">],</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cov</span><span class="p">]</span>
                <span class="n">w1</span><span class="p">,</span> <span class="n">w0</span> <span class="o">=</span> <span class="n">W</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">],</span> <span class="n">W</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>

                <span class="n">su</span> <span class="o">=</span> <span class="n">calculate_smd</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x0</span><span class="p">)</span>
                <span class="n">sw</span> <span class="o">=</span> <span class="n">calculate_smd</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">w0</span><span class="p">)</span>

                <span class="n">vu</span> <span class="o">=</span> <span class="n">variance_ratio</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x0</span><span class="p">)</span> <span class="k">if</span> <span class="n">cov</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">]</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">vw</span> <span class="o">=</span> <span class="n">variance_ratio</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">w0</span><span class="p">)</span> <span class="k">if</span> <span class="n">cov</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">]</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

                <span class="n">smd_unw_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">su</span><span class="p">)</span>
                <span class="n">smd_w_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sw</span><span class="p">)</span>
                <span class="n">vr_unw_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vu</span><span class="p">)</span>
                <span class="n">vr_w_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vw</span><span class="p">)</span>

            <span class="n">smd_unw_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smd_unw_i</span><span class="p">)</span>
            <span class="n">smd_w_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smd_w_i</span><span class="p">)</span>
            <span class="n">vr_unw_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vr_unw_i</span><span class="p">)</span>
            <span class="n">vr_w_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vr_w_i</span><span class="p">)</span>

        <span class="n">smd_unw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">smd_unw_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">smd_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">smd_w_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">vr_unw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">vr_unw_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">vr_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">vr_w_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">severity</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sw</span> <span class="ow">in</span> <span class="n">smd_w</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sw</span> <span class="o">&lt;=</span> <span class="mf">0.1</span><span class="p">:</span>
                <span class="n">severity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"Good"</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">sw</span> <span class="o">&lt;=</span> <span class="mf">0.2</span><span class="p">:</span>
                <span class="n">severity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"Moderate"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">severity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"Poor"</span><span class="p">)</span>

        <span class="n">covariate_names</span> <span class="o">=</span> <span class="n">covariates</span>
        <span class="n">numeric_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s2">"Covariate"</span><span class="p">:</span> <span class="n">covariate_names</span><span class="p">,</span>
            <span class="s2">"SMD_Unweighted"</span><span class="p">:</span> <span class="n">smd_unw</span><span class="p">,</span>
            <span class="s2">"SMD_Weighted"</span><span class="p">:</span> <span class="n">smd_w</span><span class="p">,</span>
            <span class="s2">"Imbalance_Severity"</span><span class="p">:</span> <span class="n">severity</span><span class="p">,</span>
            <span class="s2">"VR_Unweighted"</span><span class="p">:</span> <span class="n">vr_unw</span><span class="p">,</span>
            <span class="s2">"VR_Weighted"</span><span class="p">:</span> <span class="n">vr_w</span>
        <span class="p">})</span>

        <span class="n">numeric_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"covariate_balance_table_</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">.xlsx"</span><span class="p">)</span>
        <span class="n">numeric_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">numeric_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Exported numeric summary to: </span><span class="si">{</span><span class="n">numeric_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># -------------------------</span>
        <span class="c1"># Plot</span>
        <span class="c1"># -------------------------</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">covariates</span>
        <span class="n">y_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.45</span><span class="p">))</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">smd_unw</span><span class="p">,</span> <span class="n">y_pos</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Unweighted"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">smd_w</span><span class="p">,</span> <span class="n">y_pos</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'blue'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Weighted"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Threshold 0.1"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'black'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Threshold 0.2"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">smd_unw</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">smd_w</span><span class="p">),</span> <span class="mf">0.25</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">y_pos</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Standardized Mean Differences (SMD)"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">"upper right"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">vr_mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">cov</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">]</span> <span class="k">for</span> <span class="n">cov</span> <span class="ow">in</span> <span class="n">covariates</span><span class="p">]</span>
        <span class="n">filtered_y</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vr_mask</span><span class="p">)</span> <span class="k">if</span> <span class="n">b</span><span class="p">]</span>
        <span class="n">filtered_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">filtered_y</span><span class="p">]</span>
        <span class="n">filtered_vr_unw</span> <span class="o">=</span> <span class="p">[</span><span class="n">vr_unw</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">filtered_y</span><span class="p">]</span>
        <span class="n">filtered_vr_w</span> <span class="o">=</span> <span class="p">[</span><span class="n">vr_w</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">filtered_y</span><span class="p">]</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">filtered_vr_unw</span><span class="p">,</span> <span class="n">filtered_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'blue'</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">'o'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Unweighted"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">filtered_vr_w</span><span class="p">,</span> <span class="n">filtered_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">'x'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Weighted"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">filtered_vr_unw</span> <span class="o">+</span> <span class="n">filtered_vr_w</span> <span class="o">+</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">])</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">filtered_y</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">filtered_labels</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Variance Ratio (VR)"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Covariate Balance for </span><span class="si">{</span><span class="n">group</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'CAT_'</span><span class="p">,</span><span class="w"> </span><span class="s1">''</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">'bold'</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.96</span><span class="p">])</span>
        <span class="n">plot_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"love_plot_</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">.pdf"</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Saved love plot: </span><span class="si">{</span><span class="n">plot_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Max weighted SMD for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">smd_w</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Processing SUBCAT_Amfetaminen...
 Exported numeric summary to: outputs\SUBCAT_Amfetaminen\covariate_balance_table_SUBCAT_Amfetaminen.xlsx
 Saved love plot: outputs\SUBCAT_Amfetaminen\love_plot_SUBCAT_Amfetaminen.pdf
 Max weighted SMD for SUBCAT_Amfetaminen: 0.369

 Processing SUBCAT_Antidepressiva_Overige...
 Exported numeric summary to: outputs\SUBCAT_Antidepressiva_Overige\covariate_balance_table_SUBCAT_Antidepressiva_Overige.xlsx
 Saved love plot: outputs\SUBCAT_Antidepressiva_Overige\love_plot_SUBCAT_Antidepressiva_Overige.pdf
 Max weighted SMD for SUBCAT_Antidepressiva_Overige: 0.288

 Processing SUBCAT_Antipsychotica_Atypisch...
 Exported numeric summary to: outputs\SUBCAT_Antipsychotica_Atypisch\covariate_balance_table_SUBCAT_Antipsychotica_Atypisch.xlsx
 Saved love plot: outputs\SUBCAT_Antipsychotica_Atypisch\love_plot_SUBCAT_Antipsychotica_Atypisch.pdf
 Max weighted SMD for SUBCAT_Antipsychotica_Atypisch: 0.583

 Processing SUBCAT_Anti_Epileptica_Stemmingsstabilisatoren...
 Exported numeric summary to: outputs\SUBCAT_Anti_Epileptica_Stemmingsstabilisatoren\covariate_balance_table_SUBCAT_Anti_Epileptica_Stemmingsstabilisatoren.xlsx
 Saved love plot: outputs\SUBCAT_Anti_Epileptica_Stemmingsstabilisatoren\love_plot_SUBCAT_Anti_Epileptica_Stemmingsstabilisatoren.pdf
 Max weighted SMD for SUBCAT_Anti_Epileptica_Stemmingsstabilisatoren: 0.262

 Processing SUBCAT_Anxiolytica_Benzodiazepine...
 Exported numeric summary to: outputs\SUBCAT_Anxiolytica_Benzodiazepine\covariate_balance_table_SUBCAT_Anxiolytica_Benzodiazepine.xlsx
 Saved love plot: outputs\SUBCAT_Anxiolytica_Benzodiazepine\love_plot_SUBCAT_Anxiolytica_Benzodiazepine.pdf
 Max weighted SMD for SUBCAT_Anxiolytica_Benzodiazepine: 0.227

 Processing SUBCAT_Hypnotica_Benzodiazepine...
 Exported numeric summary to: outputs\SUBCAT_Hypnotica_Benzodiazepine\covariate_balance_table_SUBCAT_Hypnotica_Benzodiazepine.xlsx
 Saved love plot: outputs\SUBCAT_Hypnotica_Benzodiazepine\love_plot_SUBCAT_Hypnotica_Benzodiazepine.pdf
 Max weighted SMD for SUBCAT_Hypnotica_Benzodiazepine: 0.211

 Processing SUBCAT_Nsaids...
 Exported numeric summary to: outputs\SUBCAT_Nsaids\covariate_balance_table_SUBCAT_Nsaids.xlsx
 Saved love plot: outputs\SUBCAT_Nsaids\love_plot_SUBCAT_Nsaids.pdf
 Max weighted SMD for SUBCAT_Nsaids: 0.241

 Processing SUBCAT_Opioden...
 Exported numeric summary to: outputs\SUBCAT_Opioden\covariate_balance_table_SUBCAT_Opioden.xlsx
 Saved love plot: outputs\SUBCAT_Opioden\love_plot_SUBCAT_Opioden.pdf
 Max weighted SMD for SUBCAT_Opioden: 0.333

 Processing SUBCAT_Paracetamol_Mono...
 Exported numeric summary to: outputs\SUBCAT_Paracetamol_Mono\covariate_balance_table_SUBCAT_Paracetamol_Mono.xlsx
 Saved love plot: outputs\SUBCAT_Paracetamol_Mono\love_plot_SUBCAT_Paracetamol_Mono.pdf
 Max weighted SMD for SUBCAT_Paracetamol_Mono: 0.255

 Processing SUBCAT_Snri...
 Exported numeric summary to: outputs\SUBCAT_Snri\covariate_balance_table_SUBCAT_Snri.xlsx
 Saved love plot: outputs\SUBCAT_Snri\love_plot_SUBCAT_Snri.pdf
 Max weighted SMD for SUBCAT_Snri: 0.287

 Processing SUBCAT_Ssri...
 Exported numeric summary to: outputs\SUBCAT_Ssri\covariate_balance_table_SUBCAT_Ssri.xlsx
 Saved love plot: outputs\SUBCAT_Ssri\love_plot_SUBCAT_Ssri.pdf
 Max weighted SMD for SUBCAT_Ssri: 0.187

 Processing SUBCAT_Systemische_Antihistaminica...
 Exported numeric summary to: outputs\SUBCAT_Systemische_Antihistaminica\covariate_balance_table_SUBCAT_Systemische_Antihistaminica.xlsx
 Saved love plot: outputs\SUBCAT_Systemische_Antihistaminica\love_plot_SUBCAT_Systemische_Antihistaminica.pdf
 Max weighted SMD for SUBCAT_Systemische_Antihistaminica: 0.391

 Processing SUBCAT_Tca...
 Exported numeric summary to: outputs\SUBCAT_Tca\covariate_balance_table_SUBCAT_Tca.xlsx
 Saved love plot: outputs\SUBCAT_Tca\love_plot_SUBCAT_Tca.pdf
 Max weighted SMD for SUBCAT_Tca: 0.283

 Processing SUBCAT_Tetracyclische_Antidepressiva...
 Exported numeric summary to: outputs\SUBCAT_Tetracyclische_Antidepressiva\covariate_balance_table_SUBCAT_Tetracyclische_Antidepressiva.xlsx
 Saved love plot: outputs\SUBCAT_Tetracyclische_Antidepressiva\love_plot_SUBCAT_Tetracyclische_Antidepressiva.pdf
 Max weighted SMD for SUBCAT_Tetracyclische_Antidepressiva: 0.247

 Processing SUBCAT_Z_Drugs...
 Exported numeric summary to: outputs\SUBCAT_Z_Drugs\covariate_balance_table_SUBCAT_Z_Drugs.xlsx
 Saved love plot: outputs\SUBCAT_Z_Drugs\love_plot_SUBCAT_Z_Drugs.pdf
 Max weighted SMD for SUBCAT_Z_Drugs: 0.181
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=0ab142d4-d10c-4ad7-ba2a-fdeb4d489dcc">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[73]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Heatmap:</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=1bb78ca6-383e-4d8c-95c9-43271e6ecc64">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[74]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="c1">#-----------------------------</span>
<span class="c1"># Generate heatmaps</span>
<span class="c1"># -------------------------------</span>
<span class="k">for</span> <span class="n">treatment_var</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">========== Creating Heatmap for </span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s2"> =========="</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">'outputs'</span><span class="p">,</span> <span class="n">treatment_var</span><span class="p">)</span>
        <span class="n">balance_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'covariate_balance_table_</span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s1">.xlsx'</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">balance_path</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Balance file not found: </span><span class="si">{</span><span class="n">balance_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">balance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">balance_path</span><span class="p">)</span>

        <span class="c1">#  Use finalized covariates + 'Propensity Score'</span>
        <span class="n">covariates</span> <span class="o">=</span> <span class="n">final_covariates_map</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">'Propensity Score'</span><span class="p">]</span>
        <span class="n">balance_df</span> <span class="o">=</span> <span class="n">balance_df</span><span class="p">[</span><span class="n">balance_df</span><span class="p">[</span><span class="s1">'Covariate'</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">covariates</span><span class="p">)]</span>

        <span class="c1">#  Check for CAPS5score_baseline</span>
        <span class="n">highlight_caps</span> <span class="o">=</span> <span class="s1">'CAPS5score_baseline'</span> <span class="ow">in</span> <span class="n">balance_df</span><span class="p">[</span><span class="s1">'Covariate'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="c1">#  Format for heatmap</span>
        <span class="n">heatmap_df</span> <span class="o">=</span> <span class="n">balance_df</span><span class="p">[[</span><span class="s1">'Covariate'</span><span class="p">,</span> <span class="s1">'SMD_Unweighted'</span><span class="p">,</span> <span class="s1">'SMD_Weighted'</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">heatmap_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'Covariate'</span><span class="p">,</span> <span class="s1">'Unweighted'</span><span class="p">,</span> <span class="s1">'Weighted'</span><span class="p">]</span>
        <span class="n">heatmap_df</span> <span class="o">=</span> <span class="n">heatmap_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">'Covariate'</span><span class="p">)</span>
        <span class="n">heatmap_df</span> <span class="o">=</span> <span class="n">heatmap_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">'Unweighted'</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1">#  Plot</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">heatmap_df</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.35</span><span class="p">)))</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span>
            <span class="n">heatmap_df</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="s2">"coolwarm"</span><span class="p">,</span>
            <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">fmt</span><span class="o">=</span><span class="s2">".2f"</span><span class="p">,</span>
            <span class="n">linewidths</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
            <span class="n">linecolor</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span>
            <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">"label"</span><span class="p">:</span> <span class="s2">"Standardized Mean Difference"</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Covariate Balance Heatmap (Rubin IPTW)</span><span class="se">\n</span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">'bold'</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Condition"</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"Covariate"</span><span class="p">)</span>

        <span class="c1">#  Bold CAPS5score_baseline if present</span>
        <span class="k">if</span> <span class="n">highlight_caps</span><span class="p">:</span>
            <span class="n">ylabels</span> <span class="o">=</span> <span class="p">[</span><span class="n">label</span><span class="o">.</span><span class="n">get_text</span><span class="p">()</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span>
                <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2"> "</span> <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="s1">'CAPS5score_baseline'</span> <span class="k">else</span> <span class="n">label</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ylabels</span>
            <span class="p">])</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="c1">#  Save image</span>
        <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'heatmap_smd_</span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s1">.png'</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Heatmap saved: </span><span class="si">{</span><span class="n">save_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error processing </span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
========== Creating Heatmap for SUBCAT_Antipsychotica_atypisch ==========
 Heatmap saved: outputs\SUBCAT_Antipsychotica_atypisch\heatmap_smd_SUBCAT_Antipsychotica_atypisch.png

========== Creating Heatmap for SUBCAT_TCA ==========
 Heatmap saved: outputs\SUBCAT_TCA\heatmap_smd_SUBCAT_TCA.png

========== Creating Heatmap for SUBCAT_SSRI ==========
 Heatmap saved: outputs\SUBCAT_SSRI\heatmap_smd_SUBCAT_SSRI.png

========== Creating Heatmap for SUBCAT_SNRI ==========
 Heatmap saved: outputs\SUBCAT_SNRI\heatmap_smd_SUBCAT_SNRI.png

========== Creating Heatmap for SUBCAT_Tetracyclische_antidepressiva ==========
 Heatmap saved: outputs\SUBCAT_Tetracyclische_antidepressiva\heatmap_smd_SUBCAT_Tetracyclische_antidepressiva.png

========== Creating Heatmap for SUBCAT_Antidepressiva_overige ==========
 Heatmap saved: outputs\SUBCAT_Antidepressiva_overige\heatmap_smd_SUBCAT_Antidepressiva_overige.png

========== Creating Heatmap for SUBCAT_Systemische_antihistaminica ==========
 Heatmap saved: outputs\SUBCAT_Systemische_antihistaminica\heatmap_smd_SUBCAT_Systemische_antihistaminica.png

========== Creating Heatmap for SUBCAT_anxiolytica_Benzodiazepine ==========
 Heatmap saved: outputs\SUBCAT_anxiolytica_Benzodiazepine\heatmap_smd_SUBCAT_anxiolytica_Benzodiazepine.png

========== Creating Heatmap for SUBCAT_hypnotica_Benzodiazepine ==========
 Heatmap saved: outputs\SUBCAT_hypnotica_Benzodiazepine\heatmap_smd_SUBCAT_hypnotica_Benzodiazepine.png

========== Creating Heatmap for SUBCAT_Amfetaminen ==========
 Heatmap saved: outputs\SUBCAT_Amfetaminen\heatmap_smd_SUBCAT_Amfetaminen.png

========== Creating Heatmap for SUBCAT_Paracetamol_mono ==========
 Heatmap saved: outputs\SUBCAT_Paracetamol_mono\heatmap_smd_SUBCAT_Paracetamol_mono.png

========== Creating Heatmap for SUBCAT_Anti_epileptica_stemmingsstabilisatoren ==========
 Heatmap saved: outputs\SUBCAT_Anti_epileptica_stemmingsstabilisatoren\heatmap_smd_SUBCAT_Anti_epileptica_stemmingsstabilisatoren.png

========== Creating Heatmap for SUBCAT_Opioden ==========
 Heatmap saved: outputs\SUBCAT_Opioden\heatmap_smd_SUBCAT_Opioden.png

========== Creating Heatmap for SUBCAT_Z_drugs ==========
 Heatmap saved: outputs\SUBCAT_Z_drugs\heatmap_smd_SUBCAT_Z_drugs.png

========== Creating Heatmap for SUBCAT_NSAIDs ==========
 Heatmap saved: outputs\SUBCAT_NSAIDs\heatmap_smd_SUBCAT_NSAIDs.png
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=e8017939-91a9-45e2-90b0-e309b89f8a89">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span> 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=fa951dd2-27ff-43ba-b9fd-c07e234136ff">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="SubSubCat-Analysis:">SubSubCat Analysis:<a class="anchor-link" href="#SubSubCat-Analysis:"></a></h2>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=69094b37-2a1f-4e4f-9430-b1f89e29fdf1">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[75]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">covariates_SubSubCat_Oxazepam</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span> <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SubSubCat_Diazepam</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span> <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_SubSubCat_Paracetamol</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SubSubCat_Lorazepam</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span> <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SubSubCat_Mirtazapine</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SubSubCat_Escitalopram</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_SubSubCat_Sertraline</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SubSubCat_Temazepam</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span> <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SubSubCat_Citalopram</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SubSubCat_Quetiapine</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>




<span class="n">covariates_SubSubCat_Amitriptyline</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_SubSubCat_Venlafaxine</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SubSubCat_Fluoxetine</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SubSubCat_Topiramaat</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>





<span class="n">covariates_SubSubCat_Zopiclon</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>










<span class="n">covariates_SubSubCat_Bupropion</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SubSubCat_Methylfenidaat</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span>
    <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SubSubCat_Olanzapine</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=d96d7337-d69e-4554-8337-57adf4d3c977">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[76]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="c1"># This finds all variables that start with covariates_SUbSubCAT_ or covariates_SubSubcat_</span>
<span class="n">final_covariates_map</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<span class="n">final_covariates_map</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
    <span class="n">var</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"covariates_"</span><span class="p">,</span> <span class="s2">""</span><span class="p">):</span> <span class="n">val</span>
    <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"covariates_subsubcat_"</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
<span class="p">})</span>

<span class="c1"># Show detected group names</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Groups found:"</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
<span class="n">medication_groups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">medication_groups</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Groups found: ['SubSubCat_Oxazepam', 'SubSubCat_Diazepam', 'SubSubCat_Paracetamol', 'SubSubCat_Lorazepam', 'SubSubCat_Mirtazapine', 'SubSubCat_Escitalopram', 'SubSubCat_Sertraline', 'SubSubCat_Temazepam', 'SubSubCat_Citalopram', 'SubSubCat_Quetiapine', 'SubSubCat_Amitriptyline', 'SubSubCat_Venlafaxine', 'SubSubCat_Fluoxetine', 'SubSubCat_Topiramaat', 'SubSubCat_Zopiclon', 'SubSubCat_Bupropion', 'SubSubCat_Methylfenidaat', 'SubSubCat_Olanzapine']
['SubSubCat_Oxazepam', 'SubSubCat_Diazepam', 'SubSubCat_Paracetamol', 'SubSubCat_Lorazepam', 'SubSubCat_Mirtazapine', 'SubSubCat_Escitalopram', 'SubSubCat_Sertraline', 'SubSubCat_Temazepam', 'SubSubCat_Citalopram', 'SubSubCat_Quetiapine', 'SubSubCat_Amitriptyline', 'SubSubCat_Venlafaxine', 'SubSubCat_Fluoxetine', 'SubSubCat_Topiramaat', 'SubSubCat_Zopiclon', 'SubSubCat_Bupropion', 'SubSubCat_Methylfenidaat', 'SubSubCat_Olanzapine']
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=0640ebd5-cfed-4ddb-a643-ec647517528a">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[77]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>


<span class="k">def</span> <span class="nf">run_all_SUBSUBCAT_group_models</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Runs downstream analysis for each SUBSUBCAT medisubsubcation group using imputed datasets.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - imputed_dfs: list of 5 imputed DataFrames (from df_imputed_final_imp1.pkl ... imp5.pkl)</span>
<span class="sd">    </span>
<span class="sd">    Notes:</span>
<span class="sd">    - Covariate lists must be defined as global variables: covariates_subsubcat_&lt;group&gt;</span>
<span class="sd">    - Outputs are saved in: outputs/SUBSUBCAT_&lt;GROUP&gt;/</span>
<span class="sd">    """</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">" Starting analysis for all SUBSUBCAT groups"</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">var_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"covariates_subsubcat_"</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">globals</span><span class="p">()[</span><span class="n">var_name</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">group_name</span> <span class="o">=</span> <span class="n">var_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"covariates_"</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
            <span class="n">group_name</span> <span class="o">=</span> <span class="n">group_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"_"</span><span class="p">,</span> <span class="s2">" "</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">" "</span><span class="p">,</span> <span class="s2">"_"</span><span class="p">)</span>  <span class="c1"># e.g., subsubcat_z_drugs  Subsubcat_Z_Drugs</span>
            <span class="n">group_name</span> <span class="o">=</span> <span class="n">group_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"Subsubcat_"</span><span class="p">,</span> <span class="s2">"SUBSUBCAT_"</span><span class="p">)</span>  <span class="c1"># force prefix to uppercase</span>

            <span class="n">covariates</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()[</span><span class="n">var_name</span><span class="p">]</span>
            <span class="n">output_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"outputs/</span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">"</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Processing </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">..."</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">df_imp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   Using imputation </span><span class="si">{</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

                <span class="c1"># Define X and Y</span>
                <span class="n">X</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span>
                <span class="n">Y</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="s2">"caps5_change_baseline"</span><span class="p">]</span>

                <span class="c1"># === Save X and Y as placeholder (replace with modeling later)</span>
                <span class="n">X</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/X_imp</span><span class="si">{</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.csv"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">Y</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"Y"</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/Y_imp</span><span class="si">{</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.csv"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Done: </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> All SUBSUBCAT group analyses complete."</span><span class="p">)</span>

<span class="c1"># ========= STEP 4: Execute ========= #</span>
<span class="n">run_all_SUBSUBCAT_group_models</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre> Starting analysis for all SUBSUBCAT groups

 Processing SUBSUBCAT_Oxazepam...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Oxazepam

 Processing SUBSUBCAT_Diazepam...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Diazepam

 Processing SUBSUBCAT_Paracetamol...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Paracetamol

 Processing SUBSUBCAT_Lorazepam...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Lorazepam

 Processing SUBSUBCAT_Mirtazapine...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Mirtazapine

 Processing SUBSUBCAT_Escitalopram...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Escitalopram

 Processing SUBSUBCAT_Sertraline...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Sertraline

 Processing SUBSUBCAT_Temazepam...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Temazepam

 Processing SUBSUBCAT_Citalopram...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Citalopram

 Processing SUBSUBCAT_Quetiapine...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Quetiapine

 Processing SUBSUBCAT_Amitriptyline...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Amitriptyline

 Processing SUBSUBCAT_Venlafaxine...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Venlafaxine

 Processing SUBSUBCAT_Fluoxetine...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Fluoxetine

 Processing SUBSUBCAT_Topiramaat...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Topiramaat

 Processing SUBSUBCAT_Zopiclon...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Zopiclon

 Processing SUBSUBCAT_Bupropion...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Bupropion

 Processing SUBSUBCAT_Methylfenidaat...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Methylfenidaat

 Processing SUBSUBCAT_Olanzapine...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Olanzapine

 All SUBSUBCAT group analyses complete.
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=c77713ae-0355-4e4f-9a8c-910b53ed4871">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[78]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">treatment_var</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">treatment_var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Imp </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">:  Not found in columns."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">treated</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">control</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Imp </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: Treated = </span><span class="si">{</span><span class="n">treated</span><span class="si">}</span><span class="s2">, Control = </span><span class="si">{</span><span class="n">control</span><span class="si">}</span><span class="s2">, Missing = </span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 SubSubCat_Oxazepam
  Imp 1: Treated = 206, Control = 3435, Missing = 0
  Imp 2: Treated = 206, Control = 3435, Missing = 0
  Imp 3: Treated = 206, Control = 3435, Missing = 0
  Imp 4: Treated = 206, Control = 3435, Missing = 0
  Imp 5: Treated = 206, Control = 3435, Missing = 0

 SubSubCat_Diazepam
  Imp 1: Treated = 42, Control = 3599, Missing = 0
  Imp 2: Treated = 42, Control = 3599, Missing = 0
  Imp 3: Treated = 42, Control = 3599, Missing = 0
  Imp 4: Treated = 42, Control = 3599, Missing = 0
  Imp 5: Treated = 42, Control = 3599, Missing = 0

 SubSubCat_Paracetamol
  Imp 1: Treated = 43, Control = 3598, Missing = 0
  Imp 2: Treated = 43, Control = 3598, Missing = 0
  Imp 3: Treated = 43, Control = 3598, Missing = 0
  Imp 4: Treated = 43, Control = 3598, Missing = 0
  Imp 5: Treated = 43, Control = 3598, Missing = 0

 SubSubCat_Lorazepam
  Imp 1: Treated = 67, Control = 3574, Missing = 0
  Imp 2: Treated = 67, Control = 3574, Missing = 0
  Imp 3: Treated = 67, Control = 3574, Missing = 0
  Imp 4: Treated = 67, Control = 3574, Missing = 0
  Imp 5: Treated = 67, Control = 3574, Missing = 0

 SubSubCat_Mirtazapine
  Imp 1: Treated = 87, Control = 3554, Missing = 0
  Imp 2: Treated = 87, Control = 3554, Missing = 0
  Imp 3: Treated = 87, Control = 3554, Missing = 0
  Imp 4: Treated = 87, Control = 3554, Missing = 0
  Imp 5: Treated = 87, Control = 3554, Missing = 0

 SubSubCat_Escitalopram
  Imp 1: Treated = 69, Control = 3572, Missing = 0
  Imp 2: Treated = 69, Control = 3572, Missing = 0
  Imp 3: Treated = 69, Control = 3572, Missing = 0
  Imp 4: Treated = 69, Control = 3572, Missing = 0
  Imp 5: Treated = 69, Control = 3572, Missing = 0

 SubSubCat_Sertraline
  Imp 1: Treated = 102, Control = 3539, Missing = 0
  Imp 2: Treated = 102, Control = 3539, Missing = 0
  Imp 3: Treated = 102, Control = 3539, Missing = 0
  Imp 4: Treated = 102, Control = 3539, Missing = 0
  Imp 5: Treated = 102, Control = 3539, Missing = 0

 SubSubCat_Temazepam
  Imp 1: Treated = 93, Control = 3548, Missing = 0
  Imp 2: Treated = 93, Control = 3548, Missing = 0
  Imp 3: Treated = 93, Control = 3548, Missing = 0
  Imp 4: Treated = 93, Control = 3548, Missing = 0
  Imp 5: Treated = 93, Control = 3548, Missing = 0

 SubSubCat_Citalopram
  Imp 1: Treated = 125, Control = 3516, Missing = 0
  Imp 2: Treated = 125, Control = 3516, Missing = 0
  Imp 3: Treated = 125, Control = 3516, Missing = 0
  Imp 4: Treated = 125, Control = 3516, Missing = 0
  Imp 5: Treated = 125, Control = 3516, Missing = 0

 SubSubCat_Quetiapine
  Imp 1: Treated = 203, Control = 3438, Missing = 0
  Imp 2: Treated = 203, Control = 3438, Missing = 0
  Imp 3: Treated = 203, Control = 3438, Missing = 0
  Imp 4: Treated = 203, Control = 3438, Missing = 0
  Imp 5: Treated = 203, Control = 3438, Missing = 0

 SubSubCat_Amitriptyline
  Imp 1: Treated = 52, Control = 3589, Missing = 0
  Imp 2: Treated = 52, Control = 3589, Missing = 0
  Imp 3: Treated = 52, Control = 3589, Missing = 0
  Imp 4: Treated = 52, Control = 3589, Missing = 0
  Imp 5: Treated = 52, Control = 3589, Missing = 0

 SubSubCat_Venlafaxine
  Imp 1: Treated = 59, Control = 3582, Missing = 0
  Imp 2: Treated = 59, Control = 3582, Missing = 0
  Imp 3: Treated = 59, Control = 3582, Missing = 0
  Imp 4: Treated = 59, Control = 3582, Missing = 0
  Imp 5: Treated = 59, Control = 3582, Missing = 0

 SubSubCat_Fluoxetine
  Imp 1: Treated = 71, Control = 3570, Missing = 0
  Imp 2: Treated = 71, Control = 3570, Missing = 0
  Imp 3: Treated = 71, Control = 3570, Missing = 0
  Imp 4: Treated = 71, Control = 3570, Missing = 0
  Imp 5: Treated = 71, Control = 3570, Missing = 0

 SubSubCat_Topiramaat
  Imp 1: Treated = 41, Control = 3600, Missing = 0
  Imp 2: Treated = 41, Control = 3600, Missing = 0
  Imp 3: Treated = 41, Control = 3600, Missing = 0
  Imp 4: Treated = 41, Control = 3600, Missing = 0
  Imp 5: Treated = 41, Control = 3600, Missing = 0

 SubSubCat_Zopiclon
  Imp 1: Treated = 32, Control = 3609, Missing = 0
  Imp 2: Treated = 32, Control = 3609, Missing = 0
  Imp 3: Treated = 32, Control = 3609, Missing = 0
  Imp 4: Treated = 32, Control = 3609, Missing = 0
  Imp 5: Treated = 32, Control = 3609, Missing = 0

 SubSubCat_Bupropion
  Imp 1: Treated = 34, Control = 3607, Missing = 0
  Imp 2: Treated = 34, Control = 3607, Missing = 0
  Imp 3: Treated = 34, Control = 3607, Missing = 0
  Imp 4: Treated = 34, Control = 3607, Missing = 0
  Imp 5: Treated = 34, Control = 3607, Missing = 0

 SubSubCat_Methylfenidaat
  Imp 1: Treated = 38, Control = 3603, Missing = 0
  Imp 2: Treated = 38, Control = 3603, Missing = 0
  Imp 3: Treated = 38, Control = 3603, Missing = 0
  Imp 4: Treated = 38, Control = 3603, Missing = 0
  Imp 5: Treated = 38, Control = 3603, Missing = 0

 SubSubCat_Olanzapine
  Imp 1: Treated = 33, Control = 3608, Missing = 0
  Imp 2: Treated = 33, Control = 3608, Missing = 0
  Imp 3: Treated = 33, Control = 3608, Missing = 0
  Imp 4: Treated = 33, Control = 3608, Missing = 0
  Imp 5: Treated = 33, Control = 3608, Missing = 0
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=c34e2dcc-a576-4532-bbb3-69af4010257b">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[79]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">from</span> <span class="nn">statsmodels.stats.outliers_influence</span> <span class="kn">import</span> <span class="n">variance_inflation_factor</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="c1">#  VIF computation function</span>
<span class="k">def</span> <span class="nf">compute_vif</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">has_constant</span><span class="o">=</span><span class="s1">'add'</span><span class="p">)</span>
    <span class="n">vif_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">vif_df</span><span class="p">[</span><span class="s2">"variable"</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span>
    <span class="n">vif_df</span><span class="p">[</span><span class="s2">"VIF"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">variance_inflation_factor</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
    <span class="k">return</span> <span class="n">vif_df</span>

<span class="c1">#  Process each group</span>
<span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Processing VIF for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  No covariates found for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
        <span class="k">continue</span>

    <span class="n">covariates</span> <span class="o">=</span> <span class="n">final_covariates_map</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
    <span class="n">vif_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df_imp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">vif_df</span> <span class="o">=</span> <span class="n">compute_vif</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="n">vif_df</span><span class="p">[</span><span class="s2">"imputation"</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">vif_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vif_df</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"    Failed on imputation </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">vif_list</span><span class="p">:</span>
        <span class="n">all_vif</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">vif_list</span><span class="p">)</span>
        <span class="n">pooled_vif</span> <span class="o">=</span> <span class="n">all_vif</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">"variable"</span><span class="p">)[</span><span class="s2">"VIF"</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">pooled_vif</span> <span class="o">=</span> <span class="n">pooled_vif</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">"VIF"</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"outputs"</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">pooled_vif</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"pooled_vif.csv"</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Saved: </span><span class="si">{</span><span class="n">output_folder</span><span class="si">}</span><span class="s2">/pooled_vif.csv"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Skipped </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: No valid imputations."</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Processing VIF for SubSubCat_Oxazepam
  Saved: outputs\SubSubCat_Oxazepam/pooled_vif.csv

 Processing VIF for SubSubCat_Diazepam
  Saved: outputs\SubSubCat_Diazepam/pooled_vif.csv

 Processing VIF for SubSubCat_Paracetamol
  Saved: outputs\SubSubCat_Paracetamol/pooled_vif.csv

 Processing VIF for SubSubCat_Lorazepam
  Saved: outputs\SubSubCat_Lorazepam/pooled_vif.csv

 Processing VIF for SubSubCat_Mirtazapine
  Saved: outputs\SubSubCat_Mirtazapine/pooled_vif.csv

 Processing VIF for SubSubCat_Escitalopram
  Saved: outputs\SubSubCat_Escitalopram/pooled_vif.csv

 Processing VIF for SubSubCat_Sertraline
  Saved: outputs\SubSubCat_Sertraline/pooled_vif.csv

 Processing VIF for SubSubCat_Temazepam
  Saved: outputs\SubSubCat_Temazepam/pooled_vif.csv

 Processing VIF for SubSubCat_Citalopram
  Saved: outputs\SubSubCat_Citalopram/pooled_vif.csv

 Processing VIF for SubSubCat_Quetiapine
  Saved: outputs\SubSubCat_Quetiapine/pooled_vif.csv

 Processing VIF for SubSubCat_Amitriptyline
  Saved: outputs\SubSubCat_Amitriptyline/pooled_vif.csv

 Processing VIF for SubSubCat_Venlafaxine
  Saved: outputs\SubSubCat_Venlafaxine/pooled_vif.csv

 Processing VIF for SubSubCat_Fluoxetine
  Saved: outputs\SubSubCat_Fluoxetine/pooled_vif.csv

 Processing VIF for SubSubCat_Topiramaat
  Saved: outputs\SubSubCat_Topiramaat/pooled_vif.csv

 Processing VIF for SubSubCat_Zopiclon
  Saved: outputs\SubSubCat_Zopiclon/pooled_vif.csv

 Processing VIF for SubSubCat_Bupropion
  Saved: outputs\SubSubCat_Bupropion/pooled_vif.csv

 Processing VIF for SubSubCat_Methylfenidaat
  Saved: outputs\SubSubCat_Methylfenidaat/pooled_vif.csv

 Processing VIF for SubSubCat_Olanzapine
  Saved: outputs\SubSubCat_Olanzapine/pooled_vif.csv
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=7a8d4450-4832-4ef7-b6d2-d897899a857b">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[80]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">xgboost</span> <span class="kn">import</span> <span class="n">XGBClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">roc_curve</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>

<span class="c1"># ---------- PS Estimation Function ----------</span>
<span class="k">def</span> <span class="nf">run_xgboost_ps_modeling</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Running PS estimation for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No covariates found for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"outputs"</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">covariates</span> <span class="o">=</span> <span class="n">final_covariates_map</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
        <span class="n">ps_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">auc_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df_imp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_imp</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> not found in imputed dataset </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">X</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>

            <span class="c1"># Drop missing treatment rows</span>
            <span class="n">valid_idx</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">index</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>

            <span class="c1"># Train-test split for ROC</span>
            <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">T_train</span><span class="p">,</span> <span class="n">T_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
                <span class="n">X</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
            <span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">XGBClassifier</span><span class="p">(</span><span class="n">use_label_encoder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eval_metric</span><span class="o">=</span><span class="s1">'logloss'</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
                <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">T_train</span><span class="p">)</span>

                <span class="n">ps_scores</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">ps_matrix</span><span class="p">[</span><span class="sa">f</span><span class="s2">"ps_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">ps_scores</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">valid_idx</span><span class="p">)</span>

                <span class="c1"># ROC &amp; AUC</span>
                <span class="n">auc</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">T_test</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">auc_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">auc</span><span class="p">)</span>

                <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">T_test</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">"AUC = </span><span class="si">{</span><span class="n">auc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'k--'</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"False Positive Rate"</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"True Positive Rate"</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"ROC Curve - </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> (Imp </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">)"</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"roc_curve_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.png"</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   Imp </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: AUC = </span><span class="si">{</span><span class="n">auc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, ROC saved."</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> (imp </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Save AUCs and Composite PS</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ps_matrix</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="c1"># Fill NaN rows (from dropped subjects in some imputations) with mean</span>
            <span class="n">ps_matrix</span><span class="p">[</span><span class="s2">"composite_ps"</span><span class="p">]</span> <span class="o">=</span> <span class="n">ps_matrix</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ps_matrix</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"propensity_scores.xlsx"</span><span class="p">))</span>

            <span class="n">auc_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s2">"imputation"</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">"imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">auc_list</span><span class="p">))],</span>
                <span class="s2">"AUC"</span><span class="p">:</span> <span class="n">auc_list</span>
            <span class="p">})</span>
            <span class="n">auc_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">auc_df</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"mean"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">auc_list</span><span class="p">)</span> <span class="k">if</span> <span class="n">auc_list</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span>
            <span class="n">auc_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"auc_scores.xlsx"</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Composite PS + AUC saved for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No valid PS scores generated for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># ---------- Run ----------</span>
<span class="n">run_xgboost_ps_modeling</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre> Running PS estimation for SubSubCat_Oxazepam
   Imp 1: AUC = 0.672, ROC saved.
   Imp 2: AUC = 0.653, ROC saved.
   Imp 3: AUC = 0.651, ROC saved.
   Imp 4: AUC = 0.652, ROC saved.
   Imp 5: AUC = 0.627, ROC saved.
 Composite PS + AUC saved for SubSubCat_Oxazepam
 Running PS estimation for SubSubCat_Diazepam
   Imp 1: AUC = 0.719, ROC saved.
   Imp 2: AUC = 0.723, ROC saved.
   Imp 3: AUC = 0.726, ROC saved.
   Imp 4: AUC = 0.746, ROC saved.
   Imp 5: AUC = 0.712, ROC saved.
 Composite PS + AUC saved for SubSubCat_Diazepam
 Running PS estimation for SubSubCat_Paracetamol
   Imp 1: AUC = 0.586, ROC saved.
   Imp 2: AUC = 0.618, ROC saved.
   Imp 3: AUC = 0.666, ROC saved.
   Imp 4: AUC = 0.689, ROC saved.
   Imp 5: AUC = 0.654, ROC saved.
 Composite PS + AUC saved for SubSubCat_Paracetamol
 Running PS estimation for SubSubCat_Lorazepam
   Imp 1: AUC = 0.682, ROC saved.
   Imp 2: AUC = 0.690, ROC saved.
   Imp 3: AUC = 0.686, ROC saved.
   Imp 4: AUC = 0.712, ROC saved.
   Imp 5: AUC = 0.650, ROC saved.
 Composite PS + AUC saved for SubSubCat_Lorazepam
 Running PS estimation for SubSubCat_Mirtazapine
   Imp 1: AUC = 0.643, ROC saved.
   Imp 2: AUC = 0.600, ROC saved.
   Imp 3: AUC = 0.624, ROC saved.
   Imp 4: AUC = 0.644, ROC saved.
   Imp 5: AUC = 0.650, ROC saved.
 Composite PS + AUC saved for SubSubCat_Mirtazapine
 Running PS estimation for SubSubCat_Escitalopram
   Imp 1: AUC = 0.503, ROC saved.
   Imp 2: AUC = 0.502, ROC saved.
   Imp 3: AUC = 0.494, ROC saved.
   Imp 4: AUC = 0.512, ROC saved.
   Imp 5: AUC = 0.543, ROC saved.
 Composite PS + AUC saved for SubSubCat_Escitalopram
 Running PS estimation for SubSubCat_Sertraline
   Imp 1: AUC = 0.682, ROC saved.
   Imp 2: AUC = 0.667, ROC saved.
   Imp 3: AUC = 0.697, ROC saved.
   Imp 4: AUC = 0.715, ROC saved.
   Imp 5: AUC = 0.690, ROC saved.
 Composite PS + AUC saved for SubSubCat_Sertraline
 Running PS estimation for SubSubCat_Temazepam
   Imp 1: AUC = 0.557, ROC saved.
   Imp 2: AUC = 0.553, ROC saved.
   Imp 3: AUC = 0.537, ROC saved.
   Imp 4: AUC = 0.461, ROC saved.
   Imp 5: AUC = 0.527, ROC saved.
 Composite PS + AUC saved for SubSubCat_Temazepam
 Running PS estimation for SubSubCat_Citalopram
   Imp 1: AUC = 0.636, ROC saved.
   Imp 2: AUC = 0.679, ROC saved.
   Imp 3: AUC = 0.635, ROC saved.
   Imp 4: AUC = 0.649, ROC saved.
   Imp 5: AUC = 0.657, ROC saved.
 Composite PS + AUC saved for SubSubCat_Citalopram
 Running PS estimation for SubSubCat_Quetiapine
   Imp 1: AUC = 0.783, ROC saved.
   Imp 2: AUC = 0.785, ROC saved.
   Imp 3: AUC = 0.787, ROC saved.
   Imp 4: AUC = 0.783, ROC saved.
   Imp 5: AUC = 0.772, ROC saved.
 Composite PS + AUC saved for SubSubCat_Quetiapine
 Running PS estimation for SubSubCat_Amitriptyline
   Imp 1: AUC = 0.578, ROC saved.
   Imp 2: AUC = 0.485, ROC saved.
   Imp 3: AUC = 0.527, ROC saved.
   Imp 4: AUC = 0.533, ROC saved.
   Imp 5: AUC = 0.584, ROC saved.
 Composite PS + AUC saved for SubSubCat_Amitriptyline
 Running PS estimation for SubSubCat_Venlafaxine
   Imp 1: AUC = 0.673, ROC saved.
   Imp 2: AUC = 0.703, ROC saved.
   Imp 3: AUC = 0.654, ROC saved.
   Imp 4: AUC = 0.679, ROC saved.
   Imp 5: AUC = 0.687, ROC saved.
 Composite PS + AUC saved for SubSubCat_Venlafaxine
 Running PS estimation for SubSubCat_Fluoxetine
   Imp 1: AUC = 0.690, ROC saved.
   Imp 2: AUC = 0.673, ROC saved.
   Imp 3: AUC = 0.688, ROC saved.
   Imp 4: AUC = 0.700, ROC saved.
   Imp 5: AUC = 0.721, ROC saved.
 Composite PS + AUC saved for SubSubCat_Fluoxetine
 Running PS estimation for SubSubCat_Topiramaat
   Imp 1: AUC = 0.754, ROC saved.
   Imp 2: AUC = 0.771, ROC saved.
   Imp 3: AUC = 0.779, ROC saved.
   Imp 4: AUC = 0.823, ROC saved.
   Imp 5: AUC = 0.803, ROC saved.
 Composite PS + AUC saved for SubSubCat_Topiramaat
 Running PS estimation for SubSubCat_Zopiclon
   Imp 1: AUC = 0.660, ROC saved.
   Imp 2: AUC = 0.646, ROC saved.
   Imp 3: AUC = 0.669, ROC saved.
   Imp 4: AUC = 0.673, ROC saved.
   Imp 5: AUC = 0.632, ROC saved.
 Composite PS + AUC saved for SubSubCat_Zopiclon
 Running PS estimation for SubSubCat_Bupropion
   Imp 1: AUC = 0.477, ROC saved.
   Imp 2: AUC = 0.537, ROC saved.
   Imp 3: AUC = 0.501, ROC saved.
   Imp 4: AUC = 0.524, ROC saved.
   Imp 5: AUC = 0.545, ROC saved.
 Composite PS + AUC saved for SubSubCat_Bupropion
 Running PS estimation for SubSubCat_Methylfenidaat
   Imp 1: AUC = 0.650, ROC saved.
   Imp 2: AUC = 0.654, ROC saved.
   Imp 3: AUC = 0.621, ROC saved.
   Imp 4: AUC = 0.700, ROC saved.
   Imp 5: AUC = 0.640, ROC saved.
 Composite PS + AUC saved for SubSubCat_Methylfenidaat
 Running PS estimation for SubSubCat_Olanzapine
   Imp 1: AUC = 0.595, ROC saved.
   Imp 2: AUC = 0.626, ROC saved.
   Imp 3: AUC = 0.625, ROC saved.
   Imp 4: AUC = 0.656, ROC saved.
   Imp 5: AUC = 0.621, ROC saved.
 Composite PS + AUC saved for SubSubCat_Olanzapine
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=72499bbd-b193-4443-8b30-450bd11aa408">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[81]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">xgboost</span> <span class="kn">import</span> <span class="n">XGBClassifier</span>

<span class="k">def</span> <span class="nf">compute_feature_importance</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Computing feature importance for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No covariates found for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">covariates</span> <span class="o">=</span> <span class="n">final_covariates_map</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
        <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"outputs"</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">importance_df_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df_imp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_imp</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> not in imputed dataset </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">X</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>

            <span class="c1"># Drop NaNs in treatment</span>
            <span class="n">valid_idx</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">index</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">XGBClassifier</span><span class="p">(</span><span class="n">use_label_encoder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eval_metric</span><span class="o">=</span><span class="s1">'logloss'</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
                <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>

                <span class="c1"># Get feature importance</span>
                <span class="n">importances</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_booster</span><span class="p">()</span><span class="o">.</span><span class="n">get_score</span><span class="p">(</span><span class="n">importance_type</span><span class="o">=</span><span class="s1">'gain'</span><span class="p">)</span>
                <span class="n">df_feat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">importances</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">'index'</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">"imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">])</span>
                <span class="n">df_feat</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">'feature'</span>
                <span class="n">importance_df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_feat</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   Error during modeling: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">importance_df_list</span><span class="p">:</span>
            <span class="c1"># Combine and average</span>
            <span class="n">all_feat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">importance_df_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">all_feat</span><span class="p">[</span><span class="s2">"mean_importance"</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_feat</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Filter top 30 non-zero</span>
            <span class="n">non_zero</span> <span class="o">=</span> <span class="n">all_feat</span><span class="p">[</span><span class="n">all_feat</span><span class="p">[</span><span class="s2">"mean_importance"</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">top30</span> <span class="o">=</span> <span class="n">non_zero</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">"mean_importance"</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>

            <span class="c1"># Save to CSV</span>
            <span class="n">top30</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"feature_importance.csv"</span><span class="p">))</span>

            <span class="c1"># Plot</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top30</span><span class="o">.</span><span class="n">index</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">top30</span><span class="p">[</span><span class="s2">"mean_importance"</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># plot top  bottom</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Mean Gain Importance"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Top 30 Feature Importance - </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"feature_importance_top30.png"</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Saved feature importance plot and CSV for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No valid models for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1">#  Run</span>
<span class="n">compute_feature_importance</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Computing feature importance for SubSubCat_Oxazepam
 Saved feature importance plot and CSV for SubSubCat_Oxazepam

 Computing feature importance for SubSubCat_Diazepam
 Saved feature importance plot and CSV for SubSubCat_Diazepam

 Computing feature importance for SubSubCat_Paracetamol
 Saved feature importance plot and CSV for SubSubCat_Paracetamol

 Computing feature importance for SubSubCat_Lorazepam
 Saved feature importance plot and CSV for SubSubCat_Lorazepam

 Computing feature importance for SubSubCat_Mirtazapine
 Saved feature importance plot and CSV for SubSubCat_Mirtazapine

 Computing feature importance for SubSubCat_Escitalopram
 Saved feature importance plot and CSV for SubSubCat_Escitalopram

 Computing feature importance for SubSubCat_Sertraline
 Saved feature importance plot and CSV for SubSubCat_Sertraline

 Computing feature importance for SubSubCat_Temazepam
 Saved feature importance plot and CSV for SubSubCat_Temazepam

 Computing feature importance for SubSubCat_Citalopram
 Saved feature importance plot and CSV for SubSubCat_Citalopram

 Computing feature importance for SubSubCat_Quetiapine
 Saved feature importance plot and CSV for SubSubCat_Quetiapine

 Computing feature importance for SubSubCat_Amitriptyline
 Saved feature importance plot and CSV for SubSubCat_Amitriptyline

 Computing feature importance for SubSubCat_Venlafaxine
 Saved feature importance plot and CSV for SubSubCat_Venlafaxine

 Computing feature importance for SubSubCat_Fluoxetine
 Saved feature importance plot and CSV for SubSubCat_Fluoxetine

 Computing feature importance for SubSubCat_Topiramaat
 Saved feature importance plot and CSV for SubSubCat_Topiramaat

 Computing feature importance for SubSubCat_Zopiclon
 Saved feature importance plot and CSV for SubSubCat_Zopiclon

 Computing feature importance for SubSubCat_Bupropion
 Saved feature importance plot and CSV for SubSubCat_Bupropion

 Computing feature importance for SubSubCat_Methylfenidaat
 Saved feature importance plot and CSV for SubSubCat_Methylfenidaat

 Computing feature importance for SubSubCat_Olanzapine
 Saved feature importance plot and CSV for SubSubCat_Olanzapine
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=f765c036-655f-4b4b-abee-ae90a001eb24">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[82]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="k">def</span> <span class="nf">compute_trimmed_clipped_iptw</span><span class="p">(</span><span class="n">ps_df</span><span class="p">,</span> <span class="n">treatment</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">clip_max</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">keep_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">ps_df</span> <span class="o">&gt;</span> <span class="n">lower</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ps_df</span> <span class="o">&lt;</span> <span class="n">upper</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ps_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">ps</span> <span class="o">=</span> <span class="n">ps_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">lower</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">1e-6</span><span class="p">)</span>  <span class="c1"># avoid div by zero</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">keep_mask</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">ps</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="n">w</span><span class="p">[</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">treatment</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">ps</span><span class="p">[</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">treatment</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="n">w</span><span class="p">[</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">treatment</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ps</span><span class="p">[</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">treatment</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)])</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">upper</span><span class="o">=</span><span class="n">clip_max</span><span class="p">)</span>
        <span class="n">weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">apply_rubins_rule_to_iptw</span><span class="p">(</span><span class="n">iptw_matrix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Given an IPTW matrix (n rows  M imputations), return Rubins rule pooled mean, SD, SE.</span>
<span class="sd">    """</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">q_bar</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">u_bar</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">total_var</span> <span class="o">=</span> <span class="n">u_bar</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">M</span><span class="p">)</span> <span class="o">*</span> <span class="n">B</span>
    <span class="n">total_se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">total_var</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">q_bar</span><span class="p">,</span> <span class="n">u_bar</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">total_se</span>


<span class="k">def</span> <span class="nf">run_trim_clip_save_all</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Processing IPTW + trimming + clipping for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"outputs"</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">ps_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"propensity_scores.xlsx"</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ps_path</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Missing PS file: </span><span class="si">{</span><span class="n">ps_path</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ps_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">ps_path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">ps_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">ps_all</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"ps_imp"</span><span class="p">)]</span>
            <span class="n">composite_index</span> <span class="o">=</span> <span class="n">ps_all</span><span class="o">.</span><span class="n">index</span>

            <span class="c1"># Get treatment from one imputed dataset</span>
            <span class="n">T_full</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">imputed_dfs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">T_full</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">composite_index</span><span class="p">,</span> <span class="n">group</span><span class="p">]</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="n">T_full</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Treatment column </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> not found in any imputed dataset."</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Compute IPTW matrix (shape: n  M)</span>
            <span class="n">iptw_matrix</span> <span class="o">=</span> <span class="n">compute_trimmed_clipped_iptw</span><span class="p">(</span><span class="n">ps_all</span><span class="p">[</span><span class="n">ps_cols</span><span class="p">],</span> <span class="n">T_full</span><span class="p">)</span>
            <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">"iptw_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iptw_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>

            <span class="c1"># Apply Rubins Rule for mean, SD, SE</span>
            <span class="n">iptw_matrix</span><span class="p">[</span><span class="s2">"iptw_mean"</span><span class="p">],</span> <span class="n">iptw_matrix</span><span class="p">[</span><span class="s2">"iptw_sd"</span><span class="p">],</span> <span class="n">iptw_matrix</span><span class="p">[</span><span class="s2">"iptw_se"</span><span class="p">]</span> <span class="o">=</span> <span class="n">apply_rubins_rule_to_iptw</span><span class="p">(</span>
                <span class="n">iptw_matrix</span><span class="p">[[</span><span class="sa">f</span><span class="s2">"iptw_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iptw_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]]</span>
            <span class="p">)</span>

            <span class="c1"># Save IPTW matrix separately</span>
            <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"iptw_weights.xlsx"</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Saved IPTW weights for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

            <span class="c1"># Save trimmed &amp; clipped imputed datasets with IPTW</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">imputed_dfs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">trimmed_idx</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="n">needed_cols</span> <span class="o">=</span> <span class="n">final_covariates_map</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">group</span><span class="p">,</span> <span class="s2">"caps5_change_baseline"</span><span class="p">]</span>

                <span class="c1"># Select only necessary columns</span>
                <span class="n">df_trimmed</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">trimmed_idx</span><span class="p">,</span> <span class="n">needed_cols</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">df_trimmed</span><span class="p">[</span><span class="s2">"iptw"</span><span class="p">]</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="p">[</span><span class="sa">f</span><span class="s2">"iptw_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">trimmed_idx</span><span class="p">]</span>

                <span class="c1">#  DROP rows with missing IPTW values</span>
                <span class="n">before</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_trimmed</span><span class="p">)</span>
                <span class="n">df_trimmed</span> <span class="o">=</span> <span class="n">df_trimmed</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">"iptw"</span><span class="p">])</span>
                <span class="n">after</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_trimmed</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"     Retained </span><span class="si">{</span><span class="n">after</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">before</span><span class="si">}</span><span class="s2"> rows after IPTW NaN drop."</span><span class="p">)</span>

                <span class="c1"># Save to .pkl</span>
                <span class="n">df_trimmed</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"trimmed_data_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.pkl"</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   Saved trimmed dataset: </span><span class="si">{</span><span class="n">output_folder</span><span class="si">}</span><span class="s2">/trimmed_data_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.*"</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>


<span class="n">run_trim_clip_save_all</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Processing IPTW + trimming + clipping for SubSubCat_Oxazepam
 Saved IPTW weights for SubSubCat_Oxazepam
     Retained 610/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Oxazepam/trimmed_data_imp1.*
     Retained 576/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Oxazepam/trimmed_data_imp2.*
     Retained 603/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Oxazepam/trimmed_data_imp3.*
     Retained 578/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Oxazepam/trimmed_data_imp4.*
     Retained 584/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Oxazepam/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SubSubCat_Diazepam
 Saved IPTW weights for SubSubCat_Diazepam
     Retained 88/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Diazepam/trimmed_data_imp1.*
     Retained 95/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Diazepam/trimmed_data_imp2.*
     Retained 99/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Diazepam/trimmed_data_imp3.*
     Retained 90/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Diazepam/trimmed_data_imp4.*
     Retained 101/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Diazepam/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SubSubCat_Paracetamol
 Saved IPTW weights for SubSubCat_Paracetamol
     Retained 78/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Paracetamol/trimmed_data_imp1.*
     Retained 76/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Paracetamol/trimmed_data_imp2.*
     Retained 67/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Paracetamol/trimmed_data_imp3.*
     Retained 62/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Paracetamol/trimmed_data_imp4.*
     Retained 68/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Paracetamol/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SubSubCat_Lorazepam
 Saved IPTW weights for SubSubCat_Lorazepam
     Retained 127/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Lorazepam/trimmed_data_imp1.*
     Retained 148/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Lorazepam/trimmed_data_imp2.*
     Retained 147/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Lorazepam/trimmed_data_imp3.*
     Retained 139/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Lorazepam/trimmed_data_imp4.*
     Retained 143/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Lorazepam/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SubSubCat_Mirtazapine
 Saved IPTW weights for SubSubCat_Mirtazapine
     Retained 154/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Mirtazapine/trimmed_data_imp1.*
     Retained 169/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Mirtazapine/trimmed_data_imp2.*
     Retained 174/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Mirtazapine/trimmed_data_imp3.*
     Retained 170/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Mirtazapine/trimmed_data_imp4.*
     Retained 164/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Mirtazapine/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SubSubCat_Escitalopram
 Saved IPTW weights for SubSubCat_Escitalopram
     Retained 142/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Escitalopram/trimmed_data_imp1.*
     Retained 149/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Escitalopram/trimmed_data_imp2.*
     Retained 156/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Escitalopram/trimmed_data_imp3.*
     Retained 152/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Escitalopram/trimmed_data_imp4.*
     Retained 144/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Escitalopram/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SubSubCat_Sertraline
 Saved IPTW weights for SubSubCat_Sertraline
     Retained 240/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Sertraline/trimmed_data_imp1.*
     Retained 261/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Sertraline/trimmed_data_imp2.*
     Retained 225/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Sertraline/trimmed_data_imp3.*
     Retained 263/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Sertraline/trimmed_data_imp4.*
     Retained 251/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Sertraline/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SubSubCat_Temazepam
 Saved IPTW weights for SubSubCat_Temazepam
     Retained 195/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Temazepam/trimmed_data_imp1.*
     Retained 200/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Temazepam/trimmed_data_imp2.*
     Retained 202/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Temazepam/trimmed_data_imp3.*
     Retained 203/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Temazepam/trimmed_data_imp4.*
     Retained 186/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Temazepam/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SubSubCat_Citalopram
 Saved IPTW weights for SubSubCat_Citalopram
     Retained 359/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Citalopram/trimmed_data_imp1.*
     Retained 345/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Citalopram/trimmed_data_imp2.*
     Retained 362/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Citalopram/trimmed_data_imp3.*
     Retained 333/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Citalopram/trimmed_data_imp4.*
     Retained 341/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Citalopram/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SubSubCat_Quetiapine
 Saved IPTW weights for SubSubCat_Quetiapine
     Retained 510/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Quetiapine/trimmed_data_imp1.*
     Retained 524/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Quetiapine/trimmed_data_imp2.*
     Retained 493/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Quetiapine/trimmed_data_imp3.*
     Retained 540/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Quetiapine/trimmed_data_imp4.*
     Retained 486/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Quetiapine/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SubSubCat_Amitriptyline
 Saved IPTW weights for SubSubCat_Amitriptyline
     Retained 107/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Amitriptyline/trimmed_data_imp1.*
     Retained 109/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Amitriptyline/trimmed_data_imp2.*
     Retained 102/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Amitriptyline/trimmed_data_imp3.*
     Retained 108/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Amitriptyline/trimmed_data_imp4.*
     Retained 101/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Amitriptyline/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SubSubCat_Venlafaxine
 Saved IPTW weights for SubSubCat_Venlafaxine
     Retained 121/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Venlafaxine/trimmed_data_imp1.*
     Retained 114/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Venlafaxine/trimmed_data_imp2.*
     Retained 109/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Venlafaxine/trimmed_data_imp3.*
     Retained 114/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Venlafaxine/trimmed_data_imp4.*
     Retained 120/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Venlafaxine/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SubSubCat_Fluoxetine
 Saved IPTW weights for SubSubCat_Fluoxetine
     Retained 147/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Fluoxetine/trimmed_data_imp1.*
     Retained 148/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Fluoxetine/trimmed_data_imp2.*
     Retained 137/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Fluoxetine/trimmed_data_imp3.*
     Retained 145/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Fluoxetine/trimmed_data_imp4.*
     Retained 152/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Fluoxetine/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SubSubCat_Topiramaat
 Saved IPTW weights for SubSubCat_Topiramaat
     Retained 75/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Topiramaat/trimmed_data_imp1.*
     Retained 81/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Topiramaat/trimmed_data_imp2.*
     Retained 74/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Topiramaat/trimmed_data_imp3.*
     Retained 69/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Topiramaat/trimmed_data_imp4.*
     Retained 72/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Topiramaat/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SubSubCat_Zopiclon
 Saved IPTW weights for SubSubCat_Zopiclon
     Retained 58/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Zopiclon/trimmed_data_imp1.*
     Retained 71/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Zopiclon/trimmed_data_imp2.*
     Retained 65/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Zopiclon/trimmed_data_imp3.*
     Retained 67/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Zopiclon/trimmed_data_imp4.*
     Retained 65/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Zopiclon/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SubSubCat_Bupropion
 Saved IPTW weights for SubSubCat_Bupropion
     Retained 53/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Bupropion/trimmed_data_imp1.*
     Retained 62/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Bupropion/trimmed_data_imp2.*
     Retained 57/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Bupropion/trimmed_data_imp3.*
     Retained 62/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Bupropion/trimmed_data_imp4.*
     Retained 52/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Bupropion/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SubSubCat_Methylfenidaat
 Saved IPTW weights for SubSubCat_Methylfenidaat
     Retained 80/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Methylfenidaat/trimmed_data_imp1.*
     Retained 73/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Methylfenidaat/trimmed_data_imp2.*
     Retained 81/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Methylfenidaat/trimmed_data_imp3.*
     Retained 73/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Methylfenidaat/trimmed_data_imp4.*
     Retained 74/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Methylfenidaat/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SubSubCat_Olanzapine
 Saved IPTW weights for SubSubCat_Olanzapine
     Retained 59/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Olanzapine/trimmed_data_imp1.*
     Retained 58/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Olanzapine/trimmed_data_imp2.*
     Retained 59/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Olanzapine/trimmed_data_imp3.*
     Retained 62/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Olanzapine/trimmed_data_imp4.*
     Retained 58/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Olanzapine/trimmed_data_imp5.*
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=268b3d7e-ac3b-4300-9aeb-6089727c4787">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[83]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="k">def</span> <span class="nf">plot_ps_overlap_all_groups</span><span class="p">(</span><span class="n">medication_groups</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Plotting PS overlap for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="n">folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"outputs"</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">ps_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">"propensity_scores.xlsx"</span><span class="p">)</span>
        <span class="n">iptw_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">"iptw_weights.xlsx"</span><span class="p">)</span>
        <span class="n">trimmed_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">"trimmed_data_imp1.pkl"</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ps_file</span><span class="p">,</span> <span class="n">iptw_file</span><span class="p">,</span> <span class="n">trimmed_file</span><span class="p">]):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Missing required files for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ps_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">ps_file</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">iptw_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">iptw_file</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">trimmed_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">trimmed_file</span><span class="p">)</span>

            <span class="c1"># Extract</span>
            <span class="n">ps</span> <span class="o">=</span> <span class="n">ps_df</span><span class="p">[</span><span class="s2">"composite_ps"</span><span class="p">]</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">trimmed_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">iptw_df</span><span class="p">[</span><span class="s2">"iptw_mean"</span><span class="p">]</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">trimmed_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">trimmed_df</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>

            <span class="c1"># Masks to remove NaNs</span>
            <span class="n">treated_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ps</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">w</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
            <span class="n">control_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ps</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">w</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>

            <span class="n">treated</span> <span class="o">=</span> <span class="n">ps</span><span class="p">[</span><span class="n">treated_mask</span><span class="p">]</span>
            <span class="n">treated_w</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="n">treated_mask</span><span class="p">]</span>

            <span class="n">control</span> <span class="o">=</span> <span class="n">ps</span><span class="p">[</span><span class="n">control_mask</span><span class="p">]</span>
            <span class="n">control_w</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="n">control_mask</span><span class="p">]</span>

            <span class="c1"># === Unweighted Plot ===</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">([</span><span class="n">treated</span><span class="p">,</span> <span class="n">control</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="p">[</span><span class="s2">"Treated"</span><span class="p">,</span> <span class="s2">"Control"</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Unweighted PS Overlap - </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Composite Propensity Score"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"Count"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">"ps_overlap_unweighted.png"</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="c1"># === Weighted Plot ===</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">([</span><span class="n">treated</span><span class="p">,</span> <span class="n">control</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="p">[</span><span class="n">treated_w</span><span class="p">,</span> <span class="n">control_w</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="p">[</span><span class="s2">"Treated"</span><span class="p">,</span> <span class="s2">"Control"</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Weighted PS Overlap - </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Composite Propensity Score"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"Weighted Count"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">"ps_overlap_weighted.png"</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Saved unweighted and weighted PS plots for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error processing </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1">#  Run</span>
<span class="n">plot_ps_overlap_all_groups</span><span class="p">(</span><span class="n">medication_groups</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Plotting PS overlap for SubSubCat_Oxazepam
 Saved unweighted and weighted PS plots for SubSubCat_Oxazepam

 Plotting PS overlap for SubSubCat_Diazepam
 Saved unweighted and weighted PS plots for SubSubCat_Diazepam

 Plotting PS overlap for SubSubCat_Paracetamol
 Saved unweighted and weighted PS plots for SubSubCat_Paracetamol

 Plotting PS overlap for SubSubCat_Lorazepam
 Saved unweighted and weighted PS plots for SubSubCat_Lorazepam

 Plotting PS overlap for SubSubCat_Mirtazapine
 Saved unweighted and weighted PS plots for SubSubCat_Mirtazapine

 Plotting PS overlap for SubSubCat_Escitalopram
 Saved unweighted and weighted PS plots for SubSubCat_Escitalopram

 Plotting PS overlap for SubSubCat_Sertraline
 Saved unweighted and weighted PS plots for SubSubCat_Sertraline

 Plotting PS overlap for SubSubCat_Temazepam
 Saved unweighted and weighted PS plots for SubSubCat_Temazepam

 Plotting PS overlap for SubSubCat_Citalopram
 Saved unweighted and weighted PS plots for SubSubCat_Citalopram

 Plotting PS overlap for SubSubCat_Quetiapine
 Saved unweighted and weighted PS plots for SubSubCat_Quetiapine

 Plotting PS overlap for SubSubCat_Amitriptyline
 Saved unweighted and weighted PS plots for SubSubCat_Amitriptyline

 Plotting PS overlap for SubSubCat_Venlafaxine
 Saved unweighted and weighted PS plots for SubSubCat_Venlafaxine

 Plotting PS overlap for SubSubCat_Fluoxetine
 Saved unweighted and weighted PS plots for SubSubCat_Fluoxetine

 Plotting PS overlap for SubSubCat_Topiramaat
 Saved unweighted and weighted PS plots for SubSubCat_Topiramaat

 Plotting PS overlap for SubSubCat_Zopiclon
 Saved unweighted and weighted PS plots for SubSubCat_Zopiclon

 Plotting PS overlap for SubSubCat_Bupropion
 Saved unweighted and weighted PS plots for SubSubCat_Bupropion

 Plotting PS overlap for SubSubCat_Methylfenidaat
 Saved unweighted and weighted PS plots for SubSubCat_Methylfenidaat

 Plotting PS overlap for SubSubCat_Olanzapine
 Saved unweighted and weighted PS plots for SubSubCat_Olanzapine
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=1bd15f13-2739-42d0-9532-0904b6f03336">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[84]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># Set up base output folder</span>
<span class="n">output_base</span> <span class="o">=</span> <span class="s2">"outputs"</span>
<span class="n">ps_file</span> <span class="o">=</span> <span class="s2">"propensity_scores.xlsx"</span>
<span class="n">iptw_file</span> <span class="o">=</span> <span class="s2">"iptw_weights.xlsx"</span>
<span class="n">trimmed_data_file</span> <span class="o">=</span> <span class="s2">"trimmed_data_imp1.pkl"</span>

<span class="c1"># Collect all treatment group folders</span>
<span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">medication_groups</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">g</span><span class="p">))]</span>

<span class="c1"># Generate 4-panel overlap plots</span>
<span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
    <span class="n">group_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Load trimmed treatment info</span>
        <span class="n">trimmed_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="n">trimmed_data_file</span><span class="p">))</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">trimmed_df</span><span class="o">.</span><span class="n">index</span>

        <span class="c1"># Fix: case-insensitive match for treatment variable</span>
        <span class="n">possible_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">trimmed_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">group</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">possible_cols</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Treatment variable </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> not found in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">, skipping."</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">treatment_var</span> <span class="o">=</span> <span class="n">possible_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">trimmed_df</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span>

        <span class="c1"># Load composite PS (aligned to trimmed_df index)</span>
        <span class="n">ps_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="n">ps_file</span><span class="p">),</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">'composite_ps'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ps_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Composite column missing in </span><span class="si">{</span><span class="n">ps_file</span><span class="si">}</span><span class="s2">, skipping </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">."</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">ps</span> <span class="o">=</span> <span class="n">ps_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s1">'composite_ps'</span><span class="p">]</span>

        <span class="c1"># Load IPTW weights (aligned to trimmed_df index)</span>
        <span class="n">weights_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="n">iptw_file</span><span class="p">),</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">'iptw_mean'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">weights_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" IPTW weight column missing in </span><span class="si">{</span><span class="n">iptw_file</span><span class="si">}</span><span class="s2">, skipping </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">."</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">weights_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s1">'iptw_mean'</span><span class="p">]</span>

        <span class="c1"># Prepare 4 datasets</span>
        <span class="n">raw_treated</span> <span class="o">=</span> <span class="n">ps</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">raw_control</span> <span class="o">=</span> <span class="n">ps</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">weighted_treated</span> <span class="o">=</span> <span class="p">(</span><span class="n">ps</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">],</span> <span class="n">weights</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">weighted_control</span> <span class="o">=</span> <span class="p">(</span><span class="n">ps</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">],</span> <span class="n">weights</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Create plot</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Propensity Score Distribution - </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">raw_treated</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'blue'</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Raw Treated"</span><span class="p">)</span>

        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">raw_control</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'green'</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Raw Control"</span><span class="p">)</span>

        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">weighted_treated</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weighted_treated</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'blue'</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Weighted Treated"</span><span class="p">)</span>

        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">weighted_control</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weighted_control</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'green'</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Weighted Control"</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="o">.</span><span class="n">flat</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Propensity Score"</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Count"</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">])</span>

        <span class="c1"># Save figure</span>
        <span class="n">plot_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"four_panel_overlap_</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">.png"</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_path</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Saved: </span><span class="si">{</span><span class="n">plot_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>  Saved: outputs\SubSubCat_Oxazepam\four_panel_overlap_SubSubCat_Oxazepam.png
  Saved: outputs\SubSubCat_Diazepam\four_panel_overlap_SubSubCat_Diazepam.png
  Saved: outputs\SubSubCat_Paracetamol\four_panel_overlap_SubSubCat_Paracetamol.png
  Saved: outputs\SubSubCat_Lorazepam\four_panel_overlap_SubSubCat_Lorazepam.png
  Saved: outputs\SubSubCat_Mirtazapine\four_panel_overlap_SubSubCat_Mirtazapine.png
  Saved: outputs\SubSubCat_Escitalopram\four_panel_overlap_SubSubCat_Escitalopram.png
  Saved: outputs\SubSubCat_Sertraline\four_panel_overlap_SubSubCat_Sertraline.png
  Saved: outputs\SubSubCat_Temazepam\four_panel_overlap_SubSubCat_Temazepam.png
  Saved: outputs\SubSubCat_Citalopram\four_panel_overlap_SubSubCat_Citalopram.png
  Saved: outputs\SubSubCat_Quetiapine\four_panel_overlap_SubSubCat_Quetiapine.png
  Saved: outputs\SubSubCat_Amitriptyline\four_panel_overlap_SubSubCat_Amitriptyline.png
  Saved: outputs\SubSubCat_Venlafaxine\four_panel_overlap_SubSubCat_Venlafaxine.png
  Saved: outputs\SubSubCat_Fluoxetine\four_panel_overlap_SubSubCat_Fluoxetine.png
  Saved: outputs\SubSubCat_Topiramaat\four_panel_overlap_SubSubCat_Topiramaat.png
  Saved: outputs\SubSubCat_Zopiclon\four_panel_overlap_SubSubCat_Zopiclon.png
  Saved: outputs\SubSubCat_Bupropion\four_panel_overlap_SubSubCat_Bupropion.png
  Saved: outputs\SubSubCat_Methylfenidaat\four_panel_overlap_SubSubCat_Methylfenidaat.png
  Saved: outputs\SubSubCat_Olanzapine\four_panel_overlap_SubSubCat_Olanzapine.png
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=35e9e7aa-87a4-4cba-bfcd-245fd505fec4">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[85]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># ATT calculation:</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=37ecf92b-090c-4b5f-8a78-cc19d881e434">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[86]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Weighted:</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=31fa2d03-12f9-4dc4-b4d1-06ce5b1731cd">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[87]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">GradientBoostingRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">r2_score</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">KFold</span>
<span class="kn">from</span> <span class="nn">econml.dml</span> <span class="kn">import</span> <span class="n">LinearDML</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">t</span><span class="p">,</span> <span class="n">probplot</span>
<span class="kn">import</span> <span class="nn">xgboost</span> <span class="k">as</span> <span class="nn">xgb</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Configuration</span>
<span class="c1"># -----------------------------</span>
<span class="n">n_repeats</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">seeds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span>
<span class="n">imputations</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">output_folder</span> <span class="o">=</span> <span class="s2">"outputs"</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Diagnostic Plotting Function</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">create_diagnostic_plots</span><span class="p">(</span><span class="n">residuals_data</span><span class="p">,</span> <span class="n">fitted_data</span><span class="p">,</span> <span class="n">group_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Create 4 diagnostic plots for model validation"""</span>
    <span class="n">plots_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"plots"</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">plots_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Flatten the collected data</span>
    <span class="n">all_residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">residuals_data</span><span class="p">)</span>
    <span class="n">all_fitted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">fitted_data</span><span class="p">)</span>
    
    <span class="c1"># Create figure with 2x2 subplots</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Diagnostic Plots - </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">'bold'</span><span class="p">)</span>
    
    <span class="c1"># 1. Residuals vs Fitted</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">all_fitted</span><span class="p">,</span> <span class="n">all_residuals</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Fitted Values'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Residuals'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Residuals vs Fitted'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># 2. QQ Plot</span>
    <span class="n">probplot</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s2">"norm"</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Q-Q Plot (Normal)'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># 3. Residual Histogram</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'skyblue'</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">'black'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Residuals'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Density'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Residual Distribution'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># 4. Scale-Location Plot</span>
    <span class="n">sqrt_abs_residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">))</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">all_fitted</span><span class="p">,</span> <span class="n">sqrt_abs_residuals</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Fitted Values'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'|Residuals|'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Scale-Location Plot'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    
    <span class="c1"># Save plot</span>
    <span class="n">plot_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plots_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s1">.png'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_filename</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">'tight'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Diagnostic plots saved for </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Rubin's Rule</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">rubins_pool</span><span class="p">(</span><span class="n">estimates</span><span class="p">,</span> <span class="n">ses</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">estimates</span><span class="p">)</span>
    <span class="n">q_bar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">estimates</span><span class="p">)</span>
    <span class="n">u_bar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">ses</span><span class="p">))</span>
    <span class="n">b_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">estimates</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">total_var</span> <span class="o">=</span> <span class="n">u_bar</span> <span class="o">+</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">b_m</span><span class="p">)</span>
    <span class="n">total_se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">total_var</span><span class="p">)</span>
    <span class="n">ci_lower</span> <span class="o">=</span> <span class="n">q_bar</span> <span class="o">-</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">total_se</span>
    <span class="n">ci_upper</span> <span class="o">=</span> <span class="n">q_bar</span> <span class="o">+</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">total_se</span>
    <span class="n">p_value</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">q_bar</span> <span class="o">/</span> <span class="n">total_se</span><span class="p">),</span> <span class="n">df</span><span class="o">=</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">rounded_p</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">p_value</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">formatted_p</span> <span class="o">=</span> <span class="s2">"&lt; 0.00001"</span> <span class="k">if</span> <span class="n">rounded_p</span> <span class="o">&lt;=</span> <span class="mf">0.00001</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">rounded_p</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">return</span> <span class="n">q_bar</span><span class="p">,</span> <span class="n">total_se</span><span class="p">,</span> <span class="n">ci_lower</span><span class="p">,</span> <span class="n">ci_upper</span><span class="p">,</span> <span class="n">formatted_p</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># SMD + Variance Ratio</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">calculate_smd_vr</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
    <span class="n">treated</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">control</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">w_treated</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">w_control</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">smd</span><span class="p">,</span> <span class="n">vr</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m1</span><span class="p">,</span> <span class="n">m0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">treated</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">w_treated</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">control</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">w_control</span><span class="p">)</span>
            <span class="n">s1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">((</span><span class="n">treated</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">-</span> <span class="n">m1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w_treated</span><span class="p">))</span>
            <span class="n">s0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">((</span><span class="n">control</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">-</span> <span class="n">m0</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w_control</span><span class="p">))</span>
            <span class="n">pooled_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">s1</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">s0</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">smd</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">m1</span> <span class="o">-</span> <span class="n">m0</span><span class="p">)</span> <span class="o">/</span> <span class="n">pooled_sd</span> <span class="k">if</span> <span class="n">pooled_sd</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">vr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s1</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">s0</span><span class="o">**</span><span class="mi">2</span> <span class="k">if</span> <span class="n">s0</span><span class="o">**</span><span class="mi">2</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">smd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">vr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">smd</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">vr</span><span class="p">)</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># DML Main Loop</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">run_dml_with_trimmed_data</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="p">):</span>
    <span class="n">att_results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">balance_results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">covariates</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Running DML for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">group_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">group_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">best_result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">best_se</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">"inf"</span><span class="p">)</span>
        
        <span class="c1"># Initialize lists to collect residuals and fitted values for diagnostic plots</span>
        <span class="n">group_residuals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">group_fitted</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="n">seeds</span><span class="p">:</span>
            <span class="n">att_list</span><span class="p">,</span> <span class="n">se_list</span><span class="p">,</span> <span class="n">r2_list</span><span class="p">,</span> <span class="n">rmse_list</span><span class="p">,</span> <span class="n">smd_list</span><span class="p">,</span> <span class="n">vr_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">imp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">imputations</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"trimmed_data_imp</span><span class="si">{</span><span class="n">imp</span><span class="si">}</span><span class="s2">.pkl"</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">or</span> <span class="s2">"iptw"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">T</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
                <span class="n">Y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">"caps5_change_baseline"</span><span class="p">]</span>
                <span class="n">W</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">"iptw"</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">repeat</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_repeats</span><span class="p">):</span>
                    <span class="n">kf</span> <span class="o">=</span> <span class="n">KFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span> <span class="o">+</span> <span class="n">repeat</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">train_idx</span><span class="p">,</span> <span class="n">test_idx</span> <span class="ow">in</span> <span class="n">kf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">X_train</span><span class="p">,</span> <span class="n">T_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">W_train</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span>
                                <span class="n">T</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span>
                                <span class="n">Y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span>
                                <span class="n">W</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span>
                            <span class="p">)</span>

                            <span class="n">model_y</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
                            <span class="n">model_t</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                        <span class="n">use_label_encoder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eval_metric</span><span class="o">=</span><span class="s2">"logloss"</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>

                            <span class="n">dml</span> <span class="o">=</span> <span class="n">LinearDML</span><span class="p">(</span><span class="n">model_y</span><span class="o">=</span><span class="n">model_y</span><span class="p">,</span> <span class="n">model_t</span><span class="o">=</span><span class="n">model_t</span><span class="p">,</span> <span class="n">discrete_treatment</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                            <span class="n">cv</span><span class="o">=</span><span class="n">KFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">),</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
                            <span class="n">dml</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Y_train</span><span class="p">,</span> <span class="n">T_train</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">X_train</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="n">W_train</span><span class="p">)</span>

                            <span class="n">tau</span> <span class="o">=</span> <span class="n">dml</span><span class="o">.</span><span class="n">effect</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
                            <span class="n">att</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span>
                            <span class="n">influence</span> <span class="o">=</span> <span class="n">tau</span> <span class="o">-</span> <span class="n">att</span>
                            <span class="n">se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">influence</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">tau</span><span class="p">))</span>

                            <span class="n">att_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">att</span><span class="p">)</span>
                            <span class="n">se_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">se</span><span class="p">)</span>

                            <span class="n">Y_pred</span> <span class="o">=</span> <span class="n">model_y</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="n">W_train</span><span class="p">)</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
                            <span class="n">residuals</span> <span class="o">=</span> <span class="n">Y_train</span> <span class="o">-</span> <span class="n">Y_pred</span>
                            <span class="n">rmse</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_pred</span><span class="p">,</span> <span class="n">squared</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                            <span class="n">r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_pred</span><span class="p">)</span>
                            <span class="n">r2_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
                            <span class="n">rmse_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rmse</span><span class="p">)</span>
                            
                            <span class="c1"># Collect residuals and fitted values for diagnostic plots</span>
                            <span class="n">group_residuals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">residuals</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                            <span class="n">group_fitted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Y_pred</span><span class="p">)</span>

                            <span class="n">smd</span><span class="p">,</span> <span class="n">vr</span> <span class="o">=</span> <span class="n">calculate_smd_vr</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">T_train</span><span class="p">,</span> <span class="n">W_train</span><span class="p">)</span>
                            <span class="n">smd_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smd</span><span class="p">)</span>
                            <span class="n">vr_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vr</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">, seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">, imp </span><span class="si">{</span><span class="n">imp</span><span class="si">}</span><span class="s2">, rep </span><span class="si">{</span><span class="n">repeat</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">att_list</span><span class="p">:</span>
                <span class="n">att</span><span class="p">,</span> <span class="n">se</span><span class="p">,</span> <span class="n">ci_l</span><span class="p">,</span> <span class="n">ci_u</span><span class="p">,</span> <span class="n">p_val</span> <span class="o">=</span> <span class="n">rubins_pool</span><span class="p">(</span><span class="n">att_list</span><span class="p">,</span> <span class="n">se_list</span><span class="p">)</span>
                <span class="n">avg_r2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">r2_list</span><span class="p">)</span>
                <span class="n">avg_rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rmse_list</span><span class="p">)</span>
                <span class="n">avg_smd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">smd_list</span><span class="p">)</span>
                <span class="n">avg_vr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">vr_list</span><span class="p">)</span>

                <span class="n">balance_results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">"group"</span><span class="p">:</span> <span class="n">group</span><span class="p">,</span> <span class="s2">"seed"</span><span class="p">:</span> <span class="n">seed</span><span class="p">,</span> <span class="s2">"smd"</span><span class="p">:</span> <span class="n">avg_smd</span><span class="p">,</span> <span class="s2">"vr"</span><span class="p">:</span> <span class="n">avg_vr</span>
                <span class="p">})</span>

                <span class="k">if</span> <span class="n">se</span> <span class="o">&lt;</span> <span class="n">best_se</span><span class="p">:</span>
                    <span class="n">best_se</span> <span class="o">=</span> <span class="n">se</span>
                    <span class="n">best_result</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">"group"</span><span class="p">:</span> <span class="n">group</span><span class="p">,</span> <span class="s2">"seed"</span><span class="p">:</span> <span class="n">seed</span><span class="p">,</span> <span class="s2">"att"</span><span class="p">:</span> <span class="n">att</span><span class="p">,</span> <span class="s2">"se"</span><span class="p">:</span> <span class="n">se</span><span class="p">,</span>
                        <span class="s2">"ci_lower"</span><span class="p">:</span> <span class="n">ci_l</span><span class="p">,</span> <span class="s2">"ci_upper"</span><span class="p">:</span> <span class="n">ci_u</span><span class="p">,</span> <span class="s2">"p_value"</span><span class="p">:</span> <span class="n">p_val</span><span class="p">,</span>
                        <span class="s2">"r2"</span><span class="p">:</span> <span class="n">avg_r2</span><span class="p">,</span> <span class="s2">"rmse"</span><span class="p">:</span> <span class="n">avg_rmse</span>
                    <span class="p">}</span>

                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> | Seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">: ATT = </span><span class="si">{</span><span class="n">att</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, SE = </span><span class="si">{</span><span class="n">se</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, p = </span><span class="si">{</span><span class="n">p_val</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No valid results for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> | Seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Create diagnostic plots for this group</span>
        <span class="k">if</span> <span class="n">group_residuals</span> <span class="ow">and</span> <span class="n">group_fitted</span><span class="p">:</span>
            <span class="n">create_diagnostic_plots</span><span class="p">(</span><span class="n">group_residuals</span><span class="p">,</span> <span class="n">group_fitted</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">best_result</span><span class="p">:</span>
            <span class="n">att_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">best_result</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Best result for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">  Seed </span><span class="si">{</span><span class="n">best_result</span><span class="p">[</span><span class="s1">'seed'</span><span class="p">]</span><span class="si">}</span><span class="s2"> | SE = </span><span class="si">{</span><span class="n">best_result</span><span class="p">[</span><span class="s1">'se'</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="c1"># Save final output</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">att_results</span><span class="p">)</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">"dml_rubin_summary_subsubcats.xlsx"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">balance_results</span><span class="p">)</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">"smd_vr_summary_subsubcats.xlsx"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> All summary files saved."</span><span class="p">)</span>

<span class="n">run_dml_with_trimmed_data</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Running DML for SubSubCat_Oxazepam
 SubSubCat_Oxazepam | Seed 1: ATT = 0.6527, SE = 1.3843, p = 0.63834
 SubSubCat_Oxazepam | Seed 2: ATT = 0.7134, SE = 1.4110, p = 0.61426
 SubSubCat_Oxazepam | Seed 3: ATT = 0.6063, SE = 1.5022, p = 0.68737
 SubSubCat_Oxazepam | Seed 4: ATT = 0.6071, SE = 1.4114, p = 0.66800
 SubSubCat_Oxazepam | Seed 5: ATT = 0.6610, SE = 1.4360, p = 0.64630
 SubSubCat_Oxazepam | Seed 6: ATT = 0.5329, SE = 1.4188, p = 0.70803
 SubSubCat_Oxazepam | Seed 7: ATT = 0.6002, SE = 1.3367, p = 0.65441
 SubSubCat_Oxazepam | Seed 8: ATT = 0.4871, SE = 1.5357, p = 0.75176
 SubSubCat_Oxazepam | Seed 9: ATT = 0.6092, SE = 1.4326, p = 0.67160
 SubSubCat_Oxazepam | Seed 10: ATT = 0.6056, SE = 1.4057, p = 0.66755
 Diagnostic plots saved for SubSubCat_Oxazepam
 Best result for SubSubCat_Oxazepam  Seed 7 | SE = 1.3367

 Running DML for SubSubCat_Diazepam
 SubSubCat_Diazepam | Seed 1: ATT = -1.3232, SE = 3.7871, p = 0.72754
 SubSubCat_Diazepam | Seed 2: ATT = -1.4191, SE = 4.1503, p = 0.73313
 SubSubCat_Diazepam | Seed 3: ATT = -1.3169, SE = 3.7653, p = 0.72728
 SubSubCat_Diazepam | Seed 4: ATT = -1.4382, SE = 4.0496, p = 0.72325
 SubSubCat_Diazepam | Seed 5: ATT = -1.1518, SE = 4.0410, p = 0.77622
 SubSubCat_Diazepam | Seed 6: ATT = -1.1376, SE = 3.5616, p = 0.75009
 SubSubCat_Diazepam | Seed 7: ATT = -1.3825, SE = 3.3470, p = 0.68045
 SubSubCat_Diazepam | Seed 8: ATT = -1.0571, SE = 3.4623, p = 0.76076
 SubSubCat_Diazepam | Seed 9: ATT = -0.8227, SE = 3.9887, p = 0.83702
 SubSubCat_Diazepam | Seed 10: ATT = -1.0244, SE = 3.4116, p = 0.76459
 Diagnostic plots saved for SubSubCat_Diazepam
 Best result for SubSubCat_Diazepam  Seed 7 | SE = 3.3470

 Running DML for SubSubCat_Paracetamol
 SubSubCat_Paracetamol | Seed 1: ATT = 2.0393, SE = 4.3711, p = 0.64185
 SubSubCat_Paracetamol | Seed 2: ATT = 2.7907, SE = 4.2355, p = 0.51150
 SubSubCat_Paracetamol | Seed 3: ATT = 2.8694, SE = 4.5707, p = 0.53159
 SubSubCat_Paracetamol | Seed 4: ATT = 2.1570, SE = 4.4108, p = 0.62591
 SubSubCat_Paracetamol | Seed 5: ATT = 2.4375, SE = 4.3892, p = 0.57991
 SubSubCat_Paracetamol | Seed 6: ATT = 2.3889, SE = 4.5852, p = 0.60354
 SubSubCat_Paracetamol | Seed 7: ATT = 2.5179, SE = 4.8509, p = 0.60488
 SubSubCat_Paracetamol | Seed 8: ATT = 2.3308, SE = 4.6639, p = 0.61836
 SubSubCat_Paracetamol | Seed 9: ATT = 2.3820, SE = 4.8038, p = 0.62109
 SubSubCat_Paracetamol | Seed 10: ATT = 2.3697, SE = 4.8779, p = 0.62818
 Diagnostic plots saved for SubSubCat_Paracetamol
 Best result for SubSubCat_Paracetamol  Seed 2 | SE = 4.2355

 Running DML for SubSubCat_Lorazepam
 SubSubCat_Lorazepam | Seed 1: ATT = 1.1563, SE = 3.0307, p = 0.70362
 SubSubCat_Lorazepam | Seed 2: ATT = 0.8529, SE = 2.9947, p = 0.77639
 SubSubCat_Lorazepam | Seed 3: ATT = 0.9185, SE = 3.2865, p = 0.78045
 SubSubCat_Lorazepam | Seed 4: ATT = 0.8674, SE = 3.1949, p = 0.78657
 SubSubCat_Lorazepam | Seed 5: ATT = 1.3621, SE = 2.8281, p = 0.63112
 SubSubCat_Lorazepam | Seed 6: ATT = 0.9842, SE = 2.7087, p = 0.71713
 SubSubCat_Lorazepam | Seed 7: ATT = 0.8184, SE = 2.8787, p = 0.77678
 SubSubCat_Lorazepam | Seed 8: ATT = 0.6718, SE = 2.8390, p = 0.81343
 SubSubCat_Lorazepam | Seed 9: ATT = 0.9912, SE = 3.0773, p = 0.74805
 SubSubCat_Lorazepam | Seed 10: ATT = 0.5370, SE = 2.7393, p = 0.84498
 Diagnostic plots saved for SubSubCat_Lorazepam
 Best result for SubSubCat_Lorazepam  Seed 6 | SE = 2.7087

 Running DML for SubSubCat_Mirtazapine
 SubSubCat_Mirtazapine | Seed 1: ATT = 8.8453, SE = 2.9544, p = 0.00348
 SubSubCat_Mirtazapine | Seed 2: ATT = 8.7660, SE = 2.8774, p = 0.00297
 SubSubCat_Mirtazapine | Seed 3: ATT = 8.7492, SE = 2.7258, p = 0.00179
 SubSubCat_Mirtazapine | Seed 4: ATT = 8.5771, SE = 2.8307, p = 0.00312
 SubSubCat_Mirtazapine | Seed 5: ATT = 8.7557, SE = 2.9581, p = 0.00385
 SubSubCat_Mirtazapine | Seed 6: ATT = 8.6977, SE = 2.6920, p = 0.00168
 SubSubCat_Mirtazapine | Seed 7: ATT = 8.7939, SE = 3.0799, p = 0.00524
 SubSubCat_Mirtazapine | Seed 8: ATT = 8.8507, SE = 3.0207, p = 0.00421
 SubSubCat_Mirtazapine | Seed 9: ATT = 8.6696, SE = 2.9896, p = 0.00460
 SubSubCat_Mirtazapine | Seed 10: ATT = 8.4923, SE = 2.9715, p = 0.00520
 Diagnostic plots saved for SubSubCat_Mirtazapine
 Best result for SubSubCat_Mirtazapine  Seed 6 | SE = 2.6920

 Running DML for SubSubCat_Escitalopram
 SubSubCat_Escitalopram | Seed 1: ATT = 0.1966, SE = 2.4541, p = 0.93630
 SubSubCat_Escitalopram | Seed 2: ATT = 0.4981, SE = 2.5910, p = 0.84794
 SubSubCat_Escitalopram | Seed 3: ATT = 0.4340, SE = 2.7187, p = 0.87349
 SubSubCat_Escitalopram | Seed 4: ATT = 0.4350, SE = 2.6587, p = 0.87038
 SubSubCat_Escitalopram | Seed 5: ATT = 0.3349, SE = 2.3212, p = 0.88558
 SubSubCat_Escitalopram | Seed 6: ATT = 0.7932, SE = 2.3717, p = 0.73876
 SubSubCat_Escitalopram | Seed 7: ATT = 0.4450, SE = 2.4224, p = 0.85462
 SubSubCat_Escitalopram | Seed 8: ATT = 0.2534, SE = 2.6672, p = 0.92452
 SubSubCat_Escitalopram | Seed 9: ATT = 0.4624, SE = 2.4170, p = 0.84868
 SubSubCat_Escitalopram | Seed 10: ATT = 0.4433, SE = 2.5709, p = 0.86343
 Diagnostic plots saved for SubSubCat_Escitalopram
 Best result for SubSubCat_Escitalopram  Seed 5 | SE = 2.3212

 Running DML for SubSubCat_Sertraline
 SubSubCat_Sertraline | Seed 1: ATT = 0.5238, SE = 1.8419, p = 0.77671
 SubSubCat_Sertraline | Seed 2: ATT = 0.2312, SE = 1.9544, p = 0.90607
 SubSubCat_Sertraline | Seed 3: ATT = 0.3969, SE = 2.1489, p = 0.85383
 SubSubCat_Sertraline | Seed 4: ATT = 0.3160, SE = 1.8292, p = 0.86322
 SubSubCat_Sertraline | Seed 5: ATT = 0.3894, SE = 2.0592, p = 0.85038
 SubSubCat_Sertraline | Seed 6: ATT = 0.3213, SE = 1.7509, p = 0.85477
 SubSubCat_Sertraline | Seed 7: ATT = 0.3184, SE = 1.7735, p = 0.85787
 SubSubCat_Sertraline | Seed 8: ATT = 0.2716, SE = 1.7489, p = 0.87688
 SubSubCat_Sertraline | Seed 9: ATT = 0.2944, SE = 1.7014, p = 0.86298
 SubSubCat_Sertraline | Seed 10: ATT = 0.3241, SE = 1.7609, p = 0.85436
 Diagnostic plots saved for SubSubCat_Sertraline
 Best result for SubSubCat_Sertraline  Seed 9 | SE = 1.7014

 Running DML for SubSubCat_Temazepam
 SubSubCat_Temazepam | Seed 1: ATT = -0.3017, SE = 2.2241, p = 0.89236
 SubSubCat_Temazepam | Seed 2: ATT = 0.0155, SE = 2.2429, p = 0.99450
 SubSubCat_Temazepam | Seed 3: ATT = -0.3720, SE = 2.1375, p = 0.86220
 SubSubCat_Temazepam | Seed 4: ATT = -0.1711, SE = 1.9734, p = 0.93109
 SubSubCat_Temazepam | Seed 5: ATT = -0.5194, SE = 2.3110, p = 0.82263
 SubSubCat_Temazepam | Seed 6: ATT = -0.4595, SE = 2.2809, p = 0.84076
 SubSubCat_Temazepam | Seed 7: ATT = -0.2792, SE = 2.0926, p = 0.89412
 SubSubCat_Temazepam | Seed 8: ATT = -0.3069, SE = 2.1562, p = 0.88710
 SubSubCat_Temazepam | Seed 9: ATT = -0.3453, SE = 2.3902, p = 0.88542
 SubSubCat_Temazepam | Seed 10: ATT = -0.2872, SE = 2.0755, p = 0.89022
 Diagnostic plots saved for SubSubCat_Temazepam
 Best result for SubSubCat_Temazepam  Seed 4 | SE = 1.9734

 Running DML for SubSubCat_Citalopram
 SubSubCat_Citalopram | Seed 1: ATT = -3.2279, SE = 1.8197, p = 0.07916
 SubSubCat_Citalopram | Seed 2: ATT = -3.2054, SE = 1.9687, p = 0.10667
 SubSubCat_Citalopram | Seed 3: ATT = -3.1389, SE = 2.0491, p = 0.12876
 SubSubCat_Citalopram | Seed 4: ATT = -3.1384, SE = 1.9064, p = 0.10289
 SubSubCat_Citalopram | Seed 5: ATT = -3.2287, SE = 1.7981, p = 0.07560
 SubSubCat_Citalopram | Seed 6: ATT = -3.4447, SE = 1.8798, p = 0.06990
 SubSubCat_Citalopram | Seed 7: ATT = -3.2367, SE = 1.9653, p = 0.10275
 SubSubCat_Citalopram | Seed 8: ATT = -3.1659, SE = 1.9899, p = 0.11479
 SubSubCat_Citalopram | Seed 9: ATT = -3.2362, SE = 1.9459, p = 0.09945
 SubSubCat_Citalopram | Seed 10: ATT = -3.0967, SE = 1.8858, p = 0.10375
 Diagnostic plots saved for SubSubCat_Citalopram
 Best result for SubSubCat_Citalopram  Seed 5 | SE = 1.7981

 Running DML for SubSubCat_Quetiapine
 SubSubCat_Quetiapine | Seed 1: ATT = 1.6134, SE = 1.7131, p = 0.34858
 SubSubCat_Quetiapine | Seed 2: ATT = 1.4029, SE = 1.5253, p = 0.35994
 SubSubCat_Quetiapine | Seed 3: ATT = 1.5053, SE = 1.7141, p = 0.38196
 SubSubCat_Quetiapine | Seed 4: ATT = 1.6057, SE = 1.6939, p = 0.34545
 SubSubCat_Quetiapine | Seed 5: ATT = 1.5086, SE = 1.6131, p = 0.35195
 SubSubCat_Quetiapine | Seed 6: ATT = 1.4680, SE = 1.7839, p = 0.41253
 SubSubCat_Quetiapine | Seed 7: ATT = 1.6238, SE = 1.7595, p = 0.35831
 SubSubCat_Quetiapine | Seed 8: ATT = 1.4698, SE = 1.6664, p = 0.37990
 SubSubCat_Quetiapine | Seed 9: ATT = 1.5487, SE = 1.5934, p = 0.33344
 SubSubCat_Quetiapine | Seed 10: ATT = 1.5426, SE = 1.6235, p = 0.34434
 Diagnostic plots saved for SubSubCat_Quetiapine
 Best result for SubSubCat_Quetiapine  Seed 2 | SE = 1.5253

 Running DML for SubSubCat_Amitriptyline
 SubSubCat_Amitriptyline | Seed 1: ATT = 4.6490, SE = 3.5496, p = 0.19331
 SubSubCat_Amitriptyline | Seed 2: ATT = 4.3387, SE = 3.4989, p = 0.21790
 SubSubCat_Amitriptyline | Seed 3: ATT = 4.4433, SE = 3.7854, p = 0.24329
 SubSubCat_Amitriptyline | Seed 4: ATT = 4.5808, SE = 3.3340, p = 0.17256
 SubSubCat_Amitriptyline | Seed 5: ATT = 4.7673, SE = 3.2978, p = 0.15145
 SubSubCat_Amitriptyline | Seed 6: ATT = 4.2046, SE = 4.4584, p = 0.34795
 SubSubCat_Amitriptyline | Seed 7: ATT = 4.8078, SE = 3.7875, p = 0.20728
 SubSubCat_Amitriptyline | Seed 8: ATT = 4.5218, SE = 4.2883, p = 0.29425
 SubSubCat_Amitriptyline | Seed 9: ATT = 4.7955, SE = 3.8829, p = 0.21974
 SubSubCat_Amitriptyline | Seed 10: ATT = 4.9822, SE = 3.2112, p = 0.12397
 Diagnostic plots saved for SubSubCat_Amitriptyline
 Best result for SubSubCat_Amitriptyline  Seed 10 | SE = 3.2112

 Running DML for SubSubCat_Venlafaxine
 SubSubCat_Venlafaxine | Seed 1: ATT = 2.0775, SE = 3.3320, p = 0.53438
 SubSubCat_Venlafaxine | Seed 2: ATT = 1.4582, SE = 3.4414, p = 0.67270
 SubSubCat_Venlafaxine | Seed 3: ATT = 1.9661, SE = 3.5331, p = 0.57914
 SubSubCat_Venlafaxine | Seed 4: ATT = 1.9169, SE = 3.3814, p = 0.57206
 SubSubCat_Venlafaxine | Seed 5: ATT = 1.9263, SE = 3.1907, p = 0.54740
 SubSubCat_Venlafaxine | Seed 6: ATT = 1.6692, SE = 3.4734, p = 0.63189
 SubSubCat_Venlafaxine | Seed 7: ATT = 1.6872, SE = 3.6553, p = 0.64540
 SubSubCat_Venlafaxine | Seed 8: ATT = 2.0200, SE = 3.3220, p = 0.54454
 SubSubCat_Venlafaxine | Seed 9: ATT = 2.3639, SE = 3.4984, p = 0.50079
 SubSubCat_Venlafaxine | Seed 10: ATT = 2.0985, SE = 3.5614, p = 0.55706
 Diagnostic plots saved for SubSubCat_Venlafaxine
 Best result for SubSubCat_Venlafaxine  Seed 5 | SE = 3.1907

 Running DML for SubSubCat_Fluoxetine
 SubSubCat_Fluoxetine | Seed 1: ATT = 4.5066, SE = 3.0167, p = 0.13839
 SubSubCat_Fluoxetine | Seed 2: ATT = 4.8799, SE = 2.8279, p = 0.08754
 SubSubCat_Fluoxetine | Seed 3: ATT = 4.8613, SE = 2.9608, p = 0.10379
 SubSubCat_Fluoxetine | Seed 4: ATT = 5.1212, SE = 2.8052, p = 0.07093
 SubSubCat_Fluoxetine | Seed 5: ATT = 5.2372, SE = 3.0643, p = 0.09057
 SubSubCat_Fluoxetine | Seed 6: ATT = 4.9068, SE = 3.0700, p = 0.11317
 SubSubCat_Fluoxetine | Seed 7: ATT = 4.6555, SE = 3.3378, p = 0.16620
 SubSubCat_Fluoxetine | Seed 8: ATT = 5.1241, SE = 2.8146, p = 0.07170
 SubSubCat_Fluoxetine | Seed 9: ATT = 5.0199, SE = 3.0580, p = 0.10385
 SubSubCat_Fluoxetine | Seed 10: ATT = 4.8991, SE = 2.9179, p = 0.09631
 Diagnostic plots saved for SubSubCat_Fluoxetine
 Best result for SubSubCat_Fluoxetine  Seed 4 | SE = 2.8052

 Running DML for SubSubCat_Topiramaat
 SubSubCat_Topiramaat | Seed 1: ATT = 7.1274, SE = 5.6473, p = 0.20988
 SubSubCat_Topiramaat | Seed 2: ATT = 7.3441, SE = 6.6016, p = 0.26862
 SubSubCat_Topiramaat | Seed 3: ATT = 8.6964, SE = 8.4120, p = 0.30375
 SubSubCat_Topiramaat | Seed 4: ATT = 8.0655, SE = 12.2565, p = 0.51202
 SubSubCat_Topiramaat | Seed 5: ATT = 7.7918, SE = 7.0322, p = 0.27053
 SubSubCat_Topiramaat | Seed 6: ATT = 7.2091, SE = 7.3665, p = 0.33015
 SubSubCat_Topiramaat | Seed 7: ATT = 7.3087, SE = 6.1638, p = 0.23856
 SubSubCat_Topiramaat | Seed 8: ATT = 8.3569, SE = 7.9155, p = 0.29364
 SubSubCat_Topiramaat | Seed 9: ATT = 8.2950, SE = 9.8076, p = 0.39972
 SubSubCat_Topiramaat | Seed 10: ATT = 7.2182, SE = 6.2251, p = 0.24903
 Diagnostic plots saved for SubSubCat_Topiramaat
 Best result for SubSubCat_Topiramaat  Seed 1 | SE = 5.6473

 Running DML for SubSubCat_Zopiclon
 SubSubCat_Zopiclon | Seed 1: ATT = 1.0251, SE = 10.2480, p = 0.92052
 SubSubCat_Zopiclon | Seed 2: ATT = 0.4405, SE = 10.2092, p = 0.96567
 SubSubCat_Zopiclon | Seed 3: ATT = 0.6628, SE = 8.6882, p = 0.93935
 SubSubCat_Zopiclon | Seed 4: ATT = 0.1910, SE = 11.4958, p = 0.98678
 SubSubCat_Zopiclon | Seed 5: ATT = 0.3667, SE = 6.5287, p = 0.95532
 SubSubCat_Zopiclon | Seed 6: ATT = 1.6562, SE = 6.3178, p = 0.79375
 SubSubCat_Zopiclon | Seed 7: ATT = 0.9971, SE = 9.4529, p = 0.91621
 SubSubCat_Zopiclon | Seed 8: ATT = 1.1025, SE = 7.7315, p = 0.88690
 SubSubCat_Zopiclon | Seed 9: ATT = 2.5886, SE = 16.1902, p = 0.87329
 SubSubCat_Zopiclon | Seed 10: ATT = 2.1027, SE = 15.3774, p = 0.89151
 Diagnostic plots saved for SubSubCat_Zopiclon
 Best result for SubSubCat_Zopiclon  Seed 6 | SE = 6.3178

 Running DML for SubSubCat_Bupropion
 SubSubCat_Bupropion | Seed 1: ATT = 2.9073, SE = 5.4649, p = 0.59592
 SubSubCat_Bupropion | Seed 2: ATT = 3.8209, SE = 5.5643, p = 0.49389
 SubSubCat_Bupropion | Seed 3: ATT = 3.4532, SE = 6.3474, p = 0.58764
 SubSubCat_Bupropion | Seed 4: ATT = 3.1377, SE = 6.3388, p = 0.62170
 SubSubCat_Bupropion | Seed 5: ATT = 3.3692, SE = 6.5833, p = 0.60995
 SubSubCat_Bupropion | Seed 6: ATT = 3.2916, SE = 7.0730, p = 0.64269
 SubSubCat_Bupropion | Seed 7: ATT = 3.8932, SE = 6.0209, p = 0.51938
 SubSubCat_Bupropion | Seed 8: ATT = 3.2358, SE = 5.9981, p = 0.59077
 SubSubCat_Bupropion | Seed 9: ATT = 2.8553, SE = 5.6852, p = 0.61662
 SubSubCat_Bupropion | Seed 10: ATT = 3.1450, SE = 6.6174, p = 0.63564
 Diagnostic plots saved for SubSubCat_Bupropion
 Best result for SubSubCat_Bupropion  Seed 1 | SE = 5.4649

 Running DML for SubSubCat_Methylfenidaat
 SubSubCat_Methylfenidaat | Seed 1: ATT = -0.7484, SE = 4.4270, p = 0.86609
 SubSubCat_Methylfenidaat | Seed 2: ATT = -0.7586, SE = 4.6987, p = 0.87207
 SubSubCat_Methylfenidaat | Seed 3: ATT = -0.5290, SE = 4.2693, p = 0.90165
 SubSubCat_Methylfenidaat | Seed 4: ATT = -0.3121, SE = 4.7528, p = 0.94777
 SubSubCat_Methylfenidaat | Seed 5: ATT = -0.4045, SE = 4.1304, p = 0.92219
 SubSubCat_Methylfenidaat | Seed 6: ATT = -0.3439, SE = 4.0180, p = 0.93197
 SubSubCat_Methylfenidaat | Seed 7: ATT = -1.2674, SE = 4.3500, p = 0.77139
 SubSubCat_Methylfenidaat | Seed 8: ATT = -0.0668, SE = 5.3294, p = 0.99002
 SubSubCat_Methylfenidaat | Seed 9: ATT = -0.4513, SE = 4.1317, p = 0.91324
 SubSubCat_Methylfenidaat | Seed 10: ATT = -0.2132, SE = 4.6424, p = 0.96346
 Diagnostic plots saved for SubSubCat_Methylfenidaat
 Best result for SubSubCat_Methylfenidaat  Seed 6 | SE = 4.0180

 Running DML for SubSubCat_Olanzapine
 SubSubCat_Olanzapine | Seed 1: ATT = 2.5668, SE = 8.8625, p = 0.77271
 SubSubCat_Olanzapine | Seed 2: ATT = 2.7274, SE = 8.4931, p = 0.74879
 SubSubCat_Olanzapine | Seed 3: ATT = 2.2632, SE = 8.7422, p = 0.79627
 SubSubCat_Olanzapine | Seed 4: ATT = 1.7907, SE = 8.2512, p = 0.82863
 SubSubCat_Olanzapine | Seed 5: ATT = 2.2532, SE = 9.5122, p = 0.81324
 SubSubCat_Olanzapine | Seed 6: ATT = 2.1699, SE = 7.4068, p = 0.77016
 SubSubCat_Olanzapine | Seed 7: ATT = 1.7464, SE = 7.7035, p = 0.82112
 SubSubCat_Olanzapine | Seed 8: ATT = 2.1646, SE = 7.5800, p = 0.77580
 SubSubCat_Olanzapine | Seed 9: ATT = 0.8563, SE = 7.4907, p = 0.90922
 SubSubCat_Olanzapine | Seed 10: ATT = 2.3691, SE = 7.1173, p = 0.73994
 Diagnostic plots saved for SubSubCat_Olanzapine
 Best result for SubSubCat_Olanzapine  Seed 10 | SE = 7.1173

 All summary files saved.
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=bf3e1c00-9abe-425a-972e-c96b06b05f43">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[88]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Unweighted:</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=b2f22f4a-6eb0-41c2-9404-d412340c7710">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[89]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">GradientBoostingRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">r2_score</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">KFold</span>
<span class="kn">from</span> <span class="nn">econml.dml</span> <span class="kn">import</span> <span class="n">LinearDML</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">t</span><span class="p">,</span> <span class="n">probplot</span>
<span class="kn">import</span> <span class="nn">xgboost</span> <span class="k">as</span> <span class="nn">xgb</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Configuration</span>
<span class="c1"># -----------------------------</span>
<span class="n">n_repeats</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">seeds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span>
<span class="n">imputations</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">output_folder</span> <span class="o">=</span> <span class="s2">"outputs"</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Plotting Functions</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">create_diagnostic_plots</span><span class="p">(</span><span class="n">residuals_data</span><span class="p">,</span> <span class="n">group_name</span><span class="p">,</span> <span class="n">output_folder</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Create diagnostic plots for each group"""</span>
    <span class="n">plots_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"plots"</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">plots_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="n">all_residuals</span> <span class="o">=</span> <span class="n">residuals_data</span><span class="p">[</span><span class="s1">'residuals'</span><span class="p">]</span>
    <span class="n">all_fitted</span> <span class="o">=</span> <span class="n">residuals_data</span><span class="p">[</span><span class="s1">'fitted'</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>
    
    <span class="c1"># Create figure with subplots</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Diagnostic Plots - </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">'bold'</span><span class="p">)</span>
    
    <span class="c1"># 1. Residuals vs Fitted</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">all_fitted</span><span class="p">,</span> <span class="n">all_residuals</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Fitted Values'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Residuals'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Residuals vs Fitted'</span><span class="p">)</span>
    
    <span class="c1"># 2. QQ Plot</span>
    <span class="n">probplot</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s2">"norm"</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'QQ Plot (Normal)'</span><span class="p">)</span>
    
    <span class="c1"># 3. Histogram of Residuals</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">'black'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Residuals'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Frequency'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Residual Distribution'</span><span class="p">)</span>
    
    <span class="c1"># 4. Scale-Location Plot</span>
    <span class="n">sqrt_abs_resid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">))</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">all_fitted</span><span class="p">,</span> <span class="n">sqrt_abs_resid</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Fitted Values'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'|Residuals|'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Scale-Location Plot'</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plots_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s1">_unweighted.png'</span><span class="p">),</span> 
                <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">'tight'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Rubin's Rule</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">rubins_pool</span><span class="p">(</span><span class="n">estimates</span><span class="p">,</span> <span class="n">ses</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">estimates</span><span class="p">)</span>
    <span class="n">q_bar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">estimates</span><span class="p">)</span>
    <span class="n">u_bar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">ses</span><span class="p">))</span>
    <span class="n">b_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">estimates</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">total_var</span> <span class="o">=</span> <span class="n">u_bar</span> <span class="o">+</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">b_m</span><span class="p">)</span>
    <span class="n">total_se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">total_var</span><span class="p">)</span>
    <span class="n">ci_lower</span> <span class="o">=</span> <span class="n">q_bar</span> <span class="o">-</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">total_se</span>
    <span class="n">ci_upper</span> <span class="o">=</span> <span class="n">q_bar</span> <span class="o">+</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">total_se</span>
    <span class="n">p_value</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">q_bar</span> <span class="o">/</span> <span class="n">total_se</span><span class="p">),</span> <span class="n">df</span><span class="o">=</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">rounded_p</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">p_value</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">formatted_p</span> <span class="o">=</span> <span class="s2">"&lt; 0.00001"</span> <span class="k">if</span> <span class="n">rounded_p</span> <span class="o">&lt;=</span> <span class="mf">0.00001</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">rounded_p</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">return</span> <span class="n">q_bar</span><span class="p">,</span> <span class="n">total_se</span><span class="p">,</span> <span class="n">ci_lower</span><span class="p">,</span> <span class="n">ci_upper</span><span class="p">,</span> <span class="n">formatted_p</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># SMD + Variance Ratio</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">calculate_smd_vr</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
    <span class="n">treated</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">control</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">smd</span><span class="p">,</span> <span class="n">vr</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m1</span><span class="p">,</span> <span class="n">m0</span> <span class="o">=</span> <span class="n">treated</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">control</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">s1</span><span class="p">,</span> <span class="n">s0</span> <span class="o">=</span> <span class="n">treated</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span> <span class="n">control</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
            <span class="n">pooled_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">s1</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">s0</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">smd</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">m1</span> <span class="o">-</span> <span class="n">m0</span><span class="p">)</span> <span class="o">/</span> <span class="n">pooled_sd</span> <span class="k">if</span> <span class="n">pooled_sd</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">vr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s1</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">s0</span><span class="o">**</span><span class="mi">2</span> <span class="k">if</span> <span class="n">s0</span><span class="o">**</span><span class="mi">2</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">smd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">vr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">smd</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">vr</span><span class="p">)</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># DML Main Loop</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">run_dml_with_trimmed_data</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="p">):</span>
    <span class="n">att_results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">balance_results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">covariates</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Running DML for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">group_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">group_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">best_result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">best_se</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">"inf"</span><span class="p">)</span>
        
        <span class="c1"># Initialize residuals collection for this group</span>
        <span class="n">group_residuals_data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'residuals'</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">'fitted'</span><span class="p">:</span> <span class="p">[]}</span>

        <span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="n">seeds</span><span class="p">:</span>
            <span class="n">att_list</span><span class="p">,</span> <span class="n">se_list</span><span class="p">,</span> <span class="n">r2_list</span><span class="p">,</span> <span class="n">rmse_list</span><span class="p">,</span> <span class="n">smd_list</span><span class="p">,</span> <span class="n">vr_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">imp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">imputations</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"trimmed_data_imp</span><span class="si">{</span><span class="n">imp</span><span class="si">}</span><span class="s2">.pkl"</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">T</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
                <span class="n">Y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">"caps5_change_baseline"</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">repeat</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_repeats</span><span class="p">):</span>
                    <span class="n">kf</span> <span class="o">=</span> <span class="n">KFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span> <span class="o">+</span> <span class="n">repeat</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">train_idx</span><span class="p">,</span> <span class="n">test_idx</span> <span class="ow">in</span> <span class="n">kf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">X_train</span><span class="p">,</span> <span class="n">T_train</span><span class="p">,</span> <span class="n">Y_train</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span>
                                <span class="n">T</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span>
                                <span class="n">Y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span>
                            <span class="p">)</span>

                            <span class="n">model_y</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
                            <span class="n">model_t</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                        <span class="n">use_label_encoder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eval_metric</span><span class="o">=</span><span class="s2">"logloss"</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>

                            <span class="n">dml</span> <span class="o">=</span> <span class="n">LinearDML</span><span class="p">(</span><span class="n">model_y</span><span class="o">=</span><span class="n">model_y</span><span class="p">,</span> <span class="n">model_t</span><span class="o">=</span><span class="n">model_t</span><span class="p">,</span> <span class="n">discrete_treatment</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                            <span class="n">cv</span><span class="o">=</span><span class="n">KFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">),</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
                            <span class="n">dml</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Y_train</span><span class="p">,</span> <span class="n">T_train</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">X_train</span><span class="p">)</span>

                            <span class="n">tau</span> <span class="o">=</span> <span class="n">dml</span><span class="o">.</span><span class="n">effect</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
                            <span class="n">att</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span>
                            <span class="n">influence</span> <span class="o">=</span> <span class="n">tau</span> <span class="o">-</span> <span class="n">att</span>
                            <span class="n">se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">influence</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">tau</span><span class="p">))</span>

                            <span class="n">att_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">att</span><span class="p">)</span>
                            <span class="n">se_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">se</span><span class="p">)</span>

                            <span class="n">Y_pred</span> <span class="o">=</span> <span class="n">model_y</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">)</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
                            <span class="n">residuals</span> <span class="o">=</span> <span class="n">Y_train</span> <span class="o">-</span> <span class="n">Y_pred</span>
                            
                            <span class="c1"># Collect residuals and fitted values for plotting</span>
                            <span class="n">group_residuals_data</span><span class="p">[</span><span class="s1">'residuals'</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">residuals</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                            <span class="n">group_residuals_data</span><span class="p">[</span><span class="s1">'fitted'</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">Y_pred</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                            
                            <span class="n">rmse</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_pred</span><span class="p">,</span> <span class="n">squared</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                            <span class="n">r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_pred</span><span class="p">)</span>
                            <span class="n">r2_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
                            <span class="n">rmse_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rmse</span><span class="p">)</span>

                            <span class="n">smd</span><span class="p">,</span> <span class="n">vr</span> <span class="o">=</span> <span class="n">calculate_smd_vr</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">T_train</span><span class="p">)</span>
                            <span class="n">smd_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smd</span><span class="p">)</span>
                            <span class="n">vr_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vr</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">, seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">, imp </span><span class="si">{</span><span class="n">imp</span><span class="si">}</span><span class="s2">, rep </span><span class="si">{</span><span class="n">repeat</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">att_list</span><span class="p">:</span>
                <span class="n">att</span><span class="p">,</span> <span class="n">se</span><span class="p">,</span> <span class="n">ci_l</span><span class="p">,</span> <span class="n">ci_u</span><span class="p">,</span> <span class="n">p_val</span> <span class="o">=</span> <span class="n">rubins_pool</span><span class="p">(</span><span class="n">att_list</span><span class="p">,</span> <span class="n">se_list</span><span class="p">)</span>
                <span class="n">avg_r2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">r2_list</span><span class="p">)</span>
                <span class="n">avg_rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rmse_list</span><span class="p">)</span>
                <span class="n">avg_smd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">smd_list</span><span class="p">)</span>
                <span class="n">avg_vr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">vr_list</span><span class="p">)</span>

                <span class="n">balance_results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">"group"</span><span class="p">:</span> <span class="n">group</span><span class="p">,</span> <span class="s2">"seed"</span><span class="p">:</span> <span class="n">seed</span><span class="p">,</span> <span class="s2">"smd"</span><span class="p">:</span> <span class="n">avg_smd</span><span class="p">,</span> <span class="s2">"vr"</span><span class="p">:</span> <span class="n">avg_vr</span>
                <span class="p">})</span>

                <span class="k">if</span> <span class="n">se</span> <span class="o">&lt;</span> <span class="n">best_se</span><span class="p">:</span>
                    <span class="n">best_se</span> <span class="o">=</span> <span class="n">se</span>
                    <span class="n">best_result</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">"group"</span><span class="p">:</span> <span class="n">group</span><span class="p">,</span> <span class="s2">"seed"</span><span class="p">:</span> <span class="n">seed</span><span class="p">,</span> <span class="s2">"att"</span><span class="p">:</span> <span class="n">att</span><span class="p">,</span> <span class="s2">"se"</span><span class="p">:</span> <span class="n">se</span><span class="p">,</span>
                        <span class="s2">"ci_lower"</span><span class="p">:</span> <span class="n">ci_l</span><span class="p">,</span> <span class="s2">"ci_upper"</span><span class="p">:</span> <span class="n">ci_u</span><span class="p">,</span> <span class="s2">"p_value"</span><span class="p">:</span> <span class="n">p_val</span><span class="p">,</span>
                        <span class="s2">"r2"</span><span class="p">:</span> <span class="n">avg_r2</span><span class="p">,</span> <span class="s2">"rmse"</span><span class="p">:</span> <span class="n">avg_rmse</span>
                    <span class="p">}</span>

                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> | Seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">: ATT = </span><span class="si">{</span><span class="n">att</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, SE = </span><span class="si">{</span><span class="n">se</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, p = </span><span class="si">{</span><span class="n">p_val</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No valid results for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> | Seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">best_result</span><span class="p">:</span>
            <span class="n">att_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">best_result</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Best result for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">  Seed </span><span class="si">{</span><span class="n">best_result</span><span class="p">[</span><span class="s1">'seed'</span><span class="p">]</span><span class="si">}</span><span class="s2"> | SE = </span><span class="si">{</span><span class="n">best_result</span><span class="p">[</span><span class="s1">'se'</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        
        <span class="c1"># Create diagnostic plots for this group</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Creating diagnostic plots for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">..."</span><span class="p">)</span>
        <span class="n">create_diagnostic_plots</span><span class="p">(</span><span class="n">group_residuals_data</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">output_folder</span><span class="p">)</span>

    <span class="c1"># Save final output</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">att_results</span><span class="p">)</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">"dml_rubin_summary_subsubcats_unweighted.xlsx"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">balance_results</span><span class="p">)</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">"smd_vr_summary_subsubcats_unweighted.xlsx"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> All summary files saved."</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">" All diagnostic plots saved in outputs/plots/ folder."</span><span class="p">)</span>

<span class="n">run_dml_with_trimmed_data</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Running DML for SubSubCat_Oxazepam
 SubSubCat_Oxazepam | Seed 1: ATT = 0.5675, SE = 1.0441, p = 0.58796
 SubSubCat_Oxazepam | Seed 2: ATT = 0.5492, SE = 1.1033, p = 0.61977
 SubSubCat_Oxazepam | Seed 3: ATT = 0.5046, SE = 1.1584, p = 0.66408
 SubSubCat_Oxazepam | Seed 4: ATT = 0.4367, SE = 1.1760, p = 0.71121
 SubSubCat_Oxazepam | Seed 5: ATT = 0.5302, SE = 1.0705, p = 0.62149
 SubSubCat_Oxazepam | Seed 6: ATT = 0.3997, SE = 1.0026, p = 0.69097
 SubSubCat_Oxazepam | Seed 7: ATT = 0.5618, SE = 1.1810, p = 0.63538
 SubSubCat_Oxazepam | Seed 8: ATT = 0.4690, SE = 1.2144, p = 0.70019
 SubSubCat_Oxazepam | Seed 9: ATT = 0.4623, SE = 1.1280, p = 0.68279
 SubSubCat_Oxazepam | Seed 10: ATT = 0.4741, SE = 1.1514, p = 0.68139
 Best result for SubSubCat_Oxazepam  Seed 6 | SE = 1.0026
 Creating diagnostic plots for SubSubCat_Oxazepam...

 Running DML for SubSubCat_Diazepam
 SubSubCat_Diazepam | Seed 1: ATT = -1.8528, SE = 3.5834, p = 0.60627
 SubSubCat_Diazepam | Seed 2: ATT = -1.9226, SE = 3.8832, p = 0.62162
 SubSubCat_Diazepam | Seed 3: ATT = -1.7790, SE = 3.6235, p = 0.62454
 SubSubCat_Diazepam | Seed 4: ATT = -1.9888, SE = 3.9226, p = 0.61326
 SubSubCat_Diazepam | Seed 5: ATT = -1.9895, SE = 3.5797, p = 0.57962
 SubSubCat_Diazepam | Seed 6: ATT = -1.5851, SE = 3.5276, p = 0.65417
 SubSubCat_Diazepam | Seed 7: ATT = -1.6450, SE = 3.4960, p = 0.63900
 SubSubCat_Diazepam | Seed 8: ATT = -1.3827, SE = 3.5326, p = 0.69633
 SubSubCat_Diazepam | Seed 9: ATT = -1.3818, SE = 3.6056, p = 0.70236
 SubSubCat_Diazepam | Seed 10: ATT = -1.4638, SE = 3.3587, p = 0.66391
 Best result for SubSubCat_Diazepam  Seed 10 | SE = 3.3587
 Creating diagnostic plots for SubSubCat_Diazepam...

 Running DML for SubSubCat_Paracetamol
 SubSubCat_Paracetamol | Seed 1: ATT = 2.3857, SE = 4.2411, p = 0.57504
 SubSubCat_Paracetamol | Seed 2: ATT = 2.9607, SE = 4.1582, p = 0.47813
 SubSubCat_Paracetamol | Seed 3: ATT = 3.1305, SE = 4.4566, p = 0.48406
 SubSubCat_Paracetamol | Seed 4: ATT = 2.5546, SE = 4.4281, p = 0.56531
 SubSubCat_Paracetamol | Seed 5: ATT = 2.9071, SE = 4.2280, p = 0.49332
 SubSubCat_Paracetamol | Seed 6: ATT = 2.7115, SE = 4.4135, p = 0.54038
 SubSubCat_Paracetamol | Seed 7: ATT = 2.5881, SE = 4.5464, p = 0.57047
 SubSubCat_Paracetamol | Seed 8: ATT = 2.5996, SE = 4.5495, p = 0.56901
 SubSubCat_Paracetamol | Seed 9: ATT = 2.5571, SE = 4.4143, p = 0.56372
 SubSubCat_Paracetamol | Seed 10: ATT = 2.9035, SE = 4.7623, p = 0.54347
 Best result for SubSubCat_Paracetamol  Seed 2 | SE = 4.1582
 Creating diagnostic plots for SubSubCat_Paracetamol...

 Running DML for SubSubCat_Lorazepam
 SubSubCat_Lorazepam | Seed 1: ATT = 0.7186, SE = 2.8524, p = 0.80161
 SubSubCat_Lorazepam | Seed 2: ATT = 0.6426, SE = 2.8071, p = 0.81939
 SubSubCat_Lorazepam | Seed 3: ATT = 0.8222, SE = 3.1674, p = 0.79572
 SubSubCat_Lorazepam | Seed 4: ATT = 0.4984, SE = 3.0267, p = 0.86955
 SubSubCat_Lorazepam | Seed 5: ATT = 0.9509, SE = 2.7837, p = 0.73337
 SubSubCat_Lorazepam | Seed 6: ATT = 0.8526, SE = 2.4832, p = 0.73206
 SubSubCat_Lorazepam | Seed 7: ATT = 0.7001, SE = 2.7284, p = 0.79801
 SubSubCat_Lorazepam | Seed 8: ATT = 0.5159, SE = 2.7240, p = 0.85016
 SubSubCat_Lorazepam | Seed 9: ATT = 0.6919, SE = 2.9639, p = 0.81590
 SubSubCat_Lorazepam | Seed 10: ATT = 0.2482, SE = 2.6614, p = 0.92589
 Best result for SubSubCat_Lorazepam  Seed 6 | SE = 2.4832
 Creating diagnostic plots for SubSubCat_Lorazepam...

 Running DML for SubSubCat_Mirtazapine
 SubSubCat_Mirtazapine | Seed 1: ATT = 7.6999, SE = 2.4700, p = 0.00239
 SubSubCat_Mirtazapine | Seed 2: ATT = 7.4652, SE = 2.4382, p = 0.00283
 SubSubCat_Mirtazapine | Seed 3: ATT = 7.3973, SE = 2.2849, p = 0.00164
 SubSubCat_Mirtazapine | Seed 4: ATT = 7.4711, SE = 2.5823, p = 0.00469
 SubSubCat_Mirtazapine | Seed 5: ATT = 7.6013, SE = 2.6826, p = 0.00558
 SubSubCat_Mirtazapine | Seed 6: ATT = 7.5080, SE = 2.5094, p = 0.00350
 SubSubCat_Mirtazapine | Seed 7: ATT = 7.6771, SE = 2.6720, p = 0.00497
 SubSubCat_Mirtazapine | Seed 8: ATT = 7.7898, SE = 2.7459, p = 0.00553
 SubSubCat_Mirtazapine | Seed 9: ATT = 7.4435, SE = 2.4542, p = 0.00309
 SubSubCat_Mirtazapine | Seed 10: ATT = 7.3712, SE = 2.6324, p = 0.00614
 Best result for SubSubCat_Mirtazapine  Seed 3 | SE = 2.2849
 Creating diagnostic plots for SubSubCat_Mirtazapine...

 Running DML for SubSubCat_Escitalopram
 SubSubCat_Escitalopram | Seed 1: ATT = 0.4862, SE = 2.6646, p = 0.85559
 SubSubCat_Escitalopram | Seed 2: ATT = 0.9598, SE = 2.6441, p = 0.71737
 SubSubCat_Escitalopram | Seed 3: ATT = 0.6558, SE = 2.6577, p = 0.80562
 SubSubCat_Escitalopram | Seed 4: ATT = 0.8798, SE = 2.7426, p = 0.74905
 SubSubCat_Escitalopram | Seed 5: ATT = 0.9322, SE = 2.4745, p = 0.70719
 SubSubCat_Escitalopram | Seed 6: ATT = 1.1090, SE = 2.5253, p = 0.66151
 SubSubCat_Escitalopram | Seed 7: ATT = 0.8568, SE = 2.5232, p = 0.73490
 SubSubCat_Escitalopram | Seed 8: ATT = 0.6292, SE = 2.6056, p = 0.80969
 SubSubCat_Escitalopram | Seed 9: ATT = 0.7844, SE = 2.5232, p = 0.75656
 SubSubCat_Escitalopram | Seed 10: ATT = 0.8350, SE = 2.4194, p = 0.73072
 Best result for SubSubCat_Escitalopram  Seed 10 | SE = 2.4194
 Creating diagnostic plots for SubSubCat_Escitalopram...

 Running DML for SubSubCat_Sertraline
 SubSubCat_Sertraline | Seed 1: ATT = -0.0755, SE = 1.8036, p = 0.96670
 SubSubCat_Sertraline | Seed 2: ATT = -0.3205, SE = 1.9406, p = 0.86914
 SubSubCat_Sertraline | Seed 3: ATT = -0.2510, SE = 2.3764, p = 0.91609
 SubSubCat_Sertraline | Seed 4: ATT = -0.3702, SE = 1.8525, p = 0.84200
 SubSubCat_Sertraline | Seed 5: ATT = -0.1055, SE = 2.7946, p = 0.96997
 SubSubCat_Sertraline | Seed 6: ATT = -0.2465, SE = 1.8690, p = 0.89532
 SubSubCat_Sertraline | Seed 7: ATT = -0.3122, SE = 1.8047, p = 0.86299
 SubSubCat_Sertraline | Seed 8: ATT = -0.4568, SE = 1.6449, p = 0.78183
 SubSubCat_Sertraline | Seed 9: ATT = -0.3408, SE = 1.8143, p = 0.85138
 SubSubCat_Sertraline | Seed 10: ATT = -0.2742, SE = 1.7827, p = 0.87807
 Best result for SubSubCat_Sertraline  Seed 8 | SE = 1.6449
 Creating diagnostic plots for SubSubCat_Sertraline...

 Running DML for SubSubCat_Temazepam
 SubSubCat_Temazepam | Seed 1: ATT = -0.5295, SE = 2.3588, p = 0.82284
 SubSubCat_Temazepam | Seed 2: ATT = -0.2870, SE = 2.1735, p = 0.89521
 SubSubCat_Temazepam | Seed 3: ATT = -0.4951, SE = 2.0864, p = 0.81293
 SubSubCat_Temazepam | Seed 4: ATT = -0.4062, SE = 1.8955, p = 0.83078
 SubSubCat_Temazepam | Seed 5: ATT = -0.5982, SE = 2.2304, p = 0.78912
 SubSubCat_Temazepam | Seed 6: ATT = -0.6605, SE = 2.1932, p = 0.76391
 SubSubCat_Temazepam | Seed 7: ATT = -0.4497, SE = 2.0140, p = 0.82378
 SubSubCat_Temazepam | Seed 8: ATT = -0.5910, SE = 2.0453, p = 0.77324
 SubSubCat_Temazepam | Seed 9: ATT = -0.4741, SE = 2.6315, p = 0.85740
 SubSubCat_Temazepam | Seed 10: ATT = -0.5028, SE = 1.9738, p = 0.79946
 Best result for SubSubCat_Temazepam  Seed 4 | SE = 1.8955
 Creating diagnostic plots for SubSubCat_Temazepam...

 Running DML for SubSubCat_Citalopram
 SubSubCat_Citalopram | Seed 1: ATT = -2.7352, SE = 1.6432, p = 0.09917
 SubSubCat_Citalopram | Seed 2: ATT = -2.6968, SE = 1.6230, p = 0.09975
 SubSubCat_Citalopram | Seed 3: ATT = -2.5446, SE = 1.8263, p = 0.16666
 SubSubCat_Citalopram | Seed 4: ATT = -2.6037, SE = 1.7839, p = 0.14757
 SubSubCat_Citalopram | Seed 5: ATT = -2.6860, SE = 1.6164, p = 0.09972
 SubSubCat_Citalopram | Seed 6: ATT = -2.9507, SE = 1.7801, p = 0.10055
 SubSubCat_Citalopram | Seed 7: ATT = -2.7028, SE = 1.7454, p = 0.12469
 SubSubCat_Citalopram | Seed 8: ATT = -2.6098, SE = 1.8332, p = 0.15769
 SubSubCat_Citalopram | Seed 9: ATT = -2.6151, SE = 1.8581, p = 0.16242
 SubSubCat_Citalopram | Seed 10: ATT = -2.5305, SE = 1.6269, p = 0.12304
 Best result for SubSubCat_Citalopram  Seed 5 | SE = 1.6164
 Creating diagnostic plots for SubSubCat_Citalopram...

 Running DML for SubSubCat_Quetiapine
 SubSubCat_Quetiapine | Seed 1: ATT = 1.9648, SE = 1.2549, p = 0.12060
 SubSubCat_Quetiapine | Seed 2: ATT = 1.9546, SE = 1.0821, p = 0.07392
 SubSubCat_Quetiapine | Seed 3: ATT = 2.0357, SE = 1.2684, p = 0.11171
 SubSubCat_Quetiapine | Seed 4: ATT = 1.9775, SE = 1.2053, p = 0.10404
 SubSubCat_Quetiapine | Seed 5: ATT = 1.9437, SE = 1.2326, p = 0.11799
 SubSubCat_Quetiapine | Seed 6: ATT = 1.8805, SE = 1.2646, p = 0.14018
 SubSubCat_Quetiapine | Seed 7: ATT = 1.9974, SE = 1.2795, p = 0.12170
 SubSubCat_Quetiapine | Seed 8: ATT = 1.8432, SE = 1.1995, p = 0.12758
 SubSubCat_Quetiapine | Seed 9: ATT = 1.8929, SE = 1.1374, p = 0.09922
 SubSubCat_Quetiapine | Seed 10: ATT = 1.9935, SE = 1.1756, p = 0.09308
 Best result for SubSubCat_Quetiapine  Seed 2 | SE = 1.0821
 Creating diagnostic plots for SubSubCat_Quetiapine...

 Running DML for SubSubCat_Amitriptyline
 SubSubCat_Amitriptyline | Seed 1: ATT = 3.9856, SE = 3.3930, p = 0.24295
 SubSubCat_Amitriptyline | Seed 2: ATT = 3.7154, SE = 3.1849, p = 0.24619
 SubSubCat_Amitriptyline | Seed 3: ATT = 3.9466, SE = 4.0069, p = 0.32705
 SubSubCat_Amitriptyline | Seed 4: ATT = 3.9972, SE = 3.1239, p = 0.20368
 SubSubCat_Amitriptyline | Seed 5: ATT = 4.0227, SE = 3.2292, p = 0.21580
 SubSubCat_Amitriptyline | Seed 6: ATT = 3.8173, SE = 3.6114, p = 0.29309
 SubSubCat_Amitriptyline | Seed 7: ATT = 3.8845, SE = 3.6439, p = 0.28901
 SubSubCat_Amitriptyline | Seed 8: ATT = 3.5152, SE = 3.8168, p = 0.35931
 SubSubCat_Amitriptyline | Seed 9: ATT = 4.1922, SE = 3.5111, p = 0.23534
 SubSubCat_Amitriptyline | Seed 10: ATT = 4.4097, SE = 3.1623, p = 0.16631
 Best result for SubSubCat_Amitriptyline  Seed 4 | SE = 3.1239
 Creating diagnostic plots for SubSubCat_Amitriptyline...

 Running DML for SubSubCat_Venlafaxine
 SubSubCat_Venlafaxine | Seed 1: ATT = 2.1155, SE = 2.9767, p = 0.47895
 SubSubCat_Venlafaxine | Seed 2: ATT = 1.6280, SE = 3.6573, p = 0.65718
 SubSubCat_Venlafaxine | Seed 3: ATT = 1.8984, SE = 3.4468, p = 0.58303
 SubSubCat_Venlafaxine | Seed 4: ATT = 2.1534, SE = 3.3573, p = 0.52275
 SubSubCat_Venlafaxine | Seed 5: ATT = 1.9479, SE = 3.1398, p = 0.53642
 SubSubCat_Venlafaxine | Seed 6: ATT = 1.7582, SE = 3.4327, p = 0.60966
 SubSubCat_Venlafaxine | Seed 7: ATT = 1.8212, SE = 3.2918, p = 0.58133
 SubSubCat_Venlafaxine | Seed 8: ATT = 1.8570, SE = 3.1668, p = 0.55894
 SubSubCat_Venlafaxine | Seed 9: ATT = 2.3000, SE = 3.3556, p = 0.49467
 SubSubCat_Venlafaxine | Seed 10: ATT = 2.1692, SE = 3.4175, p = 0.52706
 Best result for SubSubCat_Venlafaxine  Seed 1 | SE = 2.9767
 Creating diagnostic plots for SubSubCat_Venlafaxine...

 Running DML for SubSubCat_Fluoxetine
 SubSubCat_Fluoxetine | Seed 1: ATT = 4.9423, SE = 3.1422, p = 0.11894
 SubSubCat_Fluoxetine | Seed 2: ATT = 5.3046, SE = 3.0117, p = 0.08126
 SubSubCat_Fluoxetine | Seed 3: ATT = 5.2561, SE = 2.8319, p = 0.06642
 SubSubCat_Fluoxetine | Seed 4: ATT = 5.3888, SE = 2.7711, p = 0.05466
 SubSubCat_Fluoxetine | Seed 5: ATT = 5.2930, SE = 2.7354, p = 0.05585
 SubSubCat_Fluoxetine | Seed 6: ATT = 5.1291, SE = 2.8356, p = 0.07352
 SubSubCat_Fluoxetine | Seed 7: ATT = 4.9381, SE = 3.3237, p = 0.14053
 SubSubCat_Fluoxetine | Seed 8: ATT = 5.4240, SE = 2.5627, p = 0.03681
 SubSubCat_Fluoxetine | Seed 9: ATT = 5.3388, SE = 3.1371, p = 0.09192
 SubSubCat_Fluoxetine | Seed 10: ATT = 5.2369, SE = 2.7981, p = 0.06422
 Best result for SubSubCat_Fluoxetine  Seed 8 | SE = 2.5627
 Creating diagnostic plots for SubSubCat_Fluoxetine...

 Running DML for SubSubCat_Topiramaat
 SubSubCat_Topiramaat | Seed 1: ATT = 8.6175, SE = 4.8319, p = 0.07758
 SubSubCat_Topiramaat | Seed 2: ATT = 8.5584, SE = 5.3505, p = 0.11288
 SubSubCat_Topiramaat | Seed 3: ATT = 9.8178, SE = 7.9495, p = 0.21975
 SubSubCat_Topiramaat | Seed 4: ATT = 8.9772, SE = 8.6095, p = 0.29963
 SubSubCat_Topiramaat | Seed 5: ATT = 8.8682, SE = 5.7369, p = 0.12534
 SubSubCat_Topiramaat | Seed 6: ATT = 8.7930, SE = 5.9357, p = 0.14168
 SubSubCat_Topiramaat | Seed 7: ATT = 8.4931, SE = 5.1258, p = 0.10070
 SubSubCat_Topiramaat | Seed 8: ATT = 8.9110, SE = 5.8805, p = 0.13287
 SubSubCat_Topiramaat | Seed 9: ATT = 9.2228, SE = 6.8566, p = 0.18167
 SubSubCat_Topiramaat | Seed 10: ATT = 8.4505, SE = 5.8056, p = 0.14868
 Best result for SubSubCat_Topiramaat  Seed 1 | SE = 4.8319
 Creating diagnostic plots for SubSubCat_Topiramaat...

 Running DML for SubSubCat_Zopiclon
 SubSubCat_Zopiclon | Seed 1: ATT = 0.6749, SE = 6.6428, p = 0.91928
 SubSubCat_Zopiclon | Seed 2: ATT = 1.2168, SE = 6.9180, p = 0.86074
 SubSubCat_Zopiclon | Seed 3: ATT = 1.4737, SE = 9.1712, p = 0.87267
 SubSubCat_Zopiclon | Seed 4: ATT = 1.1205, SE = 8.2785, p = 0.89261
 SubSubCat_Zopiclon | Seed 5: ATT = 1.0118, SE = 5.5790, p = 0.85646
 SubSubCat_Zopiclon | Seed 6: ATT = 1.7120, SE = 6.1902, p = 0.78269
 SubSubCat_Zopiclon | Seed 7: ATT = 1.3729, SE = 8.3469, p = 0.86969
 SubSubCat_Zopiclon | Seed 8: ATT = 1.7490, SE = 6.4881, p = 0.78805
 SubSubCat_Zopiclon | Seed 9: ATT = 2.4149, SE = 9.6740, p = 0.80340
 SubSubCat_Zopiclon | Seed 10: ATT = 2.4064, SE = 13.7240, p = 0.86117
 Best result for SubSubCat_Zopiclon  Seed 5 | SE = 5.5790
 Creating diagnostic plots for SubSubCat_Zopiclon...

 Running DML for SubSubCat_Bupropion
 SubSubCat_Bupropion | Seed 1: ATT = 2.9781, SE = 5.4429, p = 0.58550
 SubSubCat_Bupropion | Seed 2: ATT = 3.5492, SE = 5.5891, p = 0.52688
 SubSubCat_Bupropion | Seed 3: ATT = 3.3624, SE = 6.3586, p = 0.59813
 SubSubCat_Bupropion | Seed 4: ATT = 2.9209, SE = 6.4160, p = 0.64992
 SubSubCat_Bupropion | Seed 5: ATT = 3.4347, SE = 7.3615, p = 0.64183
 SubSubCat_Bupropion | Seed 6: ATT = 2.8863, SE = 6.6230, p = 0.66393
 SubSubCat_Bupropion | Seed 7: ATT = 3.9808, SE = 6.6701, p = 0.55199
 SubSubCat_Bupropion | Seed 8: ATT = 2.8330, SE = 5.8414, p = 0.62876
 SubSubCat_Bupropion | Seed 9: ATT = 2.7305, SE = 5.7008, p = 0.63302
 SubSubCat_Bupropion | Seed 10: ATT = 2.9274, SE = 6.3918, p = 0.64796
 Best result for SubSubCat_Bupropion  Seed 1 | SE = 5.4429
 Creating diagnostic plots for SubSubCat_Bupropion...

 Running DML for SubSubCat_Methylfenidaat
 SubSubCat_Methylfenidaat | Seed 1: ATT = -1.2436, SE = 4.2315, p = 0.76945
 SubSubCat_Methylfenidaat | Seed 2: ATT = -1.3408, SE = 4.2475, p = 0.75292
 SubSubCat_Methylfenidaat | Seed 3: ATT = -1.2801, SE = 4.4359, p = 0.77352
 SubSubCat_Methylfenidaat | Seed 4: ATT = -0.7618, SE = 4.6168, p = 0.86927
 SubSubCat_Methylfenidaat | Seed 5: ATT = -0.9340, SE = 4.2476, p = 0.82642
 SubSubCat_Methylfenidaat | Seed 6: ATT = -0.8615, SE = 3.9648, p = 0.82844
 SubSubCat_Methylfenidaat | Seed 7: ATT = -1.7033, SE = 4.2637, p = 0.69040
 SubSubCat_Methylfenidaat | Seed 8: ATT = -0.7975, SE = 4.4506, p = 0.85815
 SubSubCat_Methylfenidaat | Seed 9: ATT = -0.9203, SE = 3.9465, p = 0.81610
 SubSubCat_Methylfenidaat | Seed 10: ATT = -0.4140, SE = 5.3079, p = 0.93799
 Best result for SubSubCat_Methylfenidaat  Seed 9 | SE = 3.9465
 Creating diagnostic plots for SubSubCat_Methylfenidaat...

 Running DML for SubSubCat_Olanzapine
 SubSubCat_Olanzapine | Seed 1: ATT = 2.7136, SE = 7.7744, p = 0.72780
 SubSubCat_Olanzapine | Seed 2: ATT = 3.7471, SE = 7.5859, p = 0.62243
 SubSubCat_Olanzapine | Seed 3: ATT = 2.4701, SE = 7.0796, p = 0.72790
 SubSubCat_Olanzapine | Seed 4: ATT = 2.6093, SE = 7.6485, p = 0.73372
 SubSubCat_Olanzapine | Seed 5: ATT = 3.1347, SE = 7.9178, p = 0.69303
 SubSubCat_Olanzapine | Seed 6: ATT = 2.7574, SE = 6.8306, p = 0.68732
 SubSubCat_Olanzapine | Seed 7: ATT = 2.6819, SE = 6.6208, p = 0.68630
 SubSubCat_Olanzapine | Seed 8: ATT = 2.8319, SE = 6.5008, p = 0.66406
 SubSubCat_Olanzapine | Seed 9: ATT = 2.2067, SE = 7.1894, p = 0.75954
 SubSubCat_Olanzapine | Seed 10: ATT = 3.2222, SE = 6.7514, p = 0.63422
 Best result for SubSubCat_Olanzapine  Seed 8 | SE = 6.5008
 Creating diagnostic plots for SubSubCat_Olanzapine...

 All summary files saved.
 All diagnostic plots saved in outputs/plots/ folder.
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=b23bb9b1-4751-49b5-a763-e0e5fdcafc3f">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[90]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">sem</span><span class="p">,</span> <span class="n">ttest_ind</span>

<span class="c1"># ----------------------------------</span>
<span class="c1"># File paths</span>
<span class="c1"># ----------------------------------</span>
<span class="n">output_base</span> <span class="o">=</span> <span class="s2">"outputs"</span>
<span class="n">att_file</span> <span class="o">=</span> <span class="s2">"dml_rubin_summary_subsubcats.xlsx"</span>
<span class="n">trimmed_file</span> <span class="o">=</span> <span class="s2">"trimmed_data_imp1.pkl"</span>
<span class="n">auc_file</span> <span class="o">=</span> <span class="s2">"auc_scores.xlsx"</span>  <span class="c1"># NEW</span>

<span class="c1"># ----------------------------------</span>
<span class="c1"># Load ATT Summary</span>
<span class="c1"># ----------------------------------</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">att_file</span><span class="p">):</span>
    <span class="n">att_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">att_file</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">" ATT summary file not found: dml_rubin_summary_subsubcats.xlsx"</span><span class="p">)</span>

<span class="n">summary_rows</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># ----------------------------------</span>
<span class="c1"># Loop over medication groups</span>
<span class="c1"># ----------------------------------</span>
<span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">medication_groups</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">g</span><span class="p">))]</span>

<span class="k">for</span> <span class="n">med</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">group_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">med</span><span class="p">)</span>

        <span class="c1"># Load trimmed data</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="n">trimmed_file</span><span class="p">))</span>

        <span class="c1"># Detect treatment column</span>
        <span class="n">treatment_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">med</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">treatment_cols</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Treatment column </span><span class="si">{</span><span class="n">med</span><span class="si">}</span><span class="s2"> not found in trimmed data. Skipping."</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">treatment_var</span> <span class="o">=</span> <span class="n">treatment_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Extract treatment and outcome</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">"caps5_change_baseline"</span><span class="p">]</span>

        <span class="c1"># Treated and control stats</span>
        <span class="n">treated</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">control</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>

        <span class="n">mean_treat</span> <span class="o">=</span> <span class="n">treated</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">se_treat</span> <span class="o">=</span> <span class="n">sem</span><span class="p">(</span><span class="n">treated</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">treated</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">mean_ctrl</span> <span class="o">=</span> <span class="n">control</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">se_ctrl</span> <span class="o">=</span> <span class="n">sem</span><span class="p">(</span><span class="n">control</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">control</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Cohen's d (unadjusted)</span>
        <span class="n">pooled_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">treated</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">control</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">cohen_d</span> <span class="o">=</span> <span class="p">(</span><span class="n">mean_treat</span> <span class="o">-</span> <span class="n">mean_ctrl</span><span class="p">)</span> <span class="o">/</span> <span class="n">pooled_sd</span> <span class="k">if</span> <span class="n">pooled_sd</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># E-value (unadjusted)</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">mean_treat</span> <span class="o">-</span> <span class="n">mean_ctrl</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">delta</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">mean_ctrl</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">mean_ctrl</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Unadjusted p-value</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">t_stat</span><span class="p">,</span> <span class="n">p_val</span> <span class="o">=</span> <span class="n">ttest_ind</span><span class="p">(</span><span class="n">treated</span><span class="p">,</span> <span class="n">control</span><span class="p">,</span> <span class="n">equal_var</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nan_policy</span><span class="o">=</span><span class="s2">"omit"</span><span class="p">)</span>
            <span class="n">rounded_p</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">p_val</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="n">formatted_p</span> <span class="o">=</span> <span class="s2">"&lt; 0.00001"</span> <span class="k">if</span> <span class="n">rounded_p</span> <span class="o">&lt;</span> <span class="mf">0.00001</span> <span class="k">else</span> <span class="n">rounded_p</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">formatted_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># AUC from new auc_scores.xlsx file</span>
        <span class="n">auc_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">auc_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="n">auc_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">auc_path</span><span class="p">):</span>
            <span class="n">auc_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">auc_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">"AUC"</span> <span class="ow">in</span> <span class="n">auc_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">auc_val</span> <span class="o">=</span> <span class="n">auc_df</span><span class="p">[</span><span class="s2">"AUC"</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="c1"># Adjusted stats from Rubin summary</span>
        <span class="n">att_row</span> <span class="o">=</span> <span class="n">att_df</span><span class="p">[</span><span class="n">att_df</span><span class="p">[</span><span class="s2">"group"</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">med</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">att_row</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">att</span> <span class="o">=</span> <span class="n">att_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"att"</span><span class="p">]</span>
            <span class="n">att_se</span> <span class="o">=</span> <span class="n">att_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"se"</span><span class="p">]</span>
            <span class="n">att_p_val</span> <span class="o">=</span> <span class="n">att_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"p_value"</span><span class="p">]</span>
            <span class="n">r2</span> <span class="o">=</span> <span class="n">att_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"r2"</span><span class="p">]</span>
            <span class="n">rmse</span> <span class="o">=</span> <span class="n">att_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"rmse"</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">rounded_att_p</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">att_p_val</span><span class="p">),</span> <span class="mi">5</span><span class="p">)</span>
                <span class="n">formatted_att_p</span> <span class="o">=</span> <span class="s2">"&lt; 0.00001"</span> <span class="k">if</span> <span class="n">rounded_att_p</span> <span class="o">&lt;</span> <span class="mf">0.00001</span> <span class="k">else</span> <span class="n">rounded_att_p</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">formatted_att_p</span> <span class="o">=</span> <span class="n">att_p_val</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">att</span><span class="p">,</span> <span class="n">att_se</span><span class="p">,</span> <span class="n">formatted_att_p</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Append full row</span>
        <span class="n">summary_rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">'Medication Group'</span><span class="p">:</span> <span class="n">med</span><span class="p">,</span>
            <span class="s1">'Mean Treated'</span><span class="p">:</span> <span class="n">mean_treat</span><span class="p">,</span>
            <span class="s1">'SE Treated'</span><span class="p">:</span> <span class="n">se_treat</span><span class="p">,</span>
            <span class="s1">'Mean Control'</span><span class="p">:</span> <span class="n">mean_ctrl</span><span class="p">,</span>
            <span class="s1">'SE Control'</span><span class="p">:</span> <span class="n">se_ctrl</span><span class="p">,</span>
            <span class="s1">'Cohen d'</span><span class="p">:</span> <span class="n">cohen_d</span><span class="p">,</span>
            <span class="s1">'E (Unadjusted)'</span><span class="p">:</span> <span class="n">E</span><span class="p">,</span>
            <span class="s1">'n Treated'</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">treated</span><span class="p">),</span>
            <span class="s1">'n Control'</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">control</span><span class="p">),</span>
            <span class="c1">#'Unadjusted p-value': formatted_p,</span>
            <span class="s1">'ATT Estimate'</span><span class="p">:</span> <span class="n">att</span><span class="p">,</span>
            <span class="s1">'ATT SE (Robust)'</span><span class="p">:</span> <span class="n">att_se</span><span class="p">,</span>
            <span class="s1">'ATT p-value'</span><span class="p">:</span> <span class="n">formatted_att_p</span><span class="p">,</span>
            <span class="s1">'R'</span><span class="p">:</span> <span class="n">r2</span><span class="p">,</span>
            <span class="s1">'RMSE'</span><span class="p">:</span> <span class="n">rmse</span><span class="p">,</span>
            <span class="s1">'AUC'</span><span class="p">:</span> <span class="n">auc_val</span>
        <span class="p">})</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error in </span><span class="si">{</span><span class="n">med</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># ----------------------------------</span>
<span class="c1"># Save final summary</span>
<span class="c1"># ----------------------------------</span>
<span class="n">summary_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">summary_rows</span><span class="p">)</span>
<span class="n">summary_df</span> <span class="o">=</span> <span class="n">summary_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">"Medication Group"</span><span class="p">)</span>
<span class="n">summary_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">"Final_ATT_Summary_SubSubCat.xlsx"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">" Final_ATT_Summary_SubSubCat saved"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre> Final_ATT_Summary_SubSubCat saved
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=e0b5aa46-fbe0-494a-9624-19a4b9e2d32b">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[91]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.backends.backend_pdf</span> <span class="kn">import</span> <span class="n">PdfPages</span>

<span class="c1">#  Load the final summary table</span>
<span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s2">"Final_ATT_Summary_SubSubCat.xlsx"</span><span class="p">)</span>

<span class="c1">#  Parse DML p-values (handle "&lt; 0.00001")</span>
<span class="k">def</span> <span class="nf">parse_pval</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">"&lt;"</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.000001</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

<span class="n">final_df</span><span class="p">[</span><span class="s1">'ATT p-value'</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="s1">'ATT p-value'</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">parse_pval</span><span class="p">)</span>

<span class="c1">#  Plot settings</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>

<span class="c1">#  Plotting function for a single medication group</span>
<span class="k">def</span> <span class="nf">plot_single_group</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    
    <span class="n">bars1</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="o">-</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">'Mean Control'</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> 
                   <span class="n">yerr</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">'SE Control'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">'Control'</span><span class="p">,</span> <span class="n">hatch</span><span class="o">=</span><span class="s1">'//'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">bars2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="o">+</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">'Mean Treated'</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> 
                   <span class="n">yerr</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">'SE Treated'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">'Treated'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'steelblue'</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

    <span class="n">label</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">"ATT = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'ATT Estimate'</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span>
        <span class="sa">f</span><span class="s2">"d = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'Cohen d'</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, p = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'ATT p-value'</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span>
        <span class="sa">f</span><span class="s2">"nT = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'n Treated'</span><span class="p">]</span><span class="si">}</span><span class="s2">, nC = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'n Control'</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span>
        <span class="sa">f</span><span class="s2">"E = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'E (Unadjusted)'</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%"</span>
    <span class="p">)</span>
    <span class="n">max_y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">'Mean Control'</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">'Mean Treated'</span><span class="p">])</span> <span class="o">+</span> <span class="mf">1.5</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_y</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">'center'</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">'bottom'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'#FFD700'</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'black'</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="o">-</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">+</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">'Control'</span><span class="p">,</span> <span class="s1">'Treated'</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Group: </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'Medication Group'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">'bold'</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"CAPS5 Change Score"</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="n">max_y</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">fig</span>

<span class="c1">#  Generate and save all plots into a multi-page PDF</span>
<span class="k">with</span> <span class="n">PdfPages</span><span class="p">(</span><span class="s2">"dml_att_barplot_subsubcat.pdf"</span><span class="p">)</span> <span class="k">as</span> <span class="n">pdf</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">final_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_single_group</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="n">pdf</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">'tight'</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">" dml_att_barplot_subsubcat is saved."</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre> dml_att_barplot_subsubcat is saved.
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=114d4815-ba90-4c26-b19c-95420b6cfd65">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[92]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Love plot:</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=fe90a956-216d-4c92-8adb-1a2611aa0b0b">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[93]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="c1"># ----------------------------------------</span>
<span class="c1"># Functions to calculate balance</span>
<span class="c1"># ----------------------------------------</span>
<span class="k">def</span> <span class="nf">calculate_smd</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">w1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">w2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">weighted_mean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span> <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">weighted_var</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">m</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
    
    <span class="n">m1</span> <span class="o">=</span> <span class="n">weighted_mean</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">w1</span><span class="p">)</span> <span class="k">if</span> <span class="n">w1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
    <span class="n">m2</span> <span class="o">=</span> <span class="n">weighted_mean</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span> <span class="k">if</span> <span class="n">w2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">weighted_var</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">w1</span><span class="p">)</span> <span class="k">if</span> <span class="n">w1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">weighted_var</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span> <span class="k">if</span> <span class="n">w2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">pooled_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">v1</span> <span class="o">+</span> <span class="n">v2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">m1</span> <span class="o">-</span> <span class="n">m2</span><span class="p">)</span> <span class="o">/</span> <span class="n">pooled_sd</span> <span class="k">if</span> <span class="n">pooled_sd</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">variance_ratio</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">w1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">w2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">weighted_var</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">m</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
    
    <span class="n">v1</span> <span class="o">=</span> <span class="n">weighted_var</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">w1</span><span class="p">)</span> <span class="k">if</span> <span class="n">w1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">weighted_var</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span> <span class="k">if</span> <span class="n">w2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">v1</span> <span class="o">/</span> <span class="n">v2</span><span class="p">,</span> <span class="n">v2</span> <span class="o">/</span> <span class="n">v1</span><span class="p">)</span> <span class="k">if</span> <span class="n">v1</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">v2</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>

<span class="c1"># ----------------------------------------</span>
<span class="c1"># Setup</span>
<span class="c1"># ----------------------------------------</span>
<span class="n">output_base</span> <span class="o">=</span> <span class="s2">"outputs"</span>
<span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">output_base</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">g</span><span class="p">))]</span>

<span class="c1"># Create a case-insensitive mapping</span>
<span class="n">final_covariates_map_lower</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="c1"># ----------------------------------------</span>
<span class="c1"># Main Loop</span>
<span class="c1"># ----------------------------------------</span>
<span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">group</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_covariates_map_lower</span><span class="p">:</span>
        <span class="k">continue</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Processing </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">..."</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">group_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">covariates</span> <span class="o">=</span> <span class="n">final_covariates_map_lower</span><span class="p">[</span><span class="n">group</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        
        <span class="n">column_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="s2">"trimmed_data_imp1.pkl"</span><span class="p">))</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">group</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">column_name</span> <span class="o">=</span> <span class="n">col</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">column_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Column not found for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">, skipping."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">smd_unw_all</span><span class="p">,</span> <span class="n">smd_w_all</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">vr_unw_all</span><span class="p">,</span> <span class="n">vr_w_all</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
            <span class="n">df_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"trimmed_data_imp</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.pkl"</span><span class="p">)</span>
            <span class="n">iptw_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="s2">"iptw_weights.xlsx"</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">df_path</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">iptw_path</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Missing data for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> imp</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, skipping."</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">df_path</span><span class="p">)</span>
            <span class="n">iptw_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">iptw_path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span>
            <span class="n">W</span> <span class="o">=</span> <span class="n">iptw_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s2">"iptw_mean"</span><span class="p">]</span>

            <span class="n">smd_unw_i</span><span class="p">,</span> <span class="n">smd_w_i</span><span class="p">,</span> <span class="n">vr_unw_i</span><span class="p">,</span> <span class="n">vr_w_i</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">cov</span> <span class="ow">in</span> <span class="n">covariates</span><span class="p">:</span>
                <span class="n">x1</span><span class="p">,</span> <span class="n">x0</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cov</span><span class="p">],</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cov</span><span class="p">]</span>
                <span class="n">w1</span><span class="p">,</span> <span class="n">w0</span> <span class="o">=</span> <span class="n">W</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">],</span> <span class="n">W</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>

                <span class="n">su</span> <span class="o">=</span> <span class="n">calculate_smd</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x0</span><span class="p">)</span>
                <span class="n">sw</span> <span class="o">=</span> <span class="n">calculate_smd</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">w0</span><span class="p">)</span>

                <span class="n">vu</span> <span class="o">=</span> <span class="n">variance_ratio</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x0</span><span class="p">)</span> <span class="k">if</span> <span class="n">cov</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">]</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">vw</span> <span class="o">=</span> <span class="n">variance_ratio</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">w0</span><span class="p">)</span> <span class="k">if</span> <span class="n">cov</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">]</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

                <span class="n">smd_unw_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">su</span><span class="p">)</span>
                <span class="n">smd_w_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sw</span><span class="p">)</span>
                <span class="n">vr_unw_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vu</span><span class="p">)</span>
                <span class="n">vr_w_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vw</span><span class="p">)</span>

            <span class="n">smd_unw_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smd_unw_i</span><span class="p">)</span>
            <span class="n">smd_w_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smd_w_i</span><span class="p">)</span>
            <span class="n">vr_unw_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vr_unw_i</span><span class="p">)</span>
            <span class="n">vr_w_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vr_w_i</span><span class="p">)</span>

        <span class="n">smd_unw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">smd_unw_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">smd_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">smd_w_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">vr_unw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">vr_unw_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">vr_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">vr_w_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">severity</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sw</span> <span class="ow">in</span> <span class="n">smd_w</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sw</span> <span class="o">&lt;=</span> <span class="mf">0.1</span><span class="p">:</span>
                <span class="n">severity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"Good"</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">sw</span> <span class="o">&lt;=</span> <span class="mf">0.2</span><span class="p">:</span>
                <span class="n">severity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"Moderate"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">severity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"Poor"</span><span class="p">)</span>

        <span class="n">covariate_names</span> <span class="o">=</span> <span class="n">covariates</span>
        <span class="n">numeric_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s2">"Covariate"</span><span class="p">:</span> <span class="n">covariate_names</span><span class="p">,</span>
            <span class="s2">"SMD_Unweighted"</span><span class="p">:</span> <span class="n">smd_unw</span><span class="p">,</span>
            <span class="s2">"SMD_Weighted"</span><span class="p">:</span> <span class="n">smd_w</span><span class="p">,</span>
            <span class="s2">"Imbalance_Severity"</span><span class="p">:</span> <span class="n">severity</span><span class="p">,</span>
            <span class="s2">"VR_Unweighted"</span><span class="p">:</span> <span class="n">vr_unw</span><span class="p">,</span>
            <span class="s2">"VR_Weighted"</span><span class="p">:</span> <span class="n">vr_w</span>
        <span class="p">})</span>

        <span class="n">numeric_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"covariate_balance_table_</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">.xlsx"</span><span class="p">)</span>
        <span class="n">numeric_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">numeric_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Exported numeric summary to: </span><span class="si">{</span><span class="n">numeric_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># -------------------------</span>
        <span class="c1"># Plot</span>
        <span class="c1"># -------------------------</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">covariates</span>
        <span class="n">y_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.45</span><span class="p">))</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">smd_unw</span><span class="p">,</span> <span class="n">y_pos</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Unweighted"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">smd_w</span><span class="p">,</span> <span class="n">y_pos</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'blue'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Weighted"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Threshold 0.1"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'black'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Threshold 0.2"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">smd_unw</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">smd_w</span><span class="p">),</span> <span class="mf">0.25</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">y_pos</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Standardized Mean Differences (SMD)"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">"upper right"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">vr_mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">cov</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">]</span> <span class="k">for</span> <span class="n">cov</span> <span class="ow">in</span> <span class="n">covariates</span><span class="p">]</span>
        <span class="n">filtered_y</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vr_mask</span><span class="p">)</span> <span class="k">if</span> <span class="n">b</span><span class="p">]</span>
        <span class="n">filtered_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">filtered_y</span><span class="p">]</span>
        <span class="n">filtered_vr_unw</span> <span class="o">=</span> <span class="p">[</span><span class="n">vr_unw</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">filtered_y</span><span class="p">]</span>
        <span class="n">filtered_vr_w</span> <span class="o">=</span> <span class="p">[</span><span class="n">vr_w</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">filtered_y</span><span class="p">]</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">filtered_vr_unw</span><span class="p">,</span> <span class="n">filtered_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'blue'</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">'o'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Unweighted"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">filtered_vr_w</span><span class="p">,</span> <span class="n">filtered_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">'x'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Weighted"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">filtered_vr_unw</span> <span class="o">+</span> <span class="n">filtered_vr_w</span> <span class="o">+</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">])</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">filtered_y</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">filtered_labels</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Variance Ratio (VR)"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Covariate Balance for </span><span class="si">{</span><span class="n">group</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'CAT_'</span><span class="p">,</span><span class="w"> </span><span class="s1">''</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">'bold'</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.96</span><span class="p">])</span>
        <span class="n">plot_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"love_plot_</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">.pdf"</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Saved love plot: </span><span class="si">{</span><span class="n">plot_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Max weighted SMD for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">smd_w</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Processing SUBSUBCAT_Amitriptyline...
 Exported numeric summary to: outputs\SUBSUBCAT_Amitriptyline\covariate_balance_table_SUBSUBCAT_Amitriptyline.xlsx
 Saved love plot: outputs\SUBSUBCAT_Amitriptyline\love_plot_SUBSUBCAT_Amitriptyline.pdf
 Max weighted SMD for SUBSUBCAT_Amitriptyline: 0.364

 Processing SUBSUBCAT_Bupropion...
 Exported numeric summary to: outputs\SUBSUBCAT_Bupropion\covariate_balance_table_SUBSUBCAT_Bupropion.xlsx
 Saved love plot: outputs\SUBSUBCAT_Bupropion\love_plot_SUBSUBCAT_Bupropion.pdf
 Max weighted SMD for SUBSUBCAT_Bupropion: 0.309

 Processing SUBSUBCAT_Citalopram...
 Exported numeric summary to: outputs\SUBSUBCAT_Citalopram\covariate_balance_table_SUBSUBCAT_Citalopram.xlsx
 Saved love plot: outputs\SUBSUBCAT_Citalopram\love_plot_SUBSUBCAT_Citalopram.pdf
 Max weighted SMD for SUBSUBCAT_Citalopram: 0.224

 Processing SUBSUBCAT_Diazepam...
 Exported numeric summary to: outputs\SUBSUBCAT_Diazepam\covariate_balance_table_SUBSUBCAT_Diazepam.xlsx
 Saved love plot: outputs\SUBSUBCAT_Diazepam\love_plot_SUBSUBCAT_Diazepam.pdf
 Max weighted SMD for SUBSUBCAT_Diazepam: 0.398

 Processing SUBSUBCAT_Escitalopram...
 Exported numeric summary to: outputs\SUBSUBCAT_Escitalopram\covariate_balance_table_SUBSUBCAT_Escitalopram.xlsx
 Saved love plot: outputs\SUBSUBCAT_Escitalopram\love_plot_SUBSUBCAT_Escitalopram.pdf
 Max weighted SMD for SUBSUBCAT_Escitalopram: 0.261

 Processing SUBSUBCAT_Fluoxetine...
 Exported numeric summary to: outputs\SUBSUBCAT_Fluoxetine\covariate_balance_table_SUBSUBCAT_Fluoxetine.xlsx
 Saved love plot: outputs\SUBSUBCAT_Fluoxetine\love_plot_SUBSUBCAT_Fluoxetine.pdf
 Max weighted SMD for SUBSUBCAT_Fluoxetine: 0.307

 Processing SUBSUBCAT_Lorazepam...
 Exported numeric summary to: outputs\SUBSUBCAT_Lorazepam\covariate_balance_table_SUBSUBCAT_Lorazepam.xlsx
 Saved love plot: outputs\SUBSUBCAT_Lorazepam\love_plot_SUBSUBCAT_Lorazepam.pdf
 Max weighted SMD for SUBSUBCAT_Lorazepam: 0.424

 Processing SUBSUBCAT_Methylfenidaat...
 Exported numeric summary to: outputs\SUBSUBCAT_Methylfenidaat\covariate_balance_table_SUBSUBCAT_Methylfenidaat.xlsx
 Saved love plot: outputs\SUBSUBCAT_Methylfenidaat\love_plot_SUBSUBCAT_Methylfenidaat.pdf
 Max weighted SMD for SUBSUBCAT_Methylfenidaat: 0.466

 Processing SUBSUBCAT_Mirtazapine...
 Exported numeric summary to: outputs\SUBSUBCAT_Mirtazapine\covariate_balance_table_SUBSUBCAT_Mirtazapine.xlsx
 Saved love plot: outputs\SUBSUBCAT_Mirtazapine\love_plot_SUBSUBCAT_Mirtazapine.pdf
 Max weighted SMD for SUBSUBCAT_Mirtazapine: 0.263

 Processing SUBSUBCAT_Olanzapine...
 Exported numeric summary to: outputs\SUBSUBCAT_Olanzapine\covariate_balance_table_SUBSUBCAT_Olanzapine.xlsx
 Saved love plot: outputs\SUBSUBCAT_Olanzapine\love_plot_SUBSUBCAT_Olanzapine.pdf
 Max weighted SMD for SUBSUBCAT_Olanzapine: 0.297

 Processing SUBSUBCAT_Oxazepam...
 Exported numeric summary to: outputs\SUBSUBCAT_Oxazepam\covariate_balance_table_SUBSUBCAT_Oxazepam.xlsx
 Saved love plot: outputs\SUBSUBCAT_Oxazepam\love_plot_SUBSUBCAT_Oxazepam.pdf
 Max weighted SMD for SUBSUBCAT_Oxazepam: 0.162

 Processing SUBSUBCAT_Paracetamol...
 Exported numeric summary to: outputs\SUBSUBCAT_Paracetamol\covariate_balance_table_SUBSUBCAT_Paracetamol.xlsx
 Saved love plot: outputs\SUBSUBCAT_Paracetamol\love_plot_SUBSUBCAT_Paracetamol.pdf
 Max weighted SMD for SUBSUBCAT_Paracetamol: 0.388

 Processing SUBSUBCAT_Quetiapine...
 Exported numeric summary to: outputs\SUBSUBCAT_Quetiapine\covariate_balance_table_SUBSUBCAT_Quetiapine.xlsx
 Saved love plot: outputs\SUBSUBCAT_Quetiapine\love_plot_SUBSUBCAT_Quetiapine.pdf
 Max weighted SMD for SUBSUBCAT_Quetiapine: 0.189

 Processing SUBSUBCAT_Sertraline...
 Exported numeric summary to: outputs\SUBSUBCAT_Sertraline\covariate_balance_table_SUBSUBCAT_Sertraline.xlsx
 Saved love plot: outputs\SUBSUBCAT_Sertraline\love_plot_SUBSUBCAT_Sertraline.pdf
 Max weighted SMD for SUBSUBCAT_Sertraline: 0.141

 Processing SUBSUBCAT_Temazepam...
 Exported numeric summary to: outputs\SUBSUBCAT_Temazepam\covariate_balance_table_SUBSUBCAT_Temazepam.xlsx
 Saved love plot: outputs\SUBSUBCAT_Temazepam\love_plot_SUBSUBCAT_Temazepam.pdf
 Max weighted SMD for SUBSUBCAT_Temazepam: 0.249

 Processing SUBSUBCAT_Topiramaat...
 Exported numeric summary to: outputs\SUBSUBCAT_Topiramaat\covariate_balance_table_SUBSUBCAT_Topiramaat.xlsx
 Saved love plot: outputs\SUBSUBCAT_Topiramaat\love_plot_SUBSUBCAT_Topiramaat.pdf
 Max weighted SMD for SUBSUBCAT_Topiramaat: 0.516

 Processing SUBSUBCAT_Venlafaxine...
 Exported numeric summary to: outputs\SUBSUBCAT_Venlafaxine\covariate_balance_table_SUBSUBCAT_Venlafaxine.xlsx
 Saved love plot: outputs\SUBSUBCAT_Venlafaxine\love_plot_SUBSUBCAT_Venlafaxine.pdf
 Max weighted SMD for SUBSUBCAT_Venlafaxine: 0.220

 Processing SUBSUBCAT_Zopiclon...
 Exported numeric summary to: outputs\SUBSUBCAT_Zopiclon\covariate_balance_table_SUBSUBCAT_Zopiclon.xlsx
 Saved love plot: outputs\SUBSUBCAT_Zopiclon\love_plot_SUBSUBCAT_Zopiclon.pdf
 Max weighted SMD for SUBSUBCAT_Zopiclon: 0.393
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=04890d8f-3ebd-485f-8faa-42e595e1b1fb">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[94]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Heatmap:</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=691f11f8-4131-4292-8b21-03e8f19df707">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[95]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="c1">#-----------------------------</span>
<span class="c1"># Generate heatmaps</span>
<span class="c1"># -------------------------------</span>
<span class="k">for</span> <span class="n">treatment_var</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">========== Creating Heatmap for </span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s2"> =========="</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">'outputs'</span><span class="p">,</span> <span class="n">treatment_var</span><span class="p">)</span>
        <span class="n">balance_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'covariate_balance_table_</span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s1">.xlsx'</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">balance_path</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Balance file not found: </span><span class="si">{</span><span class="n">balance_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">balance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">balance_path</span><span class="p">)</span>

        <span class="c1">#  Use finalized covariates + 'Propensity Score'</span>
        <span class="n">covariates</span> <span class="o">=</span> <span class="n">final_covariates_map</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">'Propensity Score'</span><span class="p">]</span>
        <span class="n">balance_df</span> <span class="o">=</span> <span class="n">balance_df</span><span class="p">[</span><span class="n">balance_df</span><span class="p">[</span><span class="s1">'Covariate'</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">covariates</span><span class="p">)]</span>

        <span class="c1">#  Check for CAPS5score_baseline</span>
        <span class="n">highlight_caps</span> <span class="o">=</span> <span class="s1">'CAPS5score_baseline'</span> <span class="ow">in</span> <span class="n">balance_df</span><span class="p">[</span><span class="s1">'Covariate'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="c1">#  Format for heatmap</span>
        <span class="n">heatmap_df</span> <span class="o">=</span> <span class="n">balance_df</span><span class="p">[[</span><span class="s1">'Covariate'</span><span class="p">,</span> <span class="s1">'SMD_Unweighted'</span><span class="p">,</span> <span class="s1">'SMD_Weighted'</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">heatmap_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'Covariate'</span><span class="p">,</span> <span class="s1">'Unweighted'</span><span class="p">,</span> <span class="s1">'Weighted'</span><span class="p">]</span>
        <span class="n">heatmap_df</span> <span class="o">=</span> <span class="n">heatmap_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">'Covariate'</span><span class="p">)</span>
        <span class="n">heatmap_df</span> <span class="o">=</span> <span class="n">heatmap_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">'Unweighted'</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1">#  Plot</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">heatmap_df</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.35</span><span class="p">)))</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span>
            <span class="n">heatmap_df</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="s2">"coolwarm"</span><span class="p">,</span>
            <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">fmt</span><span class="o">=</span><span class="s2">".2f"</span><span class="p">,</span>
            <span class="n">linewidths</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
            <span class="n">linecolor</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span>
            <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">"label"</span><span class="p">:</span> <span class="s2">"Standardized Mean Difference"</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Covariate Balance Heatmap (Rubin IPTW)</span><span class="se">\n</span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">'bold'</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Condition"</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"Covariate"</span><span class="p">)</span>

        <span class="c1">#  Bold CAPS5score_baseline if present</span>
        <span class="k">if</span> <span class="n">highlight_caps</span><span class="p">:</span>
            <span class="n">ylabels</span> <span class="o">=</span> <span class="p">[</span><span class="n">label</span><span class="o">.</span><span class="n">get_text</span><span class="p">()</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span>
                <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2"> "</span> <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="s1">'CAPS5score_baseline'</span> <span class="k">else</span> <span class="n">label</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ylabels</span>
            <span class="p">])</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="c1">#  Save image</span>
        <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'heatmap_smd_</span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s1">.png'</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Heatmap saved: </span><span class="si">{</span><span class="n">save_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error processing </span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
========== Creating Heatmap for SubSubCat_Oxazepam ==========
 Heatmap saved: outputs\SubSubCat_Oxazepam\heatmap_smd_SubSubCat_Oxazepam.png

========== Creating Heatmap for SubSubCat_Diazepam ==========
 Heatmap saved: outputs\SubSubCat_Diazepam\heatmap_smd_SubSubCat_Diazepam.png

========== Creating Heatmap for SubSubCat_Paracetamol ==========
 Heatmap saved: outputs\SubSubCat_Paracetamol\heatmap_smd_SubSubCat_Paracetamol.png

========== Creating Heatmap for SubSubCat_Lorazepam ==========
 Heatmap saved: outputs\SubSubCat_Lorazepam\heatmap_smd_SubSubCat_Lorazepam.png

========== Creating Heatmap for SubSubCat_Mirtazapine ==========
 Heatmap saved: outputs\SubSubCat_Mirtazapine\heatmap_smd_SubSubCat_Mirtazapine.png

========== Creating Heatmap for SubSubCat_Escitalopram ==========
 Heatmap saved: outputs\SubSubCat_Escitalopram\heatmap_smd_SubSubCat_Escitalopram.png

========== Creating Heatmap for SubSubCat_Sertraline ==========
 Heatmap saved: outputs\SubSubCat_Sertraline\heatmap_smd_SubSubCat_Sertraline.png

========== Creating Heatmap for SubSubCat_Temazepam ==========
 Heatmap saved: outputs\SubSubCat_Temazepam\heatmap_smd_SubSubCat_Temazepam.png

========== Creating Heatmap for SubSubCat_Citalopram ==========
 Heatmap saved: outputs\SubSubCat_Citalopram\heatmap_smd_SubSubCat_Citalopram.png

========== Creating Heatmap for SubSubCat_Quetiapine ==========
 Heatmap saved: outputs\SubSubCat_Quetiapine\heatmap_smd_SubSubCat_Quetiapine.png

========== Creating Heatmap for SubSubCat_Amitriptyline ==========
 Heatmap saved: outputs\SubSubCat_Amitriptyline\heatmap_smd_SubSubCat_Amitriptyline.png

========== Creating Heatmap for SubSubCat_Venlafaxine ==========
 Heatmap saved: outputs\SubSubCat_Venlafaxine\heatmap_smd_SubSubCat_Venlafaxine.png

========== Creating Heatmap for SubSubCat_Fluoxetine ==========
 Heatmap saved: outputs\SubSubCat_Fluoxetine\heatmap_smd_SubSubCat_Fluoxetine.png

========== Creating Heatmap for SubSubCat_Topiramaat ==========
 Heatmap saved: outputs\SubSubCat_Topiramaat\heatmap_smd_SubSubCat_Topiramaat.png

========== Creating Heatmap for SubSubCat_Zopiclon ==========
 Heatmap saved: outputs\SubSubCat_Zopiclon\heatmap_smd_SubSubCat_Zopiclon.png

========== Creating Heatmap for SubSubCat_Bupropion ==========
 Heatmap saved: outputs\SubSubCat_Bupropion\heatmap_smd_SubSubCat_Bupropion.png

========== Creating Heatmap for SubSubCat_Methylfenidaat ==========
 Heatmap saved: outputs\SubSubCat_Methylfenidaat\heatmap_smd_SubSubCat_Methylfenidaat.png

========== Creating Heatmap for SubSubCat_Olanzapine ==========
 Heatmap saved: outputs\SubSubCat_Olanzapine\heatmap_smd_SubSubCat_Olanzapine.png
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=ff8b09ff-b822-4215-914f-d0c7eff9d1e0">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span> 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=a106ae6e-11d7-4f9a-88a0-aece43009c21">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h4 id="XGBOOST:">XGBOOST:<a class="anchor-link" href="#XGBOOST:"></a></h4>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=07982f2f-0c44-4cb6-b160-9503e73823f7">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[96]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">"ignore"</span><span class="p">)</span>  <span class="c1"># optional</span>

<span class="c1"># Option 1 (recommended)</span>
<span class="n">new_path</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">"D:\Work\PTSD_Followup\XGBoost"</span>

<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">new_path</span><span class="p">)</span>  <span class="c1"># Change working directory</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Changed to:"</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Changed to: D:\Work\PTSD_Followup\XGBoost
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=2621a257-5400-454e-b562-e4fe7819d2dc">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[97]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">r</span><span class="s2">"data_baseline.csv"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=3c01f361-e551-42fc-924c-069010cd0a3d">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="CAT-analysis:">CAT analysis:<a class="anchor-link" href="#CAT-analysis:"></a></h2>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=03c51cc7-4bbe-48de-88d5-4c1ad720814c">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[98]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Import all necessary packages</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="c1"># For visualization and future steps</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="kn">from</span> <span class="nn">sklearn.experimental</span> <span class="kn">import</span> <span class="n">enable_iterative_imputer</span>  <span class="c1"># Needed to enable the experimental feature</span>
<span class="kn">from</span> <span class="nn">sklearn.impute</span> <span class="kn">import</span> <span class="n">IterativeImputer</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=47fb8af6-310c-42fc-89c1-39f8ea616894">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[99]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Check basic structure</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Shape of dataset:"</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Sample columns:"</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[:</span><span class="mi">10</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Missing values:</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>

<span class="c1"># Remove duplicate rows</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>

<span class="c1"># Confirm shape after removing duplicates</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Shape after removing duplicates:"</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Shape of dataset: (6125, 465)

Sample columns: ['CIN5', 'StartDatum', 'BEH_MOD', 'BEHDAGEN_GEPLAND', 'AANTAL_PCL', 'TOESTWO', 'BEH_AFG', 'TK', 'MM_CAPS_IN', 'MM_CAPS_TK']

Missing values:
 instrument_SDV_IN    6125
Eaantal_TK           6125
Dcriterium_FU        6125
Cernst_FU            6125
Caantal_FU           6125
Ccriterium_FU        6125
Bernst_FU            6125
Baantal_FU           6125
Bcriterium_FU        6125
Eernst_TK            6125
dtype: int64
Shape after removing duplicates: (6125, 465)
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=2eb247f3-f275-4664-8ff6-6a31c04a8607">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[100]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pyreadstat</span>

<span class="c1"># Load gender info</span>
<span class="n">gender_df</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">pyreadstat</span><span class="o">.</span><span class="n">read_sav</span><span class="p">(</span><span class="s2">"SDV_IN_Gender_2019_2024.sav"</span><span class="p">)</span>

<span class="c1"># Just extract SDV_SEXE column and append to df</span>
<span class="n">df</span><span class="p">[</span><span class="s2">"SDV_SEXE"</span><span class="p">]</span> <span class="o">=</span> <span class="n">gender_df</span><span class="p">[</span><span class="s2">"SDV_SEXE"</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Optional: map to labels</span>
<span class="n">gender_map</span> <span class="o">=</span> <span class="p">{</span><span class="mf">1.0</span><span class="p">:</span> <span class="s2">"Male"</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">:</span> <span class="s2">"Female"</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">:</span> <span class="s2">"Other"</span><span class="p">}</span>
<span class="n">df</span><span class="p">[</span><span class="s2">"gender_label"</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">"SDV_SEXE"</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">gender_map</span><span class="p">)</span>

<span class="c1"># Done! Check a sample</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s2">"SDV_SEXE"</span><span class="p">,</span> <span class="s2">"gender_label"</span><span class="p">]]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>SDV_SEXE  gender_label
2.0       Female          4602
1.0       Male            1475
3.0       Other             48
Name: count, dtype: int64
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=aa490857-cce0-4727-b0bb-2bc44c774b51">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[101]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Assuming 'gender' and 'SDV_SEXE' columns are in df</span>

<span class="c1"># Gender dummy variables</span>
<span class="n">df</span><span class="p">[</span><span class="s1">'gender_1'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">'gender'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">'gender_2'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">'gender'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># SDV_SEXE dummy variables</span>
<span class="n">df</span><span class="p">[</span><span class="s1">'SDV_SEXE_1'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">'SDV_SEXE'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">'SDV_SEXE_2'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">'SDV_SEXE'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">'SDV_SEXE_3'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">'SDV_SEXE'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># Create binary columns</span>
<span class="n">df</span><span class="p">[</span><span class="s1">'ethnicity_Dutch'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">'ethnicity'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">'ethnicity_other'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">'ethnicity'</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=58abf5c6-b900-48da-b440-c1363e17e6a7">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[102]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Columns manually identified for removal (example set from the R script)</span>
<span class="n">cols_to_drop</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'gender'</span><span class="p">,</span> <span class="s1">'ethnicity'</span><span class="p">,</span> <span class="s1">'CIN5'</span><span class="p">,</span> <span class="s1">'SDV_SEXE'</span><span class="p">,</span> <span class="s1">'StartDatum'</span><span class="p">,</span> <span class="s1">'STARTDATUM'</span><span class="p">,</span> <span class="s1">'DROPOUT_EARLYCOMPLETER'</span><span class="p">,</span> <span class="s1">'TOEST_WO'</span><span class="p">,</span>
    <span class="s1">'depressie_IN'</span><span class="p">,</span> <span class="s1">'TERUGKOMER'</span><span class="p">,</span> <span class="s1">'VROEGK_ST'</span><span class="p">,</span> <span class="s1">'gender_label'</span><span class="p">,</span>
    <span class="s1">'depr_m_psychose_huid'</span><span class="p">,</span> <span class="s1">'depr_z_psychose_huid'</span><span class="p">,</span> <span class="s1">'depr_z_psychose_verl'</span><span class="p">,</span>
    <span class="s1">'depr_m_psychose_verl'</span><span class="p">,</span> <span class="s1">'CAPS5score_followup'</span><span class="p">,</span> <span class="s1">'CAPS5_DAT_IN'</span>
<span class="p">]</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols_to_drop</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Remaining columns:"</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Remaining columns: 458
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=aed28f36-9f83-46ee-ad68-ce8bb17f0b60">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[103]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="k">if</span> <span class="s1">'BEH_DAGEN'</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">'BEH_DAGEN'</span><span class="p">:</span> <span class="s1">'treatmentdurationdays'</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=7ebe3d23-51c4-450e-9401-3653a8d2f548">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[104]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Clean and standardize column names</span>
<span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
    <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s2">"\.+"</span><span class="p">,</span> <span class="s2">"_"</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s2">"[^a-zA-Z0-9_]"</span><span class="p">,</span> <span class="s2">""</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">" "</span><span class="p">,</span> <span class="s2">"_"</span><span class="p">)</span>
    <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=63bf737a-7d2b-40ae-a33a-78fb08d6fa41">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[105]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Preview key outcome variables</span>
<span class="n">outcome_vars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'CAPS5Score_TK'</span><span class="p">]</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">outcome_vars</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2"> missing"</span><span class="p">)</span>

<span class="c1"># Calculate change score</span>
<span class="k">if</span> <span class="s1">'CAPS5score_baseline'</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s1">'CAPS5Score_TK'</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">'caps5_change_baseline'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">'CAPS5Score_TK'</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">'CAPS5score_baseline'</span><span class="p">]</span> 
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>CAPS5score_baseline: 0 missing
CAPS5Score_TK: 0 missing
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=db544569-90b1-428a-9dfa-181d1fbd95e3">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[106]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Define exceptions to keep</span>
<span class="n">protected_cols</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">"DIAGNOSIS_ANXIETY_OCD"</span><span class="p">,</span>
    <span class="s2">"DIAGNOSIS_PSYCHOTIC"</span><span class="p">,</span>
    <span class="s2">"DIAGNOSIS_EATING_DISORDER"</span><span class="p">,</span>
    <span class="s2">"DIAGNOSIS_SUBSTANCE_DISORDER"</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"EB_NON_TF_THERAPY"</span><span class="p">,</span> <span class="s2">"OTHER_TREATM_APPROACH"</span><span class="p">,</span> <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s1">'SUBCAT_Selectieve_immunosuppresiva'</span><span class="p">,</span> <span class="s1">'treatmentdurationdays'</span><span class="p">,</span>
<span class="s1">'SUBCAT_Corticosteroiden'</span><span class="p">,</span>
<span class="s1">'SUBCAT_Immunomodulerend_Coxibs'</span><span class="p">,</span>
<span class="s1">'SUBCAT_Aminosalicylaten'</span><span class="p">,</span>
<span class="s1">'SUBCAT_calcineurineremmers'</span><span class="p">,</span>
<span class="s1">'SUBCAT_Anti_epileptica_Benzodiazepine'</span><span class="p">,</span>
<span class="s1">'SUBCAT_Paracetamol_overig_combinatie'</span><span class="p">,</span> <span class="s1">'SUBCAT_MAO_remmers'</span><span class="p">,</span> <span class="s1">'SUBCAT_psychostimulans_overige'</span><span class="p">,</span> <span class="s1">'SUBCAT_Interleukine_remmers'</span>

<span class="p">]</span>


<span class="c1"># ----------------------------------------</span>
<span class="c1"># 1. Drop columns with &gt;95% missing values (except protected)</span>
<span class="n">thresh_missing</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.95</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
<span class="n">missing_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">-</span> <span class="n">thresh_missing</span><span class="p">)]</span>
<span class="n">missing_cols_to_drop</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">missing_cols</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">protected_cols</span><span class="p">]</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">missing_cols_to_drop</span><span class="p">)</span>

<span class="c1"># ----------------------------------------</span>
<span class="c1"># 2. Drop near-zero variance columns (except protected)</span>
<span class="n">low_variance_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">(</span><span class="n">dropna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">protected_cols</span><span class="p">]</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">low_variance_cols</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=164fa95f-9ce8-447a-816d-51da2b57ecd9">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[107]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">"cleaned_data_baseline.csv"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">" Step 1 Complete: Cleaned dataset saved."</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre> Step 1 Complete: Cleaned dataset saved.
</pre>
</div>
</div>
</div>
</div>
</div># Target variables:<div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=78ea46c7-ce76-4f28-9eaa-27b33c562d90">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[108]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.impute</span> <span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span> <span class="nn">fancyimpute</span> <span class="kn">import</span> <span class="n">IterativeImputer</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">LabelEncoder</span><span class="p">,</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span> <span class="nn">sklearn.compose</span> <span class="kn">import</span> <span class="n">ColumnTransformer</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=822895b2-d0b1-420a-a390-033db2fa9314">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[109]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Load the cleaned dataset from Step 1</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">"cleaned_data_baseline.csv"</span><span class="p">)</span>

<span class="c1"># Quick check</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>(6125, 204)
DIAGNOSIS_ANXIETY_OCD           float64
DIAGNOSIS_SMOKING               float64
DIAGNOSIS_EATING_DISORDER       float64
DIAGNOSIS_SUBSTANCE_DISORDER    float64
DIAGNOSIS_PSYCHOTIC             float64
DIAGNOSIS_SUICIDALITY           float64
DIAGNOSIS_SEXUAL_TRAUMA         float64
DIAGNOSIS_CHILDHOOD_TRAUMA        int64
DIAGNOSIS_CPTSD                 float64
treatmentdurationdays           float64
dtype: object
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=62c27ae4-cfe3-4ba7-9a9a-f2fd7b63f3cd">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[110]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Separate Numerical and Categorical Variables</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=0f9e1b8d-adda-4f10-8cb7-e65d17ae31a0">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[111]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Identify numerical and categorical columns</span>
<span class="n">numerical_cols</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">'float64'</span><span class="p">,</span> <span class="s1">'int64'</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">categorical_cols</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">'object'</span><span class="p">,</span> <span class="s1">'category'</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Numerical Columns: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">numerical_cols</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Categorical Columns: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">categorical_cols</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Numerical Columns: 204
Categorical Columns: 0
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=33da4410-c1a9-492b-b1da-00f1cf6b1281">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[112]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># Check missing values for each variable</span>
<span class="n">missing_summary</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC_missing'</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD_missing'</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
    <span class="s1">'Bipolar_and_Mood_disorder_missing'</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">'Bipolar_and_Mood_disorder'</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER_missing'</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
    <span class="s1">'total_rows'</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"Missing values summary:"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">missing_summary</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Missing values summary:
DIAGNOSIS_PSYCHOTIC_missing: 2484
DIAGNOSIS_ANXIETY_OCD_missing: 2484
Bipolar_and_Mood_disorder_missing: 2484
DIAGNOSIS_EATING_DISORDER_missing: 2484
total_rows: 6125
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=d32dd334-5787-4cc8-a9f7-39d96bba8507">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[113]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Define the mental health variables</span>
<span class="n">mental_health_vars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span> 
                      <span class="s1">'Bipolar_and_Mood_disorder'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">]</span>

<span class="c1"># Check patients with missing data on any of the 4 variables</span>
<span class="n">df</span><span class="p">[</span><span class="s1">'has_missing'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">mental_health_vars</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Summary of missing pattern</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Missing data pattern:"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">'has_missing'</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Patients with missing data: </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="s1">'has_missing'</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Patients with complete data: </span><span class="si">{</span><span class="p">(</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s1">'has_missing'</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
Missing data pattern:
has_missing
False    3641
True     2484
Name: count, dtype: int64
Patients with missing data: 2484
Patients with complete data: 3641
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=e2775c75-504b-41b0-a2c1-dc66adc7ce20">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[114]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Store original count before filtering</span>
<span class="n">original_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="c1"># Filter to keep only complete cases (this modifies df)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">mental_health_vars</span><span class="p">)</span>

<span class="c1"># Get the count after filtering</span>
<span class="n">complete_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="c1"># Calculate excluded count</span>
<span class="n">excluded_count</span> <span class="o">=</span> <span class="n">original_count</span> <span class="o">-</span> <span class="n">complete_count</span>

<span class="c1"># Verify the counts</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Dataset summary:"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Original dataset: </span><span class="si">{</span><span class="n">original_count</span><span class="si">}</span><span class="s2"> observations"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Complete cases: </span><span class="si">{</span><span class="n">complete_count</span><span class="si">}</span><span class="s2"> observations"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Excluded (missing): </span><span class="si">{</span><span class="n">excluded_count</span><span class="si">}</span><span class="s2"> observations"</span><span class="p">)</span>

<span class="c1"># Remove the temporary column (if it exists)</span>
<span class="k">if</span> <span class="s1">'has_missing'</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">'has_missing'</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
Dataset summary:
Original dataset: 6125 observations
Complete cases: 3641 observations
Excluded (missing): 2484 observations
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=07fc6774-6010-4ea8-8f35-f4b56d239ce3">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[115]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Check the 4 variables you filtered on (should be 0 missing)</span>
<span class="n">mental_health_vars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span> 
                      <span class="s1">'Bipolar_and_Mood_disorder'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Missing values in mental health variables:"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">mental_health_vars</span><span class="p">:</span>
    <span class="n">missing</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
Missing values in mental health variables:
DIAGNOSIS_PSYCHOTIC: 0
DIAGNOSIS_ANXIETY_OCD: 0
Bipolar_and_Mood_disorder: 0
DIAGNOSIS_EATING_DISORDER: 0
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=b0580f30-66e5-49c6-94a6-7d15a9d5b573">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[116]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>&lt;class 'pandas.core.frame.DataFrame'&gt;
Index: 3641 entries, 0 to 6124
Columns: 204 entries, DIAGNOSIS_ANXIETY_OCD to ethnicity_other
dtypes: float64(10), int64(194)
memory usage: 5.7 MB
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=715a4034-509e-4e7d-973e-ee50bbb33fb8">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[117]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Save the fully prepared data</span>
<span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">"final_prepared_data.csv"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">" Step 2 Complete: Final prepared dataset saved as 'final_prepared_data.csv'."</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre> Step 2 Complete: Final prepared dataset saved as 'final_prepared_data.csv'.
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=ad70e2d4-5b39-4d75-9165-77a7f6b99979">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[118]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.experimental</span> <span class="kn">import</span> <span class="n">enable_iterative_imputer</span>  <span class="c1"># noqa</span>
<span class="kn">from</span> <span class="nn">sklearn.impute</span> <span class="kn">import</span> <span class="n">IterativeImputer</span>

<span class="c1"># ========== CONFIG ==========</span>
<span class="n">save_folder</span> <span class="o">=</span> <span class="s2">"imputed_data"</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">n_imputations</span> <span class="o">=</span> <span class="mi">5</span>

<span class="c1"># ========== LOAD ==========</span>
<span class="c1"># Ensure df is already defined</span>
<span class="k">assert</span> <span class="s1">'df'</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">(),</span> <span class="s2">"Please load the original DataFrame as `df` before running this script."</span>

<span class="c1"># ========== IDENTIFY NUMERIC COLUMNS ==========</span>
<span class="n">numeric_cols</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">'float64'</span><span class="p">,</span> <span class="s1">'int64'</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="c1"># ========== STEP 1: MICE IMPUTATION ==========</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"="</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"STEP 1: MICE IMPUTATION"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"="</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>

<span class="n">imputed_dfs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_imputations</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">=== Running MICE Imputation: Dataset </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> ==="</span><span class="p">)</span>
    <span class="c1">#  NEW instance with different seed AND sample_posterior=True for randomness</span>
    <span class="n">mice_imputer</span> <span class="o">=</span> <span class="n">IterativeImputer</span><span class="p">(</span>
        <span class="n">max_iter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="o">+</span><span class="n">i</span><span class="p">,</span>  <span class="c1"># Different base to avoid low numbers</span>
        <span class="n">sample_posterior</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1">#  KEY: This adds randomness!</span>
        <span class="n">n_nearest_features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">initial_strategy</span><span class="o">=</span><span class="s1">'mean'</span>
    <span class="p">)</span>
    <span class="c1"># Fit-transform on numeric columns</span>
    <span class="n">imputed_array</span> <span class="o">=</span> <span class="n">mice_imputer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">numeric_cols</span><span class="p">])</span>
    <span class="c1"># Replace numeric columns in a copy of the original df</span>
    <span class="n">df_imputed</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df_imputed</span><span class="p">[</span><span class="n">numeric_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">imputed_array</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">numeric_cols</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="c1"># Append to list</span>
    <span class="n">imputed_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_imputed</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Completed imputation </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># ========== STEP 2: ROUNDING ==========</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"="</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"STEP 2: ROUNDING NUMERIC COLUMNS"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"="</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">round_all_numeric_columns_all_imputations</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">rounded_dfs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
        <span class="n">df_copy</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">numeric_cols</span> <span class="o">=</span> <span class="n">df_copy</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span>
        <span class="n">df_copy</span><span class="p">[</span><span class="n">numeric_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_copy</span><span class="p">[</span><span class="n">numeric_cols</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">decimals</span><span class="p">)</span>
        <span class="n">rounded_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_copy</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Imputation </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: Rounded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">numeric_cols</span><span class="p">)</span><span class="si">}</span><span class="s2"> numeric columns to </span><span class="si">{</span><span class="n">decimals</span><span class="si">}</span><span class="s2"> decimal place(s)."</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rounded_dfs</span>

<span class="c1"># Apply rounding to all imputed datasets</span>
<span class="n">imputed_dfs</span> <span class="o">=</span> <span class="n">round_all_numeric_columns_all_imputations</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">)</span>

<span class="c1"># ========== STEP 3: SAVE FINAL DATASETS ==========</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"="</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"STEP 3: SAVING FINAL DATASETS"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"="</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df_imputed</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
    <span class="c1"># Save outputs</span>
    <span class="n">pkl_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">save_folder</span><span class="si">}</span><span class="s2">/df_imputed_final_imp</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.pkl"</span>
    <span class="n">csv_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">save_folder</span><span class="si">}</span><span class="s2">/df_imputed_final_imp</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.csv"</span>
    <span class="n">excel_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">save_folder</span><span class="si">}</span><span class="s2">/df_imputed_final_imp</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.xlsx"</span>
    
    <span class="n">df_imputed</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="n">pkl_path</span><span class="p">)</span>
    <span class="n">df_imputed</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">df_imputed</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">excel_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Saved files for imputation </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">:"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"    </span><span class="si">{</span><span class="n">pkl_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"    </span><span class="si">{</span><span class="n">csv_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"    </span><span class="si">{</span><span class="n">excel_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># ========== STEP 4: VERIFY DATASETS ARE DIFFERENT ==========</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"="</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"STEP 4: VERIFYING DATASET DIFFERENCES"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"="</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">check_imputation_differences</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Check if imputed datasets are actually different from each other"""</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"  Only one dataset - cannot check differences"</span><span class="p">)</span>
        <span class="k">return</span>
    
    <span class="c1"># Get numeric columns that had missing values originally</span>
    <span class="n">numeric_cols</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span>
    <span class="n">missing_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">numeric_cols</span> <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()]</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">missing_cols</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"  No missing values found in original data"</span><span class="p">)</span>
        <span class="k">return</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Checking differences in </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">missing_cols</span><span class="p">)</span><span class="si">}</span><span class="s2"> columns that had missing values..."</span><span class="p">)</span>
    
    <span class="n">differences_found</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">missing_cols</span><span class="p">[:</span><span class="mi">3</span><span class="p">]:</span>  <span class="c1"># Check first 3 columns with missing values</span>
        <span class="c1"># Compare first two datasets for this column</span>
        <span class="n">values_1</span> <span class="o">=</span> <span class="n">imputed_dfs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">values_2</span> <span class="o">=</span> <span class="n">imputed_dfs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">values_1</span><span class="p">,</span> <span class="n">values_2</span><span class="p">):</span>
            <span class="n">differences_found</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># Count how many values are different</span>
            <span class="n">diff_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">values_1</span> <span class="o">!=</span> <span class="n">values_2</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Column '</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">': </span><span class="si">{</span><span class="n">diff_count</span><span class="si">}</span><span class="s2"> different values between datasets 1 &amp; 2"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Column '</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">': IDENTICAL values between datasets 1 &amp; 2"</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">differences_found</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> SUCCESS: Datasets show proper variability!"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">  WARNING: Datasets appear identical - check random_state implementation"</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">differences_found</span>

<span class="c1"># Run the check</span>
<span class="n">check_imputation_differences</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"="</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">" MICE IMPUTATION COMPLETE!"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"="</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Created </span><span class="si">{</span><span class="n">n_imputations</span><span class="si">}</span><span class="s2"> imputed datasets"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Applied rounding to all numeric columns"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Saved files in: </span><span class="si">{</span><span class="n">save_folder</span><span class="si">}</span><span class="s2">/"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"="</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>==================================================
STEP 1: MICE IMPUTATION
==================================================

=== Running MICE Imputation: Dataset 1 ===
 Completed imputation 1

=== Running MICE Imputation: Dataset 2 ===
 Completed imputation 2

=== Running MICE Imputation: Dataset 3 ===
 Completed imputation 3

=== Running MICE Imputation: Dataset 4 ===
 Completed imputation 4

=== Running MICE Imputation: Dataset 5 ===
 Completed imputation 5

==================================================
STEP 2: ROUNDING NUMERIC COLUMNS
==================================================
 Imputation 1: Rounded 204 numeric columns to 0 decimal place(s).
 Imputation 2: Rounded 204 numeric columns to 0 decimal place(s).
 Imputation 3: Rounded 204 numeric columns to 0 decimal place(s).
 Imputation 4: Rounded 204 numeric columns to 0 decimal place(s).
 Imputation 5: Rounded 204 numeric columns to 0 decimal place(s).

==================================================
STEP 3: SAVING FINAL DATASETS
==================================================
 Saved files for imputation 1:
    imputed_data/df_imputed_final_imp1.pkl
    imputed_data/df_imputed_final_imp1.csv
    imputed_data/df_imputed_final_imp1.xlsx
 Saved files for imputation 2:
    imputed_data/df_imputed_final_imp2.pkl
    imputed_data/df_imputed_final_imp2.csv
    imputed_data/df_imputed_final_imp2.xlsx
 Saved files for imputation 3:
    imputed_data/df_imputed_final_imp3.pkl
    imputed_data/df_imputed_final_imp3.csv
    imputed_data/df_imputed_final_imp3.xlsx
 Saved files for imputation 4:
    imputed_data/df_imputed_final_imp4.pkl
    imputed_data/df_imputed_final_imp4.csv
    imputed_data/df_imputed_final_imp4.xlsx
 Saved files for imputation 5:
    imputed_data/df_imputed_final_imp5.pkl
    imputed_data/df_imputed_final_imp5.csv
    imputed_data/df_imputed_final_imp5.xlsx

==================================================
STEP 4: VERIFYING DATASET DIFFERENCES
==================================================
 Checking differences in 4 columns that had missing values...
 Column 'DIAGNOSIS_SMOKING': 34 different values between datasets 1 &amp; 2
 Column 'DIAGNOSIS_SEXUAL_TRAUMA': 11 different values between datasets 1 &amp; 2
 Column 'DIAGNOSIS_CPTSD': 21 different values between datasets 1 &amp; 2

 SUCCESS: Datasets show proper variability!

==================================================
 MICE IMPUTATION COMPLETE!
==================================================
 Created 5 imputed datasets
 Applied rounding to all numeric columns
 Saved files in: imputed_data/
==================================================
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=7b53723b-bc90-45e1-b949-260ede598f53">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[119]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># ========== METHOD 1: QUICK CHECK - Compare first 2 datasets ==========</span>
<span class="k">def</span> <span class="nf">quick_difference_check</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Quick check to see if first two datasets are different"""</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Need at least 2 datasets to compare"</span><span class="p">)</span>
        <span class="k">return</span>
    
    <span class="n">df1</span> <span class="o">=</span> <span class="n">imputed_dfs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">df2</span> <span class="o">=</span> <span class="n">imputed_dfs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="c1"># Check if dataframes are identical</span>
    <span class="n">are_identical</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">df2</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Dataset 1 vs Dataset 2: </span><span class="si">{</span><span class="s1">'IDENTICAL '</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">are_identical</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">'DIFFERENT '</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">are_identical</span><span class="p">:</span>
        <span class="c1"># Count different values</span>
        <span class="n">numeric_cols</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span>
        <span class="n">total_diff</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">numeric_cols</span><span class="p">:</span>
            <span class="n">diff_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">!=</span> <span class="n">df2</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">diff_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">total_diff</span> <span class="o">+=</span> <span class="n">diff_count</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  '</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">': </span><span class="si">{</span><span class="n">diff_count</span><span class="si">}</span><span class="s2"> different values"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Total different values: </span><span class="si">{</span><span class="n">total_diff</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># ========== METHOD 2: DETAILED CHECK - All pairwise comparisons ==========</span>
<span class="k">def</span> <span class="nf">detailed_difference_check</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Check differences between all pairs of datasets"""</span>
    <span class="n">n_datasets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">=== Checking all </span><span class="si">{</span><span class="n">n_datasets</span><span class="si">}</span><span class="s2"> datasets ==="</span><span class="p">)</span>
    
    <span class="n">numeric_cols</span> <span class="o">=</span> <span class="n">imputed_dfs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_datasets</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_datasets</span><span class="p">):</span>
            <span class="n">are_identical</span> <span class="o">=</span> <span class="n">imputed_dfs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Dataset </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> vs Dataset </span><span class="si">{</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="s1">'IDENTICAL '</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">are_identical</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">'DIFFERENT '</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># ========== METHOD 3: FOCUS ON ORIGINALLY MISSING VALUES ==========</span>
<span class="k">def</span> <span class="nf">check_missing_value_differences</span><span class="p">(</span><span class="n">original_df</span><span class="p">,</span> <span class="n">imputed_dfs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Check differences only in originally missing positions"""</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">=== Checking differences in originally missing positions ==="</span><span class="p">)</span>
    
    <span class="n">numeric_cols</span> <span class="o">=</span> <span class="n">original_df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span>
    
    <span class="n">differences_found</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">numeric_cols</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">original_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">missing_mask</span> <span class="o">=</span> <span class="n">original_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Column '</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">' (</span><span class="si">{</span><span class="n">missing_mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2"> missing values):"</span><span class="p">)</span>
            
            <span class="c1"># Compare imputed values at missing positions</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">imp1_values</span> <span class="o">=</span> <span class="n">imputed_dfs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">missing_mask</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span>
                <span class="n">imp2_values</span> <span class="o">=</span> <span class="n">imputed_dfs</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">missing_mask</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span>
                
                <span class="n">are_same</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">imp1_values</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">imp2_values</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">are_same</span><span class="p">:</span>
                    <span class="n">differences_found</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">diff_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">imp1_values</span><span class="o">.</span><span class="n">values</span> <span class="o">!=</span> <span class="n">imp2_values</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Dataset </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">diff_count</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">imp1_values</span><span class="p">)</span><span class="si">}</span><span class="s2"> different imputed values "</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Dataset </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="si">}</span><span class="s2">: IDENTICAL imputed values "</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">differences_found</span>

<span class="c1"># ========== METHOD 4: SAMPLE VALUES FROM EACH DATASET ==========</span>
<span class="k">def</span> <span class="nf">show_sample_imputed_values</span><span class="p">(</span><span class="n">original_df</span><span class="p">,</span> <span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Show sample imputed values from each dataset"""</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">=== Sample imputed values (first </span><span class="si">{</span><span class="n">n_samples</span><span class="si">}</span><span class="s2"> missing positions) ==="</span><span class="p">)</span>
    
    <span class="n">numeric_cols</span> <span class="o">=</span> <span class="n">original_df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span>
    
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">numeric_cols</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">original_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">missing_positions</span> <span class="o">=</span> <span class="n">original_df</span><span class="p">[</span><span class="n">original_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="n">n_samples</span><span class="p">]</span>
            
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Column '</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">' at positions </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">missing_positions</span><span class="p">)</span><span class="si">}</span><span class="s2">:"</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df_imp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
                <span class="n">values</span> <span class="o">=</span> <span class="n">df_imp</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">missing_positions</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Dataset </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">values</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># ========== RUN ALL CHECKS ==========</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"="</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"CHECKING IMPUTATION DIFFERENCES"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"="</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>

<span class="c1"># Method 1: Quick check</span>
<span class="n">quick_difference_check</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">)</span>

<span class="c1"># Method 2: All pairwise comparisons  </span>
<span class="n">detailed_difference_check</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">)</span>

<span class="c1"># Method 3: Focus on originally missing values (assumes 'df' is your original dataframe)</span>
<span class="k">if</span> <span class="s1">'df'</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
    <span class="n">differences_found</span> <span class="o">=</span> <span class="n">check_missing_value_differences</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">imputed_dfs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">differences_found</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> SUCCESS: Found differences in imputed values!"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> WARNING: No differences found in imputed values!"</span><span class="p">)</span>

<span class="c1"># Method 4: Show sample values</span>
<span class="k">if</span> <span class="s1">'df'</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
    <span class="n">show_sample_imputed_values</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>============================================================
CHECKING IMPUTATION DIFFERENCES
============================================================
Dataset 1 vs Dataset 2: DIFFERENT 
  'DIAGNOSIS_SMOKING': 34 different values
  'DIAGNOSIS_SEXUAL_TRAUMA': 11 different values
  'DIAGNOSIS_CPTSD': 21 different values
  'treatmentdurationdays': 1127 different values
  Total different values: 1193

=== Checking all 5 datasets ===
Dataset 1 vs Dataset 2: DIFFERENT 
Dataset 1 vs Dataset 3: DIFFERENT 
Dataset 1 vs Dataset 4: DIFFERENT 
Dataset 1 vs Dataset 5: DIFFERENT 
Dataset 2 vs Dataset 3: DIFFERENT 
Dataset 2 vs Dataset 4: DIFFERENT 
Dataset 2 vs Dataset 5: DIFFERENT 
Dataset 3 vs Dataset 4: DIFFERENT 
Dataset 3 vs Dataset 5: DIFFERENT 
Dataset 4 vs Dataset 5: DIFFERENT 

=== Checking differences in originally missing positions ===

Column 'DIAGNOSIS_SMOKING' (64 missing values):
  Dataset 1 vs 2: 34/64 different imputed values 
  Dataset 2 vs 3: 35/64 different imputed values 
  Dataset 3 vs 4: 33/64 different imputed values 
  Dataset 4 vs 5: 35/64 different imputed values 

Column 'DIAGNOSIS_SEXUAL_TRAUMA' (29 missing values):
  Dataset 1 vs 2: 11/29 different imputed values 
  Dataset 2 vs 3: 14/29 different imputed values 
  Dataset 3 vs 4: 16/29 different imputed values 
  Dataset 4 vs 5: 17/29 different imputed values 

Column 'DIAGNOSIS_CPTSD' (51 missing values):
  Dataset 1 vs 2: 21/51 different imputed values 
  Dataset 2 vs 3: 24/51 different imputed values 
  Dataset 3 vs 4: 29/51 different imputed values 
  Dataset 4 vs 5: 22/51 different imputed values 

Column 'treatmentdurationdays' (1412 missing values):
  Dataset 1 vs 2: 1127/1412 different imputed values 
  Dataset 2 vs 3: 1151/1412 different imputed values 
  Dataset 3 vs 4: 1175/1412 different imputed values 
  Dataset 4 vs 5: 1146/1412 different imputed values 

 SUCCESS: Found differences in imputed values!

=== Sample imputed values (first 3 missing positions) ===

Column 'DIAGNOSIS_SMOKING' at positions [5, 8, 65]:
  Dataset 1: [-1.  0.  1.]
  Dataset 2: [ 0. -1.  1.]
  Dataset 3: [ 0. -0.  1.]
  Dataset 4: [ 1. -1.  1.]
  Dataset 5: [0. 0. 0.]

Column 'DIAGNOSIS_SEXUAL_TRAUMA' at positions [34, 35, 36]:
  Dataset 1: [1. 1. 1.]
  Dataset 2: [1. 1. 1.]
  Dataset 3: [1. 2. 0.]
  Dataset 4: [ 0.  1. -0.]
  Dataset 5: [0. 1. 1.]

Column 'DIAGNOSIS_CPTSD' at positions [8, 65, 248]:
  Dataset 1: [0. 1. 1.]
  Dataset 2: [1. 1. 1.]
  Dataset 3: [1. 1. 1.]
  Dataset 4: [0. 1. 1.]
  Dataset 5: [0. 1. 1.]

Column 'treatmentdurationdays' at positions [0, 1, 6]:
  Dataset 1: [3. 5. 2.]
  Dataset 2: [3. 4. 5.]
  Dataset 3: [3. 3. 3.]
  Dataset 4: [3. 4. 4.]
  Dataset 5: [5. 4. 1.]
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=711fb48b-df58-47c5-ab5a-1bf448defe1a">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[120]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">imputed_folder</span> <span class="o">=</span> <span class="s2">"imputed_data"</span>
<span class="n">n_imputations</span> <span class="o">=</span> <span class="mi">5</span>

<span class="c1"># Lists to hold DataFrames and Y vectors</span>
<span class="n">imputed_dfs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">Y_list</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_imputations</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">imputed_folder</span><span class="si">}</span><span class="s2">/df_imputed_final_imp</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.pkl"</span>
    
    <span class="c1"># Load imputed DataFrame</span>
    <span class="n">df_imp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
    <span class="n">imputed_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_imp</span><span class="p">)</span>

    <span class="c1"># Define Y for this imputation</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="s2">"caps5_change_baseline"</span><span class="p">]</span>
    <span class="n">Y_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Y for imputation </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> defined. Sample values:"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Y for imputation 1 defined. Sample values:
0   -41.0
1   -15.0
2   -46.0
3   -41.0
4   -20.0
Name: caps5_change_baseline, dtype: float64
Y for imputation 2 defined. Sample values:
0   -41.0
1   -15.0
2   -46.0
3   -41.0
4   -20.0
Name: caps5_change_baseline, dtype: float64
Y for imputation 3 defined. Sample values:
0   -41.0
1   -15.0
2   -46.0
3   -41.0
4   -20.0
Name: caps5_change_baseline, dtype: float64
Y for imputation 4 defined. Sample values:
0   -41.0
1   -15.0
2   -46.0
3   -41.0
4   -20.0
Name: caps5_change_baseline, dtype: float64
Y for imputation 5 defined. Sample values:
0   -41.0
1   -15.0
2   -46.0
3   -41.0
4   -20.0
Name: caps5_change_baseline, dtype: float64
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=867d7aa7-2678-4d61-b04d-49183d36f6dd">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[121]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># Load imputed DataFrames from saved files</span>
<span class="n">imputed_folder</span> <span class="o">=</span> <span class="s2">"imputed_data"</span>
<span class="n">n_imputations</span> <span class="o">=</span> <span class="mi">5</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_imputations</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">=== Imputed Dataset </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> ==="</span><span class="p">)</span>

    <span class="c1"># Load each imputed dataset</span>
    <span class="n">df_imp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">imputed_folder</span><span class="si">}</span><span class="s2">/df_imputed_final_imp</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.pkl"</span><span class="p">)</span>

    <span class="c1"># Get all CAT_* columns</span>
    <span class="n">cat_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df_imp</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'CAT_'</span><span class="p">)]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">"Medication Groups:"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">cat_columns</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Total Medication Groups Found:"</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cat_columns</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
=== Imputed Dataset 1 ===
Medication Groups:
['CAT_Antidepressiva', 'CAT_Benzodiazepine', 'CAT_Anti_epileptica', 'CAT_Antihistaminica', 'CAT_Opioden', 'CAT_Antipsychotica', 'CAT_Aceetanilidederivaten', 'CAT_Antihypertensiva', 'CAT_Salicylaat', 'CAT_NSAIDs', 'CAT_Migrainemiddelen', 'CAT_ADHD', 'CAT_Anticonceptiva', 'CAT_Z_drugs', 'CAT_Spierrelaxantia', 'CAT_Immunomodulerende_middelen', 'CAT_Alcoholverslaving', 'CAT_Stemmingsstabilisatoren', 'CAT_Parkinson', 'CAT_ALL', 'CAT_ALL_PSYCHOTROPICS', 'CAT_ALL_PSYCHOTROPICS_EXCL_BENZO', 'CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS']
Total Medication Groups Found: 23

=== Imputed Dataset 2 ===
Medication Groups:
['CAT_Antidepressiva', 'CAT_Benzodiazepine', 'CAT_Anti_epileptica', 'CAT_Antihistaminica', 'CAT_Opioden', 'CAT_Antipsychotica', 'CAT_Aceetanilidederivaten', 'CAT_Antihypertensiva', 'CAT_Salicylaat', 'CAT_NSAIDs', 'CAT_Migrainemiddelen', 'CAT_ADHD', 'CAT_Anticonceptiva', 'CAT_Z_drugs', 'CAT_Spierrelaxantia', 'CAT_Immunomodulerende_middelen', 'CAT_Alcoholverslaving', 'CAT_Stemmingsstabilisatoren', 'CAT_Parkinson', 'CAT_ALL', 'CAT_ALL_PSYCHOTROPICS', 'CAT_ALL_PSYCHOTROPICS_EXCL_BENZO', 'CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS']
Total Medication Groups Found: 23

=== Imputed Dataset 3 ===
Medication Groups:
['CAT_Antidepressiva', 'CAT_Benzodiazepine', 'CAT_Anti_epileptica', 'CAT_Antihistaminica', 'CAT_Opioden', 'CAT_Antipsychotica', 'CAT_Aceetanilidederivaten', 'CAT_Antihypertensiva', 'CAT_Salicylaat', 'CAT_NSAIDs', 'CAT_Migrainemiddelen', 'CAT_ADHD', 'CAT_Anticonceptiva', 'CAT_Z_drugs', 'CAT_Spierrelaxantia', 'CAT_Immunomodulerende_middelen', 'CAT_Alcoholverslaving', 'CAT_Stemmingsstabilisatoren', 'CAT_Parkinson', 'CAT_ALL', 'CAT_ALL_PSYCHOTROPICS', 'CAT_ALL_PSYCHOTROPICS_EXCL_BENZO', 'CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS']
Total Medication Groups Found: 23

=== Imputed Dataset 4 ===
Medication Groups:
['CAT_Antidepressiva', 'CAT_Benzodiazepine', 'CAT_Anti_epileptica', 'CAT_Antihistaminica', 'CAT_Opioden', 'CAT_Antipsychotica', 'CAT_Aceetanilidederivaten', 'CAT_Antihypertensiva', 'CAT_Salicylaat', 'CAT_NSAIDs', 'CAT_Migrainemiddelen', 'CAT_ADHD', 'CAT_Anticonceptiva', 'CAT_Z_drugs', 'CAT_Spierrelaxantia', 'CAT_Immunomodulerende_middelen', 'CAT_Alcoholverslaving', 'CAT_Stemmingsstabilisatoren', 'CAT_Parkinson', 'CAT_ALL', 'CAT_ALL_PSYCHOTROPICS', 'CAT_ALL_PSYCHOTROPICS_EXCL_BENZO', 'CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS']
Total Medication Groups Found: 23

=== Imputed Dataset 5 ===
Medication Groups:
['CAT_Antidepressiva', 'CAT_Benzodiazepine', 'CAT_Anti_epileptica', 'CAT_Antihistaminica', 'CAT_Opioden', 'CAT_Antipsychotica', 'CAT_Aceetanilidederivaten', 'CAT_Antihypertensiva', 'CAT_Salicylaat', 'CAT_NSAIDs', 'CAT_Migrainemiddelen', 'CAT_ADHD', 'CAT_Anticonceptiva', 'CAT_Z_drugs', 'CAT_Spierrelaxantia', 'CAT_Immunomodulerende_middelen', 'CAT_Alcoholverslaving', 'CAT_Stemmingsstabilisatoren', 'CAT_Parkinson', 'CAT_ALL', 'CAT_ALL_PSYCHOTROPICS', 'CAT_ALL_PSYCHOTROPICS_EXCL_BENZO', 'CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS']
Total Medication Groups Found: 23
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=e17e7f0c-2653-4a13-9d3f-d96b63ee9397">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[122]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">covariates_CAT_ADHD</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'CAT_Anti_epileptica'</span><span class="p">,</span> <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span> <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span> <span class="s1">'CAT_Opioden'</span><span class="p">,</span>
    <span class="s1">'CAT_Z_drugs'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SMOKING'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span>
    <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"EB_NON_TF_THERAPY"</span><span class="p">,</span> <span class="s2">"OTHER_TREATM_APPROACH"</span><span class="p">,</span> <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_CAT_Aceetanilidederivaten</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'CAT_Anti_epileptica'</span><span class="p">,</span> <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span> <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span> <span class="s1">'CAT_Opioden'</span><span class="p">,</span> <span class="s1">'CAT_Z_drugs'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SMOKING'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"EB_NON_TF_THERAPY"</span><span class="p">,</span> <span class="s2">"OTHER_TREATM_APPROACH"</span><span class="p">,</span> <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_CAT_Z_drugs</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'CAT_Anti_epileptica'</span><span class="p">,</span> <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span> <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span> <span class="s1">'CAT_Opioden'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SMOKING'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"EB_NON_TF_THERAPY"</span><span class="p">,</span> <span class="s2">"OTHER_TREATM_APPROACH"</span><span class="p">,</span> <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_CAT_Opioden</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'CAT_Anti_epileptica'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span> <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span> <span class="s1">'CAT_Z_drugs'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SMOKING'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"EB_NON_TF_THERAPY"</span><span class="p">,</span> <span class="s2">"OTHER_TREATM_APPROACH"</span><span class="p">,</span> <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_CAT_NSAIDs</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'CAT_Anti_epileptica'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span> <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span> <span class="s1">'CAT_Opioden'</span><span class="p">,</span> <span class="s1">'CAT_Z_drugs'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SMOKING'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"EB_NON_TF_THERAPY"</span><span class="p">,</span> <span class="s2">"OTHER_TREATM_APPROACH"</span><span class="p">,</span> <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>



<span class="n">covariates_CAT_Benzodiazepine</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'CAT_Anti_epileptica'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span> <span class="s1">'CAT_Opioden'</span><span class="p">,</span> <span class="s1">'CAT_Z_drugs'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SMOKING'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"EB_NON_TF_THERAPY"</span><span class="p">,</span> <span class="s2">"OTHER_TREATM_APPROACH"</span><span class="p">,</span> <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_CAT_Antihypertensiva</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'CAT_Anti_epileptica'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span> <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span> <span class="s1">'CAT_Opioden'</span><span class="p">,</span> <span class="s1">'CAT_Z_drugs'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SMOKING'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"EB_NON_TF_THERAPY"</span><span class="p">,</span> <span class="s2">"OTHER_TREATM_APPROACH"</span><span class="p">,</span> <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_CAT_Antihistaminica</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'CAT_Anti_epileptica'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span> <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span> <span class="s1">'CAT_Opioden'</span><span class="p">,</span> <span class="s1">'CAT_Z_drugs'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SMOKING'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"EB_NON_TF_THERAPY"</span><span class="p">,</span> <span class="s2">"OTHER_TREATM_APPROACH"</span><span class="p">,</span> <span class="s2">"Bipolar_and_Mood_disorder"</span>
<span class="p">]</span>


<span class="n">covariates_CAT_Anti_epileptica</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span> <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span> <span class="s1">'CAT_Opioden'</span><span class="p">,</span> <span class="s1">'CAT_Z_drugs'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SMOKING'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"EB_NON_TF_THERAPY"</span><span class="p">,</span> <span class="s2">"OTHER_TREATM_APPROACH"</span><span class="p">,</span> <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_CAT_Antidepressiva</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'CAT_Anti_epileptica'</span><span class="p">,</span> <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span> <span class="s1">'CAT_Opioden'</span><span class="p">,</span> <span class="s1">'CAT_Z_drugs'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SMOKING'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"EB_NON_TF_THERAPY"</span><span class="p">,</span> <span class="s2">"OTHER_TREATM_APPROACH"</span><span class="p">,</span> <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_CAT_Antipsychotica</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'CAT_Anti_epileptica'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span> <span class="s1">'CAT_Opioden'</span><span class="p">,</span> <span class="s1">'CAT_Z_drugs'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SMOKING'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"EB_NON_TF_THERAPY"</span><span class="p">,</span> <span class="s2">"OTHER_TREATM_APPROACH"</span><span class="p">,</span> <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_CAT_ALL_PSYCHOTROPICS_EXCL_BENZO</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span> <span class="s1">'CAT_Anticonceptiva'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SMOKING'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"EB_NON_TF_THERAPY"</span><span class="p">,</span> <span class="s2">"OTHER_TREATM_APPROACH"</span><span class="p">,</span> <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span> <span class="s1">'CAT_Z_drugs'</span><span class="p">,</span> <span class="s1">'CAT_Anticonceptiva'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SMOKING'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"EB_NON_TF_THERAPY"</span><span class="p">,</span> <span class="s2">"OTHER_TREATM_APPROACH"</span><span class="p">,</span> <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_CAT_ALL_PSYCHOTROPICS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SMOKING'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"EB_NON_TF_THERAPY"</span><span class="p">,</span> <span class="s2">"OTHER_TREATM_APPROACH"</span><span class="p">,</span> <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_CAT_ALL</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SMOKING'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span>
    <span class="s1">'age'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"EB_NON_TF_THERAPY"</span><span class="p">,</span> <span class="s2">"OTHER_TREATM_APPROACH"</span><span class="p">,</span> <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=e8659b20-ab67-4388-bd8f-11c2dedcb4e9">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[123]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="c1"># This finds all variables that start with covariates_CAT_ or covariates_cat_</span>
<span class="n">final_covariates_map</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<span class="n">final_covariates_map</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
    <span class="n">var</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"covariates_"</span><span class="p">,</span> <span class="s2">""</span><span class="p">):</span> <span class="n">val</span>
    <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"covariates_cat_"</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
<span class="p">})</span>

<span class="c1"># Show detected group names</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Groups found:"</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
<span class="n">medication_groups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">medication_groups</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Groups found: ['CAT_ADHD', 'CAT_Aceetanilidederivaten', 'CAT_Z_drugs', 'CAT_Opioden', 'CAT_NSAIDs', 'CAT_Benzodiazepine', 'CAT_Antihypertensiva', 'CAT_Antihistaminica', 'CAT_Anti_epileptica', 'CAT_Antidepressiva', 'CAT_Antipsychotica', 'CAT_ALL_PSYCHOTROPICS_EXCL_BENZO', 'CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS', 'CAT_ALL_PSYCHOTROPICS', 'CAT_ALL']
['CAT_ADHD', 'CAT_Aceetanilidederivaten', 'CAT_Z_drugs', 'CAT_Opioden', 'CAT_NSAIDs', 'CAT_Benzodiazepine', 'CAT_Antihypertensiva', 'CAT_Antihistaminica', 'CAT_Anti_epileptica', 'CAT_Antidepressiva', 'CAT_Antipsychotica', 'CAT_ALL_PSYCHOTROPICS_EXCL_BENZO', 'CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS', 'CAT_ALL_PSYCHOTROPICS', 'CAT_ALL']
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=9f8c8ff1-c3d0-48d3-9fbf-98a6762e001e">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[124]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>


<span class="k">def</span> <span class="nf">run_all_CAT_group_models</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Runs downstream analysis for each CAT medication group using imputed datasets.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - imputed_dfs: list of 5 imputed DataFrames (from df_imputed_final_imp1.pkl ... imp5.pkl)</span>
<span class="sd">    </span>
<span class="sd">    Notes:</span>
<span class="sd">    - Covariate lists must be defined as global variables: covariates_cat_&lt;group&gt;</span>
<span class="sd">    - Outputs are saved in: outputs/CAT_&lt;GROUP&gt;/</span>
<span class="sd">    """</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">" Starting analysis for all CAT groups"</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">var_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"covariates_cat_"</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">globals</span><span class="p">()[</span><span class="n">var_name</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">group_name</span> <span class="o">=</span> <span class="n">var_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"covariates_"</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
            <span class="n">group_name</span> <span class="o">=</span> <span class="n">group_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"_"</span><span class="p">,</span> <span class="s2">" "</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">" "</span><span class="p">,</span> <span class="s2">"_"</span><span class="p">)</span>  <span class="c1"># e.g., cat_z_drugs  Cat_Z_Drugs</span>
            <span class="n">group_name</span> <span class="o">=</span> <span class="n">group_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"Cat_"</span><span class="p">,</span> <span class="s2">"CAT_"</span><span class="p">)</span>  <span class="c1"># force prefix to uppercase</span>

            <span class="n">covariates</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()[</span><span class="n">var_name</span><span class="p">]</span>
            <span class="n">output_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"outputs/</span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">"</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Processing </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">..."</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">df_imp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   Using imputation </span><span class="si">{</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

                <span class="c1"># Define X and Y</span>
                <span class="n">X</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span>
                <span class="n">Y</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="s2">"caps5_change_baseline"</span><span class="p">]</span>

                <span class="c1"># === Save X and Y as placeholder (replace with modeling later)</span>
                <span class="n">X</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/X_imp</span><span class="si">{</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.csv"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">Y</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"Y"</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/Y_imp</span><span class="si">{</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.csv"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Done: </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> All CAT group analyses complete."</span><span class="p">)</span>

<span class="c1"># ========= STEP 4: Execute ========= #</span>
<span class="n">run_all_CAT_group_models</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre> Starting analysis for all CAT groups

 Processing CAT_Adhd...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: CAT_Adhd

 Processing CAT_Aceetanilidederivaten...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: CAT_Aceetanilidederivaten

 Processing CAT_Z_Drugs...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: CAT_Z_Drugs

 Processing CAT_Opioden...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: CAT_Opioden

 Processing CAT_Nsaids...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: CAT_Nsaids

 Processing CAT_Benzodiazepine...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: CAT_Benzodiazepine

 Processing CAT_Antihypertensiva...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: CAT_Antihypertensiva

 Processing CAT_Antihistaminica...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: CAT_Antihistaminica

 Processing CAT_Anti_Epileptica...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: CAT_Anti_Epileptica

 Processing CAT_Antidepressiva...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: CAT_Antidepressiva

 Processing CAT_Antipsychotica...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: CAT_Antipsychotica

 Processing CAT_All_Psychotropics_Excl_Benzo...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: CAT_All_Psychotropics_Excl_Benzo

 Processing CAT_All_Psychotropics_Excl_Sedatives_Hypnotics...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: CAT_All_Psychotropics_Excl_Sedatives_Hypnotics

 Processing CAT_All_Psychotropics...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: CAT_All_Psychotropics

 Processing CAT_All...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: CAT_All

 All CAT group analyses complete.
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=aa157356-6578-40bc-a6c3-3f9664d73f58">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[125]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">treatment_var</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">treatment_var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Imp </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">:  Not found in columns."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">treated</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">control</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Imp </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: Treated = </span><span class="si">{</span><span class="n">treated</span><span class="si">}</span><span class="s2">, Control = </span><span class="si">{</span><span class="n">control</span><span class="si">}</span><span class="s2">, Missing = </span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 CAT_ADHD
  Imp 1: Treated = 56, Control = 3585, Missing = 0
  Imp 2: Treated = 56, Control = 3585, Missing = 0
  Imp 3: Treated = 56, Control = 3585, Missing = 0
  Imp 4: Treated = 56, Control = 3585, Missing = 0
  Imp 5: Treated = 56, Control = 3585, Missing = 0

 CAT_Aceetanilidederivaten
  Imp 1: Treated = 50, Control = 3591, Missing = 0
  Imp 2: Treated = 50, Control = 3591, Missing = 0
  Imp 3: Treated = 50, Control = 3591, Missing = 0
  Imp 4: Treated = 50, Control = 3591, Missing = 0
  Imp 5: Treated = 50, Control = 3591, Missing = 0

 CAT_Z_drugs
  Imp 1: Treated = 57, Control = 3584, Missing = 0
  Imp 2: Treated = 57, Control = 3584, Missing = 0
  Imp 3: Treated = 57, Control = 3584, Missing = 0
  Imp 4: Treated = 57, Control = 3584, Missing = 0
  Imp 5: Treated = 57, Control = 3584, Missing = 0

 CAT_Opioden
  Imp 1: Treated = 54, Control = 3587, Missing = 0
  Imp 2: Treated = 54, Control = 3587, Missing = 0
  Imp 3: Treated = 54, Control = 3587, Missing = 0
  Imp 4: Treated = 54, Control = 3587, Missing = 0
  Imp 5: Treated = 54, Control = 3587, Missing = 0

 CAT_NSAIDs
  Imp 1: Treated = 37, Control = 3604, Missing = 0
  Imp 2: Treated = 37, Control = 3604, Missing = 0
  Imp 3: Treated = 37, Control = 3604, Missing = 0
  Imp 4: Treated = 37, Control = 3604, Missing = 0
  Imp 5: Treated = 37, Control = 3604, Missing = 0

 CAT_Benzodiazepine
  Imp 1: Treated = 396, Control = 3245, Missing = 0
  Imp 2: Treated = 396, Control = 3245, Missing = 0
  Imp 3: Treated = 396, Control = 3245, Missing = 0
  Imp 4: Treated = 396, Control = 3245, Missing = 0
  Imp 5: Treated = 396, Control = 3245, Missing = 0

 CAT_Antihypertensiva
  Imp 1: Treated = 45, Control = 3596, Missing = 0
  Imp 2: Treated = 45, Control = 3596, Missing = 0
  Imp 3: Treated = 45, Control = 3596, Missing = 0
  Imp 4: Treated = 45, Control = 3596, Missing = 0
  Imp 5: Treated = 45, Control = 3596, Missing = 0

 CAT_Antihistaminica
  Imp 1: Treated = 56, Control = 3585, Missing = 0
  Imp 2: Treated = 56, Control = 3585, Missing = 0
  Imp 3: Treated = 56, Control = 3585, Missing = 0
  Imp 4: Treated = 56, Control = 3585, Missing = 0
  Imp 5: Treated = 56, Control = 3585, Missing = 0

 CAT_Anti_epileptica
  Imp 1: Treated = 84, Control = 3557, Missing = 0
  Imp 2: Treated = 84, Control = 3557, Missing = 0
  Imp 3: Treated = 84, Control = 3557, Missing = 0
  Imp 4: Treated = 84, Control = 3557, Missing = 0
  Imp 5: Treated = 84, Control = 3557, Missing = 0

 CAT_Antidepressiva
  Imp 1: Treated = 636, Control = 3005, Missing = 0
  Imp 2: Treated = 636, Control = 3005, Missing = 0
  Imp 3: Treated = 636, Control = 3005, Missing = 0
  Imp 4: Treated = 636, Control = 3005, Missing = 0
  Imp 5: Treated = 636, Control = 3005, Missing = 0

 CAT_Antipsychotica
  Imp 1: Treated = 268, Control = 3373, Missing = 0
  Imp 2: Treated = 268, Control = 3373, Missing = 0
  Imp 3: Treated = 268, Control = 3373, Missing = 0
  Imp 4: Treated = 268, Control = 3373, Missing = 0
  Imp 5: Treated = 268, Control = 3373, Missing = 0

 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO
  Imp 1: Treated = 869, Control = 2772, Missing = 0
  Imp 2: Treated = 869, Control = 2772, Missing = 0
  Imp 3: Treated = 869, Control = 2772, Missing = 0
  Imp 4: Treated = 869, Control = 2772, Missing = 0
  Imp 5: Treated = 869, Control = 2772, Missing = 0

 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS
  Imp 1: Treated = 846, Control = 2795, Missing = 0
  Imp 2: Treated = 846, Control = 2795, Missing = 0
  Imp 3: Treated = 846, Control = 2795, Missing = 0
  Imp 4: Treated = 846, Control = 2795, Missing = 0
  Imp 5: Treated = 846, Control = 2795, Missing = 0

 CAT_ALL_PSYCHOTROPICS
  Imp 1: Treated = 1031, Control = 2610, Missing = 0
  Imp 2: Treated = 1031, Control = 2610, Missing = 0
  Imp 3: Treated = 1031, Control = 2610, Missing = 0
  Imp 4: Treated = 1031, Control = 2610, Missing = 0
  Imp 5: Treated = 1031, Control = 2610, Missing = 0

 CAT_ALL
  Imp 1: Treated = 1072, Control = 2569, Missing = 0
  Imp 2: Treated = 1072, Control = 2569, Missing = 0
  Imp 3: Treated = 1072, Control = 2569, Missing = 0
  Imp 4: Treated = 1072, Control = 2569, Missing = 0
  Imp 5: Treated = 1072, Control = 2569, Missing = 0
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=45518bb5-2213-4061-a9f4-d9dc5a771895">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[126]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">from</span> <span class="nn">statsmodels.stats.outliers_influence</span> <span class="kn">import</span> <span class="n">variance_inflation_factor</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="c1">#  VIF computation function</span>
<span class="k">def</span> <span class="nf">compute_vif</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">has_constant</span><span class="o">=</span><span class="s1">'add'</span><span class="p">)</span>
    <span class="n">vif_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">vif_df</span><span class="p">[</span><span class="s2">"variable"</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span>
    <span class="n">vif_df</span><span class="p">[</span><span class="s2">"VIF"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">variance_inflation_factor</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
    <span class="k">return</span> <span class="n">vif_df</span>

<span class="c1">#  Process each group</span>
<span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Processing VIF for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  No covariates found for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
        <span class="k">continue</span>

    <span class="n">covariates</span> <span class="o">=</span> <span class="n">final_covariates_map</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
    <span class="n">vif_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df_imp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">vif_df</span> <span class="o">=</span> <span class="n">compute_vif</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="n">vif_df</span><span class="p">[</span><span class="s2">"imputation"</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">vif_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vif_df</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"    Failed on imputation </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">vif_list</span><span class="p">:</span>
        <span class="n">all_vif</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">vif_list</span><span class="p">)</span>
        <span class="n">pooled_vif</span> <span class="o">=</span> <span class="n">all_vif</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">"variable"</span><span class="p">)[</span><span class="s2">"VIF"</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">pooled_vif</span> <span class="o">=</span> <span class="n">pooled_vif</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">"VIF"</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"outputs"</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">pooled_vif</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"pooled_vif.csv"</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Saved: </span><span class="si">{</span><span class="n">output_folder</span><span class="si">}</span><span class="s2">/pooled_vif.csv"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Skipped </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: No valid imputations."</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Processing VIF for CAT_ADHD
  Saved: outputs\CAT_ADHD/pooled_vif.csv

 Processing VIF for CAT_Aceetanilidederivaten
  Saved: outputs\CAT_Aceetanilidederivaten/pooled_vif.csv

 Processing VIF for CAT_Z_drugs
  Saved: outputs\CAT_Z_drugs/pooled_vif.csv

 Processing VIF for CAT_Opioden
  Saved: outputs\CAT_Opioden/pooled_vif.csv

 Processing VIF for CAT_NSAIDs
  Saved: outputs\CAT_NSAIDs/pooled_vif.csv

 Processing VIF for CAT_Benzodiazepine
  Saved: outputs\CAT_Benzodiazepine/pooled_vif.csv

 Processing VIF for CAT_Antihypertensiva
  Saved: outputs\CAT_Antihypertensiva/pooled_vif.csv

 Processing VIF for CAT_Antihistaminica
  Saved: outputs\CAT_Antihistaminica/pooled_vif.csv

 Processing VIF for CAT_Anti_epileptica
  Saved: outputs\CAT_Anti_epileptica/pooled_vif.csv

 Processing VIF for CAT_Antidepressiva
  Saved: outputs\CAT_Antidepressiva/pooled_vif.csv

 Processing VIF for CAT_Antipsychotica
  Saved: outputs\CAT_Antipsychotica/pooled_vif.csv

 Processing VIF for CAT_ALL_PSYCHOTROPICS_EXCL_BENZO
  Saved: outputs\CAT_ALL_PSYCHOTROPICS_EXCL_BENZO/pooled_vif.csv

 Processing VIF for CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS
  Saved: outputs\CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS/pooled_vif.csv

 Processing VIF for CAT_ALL_PSYCHOTROPICS
  Saved: outputs\CAT_ALL_PSYCHOTROPICS/pooled_vif.csv

 Processing VIF for CAT_ALL
  Saved: outputs\CAT_ALL/pooled_vif.csv
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=d0a75c56-8246-4cf6-87ef-07269bd1ce01">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[127]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">xgboost</span> <span class="kn">import</span> <span class="n">XGBClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">roc_curve</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>

<span class="c1"># ---------- PS Estimation Function ----------</span>
<span class="k">def</span> <span class="nf">run_xgboost_ps_modeling</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Running PS estimation for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No covariates found for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"outputs"</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">covariates</span> <span class="o">=</span> <span class="n">final_covariates_map</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
        <span class="n">ps_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">auc_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df_imp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_imp</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> not found in imputed dataset </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">X</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>

            <span class="c1"># Drop missing treatment rows</span>
            <span class="n">valid_idx</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">index</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>

            <span class="c1"># Train-test split for ROC</span>
            <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">T_train</span><span class="p">,</span> <span class="n">T_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
                <span class="n">X</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
            <span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">XGBClassifier</span><span class="p">(</span><span class="n">use_label_encoder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eval_metric</span><span class="o">=</span><span class="s1">'logloss'</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
                <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">T_train</span><span class="p">)</span>

                <span class="n">ps_scores</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">ps_matrix</span><span class="p">[</span><span class="sa">f</span><span class="s2">"ps_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">ps_scores</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">valid_idx</span><span class="p">)</span>

                <span class="c1"># ROC &amp; AUC</span>
                <span class="n">auc</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">T_test</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">auc_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">auc</span><span class="p">)</span>

                <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">T_test</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">"AUC = </span><span class="si">{</span><span class="n">auc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'k--'</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"False Positive Rate"</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"True Positive Rate"</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"ROC Curve - </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> (Imp </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">)"</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"roc_curve_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.png"</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   Imp </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: AUC = </span><span class="si">{</span><span class="n">auc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, ROC saved."</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> (imp </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Save AUCs and Composite PS</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ps_matrix</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="c1"># Fill NaN rows (from dropped subjects in some imputations) with mean</span>
            <span class="n">ps_matrix</span><span class="p">[</span><span class="s2">"composite_ps"</span><span class="p">]</span> <span class="o">=</span> <span class="n">ps_matrix</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ps_matrix</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"propensity_scores.xlsx"</span><span class="p">))</span>

            <span class="n">auc_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s2">"imputation"</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">"imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">auc_list</span><span class="p">))],</span>
                <span class="s2">"AUC"</span><span class="p">:</span> <span class="n">auc_list</span>
            <span class="p">})</span>
            <span class="n">auc_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">auc_df</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"mean"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">auc_list</span><span class="p">)</span> <span class="k">if</span> <span class="n">auc_list</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span>
            <span class="n">auc_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"auc_scores.xlsx"</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Composite PS + AUC saved for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No valid PS scores generated for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># ---------- Run ----------</span>
<span class="n">run_xgboost_ps_modeling</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre> Running PS estimation for CAT_ADHD
   Imp 1: AUC = 0.673, ROC saved.
   Imp 2: AUC = 0.674, ROC saved.
   Imp 3: AUC = 0.656, ROC saved.
   Imp 4: AUC = 0.725, ROC saved.
   Imp 5: AUC = 0.638, ROC saved.
 Composite PS + AUC saved for CAT_ADHD
 Running PS estimation for CAT_Aceetanilidederivaten
   Imp 1: AUC = 0.726, ROC saved.
   Imp 2: AUC = 0.778, ROC saved.
   Imp 3: AUC = 0.743, ROC saved.
   Imp 4: AUC = 0.800, ROC saved.
   Imp 5: AUC = 0.791, ROC saved.
 Composite PS + AUC saved for CAT_Aceetanilidederivaten
 Running PS estimation for CAT_Z_drugs
   Imp 1: AUC = 0.717, ROC saved.
   Imp 2: AUC = 0.717, ROC saved.
   Imp 3: AUC = 0.705, ROC saved.
   Imp 4: AUC = 0.695, ROC saved.
   Imp 5: AUC = 0.690, ROC saved.
 Composite PS + AUC saved for CAT_Z_drugs
 Running PS estimation for CAT_Opioden
   Imp 1: AUC = 0.796, ROC saved.
   Imp 2: AUC = 0.804, ROC saved.
   Imp 3: AUC = 0.814, ROC saved.
   Imp 4: AUC = 0.789, ROC saved.
   Imp 5: AUC = 0.812, ROC saved.
 Composite PS + AUC saved for CAT_Opioden
 Running PS estimation for CAT_NSAIDs
   Imp 1: AUC = 0.687, ROC saved.
   Imp 2: AUC = 0.712, ROC saved.
   Imp 3: AUC = 0.711, ROC saved.
   Imp 4: AUC = 0.681, ROC saved.
   Imp 5: AUC = 0.692, ROC saved.
 Composite PS + AUC saved for CAT_NSAIDs
 Running PS estimation for CAT_Benzodiazepine
   Imp 1: AUC = 0.757, ROC saved.
   Imp 2: AUC = 0.750, ROC saved.
   Imp 3: AUC = 0.748, ROC saved.
   Imp 4: AUC = 0.755, ROC saved.
   Imp 5: AUC = 0.762, ROC saved.
 Composite PS + AUC saved for CAT_Benzodiazepine
 Running PS estimation for CAT_Antihypertensiva
   Imp 1: AUC = 0.768, ROC saved.
   Imp 2: AUC = 0.751, ROC saved.
   Imp 3: AUC = 0.790, ROC saved.
   Imp 4: AUC = 0.768, ROC saved.
   Imp 5: AUC = 0.756, ROC saved.
 Composite PS + AUC saved for CAT_Antihypertensiva
 Running PS estimation for CAT_Antihistaminica
   Imp 1: AUC = 0.798, ROC saved.
   Imp 2: AUC = 0.790, ROC saved.
   Imp 3: AUC = 0.795, ROC saved.
   Imp 4: AUC = 0.770, ROC saved.
   Imp 5: AUC = 0.761, ROC saved.
 Composite PS + AUC saved for CAT_Antihistaminica
 Running PS estimation for CAT_Anti_epileptica
   Imp 1: AUC = 0.731, ROC saved.
   Imp 2: AUC = 0.773, ROC saved.
   Imp 3: AUC = 0.751, ROC saved.
   Imp 4: AUC = 0.763, ROC saved.
   Imp 5: AUC = 0.760, ROC saved.
 Composite PS + AUC saved for CAT_Anti_epileptica
 Running PS estimation for CAT_Antidepressiva
   Imp 1: AUC = 0.787, ROC saved.
   Imp 2: AUC = 0.780, ROC saved.
   Imp 3: AUC = 0.782, ROC saved.
   Imp 4: AUC = 0.772, ROC saved.
   Imp 5: AUC = 0.779, ROC saved.
 Composite PS + AUC saved for CAT_Antidepressiva
 Running PS estimation for CAT_Antipsychotica
   Imp 1: AUC = 0.812, ROC saved.
   Imp 2: AUC = 0.802, ROC saved.
   Imp 3: AUC = 0.824, ROC saved.
   Imp 4: AUC = 0.795, ROC saved.
   Imp 5: AUC = 0.813, ROC saved.
 Composite PS + AUC saved for CAT_Antipsychotica
 Running PS estimation for CAT_ALL_PSYCHOTROPICS_EXCL_BENZO
   Imp 1: AUC = 0.774, ROC saved.
   Imp 2: AUC = 0.768, ROC saved.
   Imp 3: AUC = 0.770, ROC saved.
   Imp 4: AUC = 0.764, ROC saved.
   Imp 5: AUC = 0.764, ROC saved.
 Composite PS + AUC saved for CAT_ALL_PSYCHOTROPICS_EXCL_BENZO
 Running PS estimation for CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS
   Imp 1: AUC = 0.786, ROC saved.
   Imp 2: AUC = 0.775, ROC saved.
   Imp 3: AUC = 0.769, ROC saved.
   Imp 4: AUC = 0.771, ROC saved.
   Imp 5: AUC = 0.776, ROC saved.
 Composite PS + AUC saved for CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS
 Running PS estimation for CAT_ALL_PSYCHOTROPICS
   Imp 1: AUC = 0.773, ROC saved.
   Imp 2: AUC = 0.782, ROC saved.
   Imp 3: AUC = 0.776, ROC saved.
   Imp 4: AUC = 0.761, ROC saved.
   Imp 5: AUC = 0.780, ROC saved.
 Composite PS + AUC saved for CAT_ALL_PSYCHOTROPICS
 Running PS estimation for CAT_ALL
   Imp 1: AUC = 0.778, ROC saved.
   Imp 2: AUC = 0.778, ROC saved.
   Imp 3: AUC = 0.777, ROC saved.
   Imp 4: AUC = 0.774, ROC saved.
   Imp 5: AUC = 0.787, ROC saved.
 Composite PS + AUC saved for CAT_ALL
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=9a181c2a-5bec-4510-9d28-a7637b4615e2">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[128]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">xgboost</span> <span class="kn">import</span> <span class="n">XGBClassifier</span>

<span class="k">def</span> <span class="nf">compute_feature_importance</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Computing feature importance for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No covariates found for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">covariates</span> <span class="o">=</span> <span class="n">final_covariates_map</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
        <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"outputs"</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">importance_df_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df_imp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_imp</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> not in imputed dataset </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">X</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>

            <span class="c1"># Drop NaNs in treatment</span>
            <span class="n">valid_idx</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">index</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">XGBClassifier</span><span class="p">(</span><span class="n">use_label_encoder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eval_metric</span><span class="o">=</span><span class="s1">'logloss'</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
                <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>

                <span class="c1"># Get feature importance</span>
                <span class="n">importances</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_booster</span><span class="p">()</span><span class="o">.</span><span class="n">get_score</span><span class="p">(</span><span class="n">importance_type</span><span class="o">=</span><span class="s1">'gain'</span><span class="p">)</span>
                <span class="n">df_feat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">importances</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">'index'</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">"imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">])</span>
                <span class="n">df_feat</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">'feature'</span>
                <span class="n">importance_df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_feat</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   Error during modeling: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">importance_df_list</span><span class="p">:</span>
            <span class="c1"># Combine and average</span>
            <span class="n">all_feat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">importance_df_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">all_feat</span><span class="p">[</span><span class="s2">"mean_importance"</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_feat</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Filter top 30 non-zero</span>
            <span class="n">non_zero</span> <span class="o">=</span> <span class="n">all_feat</span><span class="p">[</span><span class="n">all_feat</span><span class="p">[</span><span class="s2">"mean_importance"</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">top30</span> <span class="o">=</span> <span class="n">non_zero</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">"mean_importance"</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>

            <span class="c1"># Save to CSV</span>
            <span class="n">top30</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"feature_importance.csv"</span><span class="p">))</span>

            <span class="c1"># Plot</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top30</span><span class="o">.</span><span class="n">index</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">top30</span><span class="p">[</span><span class="s2">"mean_importance"</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># plot top  bottom</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Mean Gain Importance"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Top 30 Feature Importance - </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"feature_importance_top30.png"</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Saved feature importance plot and CSV for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No valid models for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1">#  Run</span>
<span class="n">compute_feature_importance</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Computing feature importance for CAT_ADHD
 Saved feature importance plot and CSV for CAT_ADHD

 Computing feature importance for CAT_Aceetanilidederivaten
 Saved feature importance plot and CSV for CAT_Aceetanilidederivaten

 Computing feature importance for CAT_Z_drugs
 Saved feature importance plot and CSV for CAT_Z_drugs

 Computing feature importance for CAT_Opioden
 Saved feature importance plot and CSV for CAT_Opioden

 Computing feature importance for CAT_NSAIDs
 Saved feature importance plot and CSV for CAT_NSAIDs

 Computing feature importance for CAT_Benzodiazepine
 Saved feature importance plot and CSV for CAT_Benzodiazepine

 Computing feature importance for CAT_Antihypertensiva
 Saved feature importance plot and CSV for CAT_Antihypertensiva

 Computing feature importance for CAT_Antihistaminica
 Saved feature importance plot and CSV for CAT_Antihistaminica

 Computing feature importance for CAT_Anti_epileptica
 Saved feature importance plot and CSV for CAT_Anti_epileptica

 Computing feature importance for CAT_Antidepressiva
 Saved feature importance plot and CSV for CAT_Antidepressiva

 Computing feature importance for CAT_Antipsychotica
 Saved feature importance plot and CSV for CAT_Antipsychotica

 Computing feature importance for CAT_ALL_PSYCHOTROPICS_EXCL_BENZO
 Saved feature importance plot and CSV for CAT_ALL_PSYCHOTROPICS_EXCL_BENZO

 Computing feature importance for CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS
 Saved feature importance plot and CSV for CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS

 Computing feature importance for CAT_ALL_PSYCHOTROPICS
 Saved feature importance plot and CSV for CAT_ALL_PSYCHOTROPICS

 Computing feature importance for CAT_ALL
 Saved feature importance plot and CSV for CAT_ALL
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=df86de76-a391-45d6-a5e2-06d6390c6a1a">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[129]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="k">def</span> <span class="nf">compute_trimmed_clipped_iptw</span><span class="p">(</span><span class="n">ps_df</span><span class="p">,</span> <span class="n">treatment</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">clip_max</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">keep_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">ps_df</span> <span class="o">&gt;</span> <span class="n">lower</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ps_df</span> <span class="o">&lt;</span> <span class="n">upper</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ps_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">ps</span> <span class="o">=</span> <span class="n">ps_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">lower</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">1e-6</span><span class="p">)</span>  <span class="c1"># avoid div by zero</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">keep_mask</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">ps</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="n">w</span><span class="p">[</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">treatment</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">ps</span><span class="p">[</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">treatment</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="n">w</span><span class="p">[</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">treatment</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ps</span><span class="p">[</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">treatment</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)])</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">upper</span><span class="o">=</span><span class="n">clip_max</span><span class="p">)</span>
        <span class="n">weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">apply_rubins_rule_to_iptw</span><span class="p">(</span><span class="n">iptw_matrix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Given an IPTW matrix (n rows  M imputations), return Rubins rule pooled mean, SD, SE.</span>
<span class="sd">    """</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">q_bar</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">u_bar</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">total_var</span> <span class="o">=</span> <span class="n">u_bar</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">M</span><span class="p">)</span> <span class="o">*</span> <span class="n">B</span>
    <span class="n">total_se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">total_var</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">q_bar</span><span class="p">,</span> <span class="n">u_bar</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">total_se</span>


<span class="k">def</span> <span class="nf">run_trim_clip_save_all</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Processing IPTW + trimming + clipping for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"outputs"</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">ps_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"propensity_scores.xlsx"</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ps_path</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Missing PS file: </span><span class="si">{</span><span class="n">ps_path</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ps_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">ps_path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">ps_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">ps_all</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"ps_imp"</span><span class="p">)]</span>
            <span class="n">composite_index</span> <span class="o">=</span> <span class="n">ps_all</span><span class="o">.</span><span class="n">index</span>

            <span class="c1"># Get treatment from one imputed dataset</span>
            <span class="n">T_full</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">imputed_dfs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">T_full</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">composite_index</span><span class="p">,</span> <span class="n">group</span><span class="p">]</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="n">T_full</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Treatment column </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> not found in any imputed dataset."</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Compute IPTW matrix (shape: n  M)</span>
            <span class="n">iptw_matrix</span> <span class="o">=</span> <span class="n">compute_trimmed_clipped_iptw</span><span class="p">(</span><span class="n">ps_all</span><span class="p">[</span><span class="n">ps_cols</span><span class="p">],</span> <span class="n">T_full</span><span class="p">)</span>
            <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">"iptw_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iptw_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>

            <span class="c1"># Apply Rubins Rule for mean, SD, SE</span>
            <span class="n">iptw_matrix</span><span class="p">[</span><span class="s2">"iptw_mean"</span><span class="p">],</span> <span class="n">iptw_matrix</span><span class="p">[</span><span class="s2">"iptw_sd"</span><span class="p">],</span> <span class="n">iptw_matrix</span><span class="p">[</span><span class="s2">"iptw_se"</span><span class="p">]</span> <span class="o">=</span> <span class="n">apply_rubins_rule_to_iptw</span><span class="p">(</span>
                <span class="n">iptw_matrix</span><span class="p">[[</span><span class="sa">f</span><span class="s2">"iptw_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iptw_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]]</span>
            <span class="p">)</span>

            <span class="c1"># Save IPTW matrix separately</span>
            <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"iptw_weights.xlsx"</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Saved IPTW weights for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

            <span class="c1"># Save trimmed &amp; clipped imputed datasets with IPTW</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">imputed_dfs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">trimmed_idx</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="n">needed_cols</span> <span class="o">=</span> <span class="n">final_covariates_map</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">group</span><span class="p">,</span> <span class="s2">"caps5_change_baseline"</span><span class="p">]</span>

                <span class="c1"># Select only necessary columns</span>
                <span class="n">df_trimmed</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">trimmed_idx</span><span class="p">,</span> <span class="n">needed_cols</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">df_trimmed</span><span class="p">[</span><span class="s2">"iptw"</span><span class="p">]</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="p">[</span><span class="sa">f</span><span class="s2">"iptw_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">trimmed_idx</span><span class="p">]</span>

                <span class="c1">#  DROP rows with missing IPTW values</span>
                <span class="n">before</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_trimmed</span><span class="p">)</span>
                <span class="n">df_trimmed</span> <span class="o">=</span> <span class="n">df_trimmed</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">"iptw"</span><span class="p">])</span>
                <span class="n">after</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_trimmed</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"     Retained </span><span class="si">{</span><span class="n">after</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">before</span><span class="si">}</span><span class="s2"> rows after IPTW NaN drop."</span><span class="p">)</span>

                <span class="c1"># Save to .pkl</span>
                <span class="n">df_trimmed</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"trimmed_data_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.pkl"</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   Saved trimmed dataset: </span><span class="si">{</span><span class="n">output_folder</span><span class="si">}</span><span class="s2">/trimmed_data_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.*"</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>


<span class="n">run_trim_clip_save_all</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Processing IPTW + trimming + clipping for CAT_ADHD
 Saved IPTW weights for CAT_ADHD
     Retained 111/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ADHD/trimmed_data_imp1.*
     Retained 103/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ADHD/trimmed_data_imp2.*
     Retained 110/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ADHD/trimmed_data_imp3.*
     Retained 108/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ADHD/trimmed_data_imp4.*
     Retained 104/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ADHD/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for CAT_Aceetanilidederivaten
 Saved IPTW weights for CAT_Aceetanilidederivaten
     Retained 75/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Aceetanilidederivaten/trimmed_data_imp1.*
     Retained 68/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Aceetanilidederivaten/trimmed_data_imp2.*
     Retained 67/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Aceetanilidederivaten/trimmed_data_imp3.*
     Retained 75/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Aceetanilidederivaten/trimmed_data_imp4.*
     Retained 68/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Aceetanilidederivaten/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for CAT_Z_drugs
 Saved IPTW weights for CAT_Z_drugs
     Retained 99/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Z_drugs/trimmed_data_imp1.*
     Retained 96/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Z_drugs/trimmed_data_imp2.*
     Retained 101/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Z_drugs/trimmed_data_imp3.*
     Retained 100/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Z_drugs/trimmed_data_imp4.*
     Retained 101/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Z_drugs/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for CAT_Opioden
 Saved IPTW weights for CAT_Opioden
     Retained 98/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Opioden/trimmed_data_imp1.*
     Retained 92/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Opioden/trimmed_data_imp2.*
     Retained 95/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Opioden/trimmed_data_imp3.*
     Retained 98/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Opioden/trimmed_data_imp4.*
     Retained 90/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Opioden/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for CAT_NSAIDs
 Saved IPTW weights for CAT_NSAIDs
     Retained 65/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_NSAIDs/trimmed_data_imp1.*
     Retained 62/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_NSAIDs/trimmed_data_imp2.*
     Retained 67/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_NSAIDs/trimmed_data_imp3.*
     Retained 69/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_NSAIDs/trimmed_data_imp4.*
     Retained 62/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_NSAIDs/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for CAT_Benzodiazepine
 Saved IPTW weights for CAT_Benzodiazepine
     Retained 991/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Benzodiazepine/trimmed_data_imp1.*
     Retained 1028/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Benzodiazepine/trimmed_data_imp2.*
     Retained 977/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Benzodiazepine/trimmed_data_imp3.*
     Retained 1052/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Benzodiazepine/trimmed_data_imp4.*
     Retained 1030/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Benzodiazepine/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for CAT_Antihypertensiva
 Saved IPTW weights for CAT_Antihypertensiva
     Retained 84/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antihypertensiva/trimmed_data_imp1.*
     Retained 82/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antihypertensiva/trimmed_data_imp2.*
     Retained 79/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antihypertensiva/trimmed_data_imp3.*
     Retained 90/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antihypertensiva/trimmed_data_imp4.*
     Retained 86/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antihypertensiva/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for CAT_Antihistaminica
 Saved IPTW weights for CAT_Antihistaminica
     Retained 96/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antihistaminica/trimmed_data_imp1.*
     Retained 96/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antihistaminica/trimmed_data_imp2.*
     Retained 96/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antihistaminica/trimmed_data_imp3.*
     Retained 96/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antihistaminica/trimmed_data_imp4.*
     Retained 92/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antihistaminica/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for CAT_Anti_epileptica
 Saved IPTW weights for CAT_Anti_epileptica
     Retained 135/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Anti_epileptica/trimmed_data_imp1.*
     Retained 145/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Anti_epileptica/trimmed_data_imp2.*
     Retained 140/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Anti_epileptica/trimmed_data_imp3.*
     Retained 147/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Anti_epileptica/trimmed_data_imp4.*
     Retained 148/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Anti_epileptica/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for CAT_Antidepressiva
 Saved IPTW weights for CAT_Antidepressiva
     Retained 1622/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antidepressiva/trimmed_data_imp1.*
     Retained 1554/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antidepressiva/trimmed_data_imp2.*
     Retained 1587/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antidepressiva/trimmed_data_imp3.*
     Retained 1610/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antidepressiva/trimmed_data_imp4.*
     Retained 1590/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antidepressiva/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for CAT_Antipsychotica
 Saved IPTW weights for CAT_Antipsychotica
     Retained 637/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antipsychotica/trimmed_data_imp1.*
     Retained 623/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antipsychotica/trimmed_data_imp2.*
     Retained 604/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antipsychotica/trimmed_data_imp3.*
     Retained 598/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antipsychotica/trimmed_data_imp4.*
     Retained 587/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antipsychotica/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for CAT_ALL_PSYCHOTROPICS_EXCL_BENZO
 Saved IPTW weights for CAT_ALL_PSYCHOTROPICS_EXCL_BENZO
     Retained 1938/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL_PSYCHOTROPICS_EXCL_BENZO/trimmed_data_imp1.*
     Retained 1899/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL_PSYCHOTROPICS_EXCL_BENZO/trimmed_data_imp2.*
     Retained 1992/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL_PSYCHOTROPICS_EXCL_BENZO/trimmed_data_imp3.*
     Retained 1948/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL_PSYCHOTROPICS_EXCL_BENZO/trimmed_data_imp4.*
     Retained 1929/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL_PSYCHOTROPICS_EXCL_BENZO/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS
 Saved IPTW weights for CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS
     Retained 1973/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS/trimmed_data_imp1.*
     Retained 1925/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS/trimmed_data_imp2.*
     Retained 1945/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS/trimmed_data_imp3.*
     Retained 1910/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS/trimmed_data_imp4.*
     Retained 1940/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for CAT_ALL_PSYCHOTROPICS
 Saved IPTW weights for CAT_ALL_PSYCHOTROPICS
     Retained 2321/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL_PSYCHOTROPICS/trimmed_data_imp1.*
     Retained 2238/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL_PSYCHOTROPICS/trimmed_data_imp2.*
     Retained 2298/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL_PSYCHOTROPICS/trimmed_data_imp3.*
     Retained 2277/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL_PSYCHOTROPICS/trimmed_data_imp4.*
     Retained 2271/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL_PSYCHOTROPICS/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for CAT_ALL
 Saved IPTW weights for CAT_ALL
     Retained 2300/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL/trimmed_data_imp1.*
     Retained 2203/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL/trimmed_data_imp2.*
     Retained 2295/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL/trimmed_data_imp3.*
     Retained 2284/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL/trimmed_data_imp4.*
     Retained 2282/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL/trimmed_data_imp5.*
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=9ed308b6-fe68-43f9-aa75-565caf5adf0d">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[130]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="k">def</span> <span class="nf">plot_ps_overlap_all_groups</span><span class="p">(</span><span class="n">medication_groups</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Plotting PS overlap for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="n">folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"outputs"</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">ps_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">"propensity_scores.xlsx"</span><span class="p">)</span>
        <span class="n">iptw_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">"iptw_weights.xlsx"</span><span class="p">)</span>
        <span class="n">trimmed_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">"trimmed_data_imp1.pkl"</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ps_file</span><span class="p">,</span> <span class="n">iptw_file</span><span class="p">,</span> <span class="n">trimmed_file</span><span class="p">]):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Missing required files for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ps_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">ps_file</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">iptw_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">iptw_file</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">trimmed_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">trimmed_file</span><span class="p">)</span>

            <span class="c1"># Extract</span>
            <span class="n">ps</span> <span class="o">=</span> <span class="n">ps_df</span><span class="p">[</span><span class="s2">"composite_ps"</span><span class="p">]</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">trimmed_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">iptw_df</span><span class="p">[</span><span class="s2">"iptw_mean"</span><span class="p">]</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">trimmed_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">trimmed_df</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>

            <span class="c1"># Masks to remove NaNs</span>
            <span class="n">treated_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ps</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">w</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
            <span class="n">control_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ps</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">w</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>

            <span class="n">treated</span> <span class="o">=</span> <span class="n">ps</span><span class="p">[</span><span class="n">treated_mask</span><span class="p">]</span>
            <span class="n">treated_w</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="n">treated_mask</span><span class="p">]</span>

            <span class="n">control</span> <span class="o">=</span> <span class="n">ps</span><span class="p">[</span><span class="n">control_mask</span><span class="p">]</span>
            <span class="n">control_w</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="n">control_mask</span><span class="p">]</span>

            <span class="c1"># === Unweighted Plot ===</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">([</span><span class="n">treated</span><span class="p">,</span> <span class="n">control</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="p">[</span><span class="s2">"Treated"</span><span class="p">,</span> <span class="s2">"Control"</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Unweighted PS Overlap - </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Composite Propensity Score"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"Count"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">"ps_overlap_unweighted.png"</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="c1"># === Weighted Plot ===</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">([</span><span class="n">treated</span><span class="p">,</span> <span class="n">control</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="p">[</span><span class="n">treated_w</span><span class="p">,</span> <span class="n">control_w</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="p">[</span><span class="s2">"Treated"</span><span class="p">,</span> <span class="s2">"Control"</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Weighted PS Overlap - </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Composite Propensity Score"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"Weighted Count"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">"ps_overlap_weighted.png"</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Saved unweighted and weighted PS plots for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error processing </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1">#  Run</span>
<span class="n">plot_ps_overlap_all_groups</span><span class="p">(</span><span class="n">medication_groups</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Plotting PS overlap for CAT_ADHD
 Saved unweighted and weighted PS plots for CAT_ADHD

 Plotting PS overlap for CAT_Aceetanilidederivaten
 Saved unweighted and weighted PS plots for CAT_Aceetanilidederivaten

 Plotting PS overlap for CAT_Z_drugs
 Saved unweighted and weighted PS plots for CAT_Z_drugs

 Plotting PS overlap for CAT_Opioden
 Saved unweighted and weighted PS plots for CAT_Opioden

 Plotting PS overlap for CAT_NSAIDs
 Saved unweighted and weighted PS plots for CAT_NSAIDs

 Plotting PS overlap for CAT_Benzodiazepine
 Saved unweighted and weighted PS plots for CAT_Benzodiazepine

 Plotting PS overlap for CAT_Antihypertensiva
 Saved unweighted and weighted PS plots for CAT_Antihypertensiva

 Plotting PS overlap for CAT_Antihistaminica
 Saved unweighted and weighted PS plots for CAT_Antihistaminica

 Plotting PS overlap for CAT_Anti_epileptica
 Saved unweighted and weighted PS plots for CAT_Anti_epileptica

 Plotting PS overlap for CAT_Antidepressiva
 Saved unweighted and weighted PS plots for CAT_Antidepressiva

 Plotting PS overlap for CAT_Antipsychotica
 Saved unweighted and weighted PS plots for CAT_Antipsychotica

 Plotting PS overlap for CAT_ALL_PSYCHOTROPICS_EXCL_BENZO
 Saved unweighted and weighted PS plots for CAT_ALL_PSYCHOTROPICS_EXCL_BENZO

 Plotting PS overlap for CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS
 Saved unweighted and weighted PS plots for CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS

 Plotting PS overlap for CAT_ALL_PSYCHOTROPICS
 Saved unweighted and weighted PS plots for CAT_ALL_PSYCHOTROPICS

 Plotting PS overlap for CAT_ALL
 Saved unweighted and weighted PS plots for CAT_ALL
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=29ea4dea-63df-45a3-96a0-4fa1500801cd">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[131]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># Set up base output folder</span>
<span class="n">output_base</span> <span class="o">=</span> <span class="s2">"outputs"</span>
<span class="n">ps_file</span> <span class="o">=</span> <span class="s2">"propensity_scores.xlsx"</span>
<span class="n">iptw_file</span> <span class="o">=</span> <span class="s2">"iptw_weights.xlsx"</span>
<span class="n">trimmed_data_file</span> <span class="o">=</span> <span class="s2">"trimmed_data_imp1.pkl"</span>

<span class="c1"># Collect all treatment group folders</span>
<span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">medication_groups</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">g</span><span class="p">))]</span>

<span class="c1"># Generate 4-panel overlap plots</span>
<span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
    <span class="n">group_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Load trimmed treatment info</span>
        <span class="n">trimmed_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="n">trimmed_data_file</span><span class="p">))</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">trimmed_df</span><span class="o">.</span><span class="n">index</span>

        <span class="c1"># Fix: case-insensitive match for treatment variable</span>
        <span class="n">possible_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">trimmed_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">group</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">possible_cols</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Treatment variable </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> not found in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">, skipping."</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">treatment_var</span> <span class="o">=</span> <span class="n">possible_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">trimmed_df</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span>

        <span class="c1"># Load composite PS (aligned to trimmed_df index)</span>
        <span class="n">ps_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="n">ps_file</span><span class="p">),</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">'composite_ps'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ps_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Composite column missing in </span><span class="si">{</span><span class="n">ps_file</span><span class="si">}</span><span class="s2">, skipping </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">."</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">ps</span> <span class="o">=</span> <span class="n">ps_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s1">'composite_ps'</span><span class="p">]</span>

        <span class="c1"># Load IPTW weights (aligned to trimmed_df index)</span>
        <span class="n">weights_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="n">iptw_file</span><span class="p">),</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">'iptw_mean'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">weights_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" IPTW weight column missing in </span><span class="si">{</span><span class="n">iptw_file</span><span class="si">}</span><span class="s2">, skipping </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">."</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">weights_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s1">'iptw_mean'</span><span class="p">]</span>

        <span class="c1"># Prepare 4 datasets</span>
        <span class="n">raw_treated</span> <span class="o">=</span> <span class="n">ps</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">raw_control</span> <span class="o">=</span> <span class="n">ps</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">weighted_treated</span> <span class="o">=</span> <span class="p">(</span><span class="n">ps</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">],</span> <span class="n">weights</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">weighted_control</span> <span class="o">=</span> <span class="p">(</span><span class="n">ps</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">],</span> <span class="n">weights</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Create plot</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Propensity Score Distribution - </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">raw_treated</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'blue'</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Raw Treated"</span><span class="p">)</span>

        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">raw_control</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'green'</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Raw Control"</span><span class="p">)</span>

        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">weighted_treated</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weighted_treated</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'blue'</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Weighted Treated"</span><span class="p">)</span>

        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">weighted_control</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weighted_control</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'green'</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Weighted Control"</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="o">.</span><span class="n">flat</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Propensity Score"</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Count"</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">])</span>

        <span class="c1"># Save figure</span>
        <span class="n">plot_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"four_panel_overlap_</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">.png"</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_path</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Saved: </span><span class="si">{</span><span class="n">plot_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>  Saved: outputs\CAT_ADHD\four_panel_overlap_CAT_ADHD.png
  Saved: outputs\CAT_Aceetanilidederivaten\four_panel_overlap_CAT_Aceetanilidederivaten.png
  Saved: outputs\CAT_Z_drugs\four_panel_overlap_CAT_Z_drugs.png
  Saved: outputs\CAT_Opioden\four_panel_overlap_CAT_Opioden.png
  Saved: outputs\CAT_NSAIDs\four_panel_overlap_CAT_NSAIDs.png
  Saved: outputs\CAT_Benzodiazepine\four_panel_overlap_CAT_Benzodiazepine.png
  Saved: outputs\CAT_Antihypertensiva\four_panel_overlap_CAT_Antihypertensiva.png
  Saved: outputs\CAT_Antihistaminica\four_panel_overlap_CAT_Antihistaminica.png
  Saved: outputs\CAT_Anti_epileptica\four_panel_overlap_CAT_Anti_epileptica.png
  Saved: outputs\CAT_Antidepressiva\four_panel_overlap_CAT_Antidepressiva.png
  Saved: outputs\CAT_Antipsychotica\four_panel_overlap_CAT_Antipsychotica.png
  Saved: outputs\CAT_ALL_PSYCHOTROPICS_EXCL_BENZO\four_panel_overlap_CAT_ALL_PSYCHOTROPICS_EXCL_BENZO.png
  Saved: outputs\CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS\four_panel_overlap_CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS.png
  Saved: outputs\CAT_ALL_PSYCHOTROPICS\four_panel_overlap_CAT_ALL_PSYCHOTROPICS.png
  Saved: outputs\CAT_ALL\four_panel_overlap_CAT_ALL.png
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=84753833-c355-4cd9-91f1-f0d0f66b7705">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[132]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># ATT calculation:</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=8ac32062-ff51-4b7d-9ac8-94e71a1e7534">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[133]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Weighted:</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=9be14728-16ba-4ae3-8077-ec1c895d8b10">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[134]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">GradientBoostingRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">r2_score</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">KFold</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">t</span><span class="p">,</span> <span class="n">probplot</span>
<span class="kn">import</span> <span class="nn">xgboost</span> <span class="k">as</span> <span class="nn">xgb</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Configuration</span>
<span class="c1"># -----------------------------</span>
<span class="n">n_repeats</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">seeds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span>
<span class="n">imputations</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">output_folder</span> <span class="o">=</span> <span class="s2">"outputs"</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Diagnostic Plotting Function</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">create_diagnostic_plots</span><span class="p">(</span><span class="n">residuals_data</span><span class="p">,</span> <span class="n">fitted_data</span><span class="p">,</span> <span class="n">group_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Create 4 diagnostic plots for model validation"""</span>
    <span class="n">plots_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"plots"</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">plots_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Flatten the collected data</span>
    <span class="n">all_residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">residuals_data</span><span class="p">)</span>
    <span class="n">all_fitted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">fitted_data</span><span class="p">)</span>
    
    <span class="c1"># Create figure with 2x2 subplots</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Diagnostic Plots - </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">'bold'</span><span class="p">)</span>
    
    <span class="c1"># 1. Residuals vs Fitted</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">all_fitted</span><span class="p">,</span> <span class="n">all_residuals</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Fitted Values'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Residuals'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Residuals vs Fitted'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># 2. QQ Plot</span>
    <span class="n">probplot</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s2">"norm"</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Q-Q Plot (Normal)'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># 3. Residual Histogram</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'skyblue'</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">'black'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Residuals'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Density'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Residual Distribution'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># 4. Scale-Location Plot</span>
    <span class="n">sqrt_abs_residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">))</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">all_fitted</span><span class="p">,</span> <span class="n">sqrt_abs_residuals</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Fitted Values'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'|Residuals|'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Scale-Location Plot'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    
    <span class="c1"># Save plot</span>
    <span class="n">plot_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plots_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s1">.png'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_filename</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">'tight'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Diagnostic plots saved for </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Rubin's Rule</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">rubins_pool</span><span class="p">(</span><span class="n">estimates</span><span class="p">,</span> <span class="n">ses</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">estimates</span><span class="p">)</span>
    <span class="n">q_bar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">estimates</span><span class="p">)</span>
    <span class="n">u_bar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">ses</span><span class="p">))</span>
    <span class="n">b_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">estimates</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">total_var</span> <span class="o">=</span> <span class="n">u_bar</span> <span class="o">+</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">b_m</span><span class="p">)</span>
    <span class="n">total_se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">total_var</span><span class="p">)</span>
    <span class="n">ci_lower</span> <span class="o">=</span> <span class="n">q_bar</span> <span class="o">-</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">total_se</span>
    <span class="n">ci_upper</span> <span class="o">=</span> <span class="n">q_bar</span> <span class="o">+</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">total_se</span>
    <span class="n">p_value</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">q_bar</span> <span class="o">/</span> <span class="n">total_se</span><span class="p">),</span> <span class="n">df</span><span class="o">=</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">rounded_p</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">p_value</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">formatted_p</span> <span class="o">=</span> <span class="s2">"&lt; 0.00001"</span> <span class="k">if</span> <span class="n">rounded_p</span> <span class="o">&lt;=</span> <span class="mf">0.00001</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">rounded_p</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">return</span> <span class="n">q_bar</span><span class="p">,</span> <span class="n">total_se</span><span class="p">,</span> <span class="n">ci_lower</span><span class="p">,</span> <span class="n">ci_upper</span><span class="p">,</span> <span class="n">formatted_p</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># SMD + Variance Ratio</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">calculate_smd_vr</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
    <span class="n">treated</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">control</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">w_treated</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">w_control</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">smd</span><span class="p">,</span> <span class="n">vr</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m1</span><span class="p">,</span> <span class="n">m0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">treated</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">w_treated</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">control</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">w_control</span><span class="p">)</span>
            <span class="n">s1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">((</span><span class="n">treated</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">-</span> <span class="n">m1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w_treated</span><span class="p">))</span>
            <span class="n">s0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">((</span><span class="n">control</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">-</span> <span class="n">m0</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w_control</span><span class="p">))</span>
            <span class="n">pooled_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">s1</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">s0</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">smd</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">m1</span> <span class="o">-</span> <span class="n">m0</span><span class="p">)</span> <span class="o">/</span> <span class="n">pooled_sd</span> <span class="k">if</span> <span class="n">pooled_sd</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">vr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s1</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">s0</span><span class="o">**</span><span class="mi">2</span> <span class="k">if</span> <span class="n">s0</span><span class="o">**</span><span class="mi">2</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">smd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">vr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">smd</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">vr</span><span class="p">)</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># XGBoost Main Loop (No DML)</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">run_xgboost_with_trimmed_data</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="p">):</span>
    <span class="n">att_results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">balance_results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">covariates</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Running XGBoost for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">group_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">group_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">best_result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">best_se</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">"inf"</span><span class="p">)</span>
        
        <span class="c1"># Initialize lists to collect residuals and fitted values for diagnostic plots</span>
        <span class="n">group_residuals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">group_fitted</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="n">seeds</span><span class="p">:</span>
            <span class="n">att_list</span><span class="p">,</span> <span class="n">se_list</span><span class="p">,</span> <span class="n">r2_list</span><span class="p">,</span> <span class="n">rmse_list</span><span class="p">,</span> <span class="n">smd_list</span><span class="p">,</span> <span class="n">vr_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">imp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">imputations</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"trimmed_data_imp</span><span class="si">{</span><span class="n">imp</span><span class="si">}</span><span class="s2">.pkl"</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">or</span> <span class="s2">"iptw"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">T</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
                <span class="n">Y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">"caps5_change_baseline"</span><span class="p">]</span>
                <span class="n">W</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">"iptw"</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">repeat</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_repeats</span><span class="p">):</span>
                    <span class="n">kf</span> <span class="o">=</span> <span class="n">KFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span> <span class="o">+</span> <span class="n">repeat</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">train_idx</span><span class="p">,</span> <span class="n">test_idx</span> <span class="ow">in</span> <span class="n">kf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">X_train</span><span class="p">,</span> <span class="n">T_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">W_train</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span>
                                <span class="n">T</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span>
                                <span class="n">Y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span>
                                <span class="n">W</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span>
                            <span class="p">)</span>

                            <span class="c1"># XGBoost regression model</span>
                            <span class="n">model</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
                            
                            <span class="c1"># Add treatment variable to features</span>
                            <span class="n">X_train_with_T</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                            <span class="n">X_train_with_T</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_train</span>
                            
                            <span class="c1"># Fit model</span>
                            <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_with_T</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="n">W_train</span><span class="p">)</span>
                            
                            <span class="c1"># Predict outcomes for treated and control groups</span>
                            <span class="n">X_treated</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                            <span class="n">X_treated</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="n">X_control</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                            <span class="n">X_control</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                            
                            <span class="n">Y_pred_treated</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_treated</span><span class="p">)</span>
                            <span class="n">Y_pred_control</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_control</span><span class="p">)</span>
                            
                            <span class="c1"># Calculate ATT (Average Treatment Effect on Treated)</span>
                            <span class="n">treated_mask</span> <span class="o">=</span> <span class="n">T_train</span> <span class="o">==</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">treated_mask</span><span class="p">):</span>
                                <span class="n">att</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">Y_pred_treated</span><span class="p">[</span><span class="n">treated_mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">Y_pred_control</span><span class="p">[</span><span class="n">treated_mask</span><span class="p">],</span> 
                                               <span class="n">weights</span><span class="o">=</span><span class="n">W_train</span><span class="p">[</span><span class="n">treated_mask</span><span class="p">])</span>
                                
                                <span class="c1"># Calculate standard error (approximate)</span>
                                <span class="n">treatment_effects</span> <span class="o">=</span> <span class="n">Y_pred_treated</span><span class="p">[</span><span class="n">treated_mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">Y_pred_control</span><span class="p">[</span><span class="n">treated_mask</span><span class="p">]</span>
                                <span class="n">residual</span> <span class="o">=</span> <span class="n">treatment_effects</span> <span class="o">-</span> <span class="n">att</span>
                                <span class="n">se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">W_train</span><span class="p">[</span><span class="n">treated_mask</span><span class="p">]</span> <span class="o">*</span> <span class="n">residual</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">W_train</span><span class="p">[</span><span class="n">treated_mask</span><span class="p">])</span>

                                
                                <span class="n">att_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">att</span><span class="p">)</span>
                                <span class="n">se_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">se</span><span class="p">)</span>

                            <span class="c1"># Model performance metrics</span>
                            <span class="n">Y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train_with_T</span><span class="p">)</span>
                            <span class="n">residuals</span> <span class="o">=</span> <span class="n">Y_train</span> <span class="o">-</span> <span class="n">Y_pred</span>
                            <span class="n">rmse</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_pred</span><span class="p">,</span> <span class="n">squared</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                            <span class="n">r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_pred</span><span class="p">)</span>
                            <span class="n">r2_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
                            <span class="n">rmse_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rmse</span><span class="p">)</span>
                            
                            <span class="c1"># Collect residuals and fitted values for diagnostic plots</span>
                            <span class="n">group_residuals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">residuals</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                            <span class="n">group_fitted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Y_pred</span><span class="p">)</span>

                            <span class="n">smd</span><span class="p">,</span> <span class="n">vr</span> <span class="o">=</span> <span class="n">calculate_smd_vr</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">T_train</span><span class="p">,</span> <span class="n">W_train</span><span class="p">)</span>
                            <span class="n">smd_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smd</span><span class="p">)</span>
                            <span class="n">vr_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vr</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">, seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">, imp </span><span class="si">{</span><span class="n">imp</span><span class="si">}</span><span class="s2">, rep </span><span class="si">{</span><span class="n">repeat</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">att_list</span><span class="p">:</span>
                <span class="n">att</span><span class="p">,</span> <span class="n">se</span><span class="p">,</span> <span class="n">ci_l</span><span class="p">,</span> <span class="n">ci_u</span><span class="p">,</span> <span class="n">p_val</span> <span class="o">=</span> <span class="n">rubins_pool</span><span class="p">(</span><span class="n">att_list</span><span class="p">,</span> <span class="n">se_list</span><span class="p">)</span>
                <span class="n">avg_r2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">r2_list</span><span class="p">)</span>
                <span class="n">avg_rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rmse_list</span><span class="p">)</span>
                <span class="n">avg_smd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">smd_list</span><span class="p">)</span>
                <span class="n">avg_vr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">vr_list</span><span class="p">)</span>

                <span class="n">balance_results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">"group"</span><span class="p">:</span> <span class="n">group</span><span class="p">,</span> <span class="s2">"seed"</span><span class="p">:</span> <span class="n">seed</span><span class="p">,</span> <span class="s2">"smd"</span><span class="p">:</span> <span class="n">avg_smd</span><span class="p">,</span> <span class="s2">"vr"</span><span class="p">:</span> <span class="n">avg_vr</span>
                <span class="p">})</span>

                <span class="k">if</span> <span class="n">se</span> <span class="o">&lt;</span> <span class="n">best_se</span><span class="p">:</span>
                    <span class="n">best_se</span> <span class="o">=</span> <span class="n">se</span>
                    <span class="n">best_result</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">"group"</span><span class="p">:</span> <span class="n">group</span><span class="p">,</span> <span class="s2">"seed"</span><span class="p">:</span> <span class="n">seed</span><span class="p">,</span> <span class="s2">"att"</span><span class="p">:</span> <span class="n">att</span><span class="p">,</span> <span class="s2">"se"</span><span class="p">:</span> <span class="n">se</span><span class="p">,</span>
                        <span class="s2">"ci_lower"</span><span class="p">:</span> <span class="n">ci_l</span><span class="p">,</span> <span class="s2">"ci_upper"</span><span class="p">:</span> <span class="n">ci_u</span><span class="p">,</span> <span class="s2">"p_value"</span><span class="p">:</span> <span class="n">p_val</span><span class="p">,</span>
                        <span class="s2">"r2"</span><span class="p">:</span> <span class="n">avg_r2</span><span class="p">,</span> <span class="s2">"rmse"</span><span class="p">:</span> <span class="n">avg_rmse</span>
                    <span class="p">}</span>

                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> | Seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">: ATT = </span><span class="si">{</span><span class="n">att</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, SE = </span><span class="si">{</span><span class="n">se</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, p = </span><span class="si">{</span><span class="n">p_val</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No valid results for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> | Seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Create diagnostic plots for this group</span>
        <span class="k">if</span> <span class="n">group_residuals</span> <span class="ow">and</span> <span class="n">group_fitted</span><span class="p">:</span>
            <span class="n">create_diagnostic_plots</span><span class="p">(</span><span class="n">group_residuals</span><span class="p">,</span> <span class="n">group_fitted</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">best_result</span><span class="p">:</span>
            <span class="n">att_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">best_result</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Best result for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">  Seed </span><span class="si">{</span><span class="n">best_result</span><span class="p">[</span><span class="s1">'seed'</span><span class="p">]</span><span class="si">}</span><span class="s2"> | SE = </span><span class="si">{</span><span class="n">best_result</span><span class="p">[</span><span class="s1">'se'</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="c1"># Save final output</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">att_results</span><span class="p">)</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">"xgb_rubin_summary_cats.xlsx"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">balance_results</span><span class="p">)</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">"smd_vr_summary_cats.xlsx"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> All summary files saved."</span><span class="p">)</span>

<span class="n">run_xgboost_with_trimmed_data</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Running XGBoost for CAT_ADHD
 CAT_ADHD | Seed 1: ATT = 0.6398, SE = 1.8546, p = 0.73313
 CAT_ADHD | Seed 2: ATT = 0.8262, SE = 1.4715, p = 0.57969
 CAT_ADHD | Seed 3: ATT = 0.6040, SE = 1.6900, p = 0.72390
 CAT_ADHD | Seed 4: ATT = 0.4602, SE = 1.7659, p = 0.79662
 CAT_ADHD | Seed 5: ATT = 0.4471, SE = 1.4554, p = 0.76135
 CAT_ADHD | Seed 6: ATT = 0.6564, SE = 1.5766, p = 0.68086
 CAT_ADHD | Seed 7: ATT = 0.6471, SE = 1.5556, p = 0.68113
 CAT_ADHD | Seed 8: ATT = 0.4790, SE = 1.5862, p = 0.76528
 CAT_ADHD | Seed 9: ATT = 0.4780, SE = 1.4343, p = 0.74182
 CAT_ADHD | Seed 10: ATT = 0.6919, SE = 1.7242, p = 0.69175
 Diagnostic plots saved for CAT_ADHD
 Best result for CAT_ADHD  Seed 9 | SE = 1.4343

 Running XGBoost for CAT_Aceetanilidederivaten
 CAT_Aceetanilidederivaten | Seed 1: ATT = 0.2975, SE = 2.8691, p = 0.91828
 CAT_Aceetanilidederivaten | Seed 2: ATT = 0.4510, SE = 3.1244, p = 0.88644
 CAT_Aceetanilidederivaten | Seed 3: ATT = 0.4654, SE = 3.0902, p = 0.88154
 CAT_Aceetanilidederivaten | Seed 4: ATT = 0.4088, SE = 2.9916, p = 0.89244
 CAT_Aceetanilidederivaten | Seed 5: ATT = 0.2789, SE = 3.1691, p = 0.93061
 CAT_Aceetanilidederivaten | Seed 6: ATT = 0.1762, SE = 2.6640, p = 0.94780
 CAT_Aceetanilidederivaten | Seed 7: ATT = 0.2876, SE = 3.1560, p = 0.92815
 CAT_Aceetanilidederivaten | Seed 8: ATT = -0.0931, SE = 3.4733, p = 0.97884
 CAT_Aceetanilidederivaten | Seed 9: ATT = 0.4887, SE = 2.6818, p = 0.85694
 CAT_Aceetanilidederivaten | Seed 10: ATT = 0.3615, SE = 3.1816, p = 0.91048
 Diagnostic plots saved for CAT_Aceetanilidederivaten
 Best result for CAT_Aceetanilidederivaten  Seed 6 | SE = 2.6640

 Running XGBoost for CAT_Z_drugs
 CAT_Z_drugs | Seed 1: ATT = 1.6543, SE = 2.2972, p = 0.47840
 CAT_Z_drugs | Seed 2: ATT = 1.8005, SE = 2.5655, p = 0.48955
 CAT_Z_drugs | Seed 3: ATT = 1.8726, SE = 2.4232, p = 0.44721
 CAT_Z_drugs | Seed 4: ATT = 2.0002, SE = 2.7489, p = 0.47387
 CAT_Z_drugs | Seed 5: ATT = 1.9562, SE = 2.9419, p = 0.51243
 CAT_Z_drugs | Seed 6: ATT = 1.7947, SE = 2.2633, p = 0.43557
 CAT_Z_drugs | Seed 7: ATT = 1.9174, SE = 2.5665, p = 0.46229
 CAT_Z_drugs | Seed 8: ATT = 1.8006, SE = 2.5342, p = 0.48422
 CAT_Z_drugs | Seed 9: ATT = 1.9565, SE = 2.8335, p = 0.49650
 CAT_Z_drugs | Seed 10: ATT = 1.9022, SE = 2.7553, p = 0.49658
 Diagnostic plots saved for CAT_Z_drugs
 Best result for CAT_Z_drugs  Seed 6 | SE = 2.2633

 Running XGBoost for CAT_Opioden
 CAT_Opioden | Seed 1: ATT = 1.3282, SE = 1.3960, p = 0.35085
 CAT_Opioden | Seed 2: ATT = 1.0273, SE = 1.3282, p = 0.44681
 CAT_Opioden | Seed 3: ATT = 1.0416, SE = 1.4482, p = 0.47893
 CAT_Opioden | Seed 4: ATT = 1.3028, SE = 1.9832, p = 0.51749
 CAT_Opioden | Seed 5: ATT = 1.1067, SE = 1.3827, p = 0.43135
 CAT_Opioden | Seed 6: ATT = 1.1278, SE = 1.1617, p = 0.34135
 CAT_Opioden | Seed 7: ATT = 1.4468, SE = 1.3851, p = 0.30664
 CAT_Opioden | Seed 8: ATT = 1.1480, SE = 1.3143, p = 0.39107
 CAT_Opioden | Seed 9: ATT = 1.0798, SE = 1.6741, p = 0.52502
 CAT_Opioden | Seed 10: ATT = 1.0983, SE = 1.3885, p = 0.43668
 Diagnostic plots saved for CAT_Opioden
 Best result for CAT_Opioden  Seed 6 | SE = 1.1617

 Running XGBoost for CAT_NSAIDs
 CAT_NSAIDs | Seed 1: ATT = 1.0605, SE = 2.1695, p = 0.62940
 CAT_NSAIDs | Seed 2: ATT = 0.9690, SE = 2.2269, p = 0.66737
 CAT_NSAIDs | Seed 3: ATT = 1.0056, SE = 2.3311, p = 0.67006
 CAT_NSAIDs | Seed 4: ATT = 0.7983, SE = 2.2999, p = 0.73153
 CAT_NSAIDs | Seed 5: ATT = 0.8897, SE = 2.1683, p = 0.68522
 CAT_NSAIDs | Seed 6: ATT = 0.9899, SE = 2.3087, p = 0.67193
 CAT_NSAIDs | Seed 7: ATT = 0.6264, SE = 1.4557, p = 0.67081
 CAT_NSAIDs | Seed 8: ATT = 0.8327, SE = 2.0021, p = 0.68116
 CAT_NSAIDs | Seed 9: ATT = 0.8049, SE = 2.2322, p = 0.72155
 CAT_NSAIDs | Seed 10: ATT = 1.1998, SE = 2.3251, p = 0.61055
 Diagnostic plots saved for CAT_NSAIDs
 Best result for CAT_NSAIDs  Seed 7 | SE = 1.4557

 Running XGBoost for CAT_Benzodiazepine
 CAT_Benzodiazepine | Seed 1: ATT = -0.0377, SE = 0.6840, p = 0.95653
 CAT_Benzodiazepine | Seed 2: ATT = 0.0419, SE = 0.6450, p = 0.94870
 CAT_Benzodiazepine | Seed 3: ATT = 0.0019, SE = 0.6712, p = 0.99772
 CAT_Benzodiazepine | Seed 4: ATT = -0.0132, SE = 0.6206, p = 0.98320
 CAT_Benzodiazepine | Seed 5: ATT = -0.0392, SE = 0.5512, p = 0.94383
 CAT_Benzodiazepine | Seed 6: ATT = 0.0827, SE = 0.5254, p = 0.87625
 CAT_Benzodiazepine | Seed 7: ATT = -0.0102, SE = 0.6545, p = 0.98772
 CAT_Benzodiazepine | Seed 8: ATT = 0.0005, SE = 0.4966, p = 0.99924
 CAT_Benzodiazepine | Seed 9: ATT = 0.0411, SE = 0.5405, p = 0.94007
 CAT_Benzodiazepine | Seed 10: ATT = 0.0331, SE = 0.5492, p = 0.95238
 Diagnostic plots saved for CAT_Benzodiazepine
 Best result for CAT_Benzodiazepine  Seed 8 | SE = 0.4966

 Running XGBoost for CAT_Antihypertensiva
 CAT_Antihypertensiva | Seed 1: ATT = -0.4511, SE = 1.1467, p = 0.69751
 CAT_Antihypertensiva | Seed 2: ATT = -0.3866, SE = 0.9317, p = 0.68185
 CAT_Antihypertensiva | Seed 3: ATT = -0.4618, SE = 1.5558, p = 0.76914
 CAT_Antihypertensiva | Seed 4: ATT = -0.3840, SE = 1.3588, p = 0.77989
 CAT_Antihypertensiva | Seed 5: ATT = -0.3672, SE = 1.2783, p = 0.77641
 CAT_Antihypertensiva | Seed 6: ATT = -0.3128, SE = 1.2583, p = 0.80577
 CAT_Antihypertensiva | Seed 7: ATT = -0.2706, SE = 1.0630, p = 0.80123
 CAT_Antihypertensiva | Seed 8: ATT = -0.3240, SE = 1.6639, p = 0.84725
 CAT_Antihypertensiva | Seed 9: ATT = -0.3159, SE = 1.3086, p = 0.81127
 CAT_Antihypertensiva | Seed 10: ATT = -0.3633, SE = 0.9161, p = 0.69518
 Diagnostic plots saved for CAT_Antihypertensiva
 Best result for CAT_Antihypertensiva  Seed 10 | SE = 0.9161

 Running XGBoost for CAT_Antihistaminica
 CAT_Antihistaminica | Seed 1: ATT = 1.3301, SE = 1.4132, p = 0.35599
 CAT_Antihistaminica | Seed 2: ATT = 1.2875, SE = 1.3585, p = 0.35269
 CAT_Antihistaminica | Seed 3: ATT = 1.3465, SE = 1.4438, p = 0.36030
 CAT_Antihistaminica | Seed 4: ATT = 1.2185, SE = 1.2393, p = 0.33528
 CAT_Antihistaminica | Seed 5: ATT = 1.3082, SE = 1.1263, p = 0.25683
 CAT_Antihistaminica | Seed 6: ATT = 1.2464, SE = 1.3835, p = 0.37656
 CAT_Antihistaminica | Seed 7: ATT = 1.2627, SE = 1.7062, p = 0.46644
 CAT_Antihistaminica | Seed 8: ATT = 1.2095, SE = 1.3552, p = 0.38100
 CAT_Antihistaminica | Seed 9: ATT = 1.3573, SE = 1.2520, p = 0.28908
 CAT_Antihistaminica | Seed 10: ATT = 1.3719, SE = 1.3274, p = 0.31166
 Diagnostic plots saved for CAT_Antihistaminica
 Best result for CAT_Antihistaminica  Seed 5 | SE = 1.1263

 Running XGBoost for CAT_Anti_epileptica
 CAT_Anti_epileptica | Seed 1: ATT = 1.7975, SE = 2.1851, p = 0.41880
 CAT_Anti_epileptica | Seed 2: ATT = 1.8566, SE = 2.2290, p = 0.41309
 CAT_Anti_epileptica | Seed 3: ATT = 1.8823, SE = 2.2779, p = 0.41675
 CAT_Anti_epileptica | Seed 4: ATT = 1.6111, SE = 1.8124, p = 0.38289
 CAT_Anti_epileptica | Seed 5: ATT = 1.6519, SE = 1.7482, p = 0.35411
 CAT_Anti_epileptica | Seed 6: ATT = 1.6680, SE = 1.7649, p = 0.35402
 CAT_Anti_epileptica | Seed 7: ATT = 2.1125, SE = 2.4046, p = 0.38837
 CAT_Anti_epileptica | Seed 8: ATT = 1.8988, SE = 2.0831, p = 0.37109
 CAT_Anti_epileptica | Seed 9: ATT = 1.8877, SE = 2.0817, p = 0.37351
 CAT_Anti_epileptica | Seed 10: ATT = 1.8031, SE = 2.2805, p = 0.43688
 Diagnostic plots saved for CAT_Anti_epileptica
 Best result for CAT_Anti_epileptica  Seed 5 | SE = 1.7482

 Running XGBoost for CAT_Antidepressiva
 CAT_Antidepressiva | Seed 1: ATT = 0.7347, SE = 0.3626, p = 0.05398
 CAT_Antidepressiva | Seed 2: ATT = 0.7006, SE = 0.3374, p = 0.04875
 CAT_Antidepressiva | Seed 3: ATT = 0.7026, SE = 0.3835, p = 0.07938
 CAT_Antidepressiva | Seed 4: ATT = 0.7111, SE = 0.3441, p = 0.04971
 CAT_Antidepressiva | Seed 5: ATT = 0.6671, SE = 0.3238, p = 0.05036
 CAT_Antidepressiva | Seed 6: ATT = 0.7090, SE = 0.3583, p = 0.05946
 CAT_Antidepressiva | Seed 7: ATT = 0.7067, SE = 0.3977, p = 0.08823
 CAT_Antidepressiva | Seed 8: ATT = 0.6586, SE = 0.3446, p = 0.06802
 CAT_Antidepressiva | Seed 9: ATT = 0.7155, SE = 0.4433, p = 0.11961
 CAT_Antidepressiva | Seed 10: ATT = 0.7449, SE = 0.4894, p = 0.14103
 Diagnostic plots saved for CAT_Antidepressiva
 Best result for CAT_Antidepressiva  Seed 5 | SE = 0.3238

 Running XGBoost for CAT_Antipsychotica
 CAT_Antipsychotica | Seed 1: ATT = 0.7601, SE = 0.8005, p = 0.35185
 CAT_Antipsychotica | Seed 2: ATT = 0.6547, SE = 0.8229, p = 0.43407
 CAT_Antipsychotica | Seed 3: ATT = 0.6411, SE = 0.7460, p = 0.39859
 CAT_Antipsychotica | Seed 4: ATT = 0.7443, SE = 0.8971, p = 0.41493
 CAT_Antipsychotica | Seed 5: ATT = 0.7025, SE = 0.6613, p = 0.29869
 CAT_Antipsychotica | Seed 6: ATT = 0.5721, SE = 0.6462, p = 0.38477
 CAT_Antipsychotica | Seed 7: ATT = 0.7636, SE = 0.6694, p = 0.26522
 CAT_Antipsychotica | Seed 8: ATT = 0.6330, SE = 0.7932, p = 0.43265
 CAT_Antipsychotica | Seed 9: ATT = 0.6966, SE = 0.7450, p = 0.35906
 CAT_Antipsychotica | Seed 10: ATT = 0.6938, SE = 0.6799, p = 0.31766
 Diagnostic plots saved for CAT_Antipsychotica
 Best result for CAT_Antipsychotica  Seed 6 | SE = 0.6462

 Running XGBoost for CAT_ALL_PSYCHOTROPICS_EXCL_BENZO
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 1: ATT = 1.5821, SE = 0.5541, p = 0.00872
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 2: ATT = 1.5745, SE = 0.5953, p = 0.01418
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 3: ATT = 1.5571, SE = 0.6117, p = 0.01776
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 4: ATT = 1.5741, SE = 0.5149, p = 0.00541
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 5: ATT = 1.6148, SE = 0.6360, p = 0.01802
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 6: ATT = 1.5842, SE = 0.6865, p = 0.02996
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 7: ATT = 1.5890, SE = 0.5302, p = 0.00625
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 8: ATT = 1.5755, SE = 0.5737, p = 0.01124
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 9: ATT = 1.5728, SE = 0.5917, p = 0.01376
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 10: ATT = 1.5336, SE = 0.6769, p = 0.03279
 Diagnostic plots saved for CAT_ALL_PSYCHOTROPICS_EXCL_BENZO
 Best result for CAT_ALL_PSYCHOTROPICS_EXCL_BENZO  Seed 4 | SE = 0.5149

 Running XGBoost for CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 1: ATT = 1.1345, SE = 0.4274, p = 0.01388
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 2: ATT = 1.1671, SE = 0.4374, p = 0.01344
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 3: ATT = 1.1542, SE = 0.3947, p = 0.00742
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 4: ATT = 1.1347, SE = 0.4744, p = 0.02494
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 5: ATT = 1.1553, SE = 0.3937, p = 0.00724
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 6: ATT = 1.1656, SE = 0.4372, p = 0.01352
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 7: ATT = 1.1599, SE = 0.4442, p = 0.01531
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 8: ATT = 1.1665, SE = 0.4750, p = 0.02169
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 9: ATT = 1.1394, SE = 0.5141, p = 0.03641
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 10: ATT = 1.1719, SE = 0.4336, p = 0.01243
 Diagnostic plots saved for CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS
 Best result for CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS  Seed 5 | SE = 0.3937

 Running XGBoost for CAT_ALL_PSYCHOTROPICS
 CAT_ALL_PSYCHOTROPICS | Seed 1: ATT = 1.6451, SE = 0.4732, p = 0.00195
 CAT_ALL_PSYCHOTROPICS | Seed 2: ATT = 1.6850, SE = 0.3958, p = 0.00027
 CAT_ALL_PSYCHOTROPICS | Seed 3: ATT = 1.6624, SE = 0.4036, p = 0.00039
 CAT_ALL_PSYCHOTROPICS | Seed 4: ATT = 1.6103, SE = 0.4209, p = 0.00082
 CAT_ALL_PSYCHOTROPICS | Seed 5: ATT = 1.6379, SE = 0.4155, p = 0.00061
 CAT_ALL_PSYCHOTROPICS | Seed 6: ATT = 1.6301, SE = 0.4206, p = 0.00072
 CAT_ALL_PSYCHOTROPICS | Seed 7: ATT = 1.6533, SE = 0.4208, p = 0.00063
 CAT_ALL_PSYCHOTROPICS | Seed 8: ATT = 1.6500, SE = 0.3803, p = 0.00022
 CAT_ALL_PSYCHOTROPICS | Seed 9: ATT = 1.6783, SE = 0.4239, p = 0.00058
 CAT_ALL_PSYCHOTROPICS | Seed 10: ATT = 1.6640, SE = 0.4890, p = 0.00234
 Diagnostic plots saved for CAT_ALL_PSYCHOTROPICS
 Best result for CAT_ALL_PSYCHOTROPICS  Seed 8 | SE = 0.3803

 Running XGBoost for CAT_ALL
 CAT_ALL | Seed 1: ATT = 2.0939, SE = 0.3808, p = &lt; 0.00001
 CAT_ALL | Seed 2: ATT = 2.0753, SE = 0.4938, p = 0.00032
 CAT_ALL | Seed 3: ATT = 2.0863, SE = 0.5517, p = 0.00091
 CAT_ALL | Seed 4: ATT = 2.0797, SE = 0.4805, p = 0.00023
 CAT_ALL | Seed 5: ATT = 2.0804, SE = 0.4467, p = 0.00010
 CAT_ALL | Seed 6: ATT = 2.0702, SE = 0.5665, p = 0.00126
 CAT_ALL | Seed 7: ATT = 2.0836, SE = 0.5123, p = 0.00044
 CAT_ALL | Seed 8: ATT = 2.0713, SE = 0.4302, p = 0.00007
 CAT_ALL | Seed 9: ATT = 2.0930, SE = 0.5186, p = 0.00048
 CAT_ALL | Seed 10: ATT = 2.0448, SE = 0.4792, p = 0.00027
 Diagnostic plots saved for CAT_ALL
 Best result for CAT_ALL  Seed 1 | SE = 0.3808

 All summary files saved.
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=accbc7d0-83ff-4a42-a304-f9cd50f5031b">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[135]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Unweighted:</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=2031c63f-4f0b-4ead-acae-9a083dbea569">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[136]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">GradientBoostingRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">r2_score</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">KFold</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">t</span><span class="p">,</span> <span class="n">probplot</span>
<span class="kn">import</span> <span class="nn">xgboost</span> <span class="k">as</span> <span class="nn">xgb</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Configuration</span>
<span class="c1"># -----------------------------</span>
<span class="n">n_repeats</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">seeds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span>
<span class="n">imputations</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">output_folder</span> <span class="o">=</span> <span class="s2">"outputs"</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Diagnostic Plotting Function</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">create_diagnostic_plots</span><span class="p">(</span><span class="n">residuals_data</span><span class="p">,</span> <span class="n">fitted_data</span><span class="p">,</span> <span class="n">group_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Create 4 diagnostic plots for model validation"""</span>
    <span class="n">plots_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"plots"</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">plots_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Flatten the collected data</span>
    <span class="n">all_residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">residuals_data</span><span class="p">)</span>
    <span class="n">all_fitted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">fitted_data</span><span class="p">)</span>
    
    <span class="c1"># Create figure with 2x2 subplots</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Diagnostic Plots - </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">'bold'</span><span class="p">)</span>
    
    <span class="c1"># 1. Residuals vs Fitted</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">all_fitted</span><span class="p">,</span> <span class="n">all_residuals</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Fitted Values'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Residuals'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Residuals vs Fitted'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># 2. QQ Plot</span>
    <span class="n">probplot</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s2">"norm"</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Q-Q Plot (Normal)'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># 3. Residual Histogram</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'skyblue'</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">'black'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Residuals'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Density'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Residual Distribution'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># 4. Scale-Location Plot</span>
    <span class="n">sqrt_abs_residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">))</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">all_fitted</span><span class="p">,</span> <span class="n">sqrt_abs_residuals</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Fitted Values'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'|Residuals|'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Scale-Location Plot'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    
    <span class="c1"># Save plot</span>
    <span class="n">plot_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plots_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s1">_unweighted.png'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_filename</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">'tight'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Diagnostic plots saved for </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Rubin's Rule</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">rubins_pool</span><span class="p">(</span><span class="n">estimates</span><span class="p">,</span> <span class="n">ses</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">estimates</span><span class="p">)</span>
    <span class="n">q_bar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">estimates</span><span class="p">)</span>
    <span class="n">u_bar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">ses</span><span class="p">))</span>
    <span class="n">b_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">estimates</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">total_var</span> <span class="o">=</span> <span class="n">u_bar</span> <span class="o">+</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">b_m</span><span class="p">)</span>
    <span class="n">total_se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">total_var</span><span class="p">)</span>
    <span class="n">ci_lower</span> <span class="o">=</span> <span class="n">q_bar</span> <span class="o">-</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">total_se</span>
    <span class="n">ci_upper</span> <span class="o">=</span> <span class="n">q_bar</span> <span class="o">+</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">total_se</span>
    <span class="n">p_value</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">q_bar</span> <span class="o">/</span> <span class="n">total_se</span><span class="p">),</span> <span class="n">df</span><span class="o">=</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">rounded_p</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">p_value</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">formatted_p</span> <span class="o">=</span> <span class="s2">"&lt; 0.00001"</span> <span class="k">if</span> <span class="n">rounded_p</span> <span class="o">&lt;=</span> <span class="mf">0.00001</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">rounded_p</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">return</span> <span class="n">q_bar</span><span class="p">,</span> <span class="n">total_se</span><span class="p">,</span> <span class="n">ci_lower</span><span class="p">,</span> <span class="n">ci_upper</span><span class="p">,</span> <span class="n">formatted_p</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># SMD + Variance Ratio</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">calculate_smd_vr</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
    <span class="n">treated</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">control</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">smd</span><span class="p">,</span> <span class="n">vr</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m1</span><span class="p">,</span> <span class="n">m0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">treated</span><span class="p">[</span><span class="n">col</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">control</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
            <span class="n">s1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">treated</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
            <span class="n">s0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">control</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
            <span class="n">pooled_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">s1</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">s0</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">smd</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">m1</span> <span class="o">-</span> <span class="n">m0</span><span class="p">)</span> <span class="o">/</span> <span class="n">pooled_sd</span> <span class="k">if</span> <span class="n">pooled_sd</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">vr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s1</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">s0</span><span class="o">**</span><span class="mi">2</span> <span class="k">if</span> <span class="n">s0</span><span class="o">**</span><span class="mi">2</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">smd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">vr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">smd</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">vr</span><span class="p">)</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># XGBoost Main Loop (No DML)</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">run_xgboost_with_trimmed_data</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="p">):</span>
    <span class="n">att_results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">balance_results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">covariates</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Running XGBoost for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">group_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">group_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">best_result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">best_se</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">"inf"</span><span class="p">)</span>
        
        <span class="c1"># Initialize lists to collect residuals and fitted values for diagnostic plots</span>
        <span class="n">group_residuals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">group_fitted</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="n">seeds</span><span class="p">:</span>
            <span class="n">att_list</span><span class="p">,</span> <span class="n">se_list</span><span class="p">,</span> <span class="n">r2_list</span><span class="p">,</span> <span class="n">rmse_list</span><span class="p">,</span> <span class="n">smd_list</span><span class="p">,</span> <span class="n">vr_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">imp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">imputations</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"trimmed_data_imp</span><span class="si">{</span><span class="n">imp</span><span class="si">}</span><span class="s2">.pkl"</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">or</span> <span class="s2">"iptw"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">T</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
                <span class="n">Y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">"caps5_change_baseline"</span><span class="p">]</span>
                <span class="c1">#W = df["iptw"]</span>

                <span class="k">for</span> <span class="n">repeat</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_repeats</span><span class="p">):</span>
                    <span class="n">kf</span> <span class="o">=</span> <span class="n">KFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span> <span class="o">+</span> <span class="n">repeat</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">train_idx</span><span class="p">,</span> <span class="n">test_idx</span> <span class="ow">in</span> <span class="n">kf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">X_train</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">]</span>
                            <span class="n">T_train</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">]</span>
                            <span class="n">Y_train</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">]</span>
                        

                            <span class="c1"># XGBoost regression model</span>
                            <span class="n">model</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
                            
                            <span class="c1"># Add treatment variable to features</span>
                            <span class="n">X_train_with_T</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                            <span class="n">X_train_with_T</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_train</span>
                            
                            <span class="c1"># Fit model</span>
                            <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_with_T</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">)</span>
                            
                            <span class="c1"># Predict outcomes for treated and control groups</span>
                            <span class="n">X_treated</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                            <span class="n">X_treated</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="n">X_control</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                            <span class="n">X_control</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                            
                            <span class="n">Y_pred_treated</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_treated</span><span class="p">)</span>
                            <span class="n">Y_pred_control</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_control</span><span class="p">)</span>
                            
                            <span class="c1"># Calculate ATT (Average Treatment Effect on Treated)</span>
                            <span class="n">treated_mask</span> <span class="o">=</span> <span class="n">T_train</span> <span class="o">==</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">treated_mask</span><span class="p">):</span>
                                <span class="n">att</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Y_pred_treated</span><span class="p">[</span><span class="n">treated_mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">Y_pred_control</span><span class="p">[</span><span class="n">treated_mask</span><span class="p">])</span>
                                
                                <span class="c1"># Calculate standard error (approximate)</span>
                                <span class="n">treatment_effects</span> <span class="o">=</span> <span class="n">Y_pred_treated</span><span class="p">[</span><span class="n">treated_mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">Y_pred_control</span><span class="p">[</span><span class="n">treated_mask</span><span class="p">]</span>
                                <span class="n">residual</span> <span class="o">=</span> <span class="n">treatment_effects</span> <span class="o">-</span> <span class="n">att</span>
                                <span class="n">se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">residual</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">treated_mask</span><span class="p">)</span>
                                <span class="n">att_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">att</span><span class="p">)</span>
                                <span class="n">se_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">se</span><span class="p">)</span>

                            <span class="c1"># Model performance metrics</span>
                            <span class="n">Y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train_with_T</span><span class="p">)</span>
                            <span class="n">residuals</span> <span class="o">=</span> <span class="n">Y_train</span> <span class="o">-</span> <span class="n">Y_pred</span>
                            <span class="n">rmse</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_pred</span><span class="p">,</span> <span class="n">squared</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                            <span class="n">r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_pred</span><span class="p">)</span>
                            <span class="n">r2_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
                            <span class="n">rmse_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rmse</span><span class="p">)</span>
                            
                            <span class="c1"># Collect residuals and fitted values for diagnostic plots</span>
                            <span class="n">group_residuals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">residuals</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                            <span class="n">group_fitted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Y_pred</span><span class="p">)</span>

                            <span class="n">smd</span><span class="p">,</span> <span class="n">vr</span> <span class="o">=</span> <span class="n">calculate_smd_vr</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">T_train</span><span class="p">)</span>
                            <span class="n">smd_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smd</span><span class="p">)</span>
                            <span class="n">vr_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vr</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">, seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">, imp </span><span class="si">{</span><span class="n">imp</span><span class="si">}</span><span class="s2">, rep </span><span class="si">{</span><span class="n">repeat</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">att_list</span><span class="p">:</span>
                <span class="n">att</span><span class="p">,</span> <span class="n">se</span><span class="p">,</span> <span class="n">ci_l</span><span class="p">,</span> <span class="n">ci_u</span><span class="p">,</span> <span class="n">p_val</span> <span class="o">=</span> <span class="n">rubins_pool</span><span class="p">(</span><span class="n">att_list</span><span class="p">,</span> <span class="n">se_list</span><span class="p">)</span>
                <span class="n">avg_r2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">r2_list</span><span class="p">)</span>
                <span class="n">avg_rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rmse_list</span><span class="p">)</span>
                <span class="n">avg_smd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">smd_list</span><span class="p">)</span>
                <span class="n">avg_vr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">vr_list</span><span class="p">)</span>

                <span class="n">balance_results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">"group"</span><span class="p">:</span> <span class="n">group</span><span class="p">,</span> <span class="s2">"seed"</span><span class="p">:</span> <span class="n">seed</span><span class="p">,</span> <span class="s2">"smd"</span><span class="p">:</span> <span class="n">avg_smd</span><span class="p">,</span> <span class="s2">"vr"</span><span class="p">:</span> <span class="n">avg_vr</span>
                <span class="p">})</span>

                <span class="k">if</span> <span class="n">se</span> <span class="o">&lt;</span> <span class="n">best_se</span><span class="p">:</span>
                    <span class="n">best_se</span> <span class="o">=</span> <span class="n">se</span>
                    <span class="n">best_result</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">"group"</span><span class="p">:</span> <span class="n">group</span><span class="p">,</span> <span class="s2">"seed"</span><span class="p">:</span> <span class="n">seed</span><span class="p">,</span> <span class="s2">"att"</span><span class="p">:</span> <span class="n">att</span><span class="p">,</span> <span class="s2">"se"</span><span class="p">:</span> <span class="n">se</span><span class="p">,</span>
                        <span class="s2">"ci_lower"</span><span class="p">:</span> <span class="n">ci_l</span><span class="p">,</span> <span class="s2">"ci_upper"</span><span class="p">:</span> <span class="n">ci_u</span><span class="p">,</span> <span class="s2">"p_value"</span><span class="p">:</span> <span class="n">p_val</span><span class="p">,</span>
                        <span class="s2">"r2"</span><span class="p">:</span> <span class="n">avg_r2</span><span class="p">,</span> <span class="s2">"rmse"</span><span class="p">:</span> <span class="n">avg_rmse</span>
                    <span class="p">}</span>

                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> | Seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">: ATT = </span><span class="si">{</span><span class="n">att</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, SE = </span><span class="si">{</span><span class="n">se</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, p = </span><span class="si">{</span><span class="n">p_val</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No valid results for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> | Seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Create diagnostic plots for this group</span>
        <span class="k">if</span> <span class="n">group_residuals</span> <span class="ow">and</span> <span class="n">group_fitted</span><span class="p">:</span>
            <span class="n">create_diagnostic_plots</span><span class="p">(</span><span class="n">group_residuals</span><span class="p">,</span> <span class="n">group_fitted</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">best_result</span><span class="p">:</span>
            <span class="n">att_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">best_result</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Best result for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">  Seed </span><span class="si">{</span><span class="n">best_result</span><span class="p">[</span><span class="s1">'seed'</span><span class="p">]</span><span class="si">}</span><span class="s2"> | SE = </span><span class="si">{</span><span class="n">best_result</span><span class="p">[</span><span class="s1">'se'</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="c1"># Save final output</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">att_results</span><span class="p">)</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">"xgb_rubin_summary_cats_unweighted.xlsx"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">balance_results</span><span class="p">)</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">"smd_vr_summary_cats_unweighted.xlsx"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> All summary files saved."</span><span class="p">)</span>

<span class="n">run_xgboost_with_trimmed_data</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Running XGBoost for CAT_ADHD
 CAT_ADHD | Seed 1: ATT = 0.3917, SE = 1.8300, p = 0.83234
 CAT_ADHD | Seed 2: ATT = 0.6429, SE = 1.6017, p = 0.69171
 CAT_ADHD | Seed 3: ATT = 0.4355, SE = 1.4527, p = 0.76695
 CAT_ADHD | Seed 4: ATT = 0.3375, SE = 1.6151, p = 0.83624
 CAT_ADHD | Seed 5: ATT = 0.3827, SE = 1.4431, p = 0.79312
 CAT_ADHD | Seed 6: ATT = 0.5450, SE = 1.3486, p = 0.68972
 CAT_ADHD | Seed 7: ATT = 0.4745, SE = 1.5034, p = 0.75505
 CAT_ADHD | Seed 8: ATT = 0.4960, SE = 1.4371, p = 0.73298
 CAT_ADHD | Seed 9: ATT = 0.4193, SE = 1.2929, p = 0.74853
 CAT_ADHD | Seed 10: ATT = 0.4049, SE = 1.5725, p = 0.79901
 Diagnostic plots saved for CAT_ADHD
 Best result for CAT_ADHD  Seed 9 | SE = 1.2929

 Running XGBoost for CAT_Aceetanilidederivaten
 CAT_Aceetanilidederivaten | Seed 1: ATT = 0.5079, SE = 2.4989, p = 0.84064
 CAT_Aceetanilidederivaten | Seed 2: ATT = 0.5197, SE = 2.7070, p = 0.84938
 CAT_Aceetanilidederivaten | Seed 3: ATT = 0.1977, SE = 2.5870, p = 0.93973
 CAT_Aceetanilidederivaten | Seed 4: ATT = 0.2976, SE = 2.8787, p = 0.91853
 CAT_Aceetanilidederivaten | Seed 5: ATT = 0.2865, SE = 2.2633, p = 0.90032
 CAT_Aceetanilidederivaten | Seed 6: ATT = 0.3165, SE = 2.3146, p = 0.89236
 CAT_Aceetanilidederivaten | Seed 7: ATT = 0.5245, SE = 2.8020, p = 0.85308
 CAT_Aceetanilidederivaten | Seed 8: ATT = -0.0815, SE = 3.1562, p = 0.97961
 CAT_Aceetanilidederivaten | Seed 9: ATT = 0.6130, SE = 2.5515, p = 0.81217
 CAT_Aceetanilidederivaten | Seed 10: ATT = 0.3675, SE = 2.7211, p = 0.89368
 Diagnostic plots saved for CAT_Aceetanilidederivaten
 Best result for CAT_Aceetanilidederivaten  Seed 5 | SE = 2.2633

 Running XGBoost for CAT_Z_drugs
 CAT_Z_drugs | Seed 1: ATT = 1.7026, SE = 2.2622, p = 0.45898
 CAT_Z_drugs | Seed 2: ATT = 1.6228, SE = 2.4578, p = 0.51536
 CAT_Z_drugs | Seed 3: ATT = 1.6112, SE = 2.0481, p = 0.43917
 CAT_Z_drugs | Seed 4: ATT = 1.8127, SE = 2.4403, p = 0.46481
 CAT_Z_drugs | Seed 5: ATT = 1.7725, SE = 2.3572, p = 0.45939
 CAT_Z_drugs | Seed 6: ATT = 1.8918, SE = 2.1084, p = 0.37848
 CAT_Z_drugs | Seed 7: ATT = 1.7999, SE = 2.2659, p = 0.43476
 CAT_Z_drugs | Seed 8: ATT = 1.6591, SE = 2.1059, p = 0.43851
 CAT_Z_drugs | Seed 9: ATT = 1.8434, SE = 2.3393, p = 0.43839
 CAT_Z_drugs | Seed 10: ATT = 1.8718, SE = 2.3672, p = 0.43686
 Diagnostic plots saved for CAT_Z_drugs
 Best result for CAT_Z_drugs  Seed 3 | SE = 2.0481

 Running XGBoost for CAT_Opioden
 CAT_Opioden | Seed 1: ATT = 1.2481, SE = 1.3933, p = 0.37927
 CAT_Opioden | Seed 2: ATT = 1.1118, SE = 1.2019, p = 0.36416
 CAT_Opioden | Seed 3: ATT = 0.8531, SE = 1.2050, p = 0.48575
 CAT_Opioden | Seed 4: ATT = 1.3476, SE = 2.0414, p = 0.51546
 CAT_Opioden | Seed 5: ATT = 1.2285, SE = 1.4606, p = 0.40859
 CAT_Opioden | Seed 6: ATT = 1.0796, SE = 1.2987, p = 0.41400
 CAT_Opioden | Seed 7: ATT = 1.3679, SE = 1.4907, p = 0.36794
 CAT_Opioden | Seed 8: ATT = 1.0536, SE = 1.6159, p = 0.52060
 CAT_Opioden | Seed 9: ATT = 0.9430, SE = 1.3802, p = 0.50101
 CAT_Opioden | Seed 10: ATT = 1.2302, SE = 1.5568, p = 0.43715
 Diagnostic plots saved for CAT_Opioden
 Best result for CAT_Opioden  Seed 2 | SE = 1.2019

 Running XGBoost for CAT_NSAIDs
 CAT_NSAIDs | Seed 1: ATT = 1.1089, SE = 2.2675, p = 0.62926
 CAT_NSAIDs | Seed 2: ATT = 1.0503, SE = 2.2178, p = 0.64009
 CAT_NSAIDs | Seed 3: ATT = 0.9823, SE = 2.4492, p = 0.69194
 CAT_NSAIDs | Seed 4: ATT = 1.1218, SE = 2.2172, p = 0.61750
 CAT_NSAIDs | Seed 5: ATT = 0.9849, SE = 2.2420, p = 0.66440
 CAT_NSAIDs | Seed 6: ATT = 1.1108, SE = 2.4764, p = 0.65779
 CAT_NSAIDs | Seed 7: ATT = 0.8450, SE = 1.7732, p = 0.63802
 CAT_NSAIDs | Seed 8: ATT = 1.0164, SE = 2.0788, p = 0.62931
 CAT_NSAIDs | Seed 9: ATT = 0.9091, SE = 2.3862, p = 0.70656
 CAT_NSAIDs | Seed 10: ATT = 1.1424, SE = 2.3609, p = 0.63284
 Diagnostic plots saved for CAT_NSAIDs
 Best result for CAT_NSAIDs  Seed 7 | SE = 1.7732

 Running XGBoost for CAT_Benzodiazepine
 CAT_Benzodiazepine | Seed 1: ATT = 0.2874, SE = 0.4001, p = 0.47960
 CAT_Benzodiazepine | Seed 2: ATT = 0.3413, SE = 0.3859, p = 0.38523
 CAT_Benzodiazepine | Seed 3: ATT = 0.2947, SE = 0.3020, p = 0.33879
 CAT_Benzodiazepine | Seed 4: ATT = 0.2725, SE = 0.4353, p = 0.53723
 CAT_Benzodiazepine | Seed 5: ATT = 0.2924, SE = 0.3228, p = 0.37405
 CAT_Benzodiazepine | Seed 6: ATT = 0.3149, SE = 0.3626, p = 0.39386
 CAT_Benzodiazepine | Seed 7: ATT = 0.2418, SE = 0.3579, p = 0.50577
 CAT_Benzodiazepine | Seed 8: ATT = 0.3192, SE = 0.3472, p = 0.36702
 CAT_Benzodiazepine | Seed 9: ATT = 0.2812, SE = 0.3176, p = 0.38478
 CAT_Benzodiazepine | Seed 10: ATT = 0.2873, SE = 0.3197, p = 0.37784
 Diagnostic plots saved for CAT_Benzodiazepine
 Best result for CAT_Benzodiazepine  Seed 3 | SE = 0.3020

 Running XGBoost for CAT_Antihypertensiva
 CAT_Antihypertensiva | Seed 1: ATT = -0.4378, SE = 1.0469, p = 0.67950
 CAT_Antihypertensiva | Seed 2: ATT = -0.3604, SE = 0.9420, p = 0.70539
 CAT_Antihypertensiva | Seed 3: ATT = -0.4735, SE = 1.3834, p = 0.73512
 CAT_Antihypertensiva | Seed 4: ATT = -0.2201, SE = 1.3770, p = 0.87436
 CAT_Antihypertensiva | Seed 5: ATT = -0.1620, SE = 1.3015, p = 0.90199
 CAT_Antihypertensiva | Seed 6: ATT = -0.2753, SE = 1.0425, p = 0.79399
 CAT_Antihypertensiva | Seed 7: ATT = -0.1325, SE = 1.1126, p = 0.90621
 CAT_Antihypertensiva | Seed 8: ATT = -0.2809, SE = 1.6194, p = 0.86376
 CAT_Antihypertensiva | Seed 9: ATT = -0.2064, SE = 1.2223, p = 0.86730
 CAT_Antihypertensiva | Seed 10: ATT = -0.3280, SE = 1.0503, p = 0.75754
 Diagnostic plots saved for CAT_Antihypertensiva
 Best result for CAT_Antihypertensiva  Seed 2 | SE = 0.9420

 Running XGBoost for CAT_Antihistaminica
 CAT_Antihistaminica | Seed 1: ATT = 1.4831, SE = 1.0287, p = 0.16231
 CAT_Antihistaminica | Seed 2: ATT = 1.4511, SE = 1.4784, p = 0.33610
 CAT_Antihistaminica | Seed 3: ATT = 1.3902, SE = 1.3364, p = 0.30860
 CAT_Antihistaminica | Seed 4: ATT = 1.4573, SE = 1.2330, p = 0.24883
 CAT_Antihistaminica | Seed 5: ATT = 1.3652, SE = 1.2001, p = 0.26651
 CAT_Antihistaminica | Seed 6: ATT = 1.4958, SE = 1.4863, p = 0.32427
 CAT_Antihistaminica | Seed 7: ATT = 1.4814, SE = 1.6825, p = 0.38734
 CAT_Antihistaminica | Seed 8: ATT = 1.3965, SE = 1.3559, p = 0.31331
 CAT_Antihistaminica | Seed 9: ATT = 1.5152, SE = 1.2253, p = 0.22821
 CAT_Antihistaminica | Seed 10: ATT = 1.4705, SE = 1.4614, p = 0.32435
 Diagnostic plots saved for CAT_Antihistaminica
 Best result for CAT_Antihistaminica  Seed 1 | SE = 1.0287

 Running XGBoost for CAT_Anti_epileptica
 CAT_Anti_epileptica | Seed 1: ATT = 1.6849, SE = 1.9045, p = 0.38510
 CAT_Anti_epileptica | Seed 2: ATT = 1.7863, SE = 1.8199, p = 0.33612
 CAT_Anti_epileptica | Seed 3: ATT = 1.7945, SE = 1.8073, p = 0.33067
 CAT_Anti_epileptica | Seed 4: ATT = 1.6692, SE = 1.7199, p = 0.34147
 CAT_Anti_epileptica | Seed 5: ATT = 1.7242, SE = 1.7980, p = 0.34716
 CAT_Anti_epileptica | Seed 6: ATT = 1.8372, SE = 1.6760, p = 0.28387
 CAT_Anti_epileptica | Seed 7: ATT = 1.9840, SE = 2.0670, p = 0.34671
 CAT_Anti_epileptica | Seed 8: ATT = 1.7428, SE = 1.7737, p = 0.33560
 CAT_Anti_epileptica | Seed 9: ATT = 1.9905, SE = 1.8378, p = 0.28953
 CAT_Anti_epileptica | Seed 10: ATT = 1.7232, SE = 1.8876, p = 0.37037
 Diagnostic plots saved for CAT_Anti_epileptica
 Best result for CAT_Anti_epileptica  Seed 6 | SE = 1.6760

 Running XGBoost for CAT_Antidepressiva
 CAT_Antidepressiva | Seed 1: ATT = 0.7568, SE = 0.3792, p = 0.05745
 CAT_Antidepressiva | Seed 2: ATT = 0.7308, SE = 0.3272, p = 0.03512
 CAT_Antidepressiva | Seed 3: ATT = 0.7725, SE = 0.4167, p = 0.07608
 CAT_Antidepressiva | Seed 4: ATT = 0.7389, SE = 0.3549, p = 0.04815
 CAT_Antidepressiva | Seed 5: ATT = 0.7625, SE = 0.3006, p = 0.01813
 CAT_Antidepressiva | Seed 6: ATT = 0.7398, SE = 0.3271, p = 0.03307
 CAT_Antidepressiva | Seed 7: ATT = 0.7272, SE = 0.3529, p = 0.05038
 CAT_Antidepressiva | Seed 8: ATT = 0.6963, SE = 0.2607, p = 0.01337
 CAT_Antidepressiva | Seed 9: ATT = 0.7450, SE = 0.3754, p = 0.05876
 CAT_Antidepressiva | Seed 10: ATT = 0.7477, SE = 0.3748, p = 0.05754
 Diagnostic plots saved for CAT_Antidepressiva
 Best result for CAT_Antidepressiva  Seed 8 | SE = 0.2607

 Running XGBoost for CAT_Antipsychotica
 CAT_Antipsychotica | Seed 1: ATT = 1.2444, SE = 0.7484, p = 0.10938
 CAT_Antipsychotica | Seed 2: ATT = 1.2182, SE = 0.6761, p = 0.08414
 CAT_Antipsychotica | Seed 3: ATT = 1.2274, SE = 0.5713, p = 0.04199
 CAT_Antipsychotica | Seed 4: ATT = 1.2174, SE = 0.9075, p = 0.19231
 CAT_Antipsychotica | Seed 5: ATT = 1.2026, SE = 0.5683, p = 0.04489
 CAT_Antipsychotica | Seed 6: ATT = 1.0961, SE = 0.4211, p = 0.01560
 CAT_Antipsychotica | Seed 7: ATT = 1.1863, SE = 0.6015, p = 0.06023
 CAT_Antipsychotica | Seed 8: ATT = 1.2331, SE = 0.5813, p = 0.04441
 CAT_Antipsychotica | Seed 9: ATT = 1.1750, SE = 0.6405, p = 0.07902
 CAT_Antipsychotica | Seed 10: ATT = 1.1732, SE = 0.5268, p = 0.03559
 Diagnostic plots saved for CAT_Antipsychotica
 Best result for CAT_Antipsychotica  Seed 6 | SE = 0.4211

 Running XGBoost for CAT_ALL_PSYCHOTROPICS_EXCL_BENZO
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 1: ATT = 1.0629, SE = 0.3872, p = 0.01128
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 2: ATT = 1.0278, SE = 0.3735, p = 0.01110
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 3: ATT = 1.0330, SE = 0.3892, p = 0.01389
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 4: ATT = 1.0671, SE = 0.4124, p = 0.01616
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 5: ATT = 1.0459, SE = 0.3690, p = 0.00916
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 6: ATT = 1.0315, SE = 0.4380, p = 0.02705
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 7: ATT = 1.0519, SE = 0.3404, p = 0.00500
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 8: ATT = 1.0356, SE = 0.4173, p = 0.02048
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 9: ATT = 1.0792, SE = 0.4222, p = 0.01734
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 10: ATT = 1.0720, SE = 0.4035, p = 0.01380
 Diagnostic plots saved for CAT_ALL_PSYCHOTROPICS_EXCL_BENZO
 Best result for CAT_ALL_PSYCHOTROPICS_EXCL_BENZO  Seed 7 | SE = 0.3404

 Running XGBoost for CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 1: ATT = 0.8251, SE = 0.3131, p = 0.01449
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 2: ATT = 0.8714, SE = 0.3872, p = 0.03383
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 3: ATT = 0.8360, SE = 0.3444, p = 0.02307
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 4: ATT = 0.8316, SE = 0.2252, p = 0.00114
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 5: ATT = 0.8457, SE = 0.3758, p = 0.03388
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 6: ATT = 0.8528, SE = 0.3710, p = 0.03055
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 7: ATT = 0.8364, SE = 0.2987, p = 0.00992
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 8: ATT = 0.8347, SE = 0.2482, p = 0.00258
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 9: ATT = 0.8368, SE = 0.3680, p = 0.03221
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 10: ATT = 0.8658, SE = 0.3816, p = 0.03255
 Diagnostic plots saved for CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS
 Best result for CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS  Seed 4 | SE = 0.2252

 Running XGBoost for CAT_ALL_PSYCHOTROPICS
 CAT_ALL_PSYCHOTROPICS | Seed 1: ATT = 1.5842, SE = 0.3769, p = 0.00031
 CAT_ALL_PSYCHOTROPICS | Seed 2: ATT = 1.5893, SE = 0.4113, p = 0.00074
 CAT_ALL_PSYCHOTROPICS | Seed 3: ATT = 1.6036, SE = 0.4042, p = 0.00057
 CAT_ALL_PSYCHOTROPICS | Seed 4: ATT = 1.5857, SE = 0.3313, p = 0.00007
 CAT_ALL_PSYCHOTROPICS | Seed 5: ATT = 1.6003, SE = 0.4233, p = 0.00092
 CAT_ALL_PSYCHOTROPICS | Seed 6: ATT = 1.5562, SE = 0.3206, p = 0.00006
 CAT_ALL_PSYCHOTROPICS | Seed 7: ATT = 1.5912, SE = 0.3861, p = 0.00039
 CAT_ALL_PSYCHOTROPICS | Seed 8: ATT = 1.6229, SE = 0.3508, p = 0.00011
 CAT_ALL_PSYCHOTROPICS | Seed 9: ATT = 1.5746, SE = 0.3534, p = 0.00017
 CAT_ALL_PSYCHOTROPICS | Seed 10: ATT = 1.6034, SE = 0.3459, p = 0.00010
 Diagnostic plots saved for CAT_ALL_PSYCHOTROPICS
 Best result for CAT_ALL_PSYCHOTROPICS  Seed 6 | SE = 0.3206

 Running XGBoost for CAT_ALL
 CAT_ALL | Seed 1: ATT = 2.0414, SE = 0.2589, p = &lt; 0.00001
 CAT_ALL | Seed 2: ATT = 2.0530, SE = 0.3257, p = &lt; 0.00001
 CAT_ALL | Seed 3: ATT = 2.0554, SE = 0.3898, p = 0.00002
 CAT_ALL | Seed 4: ATT = 2.0605, SE = 0.4100, p = 0.00004
 CAT_ALL | Seed 5: ATT = 2.0588, SE = 0.2623, p = &lt; 0.00001
 CAT_ALL | Seed 6: ATT = 2.0694, SE = 0.4013, p = 0.00003
 CAT_ALL | Seed 7: ATT = 2.0709, SE = 0.3551, p = &lt; 0.00001
 CAT_ALL | Seed 8: ATT = 2.0459, SE = 0.3626, p = &lt; 0.00001
 CAT_ALL | Seed 9: ATT = 2.0890, SE = 0.3036, p = &lt; 0.00001
 CAT_ALL | Seed 10: ATT = 2.0531, SE = 0.2924, p = &lt; 0.00001
 Diagnostic plots saved for CAT_ALL
 Best result for CAT_ALL  Seed 1 | SE = 0.2589

 All summary files saved.
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=09f4c13c-ac14-4dfc-aa7a-e7ec6d3a5f1f">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[137]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">sem</span><span class="p">,</span> <span class="n">ttest_ind</span>

<span class="c1"># ----------------------------------</span>
<span class="c1"># File paths</span>
<span class="c1"># ----------------------------------</span>
<span class="n">output_base</span> <span class="o">=</span> <span class="s2">"outputs"</span>
<span class="n">att_file</span> <span class="o">=</span> <span class="s2">"xgb_rubin_summary_cats.xlsx"</span>
<span class="n">trimmed_file</span> <span class="o">=</span> <span class="s2">"trimmed_data_imp1.pkl"</span>
<span class="n">auc_file</span> <span class="o">=</span> <span class="s2">"auc_scores.xlsx"</span>  <span class="c1"># NEW</span>

<span class="c1"># ----------------------------------</span>
<span class="c1"># Load ATT Summary</span>
<span class="c1"># ----------------------------------</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">att_file</span><span class="p">):</span>
    <span class="n">att_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">att_file</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">" ATT summary file not found: xgb_rubin_summary_cats.xlsx"</span><span class="p">)</span>

<span class="n">summary_rows</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># ----------------------------------</span>
<span class="c1"># Loop over medication groups</span>
<span class="c1"># ----------------------------------</span>
<span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">medication_groups</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">g</span><span class="p">))]</span>

<span class="k">for</span> <span class="n">med</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">group_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">med</span><span class="p">)</span>

        <span class="c1"># Load trimmed data</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="n">trimmed_file</span><span class="p">))</span>

        <span class="c1"># Detect treatment column</span>
        <span class="n">treatment_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">med</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">treatment_cols</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Treatment column </span><span class="si">{</span><span class="n">med</span><span class="si">}</span><span class="s2"> not found in trimmed data. Skipping."</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">treatment_var</span> <span class="o">=</span> <span class="n">treatment_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Extract treatment and outcome</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">"caps5_change_baseline"</span><span class="p">]</span>

        <span class="c1"># Treated and control stats</span>
        <span class="n">treated</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">control</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>

        <span class="n">mean_treat</span> <span class="o">=</span> <span class="n">treated</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">se_treat</span> <span class="o">=</span> <span class="n">sem</span><span class="p">(</span><span class="n">treated</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">treated</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">mean_ctrl</span> <span class="o">=</span> <span class="n">control</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">se_ctrl</span> <span class="o">=</span> <span class="n">sem</span><span class="p">(</span><span class="n">control</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">control</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Cohen's d (unadjusted)</span>
        <span class="n">pooled_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">treated</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">control</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">cohen_d</span> <span class="o">=</span> <span class="p">(</span><span class="n">mean_treat</span> <span class="o">-</span> <span class="n">mean_ctrl</span><span class="p">)</span> <span class="o">/</span> <span class="n">pooled_sd</span> <span class="k">if</span> <span class="n">pooled_sd</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># E-value (unadjusted)</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">mean_treat</span> <span class="o">-</span> <span class="n">mean_ctrl</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">delta</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">mean_ctrl</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">mean_ctrl</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Unadjusted p-value</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">t_stat</span><span class="p">,</span> <span class="n">p_val</span> <span class="o">=</span> <span class="n">ttest_ind</span><span class="p">(</span><span class="n">treated</span><span class="p">,</span> <span class="n">control</span><span class="p">,</span> <span class="n">equal_var</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nan_policy</span><span class="o">=</span><span class="s2">"omit"</span><span class="p">)</span>
            <span class="n">rounded_p</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">p_val</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="n">formatted_p</span> <span class="o">=</span> <span class="s2">"&lt; 0.00001"</span> <span class="k">if</span> <span class="n">rounded_p</span> <span class="o">&lt;</span> <span class="mf">0.00001</span> <span class="k">else</span> <span class="n">rounded_p</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">formatted_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># AUC from new auc_scores.xlsx file</span>
        <span class="n">auc_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">auc_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="n">auc_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">auc_path</span><span class="p">):</span>
            <span class="n">auc_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">auc_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">"AUC"</span> <span class="ow">in</span> <span class="n">auc_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">auc_val</span> <span class="o">=</span> <span class="n">auc_df</span><span class="p">[</span><span class="s2">"AUC"</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="c1"># Adjusted stats from Rubin summary</span>
        <span class="n">att_row</span> <span class="o">=</span> <span class="n">att_df</span><span class="p">[</span><span class="n">att_df</span><span class="p">[</span><span class="s2">"group"</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">med</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">att_row</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">att</span> <span class="o">=</span> <span class="n">att_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"att"</span><span class="p">]</span>
            <span class="n">att_se</span> <span class="o">=</span> <span class="n">att_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"se"</span><span class="p">]</span>
            <span class="n">att_p_val</span> <span class="o">=</span> <span class="n">att_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"p_value"</span><span class="p">]</span>
            <span class="n">r2</span> <span class="o">=</span> <span class="n">att_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"r2"</span><span class="p">]</span>
            <span class="n">rmse</span> <span class="o">=</span> <span class="n">att_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"rmse"</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">rounded_att_p</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">att_p_val</span><span class="p">),</span> <span class="mi">5</span><span class="p">)</span>
                <span class="n">formatted_att_p</span> <span class="o">=</span> <span class="s2">"&lt; 0.00001"</span> <span class="k">if</span> <span class="n">rounded_att_p</span> <span class="o">&lt;</span> <span class="mf">0.00001</span> <span class="k">else</span> <span class="n">rounded_att_p</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">formatted_att_p</span> <span class="o">=</span> <span class="n">att_p_val</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">att</span><span class="p">,</span> <span class="n">att_se</span><span class="p">,</span> <span class="n">formatted_att_p</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Append full row</span>
        <span class="n">summary_rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">'Medication Group'</span><span class="p">:</span> <span class="n">med</span><span class="p">,</span>
            <span class="s1">'Mean Treated'</span><span class="p">:</span> <span class="n">mean_treat</span><span class="p">,</span>
            <span class="s1">'SE Treated'</span><span class="p">:</span> <span class="n">se_treat</span><span class="p">,</span>
            <span class="s1">'Mean Control'</span><span class="p">:</span> <span class="n">mean_ctrl</span><span class="p">,</span>
            <span class="s1">'SE Control'</span><span class="p">:</span> <span class="n">se_ctrl</span><span class="p">,</span>
            <span class="s1">'Cohen d'</span><span class="p">:</span> <span class="n">cohen_d</span><span class="p">,</span>
            <span class="s1">'E (Unadjusted)'</span><span class="p">:</span> <span class="n">E</span><span class="p">,</span>
            <span class="s1">'n Treated'</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">treated</span><span class="p">),</span>
            <span class="s1">'n Control'</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">control</span><span class="p">),</span>
            <span class="c1">#'Unadjusted p-value': formatted_p,</span>
            <span class="s1">'ATT Estimate'</span><span class="p">:</span> <span class="n">att</span><span class="p">,</span>
            <span class="s1">'ATT SE (Robust)'</span><span class="p">:</span> <span class="n">att_se</span><span class="p">,</span>
            <span class="s1">'ATT p-value'</span><span class="p">:</span> <span class="n">formatted_att_p</span><span class="p">,</span>
            <span class="s1">'R'</span><span class="p">:</span> <span class="n">r2</span><span class="p">,</span>
            <span class="s1">'RMSE'</span><span class="p">:</span> <span class="n">rmse</span><span class="p">,</span>
            <span class="s1">'AUC'</span><span class="p">:</span> <span class="n">auc_val</span>
        <span class="p">})</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error in </span><span class="si">{</span><span class="n">med</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># ----------------------------------</span>
<span class="c1"># Save final summary</span>
<span class="c1"># ----------------------------------</span>
<span class="n">summary_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">summary_rows</span><span class="p">)</span>
<span class="n">summary_df</span> <span class="o">=</span> <span class="n">summary_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">"Medication Group"</span><span class="p">)</span>
<span class="n">summary_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">"Final_ATT_Summary_Cat.xlsx"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">" Final_ATT_Summary_Cat saved"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre> Final_ATT_Summary_Cat saved
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=2add3f46-01e8-4fac-b63c-cb913efd7755">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[138]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.backends.backend_pdf</span> <span class="kn">import</span> <span class="n">PdfPages</span>

<span class="c1">#  Load the final summary table</span>
<span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s2">"Final_ATT_Summary_Cat.xlsx"</span><span class="p">)</span>

<span class="c1">#  Parse DML p-values (handle "&lt; 0.00001")</span>
<span class="k">def</span> <span class="nf">parse_pval</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">"&lt;"</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.000001</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

<span class="n">final_df</span><span class="p">[</span><span class="s1">'ATT p-value'</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="s1">'ATT p-value'</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">parse_pval</span><span class="p">)</span>

<span class="c1">#  Plot settings</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>

<span class="c1">#  Plotting function for a single medication group</span>
<span class="k">def</span> <span class="nf">plot_single_group</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    
    <span class="n">bars1</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="o">-</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">'Mean Control'</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> 
                   <span class="n">yerr</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">'SE Control'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">'Control'</span><span class="p">,</span> <span class="n">hatch</span><span class="o">=</span><span class="s1">'//'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">bars2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="o">+</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">'Mean Treated'</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> 
                   <span class="n">yerr</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">'SE Treated'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">'Treated'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'steelblue'</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

    <span class="n">label</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">"ATT = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'ATT Estimate'</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span>
        <span class="sa">f</span><span class="s2">"d = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'Cohen d'</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, p = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'ATT p-value'</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span>
        <span class="sa">f</span><span class="s2">"nT = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'n Treated'</span><span class="p">]</span><span class="si">}</span><span class="s2">, nC = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'n Control'</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span>
        <span class="sa">f</span><span class="s2">"E = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'E (Unadjusted)'</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%"</span>
    <span class="p">)</span>
    <span class="n">max_y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">'Mean Control'</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">'Mean Treated'</span><span class="p">])</span> <span class="o">+</span> <span class="mf">1.5</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_y</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">'center'</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">'bottom'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'#FFD700'</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'black'</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="o">-</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">+</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">'Control'</span><span class="p">,</span> <span class="s1">'Treated'</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Group: </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'Medication Group'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">'bold'</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"CAPS5 Change Score"</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="n">max_y</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">fig</span>

<span class="c1">#  Generate and save all plots into a multi-page PDF</span>
<span class="k">with</span> <span class="n">PdfPages</span><span class="p">(</span><span class="s2">"xgb_att_barplot_cat.pdf"</span><span class="p">)</span> <span class="k">as</span> <span class="n">pdf</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">final_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_single_group</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="n">pdf</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">'tight'</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">" xgb_att_barplot_cat saved"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre> xgb_att_barplot_cat saved
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=7c7dd2a6-210a-47e3-adc8-15a9d93cfd82">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[139]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Love plot:</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=bd5ab6a2-6ea7-4e7c-bb94-cf40cd9c330d">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[140]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="c1"># ----------------------------------------</span>
<span class="c1"># Functions to calculate balance</span>
<span class="c1"># ----------------------------------------</span>
<span class="k">def</span> <span class="nf">calculate_smd</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">w1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">w2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">weighted_mean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span> <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">weighted_var</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">m</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
    
    <span class="n">m1</span> <span class="o">=</span> <span class="n">weighted_mean</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">w1</span><span class="p">)</span> <span class="k">if</span> <span class="n">w1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
    <span class="n">m2</span> <span class="o">=</span> <span class="n">weighted_mean</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span> <span class="k">if</span> <span class="n">w2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">weighted_var</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">w1</span><span class="p">)</span> <span class="k">if</span> <span class="n">w1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">weighted_var</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span> <span class="k">if</span> <span class="n">w2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">pooled_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">v1</span> <span class="o">+</span> <span class="n">v2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">m1</span> <span class="o">-</span> <span class="n">m2</span><span class="p">)</span> <span class="o">/</span> <span class="n">pooled_sd</span> <span class="k">if</span> <span class="n">pooled_sd</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">variance_ratio</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">w1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">w2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">weighted_var</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">m</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
    
    <span class="n">v1</span> <span class="o">=</span> <span class="n">weighted_var</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">w1</span><span class="p">)</span> <span class="k">if</span> <span class="n">w1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">weighted_var</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span> <span class="k">if</span> <span class="n">w2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">v1</span> <span class="o">/</span> <span class="n">v2</span><span class="p">,</span> <span class="n">v2</span> <span class="o">/</span> <span class="n">v1</span><span class="p">)</span> <span class="k">if</span> <span class="n">v1</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">v2</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>

<span class="c1"># ----------------------------------------</span>
<span class="c1"># Setup</span>
<span class="c1"># ----------------------------------------</span>
<span class="n">output_base</span> <span class="o">=</span> <span class="s2">"outputs"</span>
<span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">output_base</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">g</span><span class="p">))]</span>

<span class="c1"># Create a case-insensitive mapping</span>
<span class="n">final_covariates_map_lower</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="c1"># ----------------------------------------</span>
<span class="c1"># Main Loop</span>
<span class="c1"># ----------------------------------------</span>
<span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">group</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_covariates_map_lower</span><span class="p">:</span>
        <span class="k">continue</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Processing </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">..."</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">group_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">covariates</span> <span class="o">=</span> <span class="n">final_covariates_map_lower</span><span class="p">[</span><span class="n">group</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        
        <span class="n">column_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="s2">"trimmed_data_imp1.pkl"</span><span class="p">))</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">group</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">column_name</span> <span class="o">=</span> <span class="n">col</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">column_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Column not found for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">, skipping."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">smd_unw_all</span><span class="p">,</span> <span class="n">smd_w_all</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">vr_unw_all</span><span class="p">,</span> <span class="n">vr_w_all</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
            <span class="n">df_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"trimmed_data_imp</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.pkl"</span><span class="p">)</span>
            <span class="n">iptw_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="s2">"iptw_weights.xlsx"</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">df_path</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">iptw_path</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Missing data for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> imp</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, skipping."</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">df_path</span><span class="p">)</span>
            <span class="n">iptw_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">iptw_path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span>
            <span class="n">W</span> <span class="o">=</span> <span class="n">iptw_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s2">"iptw_mean"</span><span class="p">]</span>

            <span class="n">smd_unw_i</span><span class="p">,</span> <span class="n">smd_w_i</span><span class="p">,</span> <span class="n">vr_unw_i</span><span class="p">,</span> <span class="n">vr_w_i</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">cov</span> <span class="ow">in</span> <span class="n">covariates</span><span class="p">:</span>
                <span class="n">x1</span><span class="p">,</span> <span class="n">x0</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cov</span><span class="p">],</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cov</span><span class="p">]</span>
                <span class="n">w1</span><span class="p">,</span> <span class="n">w0</span> <span class="o">=</span> <span class="n">W</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">],</span> <span class="n">W</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>

                <span class="n">su</span> <span class="o">=</span> <span class="n">calculate_smd</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x0</span><span class="p">)</span>
                <span class="n">sw</span> <span class="o">=</span> <span class="n">calculate_smd</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">w0</span><span class="p">)</span>

                <span class="n">vu</span> <span class="o">=</span> <span class="n">variance_ratio</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x0</span><span class="p">)</span> <span class="k">if</span> <span class="n">cov</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">]</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">vw</span> <span class="o">=</span> <span class="n">variance_ratio</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">w0</span><span class="p">)</span> <span class="k">if</span> <span class="n">cov</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">]</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

                <span class="n">smd_unw_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">su</span><span class="p">)</span>
                <span class="n">smd_w_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sw</span><span class="p">)</span>
                <span class="n">vr_unw_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vu</span><span class="p">)</span>
                <span class="n">vr_w_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vw</span><span class="p">)</span>

            <span class="n">smd_unw_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smd_unw_i</span><span class="p">)</span>
            <span class="n">smd_w_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smd_w_i</span><span class="p">)</span>
            <span class="n">vr_unw_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vr_unw_i</span><span class="p">)</span>
            <span class="n">vr_w_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vr_w_i</span><span class="p">)</span>

        <span class="n">smd_unw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">smd_unw_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">smd_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">smd_w_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">vr_unw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">vr_unw_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">vr_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">vr_w_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">severity</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sw</span> <span class="ow">in</span> <span class="n">smd_w</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sw</span> <span class="o">&lt;=</span> <span class="mf">0.1</span><span class="p">:</span>
                <span class="n">severity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"Good"</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">sw</span> <span class="o">&lt;=</span> <span class="mf">0.2</span><span class="p">:</span>
                <span class="n">severity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"Moderate"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">severity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"Poor"</span><span class="p">)</span>

        <span class="n">covariate_names</span> <span class="o">=</span> <span class="n">covariates</span>
        <span class="n">numeric_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s2">"Covariate"</span><span class="p">:</span> <span class="n">covariate_names</span><span class="p">,</span>
            <span class="s2">"SMD_Unweighted"</span><span class="p">:</span> <span class="n">smd_unw</span><span class="p">,</span>
            <span class="s2">"SMD_Weighted"</span><span class="p">:</span> <span class="n">smd_w</span><span class="p">,</span>
            <span class="s2">"Imbalance_Severity"</span><span class="p">:</span> <span class="n">severity</span><span class="p">,</span>
            <span class="s2">"VR_Unweighted"</span><span class="p">:</span> <span class="n">vr_unw</span><span class="p">,</span>
            <span class="s2">"VR_Weighted"</span><span class="p">:</span> <span class="n">vr_w</span>
        <span class="p">})</span>

        <span class="n">numeric_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"covariate_balance_table_</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">.xlsx"</span><span class="p">)</span>
        <span class="n">numeric_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">numeric_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Exported numeric summary to: </span><span class="si">{</span><span class="n">numeric_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># -------------------------</span>
        <span class="c1"># Plot</span>
        <span class="c1"># -------------------------</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">covariates</span>
        <span class="n">y_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.45</span><span class="p">))</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">smd_unw</span><span class="p">,</span> <span class="n">y_pos</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Unweighted"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">smd_w</span><span class="p">,</span> <span class="n">y_pos</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'blue'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Weighted"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Threshold 0.1"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'black'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Threshold 0.2"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">smd_unw</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">smd_w</span><span class="p">),</span> <span class="mf">0.25</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">y_pos</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Standardized Mean Differences (SMD)"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">"upper right"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">vr_mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">cov</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">]</span> <span class="k">for</span> <span class="n">cov</span> <span class="ow">in</span> <span class="n">covariates</span><span class="p">]</span>
        <span class="n">filtered_y</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vr_mask</span><span class="p">)</span> <span class="k">if</span> <span class="n">b</span><span class="p">]</span>
        <span class="n">filtered_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">filtered_y</span><span class="p">]</span>
        <span class="n">filtered_vr_unw</span> <span class="o">=</span> <span class="p">[</span><span class="n">vr_unw</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">filtered_y</span><span class="p">]</span>
        <span class="n">filtered_vr_w</span> <span class="o">=</span> <span class="p">[</span><span class="n">vr_w</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">filtered_y</span><span class="p">]</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">filtered_vr_unw</span><span class="p">,</span> <span class="n">filtered_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'blue'</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">'o'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Unweighted"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">filtered_vr_w</span><span class="p">,</span> <span class="n">filtered_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">'x'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Weighted"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">filtered_vr_unw</span> <span class="o">+</span> <span class="n">filtered_vr_w</span> <span class="o">+</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">])</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">filtered_y</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">filtered_labels</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Variance Ratio (VR)"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Covariate Balance for </span><span class="si">{</span><span class="n">group</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'CAT_'</span><span class="p">,</span><span class="w"> </span><span class="s1">''</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">'bold'</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.96</span><span class="p">])</span>
        <span class="n">plot_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"love_plot_</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">.pdf"</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Saved love plot: </span><span class="si">{</span><span class="n">plot_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Max weighted SMD for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">smd_w</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Processing CAT_Aceetanilidederivaten...
 Exported numeric summary to: outputs\CAT_Aceetanilidederivaten\covariate_balance_table_CAT_Aceetanilidederivaten.xlsx
 Saved love plot: outputs\CAT_Aceetanilidederivaten\love_plot_CAT_Aceetanilidederivaten.pdf
 Max weighted SMD for CAT_Aceetanilidederivaten: 0.478

 Processing CAT_Adhd...
 Exported numeric summary to: outputs\CAT_Adhd\covariate_balance_table_CAT_Adhd.xlsx
 Saved love plot: outputs\CAT_Adhd\love_plot_CAT_Adhd.pdf
 Max weighted SMD for CAT_Adhd: 0.390

 Processing CAT_All...
 Exported numeric summary to: outputs\CAT_All\covariate_balance_table_CAT_All.xlsx
 Saved love plot: outputs\CAT_All\love_plot_CAT_All.pdf
 Max weighted SMD for CAT_All: 0.235

 Processing CAT_All_Psychotropics...
 Exported numeric summary to: outputs\CAT_All_Psychotropics\covariate_balance_table_CAT_All_Psychotropics.xlsx
 Saved love plot: outputs\CAT_All_Psychotropics\love_plot_CAT_All_Psychotropics.pdf
 Max weighted SMD for CAT_All_Psychotropics: 0.207

 Processing CAT_All_Psychotropics_Excl_Benzo...
 Exported numeric summary to: outputs\CAT_All_Psychotropics_Excl_Benzo\covariate_balance_table_CAT_All_Psychotropics_Excl_Benzo.xlsx
 Saved love plot: outputs\CAT_All_Psychotropics_Excl_Benzo\love_plot_CAT_All_Psychotropics_Excl_Benzo.pdf
 Max weighted SMD for CAT_All_Psychotropics_Excl_Benzo: 0.194

 Processing CAT_All_Psychotropics_Excl_Sedatives_Hypnotics...
 Exported numeric summary to: outputs\CAT_All_Psychotropics_Excl_Sedatives_Hypnotics\covariate_balance_table_CAT_All_Psychotropics_Excl_Sedatives_Hypnotics.xlsx
 Saved love plot: outputs\CAT_All_Psychotropics_Excl_Sedatives_Hypnotics\love_plot_CAT_All_Psychotropics_Excl_Sedatives_Hypnotics.pdf
 Max weighted SMD for CAT_All_Psychotropics_Excl_Sedatives_Hypnotics: 0.207

 Processing CAT_Antidepressiva...
 Exported numeric summary to: outputs\CAT_Antidepressiva\covariate_balance_table_CAT_Antidepressiva.xlsx
 Saved love plot: outputs\CAT_Antidepressiva\love_plot_CAT_Antidepressiva.pdf
 Max weighted SMD for CAT_Antidepressiva: 0.131

 Processing CAT_Antihistaminica...
 Exported numeric summary to: outputs\CAT_Antihistaminica\covariate_balance_table_CAT_Antihistaminica.xlsx
 Saved love plot: outputs\CAT_Antihistaminica\love_plot_CAT_Antihistaminica.pdf
 Max weighted SMD for CAT_Antihistaminica: 0.385

 Processing CAT_Antihypertensiva...
 Exported numeric summary to: outputs\CAT_Antihypertensiva\covariate_balance_table_CAT_Antihypertensiva.xlsx
 Saved love plot: outputs\CAT_Antihypertensiva\love_plot_CAT_Antihypertensiva.pdf
 Max weighted SMD for CAT_Antihypertensiva: 0.325

 Processing CAT_Antipsychotica...
 Exported numeric summary to: outputs\CAT_Antipsychotica\covariate_balance_table_CAT_Antipsychotica.xlsx
 Saved love plot: outputs\CAT_Antipsychotica\love_plot_CAT_Antipsychotica.pdf
 Max weighted SMD for CAT_Antipsychotica: 0.237

 Processing CAT_Anti_Epileptica...
 Exported numeric summary to: outputs\CAT_Anti_Epileptica\covariate_balance_table_CAT_Anti_Epileptica.xlsx
 Saved love plot: outputs\CAT_Anti_Epileptica\love_plot_CAT_Anti_Epileptica.pdf
 Max weighted SMD for CAT_Anti_Epileptica: 0.382

 Processing CAT_Benzodiazepine...
 Exported numeric summary to: outputs\CAT_Benzodiazepine\covariate_balance_table_CAT_Benzodiazepine.xlsx
 Saved love plot: outputs\CAT_Benzodiazepine\love_plot_CAT_Benzodiazepine.pdf
 Max weighted SMD for CAT_Benzodiazepine: 0.185

 Processing CAT_Nsaids...
 Exported numeric summary to: outputs\CAT_Nsaids\covariate_balance_table_CAT_Nsaids.xlsx
 Saved love plot: outputs\CAT_Nsaids\love_plot_CAT_Nsaids.pdf
 Max weighted SMD for CAT_Nsaids: 0.351

 Processing CAT_Opioden...
 Exported numeric summary to: outputs\CAT_Opioden\covariate_balance_table_CAT_Opioden.xlsx
 Saved love plot: outputs\CAT_Opioden\love_plot_CAT_Opioden.pdf
 Max weighted SMD for CAT_Opioden: 0.325

 Processing CAT_Z_Drugs...
 Exported numeric summary to: outputs\CAT_Z_Drugs\covariate_balance_table_CAT_Z_Drugs.xlsx
 Saved love plot: outputs\CAT_Z_Drugs\love_plot_CAT_Z_Drugs.pdf
 Max weighted SMD for CAT_Z_Drugs: 0.376
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=1cedeed7-7c10-422b-b58e-81e03e632ac7">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[141]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Heatmap:</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=99056fbb-3bd6-44b0-beed-753f79181a6f">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[142]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="c1">#-----------------------------</span>
<span class="c1"># Generate heatmaps</span>
<span class="c1"># -------------------------------</span>
<span class="k">for</span> <span class="n">treatment_var</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">========== Creating Heatmap for </span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s2"> =========="</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">'outputs'</span><span class="p">,</span> <span class="n">treatment_var</span><span class="p">)</span>
        <span class="n">balance_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'covariate_balance_table_</span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s1">.xlsx'</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">balance_path</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Balance file not found: </span><span class="si">{</span><span class="n">balance_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">balance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">balance_path</span><span class="p">)</span>

        <span class="c1">#  Use finalized covariates + 'Propensity Score'</span>
        <span class="n">covariates</span> <span class="o">=</span> <span class="n">final_covariates_map</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">'Propensity Score'</span><span class="p">]</span>
        <span class="n">balance_df</span> <span class="o">=</span> <span class="n">balance_df</span><span class="p">[</span><span class="n">balance_df</span><span class="p">[</span><span class="s1">'Covariate'</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">covariates</span><span class="p">)]</span>

        <span class="c1">#  Check for CAPS5score_baseline</span>
        <span class="n">highlight_caps</span> <span class="o">=</span> <span class="s1">'CAPS5score_baseline'</span> <span class="ow">in</span> <span class="n">balance_df</span><span class="p">[</span><span class="s1">'Covariate'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="c1">#  Format for heatmap</span>
        <span class="n">heatmap_df</span> <span class="o">=</span> <span class="n">balance_df</span><span class="p">[[</span><span class="s1">'Covariate'</span><span class="p">,</span> <span class="s1">'SMD_Unweighted'</span><span class="p">,</span> <span class="s1">'SMD_Weighted'</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">heatmap_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'Covariate'</span><span class="p">,</span> <span class="s1">'Unweighted'</span><span class="p">,</span> <span class="s1">'Weighted'</span><span class="p">]</span>
        <span class="n">heatmap_df</span> <span class="o">=</span> <span class="n">heatmap_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">'Covariate'</span><span class="p">)</span>
        <span class="n">heatmap_df</span> <span class="o">=</span> <span class="n">heatmap_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">'Unweighted'</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1">#  Plot</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">heatmap_df</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.35</span><span class="p">)))</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span>
            <span class="n">heatmap_df</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="s2">"coolwarm"</span><span class="p">,</span>
            <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">fmt</span><span class="o">=</span><span class="s2">".2f"</span><span class="p">,</span>
            <span class="n">linewidths</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
            <span class="n">linecolor</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span>
            <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">"label"</span><span class="p">:</span> <span class="s2">"Standardized Mean Difference"</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Covariate Balance Heatmap (Rubin IPTW)</span><span class="se">\n</span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">'bold'</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Condition"</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"Covariate"</span><span class="p">)</span>

        <span class="c1">#  Bold CAPS5score_baseline if present</span>
        <span class="k">if</span> <span class="n">highlight_caps</span><span class="p">:</span>
            <span class="n">ylabels</span> <span class="o">=</span> <span class="p">[</span><span class="n">label</span><span class="o">.</span><span class="n">get_text</span><span class="p">()</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span>
                <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2"> "</span> <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="s1">'CAPS5score_baseline'</span> <span class="k">else</span> <span class="n">label</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ylabels</span>
            <span class="p">])</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="c1">#  Save image</span>
        <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'heatmap_smd_</span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s1">.png'</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Heatmap saved: </span><span class="si">{</span><span class="n">save_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error processing </span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
========== Creating Heatmap for CAT_ADHD ==========
 Heatmap saved: outputs\CAT_ADHD\heatmap_smd_CAT_ADHD.png

========== Creating Heatmap for CAT_Aceetanilidederivaten ==========
 Heatmap saved: outputs\CAT_Aceetanilidederivaten\heatmap_smd_CAT_Aceetanilidederivaten.png

========== Creating Heatmap for CAT_Z_drugs ==========
 Heatmap saved: outputs\CAT_Z_drugs\heatmap_smd_CAT_Z_drugs.png

========== Creating Heatmap for CAT_Opioden ==========
 Heatmap saved: outputs\CAT_Opioden\heatmap_smd_CAT_Opioden.png

========== Creating Heatmap for CAT_NSAIDs ==========
 Heatmap saved: outputs\CAT_NSAIDs\heatmap_smd_CAT_NSAIDs.png

========== Creating Heatmap for CAT_Benzodiazepine ==========
 Heatmap saved: outputs\CAT_Benzodiazepine\heatmap_smd_CAT_Benzodiazepine.png

========== Creating Heatmap for CAT_Antihypertensiva ==========
 Heatmap saved: outputs\CAT_Antihypertensiva\heatmap_smd_CAT_Antihypertensiva.png

========== Creating Heatmap for CAT_Antihistaminica ==========
 Heatmap saved: outputs\CAT_Antihistaminica\heatmap_smd_CAT_Antihistaminica.png

========== Creating Heatmap for CAT_Anti_epileptica ==========
 Heatmap saved: outputs\CAT_Anti_epileptica\heatmap_smd_CAT_Anti_epileptica.png

========== Creating Heatmap for CAT_Antidepressiva ==========
 Heatmap saved: outputs\CAT_Antidepressiva\heatmap_smd_CAT_Antidepressiva.png

========== Creating Heatmap for CAT_Antipsychotica ==========
 Heatmap saved: outputs\CAT_Antipsychotica\heatmap_smd_CAT_Antipsychotica.png

========== Creating Heatmap for CAT_ALL_PSYCHOTROPICS_EXCL_BENZO ==========
 Heatmap saved: outputs\CAT_ALL_PSYCHOTROPICS_EXCL_BENZO\heatmap_smd_CAT_ALL_PSYCHOTROPICS_EXCL_BENZO.png

========== Creating Heatmap for CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS ==========
 Heatmap saved: outputs\CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS\heatmap_smd_CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS.png

========== Creating Heatmap for CAT_ALL_PSYCHOTROPICS ==========
 Heatmap saved: outputs\CAT_ALL_PSYCHOTROPICS\heatmap_smd_CAT_ALL_PSYCHOTROPICS.png

========== Creating Heatmap for CAT_ALL ==========
 Heatmap saved: outputs\CAT_ALL\heatmap_smd_CAT_ALL.png
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=c2ecb610-b6bb-4639-9b1b-ff658d37153c">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="Subcat-analysis:">Subcat analysis:<a class="anchor-link" href="#Subcat-analysis:"></a></h2>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=71e55b3a-f46c-4df7-bc09-7d346c53e2a6">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[143]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">covariates_SUBCAT_Antipsychotica_atypisch</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span> <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SUBCAT_TCA</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SUBCAT_SSRI</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SUBCAT_SNRI</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_SUBCAT_Tetracyclische_antidepressiva</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SUBCAT_Antidepressiva_overige</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SUBCAT_Systemische_antihistaminica</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span> <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_SUBCAT_anxiolytica_Benzodiazepine</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SUBCAT_hypnotica_Benzodiazepine</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_SUBCAT_Amfetaminen</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span> <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span>
    <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_SUBCAT_Paracetamol_mono</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span> <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_SUBCAT_Anti_epileptica_stemmingsstabilisatoren</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span> 
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SUBCAT_Opioden</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SUBCAT_Z_drugs</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span> <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SUBCAT_NSAIDs</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=9a3ef609-2a60-4e10-8983-dadb6790f337">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[144]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="c1"># This finds all variables that start with covariates_SUBCAT_</span>
<span class="n">final_covariates_map</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<span class="n">final_covariates_map</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
    <span class="n">var</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"covariates_"</span><span class="p">,</span> <span class="s2">""</span><span class="p">):</span> <span class="n">val</span>
    <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"covariates_subcat_"</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
<span class="p">})</span>

<span class="c1"># Show detected group names</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Groups found:"</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
<span class="n">medication_groups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">medication_groups</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Groups found: ['SUBCAT_Antipsychotica_atypisch', 'SUBCAT_TCA', 'SUBCAT_SSRI', 'SUBCAT_SNRI', 'SUBCAT_Tetracyclische_antidepressiva', 'SUBCAT_Antidepressiva_overige', 'SUBCAT_Systemische_antihistaminica', 'SUBCAT_anxiolytica_Benzodiazepine', 'SUBCAT_hypnotica_Benzodiazepine', 'SUBCAT_Amfetaminen', 'SUBCAT_Paracetamol_mono', 'SUBCAT_Anti_epileptica_stemmingsstabilisatoren', 'SUBCAT_Opioden', 'SUBCAT_Z_drugs', 'SUBCAT_NSAIDs']
['SUBCAT_Antipsychotica_atypisch', 'SUBCAT_TCA', 'SUBCAT_SSRI', 'SUBCAT_SNRI', 'SUBCAT_Tetracyclische_antidepressiva', 'SUBCAT_Antidepressiva_overige', 'SUBCAT_Systemische_antihistaminica', 'SUBCAT_anxiolytica_Benzodiazepine', 'SUBCAT_hypnotica_Benzodiazepine', 'SUBCAT_Amfetaminen', 'SUBCAT_Paracetamol_mono', 'SUBCAT_Anti_epileptica_stemmingsstabilisatoren', 'SUBCAT_Opioden', 'SUBCAT_Z_drugs', 'SUBCAT_NSAIDs']
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=e8784a01-10be-41b1-aa30-a516788adbaf">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[145]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>


<span class="k">def</span> <span class="nf">run_all_SUBCAT_group_models</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Runs downstream analysis for each SUBCAT medisubcation group using imputed datasets.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - imputed_dfs: list of 5 imputed DataFrames (from df_imputed_final_imp1.pkl ... imp5.pkl)</span>
<span class="sd">    </span>
<span class="sd">    Notes:</span>
<span class="sd">    - Covariate lists must be defined as global variables: covariates_subcat_&lt;group&gt;</span>
<span class="sd">    - Outputs are saved in: outputs/SUBCAT_&lt;GROUP&gt;/</span>
<span class="sd">    """</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">" Starting analysis for all SUBCAT groups"</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">var_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"covariates_subcat_"</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">globals</span><span class="p">()[</span><span class="n">var_name</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">group_name</span> <span class="o">=</span> <span class="n">var_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"covariates_"</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
            <span class="n">group_name</span> <span class="o">=</span> <span class="n">group_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"_"</span><span class="p">,</span> <span class="s2">" "</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">" "</span><span class="p">,</span> <span class="s2">"_"</span><span class="p">)</span>  <span class="c1"># e.g., subcat_z_drugs  Subcat_Z_Drugs</span>
            <span class="n">group_name</span> <span class="o">=</span> <span class="n">group_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"Subcat_"</span><span class="p">,</span> <span class="s2">"SUBCAT_"</span><span class="p">)</span>  <span class="c1"># force prefix to uppercase</span>

            <span class="n">covariates</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()[</span><span class="n">var_name</span><span class="p">]</span>
            <span class="n">output_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"outputs/</span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">"</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Processing </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">..."</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">df_imp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   Using imputation </span><span class="si">{</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

                <span class="c1"># Define X and Y</span>
                <span class="n">X</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span>
                <span class="n">Y</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="s2">"caps5_change_baseline"</span><span class="p">]</span>

                <span class="c1"># === Save X and Y as placeholder (replace with modeling later)</span>
                <span class="n">X</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/X_imp</span><span class="si">{</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.csv"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">Y</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"Y"</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/Y_imp</span><span class="si">{</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.csv"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Done: </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> All SUBCAT group analyses complete."</span><span class="p">)</span>

<span class="c1"># ========= STEP 4: Execute ========= #</span>
<span class="n">run_all_SUBCAT_group_models</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre> Starting analysis for all SUBCAT groups

 Processing SUBCAT_Antipsychotica_Atypisch...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBCAT_Antipsychotica_Atypisch

 Processing SUBCAT_Tca...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBCAT_Tca

 Processing SUBCAT_Ssri...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBCAT_Ssri

 Processing SUBCAT_Snri...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBCAT_Snri

 Processing SUBCAT_Tetracyclische_Antidepressiva...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBCAT_Tetracyclische_Antidepressiva

 Processing SUBCAT_Antidepressiva_Overige...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBCAT_Antidepressiva_Overige

 Processing SUBCAT_Systemische_Antihistaminica...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBCAT_Systemische_Antihistaminica

 Processing SUBCAT_Anxiolytica_Benzodiazepine...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBCAT_Anxiolytica_Benzodiazepine

 Processing SUBCAT_Hypnotica_Benzodiazepine...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBCAT_Hypnotica_Benzodiazepine

 Processing SUBCAT_Amfetaminen...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBCAT_Amfetaminen

 Processing SUBCAT_Paracetamol_Mono...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBCAT_Paracetamol_Mono

 Processing SUBCAT_Anti_Epileptica_Stemmingsstabilisatoren...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBCAT_Anti_Epileptica_Stemmingsstabilisatoren

 Processing SUBCAT_Opioden...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBCAT_Opioden

 Processing SUBCAT_Z_Drugs...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBCAT_Z_Drugs

 Processing SUBCAT_Nsaids...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBCAT_Nsaids

 All SUBCAT group analyses complete.
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=e6669c45-1195-4268-9001-4ddc425cc580">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[146]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">treatment_var</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">treatment_var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Imp </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">:  Not found in columns."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">treated</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">control</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Imp </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: Treated = </span><span class="si">{</span><span class="n">treated</span><span class="si">}</span><span class="s2">, Control = </span><span class="si">{</span><span class="n">control</span><span class="si">}</span><span class="s2">, Missing = </span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 SUBCAT_Antipsychotica_atypisch
  Imp 1: Treated = 256, Control = 3385, Missing = 0
  Imp 2: Treated = 256, Control = 3385, Missing = 0
  Imp 3: Treated = 256, Control = 3385, Missing = 0
  Imp 4: Treated = 256, Control = 3385, Missing = 0
  Imp 5: Treated = 256, Control = 3385, Missing = 0

 SUBCAT_TCA
  Imp 1: Treated = 86, Control = 3555, Missing = 0
  Imp 2: Treated = 86, Control = 3555, Missing = 0
  Imp 3: Treated = 86, Control = 3555, Missing = 0
  Imp 4: Treated = 86, Control = 3555, Missing = 0
  Imp 5: Treated = 86, Control = 3555, Missing = 0

 SUBCAT_SSRI
  Imp 1: Treated = 396, Control = 3245, Missing = 0
  Imp 2: Treated = 396, Control = 3245, Missing = 0
  Imp 3: Treated = 396, Control = 3245, Missing = 0
  Imp 4: Treated = 396, Control = 3245, Missing = 0
  Imp 5: Treated = 396, Control = 3245, Missing = 0

 SUBCAT_SNRI
  Imp 1: Treated = 82, Control = 3559, Missing = 0
  Imp 2: Treated = 82, Control = 3559, Missing = 0
  Imp 3: Treated = 82, Control = 3559, Missing = 0
  Imp 4: Treated = 82, Control = 3559, Missing = 0
  Imp 5: Treated = 82, Control = 3559, Missing = 0

 SUBCAT_Tetracyclische_antidepressiva
  Imp 1: Treated = 87, Control = 3554, Missing = 0
  Imp 2: Treated = 87, Control = 3554, Missing = 0
  Imp 3: Treated = 87, Control = 3554, Missing = 0
  Imp 4: Treated = 87, Control = 3554, Missing = 0
  Imp 5: Treated = 87, Control = 3554, Missing = 0

 SUBCAT_Antidepressiva_overige
  Imp 1: Treated = 42, Control = 3599, Missing = 0
  Imp 2: Treated = 42, Control = 3599, Missing = 0
  Imp 3: Treated = 42, Control = 3599, Missing = 0
  Imp 4: Treated = 42, Control = 3599, Missing = 0
  Imp 5: Treated = 42, Control = 3599, Missing = 0

 SUBCAT_Systemische_antihistaminica
  Imp 1: Treated = 56, Control = 3585, Missing = 0
  Imp 2: Treated = 56, Control = 3585, Missing = 0
  Imp 3: Treated = 56, Control = 3585, Missing = 0
  Imp 4: Treated = 56, Control = 3585, Missing = 0
  Imp 5: Treated = 56, Control = 3585, Missing = 0

 SUBCAT_anxiolytica_Benzodiazepine
  Imp 1: Treated = 311, Control = 3330, Missing = 0
  Imp 2: Treated = 311, Control = 3330, Missing = 0
  Imp 3: Treated = 311, Control = 3330, Missing = 0
  Imp 4: Treated = 311, Control = 3330, Missing = 0
  Imp 5: Treated = 311, Control = 3330, Missing = 0

 SUBCAT_hypnotica_Benzodiazepine
  Imp 1: Treated = 132, Control = 3509, Missing = 0
  Imp 2: Treated = 132, Control = 3509, Missing = 0
  Imp 3: Treated = 132, Control = 3509, Missing = 0
  Imp 4: Treated = 132, Control = 3509, Missing = 0
  Imp 5: Treated = 132, Control = 3509, Missing = 0

 SUBCAT_Amfetaminen
  Imp 1: Treated = 52, Control = 3589, Missing = 0
  Imp 2: Treated = 52, Control = 3589, Missing = 0
  Imp 3: Treated = 52, Control = 3589, Missing = 0
  Imp 4: Treated = 52, Control = 3589, Missing = 0
  Imp 5: Treated = 52, Control = 3589, Missing = 0

 SUBCAT_Paracetamol_mono
  Imp 1: Treated = 43, Control = 3598, Missing = 0
  Imp 2: Treated = 43, Control = 3598, Missing = 0
  Imp 3: Treated = 43, Control = 3598, Missing = 0
  Imp 4: Treated = 43, Control = 3598, Missing = 0
  Imp 5: Treated = 43, Control = 3598, Missing = 0

 SUBCAT_Anti_epileptica_stemmingsstabilisatoren
  Imp 1: Treated = 57, Control = 3584, Missing = 0
  Imp 2: Treated = 57, Control = 3584, Missing = 0
  Imp 3: Treated = 57, Control = 3584, Missing = 0
  Imp 4: Treated = 57, Control = 3584, Missing = 0
  Imp 5: Treated = 57, Control = 3584, Missing = 0

 SUBCAT_Opioden
  Imp 1: Treated = 54, Control = 3587, Missing = 0
  Imp 2: Treated = 54, Control = 3587, Missing = 0
  Imp 3: Treated = 54, Control = 3587, Missing = 0
  Imp 4: Treated = 54, Control = 3587, Missing = 0
  Imp 5: Treated = 54, Control = 3587, Missing = 0

 SUBCAT_Z_drugs
  Imp 1: Treated = 57, Control = 3584, Missing = 0
  Imp 2: Treated = 57, Control = 3584, Missing = 0
  Imp 3: Treated = 57, Control = 3584, Missing = 0
  Imp 4: Treated = 57, Control = 3584, Missing = 0
  Imp 5: Treated = 57, Control = 3584, Missing = 0

 SUBCAT_NSAIDs
  Imp 1: Treated = 37, Control = 3604, Missing = 0
  Imp 2: Treated = 37, Control = 3604, Missing = 0
  Imp 3: Treated = 37, Control = 3604, Missing = 0
  Imp 4: Treated = 37, Control = 3604, Missing = 0
  Imp 5: Treated = 37, Control = 3604, Missing = 0
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=62728b25-f7b4-4303-b783-3813f0bc25f5">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[147]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">from</span> <span class="nn">statsmodels.stats.outliers_influence</span> <span class="kn">import</span> <span class="n">variance_inflation_factor</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="c1">#  VIF computation function</span>
<span class="k">def</span> <span class="nf">compute_vif</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">has_constant</span><span class="o">=</span><span class="s1">'add'</span><span class="p">)</span>
    <span class="n">vif_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">vif_df</span><span class="p">[</span><span class="s2">"variable"</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span>
    <span class="n">vif_df</span><span class="p">[</span><span class="s2">"VIF"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">variance_inflation_factor</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
    <span class="k">return</span> <span class="n">vif_df</span>

<span class="c1">#  Process each group</span>
<span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Processing VIF for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  No covariates found for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
        <span class="k">continue</span>

    <span class="n">covariates</span> <span class="o">=</span> <span class="n">final_covariates_map</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
    <span class="n">vif_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df_imp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">vif_df</span> <span class="o">=</span> <span class="n">compute_vif</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="n">vif_df</span><span class="p">[</span><span class="s2">"imputation"</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">vif_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vif_df</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"    Failed on imputation </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">vif_list</span><span class="p">:</span>
        <span class="n">all_vif</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">vif_list</span><span class="p">)</span>
        <span class="n">pooled_vif</span> <span class="o">=</span> <span class="n">all_vif</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">"variable"</span><span class="p">)[</span><span class="s2">"VIF"</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">pooled_vif</span> <span class="o">=</span> <span class="n">pooled_vif</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">"VIF"</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"outputs"</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">pooled_vif</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"pooled_vif.csv"</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Saved: </span><span class="si">{</span><span class="n">output_folder</span><span class="si">}</span><span class="s2">/pooled_vif.csv"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Skipped </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: No valid imputations."</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Processing VIF for SUBCAT_Antipsychotica_atypisch
  Saved: outputs\SUBCAT_Antipsychotica_atypisch/pooled_vif.csv

 Processing VIF for SUBCAT_TCA
  Saved: outputs\SUBCAT_TCA/pooled_vif.csv

 Processing VIF for SUBCAT_SSRI
  Saved: outputs\SUBCAT_SSRI/pooled_vif.csv

 Processing VIF for SUBCAT_SNRI
  Saved: outputs\SUBCAT_SNRI/pooled_vif.csv

 Processing VIF for SUBCAT_Tetracyclische_antidepressiva
  Saved: outputs\SUBCAT_Tetracyclische_antidepressiva/pooled_vif.csv

 Processing VIF for SUBCAT_Antidepressiva_overige
  Saved: outputs\SUBCAT_Antidepressiva_overige/pooled_vif.csv

 Processing VIF for SUBCAT_Systemische_antihistaminica
  Saved: outputs\SUBCAT_Systemische_antihistaminica/pooled_vif.csv

 Processing VIF for SUBCAT_anxiolytica_Benzodiazepine
  Saved: outputs\SUBCAT_anxiolytica_Benzodiazepine/pooled_vif.csv

 Processing VIF for SUBCAT_hypnotica_Benzodiazepine
  Saved: outputs\SUBCAT_hypnotica_Benzodiazepine/pooled_vif.csv

 Processing VIF for SUBCAT_Amfetaminen
  Saved: outputs\SUBCAT_Amfetaminen/pooled_vif.csv

 Processing VIF for SUBCAT_Paracetamol_mono
  Saved: outputs\SUBCAT_Paracetamol_mono/pooled_vif.csv

 Processing VIF for SUBCAT_Anti_epileptica_stemmingsstabilisatoren
  Saved: outputs\SUBCAT_Anti_epileptica_stemmingsstabilisatoren/pooled_vif.csv

 Processing VIF for SUBCAT_Opioden
  Saved: outputs\SUBCAT_Opioden/pooled_vif.csv

 Processing VIF for SUBCAT_Z_drugs
  Saved: outputs\SUBCAT_Z_drugs/pooled_vif.csv

 Processing VIF for SUBCAT_NSAIDs
  Saved: outputs\SUBCAT_NSAIDs/pooled_vif.csv
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=00a3aec7-90b0-4160-b2eb-4e97e633bfb9">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[148]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">xgboost</span> <span class="kn">import</span> <span class="n">XGBClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">roc_curve</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>

<span class="c1"># ---------- PS Estimation Function ----------</span>
<span class="k">def</span> <span class="nf">run_xgboost_ps_modeling</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Running PS estimation for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No covariates found for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"outputs"</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">covariates</span> <span class="o">=</span> <span class="n">final_covariates_map</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
        <span class="n">ps_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">auc_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df_imp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_imp</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> not found in imputed dataset </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">X</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>

            <span class="c1"># Drop missing treatment rows</span>
            <span class="n">valid_idx</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">index</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>

            <span class="c1"># Train-test split for ROC</span>
            <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">T_train</span><span class="p">,</span> <span class="n">T_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
                <span class="n">X</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
            <span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">XGBClassifier</span><span class="p">(</span><span class="n">use_label_encoder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eval_metric</span><span class="o">=</span><span class="s1">'logloss'</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
                <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">T_train</span><span class="p">)</span>

                <span class="n">ps_scores</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">ps_matrix</span><span class="p">[</span><span class="sa">f</span><span class="s2">"ps_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">ps_scores</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">valid_idx</span><span class="p">)</span>

                <span class="c1"># ROC &amp; AUC</span>
                <span class="n">auc</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">T_test</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">auc_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">auc</span><span class="p">)</span>

                <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">T_test</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">"AUC = </span><span class="si">{</span><span class="n">auc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'k--'</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"False Positive Rate"</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"True Positive Rate"</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"ROC Curve - </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> (Imp </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">)"</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"roc_curve_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.png"</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   Imp </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: AUC = </span><span class="si">{</span><span class="n">auc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, ROC saved."</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> (imp </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Save AUCs and Composite PS</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ps_matrix</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="c1"># Fill NaN rows (from dropped subjects in some imputations) with mean</span>
            <span class="n">ps_matrix</span><span class="p">[</span><span class="s2">"composite_ps"</span><span class="p">]</span> <span class="o">=</span> <span class="n">ps_matrix</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ps_matrix</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"propensity_scores.xlsx"</span><span class="p">))</span>

            <span class="n">auc_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s2">"imputation"</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">"imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">auc_list</span><span class="p">))],</span>
                <span class="s2">"AUC"</span><span class="p">:</span> <span class="n">auc_list</span>
            <span class="p">})</span>
            <span class="n">auc_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">auc_df</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"mean"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">auc_list</span><span class="p">)</span> <span class="k">if</span> <span class="n">auc_list</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span>
            <span class="n">auc_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"auc_scores.xlsx"</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Composite PS + AUC saved for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No valid PS scores generated for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># ---------- Run ----------</span>
<span class="n">run_xgboost_ps_modeling</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre> Running PS estimation for SUBCAT_Antipsychotica_atypisch
   Imp 1: AUC = 0.998, ROC saved.
   Imp 2: AUC = 0.998, ROC saved.
   Imp 3: AUC = 0.998, ROC saved.
   Imp 4: AUC = 0.998, ROC saved.
   Imp 5: AUC = 0.998, ROC saved.
 Composite PS + AUC saved for SUBCAT_Antipsychotica_atypisch
 Running PS estimation for SUBCAT_TCA
   Imp 1: AUC = 0.575, ROC saved.
   Imp 2: AUC = 0.579, ROC saved.
   Imp 3: AUC = 0.579, ROC saved.
   Imp 4: AUC = 0.608, ROC saved.
   Imp 5: AUC = 0.571, ROC saved.
 Composite PS + AUC saved for SUBCAT_TCA
 Running PS estimation for SUBCAT_SSRI
   Imp 1: AUC = 0.641, ROC saved.
   Imp 2: AUC = 0.658, ROC saved.
   Imp 3: AUC = 0.644, ROC saved.
   Imp 4: AUC = 0.631, ROC saved.
   Imp 5: AUC = 0.653, ROC saved.
 Composite PS + AUC saved for SUBCAT_SSRI
 Running PS estimation for SUBCAT_SNRI
   Imp 1: AUC = 0.689, ROC saved.
   Imp 2: AUC = 0.638, ROC saved.
   Imp 3: AUC = 0.640, ROC saved.
   Imp 4: AUC = 0.655, ROC saved.
   Imp 5: AUC = 0.641, ROC saved.
 Composite PS + AUC saved for SUBCAT_SNRI
 Running PS estimation for SUBCAT_Tetracyclische_antidepressiva
   Imp 1: AUC = 0.581, ROC saved.
   Imp 2: AUC = 0.538, ROC saved.
   Imp 3: AUC = 0.569, ROC saved.
   Imp 4: AUC = 0.577, ROC saved.
   Imp 5: AUC = 0.623, ROC saved.
 Composite PS + AUC saved for SUBCAT_Tetracyclische_antidepressiva
 Running PS estimation for SUBCAT_Antidepressiva_overige
   Imp 1: AUC = 0.439, ROC saved.
   Imp 2: AUC = 0.438, ROC saved.
   Imp 3: AUC = 0.503, ROC saved.
   Imp 4: AUC = 0.523, ROC saved.
   Imp 5: AUC = 0.487, ROC saved.
 Composite PS + AUC saved for SUBCAT_Antidepressiva_overige
 Running PS estimation for SUBCAT_Systemische_antihistaminica
   Imp 1: AUC = 0.637, ROC saved.
   Imp 2: AUC = 0.646, ROC saved.
   Imp 3: AUC = 0.614, ROC saved.
   Imp 4: AUC = 0.639, ROC saved.
   Imp 5: AUC = 0.647, ROC saved.
 Composite PS + AUC saved for SUBCAT_Systemische_antihistaminica
 Running PS estimation for SUBCAT_anxiolytica_Benzodiazepine
   Imp 1: AUC = 0.708, ROC saved.
   Imp 2: AUC = 0.708, ROC saved.
   Imp 3: AUC = 0.708, ROC saved.
   Imp 4: AUC = 0.705, ROC saved.
   Imp 5: AUC = 0.703, ROC saved.
 Composite PS + AUC saved for SUBCAT_anxiolytica_Benzodiazepine
 Running PS estimation for SUBCAT_hypnotica_Benzodiazepine
   Imp 1: AUC = 0.603, ROC saved.
   Imp 2: AUC = 0.577, ROC saved.
   Imp 3: AUC = 0.604, ROC saved.
   Imp 4: AUC = 0.583, ROC saved.
   Imp 5: AUC = 0.634, ROC saved.
 Composite PS + AUC saved for SUBCAT_hypnotica_Benzodiazepine
 Running PS estimation for SUBCAT_Amfetaminen
   Imp 1: AUC = 0.530, ROC saved.
   Imp 2: AUC = 0.554, ROC saved.
   Imp 3: AUC = 0.556, ROC saved.
   Imp 4: AUC = 0.562, ROC saved.
   Imp 5: AUC = 0.488, ROC saved.
 Composite PS + AUC saved for SUBCAT_Amfetaminen
 Running PS estimation for SUBCAT_Paracetamol_mono
   Imp 1: AUC = 0.599, ROC saved.
   Imp 2: AUC = 0.609, ROC saved.
   Imp 3: AUC = 0.625, ROC saved.
   Imp 4: AUC = 0.658, ROC saved.
   Imp 5: AUC = 0.664, ROC saved.
 Composite PS + AUC saved for SUBCAT_Paracetamol_mono
 Running PS estimation for SUBCAT_Anti_epileptica_stemmingsstabilisatoren
   Imp 1: AUC = 0.687, ROC saved.
   Imp 2: AUC = 0.683, ROC saved.
   Imp 3: AUC = 0.697, ROC saved.
   Imp 4: AUC = 0.686, ROC saved.
   Imp 5: AUC = 0.688, ROC saved.
 Composite PS + AUC saved for SUBCAT_Anti_epileptica_stemmingsstabilisatoren
 Running PS estimation for SUBCAT_Opioden
   Imp 1: AUC = 0.660, ROC saved.
   Imp 2: AUC = 0.676, ROC saved.
   Imp 3: AUC = 0.694, ROC saved.
   Imp 4: AUC = 0.665, ROC saved.
   Imp 5: AUC = 0.635, ROC saved.
 Composite PS + AUC saved for SUBCAT_Opioden
 Running PS estimation for SUBCAT_Z_drugs
   Imp 1: AUC = 0.599, ROC saved.
   Imp 2: AUC = 0.651, ROC saved.
   Imp 3: AUC = 0.591, ROC saved.
   Imp 4: AUC = 0.573, ROC saved.
   Imp 5: AUC = 0.588, ROC saved.
 Composite PS + AUC saved for SUBCAT_Z_drugs
 Running PS estimation for SUBCAT_NSAIDs
   Imp 1: AUC = 0.537, ROC saved.
   Imp 2: AUC = 0.554, ROC saved.
   Imp 3: AUC = 0.615, ROC saved.
   Imp 4: AUC = 0.612, ROC saved.
   Imp 5: AUC = 0.608, ROC saved.
 Composite PS + AUC saved for SUBCAT_NSAIDs
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=6c350b8e-70f1-4c4d-bfa4-8963d6f2e7f2">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[149]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">xgboost</span> <span class="kn">import</span> <span class="n">XGBClassifier</span>

<span class="k">def</span> <span class="nf">compute_feature_importance</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Computing feature importance for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No covariates found for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">covariates</span> <span class="o">=</span> <span class="n">final_covariates_map</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
        <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"outputs"</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">importance_df_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df_imp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_imp</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> not in imputed dataset </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">X</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>

            <span class="c1"># Drop NaNs in treatment</span>
            <span class="n">valid_idx</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">index</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">XGBClassifier</span><span class="p">(</span><span class="n">use_label_encoder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eval_metric</span><span class="o">=</span><span class="s1">'logloss'</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
                <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>

                <span class="c1"># Get feature importance</span>
                <span class="n">importances</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_booster</span><span class="p">()</span><span class="o">.</span><span class="n">get_score</span><span class="p">(</span><span class="n">importance_type</span><span class="o">=</span><span class="s1">'gain'</span><span class="p">)</span>
                <span class="n">df_feat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">importances</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">'index'</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">"imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">])</span>
                <span class="n">df_feat</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">'feature'</span>
                <span class="n">importance_df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_feat</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   Error during modeling: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">importance_df_list</span><span class="p">:</span>
            <span class="c1"># Combine and average</span>
            <span class="n">all_feat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">importance_df_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">all_feat</span><span class="p">[</span><span class="s2">"mean_importance"</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_feat</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Filter top 30 non-zero</span>
            <span class="n">non_zero</span> <span class="o">=</span> <span class="n">all_feat</span><span class="p">[</span><span class="n">all_feat</span><span class="p">[</span><span class="s2">"mean_importance"</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">top30</span> <span class="o">=</span> <span class="n">non_zero</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">"mean_importance"</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>

            <span class="c1"># Save to CSV</span>
            <span class="n">top30</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"feature_importance.csv"</span><span class="p">))</span>

            <span class="c1"># Plot</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top30</span><span class="o">.</span><span class="n">index</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">top30</span><span class="p">[</span><span class="s2">"mean_importance"</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># plot top  bottom</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Mean Gain Importance"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Top 30 Feature Importance - </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"feature_importance_top30.png"</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Saved feature importance plot and CSV for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No valid models for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1">#  Run</span>
<span class="n">compute_feature_importance</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Computing feature importance for SUBCAT_Antipsychotica_atypisch
 Saved feature importance plot and CSV for SUBCAT_Antipsychotica_atypisch

 Computing feature importance for SUBCAT_TCA
 Saved feature importance plot and CSV for SUBCAT_TCA

 Computing feature importance for SUBCAT_SSRI
 Saved feature importance plot and CSV for SUBCAT_SSRI

 Computing feature importance for SUBCAT_SNRI
 Saved feature importance plot and CSV for SUBCAT_SNRI

 Computing feature importance for SUBCAT_Tetracyclische_antidepressiva
 Saved feature importance plot and CSV for SUBCAT_Tetracyclische_antidepressiva

 Computing feature importance for SUBCAT_Antidepressiva_overige
 Saved feature importance plot and CSV for SUBCAT_Antidepressiva_overige

 Computing feature importance for SUBCAT_Systemische_antihistaminica
 Saved feature importance plot and CSV for SUBCAT_Systemische_antihistaminica

 Computing feature importance for SUBCAT_anxiolytica_Benzodiazepine
 Saved feature importance plot and CSV for SUBCAT_anxiolytica_Benzodiazepine

 Computing feature importance for SUBCAT_hypnotica_Benzodiazepine
 Saved feature importance plot and CSV for SUBCAT_hypnotica_Benzodiazepine

 Computing feature importance for SUBCAT_Amfetaminen
 Saved feature importance plot and CSV for SUBCAT_Amfetaminen

 Computing feature importance for SUBCAT_Paracetamol_mono
 Saved feature importance plot and CSV for SUBCAT_Paracetamol_mono

 Computing feature importance for SUBCAT_Anti_epileptica_stemmingsstabilisatoren
 Saved feature importance plot and CSV for SUBCAT_Anti_epileptica_stemmingsstabilisatoren

 Computing feature importance for SUBCAT_Opioden
 Saved feature importance plot and CSV for SUBCAT_Opioden

 Computing feature importance for SUBCAT_Z_drugs
 Saved feature importance plot and CSV for SUBCAT_Z_drugs

 Computing feature importance for SUBCAT_NSAIDs
 Saved feature importance plot and CSV for SUBCAT_NSAIDs
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=03b8ab3d-0e32-41f1-8ac1-e8c308947d89">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[150]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="k">def</span> <span class="nf">compute_trimmed_clipped_iptw</span><span class="p">(</span><span class="n">ps_df</span><span class="p">,</span> <span class="n">treatment</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">clip_max</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">keep_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">ps_df</span> <span class="o">&gt;</span> <span class="n">lower</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ps_df</span> <span class="o">&lt;</span> <span class="n">upper</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ps_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">ps</span> <span class="o">=</span> <span class="n">ps_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">lower</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">1e-6</span><span class="p">)</span>  <span class="c1"># avoid div by zero</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">keep_mask</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">ps</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="n">w</span><span class="p">[</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">treatment</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">ps</span><span class="p">[</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">treatment</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="n">w</span><span class="p">[</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">treatment</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ps</span><span class="p">[</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">treatment</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)])</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">upper</span><span class="o">=</span><span class="n">clip_max</span><span class="p">)</span>
        <span class="n">weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">apply_rubins_rule_to_iptw</span><span class="p">(</span><span class="n">iptw_matrix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Given an IPTW matrix (n rows  M imputations), return Rubins rule pooled mean, SD, SE.</span>
<span class="sd">    """</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">q_bar</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">u_bar</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">total_var</span> <span class="o">=</span> <span class="n">u_bar</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">M</span><span class="p">)</span> <span class="o">*</span> <span class="n">B</span>
    <span class="n">total_se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">total_var</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">q_bar</span><span class="p">,</span> <span class="n">u_bar</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">total_se</span>


<span class="k">def</span> <span class="nf">run_trim_clip_save_all</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Processing IPTW + trimming + clipping for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"outputs"</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">ps_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"propensity_scores.xlsx"</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ps_path</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Missing PS file: </span><span class="si">{</span><span class="n">ps_path</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ps_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">ps_path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">ps_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">ps_all</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"ps_imp"</span><span class="p">)]</span>
            <span class="n">composite_index</span> <span class="o">=</span> <span class="n">ps_all</span><span class="o">.</span><span class="n">index</span>

            <span class="c1"># Get treatment from one imputed dataset</span>
            <span class="n">T_full</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">imputed_dfs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">T_full</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">composite_index</span><span class="p">,</span> <span class="n">group</span><span class="p">]</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="n">T_full</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Treatment column </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> not found in any imputed dataset."</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Compute IPTW matrix (shape: n  M)</span>
            <span class="n">iptw_matrix</span> <span class="o">=</span> <span class="n">compute_trimmed_clipped_iptw</span><span class="p">(</span><span class="n">ps_all</span><span class="p">[</span><span class="n">ps_cols</span><span class="p">],</span> <span class="n">T_full</span><span class="p">)</span>
            <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">"iptw_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iptw_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>

            <span class="c1"># Apply Rubins Rule for mean, SD, SE</span>
            <span class="n">iptw_matrix</span><span class="p">[</span><span class="s2">"iptw_mean"</span><span class="p">],</span> <span class="n">iptw_matrix</span><span class="p">[</span><span class="s2">"iptw_sd"</span><span class="p">],</span> <span class="n">iptw_matrix</span><span class="p">[</span><span class="s2">"iptw_se"</span><span class="p">]</span> <span class="o">=</span> <span class="n">apply_rubins_rule_to_iptw</span><span class="p">(</span>
                <span class="n">iptw_matrix</span><span class="p">[[</span><span class="sa">f</span><span class="s2">"iptw_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iptw_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]]</span>
            <span class="p">)</span>

            <span class="c1"># Save IPTW matrix separately</span>
            <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"iptw_weights.xlsx"</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Saved IPTW weights for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

            <span class="c1"># Save trimmed &amp; clipped imputed datasets with IPTW</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">imputed_dfs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">trimmed_idx</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="n">needed_cols</span> <span class="o">=</span> <span class="n">final_covariates_map</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">group</span><span class="p">,</span> <span class="s2">"caps5_change_baseline"</span><span class="p">]</span>

                <span class="c1"># Select only necessary columns</span>
                <span class="n">df_trimmed</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">trimmed_idx</span><span class="p">,</span> <span class="n">needed_cols</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">df_trimmed</span><span class="p">[</span><span class="s2">"iptw"</span><span class="p">]</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="p">[</span><span class="sa">f</span><span class="s2">"iptw_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">trimmed_idx</span><span class="p">]</span>

                <span class="c1">#  DROP rows with missing IPTW values</span>
                <span class="n">before</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_trimmed</span><span class="p">)</span>
                <span class="n">df_trimmed</span> <span class="o">=</span> <span class="n">df_trimmed</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">"iptw"</span><span class="p">])</span>
                <span class="n">after</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_trimmed</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"     Retained </span><span class="si">{</span><span class="n">after</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">before</span><span class="si">}</span><span class="s2"> rows after IPTW NaN drop."</span><span class="p">)</span>

                <span class="c1"># Save to .pkl</span>
                <span class="n">df_trimmed</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"trimmed_data_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.pkl"</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   Saved trimmed dataset: </span><span class="si">{</span><span class="n">output_folder</span><span class="si">}</span><span class="s2">/trimmed_data_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.*"</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>


<span class="n">run_trim_clip_save_all</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Processing IPTW + trimming + clipping for SUBCAT_Antipsychotica_atypisch
 Saved IPTW weights for SUBCAT_Antipsychotica_atypisch
     Retained 35/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Antipsychotica_atypisch/trimmed_data_imp1.*
     Retained 38/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Antipsychotica_atypisch/trimmed_data_imp2.*
     Retained 34/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Antipsychotica_atypisch/trimmed_data_imp3.*
     Retained 33/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Antipsychotica_atypisch/trimmed_data_imp4.*
     Retained 35/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Antipsychotica_atypisch/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SUBCAT_TCA
 Saved IPTW weights for SUBCAT_TCA
     Retained 174/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_TCA/trimmed_data_imp1.*
     Retained 179/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_TCA/trimmed_data_imp2.*
     Retained 192/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_TCA/trimmed_data_imp3.*
     Retained 178/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_TCA/trimmed_data_imp4.*
     Retained 182/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_TCA/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SUBCAT_SSRI
 Saved IPTW weights for SUBCAT_SSRI
     Retained 1206/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_SSRI/trimmed_data_imp1.*
     Retained 1195/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_SSRI/trimmed_data_imp2.*
     Retained 1266/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_SSRI/trimmed_data_imp3.*
     Retained 1231/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_SSRI/trimmed_data_imp4.*
     Retained 1227/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_SSRI/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SUBCAT_SNRI
 Saved IPTW weights for SUBCAT_SNRI
     Retained 168/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_SNRI/trimmed_data_imp1.*
     Retained 159/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_SNRI/trimmed_data_imp2.*
     Retained 169/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_SNRI/trimmed_data_imp3.*
     Retained 155/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_SNRI/trimmed_data_imp4.*
     Retained 183/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_SNRI/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SUBCAT_Tetracyclische_antidepressiva
 Saved IPTW weights for SUBCAT_Tetracyclische_antidepressiva
     Retained 193/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Tetracyclische_antidepressiva/trimmed_data_imp1.*
     Retained 185/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Tetracyclische_antidepressiva/trimmed_data_imp2.*
     Retained 196/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Tetracyclische_antidepressiva/trimmed_data_imp3.*
     Retained 181/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Tetracyclische_antidepressiva/trimmed_data_imp4.*
     Retained 181/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Tetracyclische_antidepressiva/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SUBCAT_Antidepressiva_overige
 Saved IPTW weights for SUBCAT_Antidepressiva_overige
     Retained 81/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Antidepressiva_overige/trimmed_data_imp1.*
     Retained 75/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Antidepressiva_overige/trimmed_data_imp2.*
     Retained 69/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Antidepressiva_overige/trimmed_data_imp3.*
     Retained 75/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Antidepressiva_overige/trimmed_data_imp4.*
     Retained 73/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Antidepressiva_overige/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SUBCAT_Systemische_antihistaminica
 Saved IPTW weights for SUBCAT_Systemische_antihistaminica
     Retained 123/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Systemische_antihistaminica/trimmed_data_imp1.*
     Retained 118/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Systemische_antihistaminica/trimmed_data_imp2.*
     Retained 128/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Systemische_antihistaminica/trimmed_data_imp3.*
     Retained 118/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Systemische_antihistaminica/trimmed_data_imp4.*
     Retained 115/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Systemische_antihistaminica/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SUBCAT_anxiolytica_Benzodiazepine
 Saved IPTW weights for SUBCAT_anxiolytica_Benzodiazepine
     Retained 885/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_anxiolytica_Benzodiazepine/trimmed_data_imp1.*
     Retained 938/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_anxiolytica_Benzodiazepine/trimmed_data_imp2.*
     Retained 895/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_anxiolytica_Benzodiazepine/trimmed_data_imp3.*
     Retained 945/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_anxiolytica_Benzodiazepine/trimmed_data_imp4.*
     Retained 828/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_anxiolytica_Benzodiazepine/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SUBCAT_hypnotica_Benzodiazepine
 Saved IPTW weights for SUBCAT_hypnotica_Benzodiazepine
     Retained 327/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_hypnotica_Benzodiazepine/trimmed_data_imp1.*
     Retained 324/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_hypnotica_Benzodiazepine/trimmed_data_imp2.*
     Retained 324/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_hypnotica_Benzodiazepine/trimmed_data_imp3.*
     Retained 326/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_hypnotica_Benzodiazepine/trimmed_data_imp4.*
     Retained 322/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_hypnotica_Benzodiazepine/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SUBCAT_Amfetaminen
 Saved IPTW weights for SUBCAT_Amfetaminen
     Retained 103/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Amfetaminen/trimmed_data_imp1.*
     Retained 105/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Amfetaminen/trimmed_data_imp2.*
     Retained 102/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Amfetaminen/trimmed_data_imp3.*
     Retained 96/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Amfetaminen/trimmed_data_imp4.*
     Retained 110/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Amfetaminen/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SUBCAT_Paracetamol_mono
 Saved IPTW weights for SUBCAT_Paracetamol_mono
     Retained 64/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Paracetamol_mono/trimmed_data_imp1.*
     Retained 76/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Paracetamol_mono/trimmed_data_imp2.*
     Retained 64/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Paracetamol_mono/trimmed_data_imp3.*
     Retained 55/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Paracetamol_mono/trimmed_data_imp4.*
     Retained 69/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Paracetamol_mono/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SUBCAT_Anti_epileptica_stemmingsstabilisatoren
 Saved IPTW weights for SUBCAT_Anti_epileptica_stemmingsstabilisatoren
     Retained 92/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Anti_epileptica_stemmingsstabilisatoren/trimmed_data_imp1.*
     Retained 98/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Anti_epileptica_stemmingsstabilisatoren/trimmed_data_imp2.*
     Retained 96/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Anti_epileptica_stemmingsstabilisatoren/trimmed_data_imp3.*
     Retained 105/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Anti_epileptica_stemmingsstabilisatoren/trimmed_data_imp4.*
     Retained 95/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Anti_epileptica_stemmingsstabilisatoren/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SUBCAT_Opioden
 Saved IPTW weights for SUBCAT_Opioden
     Retained 106/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Opioden/trimmed_data_imp1.*
     Retained 115/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Opioden/trimmed_data_imp2.*
     Retained 106/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Opioden/trimmed_data_imp3.*
     Retained 117/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Opioden/trimmed_data_imp4.*
     Retained 116/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Opioden/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SUBCAT_Z_drugs
 Saved IPTW weights for SUBCAT_Z_drugs
     Retained 119/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Z_drugs/trimmed_data_imp1.*
     Retained 124/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Z_drugs/trimmed_data_imp2.*
     Retained 126/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Z_drugs/trimmed_data_imp3.*
     Retained 118/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Z_drugs/trimmed_data_imp4.*
     Retained 114/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Z_drugs/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SUBCAT_NSAIDs
 Saved IPTW weights for SUBCAT_NSAIDs
     Retained 83/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_NSAIDs/trimmed_data_imp1.*
     Retained 86/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_NSAIDs/trimmed_data_imp2.*
     Retained 67/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_NSAIDs/trimmed_data_imp3.*
     Retained 77/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_NSAIDs/trimmed_data_imp4.*
     Retained 77/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_NSAIDs/trimmed_data_imp5.*
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=36c885c8-0ce8-4666-83e8-5926e92c2ede">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[151]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="k">def</span> <span class="nf">plot_ps_overlap_all_groups</span><span class="p">(</span><span class="n">medication_groups</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Plotting PS overlap for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="n">folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"outputs"</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">ps_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">"propensity_scores.xlsx"</span><span class="p">)</span>
        <span class="n">iptw_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">"iptw_weights.xlsx"</span><span class="p">)</span>
        <span class="n">trimmed_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">"trimmed_data_imp1.pkl"</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ps_file</span><span class="p">,</span> <span class="n">iptw_file</span><span class="p">,</span> <span class="n">trimmed_file</span><span class="p">]):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Missing required files for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ps_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">ps_file</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">iptw_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">iptw_file</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">trimmed_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">trimmed_file</span><span class="p">)</span>

            <span class="c1"># Extract</span>
            <span class="n">ps</span> <span class="o">=</span> <span class="n">ps_df</span><span class="p">[</span><span class="s2">"composite_ps"</span><span class="p">]</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">trimmed_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">iptw_df</span><span class="p">[</span><span class="s2">"iptw_mean"</span><span class="p">]</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">trimmed_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">trimmed_df</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>

            <span class="c1"># Masks to remove NaNs</span>
            <span class="n">treated_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ps</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">w</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
            <span class="n">control_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ps</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">w</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>

            <span class="n">treated</span> <span class="o">=</span> <span class="n">ps</span><span class="p">[</span><span class="n">treated_mask</span><span class="p">]</span>
            <span class="n">treated_w</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="n">treated_mask</span><span class="p">]</span>

            <span class="n">control</span> <span class="o">=</span> <span class="n">ps</span><span class="p">[</span><span class="n">control_mask</span><span class="p">]</span>
            <span class="n">control_w</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="n">control_mask</span><span class="p">]</span>

            <span class="c1"># === Unweighted Plot ===</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">([</span><span class="n">treated</span><span class="p">,</span> <span class="n">control</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="p">[</span><span class="s2">"Treated"</span><span class="p">,</span> <span class="s2">"Control"</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Unweighted PS Overlap - </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Composite Propensity Score"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"Count"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">"ps_overlap_unweighted.png"</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="c1"># === Weighted Plot ===</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">([</span><span class="n">treated</span><span class="p">,</span> <span class="n">control</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="p">[</span><span class="n">treated_w</span><span class="p">,</span> <span class="n">control_w</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="p">[</span><span class="s2">"Treated"</span><span class="p">,</span> <span class="s2">"Control"</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Weighted PS Overlap - </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Composite Propensity Score"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"Weighted Count"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">"ps_overlap_weighted.png"</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Saved unweighted and weighted PS plots for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error processing </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1">#  Run</span>
<span class="n">plot_ps_overlap_all_groups</span><span class="p">(</span><span class="n">medication_groups</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Plotting PS overlap for SUBCAT_Antipsychotica_atypisch
 Saved unweighted and weighted PS plots for SUBCAT_Antipsychotica_atypisch

 Plotting PS overlap for SUBCAT_TCA
 Saved unweighted and weighted PS plots for SUBCAT_TCA

 Plotting PS overlap for SUBCAT_SSRI
 Saved unweighted and weighted PS plots for SUBCAT_SSRI

 Plotting PS overlap for SUBCAT_SNRI
 Saved unweighted and weighted PS plots for SUBCAT_SNRI

 Plotting PS overlap for SUBCAT_Tetracyclische_antidepressiva
 Saved unweighted and weighted PS plots for SUBCAT_Tetracyclische_antidepressiva

 Plotting PS overlap for SUBCAT_Antidepressiva_overige
 Saved unweighted and weighted PS plots for SUBCAT_Antidepressiva_overige

 Plotting PS overlap for SUBCAT_Systemische_antihistaminica
 Saved unweighted and weighted PS plots for SUBCAT_Systemische_antihistaminica

 Plotting PS overlap for SUBCAT_anxiolytica_Benzodiazepine
 Saved unweighted and weighted PS plots for SUBCAT_anxiolytica_Benzodiazepine

 Plotting PS overlap for SUBCAT_hypnotica_Benzodiazepine
 Saved unweighted and weighted PS plots for SUBCAT_hypnotica_Benzodiazepine

 Plotting PS overlap for SUBCAT_Amfetaminen
 Saved unweighted and weighted PS plots for SUBCAT_Amfetaminen

 Plotting PS overlap for SUBCAT_Paracetamol_mono
 Saved unweighted and weighted PS plots for SUBCAT_Paracetamol_mono

 Plotting PS overlap for SUBCAT_Anti_epileptica_stemmingsstabilisatoren
 Saved unweighted and weighted PS plots for SUBCAT_Anti_epileptica_stemmingsstabilisatoren

 Plotting PS overlap for SUBCAT_Opioden
 Saved unweighted and weighted PS plots for SUBCAT_Opioden

 Plotting PS overlap for SUBCAT_Z_drugs
 Saved unweighted and weighted PS plots for SUBCAT_Z_drugs

 Plotting PS overlap for SUBCAT_NSAIDs
 Saved unweighted and weighted PS plots for SUBCAT_NSAIDs
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=9416ccc5-be17-41b6-b800-1388807f0170">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[152]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># Set up base output folder</span>
<span class="n">output_base</span> <span class="o">=</span> <span class="s2">"outputs"</span>
<span class="n">ps_file</span> <span class="o">=</span> <span class="s2">"propensity_scores.xlsx"</span>
<span class="n">iptw_file</span> <span class="o">=</span> <span class="s2">"iptw_weights.xlsx"</span>
<span class="n">trimmed_data_file</span> <span class="o">=</span> <span class="s2">"trimmed_data_imp1.pkl"</span>

<span class="c1"># Collect all treatment group folders</span>
<span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">medication_groups</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">g</span><span class="p">))]</span>


<span class="c1"># Generate 4-panel overlap plots</span>
<span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
    <span class="n">group_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Load trimmed treatment info</span>
        <span class="n">trimmed_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="n">trimmed_data_file</span><span class="p">))</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">trimmed_df</span><span class="o">.</span><span class="n">index</span>

        <span class="c1"># Fix: case-insensitive match for treatment variable</span>
        <span class="n">possible_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">trimmed_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">group</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">possible_cols</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Treatment variable </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> not found in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">, skipping."</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">treatment_var</span> <span class="o">=</span> <span class="n">possible_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">trimmed_df</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span>

        <span class="c1"># Load composite PS (aligned to trimmed_df index)</span>
        <span class="n">ps_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="n">ps_file</span><span class="p">),</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">'composite_ps'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ps_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Composite column missing in </span><span class="si">{</span><span class="n">ps_file</span><span class="si">}</span><span class="s2">, skipping </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">."</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">ps</span> <span class="o">=</span> <span class="n">ps_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s1">'composite_ps'</span><span class="p">]</span>

        <span class="c1"># Load IPTW weights (aligned to trimmed_df index)</span>
        <span class="n">weights_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="n">iptw_file</span><span class="p">),</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">'iptw_mean'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">weights_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" IPTW weight column missing in </span><span class="si">{</span><span class="n">iptw_file</span><span class="si">}</span><span class="s2">, skipping </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">."</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">weights_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s1">'iptw_mean'</span><span class="p">]</span>

        <span class="c1"># Prepare 4 datasets</span>
        <span class="n">raw_treated</span> <span class="o">=</span> <span class="n">ps</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">raw_control</span> <span class="o">=</span> <span class="n">ps</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">weighted_treated</span> <span class="o">=</span> <span class="p">(</span><span class="n">ps</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">],</span> <span class="n">weights</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">weighted_control</span> <span class="o">=</span> <span class="p">(</span><span class="n">ps</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">],</span> <span class="n">weights</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Create plot</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Propensity Score Distribution - </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">raw_treated</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'blue'</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Raw Treated"</span><span class="p">)</span>

        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">raw_control</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'green'</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Raw Control"</span><span class="p">)</span>

        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">weighted_treated</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weighted_treated</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'blue'</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Weighted Treated"</span><span class="p">)</span>

        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">weighted_control</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weighted_control</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'green'</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Weighted Control"</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="o">.</span><span class="n">flat</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Propensity Score"</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Count"</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">])</span>

        <span class="c1"># Save figure</span>
        <span class="n">plot_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"four_panel_overlap_</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">.png"</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_path</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Saved: </span><span class="si">{</span><span class="n">plot_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>  Saved: outputs\SUBCAT_Antipsychotica_atypisch\four_panel_overlap_SUBCAT_Antipsychotica_atypisch.png
  Saved: outputs\SUBCAT_TCA\four_panel_overlap_SUBCAT_TCA.png
  Saved: outputs\SUBCAT_SSRI\four_panel_overlap_SUBCAT_SSRI.png
  Saved: outputs\SUBCAT_SNRI\four_panel_overlap_SUBCAT_SNRI.png
  Saved: outputs\SUBCAT_Tetracyclische_antidepressiva\four_panel_overlap_SUBCAT_Tetracyclische_antidepressiva.png
  Saved: outputs\SUBCAT_Antidepressiva_overige\four_panel_overlap_SUBCAT_Antidepressiva_overige.png
  Saved: outputs\SUBCAT_Systemische_antihistaminica\four_panel_overlap_SUBCAT_Systemische_antihistaminica.png
  Saved: outputs\SUBCAT_anxiolytica_Benzodiazepine\four_panel_overlap_SUBCAT_anxiolytica_Benzodiazepine.png
  Saved: outputs\SUBCAT_hypnotica_Benzodiazepine\four_panel_overlap_SUBCAT_hypnotica_Benzodiazepine.png
  Saved: outputs\SUBCAT_Amfetaminen\four_panel_overlap_SUBCAT_Amfetaminen.png
  Saved: outputs\SUBCAT_Paracetamol_mono\four_panel_overlap_SUBCAT_Paracetamol_mono.png
  Saved: outputs\SUBCAT_Anti_epileptica_stemmingsstabilisatoren\four_panel_overlap_SUBCAT_Anti_epileptica_stemmingsstabilisatoren.png
  Saved: outputs\SUBCAT_Opioden\four_panel_overlap_SUBCAT_Opioden.png
  Saved: outputs\SUBCAT_Z_drugs\four_panel_overlap_SUBCAT_Z_drugs.png
  Saved: outputs\SUBCAT_NSAIDs\four_panel_overlap_SUBCAT_NSAIDs.png
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=a5ffe0fe-e79d-49bb-9f2b-7e652c1e72ee">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[153]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># ATT calculation:</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=37018865-e063-4f96-a285-b905dc33fabf">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[154]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Weighted:</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=96f04f14-2d87-4c64-ace6-45cb7c97414e">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[155]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">GradientBoostingRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">r2_score</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">KFold</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">t</span><span class="p">,</span> <span class="n">probplot</span>
<span class="kn">import</span> <span class="nn">xgboost</span> <span class="k">as</span> <span class="nn">xgb</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Configuration</span>
<span class="c1"># -----------------------------</span>
<span class="n">n_repeats</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">seeds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span>
<span class="n">imputations</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">output_folder</span> <span class="o">=</span> <span class="s2">"outputs"</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Diagnostic Plotting Function</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">create_diagnostic_plots</span><span class="p">(</span><span class="n">residuals_data</span><span class="p">,</span> <span class="n">fitted_data</span><span class="p">,</span> <span class="n">group_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Create 4 diagnostic plots for model validation"""</span>
    <span class="n">plots_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"plots"</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">plots_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Flatten the collected data</span>
    <span class="n">all_residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">residuals_data</span><span class="p">)</span>
    <span class="n">all_fitted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">fitted_data</span><span class="p">)</span>
    
    <span class="c1"># Create figure with 2x2 subplots</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Diagnostic Plots - </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">'bold'</span><span class="p">)</span>
    
    <span class="c1"># 1. Residuals vs Fitted</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">all_fitted</span><span class="p">,</span> <span class="n">all_residuals</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Fitted Values'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Residuals'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Residuals vs Fitted'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># 2. QQ Plot</span>
    <span class="n">probplot</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s2">"norm"</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Q-Q Plot (Normal)'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># 3. Residual Histogram</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'skyblue'</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">'black'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Residuals'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Density'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Residual Distribution'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># 4. Scale-Location Plot</span>
    <span class="n">sqrt_abs_residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">))</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">all_fitted</span><span class="p">,</span> <span class="n">sqrt_abs_residuals</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Fitted Values'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'|Residuals|'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Scale-Location Plot'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    
    <span class="c1"># Save plot</span>
    <span class="n">plot_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plots_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s1">.png'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_filename</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">'tight'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Diagnostic plots saved for </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Rubin's Rule</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">rubins_pool</span><span class="p">(</span><span class="n">estimates</span><span class="p">,</span> <span class="n">ses</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">estimates</span><span class="p">)</span>
    <span class="n">q_bar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">estimates</span><span class="p">)</span>
    <span class="n">u_bar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">ses</span><span class="p">))</span>
    <span class="n">b_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">estimates</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">total_var</span> <span class="o">=</span> <span class="n">u_bar</span> <span class="o">+</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">b_m</span><span class="p">)</span>
    <span class="n">total_se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">total_var</span><span class="p">)</span>
    <span class="n">ci_lower</span> <span class="o">=</span> <span class="n">q_bar</span> <span class="o">-</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">total_se</span>
    <span class="n">ci_upper</span> <span class="o">=</span> <span class="n">q_bar</span> <span class="o">+</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">total_se</span>
    <span class="n">p_value</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">q_bar</span> <span class="o">/</span> <span class="n">total_se</span><span class="p">),</span> <span class="n">df</span><span class="o">=</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">rounded_p</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">p_value</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">formatted_p</span> <span class="o">=</span> <span class="s2">"&lt; 0.00001"</span> <span class="k">if</span> <span class="n">rounded_p</span> <span class="o">&lt;=</span> <span class="mf">0.00001</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">rounded_p</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">return</span> <span class="n">q_bar</span><span class="p">,</span> <span class="n">total_se</span><span class="p">,</span> <span class="n">ci_lower</span><span class="p">,</span> <span class="n">ci_upper</span><span class="p">,</span> <span class="n">formatted_p</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># SMD + Variance Ratio</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">calculate_smd_vr</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
    <span class="n">treated</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">control</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">w_treated</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">w_control</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">smd</span><span class="p">,</span> <span class="n">vr</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m1</span><span class="p">,</span> <span class="n">m0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">treated</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">w_treated</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">control</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">w_control</span><span class="p">)</span>
            <span class="n">s1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">((</span><span class="n">treated</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">-</span> <span class="n">m1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w_treated</span><span class="p">))</span>
            <span class="n">s0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">((</span><span class="n">control</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">-</span> <span class="n">m0</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w_control</span><span class="p">))</span>
            <span class="n">pooled_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">s1</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">s0</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">smd</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">m1</span> <span class="o">-</span> <span class="n">m0</span><span class="p">)</span> <span class="o">/</span> <span class="n">pooled_sd</span> <span class="k">if</span> <span class="n">pooled_sd</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">vr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s1</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">s0</span><span class="o">**</span><span class="mi">2</span> <span class="k">if</span> <span class="n">s0</span><span class="o">**</span><span class="mi">2</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">smd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">vr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">smd</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">vr</span><span class="p">)</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># XGBoost Main Loop (No DML)</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">run_xgboost_with_trimmed_data</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="p">):</span>
    <span class="n">att_results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">balance_results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">covariates</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Running XGBoost for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">group_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">group_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">best_result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">best_se</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">"inf"</span><span class="p">)</span>
        
        <span class="c1"># Initialize lists to collect residuals and fitted values for diagnostic plots</span>
        <span class="n">group_residuals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">group_fitted</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="n">seeds</span><span class="p">:</span>
            <span class="n">att_list</span><span class="p">,</span> <span class="n">se_list</span><span class="p">,</span> <span class="n">r2_list</span><span class="p">,</span> <span class="n">rmse_list</span><span class="p">,</span> <span class="n">smd_list</span><span class="p">,</span> <span class="n">vr_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">imp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">imputations</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"trimmed_data_imp</span><span class="si">{</span><span class="n">imp</span><span class="si">}</span><span class="s2">.pkl"</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">or</span> <span class="s2">"iptw"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">T</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
                <span class="n">Y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">"caps5_change_baseline"</span><span class="p">]</span>
                <span class="n">W</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">"iptw"</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">repeat</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_repeats</span><span class="p">):</span>
                    <span class="n">kf</span> <span class="o">=</span> <span class="n">KFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span> <span class="o">+</span> <span class="n">repeat</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">train_idx</span><span class="p">,</span> <span class="n">test_idx</span> <span class="ow">in</span> <span class="n">kf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">X_train</span><span class="p">,</span> <span class="n">T_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">W_train</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span>
                                <span class="n">T</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span>
                                <span class="n">Y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span>
                                <span class="n">W</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span>
                            <span class="p">)</span>

                            <span class="c1"># XGBoost regression model</span>
                            <span class="n">model</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
                            
                            <span class="c1"># Add treatment variable to features</span>
                            <span class="n">X_train_with_T</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                            <span class="n">X_train_with_T</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_train</span>
                            
                            <span class="c1"># Fit model</span>
                            <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_with_T</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="n">W_train</span><span class="p">)</span>
                            
                            <span class="c1"># Predict outcomes for treated and control groups</span>
                            <span class="n">X_treated</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                            <span class="n">X_treated</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="n">X_control</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                            <span class="n">X_control</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                            
                            <span class="n">Y_pred_treated</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_treated</span><span class="p">)</span>
                            <span class="n">Y_pred_control</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_control</span><span class="p">)</span>
                            
                            <span class="c1"># Calculate ATT (Average Treatment Effect on Treated)</span>
                            <span class="n">treated_mask</span> <span class="o">=</span> <span class="n">T_train</span> <span class="o">==</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">treated_mask</span><span class="p">):</span>
                                <span class="n">att</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">Y_pred_treated</span><span class="p">[</span><span class="n">treated_mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">Y_pred_control</span><span class="p">[</span><span class="n">treated_mask</span><span class="p">],</span> 
                                               <span class="n">weights</span><span class="o">=</span><span class="n">W_train</span><span class="p">[</span><span class="n">treated_mask</span><span class="p">])</span>
                                
                                <span class="c1"># Calculate standard error (approximate)</span>
                                <span class="n">treatment_effects</span> <span class="o">=</span> <span class="n">Y_pred_treated</span><span class="p">[</span><span class="n">treated_mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">Y_pred_control</span><span class="p">[</span><span class="n">treated_mask</span><span class="p">]</span>
                                <span class="n">residual</span> <span class="o">=</span> <span class="n">treatment_effects</span> <span class="o">-</span> <span class="n">att</span>
                                <span class="n">se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">W_train</span><span class="p">[</span><span class="n">treated_mask</span><span class="p">]</span> <span class="o">*</span> <span class="n">residual</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">W_train</span><span class="p">[</span><span class="n">treated_mask</span><span class="p">])</span>

                                
                                <span class="n">att_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">att</span><span class="p">)</span>
                                <span class="n">se_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">se</span><span class="p">)</span>

                            <span class="c1"># Model performance metrics</span>
                            <span class="n">Y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train_with_T</span><span class="p">)</span>
                            <span class="n">residuals</span> <span class="o">=</span> <span class="n">Y_train</span> <span class="o">-</span> <span class="n">Y_pred</span>
                            <span class="n">rmse</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_pred</span><span class="p">,</span> <span class="n">squared</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                            <span class="n">r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_pred</span><span class="p">)</span>
                            <span class="n">r2_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
                            <span class="n">rmse_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rmse</span><span class="p">)</span>
                            
                            <span class="c1"># Collect residuals and fitted values for diagnostic plots</span>
                            <span class="n">group_residuals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">residuals</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                            <span class="n">group_fitted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Y_pred</span><span class="p">)</span>

                            <span class="n">smd</span><span class="p">,</span> <span class="n">vr</span> <span class="o">=</span> <span class="n">calculate_smd_vr</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">T_train</span><span class="p">,</span> <span class="n">W_train</span><span class="p">)</span>
                            <span class="n">smd_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smd</span><span class="p">)</span>
                            <span class="n">vr_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vr</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">, seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">, imp </span><span class="si">{</span><span class="n">imp</span><span class="si">}</span><span class="s2">, rep </span><span class="si">{</span><span class="n">repeat</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">att_list</span><span class="p">:</span>
                <span class="n">att</span><span class="p">,</span> <span class="n">se</span><span class="p">,</span> <span class="n">ci_l</span><span class="p">,</span> <span class="n">ci_u</span><span class="p">,</span> <span class="n">p_val</span> <span class="o">=</span> <span class="n">rubins_pool</span><span class="p">(</span><span class="n">att_list</span><span class="p">,</span> <span class="n">se_list</span><span class="p">)</span>
                <span class="n">avg_r2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">r2_list</span><span class="p">)</span>
                <span class="n">avg_rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rmse_list</span><span class="p">)</span>
                <span class="n">avg_smd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">smd_list</span><span class="p">)</span>
                <span class="n">avg_vr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">vr_list</span><span class="p">)</span>

                <span class="n">balance_results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">"group"</span><span class="p">:</span> <span class="n">group</span><span class="p">,</span> <span class="s2">"seed"</span><span class="p">:</span> <span class="n">seed</span><span class="p">,</span> <span class="s2">"smd"</span><span class="p">:</span> <span class="n">avg_smd</span><span class="p">,</span> <span class="s2">"vr"</span><span class="p">:</span> <span class="n">avg_vr</span>
                <span class="p">})</span>

                <span class="k">if</span> <span class="n">se</span> <span class="o">&lt;</span> <span class="n">best_se</span><span class="p">:</span>
                    <span class="n">best_se</span> <span class="o">=</span> <span class="n">se</span>
                    <span class="n">best_result</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">"group"</span><span class="p">:</span> <span class="n">group</span><span class="p">,</span> <span class="s2">"seed"</span><span class="p">:</span> <span class="n">seed</span><span class="p">,</span> <span class="s2">"att"</span><span class="p">:</span> <span class="n">att</span><span class="p">,</span> <span class="s2">"se"</span><span class="p">:</span> <span class="n">se</span><span class="p">,</span>
                        <span class="s2">"ci_lower"</span><span class="p">:</span> <span class="n">ci_l</span><span class="p">,</span> <span class="s2">"ci_upper"</span><span class="p">:</span> <span class="n">ci_u</span><span class="p">,</span> <span class="s2">"p_value"</span><span class="p">:</span> <span class="n">p_val</span><span class="p">,</span>
                        <span class="s2">"r2"</span><span class="p">:</span> <span class="n">avg_r2</span><span class="p">,</span> <span class="s2">"rmse"</span><span class="p">:</span> <span class="n">avg_rmse</span>
                    <span class="p">}</span>

                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> | Seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">: ATT = </span><span class="si">{</span><span class="n">att</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, SE = </span><span class="si">{</span><span class="n">se</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, p = </span><span class="si">{</span><span class="n">p_val</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No valid results for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> | Seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Create diagnostic plots for this group</span>
        <span class="k">if</span> <span class="n">group_residuals</span> <span class="ow">and</span> <span class="n">group_fitted</span><span class="p">:</span>
            <span class="n">create_diagnostic_plots</span><span class="p">(</span><span class="n">group_residuals</span><span class="p">,</span> <span class="n">group_fitted</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">best_result</span><span class="p">:</span>
            <span class="n">att_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">best_result</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Best result for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">  Seed </span><span class="si">{</span><span class="n">best_result</span><span class="p">[</span><span class="s1">'seed'</span><span class="p">]</span><span class="si">}</span><span class="s2"> | SE = </span><span class="si">{</span><span class="n">best_result</span><span class="p">[</span><span class="s1">'se'</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="c1"># Save final output</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">att_results</span><span class="p">)</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">"xgb_rubin_summary_subcats.xlsx"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">balance_results</span><span class="p">)</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">"smd_vr_summary_subcats.xlsx"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> All summary files saved."</span><span class="p">)</span>

<span class="n">run_xgboost_with_trimmed_data</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Running XGBoost for SUBCAT_Antipsychotica_atypisch
 SUBCAT_Antipsychotica_atypisch | Seed 1: ATT = -0.7985, SE = 2.1885, p = 0.71841
 SUBCAT_Antipsychotica_atypisch | Seed 2: ATT = -0.9127, SE = 1.9794, p = 0.64886
 SUBCAT_Antipsychotica_atypisch | Seed 3: ATT = -0.6022, SE = 1.5906, p = 0.70829
 SUBCAT_Antipsychotica_atypisch | Seed 4: ATT = -0.8361, SE = 1.9341, p = 0.66938
 SUBCAT_Antipsychotica_atypisch | Seed 5: ATT = -0.9879, SE = 2.1822, p = 0.65483
 SUBCAT_Antipsychotica_atypisch | Seed 6: ATT = -1.2858, SE = 2.3160, p = 0.58390
 SUBCAT_Antipsychotica_atypisch | Seed 7: ATT = -0.6123, SE = 2.2906, p = 0.79153
 SUBCAT_Antipsychotica_atypisch | Seed 8: ATT = -0.9784, SE = 1.9259, p = 0.61608
 SUBCAT_Antipsychotica_atypisch | Seed 9: ATT = -0.8381, SE = 2.1425, p = 0.69912
 SUBCAT_Antipsychotica_atypisch | Seed 10: ATT = -1.1909, SE = 1.8273, p = 0.52076
 Diagnostic plots saved for SUBCAT_Antipsychotica_atypisch
 Best result for SUBCAT_Antipsychotica_atypisch  Seed 3 | SE = 1.5906

 Running XGBoost for SUBCAT_TCA
 SUBCAT_TCA | Seed 1: ATT = 4.0786, SE = 1.8896, p = 0.04111
 SUBCAT_TCA | Seed 2: ATT = 3.8987, SE = 1.9588, p = 0.05807
 SUBCAT_TCA | Seed 3: ATT = 4.0471, SE = 1.8504, p = 0.03871
 SUBCAT_TCA | Seed 4: ATT = 3.8287, SE = 2.0184, p = 0.06993
 SUBCAT_TCA | Seed 5: ATT = 4.1543, SE = 1.6271, p = 0.01745
 SUBCAT_TCA | Seed 6: ATT = 4.1536, SE = 2.1056, p = 0.06017
 SUBCAT_TCA | Seed 7: ATT = 3.8999, SE = 1.6159, p = 0.02379
 SUBCAT_TCA | Seed 8: ATT = 3.9887, SE = 2.1346, p = 0.07394
 SUBCAT_TCA | Seed 9: ATT = 3.9705, SE = 1.9272, p = 0.05038
 SUBCAT_TCA | Seed 10: ATT = 3.9388, SE = 1.9252, p = 0.05187
 Diagnostic plots saved for SUBCAT_TCA
 Best result for SUBCAT_TCA  Seed 7 | SE = 1.6159

 Running XGBoost for SUBCAT_SSRI
 SUBCAT_SSRI | Seed 1: ATT = -0.0051, SE = 0.4202, p = 0.99042
 SUBCAT_SSRI | Seed 2: ATT = -0.0493, SE = 0.4349, p = 0.91069
 SUBCAT_SSRI | Seed 3: ATT = -0.0001, SE = 0.5001, p = 0.99983
 SUBCAT_SSRI | Seed 4: ATT = -0.0848, SE = 0.5310, p = 0.87446
 SUBCAT_SSRI | Seed 5: ATT = -0.0589, SE = 0.4640, p = 0.90007
 SUBCAT_SSRI | Seed 6: ATT = -0.0433, SE = 0.4570, p = 0.92521
 SUBCAT_SSRI | Seed 7: ATT = -0.0493, SE = 0.4352, p = 0.91073
 SUBCAT_SSRI | Seed 8: ATT = -0.0347, SE = 0.3724, p = 0.92664
 SUBCAT_SSRI | Seed 9: ATT = -0.0351, SE = 0.4587, p = 0.93966
 SUBCAT_SSRI | Seed 10: ATT = -0.0637, SE = 0.4234, p = 0.88168
 Diagnostic plots saved for SUBCAT_SSRI
 Best result for SUBCAT_SSRI  Seed 8 | SE = 0.3724

 Running XGBoost for SUBCAT_SNRI
 SUBCAT_SNRI | Seed 1: ATT = 2.5961, SE = 1.8332, p = 0.16958
 SUBCAT_SNRI | Seed 2: ATT = 2.6194, SE = 1.4069, p = 0.07491
 SUBCAT_SNRI | Seed 3: ATT = 2.6223, SE = 1.6670, p = 0.12879
 SUBCAT_SNRI | Seed 4: ATT = 2.5993, SE = 1.5531, p = 0.10718
 SUBCAT_SNRI | Seed 5: ATT = 2.5317, SE = 1.3426, p = 0.07149
 SUBCAT_SNRI | Seed 6: ATT = 2.3457, SE = 1.3412, p = 0.09308
 SUBCAT_SNRI | Seed 7: ATT = 2.5235, SE = 1.5223, p = 0.11038
 SUBCAT_SNRI | Seed 8: ATT = 2.4054, SE = 1.3102, p = 0.07878
 SUBCAT_SNRI | Seed 9: ATT = 2.6288, SE = 1.3651, p = 0.06608
 SUBCAT_SNRI | Seed 10: ATT = 2.6318, SE = 1.4052, p = 0.07330
 Diagnostic plots saved for SUBCAT_SNRI
 Best result for SUBCAT_SNRI  Seed 8 | SE = 1.3102

 Running XGBoost for SUBCAT_Tetracyclische_antidepressiva
 SUBCAT_Tetracyclische_antidepressiva | Seed 1: ATT = 6.6345, SE = 2.6139, p = 0.01805
 SUBCAT_Tetracyclische_antidepressiva | Seed 2: ATT = 6.6273, SE = 2.6463, p = 0.01946
 SUBCAT_Tetracyclische_antidepressiva | Seed 3: ATT = 6.5832, SE = 2.5837, p = 0.01766
 SUBCAT_Tetracyclische_antidepressiva | Seed 4: ATT = 6.5959, SE = 2.1612, p = 0.00548
 SUBCAT_Tetracyclische_antidepressiva | Seed 5: ATT = 6.7347, SE = 2.4721, p = 0.01183
 SUBCAT_Tetracyclische_antidepressiva | Seed 6: ATT = 6.6746, SE = 2.3943, p = 0.01022
 SUBCAT_Tetracyclische_antidepressiva | Seed 7: ATT = 6.6459, SE = 2.4576, p = 0.01239
 SUBCAT_Tetracyclische_antidepressiva | Seed 8: ATT = 6.5744, SE = 2.9128, p = 0.03338
 SUBCAT_Tetracyclische_antidepressiva | Seed 9: ATT = 6.3731, SE = 2.3476, p = 0.01209
 SUBCAT_Tetracyclische_antidepressiva | Seed 10: ATT = 6.4235, SE = 2.4629, p = 0.01542
 Diagnostic plots saved for SUBCAT_Tetracyclische_antidepressiva
 Best result for SUBCAT_Tetracyclische_antidepressiva  Seed 4 | SE = 2.1612

 Running XGBoost for SUBCAT_Antidepressiva_overige
 SUBCAT_Antidepressiva_overige | Seed 1: ATT = 2.1925, SE = 1.6217, p = 0.18899
 SUBCAT_Antidepressiva_overige | Seed 2: ATT = 2.3841, SE = 2.2118, p = 0.29178
 SUBCAT_Antidepressiva_overige | Seed 3: ATT = 2.2070, SE = 2.0157, p = 0.28444
 SUBCAT_Antidepressiva_overige | Seed 4: ATT = 2.1234, SE = 2.3645, p = 0.37809
 SUBCAT_Antidepressiva_overige | Seed 5: ATT = 2.2061, SE = 2.0192, p = 0.28544
 SUBCAT_Antidepressiva_overige | Seed 6: ATT = 2.1143, SE = 2.1108, p = 0.32650
 SUBCAT_Antidepressiva_overige | Seed 7: ATT = 2.2430, SE = 1.7498, p = 0.21213
 SUBCAT_Antidepressiva_overige | Seed 8: ATT = 2.2101, SE = 1.9341, p = 0.26442
 SUBCAT_Antidepressiva_overige | Seed 9: ATT = 2.2909, SE = 2.1870, p = 0.30529
 SUBCAT_Antidepressiva_overige | Seed 10: ATT = 2.0978, SE = 1.7722, p = 0.24809
 Diagnostic plots saved for SUBCAT_Antidepressiva_overige
 Best result for SUBCAT_Antidepressiva_overige  Seed 1 | SE = 1.6217

 Running XGBoost for SUBCAT_Systemische_antihistaminica
 SUBCAT_Systemische_antihistaminica | Seed 1: ATT = 0.7615, SE = 2.0489, p = 0.71340
 SUBCAT_Systemische_antihistaminica | Seed 2: ATT = 0.7586, SE = 1.3301, p = 0.57374
 SUBCAT_Systemische_antihistaminica | Seed 3: ATT = 0.8844, SE = 1.3225, p = 0.51008
 SUBCAT_Systemische_antihistaminica | Seed 4: ATT = 0.6090, SE = 1.4631, p = 0.68094
 SUBCAT_Systemische_antihistaminica | Seed 5: ATT = 0.7006, SE = 1.3674, p = 0.61306
 SUBCAT_Systemische_antihistaminica | Seed 6: ATT = 0.8417, SE = 1.3444, p = 0.53718
 SUBCAT_Systemische_antihistaminica | Seed 7: ATT = 0.7604, SE = 1.3913, p = 0.58976
 SUBCAT_Systemische_antihistaminica | Seed 8: ATT = 0.8257, SE = 1.5255, p = 0.59330
 SUBCAT_Systemische_antihistaminica | Seed 9: ATT = 0.4784, SE = 1.1326, p = 0.67653
 SUBCAT_Systemische_antihistaminica | Seed 10: ATT = 0.5472, SE = 1.7676, p = 0.75954
 Diagnostic plots saved for SUBCAT_Systemische_antihistaminica
 Best result for SUBCAT_Systemische_antihistaminica  Seed 9 | SE = 1.1326

 Running XGBoost for SUBCAT_anxiolytica_Benzodiazepine
 SUBCAT_anxiolytica_Benzodiazepine | Seed 1: ATT = 0.5913, SE = 0.7964, p = 0.46502
 SUBCAT_anxiolytica_Benzodiazepine | Seed 2: ATT = 0.5444, SE = 0.7987, p = 0.50201
 SUBCAT_anxiolytica_Benzodiazepine | Seed 3: ATT = 0.6334, SE = 0.7986, p = 0.43551
 SUBCAT_anxiolytica_Benzodiazepine | Seed 4: ATT = 0.6370, SE = 0.7372, p = 0.39610
 SUBCAT_anxiolytica_Benzodiazepine | Seed 5: ATT = 0.5873, SE = 0.7461, p = 0.43891
 SUBCAT_anxiolytica_Benzodiazepine | Seed 6: ATT = 0.5816, SE = 0.7493, p = 0.44527
 SUBCAT_anxiolytica_Benzodiazepine | Seed 7: ATT = 0.5995, SE = 0.7226, p = 0.41490
 SUBCAT_anxiolytica_Benzodiazepine | Seed 8: ATT = 0.6345, SE = 0.7373, p = 0.39802
 SUBCAT_anxiolytica_Benzodiazepine | Seed 9: ATT = 0.6145, SE = 0.7440, p = 0.41696
 SUBCAT_anxiolytica_Benzodiazepine | Seed 10: ATT = 0.6114, SE = 0.7675, p = 0.43351
 Diagnostic plots saved for SUBCAT_anxiolytica_Benzodiazepine
 Best result for SUBCAT_anxiolytica_Benzodiazepine  Seed 7 | SE = 0.7226

 Running XGBoost for SUBCAT_hypnotica_Benzodiazepine
 SUBCAT_hypnotica_Benzodiazepine | Seed 1: ATT = -0.5967, SE = 1.1729, p = 0.61555
 SUBCAT_hypnotica_Benzodiazepine | Seed 2: ATT = -0.5229, SE = 1.2645, p = 0.68292
 SUBCAT_hypnotica_Benzodiazepine | Seed 3: ATT = -0.5680, SE = 0.9964, p = 0.57395
 SUBCAT_hypnotica_Benzodiazepine | Seed 4: ATT = -0.5468, SE = 1.1616, p = 0.64210
 SUBCAT_hypnotica_Benzodiazepine | Seed 5: ATT = -0.6749, SE = 1.1510, p = 0.56312
 SUBCAT_hypnotica_Benzodiazepine | Seed 6: ATT = -0.6709, SE = 1.2511, p = 0.59671
 SUBCAT_hypnotica_Benzodiazepine | Seed 7: ATT = -0.5701, SE = 1.2313, p = 0.64752
 SUBCAT_hypnotica_Benzodiazepine | Seed 8: ATT = -0.5809, SE = 1.1719, p = 0.62463
 SUBCAT_hypnotica_Benzodiazepine | Seed 9: ATT = -0.6017, SE = 1.1448, p = 0.60397
 SUBCAT_hypnotica_Benzodiazepine | Seed 10: ATT = -0.6602, SE = 1.3247, p = 0.62275
 Diagnostic plots saved for SUBCAT_hypnotica_Benzodiazepine
 Best result for SUBCAT_hypnotica_Benzodiazepine  Seed 3 | SE = 0.9964

 Running XGBoost for SUBCAT_Amfetaminen
 SUBCAT_Amfetaminen | Seed 1: ATT = 2.8473, SE = 1.9825, p = 0.16386
 SUBCAT_Amfetaminen | Seed 2: ATT = 3.0475, SE = 1.9651, p = 0.13403
 SUBCAT_Amfetaminen | Seed 3: ATT = 2.9085, SE = 2.3980, p = 0.23697
 SUBCAT_Amfetaminen | Seed 4: ATT = 2.9915, SE = 2.2834, p = 0.20255
 SUBCAT_Amfetaminen | Seed 5: ATT = 2.8083, SE = 1.9725, p = 0.16740
 SUBCAT_Amfetaminen | Seed 6: ATT = 2.9731, SE = 2.2494, p = 0.19873
 SUBCAT_Amfetaminen | Seed 7: ATT = 3.0606, SE = 2.1569, p = 0.16876
 SUBCAT_Amfetaminen | Seed 8: ATT = 2.8773, SE = 2.3521, p = 0.23310
 SUBCAT_Amfetaminen | Seed 9: ATT = 2.9991, SE = 2.0723, p = 0.16077
 SUBCAT_Amfetaminen | Seed 10: ATT = 2.9529, SE = 1.7397, p = 0.10257
 Diagnostic plots saved for SUBCAT_Amfetaminen
 Best result for SUBCAT_Amfetaminen  Seed 10 | SE = 1.7397

 Running XGBoost for SUBCAT_Paracetamol_mono
 SUBCAT_Paracetamol_mono | Seed 1: ATT = 1.3167, SE = 2.2934, p = 0.57121
 SUBCAT_Paracetamol_mono | Seed 2: ATT = 1.5294, SE = 2.7448, p = 0.58254
 SUBCAT_Paracetamol_mono | Seed 3: ATT = 1.2618, SE = 2.5283, p = 0.62227
 SUBCAT_Paracetamol_mono | Seed 4: ATT = 1.4966, SE = 2.3570, p = 0.53146
 SUBCAT_Paracetamol_mono | Seed 5: ATT = 1.4246, SE = 2.4743, p = 0.57014
 SUBCAT_Paracetamol_mono | Seed 6: ATT = 1.1908, SE = 2.2429, p = 0.60035
 SUBCAT_Paracetamol_mono | Seed 7: ATT = 1.3765, SE = 2.2047, p = 0.53830
 SUBCAT_Paracetamol_mono | Seed 8: ATT = 1.3630, SE = 2.5052, p = 0.59140
 SUBCAT_Paracetamol_mono | Seed 9: ATT = 1.6804, SE = 2.6162, p = 0.52677
 SUBCAT_Paracetamol_mono | Seed 10: ATT = 1.2644, SE = 2.2738, p = 0.58333
 Diagnostic plots saved for SUBCAT_Paracetamol_mono
 Best result for SUBCAT_Paracetamol_mono  Seed 7 | SE = 2.2047

 Running XGBoost for SUBCAT_Anti_epileptica_stemmingsstabilisatoren
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 1: ATT = 3.1349, SE = 2.0671, p = 0.14244
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 2: ATT = 3.4130, SE = 2.3589, p = 0.16087
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 3: ATT = 3.4091, SE = 2.3698, p = 0.16320
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 4: ATT = 3.4183, SE = 2.1390, p = 0.12311
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 5: ATT = 3.5255, SE = 2.0879, p = 0.10426
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 6: ATT = 3.2613, SE = 2.8732, p = 0.26754
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 7: ATT = 3.1568, SE = 2.1620, p = 0.15721
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 8: ATT = 3.2859, SE = 2.3924, p = 0.18229
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 9: ATT = 3.3504, SE = 2.5942, p = 0.20884
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 10: ATT = 3.3486, SE = 2.8053, p = 0.24428
 Diagnostic plots saved for SUBCAT_Anti_epileptica_stemmingsstabilisatoren
 Best result for SUBCAT_Anti_epileptica_stemmingsstabilisatoren  Seed 1 | SE = 2.0671

 Running XGBoost for SUBCAT_Opioden
 SUBCAT_Opioden | Seed 1: ATT = 1.6252, SE = 2.4072, p = 0.50603
 SUBCAT_Opioden | Seed 2: ATT = 1.6932, SE = 1.8996, p = 0.38161
 SUBCAT_Opioden | Seed 3: ATT = 1.6778, SE = 1.8693, p = 0.37834
 SUBCAT_Opioden | Seed 4: ATT = 1.8805, SE = 1.7173, p = 0.28436
 SUBCAT_Opioden | Seed 5: ATT = 1.6580, SE = 1.5364, p = 0.29125
 SUBCAT_Opioden | Seed 6: ATT = 1.6938, SE = 1.9012, p = 0.38182
 SUBCAT_Opioden | Seed 7: ATT = 1.8555, SE = 1.9502, p = 0.35084
 SUBCAT_Opioden | Seed 8: ATT = 1.4915, SE = 1.9542, p = 0.45277
 SUBCAT_Opioden | Seed 9: ATT = 1.5180, SE = 1.5607, p = 0.34043
 SUBCAT_Opioden | Seed 10: ATT = 1.4408, SE = 1.7056, p = 0.40659
 Diagnostic plots saved for SUBCAT_Opioden
 Best result for SUBCAT_Opioden  Seed 5 | SE = 1.5364

 Running XGBoost for SUBCAT_Z_drugs
 SUBCAT_Z_drugs | Seed 1: ATT = 4.4883, SE = 1.7254, p = 0.01566
 SUBCAT_Z_drugs | Seed 2: ATT = 4.6155, SE = 2.0635, p = 0.03486
 SUBCAT_Z_drugs | Seed 3: ATT = 4.6152, SE = 2.0963, p = 0.03755
 SUBCAT_Z_drugs | Seed 4: ATT = 4.9237, SE = 1.8979, p = 0.01591
 SUBCAT_Z_drugs | Seed 5: ATT = 4.4150, SE = 2.0102, p = 0.03798
 SUBCAT_Z_drugs | Seed 6: ATT = 4.4812, SE = 2.1615, p = 0.04906
 SUBCAT_Z_drugs | Seed 7: ATT = 4.7137, SE = 1.8468, p = 0.01748
 SUBCAT_Z_drugs | Seed 8: ATT = 4.6923, SE = 2.0958, p = 0.03470
 SUBCAT_Z_drugs | Seed 9: ATT = 4.4653, SE = 2.0358, p = 0.03821
 SUBCAT_Z_drugs | Seed 10: ATT = 4.7464, SE = 2.1316, p = 0.03561
 Diagnostic plots saved for SUBCAT_Z_drugs
 Best result for SUBCAT_Z_drugs  Seed 1 | SE = 1.7254

 Running XGBoost for SUBCAT_NSAIDs
 SUBCAT_NSAIDs | Seed 1: ATT = 0.1779, SE = 1.7289, p = 0.91889
 SUBCAT_NSAIDs | Seed 2: ATT = 0.3865, SE = 1.5601, p = 0.80646
 SUBCAT_NSAIDs | Seed 3: ATT = 0.2973, SE = 2.0921, p = 0.88819
 SUBCAT_NSAIDs | Seed 4: ATT = 0.2822, SE = 1.5494, p = 0.85701
 SUBCAT_NSAIDs | Seed 5: ATT = 0.1655, SE = 1.6655, p = 0.92167
 SUBCAT_NSAIDs | Seed 6: ATT = 0.4503, SE = 1.8941, p = 0.81410
 SUBCAT_NSAIDs | Seed 7: ATT = 0.0548, SE = 2.0731, p = 0.97915
 SUBCAT_NSAIDs | Seed 8: ATT = 0.0384, SE = 1.6661, p = 0.98180
 SUBCAT_NSAIDs | Seed 9: ATT = 0.0449, SE = 1.4769, p = 0.97600
 SUBCAT_NSAIDs | Seed 10: ATT = 0.2776, SE = 1.4993, p = 0.85466
 Diagnostic plots saved for SUBCAT_NSAIDs
 Best result for SUBCAT_NSAIDs  Seed 9 | SE = 1.4769

 All summary files saved.
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=7e354a90-c1e2-491d-9a6a-28dc4ac2cf12">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[156]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Unweighted:</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=3e72bfe5-59ae-4ce7-bda2-80909a87b90f">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[157]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">GradientBoostingRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">r2_score</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">KFold</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">t</span><span class="p">,</span> <span class="n">probplot</span>
<span class="kn">import</span> <span class="nn">xgboost</span> <span class="k">as</span> <span class="nn">xgb</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Configuration</span>
<span class="c1"># -----------------------------</span>
<span class="n">n_repeats</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">seeds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span>
<span class="n">imputations</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">output_folder</span> <span class="o">=</span> <span class="s2">"outputs"</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Diagnostic Plotting Function</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">create_diagnostic_plots</span><span class="p">(</span><span class="n">residuals_data</span><span class="p">,</span> <span class="n">fitted_data</span><span class="p">,</span> <span class="n">group_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Create 4 diagnostic plots for model validation"""</span>
    <span class="n">plots_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"plots"</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">plots_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Flatten the collected data</span>
    <span class="n">all_residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">residuals_data</span><span class="p">)</span>
    <span class="n">all_fitted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">fitted_data</span><span class="p">)</span>
    
    <span class="c1"># Create figure with 2x2 subplots</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Diagnostic Plots - </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">'bold'</span><span class="p">)</span>
    
    <span class="c1"># 1. Residuals vs Fitted</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">all_fitted</span><span class="p">,</span> <span class="n">all_residuals</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Fitted Values'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Residuals'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Residuals vs Fitted'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># 2. QQ Plot</span>
    <span class="n">probplot</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s2">"norm"</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Q-Q Plot (Normal)'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># 3. Residual Histogram</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'skyblue'</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">'black'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Residuals'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Density'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Residual Distribution'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># 4. Scale-Location Plot</span>
    <span class="n">sqrt_abs_residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">))</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">all_fitted</span><span class="p">,</span> <span class="n">sqrt_abs_residuals</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Fitted Values'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'|Residuals|'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Scale-Location Plot'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    
    <span class="c1"># Save plot</span>
    <span class="n">plot_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plots_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s1">_unweighted.png'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_filename</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">'tight'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Diagnostic plots saved for </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Rubin's Rule</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">rubins_pool</span><span class="p">(</span><span class="n">estimates</span><span class="p">,</span> <span class="n">ses</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">estimates</span><span class="p">)</span>
    <span class="n">q_bar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">estimates</span><span class="p">)</span>
    <span class="n">u_bar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">ses</span><span class="p">))</span>
    <span class="n">b_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">estimates</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">total_var</span> <span class="o">=</span> <span class="n">u_bar</span> <span class="o">+</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">b_m</span><span class="p">)</span>
    <span class="n">total_se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">total_var</span><span class="p">)</span>
    <span class="n">ci_lower</span> <span class="o">=</span> <span class="n">q_bar</span> <span class="o">-</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">total_se</span>
    <span class="n">ci_upper</span> <span class="o">=</span> <span class="n">q_bar</span> <span class="o">+</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">total_se</span>
    <span class="n">p_value</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">q_bar</span> <span class="o">/</span> <span class="n">total_se</span><span class="p">),</span> <span class="n">df</span><span class="o">=</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">rounded_p</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">p_value</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">formatted_p</span> <span class="o">=</span> <span class="s2">"&lt; 0.00001"</span> <span class="k">if</span> <span class="n">rounded_p</span> <span class="o">&lt;=</span> <span class="mf">0.00001</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">rounded_p</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">return</span> <span class="n">q_bar</span><span class="p">,</span> <span class="n">total_se</span><span class="p">,</span> <span class="n">ci_lower</span><span class="p">,</span> <span class="n">ci_upper</span><span class="p">,</span> <span class="n">formatted_p</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># SMD + Variance Ratio</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">calculate_smd_vr</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
    <span class="n">treated</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">control</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">smd</span><span class="p">,</span> <span class="n">vr</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m1</span><span class="p">,</span> <span class="n">m0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">treated</span><span class="p">[</span><span class="n">col</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">control</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
            <span class="n">s1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">treated</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
            <span class="n">s0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">control</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
            <span class="n">pooled_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">s1</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">s0</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">smd</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">m1</span> <span class="o">-</span> <span class="n">m0</span><span class="p">)</span> <span class="o">/</span> <span class="n">pooled_sd</span> <span class="k">if</span> <span class="n">pooled_sd</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">vr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s1</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">s0</span><span class="o">**</span><span class="mi">2</span> <span class="k">if</span> <span class="n">s0</span><span class="o">**</span><span class="mi">2</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">smd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">vr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">smd</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">vr</span><span class="p">)</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># XGBoost Main Loop (No DML)</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">run_xgboost_with_trimmed_data</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="p">):</span>
    <span class="n">att_results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">balance_results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">covariates</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Running XGBoost for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">group_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">group_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">best_result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">best_se</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">"inf"</span><span class="p">)</span>
        
        <span class="c1"># Initialize lists to collect residuals and fitted values for diagnostic plots</span>
        <span class="n">group_residuals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">group_fitted</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="n">seeds</span><span class="p">:</span>
            <span class="n">att_list</span><span class="p">,</span> <span class="n">se_list</span><span class="p">,</span> <span class="n">r2_list</span><span class="p">,</span> <span class="n">rmse_list</span><span class="p">,</span> <span class="n">smd_list</span><span class="p">,</span> <span class="n">vr_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">imp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">imputations</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"trimmed_data_imp</span><span class="si">{</span><span class="n">imp</span><span class="si">}</span><span class="s2">.pkl"</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">or</span> <span class="s2">"iptw"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">T</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
                <span class="n">Y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">"caps5_change_baseline"</span><span class="p">]</span>
                <span class="c1">#W = df["iptw"]</span>

                <span class="k">for</span> <span class="n">repeat</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_repeats</span><span class="p">):</span>
                    <span class="n">kf</span> <span class="o">=</span> <span class="n">KFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span> <span class="o">+</span> <span class="n">repeat</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">train_idx</span><span class="p">,</span> <span class="n">test_idx</span> <span class="ow">in</span> <span class="n">kf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">X_train</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">]</span>
                            <span class="n">T_train</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">]</span>
                            <span class="n">Y_train</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">]</span>
                            

                            <span class="c1"># XGBoost regression model</span>
                            <span class="n">model</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
                            
                            <span class="c1"># Add treatment variable to features</span>
                            <span class="n">X_train_with_T</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                            <span class="n">X_train_with_T</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_train</span>
                            
                            <span class="c1"># Fit model</span>
                            <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_with_T</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">)</span>
                            
                            <span class="c1"># Predict outcomes for treated and control groups</span>
                            <span class="n">X_treated</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                            <span class="n">X_treated</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="n">X_control</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                            <span class="n">X_control</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                            
                            <span class="n">Y_pred_treated</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_treated</span><span class="p">)</span>
                            <span class="n">Y_pred_control</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_control</span><span class="p">)</span>
                            
                            <span class="c1"># Calculate ATT (Average Treatment Effect on Treated)</span>
                            <span class="n">treated_mask</span> <span class="o">=</span> <span class="n">T_train</span> <span class="o">==</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">treated_mask</span><span class="p">):</span>
                                <span class="n">att</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Y_pred_treated</span><span class="p">[</span><span class="n">treated_mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">Y_pred_control</span><span class="p">[</span><span class="n">treated_mask</span><span class="p">])</span>
                                
                                <span class="c1"># Calculate standard error (approximate)</span>
                                <span class="n">treatment_effects</span> <span class="o">=</span> <span class="n">Y_pred_treated</span><span class="p">[</span><span class="n">treated_mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">Y_pred_control</span><span class="p">[</span><span class="n">treated_mask</span><span class="p">]</span>
                                <span class="n">residual</span> <span class="o">=</span> <span class="n">treatment_effects</span> <span class="o">-</span> <span class="n">att</span>
                                <span class="n">se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">residual</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">treated_mask</span><span class="p">)</span>
                                <span class="n">att_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">att</span><span class="p">)</span>
                                <span class="n">se_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">se</span><span class="p">)</span>

                            <span class="c1"># Model performance metrics</span>
                            <span class="n">Y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train_with_T</span><span class="p">)</span>
                            <span class="n">residuals</span> <span class="o">=</span> <span class="n">Y_train</span> <span class="o">-</span> <span class="n">Y_pred</span>
                            <span class="n">rmse</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_pred</span><span class="p">,</span> <span class="n">squared</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                            <span class="n">r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_pred</span><span class="p">)</span>
                            <span class="n">r2_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
                            <span class="n">rmse_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rmse</span><span class="p">)</span>
                            
                            <span class="c1"># Collect residuals and fitted values for diagnostic plots</span>
                            <span class="n">group_residuals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">residuals</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                            <span class="n">group_fitted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Y_pred</span><span class="p">)</span>

                            <span class="n">smd</span><span class="p">,</span> <span class="n">vr</span> <span class="o">=</span> <span class="n">calculate_smd_vr</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">T_train</span><span class="p">)</span>
                            <span class="n">smd_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smd</span><span class="p">)</span>
                            <span class="n">vr_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vr</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">, seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">, imp </span><span class="si">{</span><span class="n">imp</span><span class="si">}</span><span class="s2">, rep </span><span class="si">{</span><span class="n">repeat</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">att_list</span><span class="p">:</span>
                <span class="n">att</span><span class="p">,</span> <span class="n">se</span><span class="p">,</span> <span class="n">ci_l</span><span class="p">,</span> <span class="n">ci_u</span><span class="p">,</span> <span class="n">p_val</span> <span class="o">=</span> <span class="n">rubins_pool</span><span class="p">(</span><span class="n">att_list</span><span class="p">,</span> <span class="n">se_list</span><span class="p">)</span>
                <span class="n">avg_r2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">r2_list</span><span class="p">)</span>
                <span class="n">avg_rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rmse_list</span><span class="p">)</span>
                <span class="n">avg_smd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">smd_list</span><span class="p">)</span>
                <span class="n">avg_vr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">vr_list</span><span class="p">)</span>

                <span class="n">balance_results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">"group"</span><span class="p">:</span> <span class="n">group</span><span class="p">,</span> <span class="s2">"seed"</span><span class="p">:</span> <span class="n">seed</span><span class="p">,</span> <span class="s2">"smd"</span><span class="p">:</span> <span class="n">avg_smd</span><span class="p">,</span> <span class="s2">"vr"</span><span class="p">:</span> <span class="n">avg_vr</span>
                <span class="p">})</span>

                <span class="k">if</span> <span class="n">se</span> <span class="o">&lt;</span> <span class="n">best_se</span><span class="p">:</span>
                    <span class="n">best_se</span> <span class="o">=</span> <span class="n">se</span>
                    <span class="n">best_result</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">"group"</span><span class="p">:</span> <span class="n">group</span><span class="p">,</span> <span class="s2">"seed"</span><span class="p">:</span> <span class="n">seed</span><span class="p">,</span> <span class="s2">"att"</span><span class="p">:</span> <span class="n">att</span><span class="p">,</span> <span class="s2">"se"</span><span class="p">:</span> <span class="n">se</span><span class="p">,</span>
                        <span class="s2">"ci_lower"</span><span class="p">:</span> <span class="n">ci_l</span><span class="p">,</span> <span class="s2">"ci_upper"</span><span class="p">:</span> <span class="n">ci_u</span><span class="p">,</span> <span class="s2">"p_value"</span><span class="p">:</span> <span class="n">p_val</span><span class="p">,</span>
                        <span class="s2">"r2"</span><span class="p">:</span> <span class="n">avg_r2</span><span class="p">,</span> <span class="s2">"rmse"</span><span class="p">:</span> <span class="n">avg_rmse</span>
                    <span class="p">}</span>

                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> | Seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">: ATT = </span><span class="si">{</span><span class="n">att</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, SE = </span><span class="si">{</span><span class="n">se</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, p = </span><span class="si">{</span><span class="n">p_val</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No valid results for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> | Seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Create diagnostic plots for this group</span>
        <span class="k">if</span> <span class="n">group_residuals</span> <span class="ow">and</span> <span class="n">group_fitted</span><span class="p">:</span>
            <span class="n">create_diagnostic_plots</span><span class="p">(</span><span class="n">group_residuals</span><span class="p">,</span> <span class="n">group_fitted</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">best_result</span><span class="p">:</span>
            <span class="n">att_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">best_result</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Best result for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">  Seed </span><span class="si">{</span><span class="n">best_result</span><span class="p">[</span><span class="s1">'seed'</span><span class="p">]</span><span class="si">}</span><span class="s2"> | SE = </span><span class="si">{</span><span class="n">best_result</span><span class="p">[</span><span class="s1">'se'</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="c1"># Save final output</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">att_results</span><span class="p">)</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">"xgb_rubin_summary_subcats_unweighted.xlsx"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">balance_results</span><span class="p">)</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">"smd_vr_summary_subcats_unweighted.xlsx"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> All summary files saved."</span><span class="p">)</span>

<span class="n">run_xgboost_with_trimmed_data</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Running XGBoost for SUBCAT_Antipsychotica_atypisch
 SUBCAT_Antipsychotica_atypisch | Seed 1: ATT = -0.6518, SE = 2.0419, p = 0.75232
 SUBCAT_Antipsychotica_atypisch | Seed 2: ATT = -0.9624, SE = 1.4914, p = 0.52486
 SUBCAT_Antipsychotica_atypisch | Seed 3: ATT = -0.6041, SE = 1.5713, p = 0.70403
 SUBCAT_Antipsychotica_atypisch | Seed 4: ATT = -0.8957, SE = 2.0290, p = 0.66285
 SUBCAT_Antipsychotica_atypisch | Seed 5: ATT = -0.8422, SE = 1.9465, p = 0.66911
 SUBCAT_Antipsychotica_atypisch | Seed 6: ATT = -1.1004, SE = 2.2366, p = 0.62720
 SUBCAT_Antipsychotica_atypisch | Seed 7: ATT = -0.7453, SE = 1.8420, p = 0.68934
 SUBCAT_Antipsychotica_atypisch | Seed 8: ATT = -0.7859, SE = 1.7412, p = 0.65580
 SUBCAT_Antipsychotica_atypisch | Seed 9: ATT = -0.8629, SE = 2.6222, p = 0.74497
 SUBCAT_Antipsychotica_atypisch | Seed 10: ATT = -1.1860, SE = 2.1617, p = 0.58832
 Diagnostic plots saved for SUBCAT_Antipsychotica_atypisch
 Best result for SUBCAT_Antipsychotica_atypisch  Seed 2 | SE = 1.4914

 Running XGBoost for SUBCAT_TCA
 SUBCAT_TCA | Seed 1: ATT = 2.2467, SE = 1.1176, p = 0.05576
 SUBCAT_TCA | Seed 2: ATT = 2.3489, SE = 1.2469, p = 0.07177
 SUBCAT_TCA | Seed 3: ATT = 2.3164, SE = 1.0688, p = 0.04037
 SUBCAT_TCA | Seed 4: ATT = 2.2354, SE = 1.1845, p = 0.07128
 SUBCAT_TCA | Seed 5: ATT = 2.4270, SE = 1.0046, p = 0.02367
 SUBCAT_TCA | Seed 6: ATT = 2.3668, SE = 1.2427, p = 0.06890
 SUBCAT_TCA | Seed 7: ATT = 2.3150, SE = 1.2119, p = 0.06813
 SUBCAT_TCA | Seed 8: ATT = 2.2655, SE = 1.3358, p = 0.10283
 SUBCAT_TCA | Seed 9: ATT = 2.2495, SE = 1.2531, p = 0.08523
 SUBCAT_TCA | Seed 10: ATT = 2.3283, SE = 0.9758, p = 0.02527
 Diagnostic plots saved for SUBCAT_TCA
 Best result for SUBCAT_TCA  Seed 10 | SE = 0.9758

 Running XGBoost for SUBCAT_SSRI
 SUBCAT_SSRI | Seed 1: ATT = 0.2086, SE = 0.2459, p = 0.40479
 SUBCAT_SSRI | Seed 2: ATT = 0.2325, SE = 0.3244, p = 0.48046
 SUBCAT_SSRI | Seed 3: ATT = 0.2274, SE = 0.3878, p = 0.56298
 SUBCAT_SSRI | Seed 4: ATT = 0.1996, SE = 0.3767, p = 0.60098
 SUBCAT_SSRI | Seed 5: ATT = 0.1342, SE = 0.3468, p = 0.70213
 SUBCAT_SSRI | Seed 6: ATT = 0.2276, SE = 0.2774, p = 0.42018
 SUBCAT_SSRI | Seed 7: ATT = 0.2187, SE = 0.3280, p = 0.51122
 SUBCAT_SSRI | Seed 8: ATT = 0.2076, SE = 0.3151, p = 0.51635
 SUBCAT_SSRI | Seed 9: ATT = 0.2793, SE = 0.3963, p = 0.48770
 SUBCAT_SSRI | Seed 10: ATT = 0.2153, SE = 0.3407, p = 0.53343
 Diagnostic plots saved for SUBCAT_SSRI
 Best result for SUBCAT_SSRI  Seed 1 | SE = 0.2459

 Running XGBoost for SUBCAT_SNRI
 SUBCAT_SNRI | Seed 1: ATT = 3.0641, SE = 1.8645, p = 0.11334
 SUBCAT_SNRI | Seed 2: ATT = 3.2252, SE = 1.6305, p = 0.05952
 SUBCAT_SNRI | Seed 3: ATT = 3.1145, SE = 1.7076, p = 0.08065
 SUBCAT_SNRI | Seed 4: ATT = 3.0608, SE = 1.5839, p = 0.06519
 SUBCAT_SNRI | Seed 5: ATT = 3.0239, SE = 1.3367, p = 0.03301
 SUBCAT_SNRI | Seed 6: ATT = 3.0128, SE = 1.5395, p = 0.06208
 SUBCAT_SNRI | Seed 7: ATT = 3.1160, SE = 1.7684, p = 0.09079
 SUBCAT_SNRI | Seed 8: ATT = 3.1702, SE = 1.5708, p = 0.05488
 SUBCAT_SNRI | Seed 9: ATT = 3.0567, SE = 1.5388, p = 0.05852
 SUBCAT_SNRI | Seed 10: ATT = 3.1382, SE = 1.4952, p = 0.04654
 Diagnostic plots saved for SUBCAT_SNRI
 Best result for SUBCAT_SNRI  Seed 5 | SE = 1.3367

 Running XGBoost for SUBCAT_Tetracyclische_antidepressiva
 SUBCAT_Tetracyclische_antidepressiva | Seed 1: ATT = 5.7911, SE = 1.8495, p = 0.00453
 SUBCAT_Tetracyclische_antidepressiva | Seed 2: ATT = 5.8245, SE = 2.0462, p = 0.00891
 SUBCAT_Tetracyclische_antidepressiva | Seed 3: ATT = 5.8673, SE = 1.8981, p = 0.00499
 SUBCAT_Tetracyclische_antidepressiva | Seed 4: ATT = 5.9391, SE = 1.5627, p = 0.00087
 SUBCAT_Tetracyclische_antidepressiva | Seed 5: ATT = 5.9885, SE = 1.5675, p = 0.00083
 SUBCAT_Tetracyclische_antidepressiva | Seed 6: ATT = 5.8928, SE = 1.8661, p = 0.00425
 SUBCAT_Tetracyclische_antidepressiva | Seed 7: ATT = 5.9749, SE = 1.4899, p = 0.00051
 SUBCAT_Tetracyclische_antidepressiva | Seed 8: ATT = 5.7346, SE = 2.0138, p = 0.00889
 SUBCAT_Tetracyclische_antidepressiva | Seed 9: ATT = 5.6834, SE = 1.8340, p = 0.00490
 SUBCAT_Tetracyclische_antidepressiva | Seed 10: ATT = 5.6171, SE = 1.5726, p = 0.00154
 Diagnostic plots saved for SUBCAT_Tetracyclische_antidepressiva
 Best result for SUBCAT_Tetracyclische_antidepressiva  Seed 7 | SE = 1.4899

 Running XGBoost for SUBCAT_Antidepressiva_overige
 SUBCAT_Antidepressiva_overige | Seed 1: ATT = 2.4530, SE = 1.9900, p = 0.22963
 SUBCAT_Antidepressiva_overige | Seed 2: ATT = 2.7042, SE = 2.2681, p = 0.24482
 SUBCAT_Antidepressiva_overige | Seed 3: ATT = 2.4556, SE = 2.3474, p = 0.30595
 SUBCAT_Antidepressiva_overige | Seed 4: ATT = 2.4178, SE = 2.6751, p = 0.37508
 SUBCAT_Antidepressiva_overige | Seed 5: ATT = 2.4640, SE = 2.3812, p = 0.31108
 SUBCAT_Antidepressiva_overige | Seed 6: ATT = 2.5173, SE = 2.3867, p = 0.30206
 SUBCAT_Antidepressiva_overige | Seed 7: ATT = 2.6255, SE = 2.0543, p = 0.21345
 SUBCAT_Antidepressiva_overige | Seed 8: ATT = 2.5815, SE = 2.2186, p = 0.25604
 SUBCAT_Antidepressiva_overige | Seed 9: ATT = 2.6589, SE = 2.2969, p = 0.25841
 SUBCAT_Antidepressiva_overige | Seed 10: ATT = 2.5367, SE = 2.0578, p = 0.22963
 Diagnostic plots saved for SUBCAT_Antidepressiva_overige
 Best result for SUBCAT_Antidepressiva_overige  Seed 1 | SE = 1.9900

 Running XGBoost for SUBCAT_Systemische_antihistaminica
 SUBCAT_Systemische_antihistaminica | Seed 1: ATT = 1.6965, SE = 2.1834, p = 0.44475
 SUBCAT_Systemische_antihistaminica | Seed 2: ATT = 1.7117, SE = 1.4376, p = 0.24541
 SUBCAT_Systemische_antihistaminica | Seed 3: ATT = 1.8448, SE = 1.5703, p = 0.25162
 SUBCAT_Systemische_antihistaminica | Seed 4: ATT = 1.4946, SE = 1.5597, p = 0.34747
 SUBCAT_Systemische_antihistaminica | Seed 5: ATT = 1.8345, SE = 1.7118, p = 0.29450
 SUBCAT_Systemische_antihistaminica | Seed 6: ATT = 1.8217, SE = 1.5812, p = 0.26061
 SUBCAT_Systemische_antihistaminica | Seed 7: ATT = 1.5769, SE = 1.9483, p = 0.42624
 SUBCAT_Systemische_antihistaminica | Seed 8: ATT = 1.7147, SE = 1.6061, p = 0.29634
 SUBCAT_Systemische_antihistaminica | Seed 9: ATT = 1.5616, SE = 1.4644, p = 0.29686
 SUBCAT_Systemische_antihistaminica | Seed 10: ATT = 1.4696, SE = 1.7345, p = 0.40520
 Diagnostic plots saved for SUBCAT_Systemische_antihistaminica
 Best result for SUBCAT_Systemische_antihistaminica  Seed 2 | SE = 1.4376

 Running XGBoost for SUBCAT_anxiolytica_Benzodiazepine
 SUBCAT_anxiolytica_Benzodiazepine | Seed 1: ATT = 0.7005, SE = 0.6283, p = 0.27594
 SUBCAT_anxiolytica_Benzodiazepine | Seed 2: ATT = 0.7351, SE = 0.6055, p = 0.23653
 SUBCAT_anxiolytica_Benzodiazepine | Seed 3: ATT = 0.7039, SE = 0.5338, p = 0.19977
 SUBCAT_anxiolytica_Benzodiazepine | Seed 4: ATT = 0.7284, SE = 0.5930, p = 0.23121
 SUBCAT_anxiolytica_Benzodiazepine | Seed 5: ATT = 0.6644, SE = 0.5388, p = 0.22948
 SUBCAT_anxiolytica_Benzodiazepine | Seed 6: ATT = 0.6857, SE = 0.5696, p = 0.24044
 SUBCAT_anxiolytica_Benzodiazepine | Seed 7: ATT = 0.7265, SE = 0.5810, p = 0.22322
 SUBCAT_anxiolytica_Benzodiazepine | Seed 8: ATT = 0.7630, SE = 0.6264, p = 0.23503
 SUBCAT_anxiolytica_Benzodiazepine | Seed 9: ATT = 0.7143, SE = 0.5533, p = 0.20900
 SUBCAT_anxiolytica_Benzodiazepine | Seed 10: ATT = 0.6989, SE = 0.5544, p = 0.21953
 Diagnostic plots saved for SUBCAT_anxiolytica_Benzodiazepine
 Best result for SUBCAT_anxiolytica_Benzodiazepine  Seed 3 | SE = 0.5338

 Running XGBoost for SUBCAT_hypnotica_Benzodiazepine
 SUBCAT_hypnotica_Benzodiazepine | Seed 1: ATT = -0.8012, SE = 0.8022, p = 0.32784
 SUBCAT_hypnotica_Benzodiazepine | Seed 2: ATT = -0.7322, SE = 0.8935, p = 0.42058
 SUBCAT_hypnotica_Benzodiazepine | Seed 3: ATT = -0.7089, SE = 0.7035, p = 0.32369
 SUBCAT_hypnotica_Benzodiazepine | Seed 4: ATT = -0.8092, SE = 0.7407, p = 0.28551
 SUBCAT_hypnotica_Benzodiazepine | Seed 5: ATT = -0.7849, SE = 0.9199, p = 0.40199
 SUBCAT_hypnotica_Benzodiazepine | Seed 6: ATT = -0.8834, SE = 0.8900, p = 0.33081
 SUBCAT_hypnotica_Benzodiazepine | Seed 7: ATT = -0.8046, SE = 0.9423, p = 0.40159
 SUBCAT_hypnotica_Benzodiazepine | Seed 8: ATT = -0.7121, SE = 0.7698, p = 0.36416
 SUBCAT_hypnotica_Benzodiazepine | Seed 9: ATT = -0.7136, SE = 0.8456, p = 0.40704
 SUBCAT_hypnotica_Benzodiazepine | Seed 10: ATT = -0.8317, SE = 0.9739, p = 0.40157
 Diagnostic plots saved for SUBCAT_hypnotica_Benzodiazepine
 Best result for SUBCAT_hypnotica_Benzodiazepine  Seed 3 | SE = 0.7035

 Running XGBoost for SUBCAT_Amfetaminen
 SUBCAT_Amfetaminen | Seed 1: ATT = 0.7753, SE = 1.7732, p = 0.66587
 SUBCAT_Amfetaminen | Seed 2: ATT = 0.7822, SE = 1.7182, p = 0.65303
 SUBCAT_Amfetaminen | Seed 3: ATT = 0.8043, SE = 1.9774, p = 0.68780
 SUBCAT_Amfetaminen | Seed 4: ATT = 0.8033, SE = 1.7301, p = 0.64661
 SUBCAT_Amfetaminen | Seed 5: ATT = 0.6545, SE = 1.5259, p = 0.67181
 SUBCAT_Amfetaminen | Seed 6: ATT = 0.5794, SE = 1.5451, p = 0.71093
 SUBCAT_Amfetaminen | Seed 7: ATT = 0.7809, SE = 1.7725, p = 0.66348
 SUBCAT_Amfetaminen | Seed 8: ATT = 0.6817, SE = 1.7847, p = 0.70585
 SUBCAT_Amfetaminen | Seed 9: ATT = 0.7250, SE = 1.8724, p = 0.70204
 SUBCAT_Amfetaminen | Seed 10: ATT = 0.8364, SE = 1.5052, p = 0.58360
 Diagnostic plots saved for SUBCAT_Amfetaminen
 Best result for SUBCAT_Amfetaminen  Seed 10 | SE = 1.5052

 Running XGBoost for SUBCAT_Paracetamol_mono
 SUBCAT_Paracetamol_mono | Seed 1: ATT = 1.1099, SE = 2.3321, p = 0.63843
 SUBCAT_Paracetamol_mono | Seed 2: ATT = 1.5200, SE = 2.5011, p = 0.54908
 SUBCAT_Paracetamol_mono | Seed 3: ATT = 1.1555, SE = 2.4523, p = 0.64177
 SUBCAT_Paracetamol_mono | Seed 4: ATT = 1.2644, SE = 2.1225, p = 0.55694
 SUBCAT_Paracetamol_mono | Seed 5: ATT = 1.3599, SE = 2.4224, p = 0.57975
 SUBCAT_Paracetamol_mono | Seed 6: ATT = 1.1734, SE = 2.0125, p = 0.56527
 SUBCAT_Paracetamol_mono | Seed 7: ATT = 1.2068, SE = 2.2296, p = 0.59333
 SUBCAT_Paracetamol_mono | Seed 8: ATT = 1.2402, SE = 2.4402, p = 0.61592
 SUBCAT_Paracetamol_mono | Seed 9: ATT = 1.4779, SE = 2.6630, p = 0.58406
 SUBCAT_Paracetamol_mono | Seed 10: ATT = 1.1612, SE = 2.2465, p = 0.60997
 Diagnostic plots saved for SUBCAT_Paracetamol_mono
 Best result for SUBCAT_Paracetamol_mono  Seed 6 | SE = 2.0125

 Running XGBoost for SUBCAT_Anti_epileptica_stemmingsstabilisatoren
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 1: ATT = 3.6564, SE = 2.0168, p = 0.08236
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 2: ATT = 4.1219, SE = 2.2363, p = 0.07769
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 3: ATT = 4.0547, SE = 2.4483, p = 0.11071
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 4: ATT = 4.0751, SE = 2.0793, p = 0.06173
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 5: ATT = 4.0854, SE = 1.9793, p = 0.04998
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 6: ATT = 3.8769, SE = 2.9122, p = 0.19560
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 7: ATT = 4.1256, SE = 2.2520, p = 0.07939
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 8: ATT = 3.9695, SE = 2.4810, p = 0.12269
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 9: ATT = 3.9356, SE = 2.6844, p = 0.15560
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 10: ATT = 3.9852, SE = 2.3052, p = 0.09669
 Diagnostic plots saved for SUBCAT_Anti_epileptica_stemmingsstabilisatoren
 Best result for SUBCAT_Anti_epileptica_stemmingsstabilisatoren  Seed 5 | SE = 1.9793

 Running XGBoost for SUBCAT_Opioden
 SUBCAT_Opioden | Seed 1: ATT = 1.5236, SE = 2.3956, p = 0.53080
 SUBCAT_Opioden | Seed 2: ATT = 1.7836, SE = 1.7372, p = 0.31478
 SUBCAT_Opioden | Seed 3: ATT = 1.8287, SE = 1.8094, p = 0.32227
 SUBCAT_Opioden | Seed 4: ATT = 1.9864, SE = 1.7733, p = 0.27372
 SUBCAT_Opioden | Seed 5: ATT = 1.8329, SE = 1.6387, p = 0.27444
 SUBCAT_Opioden | Seed 6: ATT = 1.8095, SE = 1.7259, p = 0.30488
 SUBCAT_Opioden | Seed 7: ATT = 1.9543, SE = 1.9692, p = 0.33089
 SUBCAT_Opioden | Seed 8: ATT = 1.5198, SE = 1.7480, p = 0.39320
 SUBCAT_Opioden | Seed 9: ATT = 1.6666, SE = 1.4266, p = 0.25418
 SUBCAT_Opioden | Seed 10: ATT = 1.4959, SE = 1.7143, p = 0.39153
 Diagnostic plots saved for SUBCAT_Opioden
 Best result for SUBCAT_Opioden  Seed 9 | SE = 1.4266

 Running XGBoost for SUBCAT_Z_drugs
 SUBCAT_Z_drugs | Seed 1: ATT = 4.9974, SE = 1.8740, p = 0.01350
 SUBCAT_Z_drugs | Seed 2: ATT = 5.1104, SE = 2.0622, p = 0.02064
 SUBCAT_Z_drugs | Seed 3: ATT = 5.0258, SE = 2.0727, p = 0.02321
 SUBCAT_Z_drugs | Seed 4: ATT = 5.0790, SE = 2.0066, p = 0.01833
 SUBCAT_Z_drugs | Seed 5: ATT = 4.7027, SE = 2.1530, p = 0.03894
 SUBCAT_Z_drugs | Seed 6: ATT = 4.9990, SE = 2.2162, p = 0.03348
 SUBCAT_Z_drugs | Seed 7: ATT = 5.0100, SE = 1.8101, p = 0.01070
 SUBCAT_Z_drugs | Seed 8: ATT = 5.0717, SE = 1.9902, p = 0.01764
 SUBCAT_Z_drugs | Seed 9: ATT = 5.0630, SE = 2.1446, p = 0.02670
 SUBCAT_Z_drugs | Seed 10: ATT = 5.2677, SE = 2.2110, p = 0.02547
 Diagnostic plots saved for SUBCAT_Z_drugs
 Best result for SUBCAT_Z_drugs  Seed 7 | SE = 1.8101

 Running XGBoost for SUBCAT_NSAIDs
 SUBCAT_NSAIDs | Seed 1: ATT = 0.1120, SE = 1.9030, p = 0.95357
 SUBCAT_NSAIDs | Seed 2: ATT = 0.2923, SE = 1.7992, p = 0.87229
 SUBCAT_NSAIDs | Seed 3: ATT = 0.0139, SE = 2.3326, p = 0.99529
 SUBCAT_NSAIDs | Seed 4: ATT = 0.1627, SE = 1.6165, p = 0.92066
 SUBCAT_NSAIDs | Seed 5: ATT = 0.1832, SE = 1.7698, p = 0.91843
 SUBCAT_NSAIDs | Seed 6: ATT = 0.2289, SE = 1.8184, p = 0.90087
 SUBCAT_NSAIDs | Seed 7: ATT = -0.2260, SE = 1.9387, p = 0.90815
 SUBCAT_NSAIDs | Seed 8: ATT = 0.0403, SE = 1.6141, p = 0.98028
 SUBCAT_NSAIDs | Seed 9: ATT = 0.0269, SE = 1.4591, p = 0.98543
 SUBCAT_NSAIDs | Seed 10: ATT = 0.1598, SE = 1.6946, p = 0.92564
 Diagnostic plots saved for SUBCAT_NSAIDs
 Best result for SUBCAT_NSAIDs  Seed 9 | SE = 1.4591

 All summary files saved.
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=6d115ca6-36c5-48a5-b13c-4147a3a01119">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[158]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">sem</span><span class="p">,</span> <span class="n">ttest_ind</span>

<span class="c1"># ----------------------------------</span>
<span class="c1"># File paths</span>
<span class="c1"># ----------------------------------</span>
<span class="n">output_base</span> <span class="o">=</span> <span class="s2">"outputs"</span>
<span class="n">att_file</span> <span class="o">=</span> <span class="s2">"xgb_rubin_summary_subcats.xlsx"</span>
<span class="n">trimmed_file</span> <span class="o">=</span> <span class="s2">"trimmed_data_imp1.pkl"</span>
<span class="n">auc_file</span> <span class="o">=</span> <span class="s2">"auc_scores.xlsx"</span>  

<span class="c1"># ----------------------------------</span>
<span class="c1"># Load ATT Summary</span>
<span class="c1"># ----------------------------------</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">att_file</span><span class="p">):</span>
    <span class="n">att_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">att_file</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">" ATT summary file not found: xgb_rubin_summary_subcats.xlsx"</span><span class="p">)</span>

<span class="n">summary_rows</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># ----------------------------------</span>
<span class="c1"># Loop over medication groups</span>
<span class="c1"># ----------------------------------</span>
<span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">medication_groups</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">g</span><span class="p">))]</span>

<span class="k">for</span> <span class="n">med</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">group_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">med</span><span class="p">)</span>

        <span class="c1"># Load trimmed data</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="n">trimmed_file</span><span class="p">))</span>

        <span class="c1"># Detect treatment column</span>
        <span class="n">treatment_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">med</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">treatment_cols</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Treatment column </span><span class="si">{</span><span class="n">med</span><span class="si">}</span><span class="s2"> not found in trimmed data. Skipping."</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">treatment_var</span> <span class="o">=</span> <span class="n">treatment_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Extract treatment and outcome</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">"caps5_change_baseline"</span><span class="p">]</span>

        <span class="c1"># Treated and control stats</span>
        <span class="n">treated</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">control</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>

        <span class="n">mean_treat</span> <span class="o">=</span> <span class="n">treated</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">se_treat</span> <span class="o">=</span> <span class="n">sem</span><span class="p">(</span><span class="n">treated</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">treated</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">mean_ctrl</span> <span class="o">=</span> <span class="n">control</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">se_ctrl</span> <span class="o">=</span> <span class="n">sem</span><span class="p">(</span><span class="n">control</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">control</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Cohen's d (unadjusted)</span>
        <span class="n">pooled_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">treated</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">control</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">cohen_d</span> <span class="o">=</span> <span class="p">(</span><span class="n">mean_treat</span> <span class="o">-</span> <span class="n">mean_ctrl</span><span class="p">)</span> <span class="o">/</span> <span class="n">pooled_sd</span> <span class="k">if</span> <span class="n">pooled_sd</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># E-value (unadjusted)</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">mean_treat</span> <span class="o">-</span> <span class="n">mean_ctrl</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">delta</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">mean_ctrl</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">mean_ctrl</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Unadjusted p-value</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">t_stat</span><span class="p">,</span> <span class="n">p_val</span> <span class="o">=</span> <span class="n">ttest_ind</span><span class="p">(</span><span class="n">treated</span><span class="p">,</span> <span class="n">control</span><span class="p">,</span> <span class="n">equal_var</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nan_policy</span><span class="o">=</span><span class="s2">"omit"</span><span class="p">)</span>
            <span class="n">rounded_p</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">p_val</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="n">formatted_p</span> <span class="o">=</span> <span class="s2">"&lt; 0.00001"</span> <span class="k">if</span> <span class="n">rounded_p</span> <span class="o">&lt;</span> <span class="mf">0.00001</span> <span class="k">else</span> <span class="n">rounded_p</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">formatted_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># AUC from new auc_scores.xlsx file</span>
        <span class="n">auc_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">auc_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="n">auc_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">auc_path</span><span class="p">):</span>
            <span class="n">auc_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">auc_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">"AUC"</span> <span class="ow">in</span> <span class="n">auc_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">auc_val</span> <span class="o">=</span> <span class="n">auc_df</span><span class="p">[</span><span class="s2">"AUC"</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="c1"># Adjusted stats from Rubin summary</span>
        <span class="n">att_row</span> <span class="o">=</span> <span class="n">att_df</span><span class="p">[</span><span class="n">att_df</span><span class="p">[</span><span class="s2">"group"</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">med</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">att_row</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">att</span> <span class="o">=</span> <span class="n">att_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"att"</span><span class="p">]</span>
            <span class="n">att_se</span> <span class="o">=</span> <span class="n">att_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"se"</span><span class="p">]</span>
            <span class="n">att_p_val</span> <span class="o">=</span> <span class="n">att_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"p_value"</span><span class="p">]</span>
            <span class="n">r2</span> <span class="o">=</span> <span class="n">att_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"r2"</span><span class="p">]</span>
            <span class="n">rmse</span> <span class="o">=</span> <span class="n">att_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"rmse"</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">rounded_att_p</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">att_p_val</span><span class="p">),</span> <span class="mi">5</span><span class="p">)</span>
                <span class="n">formatted_att_p</span> <span class="o">=</span> <span class="s2">"&lt; 0.00001"</span> <span class="k">if</span> <span class="n">rounded_att_p</span> <span class="o">&lt;</span> <span class="mf">0.00001</span> <span class="k">else</span> <span class="n">rounded_att_p</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">formatted_att_p</span> <span class="o">=</span> <span class="n">att_p_val</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">att</span><span class="p">,</span> <span class="n">att_se</span><span class="p">,</span> <span class="n">formatted_att_p</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Append full row</span>
        <span class="n">summary_rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">'Medication Group'</span><span class="p">:</span> <span class="n">med</span><span class="p">,</span>
            <span class="s1">'Mean Treated'</span><span class="p">:</span> <span class="n">mean_treat</span><span class="p">,</span>
            <span class="s1">'SE Treated'</span><span class="p">:</span> <span class="n">se_treat</span><span class="p">,</span>
            <span class="s1">'Mean Control'</span><span class="p">:</span> <span class="n">mean_ctrl</span><span class="p">,</span>
            <span class="s1">'SE Control'</span><span class="p">:</span> <span class="n">se_ctrl</span><span class="p">,</span>
            <span class="s1">'Cohen d'</span><span class="p">:</span> <span class="n">cohen_d</span><span class="p">,</span>
            <span class="s1">'E (Unadjusted)'</span><span class="p">:</span> <span class="n">E</span><span class="p">,</span>
            <span class="s1">'n Treated'</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">treated</span><span class="p">),</span>
            <span class="s1">'n Control'</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">control</span><span class="p">),</span>
            <span class="c1">#'Unadjusted p-value': formatted_p,</span>
            <span class="s1">'ATT Estimate'</span><span class="p">:</span> <span class="n">att</span><span class="p">,</span>
            <span class="s1">'ATT SE (Robust)'</span><span class="p">:</span> <span class="n">att_se</span><span class="p">,</span>
            <span class="s1">'ATT p-value'</span><span class="p">:</span> <span class="n">formatted_att_p</span><span class="p">,</span>
            <span class="s1">'R'</span><span class="p">:</span> <span class="n">r2</span><span class="p">,</span>
            <span class="s1">'RMSE'</span><span class="p">:</span> <span class="n">rmse</span><span class="p">,</span>
            <span class="s1">'AUC'</span><span class="p">:</span> <span class="n">auc_val</span>
        <span class="p">})</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error in </span><span class="si">{</span><span class="n">med</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># ----------------------------------</span>
<span class="c1"># Save final summary</span>
<span class="c1"># ----------------------------------</span>
<span class="n">summary_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">summary_rows</span><span class="p">)</span>
<span class="n">summary_df</span> <span class="o">=</span> <span class="n">summary_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">"Medication Group"</span><span class="p">)</span>
<span class="n">summary_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">"Final_ATT_Summary_SubCat.xlsx"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">" Final_ATT_Summary_SubCat saved"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre> Final_ATT_Summary_SubCat saved
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=630929b1-b3f8-4767-8b90-68918d6543ec">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[159]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.backends.backend_pdf</span> <span class="kn">import</span> <span class="n">PdfPages</span>

<span class="c1">#  Load the final summary table</span>
<span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s2">"Final_ATT_Summary_SubCat.xlsx"</span><span class="p">)</span>

<span class="c1">#  Parse DML p-values (handle "&lt; 0.00001")</span>
<span class="k">def</span> <span class="nf">parse_pval</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">"&lt;"</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.000001</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

<span class="n">final_df</span><span class="p">[</span><span class="s1">'ATT p-value'</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="s1">'ATT p-value'</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">parse_pval</span><span class="p">)</span>

<span class="c1">#  Plot settings</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>

<span class="c1">#  Plotting function for a single medication group</span>
<span class="k">def</span> <span class="nf">plot_single_group</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    
    <span class="n">bars1</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="o">-</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">'Mean Control'</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> 
                   <span class="n">yerr</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">'SE Control'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">'Control'</span><span class="p">,</span> <span class="n">hatch</span><span class="o">=</span><span class="s1">'//'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">bars2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="o">+</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">'Mean Treated'</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> 
                   <span class="n">yerr</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">'SE Treated'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">'Treated'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'steelblue'</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

    <span class="n">label</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">"ATT = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'ATT Estimate'</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span>
        <span class="sa">f</span><span class="s2">"d = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'Cohen d'</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, p = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'ATT p-value'</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span>
        <span class="sa">f</span><span class="s2">"nT = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'n Treated'</span><span class="p">]</span><span class="si">}</span><span class="s2">, nC = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'n Control'</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span>
        <span class="sa">f</span><span class="s2">"E = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'E (Unadjusted)'</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%"</span>
    <span class="p">)</span>
    <span class="n">max_y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">'Mean Control'</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">'Mean Treated'</span><span class="p">])</span> <span class="o">+</span> <span class="mf">1.5</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_y</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">'center'</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">'bottom'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'#FFD700'</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'black'</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="o">-</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">+</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">'Control'</span><span class="p">,</span> <span class="s1">'Treated'</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Group: </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'Medication Group'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">'bold'</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"CAPS5 Change Score"</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="n">max_y</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">fig</span>

<span class="c1">#  Generate and save all plots into a multi-page PDF</span>
<span class="k">with</span> <span class="n">PdfPages</span><span class="p">(</span><span class="s2">"xgb_att_barplot_subcat.pdf"</span><span class="p">)</span> <span class="k">as</span> <span class="n">pdf</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">final_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_single_group</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="n">pdf</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">'tight'</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">" xgb_att_barplot_subcat saved"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre> xgb_att_barplot_subcat saved
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=2cccc7ca-28e3-40b5-a9ea-17419902df6b">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[160]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Love plot:</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=d0812ab6-4512-4742-9f4d-26503f46c4ac">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[161]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="c1"># ----------------------------------------</span>
<span class="c1"># Functions to calculate balance</span>
<span class="c1"># ----------------------------------------</span>
<span class="k">def</span> <span class="nf">calculate_smd</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">w1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">w2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">weighted_mean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span> <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">weighted_var</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">m</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
    
    <span class="n">m1</span> <span class="o">=</span> <span class="n">weighted_mean</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">w1</span><span class="p">)</span> <span class="k">if</span> <span class="n">w1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
    <span class="n">m2</span> <span class="o">=</span> <span class="n">weighted_mean</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span> <span class="k">if</span> <span class="n">w2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">weighted_var</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">w1</span><span class="p">)</span> <span class="k">if</span> <span class="n">w1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">weighted_var</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span> <span class="k">if</span> <span class="n">w2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">pooled_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">v1</span> <span class="o">+</span> <span class="n">v2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">m1</span> <span class="o">-</span> <span class="n">m2</span><span class="p">)</span> <span class="o">/</span> <span class="n">pooled_sd</span> <span class="k">if</span> <span class="n">pooled_sd</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">variance_ratio</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">w1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">w2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">weighted_var</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">m</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
    
    <span class="n">v1</span> <span class="o">=</span> <span class="n">weighted_var</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">w1</span><span class="p">)</span> <span class="k">if</span> <span class="n">w1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">weighted_var</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span> <span class="k">if</span> <span class="n">w2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">v1</span> <span class="o">/</span> <span class="n">v2</span><span class="p">,</span> <span class="n">v2</span> <span class="o">/</span> <span class="n">v1</span><span class="p">)</span> <span class="k">if</span> <span class="n">v1</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">v2</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>

<span class="c1"># ----------------------------------------</span>
<span class="c1"># Setup</span>
<span class="c1"># ----------------------------------------</span>
<span class="n">output_base</span> <span class="o">=</span> <span class="s2">"outputs"</span>
<span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">output_base</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">g</span><span class="p">))]</span>

<span class="c1"># Create a case-insensitive mapping</span>
<span class="n">final_covariates_map_lower</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="c1"># ----------------------------------------</span>
<span class="c1"># Main Loop</span>
<span class="c1"># ----------------------------------------</span>
<span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">group</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_covariates_map_lower</span><span class="p">:</span>
        <span class="k">continue</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Processing </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">..."</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">group_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">covariates</span> <span class="o">=</span> <span class="n">final_covariates_map_lower</span><span class="p">[</span><span class="n">group</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        
        <span class="n">column_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="s2">"trimmed_data_imp1.pkl"</span><span class="p">))</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">group</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">column_name</span> <span class="o">=</span> <span class="n">col</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">column_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Column not found for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">, skipping."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">smd_unw_all</span><span class="p">,</span> <span class="n">smd_w_all</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">vr_unw_all</span><span class="p">,</span> <span class="n">vr_w_all</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
            <span class="n">df_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"trimmed_data_imp</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.pkl"</span><span class="p">)</span>
            <span class="n">iptw_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="s2">"iptw_weights.xlsx"</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">df_path</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">iptw_path</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Missing data for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> imp</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, skipping."</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">df_path</span><span class="p">)</span>
            <span class="n">iptw_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">iptw_path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span>
            <span class="n">W</span> <span class="o">=</span> <span class="n">iptw_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s2">"iptw_mean"</span><span class="p">]</span>

            <span class="n">smd_unw_i</span><span class="p">,</span> <span class="n">smd_w_i</span><span class="p">,</span> <span class="n">vr_unw_i</span><span class="p">,</span> <span class="n">vr_w_i</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">cov</span> <span class="ow">in</span> <span class="n">covariates</span><span class="p">:</span>
                <span class="n">x1</span><span class="p">,</span> <span class="n">x0</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cov</span><span class="p">],</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cov</span><span class="p">]</span>
                <span class="n">w1</span><span class="p">,</span> <span class="n">w0</span> <span class="o">=</span> <span class="n">W</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">],</span> <span class="n">W</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>

                <span class="n">su</span> <span class="o">=</span> <span class="n">calculate_smd</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x0</span><span class="p">)</span>
                <span class="n">sw</span> <span class="o">=</span> <span class="n">calculate_smd</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">w0</span><span class="p">)</span>

                <span class="n">vu</span> <span class="o">=</span> <span class="n">variance_ratio</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x0</span><span class="p">)</span> <span class="k">if</span> <span class="n">cov</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">]</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">vw</span> <span class="o">=</span> <span class="n">variance_ratio</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">w0</span><span class="p">)</span> <span class="k">if</span> <span class="n">cov</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">]</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

                <span class="n">smd_unw_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">su</span><span class="p">)</span>
                <span class="n">smd_w_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sw</span><span class="p">)</span>
                <span class="n">vr_unw_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vu</span><span class="p">)</span>
                <span class="n">vr_w_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vw</span><span class="p">)</span>

            <span class="n">smd_unw_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smd_unw_i</span><span class="p">)</span>
            <span class="n">smd_w_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smd_w_i</span><span class="p">)</span>
            <span class="n">vr_unw_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vr_unw_i</span><span class="p">)</span>
            <span class="n">vr_w_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vr_w_i</span><span class="p">)</span>

        <span class="n">smd_unw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">smd_unw_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">smd_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">smd_w_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">vr_unw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">vr_unw_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">vr_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">vr_w_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">severity</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sw</span> <span class="ow">in</span> <span class="n">smd_w</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sw</span> <span class="o">&lt;=</span> <span class="mf">0.1</span><span class="p">:</span>
                <span class="n">severity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"Good"</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">sw</span> <span class="o">&lt;=</span> <span class="mf">0.2</span><span class="p">:</span>
                <span class="n">severity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"Moderate"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">severity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"Poor"</span><span class="p">)</span>

        <span class="n">covariate_names</span> <span class="o">=</span> <span class="n">covariates</span>
        <span class="n">numeric_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s2">"Covariate"</span><span class="p">:</span> <span class="n">covariate_names</span><span class="p">,</span>
            <span class="s2">"SMD_Unweighted"</span><span class="p">:</span> <span class="n">smd_unw</span><span class="p">,</span>
            <span class="s2">"SMD_Weighted"</span><span class="p">:</span> <span class="n">smd_w</span><span class="p">,</span>
            <span class="s2">"Imbalance_Severity"</span><span class="p">:</span> <span class="n">severity</span><span class="p">,</span>
            <span class="s2">"VR_Unweighted"</span><span class="p">:</span> <span class="n">vr_unw</span><span class="p">,</span>
            <span class="s2">"VR_Weighted"</span><span class="p">:</span> <span class="n">vr_w</span>
        <span class="p">})</span>

        <span class="n">numeric_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"covariate_balance_table_</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">.xlsx"</span><span class="p">)</span>
        <span class="n">numeric_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">numeric_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Exported numeric summary to: </span><span class="si">{</span><span class="n">numeric_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># -------------------------</span>
        <span class="c1"># Plot</span>
        <span class="c1"># -------------------------</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">covariates</span>
        <span class="n">y_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.45</span><span class="p">))</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">smd_unw</span><span class="p">,</span> <span class="n">y_pos</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Unweighted"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">smd_w</span><span class="p">,</span> <span class="n">y_pos</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'blue'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Weighted"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Threshold 0.1"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'black'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Threshold 0.2"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">smd_unw</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">smd_w</span><span class="p">),</span> <span class="mf">0.25</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">y_pos</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Standardized Mean Differences (SMD)"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">"upper right"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">vr_mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">cov</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">]</span> <span class="k">for</span> <span class="n">cov</span> <span class="ow">in</span> <span class="n">covariates</span><span class="p">]</span>
        <span class="n">filtered_y</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vr_mask</span><span class="p">)</span> <span class="k">if</span> <span class="n">b</span><span class="p">]</span>
        <span class="n">filtered_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">filtered_y</span><span class="p">]</span>
        <span class="n">filtered_vr_unw</span> <span class="o">=</span> <span class="p">[</span><span class="n">vr_unw</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">filtered_y</span><span class="p">]</span>
        <span class="n">filtered_vr_w</span> <span class="o">=</span> <span class="p">[</span><span class="n">vr_w</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">filtered_y</span><span class="p">]</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">filtered_vr_unw</span><span class="p">,</span> <span class="n">filtered_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'blue'</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">'o'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Unweighted"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">filtered_vr_w</span><span class="p">,</span> <span class="n">filtered_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">'x'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Weighted"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">filtered_vr_unw</span> <span class="o">+</span> <span class="n">filtered_vr_w</span> <span class="o">+</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">])</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">filtered_y</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">filtered_labels</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Variance Ratio (VR)"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Covariate Balance for </span><span class="si">{</span><span class="n">group</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'CAT_'</span><span class="p">,</span><span class="w"> </span><span class="s1">''</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">'bold'</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.96</span><span class="p">])</span>
        <span class="n">plot_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"love_plot_</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">.pdf"</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Saved love plot: </span><span class="si">{</span><span class="n">plot_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Max weighted SMD for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">smd_w</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Processing SUBCAT_Amfetaminen...
 Exported numeric summary to: outputs\SUBCAT_Amfetaminen\covariate_balance_table_SUBCAT_Amfetaminen.xlsx
 Saved love plot: outputs\SUBCAT_Amfetaminen\love_plot_SUBCAT_Amfetaminen.pdf
 Max weighted SMD for SUBCAT_Amfetaminen: 0.339

 Processing SUBCAT_Antidepressiva_Overige...
 Exported numeric summary to: outputs\SUBCAT_Antidepressiva_Overige\covariate_balance_table_SUBCAT_Antidepressiva_Overige.xlsx
 Saved love plot: outputs\SUBCAT_Antidepressiva_Overige\love_plot_SUBCAT_Antidepressiva_Overige.pdf
 Max weighted SMD for SUBCAT_Antidepressiva_Overige: 0.277

 Processing SUBCAT_Antipsychotica_Atypisch...
 Exported numeric summary to: outputs\SUBCAT_Antipsychotica_Atypisch\covariate_balance_table_SUBCAT_Antipsychotica_Atypisch.xlsx
 Saved love plot: outputs\SUBCAT_Antipsychotica_Atypisch\love_plot_SUBCAT_Antipsychotica_Atypisch.pdf
 Max weighted SMD for SUBCAT_Antipsychotica_Atypisch: 0.579

 Processing SUBCAT_Anti_Epileptica_Stemmingsstabilisatoren...
 Exported numeric summary to: outputs\SUBCAT_Anti_Epileptica_Stemmingsstabilisatoren\covariate_balance_table_SUBCAT_Anti_Epileptica_Stemmingsstabilisatoren.xlsx
 Saved love plot: outputs\SUBCAT_Anti_Epileptica_Stemmingsstabilisatoren\love_plot_SUBCAT_Anti_Epileptica_Stemmingsstabilisatoren.pdf
 Max weighted SMD for SUBCAT_Anti_Epileptica_Stemmingsstabilisatoren: 0.233

 Processing SUBCAT_Anxiolytica_Benzodiazepine...
 Exported numeric summary to: outputs\SUBCAT_Anxiolytica_Benzodiazepine\covariate_balance_table_SUBCAT_Anxiolytica_Benzodiazepine.xlsx
 Saved love plot: outputs\SUBCAT_Anxiolytica_Benzodiazepine\love_plot_SUBCAT_Anxiolytica_Benzodiazepine.pdf
 Max weighted SMD for SUBCAT_Anxiolytica_Benzodiazepine: 0.145

 Processing SUBCAT_Hypnotica_Benzodiazepine...
 Exported numeric summary to: outputs\SUBCAT_Hypnotica_Benzodiazepine\covariate_balance_table_SUBCAT_Hypnotica_Benzodiazepine.xlsx
 Saved love plot: outputs\SUBCAT_Hypnotica_Benzodiazepine\love_plot_SUBCAT_Hypnotica_Benzodiazepine.pdf
 Max weighted SMD for SUBCAT_Hypnotica_Benzodiazepine: 0.188

 Processing SUBCAT_Nsaids...
 Exported numeric summary to: outputs\SUBCAT_Nsaids\covariate_balance_table_SUBCAT_Nsaids.xlsx
 Saved love plot: outputs\SUBCAT_Nsaids\love_plot_SUBCAT_Nsaids.pdf
 Max weighted SMD for SUBCAT_Nsaids: 0.238

 Processing SUBCAT_Opioden...
 Exported numeric summary to: outputs\SUBCAT_Opioden\covariate_balance_table_SUBCAT_Opioden.xlsx
 Saved love plot: outputs\SUBCAT_Opioden\love_plot_SUBCAT_Opioden.pdf
 Max weighted SMD for SUBCAT_Opioden: 0.442

 Processing SUBCAT_Paracetamol_Mono...
 Exported numeric summary to: outputs\SUBCAT_Paracetamol_Mono\covariate_balance_table_SUBCAT_Paracetamol_Mono.xlsx
 Saved love plot: outputs\SUBCAT_Paracetamol_Mono\love_plot_SUBCAT_Paracetamol_Mono.pdf
 Max weighted SMD for SUBCAT_Paracetamol_Mono: 0.267

 Processing SUBCAT_Snri...
 Exported numeric summary to: outputs\SUBCAT_Snri\covariate_balance_table_SUBCAT_Snri.xlsx
 Saved love plot: outputs\SUBCAT_Snri\love_plot_SUBCAT_Snri.pdf
 Max weighted SMD for SUBCAT_Snri: 0.325

 Processing SUBCAT_Ssri...
 Exported numeric summary to: outputs\SUBCAT_Ssri\covariate_balance_table_SUBCAT_Ssri.xlsx
 Saved love plot: outputs\SUBCAT_Ssri\love_plot_SUBCAT_Ssri.pdf
 Max weighted SMD for SUBCAT_Ssri: 0.186

 Processing SUBCAT_Systemische_Antihistaminica...
 Exported numeric summary to: outputs\SUBCAT_Systemische_Antihistaminica\covariate_balance_table_SUBCAT_Systemische_Antihistaminica.xlsx
 Saved love plot: outputs\SUBCAT_Systemische_Antihistaminica\love_plot_SUBCAT_Systemische_Antihistaminica.pdf
 Max weighted SMD for SUBCAT_Systemische_Antihistaminica: 0.316

 Processing SUBCAT_Tca...
 Exported numeric summary to: outputs\SUBCAT_Tca\covariate_balance_table_SUBCAT_Tca.xlsx
 Saved love plot: outputs\SUBCAT_Tca\love_plot_SUBCAT_Tca.pdf
 Max weighted SMD for SUBCAT_Tca: 0.336

 Processing SUBCAT_Tetracyclische_Antidepressiva...
 Exported numeric summary to: outputs\SUBCAT_Tetracyclische_Antidepressiva\covariate_balance_table_SUBCAT_Tetracyclische_Antidepressiva.xlsx
 Saved love plot: outputs\SUBCAT_Tetracyclische_Antidepressiva\love_plot_SUBCAT_Tetracyclische_Antidepressiva.pdf
 Max weighted SMD for SUBCAT_Tetracyclische_Antidepressiva: 0.255

 Processing SUBCAT_Z_Drugs...
 Exported numeric summary to: outputs\SUBCAT_Z_Drugs\covariate_balance_table_SUBCAT_Z_Drugs.xlsx
 Saved love plot: outputs\SUBCAT_Z_Drugs\love_plot_SUBCAT_Z_Drugs.pdf
 Max weighted SMD for SUBCAT_Z_Drugs: 0.179
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=ae62a1bf-fc01-4e72-b029-43d68b098e7b">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[162]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Heatmap:</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=29d944cd-c180-4252-8adb-fef061de0ecf">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[163]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="c1">#-----------------------------</span>
<span class="c1"># Generate heatmaps</span>
<span class="c1"># -------------------------------</span>
<span class="k">for</span> <span class="n">treatment_var</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">========== Creating Heatmap for </span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s2"> =========="</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">'outputs'</span><span class="p">,</span> <span class="n">treatment_var</span><span class="p">)</span>
        <span class="n">balance_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'covariate_balance_table_</span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s1">.xlsx'</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">balance_path</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Balance file not found: </span><span class="si">{</span><span class="n">balance_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">balance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">balance_path</span><span class="p">)</span>

        <span class="c1">#  Use finalized covariates + 'Propensity Score'</span>
        <span class="n">covariates</span> <span class="o">=</span> <span class="n">final_covariates_map</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">'Propensity Score'</span><span class="p">]</span>
        <span class="n">balance_df</span> <span class="o">=</span> <span class="n">balance_df</span><span class="p">[</span><span class="n">balance_df</span><span class="p">[</span><span class="s1">'Covariate'</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">covariates</span><span class="p">)]</span>

        <span class="c1">#  Check for CAPS5score_baseline</span>
        <span class="n">highlight_caps</span> <span class="o">=</span> <span class="s1">'CAPS5score_baseline'</span> <span class="ow">in</span> <span class="n">balance_df</span><span class="p">[</span><span class="s1">'Covariate'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="c1">#  Format for heatmap</span>
        <span class="n">heatmap_df</span> <span class="o">=</span> <span class="n">balance_df</span><span class="p">[[</span><span class="s1">'Covariate'</span><span class="p">,</span> <span class="s1">'SMD_Unweighted'</span><span class="p">,</span> <span class="s1">'SMD_Weighted'</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">heatmap_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'Covariate'</span><span class="p">,</span> <span class="s1">'Unweighted'</span><span class="p">,</span> <span class="s1">'Weighted'</span><span class="p">]</span>
        <span class="n">heatmap_df</span> <span class="o">=</span> <span class="n">heatmap_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">'Covariate'</span><span class="p">)</span>
        <span class="n">heatmap_df</span> <span class="o">=</span> <span class="n">heatmap_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">'Unweighted'</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1">#  Plot</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">heatmap_df</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.35</span><span class="p">)))</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span>
            <span class="n">heatmap_df</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="s2">"coolwarm"</span><span class="p">,</span>
            <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">fmt</span><span class="o">=</span><span class="s2">".2f"</span><span class="p">,</span>
            <span class="n">linewidths</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
            <span class="n">linecolor</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span>
            <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">"label"</span><span class="p">:</span> <span class="s2">"Standardized Mean Difference"</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Covariate Balance Heatmap (Rubin IPTW)</span><span class="se">\n</span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">'bold'</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Condition"</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"Covariate"</span><span class="p">)</span>

        <span class="c1">#  Bold CAPS5score_baseline if present</span>
        <span class="k">if</span> <span class="n">highlight_caps</span><span class="p">:</span>
            <span class="n">ylabels</span> <span class="o">=</span> <span class="p">[</span><span class="n">label</span><span class="o">.</span><span class="n">get_text</span><span class="p">()</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span>
                <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2"> "</span> <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="s1">'CAPS5score_baseline'</span> <span class="k">else</span> <span class="n">label</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ylabels</span>
            <span class="p">])</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="c1">#  Save image</span>
        <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'heatmap_smd_</span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s1">.png'</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Heatmap saved: </span><span class="si">{</span><span class="n">save_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error processing </span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
========== Creating Heatmap for SUBCAT_Antipsychotica_atypisch ==========
 Heatmap saved: outputs\SUBCAT_Antipsychotica_atypisch\heatmap_smd_SUBCAT_Antipsychotica_atypisch.png

========== Creating Heatmap for SUBCAT_TCA ==========
 Heatmap saved: outputs\SUBCAT_TCA\heatmap_smd_SUBCAT_TCA.png

========== Creating Heatmap for SUBCAT_SSRI ==========
 Heatmap saved: outputs\SUBCAT_SSRI\heatmap_smd_SUBCAT_SSRI.png

========== Creating Heatmap for SUBCAT_SNRI ==========
 Heatmap saved: outputs\SUBCAT_SNRI\heatmap_smd_SUBCAT_SNRI.png

========== Creating Heatmap for SUBCAT_Tetracyclische_antidepressiva ==========
 Heatmap saved: outputs\SUBCAT_Tetracyclische_antidepressiva\heatmap_smd_SUBCAT_Tetracyclische_antidepressiva.png

========== Creating Heatmap for SUBCAT_Antidepressiva_overige ==========
 Heatmap saved: outputs\SUBCAT_Antidepressiva_overige\heatmap_smd_SUBCAT_Antidepressiva_overige.png

========== Creating Heatmap for SUBCAT_Systemische_antihistaminica ==========
 Heatmap saved: outputs\SUBCAT_Systemische_antihistaminica\heatmap_smd_SUBCAT_Systemische_antihistaminica.png

========== Creating Heatmap for SUBCAT_anxiolytica_Benzodiazepine ==========
 Heatmap saved: outputs\SUBCAT_anxiolytica_Benzodiazepine\heatmap_smd_SUBCAT_anxiolytica_Benzodiazepine.png

========== Creating Heatmap for SUBCAT_hypnotica_Benzodiazepine ==========
 Heatmap saved: outputs\SUBCAT_hypnotica_Benzodiazepine\heatmap_smd_SUBCAT_hypnotica_Benzodiazepine.png

========== Creating Heatmap for SUBCAT_Amfetaminen ==========
 Heatmap saved: outputs\SUBCAT_Amfetaminen\heatmap_smd_SUBCAT_Amfetaminen.png

========== Creating Heatmap for SUBCAT_Paracetamol_mono ==========
 Heatmap saved: outputs\SUBCAT_Paracetamol_mono\heatmap_smd_SUBCAT_Paracetamol_mono.png

========== Creating Heatmap for SUBCAT_Anti_epileptica_stemmingsstabilisatoren ==========
 Heatmap saved: outputs\SUBCAT_Anti_epileptica_stemmingsstabilisatoren\heatmap_smd_SUBCAT_Anti_epileptica_stemmingsstabilisatoren.png

========== Creating Heatmap for SUBCAT_Opioden ==========
 Heatmap saved: outputs\SUBCAT_Opioden\heatmap_smd_SUBCAT_Opioden.png

========== Creating Heatmap for SUBCAT_Z_drugs ==========
 Heatmap saved: outputs\SUBCAT_Z_drugs\heatmap_smd_SUBCAT_Z_drugs.png

========== Creating Heatmap for SUBCAT_NSAIDs ==========
 Heatmap saved: outputs\SUBCAT_NSAIDs\heatmap_smd_SUBCAT_NSAIDs.png
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=711a844e-e3d4-45d5-9781-c324f75d3fbb">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span> 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=5fbd63cf-32bb-4417-99c9-b6748d051820">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="SubSubCat-Analysis:">SubSubCat Analysis:<a class="anchor-link" href="#SubSubCat-Analysis:"></a></h2>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=262ea436-3978-4fab-a149-f0e3d43f04d7">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[164]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">covariates_SubSubCat_Oxazepam</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span> <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SubSubCat_Diazepam</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span> <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_SubSubCat_Paracetamol</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SubSubCat_Lorazepam</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span> <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SubSubCat_Mirtazapine</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SubSubCat_Escitalopram</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_SubSubCat_Sertraline</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SubSubCat_Temazepam</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span> <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SubSubCat_Citalopram</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SubSubCat_Quetiapine</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>




<span class="n">covariates_SubSubCat_Amitriptyline</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_SubSubCat_Venlafaxine</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SubSubCat_Fluoxetine</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SubSubCat_Topiramaat</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>




<span class="n">covariates_SubSubCat_Zopiclon</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>










<span class="n">covariates_SubSubCat_Bupropion</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SubSubCat_Methylfenidaat</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span>
    <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SubSubCat_Olanzapine</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=33230141-1b00-460e-b113-f27cd67a2e2c">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[165]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="c1"># This finds all variables that start with covariates_SUbSubCAT_ or covariates_SubSubcat_</span>
<span class="n">final_covariates_map</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<span class="n">final_covariates_map</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
    <span class="n">var</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"covariates_"</span><span class="p">,</span> <span class="s2">""</span><span class="p">):</span> <span class="n">val</span>
    <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"covariates_subsubcat_"</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
<span class="p">})</span>

<span class="c1"># Show detected group names</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Groups found:"</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
<span class="n">medication_groups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">medication_groups</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Groups found: ['SubSubCat_Oxazepam', 'SubSubCat_Diazepam', 'SubSubCat_Paracetamol', 'SubSubCat_Lorazepam', 'SubSubCat_Mirtazapine', 'SubSubCat_Escitalopram', 'SubSubCat_Sertraline', 'SubSubCat_Temazepam', 'SubSubCat_Citalopram', 'SubSubCat_Quetiapine', 'SubSubCat_Amitriptyline', 'SubSubCat_Venlafaxine', 'SubSubCat_Fluoxetine', 'SubSubCat_Topiramaat', 'SubSubCat_Zopiclon', 'SubSubCat_Bupropion', 'SubSubCat_Methylfenidaat', 'SubSubCat_Olanzapine']
['SubSubCat_Oxazepam', 'SubSubCat_Diazepam', 'SubSubCat_Paracetamol', 'SubSubCat_Lorazepam', 'SubSubCat_Mirtazapine', 'SubSubCat_Escitalopram', 'SubSubCat_Sertraline', 'SubSubCat_Temazepam', 'SubSubCat_Citalopram', 'SubSubCat_Quetiapine', 'SubSubCat_Amitriptyline', 'SubSubCat_Venlafaxine', 'SubSubCat_Fluoxetine', 'SubSubCat_Topiramaat', 'SubSubCat_Zopiclon', 'SubSubCat_Bupropion', 'SubSubCat_Methylfenidaat', 'SubSubCat_Olanzapine']
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=00ef235f-c23f-4f2c-a4ba-4be21721cb19">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[166]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>


<span class="k">def</span> <span class="nf">run_all_SUBSUBCAT_group_models</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Runs downstream analysis for each SUBSUBCAT medisubsubcation group using imputed datasets.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - imputed_dfs: list of 5 imputed DataFrames (from df_imputed_final_imp1.pkl ... imp5.pkl)</span>
<span class="sd">    </span>
<span class="sd">    Notes:</span>
<span class="sd">    - Covariate lists must be defined as global variables: covariates_subsubcat_&lt;group&gt;</span>
<span class="sd">    - Outputs are saved in: outputs/SUBSUBCAT_&lt;GROUP&gt;/</span>
<span class="sd">    """</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">" Starting analysis for all SUBSUBCAT groups"</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">var_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"covariates_subsubcat_"</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">globals</span><span class="p">()[</span><span class="n">var_name</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">group_name</span> <span class="o">=</span> <span class="n">var_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"covariates_"</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
            <span class="n">group_name</span> <span class="o">=</span> <span class="n">group_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"_"</span><span class="p">,</span> <span class="s2">" "</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">" "</span><span class="p">,</span> <span class="s2">"_"</span><span class="p">)</span>  <span class="c1"># e.g., subsubcat_z_drugs  Subsubcat_Z_Drugs</span>
            <span class="n">group_name</span> <span class="o">=</span> <span class="n">group_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"Subsubcat_"</span><span class="p">,</span> <span class="s2">"SUBSUBCAT_"</span><span class="p">)</span>  <span class="c1"># force prefix to uppercase</span>

            <span class="n">covariates</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()[</span><span class="n">var_name</span><span class="p">]</span>
            <span class="n">output_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"outputs/</span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">"</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Processing </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">..."</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">df_imp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   Using imputation </span><span class="si">{</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

                <span class="c1"># Define X and Y</span>
                <span class="n">X</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span>
                <span class="n">Y</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="s2">"caps5_change_baseline"</span><span class="p">]</span>

                <span class="c1"># === Save X and Y as placeholder (replace with modeling later)</span>
                <span class="n">X</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/X_imp</span><span class="si">{</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.csv"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">Y</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"Y"</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/Y_imp</span><span class="si">{</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.csv"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Done: </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> All SUBSUBCAT group analyses complete."</span><span class="p">)</span>

<span class="c1"># ========= STEP 4: Execute ========= #</span>
<span class="n">run_all_SUBSUBCAT_group_models</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre> Starting analysis for all SUBSUBCAT groups

 Processing SUBSUBCAT_Oxazepam...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Oxazepam

 Processing SUBSUBCAT_Diazepam...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Diazepam

 Processing SUBSUBCAT_Paracetamol...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Paracetamol

 Processing SUBSUBCAT_Lorazepam...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Lorazepam

 Processing SUBSUBCAT_Mirtazapine...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Mirtazapine

 Processing SUBSUBCAT_Escitalopram...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Escitalopram

 Processing SUBSUBCAT_Sertraline...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Sertraline

 Processing SUBSUBCAT_Temazepam...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Temazepam

 Processing SUBSUBCAT_Citalopram...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Citalopram

 Processing SUBSUBCAT_Quetiapine...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Quetiapine

 Processing SUBSUBCAT_Amitriptyline...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Amitriptyline

 Processing SUBSUBCAT_Venlafaxine...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Venlafaxine

 Processing SUBSUBCAT_Fluoxetine...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Fluoxetine

 Processing SUBSUBCAT_Topiramaat...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Topiramaat

 Processing SUBSUBCAT_Zopiclon...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Zopiclon

 Processing SUBSUBCAT_Bupropion...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Bupropion

 Processing SUBSUBCAT_Methylfenidaat...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Methylfenidaat

 Processing SUBSUBCAT_Olanzapine...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Olanzapine

 All SUBSUBCAT group analyses complete.
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=d4e790f5-0421-408b-b159-ea2b11e06d47">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[167]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">treatment_var</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">treatment_var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Imp </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">:  Not found in columns."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">treated</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">control</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Imp </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: Treated = </span><span class="si">{</span><span class="n">treated</span><span class="si">}</span><span class="s2">, Control = </span><span class="si">{</span><span class="n">control</span><span class="si">}</span><span class="s2">, Missing = </span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 SubSubCat_Oxazepam
  Imp 1: Treated = 206, Control = 3435, Missing = 0
  Imp 2: Treated = 206, Control = 3435, Missing = 0
  Imp 3: Treated = 206, Control = 3435, Missing = 0
  Imp 4: Treated = 206, Control = 3435, Missing = 0
  Imp 5: Treated = 206, Control = 3435, Missing = 0

 SubSubCat_Diazepam
  Imp 1: Treated = 42, Control = 3599, Missing = 0
  Imp 2: Treated = 42, Control = 3599, Missing = 0
  Imp 3: Treated = 42, Control = 3599, Missing = 0
  Imp 4: Treated = 42, Control = 3599, Missing = 0
  Imp 5: Treated = 42, Control = 3599, Missing = 0

 SubSubCat_Paracetamol
  Imp 1: Treated = 43, Control = 3598, Missing = 0
  Imp 2: Treated = 43, Control = 3598, Missing = 0
  Imp 3: Treated = 43, Control = 3598, Missing = 0
  Imp 4: Treated = 43, Control = 3598, Missing = 0
  Imp 5: Treated = 43, Control = 3598, Missing = 0

 SubSubCat_Lorazepam
  Imp 1: Treated = 67, Control = 3574, Missing = 0
  Imp 2: Treated = 67, Control = 3574, Missing = 0
  Imp 3: Treated = 67, Control = 3574, Missing = 0
  Imp 4: Treated = 67, Control = 3574, Missing = 0
  Imp 5: Treated = 67, Control = 3574, Missing = 0

 SubSubCat_Mirtazapine
  Imp 1: Treated = 87, Control = 3554, Missing = 0
  Imp 2: Treated = 87, Control = 3554, Missing = 0
  Imp 3: Treated = 87, Control = 3554, Missing = 0
  Imp 4: Treated = 87, Control = 3554, Missing = 0
  Imp 5: Treated = 87, Control = 3554, Missing = 0

 SubSubCat_Escitalopram
  Imp 1: Treated = 69, Control = 3572, Missing = 0
  Imp 2: Treated = 69, Control = 3572, Missing = 0
  Imp 3: Treated = 69, Control = 3572, Missing = 0
  Imp 4: Treated = 69, Control = 3572, Missing = 0
  Imp 5: Treated = 69, Control = 3572, Missing = 0

 SubSubCat_Sertraline
  Imp 1: Treated = 102, Control = 3539, Missing = 0
  Imp 2: Treated = 102, Control = 3539, Missing = 0
  Imp 3: Treated = 102, Control = 3539, Missing = 0
  Imp 4: Treated = 102, Control = 3539, Missing = 0
  Imp 5: Treated = 102, Control = 3539, Missing = 0

 SubSubCat_Temazepam
  Imp 1: Treated = 93, Control = 3548, Missing = 0
  Imp 2: Treated = 93, Control = 3548, Missing = 0
  Imp 3: Treated = 93, Control = 3548, Missing = 0
  Imp 4: Treated = 93, Control = 3548, Missing = 0
  Imp 5: Treated = 93, Control = 3548, Missing = 0

 SubSubCat_Citalopram
  Imp 1: Treated = 125, Control = 3516, Missing = 0
  Imp 2: Treated = 125, Control = 3516, Missing = 0
  Imp 3: Treated = 125, Control = 3516, Missing = 0
  Imp 4: Treated = 125, Control = 3516, Missing = 0
  Imp 5: Treated = 125, Control = 3516, Missing = 0

 SubSubCat_Quetiapine
  Imp 1: Treated = 203, Control = 3438, Missing = 0
  Imp 2: Treated = 203, Control = 3438, Missing = 0
  Imp 3: Treated = 203, Control = 3438, Missing = 0
  Imp 4: Treated = 203, Control = 3438, Missing = 0
  Imp 5: Treated = 203, Control = 3438, Missing = 0

 SubSubCat_Amitriptyline
  Imp 1: Treated = 52, Control = 3589, Missing = 0
  Imp 2: Treated = 52, Control = 3589, Missing = 0
  Imp 3: Treated = 52, Control = 3589, Missing = 0
  Imp 4: Treated = 52, Control = 3589, Missing = 0
  Imp 5: Treated = 52, Control = 3589, Missing = 0

 SubSubCat_Venlafaxine
  Imp 1: Treated = 59, Control = 3582, Missing = 0
  Imp 2: Treated = 59, Control = 3582, Missing = 0
  Imp 3: Treated = 59, Control = 3582, Missing = 0
  Imp 4: Treated = 59, Control = 3582, Missing = 0
  Imp 5: Treated = 59, Control = 3582, Missing = 0

 SubSubCat_Fluoxetine
  Imp 1: Treated = 71, Control = 3570, Missing = 0
  Imp 2: Treated = 71, Control = 3570, Missing = 0
  Imp 3: Treated = 71, Control = 3570, Missing = 0
  Imp 4: Treated = 71, Control = 3570, Missing = 0
  Imp 5: Treated = 71, Control = 3570, Missing = 0

 SubSubCat_Topiramaat
  Imp 1: Treated = 41, Control = 3600, Missing = 0
  Imp 2: Treated = 41, Control = 3600, Missing = 0
  Imp 3: Treated = 41, Control = 3600, Missing = 0
  Imp 4: Treated = 41, Control = 3600, Missing = 0
  Imp 5: Treated = 41, Control = 3600, Missing = 0

 SubSubCat_Zopiclon
  Imp 1: Treated = 32, Control = 3609, Missing = 0
  Imp 2: Treated = 32, Control = 3609, Missing = 0
  Imp 3: Treated = 32, Control = 3609, Missing = 0
  Imp 4: Treated = 32, Control = 3609, Missing = 0
  Imp 5: Treated = 32, Control = 3609, Missing = 0

 SubSubCat_Bupropion
  Imp 1: Treated = 34, Control = 3607, Missing = 0
  Imp 2: Treated = 34, Control = 3607, Missing = 0
  Imp 3: Treated = 34, Control = 3607, Missing = 0
  Imp 4: Treated = 34, Control = 3607, Missing = 0
  Imp 5: Treated = 34, Control = 3607, Missing = 0

 SubSubCat_Methylfenidaat
  Imp 1: Treated = 38, Control = 3603, Missing = 0
  Imp 2: Treated = 38, Control = 3603, Missing = 0
  Imp 3: Treated = 38, Control = 3603, Missing = 0
  Imp 4: Treated = 38, Control = 3603, Missing = 0
  Imp 5: Treated = 38, Control = 3603, Missing = 0

 SubSubCat_Olanzapine
  Imp 1: Treated = 33, Control = 3608, Missing = 0
  Imp 2: Treated = 33, Control = 3608, Missing = 0
  Imp 3: Treated = 33, Control = 3608, Missing = 0
  Imp 4: Treated = 33, Control = 3608, Missing = 0
  Imp 5: Treated = 33, Control = 3608, Missing = 0
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=07169c03-e41b-408d-b805-a8205c103695">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[168]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">from</span> <span class="nn">statsmodels.stats.outliers_influence</span> <span class="kn">import</span> <span class="n">variance_inflation_factor</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="c1">#  VIF computation function</span>
<span class="k">def</span> <span class="nf">compute_vif</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">has_constant</span><span class="o">=</span><span class="s1">'add'</span><span class="p">)</span>
    <span class="n">vif_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">vif_df</span><span class="p">[</span><span class="s2">"variable"</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span>
    <span class="n">vif_df</span><span class="p">[</span><span class="s2">"VIF"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">variance_inflation_factor</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
    <span class="k">return</span> <span class="n">vif_df</span>

<span class="c1">#  Process each group</span>
<span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Processing VIF for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  No covariates found for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
        <span class="k">continue</span>

    <span class="n">covariates</span> <span class="o">=</span> <span class="n">final_covariates_map</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
    <span class="n">vif_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df_imp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">vif_df</span> <span class="o">=</span> <span class="n">compute_vif</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="n">vif_df</span><span class="p">[</span><span class="s2">"imputation"</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">vif_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vif_df</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"    Failed on imputation </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">vif_list</span><span class="p">:</span>
        <span class="n">all_vif</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">vif_list</span><span class="p">)</span>
        <span class="n">pooled_vif</span> <span class="o">=</span> <span class="n">all_vif</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">"variable"</span><span class="p">)[</span><span class="s2">"VIF"</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">pooled_vif</span> <span class="o">=</span> <span class="n">pooled_vif</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">"VIF"</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"outputs"</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">pooled_vif</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"pooled_vif.csv"</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Saved: </span><span class="si">{</span><span class="n">output_folder</span><span class="si">}</span><span class="s2">/pooled_vif.csv"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Skipped </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: No valid imputations."</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Processing VIF for SubSubCat_Oxazepam
  Saved: outputs\SubSubCat_Oxazepam/pooled_vif.csv

 Processing VIF for SubSubCat_Diazepam
  Saved: outputs\SubSubCat_Diazepam/pooled_vif.csv

 Processing VIF for SubSubCat_Paracetamol
  Saved: outputs\SubSubCat_Paracetamol/pooled_vif.csv

 Processing VIF for SubSubCat_Lorazepam
  Saved: outputs\SubSubCat_Lorazepam/pooled_vif.csv

 Processing VIF for SubSubCat_Mirtazapine
  Saved: outputs\SubSubCat_Mirtazapine/pooled_vif.csv

 Processing VIF for SubSubCat_Escitalopram
  Saved: outputs\SubSubCat_Escitalopram/pooled_vif.csv

 Processing VIF for SubSubCat_Sertraline
  Saved: outputs\SubSubCat_Sertraline/pooled_vif.csv

 Processing VIF for SubSubCat_Temazepam
  Saved: outputs\SubSubCat_Temazepam/pooled_vif.csv

 Processing VIF for SubSubCat_Citalopram
  Saved: outputs\SubSubCat_Citalopram/pooled_vif.csv

 Processing VIF for SubSubCat_Quetiapine
  Saved: outputs\SubSubCat_Quetiapine/pooled_vif.csv

 Processing VIF for SubSubCat_Amitriptyline
  Saved: outputs\SubSubCat_Amitriptyline/pooled_vif.csv

 Processing VIF for SubSubCat_Venlafaxine
  Saved: outputs\SubSubCat_Venlafaxine/pooled_vif.csv

 Processing VIF for SubSubCat_Fluoxetine
  Saved: outputs\SubSubCat_Fluoxetine/pooled_vif.csv

 Processing VIF for SubSubCat_Topiramaat
  Saved: outputs\SubSubCat_Topiramaat/pooled_vif.csv

 Processing VIF for SubSubCat_Zopiclon
  Saved: outputs\SubSubCat_Zopiclon/pooled_vif.csv

 Processing VIF for SubSubCat_Bupropion
  Saved: outputs\SubSubCat_Bupropion/pooled_vif.csv

 Processing VIF for SubSubCat_Methylfenidaat
  Saved: outputs\SubSubCat_Methylfenidaat/pooled_vif.csv

 Processing VIF for SubSubCat_Olanzapine
  Saved: outputs\SubSubCat_Olanzapine/pooled_vif.csv
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=926d616b-8015-4b96-92be-8ab6124676ff">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[169]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">xgboost</span> <span class="kn">import</span> <span class="n">XGBClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">roc_curve</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>

<span class="c1"># ---------- PS Estimation Function ----------</span>
<span class="k">def</span> <span class="nf">run_xgboost_ps_modeling</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Running PS estimation for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No covariates found for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"outputs"</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">covariates</span> <span class="o">=</span> <span class="n">final_covariates_map</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
        <span class="n">ps_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">auc_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df_imp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_imp</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> not found in imputed dataset </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">X</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>

            <span class="c1"># Drop missing treatment rows</span>
            <span class="n">valid_idx</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">index</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>

            <span class="c1"># Train-test split for ROC</span>
            <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">T_train</span><span class="p">,</span> <span class="n">T_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
                <span class="n">X</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
            <span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">XGBClassifier</span><span class="p">(</span><span class="n">use_label_encoder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eval_metric</span><span class="o">=</span><span class="s1">'logloss'</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
                <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">T_train</span><span class="p">)</span>

                <span class="n">ps_scores</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">ps_matrix</span><span class="p">[</span><span class="sa">f</span><span class="s2">"ps_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">ps_scores</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">valid_idx</span><span class="p">)</span>

                <span class="c1"># ROC &amp; AUC</span>
                <span class="n">auc</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">T_test</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">auc_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">auc</span><span class="p">)</span>

                <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">T_test</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">"AUC = </span><span class="si">{</span><span class="n">auc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'k--'</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"False Positive Rate"</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"True Positive Rate"</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"ROC Curve - </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> (Imp </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">)"</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"roc_curve_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.png"</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   Imp </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: AUC = </span><span class="si">{</span><span class="n">auc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, ROC saved."</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> (imp </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Save AUCs and Composite PS</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ps_matrix</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="c1"># Fill NaN rows (from dropped subjects in some imputations) with mean</span>
            <span class="n">ps_matrix</span><span class="p">[</span><span class="s2">"composite_ps"</span><span class="p">]</span> <span class="o">=</span> <span class="n">ps_matrix</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ps_matrix</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"propensity_scores.xlsx"</span><span class="p">))</span>

            <span class="n">auc_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s2">"imputation"</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">"imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">auc_list</span><span class="p">))],</span>
                <span class="s2">"AUC"</span><span class="p">:</span> <span class="n">auc_list</span>
            <span class="p">})</span>
            <span class="n">auc_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">auc_df</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"mean"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">auc_list</span><span class="p">)</span> <span class="k">if</span> <span class="n">auc_list</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span>
            <span class="n">auc_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"auc_scores.xlsx"</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Composite PS + AUC saved for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No valid PS scores generated for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># ---------- Run ----------</span>
<span class="n">run_xgboost_ps_modeling</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre> Running PS estimation for SubSubCat_Oxazepam
   Imp 1: AUC = 0.659, ROC saved.
   Imp 2: AUC = 0.657, ROC saved.
   Imp 3: AUC = 0.644, ROC saved.
   Imp 4: AUC = 0.670, ROC saved.
   Imp 5: AUC = 0.654, ROC saved.
 Composite PS + AUC saved for SubSubCat_Oxazepam
 Running PS estimation for SubSubCat_Diazepam
   Imp 1: AUC = 0.737, ROC saved.
   Imp 2: AUC = 0.721, ROC saved.
   Imp 3: AUC = 0.731, ROC saved.
   Imp 4: AUC = 0.750, ROC saved.
   Imp 5: AUC = 0.725, ROC saved.
 Composite PS + AUC saved for SubSubCat_Diazepam
 Running PS estimation for SubSubCat_Paracetamol
   Imp 1: AUC = 0.599, ROC saved.
   Imp 2: AUC = 0.618, ROC saved.
   Imp 3: AUC = 0.639, ROC saved.
   Imp 4: AUC = 0.709, ROC saved.
   Imp 5: AUC = 0.660, ROC saved.
 Composite PS + AUC saved for SubSubCat_Paracetamol
 Running PS estimation for SubSubCat_Lorazepam
   Imp 1: AUC = 0.647, ROC saved.
   Imp 2: AUC = 0.705, ROC saved.
   Imp 3: AUC = 0.673, ROC saved.
   Imp 4: AUC = 0.709, ROC saved.
   Imp 5: AUC = 0.667, ROC saved.
 Composite PS + AUC saved for SubSubCat_Lorazepam
 Running PS estimation for SubSubCat_Mirtazapine
   Imp 1: AUC = 0.610, ROC saved.
   Imp 2: AUC = 0.571, ROC saved.
   Imp 3: AUC = 0.627, ROC saved.
   Imp 4: AUC = 0.609, ROC saved.
   Imp 5: AUC = 0.664, ROC saved.
 Composite PS + AUC saved for SubSubCat_Mirtazapine
 Running PS estimation for SubSubCat_Escitalopram
   Imp 1: AUC = 0.491, ROC saved.
   Imp 2: AUC = 0.471, ROC saved.
   Imp 3: AUC = 0.499, ROC saved.
   Imp 4: AUC = 0.489, ROC saved.
   Imp 5: AUC = 0.518, ROC saved.
 Composite PS + AUC saved for SubSubCat_Escitalopram
 Running PS estimation for SubSubCat_Sertraline
   Imp 1: AUC = 0.692, ROC saved.
   Imp 2: AUC = 0.696, ROC saved.
   Imp 3: AUC = 0.701, ROC saved.
   Imp 4: AUC = 0.694, ROC saved.
   Imp 5: AUC = 0.693, ROC saved.
 Composite PS + AUC saved for SubSubCat_Sertraline
 Running PS estimation for SubSubCat_Temazepam
   Imp 1: AUC = 0.564, ROC saved.
   Imp 2: AUC = 0.524, ROC saved.
   Imp 3: AUC = 0.565, ROC saved.
   Imp 4: AUC = 0.511, ROC saved.
   Imp 5: AUC = 0.542, ROC saved.
 Composite PS + AUC saved for SubSubCat_Temazepam
 Running PS estimation for SubSubCat_Citalopram
   Imp 1: AUC = 0.653, ROC saved.
   Imp 2: AUC = 0.660, ROC saved.
   Imp 3: AUC = 0.664, ROC saved.
   Imp 4: AUC = 0.651, ROC saved.
   Imp 5: AUC = 0.657, ROC saved.
 Composite PS + AUC saved for SubSubCat_Citalopram
 Running PS estimation for SubSubCat_Quetiapine
   Imp 1: AUC = 0.775, ROC saved.
   Imp 2: AUC = 0.770, ROC saved.
   Imp 3: AUC = 0.798, ROC saved.
   Imp 4: AUC = 0.776, ROC saved.
   Imp 5: AUC = 0.763, ROC saved.
 Composite PS + AUC saved for SubSubCat_Quetiapine
 Running PS estimation for SubSubCat_Amitriptyline
   Imp 1: AUC = 0.543, ROC saved.
   Imp 2: AUC = 0.526, ROC saved.
   Imp 3: AUC = 0.488, ROC saved.
   Imp 4: AUC = 0.526, ROC saved.
   Imp 5: AUC = 0.608, ROC saved.
 Composite PS + AUC saved for SubSubCat_Amitriptyline
 Running PS estimation for SubSubCat_Venlafaxine
   Imp 1: AUC = 0.692, ROC saved.
   Imp 2: AUC = 0.715, ROC saved.
   Imp 3: AUC = 0.617, ROC saved.
   Imp 4: AUC = 0.683, ROC saved.
   Imp 5: AUC = 0.704, ROC saved.
 Composite PS + AUC saved for SubSubCat_Venlafaxine
 Running PS estimation for SubSubCat_Fluoxetine
   Imp 1: AUC = 0.698, ROC saved.
   Imp 2: AUC = 0.674, ROC saved.
   Imp 3: AUC = 0.666, ROC saved.
   Imp 4: AUC = 0.732, ROC saved.
   Imp 5: AUC = 0.709, ROC saved.
 Composite PS + AUC saved for SubSubCat_Fluoxetine
 Running PS estimation for SubSubCat_Topiramaat
   Imp 1: AUC = 0.762, ROC saved.
   Imp 2: AUC = 0.784, ROC saved.
   Imp 3: AUC = 0.790, ROC saved.
   Imp 4: AUC = 0.807, ROC saved.
   Imp 5: AUC = 0.777, ROC saved.
 Composite PS + AUC saved for SubSubCat_Topiramaat
 Running PS estimation for SubSubCat_Zopiclon
   Imp 1: AUC = 0.634, ROC saved.
   Imp 2: AUC = 0.649, ROC saved.
   Imp 3: AUC = 0.649, ROC saved.
   Imp 4: AUC = 0.667, ROC saved.
   Imp 5: AUC = 0.635, ROC saved.
 Composite PS + AUC saved for SubSubCat_Zopiclon
 Running PS estimation for SubSubCat_Bupropion
   Imp 1: AUC = 0.524, ROC saved.
   Imp 2: AUC = 0.561, ROC saved.
   Imp 3: AUC = 0.496, ROC saved.
   Imp 4: AUC = 0.547, ROC saved.
   Imp 5: AUC = 0.544, ROC saved.
 Composite PS + AUC saved for SubSubCat_Bupropion
 Running PS estimation for SubSubCat_Methylfenidaat
   Imp 1: AUC = 0.674, ROC saved.
   Imp 2: AUC = 0.689, ROC saved.
   Imp 3: AUC = 0.625, ROC saved.
   Imp 4: AUC = 0.695, ROC saved.
   Imp 5: AUC = 0.663, ROC saved.
 Composite PS + AUC saved for SubSubCat_Methylfenidaat
 Running PS estimation for SubSubCat_Olanzapine
   Imp 1: AUC = 0.601, ROC saved.
   Imp 2: AUC = 0.635, ROC saved.
   Imp 3: AUC = 0.587, ROC saved.
   Imp 4: AUC = 0.653, ROC saved.
   Imp 5: AUC = 0.608, ROC saved.
 Composite PS + AUC saved for SubSubCat_Olanzapine
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=e226945e-7d0a-45c7-b5bc-af3feda0e42c">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[170]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">xgboost</span> <span class="kn">import</span> <span class="n">XGBClassifier</span>

<span class="k">def</span> <span class="nf">compute_feature_importance</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Computing feature importance for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No covariates found for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">covariates</span> <span class="o">=</span> <span class="n">final_covariates_map</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
        <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"outputs"</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">importance_df_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df_imp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_imp</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> not in imputed dataset </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">X</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>

            <span class="c1"># Drop NaNs in treatment</span>
            <span class="n">valid_idx</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">index</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">XGBClassifier</span><span class="p">(</span><span class="n">use_label_encoder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eval_metric</span><span class="o">=</span><span class="s1">'logloss'</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
                <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>

                <span class="c1"># Get feature importance</span>
                <span class="n">importances</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_booster</span><span class="p">()</span><span class="o">.</span><span class="n">get_score</span><span class="p">(</span><span class="n">importance_type</span><span class="o">=</span><span class="s1">'gain'</span><span class="p">)</span>
                <span class="n">df_feat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">importances</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">'index'</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">"imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">])</span>
                <span class="n">df_feat</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">'feature'</span>
                <span class="n">importance_df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_feat</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   Error during modeling: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">importance_df_list</span><span class="p">:</span>
            <span class="c1"># Combine and average</span>
            <span class="n">all_feat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">importance_df_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">all_feat</span><span class="p">[</span><span class="s2">"mean_importance"</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_feat</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Filter top 30 non-zero</span>
            <span class="n">non_zero</span> <span class="o">=</span> <span class="n">all_feat</span><span class="p">[</span><span class="n">all_feat</span><span class="p">[</span><span class="s2">"mean_importance"</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">top30</span> <span class="o">=</span> <span class="n">non_zero</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">"mean_importance"</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>

            <span class="c1"># Save to CSV</span>
            <span class="n">top30</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"feature_importance.csv"</span><span class="p">))</span>

            <span class="c1"># Plot</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top30</span><span class="o">.</span><span class="n">index</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">top30</span><span class="p">[</span><span class="s2">"mean_importance"</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># plot top  bottom</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Mean Gain Importance"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Top 30 Feature Importance - </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"feature_importance_top30.png"</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Saved feature importance plot and CSV for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No valid models for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1">#  Run</span>
<span class="n">compute_feature_importance</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Computing feature importance for SubSubCat_Oxazepam
 Saved feature importance plot and CSV for SubSubCat_Oxazepam

 Computing feature importance for SubSubCat_Diazepam
 Saved feature importance plot and CSV for SubSubCat_Diazepam

 Computing feature importance for SubSubCat_Paracetamol
 Saved feature importance plot and CSV for SubSubCat_Paracetamol

 Computing feature importance for SubSubCat_Lorazepam
 Saved feature importance plot and CSV for SubSubCat_Lorazepam

 Computing feature importance for SubSubCat_Mirtazapine
 Saved feature importance plot and CSV for SubSubCat_Mirtazapine

 Computing feature importance for SubSubCat_Escitalopram
 Saved feature importance plot and CSV for SubSubCat_Escitalopram

 Computing feature importance for SubSubCat_Sertraline
 Saved feature importance plot and CSV for SubSubCat_Sertraline

 Computing feature importance for SubSubCat_Temazepam
 Saved feature importance plot and CSV for SubSubCat_Temazepam

 Computing feature importance for SubSubCat_Citalopram
 Saved feature importance plot and CSV for SubSubCat_Citalopram

 Computing feature importance for SubSubCat_Quetiapine
 Saved feature importance plot and CSV for SubSubCat_Quetiapine

 Computing feature importance for SubSubCat_Amitriptyline
 Saved feature importance plot and CSV for SubSubCat_Amitriptyline

 Computing feature importance for SubSubCat_Venlafaxine
 Saved feature importance plot and CSV for SubSubCat_Venlafaxine

 Computing feature importance for SubSubCat_Fluoxetine
 Saved feature importance plot and CSV for SubSubCat_Fluoxetine

 Computing feature importance for SubSubCat_Topiramaat
 Saved feature importance plot and CSV for SubSubCat_Topiramaat

 Computing feature importance for SubSubCat_Zopiclon
 Saved feature importance plot and CSV for SubSubCat_Zopiclon

 Computing feature importance for SubSubCat_Bupropion
 Saved feature importance plot and CSV for SubSubCat_Bupropion

 Computing feature importance for SubSubCat_Methylfenidaat
 Saved feature importance plot and CSV for SubSubCat_Methylfenidaat

 Computing feature importance for SubSubCat_Olanzapine
 Saved feature importance plot and CSV for SubSubCat_Olanzapine
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=ccef9e49-f14c-4092-b010-cfcc18a50be2">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[171]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="k">def</span> <span class="nf">compute_trimmed_clipped_iptw</span><span class="p">(</span><span class="n">ps_df</span><span class="p">,</span> <span class="n">treatment</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">clip_max</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">keep_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">ps_df</span> <span class="o">&gt;</span> <span class="n">lower</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ps_df</span> <span class="o">&lt;</span> <span class="n">upper</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ps_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">ps</span> <span class="o">=</span> <span class="n">ps_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">lower</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">1e-6</span><span class="p">)</span>  <span class="c1"># avoid div by zero</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">keep_mask</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">ps</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="n">w</span><span class="p">[</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">treatment</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">ps</span><span class="p">[</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">treatment</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="n">w</span><span class="p">[</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">treatment</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ps</span><span class="p">[</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">treatment</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)])</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">upper</span><span class="o">=</span><span class="n">clip_max</span><span class="p">)</span>
        <span class="n">weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">apply_rubins_rule_to_iptw</span><span class="p">(</span><span class="n">iptw_matrix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Given an IPTW matrix (n rows  M imputations), return Rubins rule pooled mean, SD, SE.</span>
<span class="sd">    """</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">q_bar</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">u_bar</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">total_var</span> <span class="o">=</span> <span class="n">u_bar</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">M</span><span class="p">)</span> <span class="o">*</span> <span class="n">B</span>
    <span class="n">total_se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">total_var</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">q_bar</span><span class="p">,</span> <span class="n">u_bar</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">total_se</span>


<span class="k">def</span> <span class="nf">run_trim_clip_save_all</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Processing IPTW + trimming + clipping for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"outputs"</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">ps_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"propensity_scores.xlsx"</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ps_path</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Missing PS file: </span><span class="si">{</span><span class="n">ps_path</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ps_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">ps_path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">ps_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">ps_all</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"ps_imp"</span><span class="p">)]</span>
            <span class="n">composite_index</span> <span class="o">=</span> <span class="n">ps_all</span><span class="o">.</span><span class="n">index</span>

            <span class="c1"># Get treatment from one imputed dataset</span>
            <span class="n">T_full</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">imputed_dfs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">T_full</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">composite_index</span><span class="p">,</span> <span class="n">group</span><span class="p">]</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="n">T_full</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Treatment column </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> not found in any imputed dataset."</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Compute IPTW matrix (shape: n  M)</span>
            <span class="n">iptw_matrix</span> <span class="o">=</span> <span class="n">compute_trimmed_clipped_iptw</span><span class="p">(</span><span class="n">ps_all</span><span class="p">[</span><span class="n">ps_cols</span><span class="p">],</span> <span class="n">T_full</span><span class="p">)</span>
            <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">"iptw_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iptw_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>

            <span class="c1"># Apply Rubins Rule for mean, SD, SE</span>
            <span class="n">iptw_matrix</span><span class="p">[</span><span class="s2">"iptw_mean"</span><span class="p">],</span> <span class="n">iptw_matrix</span><span class="p">[</span><span class="s2">"iptw_sd"</span><span class="p">],</span> <span class="n">iptw_matrix</span><span class="p">[</span><span class="s2">"iptw_se"</span><span class="p">]</span> <span class="o">=</span> <span class="n">apply_rubins_rule_to_iptw</span><span class="p">(</span>
                <span class="n">iptw_matrix</span><span class="p">[[</span><span class="sa">f</span><span class="s2">"iptw_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iptw_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]]</span>
            <span class="p">)</span>

            <span class="c1"># Save IPTW matrix separately</span>
            <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"iptw_weights.xlsx"</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Saved IPTW weights for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

            <span class="c1"># Save trimmed &amp; clipped imputed datasets with IPTW</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">imputed_dfs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">trimmed_idx</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="n">needed_cols</span> <span class="o">=</span> <span class="n">final_covariates_map</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">group</span><span class="p">,</span> <span class="s2">"caps5_change_baseline"</span><span class="p">]</span>

                <span class="c1"># Select only necessary columns</span>
                <span class="n">df_trimmed</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">trimmed_idx</span><span class="p">,</span> <span class="n">needed_cols</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">df_trimmed</span><span class="p">[</span><span class="s2">"iptw"</span><span class="p">]</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="p">[</span><span class="sa">f</span><span class="s2">"iptw_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">trimmed_idx</span><span class="p">]</span>

                <span class="c1">#  DROP rows with missing IPTW values</span>
                <span class="n">before</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_trimmed</span><span class="p">)</span>
                <span class="n">df_trimmed</span> <span class="o">=</span> <span class="n">df_trimmed</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">"iptw"</span><span class="p">])</span>
                <span class="n">after</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_trimmed</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"     Retained </span><span class="si">{</span><span class="n">after</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">before</span><span class="si">}</span><span class="s2"> rows after IPTW NaN drop."</span><span class="p">)</span>

                <span class="c1"># Save to .pkl</span>
                <span class="n">df_trimmed</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"trimmed_data_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.pkl"</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   Saved trimmed dataset: </span><span class="si">{</span><span class="n">output_folder</span><span class="si">}</span><span class="s2">/trimmed_data_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.*"</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>


<span class="n">run_trim_clip_save_all</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Processing IPTW + trimming + clipping for SubSubCat_Oxazepam
 Saved IPTW weights for SubSubCat_Oxazepam
     Retained 592/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Oxazepam/trimmed_data_imp1.*
     Retained 615/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Oxazepam/trimmed_data_imp2.*
     Retained 619/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Oxazepam/trimmed_data_imp3.*
     Retained 585/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Oxazepam/trimmed_data_imp4.*
     Retained 590/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Oxazepam/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SubSubCat_Diazepam
 Saved IPTW weights for SubSubCat_Diazepam
     Retained 94/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Diazepam/trimmed_data_imp1.*
     Retained 98/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Diazepam/trimmed_data_imp2.*
     Retained 93/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Diazepam/trimmed_data_imp3.*
     Retained 97/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Diazepam/trimmed_data_imp4.*
     Retained 96/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Diazepam/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SubSubCat_Paracetamol
 Saved IPTW weights for SubSubCat_Paracetamol
     Retained 70/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Paracetamol/trimmed_data_imp1.*
     Retained 72/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Paracetamol/trimmed_data_imp2.*
     Retained 67/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Paracetamol/trimmed_data_imp3.*
     Retained 61/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Paracetamol/trimmed_data_imp4.*
     Retained 66/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Paracetamol/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SubSubCat_Lorazepam
 Saved IPTW weights for SubSubCat_Lorazepam
     Retained 144/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Lorazepam/trimmed_data_imp1.*
     Retained 137/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Lorazepam/trimmed_data_imp2.*
     Retained 149/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Lorazepam/trimmed_data_imp3.*
     Retained 138/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Lorazepam/trimmed_data_imp4.*
     Retained 137/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Lorazepam/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SubSubCat_Mirtazapine
 Saved IPTW weights for SubSubCat_Mirtazapine
     Retained 152/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Mirtazapine/trimmed_data_imp1.*
     Retained 178/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Mirtazapine/trimmed_data_imp2.*
     Retained 169/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Mirtazapine/trimmed_data_imp3.*
     Retained 170/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Mirtazapine/trimmed_data_imp4.*
     Retained 161/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Mirtazapine/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SubSubCat_Escitalopram
 Saved IPTW weights for SubSubCat_Escitalopram
     Retained 148/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Escitalopram/trimmed_data_imp1.*
     Retained 135/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Escitalopram/trimmed_data_imp2.*
     Retained 147/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Escitalopram/trimmed_data_imp3.*
     Retained 148/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Escitalopram/trimmed_data_imp4.*
     Retained 151/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Escitalopram/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SubSubCat_Sertraline
 Saved IPTW weights for SubSubCat_Sertraline
     Retained 235/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Sertraline/trimmed_data_imp1.*
     Retained 259/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Sertraline/trimmed_data_imp2.*
     Retained 250/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Sertraline/trimmed_data_imp3.*
     Retained 257/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Sertraline/trimmed_data_imp4.*
     Retained 237/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Sertraline/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SubSubCat_Temazepam
 Saved IPTW weights for SubSubCat_Temazepam
     Retained 188/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Temazepam/trimmed_data_imp1.*
     Retained 197/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Temazepam/trimmed_data_imp2.*
     Retained 210/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Temazepam/trimmed_data_imp3.*
     Retained 203/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Temazepam/trimmed_data_imp4.*
     Retained 198/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Temazepam/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SubSubCat_Citalopram
 Saved IPTW weights for SubSubCat_Citalopram
     Retained 339/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Citalopram/trimmed_data_imp1.*
     Retained 342/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Citalopram/trimmed_data_imp2.*
     Retained 369/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Citalopram/trimmed_data_imp3.*
     Retained 333/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Citalopram/trimmed_data_imp4.*
     Retained 334/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Citalopram/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SubSubCat_Quetiapine
 Saved IPTW weights for SubSubCat_Quetiapine
     Retained 490/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Quetiapine/trimmed_data_imp1.*
     Retained 509/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Quetiapine/trimmed_data_imp2.*
     Retained 495/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Quetiapine/trimmed_data_imp3.*
     Retained 480/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Quetiapine/trimmed_data_imp4.*
     Retained 491/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Quetiapine/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SubSubCat_Amitriptyline
 Saved IPTW weights for SubSubCat_Amitriptyline
     Retained 107/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Amitriptyline/trimmed_data_imp1.*
     Retained 102/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Amitriptyline/trimmed_data_imp2.*
     Retained 105/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Amitriptyline/trimmed_data_imp3.*
     Retained 104/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Amitriptyline/trimmed_data_imp4.*
     Retained 101/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Amitriptyline/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SubSubCat_Venlafaxine
 Saved IPTW weights for SubSubCat_Venlafaxine
     Retained 116/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Venlafaxine/trimmed_data_imp1.*
     Retained 112/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Venlafaxine/trimmed_data_imp2.*
     Retained 112/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Venlafaxine/trimmed_data_imp3.*
     Retained 123/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Venlafaxine/trimmed_data_imp4.*
     Retained 115/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Venlafaxine/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SubSubCat_Fluoxetine
 Saved IPTW weights for SubSubCat_Fluoxetine
     Retained 152/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Fluoxetine/trimmed_data_imp1.*
     Retained 149/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Fluoxetine/trimmed_data_imp2.*
     Retained 132/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Fluoxetine/trimmed_data_imp3.*
     Retained 152/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Fluoxetine/trimmed_data_imp4.*
     Retained 144/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Fluoxetine/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SubSubCat_Topiramaat
 Saved IPTW weights for SubSubCat_Topiramaat
     Retained 76/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Topiramaat/trimmed_data_imp1.*
     Retained 77/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Topiramaat/trimmed_data_imp2.*
     Retained 78/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Topiramaat/trimmed_data_imp3.*
     Retained 69/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Topiramaat/trimmed_data_imp4.*
     Retained 76/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Topiramaat/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SubSubCat_Zopiclon
 Saved IPTW weights for SubSubCat_Zopiclon
     Retained 62/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Zopiclon/trimmed_data_imp1.*
     Retained 66/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Zopiclon/trimmed_data_imp2.*
     Retained 65/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Zopiclon/trimmed_data_imp3.*
     Retained 67/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Zopiclon/trimmed_data_imp4.*
     Retained 62/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Zopiclon/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SubSubCat_Bupropion
 Saved IPTW weights for SubSubCat_Bupropion
     Retained 54/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Bupropion/trimmed_data_imp1.*
     Retained 60/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Bupropion/trimmed_data_imp2.*
     Retained 51/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Bupropion/trimmed_data_imp3.*
     Retained 57/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Bupropion/trimmed_data_imp4.*
     Retained 60/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Bupropion/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SubSubCat_Methylfenidaat
 Saved IPTW weights for SubSubCat_Methylfenidaat
     Retained 74/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Methylfenidaat/trimmed_data_imp1.*
     Retained 77/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Methylfenidaat/trimmed_data_imp2.*
     Retained 73/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Methylfenidaat/trimmed_data_imp3.*
     Retained 73/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Methylfenidaat/trimmed_data_imp4.*
     Retained 74/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Methylfenidaat/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SubSubCat_Olanzapine
 Saved IPTW weights for SubSubCat_Olanzapine
     Retained 59/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Olanzapine/trimmed_data_imp1.*
     Retained 61/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Olanzapine/trimmed_data_imp2.*
     Retained 64/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Olanzapine/trimmed_data_imp3.*
     Retained 56/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Olanzapine/trimmed_data_imp4.*
     Retained 53/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Olanzapine/trimmed_data_imp5.*
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=9b4ab4ce-3b0b-4fa9-bd99-204c2a8c8d47">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[172]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="k">def</span> <span class="nf">plot_ps_overlap_all_groups</span><span class="p">(</span><span class="n">medication_groups</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Plotting PS overlap for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="n">folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"outputs"</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">ps_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">"propensity_scores.xlsx"</span><span class="p">)</span>
        <span class="n">iptw_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">"iptw_weights.xlsx"</span><span class="p">)</span>
        <span class="n">trimmed_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">"trimmed_data_imp1.pkl"</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ps_file</span><span class="p">,</span> <span class="n">iptw_file</span><span class="p">,</span> <span class="n">trimmed_file</span><span class="p">]):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Missing required files for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ps_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">ps_file</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">iptw_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">iptw_file</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">trimmed_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">trimmed_file</span><span class="p">)</span>

            <span class="c1"># Extract</span>
            <span class="n">ps</span> <span class="o">=</span> <span class="n">ps_df</span><span class="p">[</span><span class="s2">"composite_ps"</span><span class="p">]</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">trimmed_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">iptw_df</span><span class="p">[</span><span class="s2">"iptw_mean"</span><span class="p">]</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">trimmed_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">trimmed_df</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>

            <span class="c1"># Masks to remove NaNs</span>
            <span class="n">treated_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ps</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">w</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
            <span class="n">control_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ps</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">w</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>

            <span class="n">treated</span> <span class="o">=</span> <span class="n">ps</span><span class="p">[</span><span class="n">treated_mask</span><span class="p">]</span>
            <span class="n">treated_w</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="n">treated_mask</span><span class="p">]</span>

            <span class="n">control</span> <span class="o">=</span> <span class="n">ps</span><span class="p">[</span><span class="n">control_mask</span><span class="p">]</span>
            <span class="n">control_w</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="n">control_mask</span><span class="p">]</span>

            <span class="c1"># === Unweighted Plot ===</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">([</span><span class="n">treated</span><span class="p">,</span> <span class="n">control</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="p">[</span><span class="s2">"Treated"</span><span class="p">,</span> <span class="s2">"Control"</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Unweighted PS Overlap - </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Composite Propensity Score"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"Count"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">"ps_overlap_unweighted.png"</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="c1"># === Weighted Plot ===</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">([</span><span class="n">treated</span><span class="p">,</span> <span class="n">control</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="p">[</span><span class="n">treated_w</span><span class="p">,</span> <span class="n">control_w</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="p">[</span><span class="s2">"Treated"</span><span class="p">,</span> <span class="s2">"Control"</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Weighted PS Overlap - </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Composite Propensity Score"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"Weighted Count"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">"ps_overlap_weighted.png"</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Saved unweighted and weighted PS plots for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error processing </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1">#  Run</span>
<span class="n">plot_ps_overlap_all_groups</span><span class="p">(</span><span class="n">medication_groups</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Plotting PS overlap for SubSubCat_Oxazepam
 Saved unweighted and weighted PS plots for SubSubCat_Oxazepam

 Plotting PS overlap for SubSubCat_Diazepam
 Saved unweighted and weighted PS plots for SubSubCat_Diazepam

 Plotting PS overlap for SubSubCat_Paracetamol
 Saved unweighted and weighted PS plots for SubSubCat_Paracetamol

 Plotting PS overlap for SubSubCat_Lorazepam
 Saved unweighted and weighted PS plots for SubSubCat_Lorazepam

 Plotting PS overlap for SubSubCat_Mirtazapine
 Saved unweighted and weighted PS plots for SubSubCat_Mirtazapine

 Plotting PS overlap for SubSubCat_Escitalopram
 Saved unweighted and weighted PS plots for SubSubCat_Escitalopram

 Plotting PS overlap for SubSubCat_Sertraline
 Saved unweighted and weighted PS plots for SubSubCat_Sertraline

 Plotting PS overlap for SubSubCat_Temazepam
 Saved unweighted and weighted PS plots for SubSubCat_Temazepam

 Plotting PS overlap for SubSubCat_Citalopram
 Saved unweighted and weighted PS plots for SubSubCat_Citalopram

 Plotting PS overlap for SubSubCat_Quetiapine
 Saved unweighted and weighted PS plots for SubSubCat_Quetiapine

 Plotting PS overlap for SubSubCat_Amitriptyline
 Saved unweighted and weighted PS plots for SubSubCat_Amitriptyline

 Plotting PS overlap for SubSubCat_Venlafaxine
 Saved unweighted and weighted PS plots for SubSubCat_Venlafaxine

 Plotting PS overlap for SubSubCat_Fluoxetine
 Saved unweighted and weighted PS plots for SubSubCat_Fluoxetine

 Plotting PS overlap for SubSubCat_Topiramaat
 Saved unweighted and weighted PS plots for SubSubCat_Topiramaat

 Plotting PS overlap for SubSubCat_Zopiclon
 Saved unweighted and weighted PS plots for SubSubCat_Zopiclon

 Plotting PS overlap for SubSubCat_Bupropion
 Saved unweighted and weighted PS plots for SubSubCat_Bupropion

 Plotting PS overlap for SubSubCat_Methylfenidaat
 Saved unweighted and weighted PS plots for SubSubCat_Methylfenidaat

 Plotting PS overlap for SubSubCat_Olanzapine
 Saved unweighted and weighted PS plots for SubSubCat_Olanzapine
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=641bfc1a-fb30-4961-917d-ebe4ebcd2912">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[173]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># Set up base output folder</span>
<span class="n">output_base</span> <span class="o">=</span> <span class="s2">"outputs"</span>
<span class="n">ps_file</span> <span class="o">=</span> <span class="s2">"propensity_scores.xlsx"</span>
<span class="n">iptw_file</span> <span class="o">=</span> <span class="s2">"iptw_weights.xlsx"</span>
<span class="n">trimmed_data_file</span> <span class="o">=</span> <span class="s2">"trimmed_data_imp1.pkl"</span>

<span class="c1"># Collect all treatment group folders</span>
<span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">medication_groups</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">g</span><span class="p">))]</span>

<span class="c1"># Generate 4-panel overlap plots</span>
<span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
    <span class="n">group_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Load trimmed treatment info</span>
        <span class="n">trimmed_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="n">trimmed_data_file</span><span class="p">))</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">trimmed_df</span><span class="o">.</span><span class="n">index</span>

        <span class="c1"># Fix: case-insensitive match for treatment variable</span>
        <span class="n">possible_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">trimmed_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">group</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">possible_cols</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Treatment variable </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> not found in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">, skipping."</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">treatment_var</span> <span class="o">=</span> <span class="n">possible_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">trimmed_df</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span>

        <span class="c1"># Load composite PS (aligned to trimmed_df index)</span>
        <span class="n">ps_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="n">ps_file</span><span class="p">),</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">'composite_ps'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ps_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Composite column missing in </span><span class="si">{</span><span class="n">ps_file</span><span class="si">}</span><span class="s2">, skipping </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">."</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">ps</span> <span class="o">=</span> <span class="n">ps_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s1">'composite_ps'</span><span class="p">]</span>

        <span class="c1"># Load IPTW weights (aligned to trimmed_df index)</span>
        <span class="n">weights_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="n">iptw_file</span><span class="p">),</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">'iptw_mean'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">weights_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" IPTW weight column missing in </span><span class="si">{</span><span class="n">iptw_file</span><span class="si">}</span><span class="s2">, skipping </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">."</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">weights_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s1">'iptw_mean'</span><span class="p">]</span>

        <span class="c1"># Prepare 4 datasets</span>
        <span class="n">raw_treated</span> <span class="o">=</span> <span class="n">ps</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">raw_control</span> <span class="o">=</span> <span class="n">ps</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">weighted_treated</span> <span class="o">=</span> <span class="p">(</span><span class="n">ps</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">],</span> <span class="n">weights</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">weighted_control</span> <span class="o">=</span> <span class="p">(</span><span class="n">ps</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">],</span> <span class="n">weights</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Create plot</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Propensity Score Distribution - </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">raw_treated</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'blue'</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Raw Treated"</span><span class="p">)</span>

        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">raw_control</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'green'</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Raw Control"</span><span class="p">)</span>

        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">weighted_treated</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weighted_treated</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'blue'</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Weighted Treated"</span><span class="p">)</span>

        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">weighted_control</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weighted_control</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'green'</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Weighted Control"</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="o">.</span><span class="n">flat</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Propensity Score"</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Count"</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">])</span>

        <span class="c1"># Save figure</span>
        <span class="n">plot_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"four_panel_overlap_</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">.png"</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_path</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Saved: </span><span class="si">{</span><span class="n">plot_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>  Saved: outputs\SubSubCat_Oxazepam\four_panel_overlap_SubSubCat_Oxazepam.png
  Saved: outputs\SubSubCat_Diazepam\four_panel_overlap_SubSubCat_Diazepam.png
  Saved: outputs\SubSubCat_Paracetamol\four_panel_overlap_SubSubCat_Paracetamol.png
  Saved: outputs\SubSubCat_Lorazepam\four_panel_overlap_SubSubCat_Lorazepam.png
  Saved: outputs\SubSubCat_Mirtazapine\four_panel_overlap_SubSubCat_Mirtazapine.png
  Saved: outputs\SubSubCat_Escitalopram\four_panel_overlap_SubSubCat_Escitalopram.png
  Saved: outputs\SubSubCat_Sertraline\four_panel_overlap_SubSubCat_Sertraline.png
  Saved: outputs\SubSubCat_Temazepam\four_panel_overlap_SubSubCat_Temazepam.png
  Saved: outputs\SubSubCat_Citalopram\four_panel_overlap_SubSubCat_Citalopram.png
  Saved: outputs\SubSubCat_Quetiapine\four_panel_overlap_SubSubCat_Quetiapine.png
  Saved: outputs\SubSubCat_Amitriptyline\four_panel_overlap_SubSubCat_Amitriptyline.png
  Saved: outputs\SubSubCat_Venlafaxine\four_panel_overlap_SubSubCat_Venlafaxine.png
  Saved: outputs\SubSubCat_Fluoxetine\four_panel_overlap_SubSubCat_Fluoxetine.png
  Saved: outputs\SubSubCat_Topiramaat\four_panel_overlap_SubSubCat_Topiramaat.png
  Saved: outputs\SubSubCat_Zopiclon\four_panel_overlap_SubSubCat_Zopiclon.png
  Saved: outputs\SubSubCat_Bupropion\four_panel_overlap_SubSubCat_Bupropion.png
  Saved: outputs\SubSubCat_Methylfenidaat\four_panel_overlap_SubSubCat_Methylfenidaat.png
  Saved: outputs\SubSubCat_Olanzapine\four_panel_overlap_SubSubCat_Olanzapine.png
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=09df311b-eec5-417c-971f-6469e9c3c56d">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h1 id="ATT-calculation:">ATT calculation:<a class="anchor-link" href="#ATT-calculation:"></a></h1>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=28309ec4-a8ac-4604-8db3-1d378cf68fb3">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[174]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Weighted</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=55852696-eebd-4277-a40c-626400ce90c9">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[175]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">GradientBoostingRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">r2_score</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">KFold</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">t</span><span class="p">,</span> <span class="n">probplot</span>
<span class="kn">import</span> <span class="nn">xgboost</span> <span class="k">as</span> <span class="nn">xgb</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Configuration</span>
<span class="c1"># -----------------------------</span>
<span class="n">n_repeats</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">seeds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span>
<span class="n">imputations</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">output_folder</span> <span class="o">=</span> <span class="s2">"outputs"</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Diagnostic Plotting Function</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">create_diagnostic_plots</span><span class="p">(</span><span class="n">residuals_data</span><span class="p">,</span> <span class="n">fitted_data</span><span class="p">,</span> <span class="n">group_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Create 4 diagnostic plots for model validation"""</span>
    <span class="n">plots_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"plots"</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">plots_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Flatten the collected data</span>
    <span class="n">all_residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">residuals_data</span><span class="p">)</span>
    <span class="n">all_fitted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">fitted_data</span><span class="p">)</span>
    
    <span class="c1"># Create figure with 2x2 subplots</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Diagnostic Plots - </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">'bold'</span><span class="p">)</span>
    
    <span class="c1"># 1. Residuals vs Fitted</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">all_fitted</span><span class="p">,</span> <span class="n">all_residuals</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Fitted Values'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Residuals'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Residuals vs Fitted'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># 2. QQ Plot</span>
    <span class="n">probplot</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s2">"norm"</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Q-Q Plot (Normal)'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># 3. Residual Histogram</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'skyblue'</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">'black'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Residuals'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Density'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Residual Distribution'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># 4. Scale-Location Plot</span>
    <span class="n">sqrt_abs_residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">))</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">all_fitted</span><span class="p">,</span> <span class="n">sqrt_abs_residuals</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Fitted Values'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'|Residuals|'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Scale-Location Plot'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    
    <span class="c1"># Save plot</span>
    <span class="n">plot_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plots_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s1">.png'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_filename</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">'tight'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Diagnostic plots saved for </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Rubin's Rule</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">rubins_pool</span><span class="p">(</span><span class="n">estimates</span><span class="p">,</span> <span class="n">ses</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">estimates</span><span class="p">)</span>
    <span class="n">q_bar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">estimates</span><span class="p">)</span>
    <span class="n">u_bar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">ses</span><span class="p">))</span>
    <span class="n">b_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">estimates</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">total_var</span> <span class="o">=</span> <span class="n">u_bar</span> <span class="o">+</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">b_m</span><span class="p">)</span>
    <span class="n">total_se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">total_var</span><span class="p">)</span>
    <span class="n">ci_lower</span> <span class="o">=</span> <span class="n">q_bar</span> <span class="o">-</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">total_se</span>
    <span class="n">ci_upper</span> <span class="o">=</span> <span class="n">q_bar</span> <span class="o">+</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">total_se</span>
    <span class="n">p_value</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">q_bar</span> <span class="o">/</span> <span class="n">total_se</span><span class="p">),</span> <span class="n">df</span><span class="o">=</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">rounded_p</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">p_value</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">formatted_p</span> <span class="o">=</span> <span class="s2">"&lt; 0.00001"</span> <span class="k">if</span> <span class="n">rounded_p</span> <span class="o">&lt;=</span> <span class="mf">0.00001</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">rounded_p</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">return</span> <span class="n">q_bar</span><span class="p">,</span> <span class="n">total_se</span><span class="p">,</span> <span class="n">ci_lower</span><span class="p">,</span> <span class="n">ci_upper</span><span class="p">,</span> <span class="n">formatted_p</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># SMD + Variance Ratio</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">calculate_smd_vr</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
    <span class="n">treated</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">control</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">w_treated</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">w_control</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">smd</span><span class="p">,</span> <span class="n">vr</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m1</span><span class="p">,</span> <span class="n">m0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">treated</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">w_treated</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">control</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">w_control</span><span class="p">)</span>
            <span class="n">s1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">((</span><span class="n">treated</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">-</span> <span class="n">m1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w_treated</span><span class="p">))</span>
            <span class="n">s0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">((</span><span class="n">control</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">-</span> <span class="n">m0</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w_control</span><span class="p">))</span>
            <span class="n">pooled_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">s1</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">s0</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">smd</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">m1</span> <span class="o">-</span> <span class="n">m0</span><span class="p">)</span> <span class="o">/</span> <span class="n">pooled_sd</span> <span class="k">if</span> <span class="n">pooled_sd</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">vr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s1</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">s0</span><span class="o">**</span><span class="mi">2</span> <span class="k">if</span> <span class="n">s0</span><span class="o">**</span><span class="mi">2</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">smd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">vr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">smd</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">vr</span><span class="p">)</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># XGBoost Main Loop (No DML)</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">run_xgboost_with_trimmed_data</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="p">):</span>
    <span class="n">att_results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">balance_results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">covariates</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Running XGBoost for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">group_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">group_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">best_result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">best_se</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">"inf"</span><span class="p">)</span>
        
        <span class="c1"># Initialize lists to collect residuals and fitted values for diagnostic plots</span>
        <span class="n">group_residuals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">group_fitted</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="n">seeds</span><span class="p">:</span>
            <span class="n">att_list</span><span class="p">,</span> <span class="n">se_list</span><span class="p">,</span> <span class="n">r2_list</span><span class="p">,</span> <span class="n">rmse_list</span><span class="p">,</span> <span class="n">smd_list</span><span class="p">,</span> <span class="n">vr_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">imp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">imputations</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"trimmed_data_imp</span><span class="si">{</span><span class="n">imp</span><span class="si">}</span><span class="s2">.pkl"</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">or</span> <span class="s2">"iptw"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">T</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
                <span class="n">Y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">"caps5_change_baseline"</span><span class="p">]</span>
                <span class="n">W</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">"iptw"</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">repeat</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_repeats</span><span class="p">):</span>
                    <span class="n">kf</span> <span class="o">=</span> <span class="n">KFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span> <span class="o">+</span> <span class="n">repeat</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">train_idx</span><span class="p">,</span> <span class="n">test_idx</span> <span class="ow">in</span> <span class="n">kf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">X_train</span><span class="p">,</span> <span class="n">T_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">W_train</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span>
                                <span class="n">T</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span>
                                <span class="n">Y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span>
                                <span class="n">W</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span>
                            <span class="p">)</span>

                            <span class="c1"># XGBoost regression model</span>
                            <span class="n">model</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
                            
                            <span class="c1"># Add treatment variable to features</span>
                            <span class="n">X_train_with_T</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                            <span class="n">X_train_with_T</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_train</span>
                            
                            <span class="c1"># Fit model</span>
                            <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_with_T</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="n">W_train</span><span class="p">)</span>
                            
                            <span class="c1"># Predict outcomes for treated and control groups</span>
                            <span class="n">X_treated</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                            <span class="n">X_treated</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="n">X_control</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                            <span class="n">X_control</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                            
                            <span class="n">Y_pred_treated</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_treated</span><span class="p">)</span>
                            <span class="n">Y_pred_control</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_control</span><span class="p">)</span>
                            
                            <span class="c1"># Calculate ATT (Average Treatment Effect on Treated)</span>
                            <span class="n">treated_mask</span> <span class="o">=</span> <span class="n">T_train</span> <span class="o">==</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">treated_mask</span><span class="p">):</span>
                                <span class="n">att</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">Y_pred_treated</span><span class="p">[</span><span class="n">treated_mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">Y_pred_control</span><span class="p">[</span><span class="n">treated_mask</span><span class="p">],</span> 
                                               <span class="n">weights</span><span class="o">=</span><span class="n">W_train</span><span class="p">[</span><span class="n">treated_mask</span><span class="p">])</span>
                                
                                <span class="c1"># Calculate standard error (approximate)</span>
                                <span class="n">treatment_effects</span> <span class="o">=</span> <span class="n">Y_pred_treated</span><span class="p">[</span><span class="n">treated_mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">Y_pred_control</span><span class="p">[</span><span class="n">treated_mask</span><span class="p">]</span>
                                <span class="n">residual</span> <span class="o">=</span> <span class="n">treatment_effects</span> <span class="o">-</span> <span class="n">att</span>
                                <span class="n">se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">W_train</span><span class="p">[</span><span class="n">treated_mask</span><span class="p">]</span> <span class="o">*</span> <span class="n">residual</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">W_train</span><span class="p">[</span><span class="n">treated_mask</span><span class="p">])</span>

                                
                                <span class="n">att_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">att</span><span class="p">)</span>
                                <span class="n">se_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">se</span><span class="p">)</span>

                            <span class="c1"># Model performance metrics</span>
                            <span class="n">Y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train_with_T</span><span class="p">)</span>
                            <span class="n">residuals</span> <span class="o">=</span> <span class="n">Y_train</span> <span class="o">-</span> <span class="n">Y_pred</span>
                            <span class="n">rmse</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_pred</span><span class="p">,</span> <span class="n">squared</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                            <span class="n">r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_pred</span><span class="p">)</span>
                            <span class="n">r2_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
                            <span class="n">rmse_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rmse</span><span class="p">)</span>
                            
                            <span class="c1"># Collect residuals and fitted values for diagnostic plots</span>
                            <span class="n">group_residuals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">residuals</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                            <span class="n">group_fitted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Y_pred</span><span class="p">)</span>

                            <span class="n">smd</span><span class="p">,</span> <span class="n">vr</span> <span class="o">=</span> <span class="n">calculate_smd_vr</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">T_train</span><span class="p">,</span> <span class="n">W_train</span><span class="p">)</span>
                            <span class="n">smd_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smd</span><span class="p">)</span>
                            <span class="n">vr_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vr</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">, seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">, imp </span><span class="si">{</span><span class="n">imp</span><span class="si">}</span><span class="s2">, rep </span><span class="si">{</span><span class="n">repeat</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">att_list</span><span class="p">:</span>
                <span class="n">att</span><span class="p">,</span> <span class="n">se</span><span class="p">,</span> <span class="n">ci_l</span><span class="p">,</span> <span class="n">ci_u</span><span class="p">,</span> <span class="n">p_val</span> <span class="o">=</span> <span class="n">rubins_pool</span><span class="p">(</span><span class="n">att_list</span><span class="p">,</span> <span class="n">se_list</span><span class="p">)</span>
                <span class="n">avg_r2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">r2_list</span><span class="p">)</span>
                <span class="n">avg_rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rmse_list</span><span class="p">)</span>
                <span class="n">avg_smd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">smd_list</span><span class="p">)</span>
                <span class="n">avg_vr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">vr_list</span><span class="p">)</span>

                <span class="n">balance_results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">"group"</span><span class="p">:</span> <span class="n">group</span><span class="p">,</span> <span class="s2">"seed"</span><span class="p">:</span> <span class="n">seed</span><span class="p">,</span> <span class="s2">"smd"</span><span class="p">:</span> <span class="n">avg_smd</span><span class="p">,</span> <span class="s2">"vr"</span><span class="p">:</span> <span class="n">avg_vr</span>
                <span class="p">})</span>

                <span class="k">if</span> <span class="n">se</span> <span class="o">&lt;</span> <span class="n">best_se</span><span class="p">:</span>
                    <span class="n">best_se</span> <span class="o">=</span> <span class="n">se</span>
                    <span class="n">best_result</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">"group"</span><span class="p">:</span> <span class="n">group</span><span class="p">,</span> <span class="s2">"seed"</span><span class="p">:</span> <span class="n">seed</span><span class="p">,</span> <span class="s2">"att"</span><span class="p">:</span> <span class="n">att</span><span class="p">,</span> <span class="s2">"se"</span><span class="p">:</span> <span class="n">se</span><span class="p">,</span>
                        <span class="s2">"ci_lower"</span><span class="p">:</span> <span class="n">ci_l</span><span class="p">,</span> <span class="s2">"ci_upper"</span><span class="p">:</span> <span class="n">ci_u</span><span class="p">,</span> <span class="s2">"p_value"</span><span class="p">:</span> <span class="n">p_val</span><span class="p">,</span>
                        <span class="s2">"r2"</span><span class="p">:</span> <span class="n">avg_r2</span><span class="p">,</span> <span class="s2">"rmse"</span><span class="p">:</span> <span class="n">avg_rmse</span>
                    <span class="p">}</span>

                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> | Seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">: ATT = </span><span class="si">{</span><span class="n">att</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, SE = </span><span class="si">{</span><span class="n">se</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, p = </span><span class="si">{</span><span class="n">p_val</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No valid results for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> | Seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Create diagnostic plots for this group</span>
        <span class="k">if</span> <span class="n">group_residuals</span> <span class="ow">and</span> <span class="n">group_fitted</span><span class="p">:</span>
            <span class="n">create_diagnostic_plots</span><span class="p">(</span><span class="n">group_residuals</span><span class="p">,</span> <span class="n">group_fitted</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">best_result</span><span class="p">:</span>
            <span class="n">att_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">best_result</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Best result for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">  Seed </span><span class="si">{</span><span class="n">best_result</span><span class="p">[</span><span class="s1">'seed'</span><span class="p">]</span><span class="si">}</span><span class="s2"> | SE = </span><span class="si">{</span><span class="n">best_result</span><span class="p">[</span><span class="s1">'se'</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="c1"># Save final output</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">att_results</span><span class="p">)</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">"xgb_rubin_summary_subsubcats.xlsx"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">balance_results</span><span class="p">)</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">"smd_vr_summary_subsubcats.xlsx"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> All summary files saved."</span><span class="p">)</span>

<span class="n">run_xgboost_with_trimmed_data</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Running XGBoost for SubSubCat_Oxazepam
 SubSubCat_Oxazepam | Seed 1: ATT = 0.1398, SE = 0.6969, p = 0.84264
 SubSubCat_Oxazepam | Seed 2: ATT = 0.1165, SE = 0.9023, p = 0.89833
 SubSubCat_Oxazepam | Seed 3: ATT = 0.0600, SE = 0.7555, p = 0.93736
 SubSubCat_Oxazepam | Seed 4: ATT = 0.1039, SE = 0.8761, p = 0.90661
 SubSubCat_Oxazepam | Seed 5: ATT = 0.0328, SE = 0.8213, p = 0.96849
 SubSubCat_Oxazepam | Seed 6: ATT = 0.0943, SE = 0.7141, p = 0.89602
 SubSubCat_Oxazepam | Seed 7: ATT = 0.0978, SE = 0.6741, p = 0.88581
 SubSubCat_Oxazepam | Seed 8: ATT = 0.1972, SE = 0.8453, p = 0.81752
 SubSubCat_Oxazepam | Seed 9: ATT = 0.1709, SE = 0.7148, p = 0.81312
 SubSubCat_Oxazepam | Seed 10: ATT = 0.0034, SE = 0.7487, p = 0.99636
 Diagnostic plots saved for SubSubCat_Oxazepam
 Best result for SubSubCat_Oxazepam  Seed 7 | SE = 0.6741

 Running XGBoost for SubSubCat_Diazepam
 SubSubCat_Diazepam | Seed 1: ATT = -0.5127, SE = 1.4754, p = 0.73122
 SubSubCat_Diazepam | Seed 2: ATT = -0.6014, SE = 1.5226, p = 0.69637
 SubSubCat_Diazepam | Seed 3: ATT = -0.3875, SE = 1.8575, p = 0.83649
 SubSubCat_Diazepam | Seed 4: ATT = -0.4026, SE = 1.6708, p = 0.81165
 SubSubCat_Diazepam | Seed 5: ATT = -0.4305, SE = 1.4397, p = 0.76750
 SubSubCat_Diazepam | Seed 6: ATT = -0.4422, SE = 1.7430, p = 0.80190
 SubSubCat_Diazepam | Seed 7: ATT = -0.5450, SE = 1.2832, p = 0.67482
 SubSubCat_Diazepam | Seed 8: ATT = -0.5306, SE = 1.4808, p = 0.72322
 SubSubCat_Diazepam | Seed 9: ATT = -0.5001, SE = 1.5743, p = 0.75349
 SubSubCat_Diazepam | Seed 10: ATT = -0.3204, SE = 1.7682, p = 0.85773
 Diagnostic plots saved for SubSubCat_Diazepam
 Best result for SubSubCat_Diazepam  Seed 7 | SE = 1.2832

 Running XGBoost for SubSubCat_Paracetamol
 SubSubCat_Paracetamol | Seed 1: ATT = 2.0060, SE = 2.0653, p = 0.34110
 SubSubCat_Paracetamol | Seed 2: ATT = 1.3759, SE = 1.9453, p = 0.48619
 SubSubCat_Paracetamol | Seed 3: ATT = 1.9679, SE = 2.1816, p = 0.37599
 SubSubCat_Paracetamol | Seed 4: ATT = 1.8281, SE = 1.9382, p = 0.35499
 SubSubCat_Paracetamol | Seed 5: ATT = 1.9048, SE = 2.1664, p = 0.38798
 SubSubCat_Paracetamol | Seed 6: ATT = 1.6510, SE = 1.8254, p = 0.37474
 SubSubCat_Paracetamol | Seed 7: ATT = 1.7165, SE = 1.7410, p = 0.33401
 SubSubCat_Paracetamol | Seed 8: ATT = 1.8578, SE = 1.8845, p = 0.33404
 SubSubCat_Paracetamol | Seed 9: ATT = 1.8414, SE = 1.6747, p = 0.28244
 SubSubCat_Paracetamol | Seed 10: ATT = 1.7825, SE = 1.9482, p = 0.36933
 Diagnostic plots saved for SubSubCat_Paracetamol
 Best result for SubSubCat_Paracetamol  Seed 9 | SE = 1.6747

 Running XGBoost for SubSubCat_Lorazepam
 SubSubCat_Lorazepam | Seed 1: ATT = 0.0293, SE = 1.5040, p = 0.98461
 SubSubCat_Lorazepam | Seed 2: ATT = -0.0444, SE = 1.6618, p = 0.97892
 SubSubCat_Lorazepam | Seed 3: ATT = 0.0300, SE = 1.6289, p = 0.98547
 SubSubCat_Lorazepam | Seed 4: ATT = -0.1560, SE = 1.3570, p = 0.90942
 SubSubCat_Lorazepam | Seed 5: ATT = -0.0642, SE = 1.2546, p = 0.95963
 SubSubCat_Lorazepam | Seed 6: ATT = -0.0088, SE = 1.7795, p = 0.99608
 SubSubCat_Lorazepam | Seed 7: ATT = -0.0527, SE = 1.2798, p = 0.96747
 SubSubCat_Lorazepam | Seed 8: ATT = -0.1095, SE = 1.2075, p = 0.92847
 SubSubCat_Lorazepam | Seed 9: ATT = 0.0840, SE = 1.3158, p = 0.94961
 SubSubCat_Lorazepam | Seed 10: ATT = -0.1499, SE = 1.5363, p = 0.92308
 Diagnostic plots saved for SubSubCat_Lorazepam
 Best result for SubSubCat_Lorazepam  Seed 8 | SE = 1.2075

 Running XGBoost for SubSubCat_Mirtazapine
 SubSubCat_Mirtazapine | Seed 1: ATT = 6.9949, SE = 2.6141, p = 0.01322
 SubSubCat_Mirtazapine | Seed 2: ATT = 7.1547, SE = 2.2382, p = 0.00387
 SubSubCat_Mirtazapine | Seed 3: ATT = 7.0458, SE = 2.5208, p = 0.01004
 SubSubCat_Mirtazapine | Seed 4: ATT = 7.0449, SE = 2.2661, p = 0.00479
 SubSubCat_Mirtazapine | Seed 5: ATT = 7.1719, SE = 2.0994, p = 0.00227
 SubSubCat_Mirtazapine | Seed 6: ATT = 7.0633, SE = 2.1695, p = 0.00335
 SubSubCat_Mirtazapine | Seed 7: ATT = 6.9811, SE = 2.3444, p = 0.00654
 SubSubCat_Mirtazapine | Seed 8: ATT = 7.1270, SE = 2.5479, p = 0.00999
 SubSubCat_Mirtazapine | Seed 9: ATT = 7.0067, SE = 2.5934, p = 0.01246
 SubSubCat_Mirtazapine | Seed 10: ATT = 7.0948, SE = 2.1856, p = 0.00343
 Diagnostic plots saved for SubSubCat_Mirtazapine
 Best result for SubSubCat_Mirtazapine  Seed 5 | SE = 2.0994

 Running XGBoost for SubSubCat_Escitalopram
 SubSubCat_Escitalopram | Seed 1: ATT = -0.0234, SE = 0.9695, p = 0.98095
 SubSubCat_Escitalopram | Seed 2: ATT = -0.0040, SE = 1.0182, p = 0.99691
 SubSubCat_Escitalopram | Seed 3: ATT = -0.0254, SE = 0.9935, p = 0.97978
 SubSubCat_Escitalopram | Seed 4: ATT = 0.2600, SE = 1.0183, p = 0.80062
 SubSubCat_Escitalopram | Seed 5: ATT = 0.1350, SE = 0.8524, p = 0.87550
 SubSubCat_Escitalopram | Seed 6: ATT = -0.0313, SE = 0.7857, p = 0.96860
 SubSubCat_Escitalopram | Seed 7: ATT = 0.0780, SE = 0.9951, p = 0.93815
 SubSubCat_Escitalopram | Seed 8: ATT = 0.0307, SE = 1.1295, p = 0.97852
 SubSubCat_Escitalopram | Seed 9: ATT = 0.1055, SE = 1.0853, p = 0.92338
 SubSubCat_Escitalopram | Seed 10: ATT = -0.0069, SE = 1.0932, p = 0.99500
 Diagnostic plots saved for SubSubCat_Escitalopram
 Best result for SubSubCat_Escitalopram  Seed 6 | SE = 0.7857

 Running XGBoost for SubSubCat_Sertraline
 SubSubCat_Sertraline | Seed 1: ATT = -0.5243, SE = 0.8513, p = 0.54378
 SubSubCat_Sertraline | Seed 2: ATT = -0.4927, SE = 0.8064, p = 0.54693
 SubSubCat_Sertraline | Seed 3: ATT = -0.5319, SE = 0.8180, p = 0.52168
 SubSubCat_Sertraline | Seed 4: ATT = -0.5127, SE = 0.9045, p = 0.57608
 SubSubCat_Sertraline | Seed 5: ATT = -0.4411, SE = 0.6217, p = 0.48491
 SubSubCat_Sertraline | Seed 6: ATT = -0.5144, SE = 0.8398, p = 0.54593
 SubSubCat_Sertraline | Seed 7: ATT = -0.4878, SE = 0.7485, p = 0.52078
 SubSubCat_Sertraline | Seed 8: ATT = -0.4515, SE = 0.9008, p = 0.62075
 SubSubCat_Sertraline | Seed 9: ATT = -0.5845, SE = 1.0364, p = 0.57803
 SubSubCat_Sertraline | Seed 10: ATT = -0.5054, SE = 0.8787, p = 0.57055
 Diagnostic plots saved for SubSubCat_Sertraline
 Best result for SubSubCat_Sertraline  Seed 5 | SE = 0.6217

 Running XGBoost for SubSubCat_Temazepam
 SubSubCat_Temazepam | Seed 1: ATT = -0.0621, SE = 0.9719, p = 0.94962
 SubSubCat_Temazepam | Seed 2: ATT = -0.2376, SE = 0.6751, p = 0.72795
 SubSubCat_Temazepam | Seed 3: ATT = -0.1886, SE = 0.9659, p = 0.84682
 SubSubCat_Temazepam | Seed 4: ATT = -0.1384, SE = 0.7866, p = 0.86180
 SubSubCat_Temazepam | Seed 5: ATT = -0.1433, SE = 0.8373, p = 0.86552
 SubSubCat_Temazepam | Seed 6: ATT = -0.0888, SE = 0.9022, p = 0.92239
 SubSubCat_Temazepam | Seed 7: ATT = -0.1642, SE = 0.8293, p = 0.84470
 SubSubCat_Temazepam | Seed 8: ATT = -0.1566, SE = 1.1219, p = 0.89012
 SubSubCat_Temazepam | Seed 9: ATT = -0.1842, SE = 0.8820, p = 0.83633
 SubSubCat_Temazepam | Seed 10: ATT = -0.0748, SE = 0.7886, p = 0.92524
 Diagnostic plots saved for SubSubCat_Temazepam
 Best result for SubSubCat_Temazepam  Seed 2 | SE = 0.6751

 Running XGBoost for SubSubCat_Citalopram
 SubSubCat_Citalopram | Seed 1: ATT = -2.0497, SE = 0.8688, p = 0.02679
 SubSubCat_Citalopram | Seed 2: ATT = -2.1069, SE = 0.9193, p = 0.03099
 SubSubCat_Citalopram | Seed 3: ATT = -2.1842, SE = 0.8670, p = 0.01883
 SubSubCat_Citalopram | Seed 4: ATT = -2.2210, SE = 1.0466, p = 0.04434
 SubSubCat_Citalopram | Seed 5: ATT = -2.2056, SE = 1.2059, p = 0.07986
 SubSubCat_Citalopram | Seed 6: ATT = -2.1148, SE = 1.1336, p = 0.07438
 SubSubCat_Citalopram | Seed 7: ATT = -2.0866, SE = 0.8535, p = 0.02221
 SubSubCat_Citalopram | Seed 8: ATT = -2.2219, SE = 0.9348, p = 0.02578
 SubSubCat_Citalopram | Seed 9: ATT = -2.0976, SE = 0.9326, p = 0.03395
 SubSubCat_Citalopram | Seed 10: ATT = -2.0986, SE = 0.9219, p = 0.03203
 Diagnostic plots saved for SubSubCat_Citalopram
 Best result for SubSubCat_Citalopram  Seed 7 | SE = 0.8535

 Running XGBoost for SubSubCat_Quetiapine
 SubSubCat_Quetiapine | Seed 1: ATT = 0.8073, SE = 0.9851, p = 0.42052
 SubSubCat_Quetiapine | Seed 2: ATT = 0.8750, SE = 0.7653, p = 0.26418
 SubSubCat_Quetiapine | Seed 3: ATT = 0.7276, SE = 0.9760, p = 0.46321
 SubSubCat_Quetiapine | Seed 4: ATT = 0.8812, SE = 0.9238, p = 0.34966
 SubSubCat_Quetiapine | Seed 5: ATT = 0.8608, SE = 0.9067, p = 0.35191
 SubSubCat_Quetiapine | Seed 6: ATT = 0.7567, SE = 0.7418, p = 0.31786
 SubSubCat_Quetiapine | Seed 7: ATT = 0.9252, SE = 0.9212, p = 0.32522
 SubSubCat_Quetiapine | Seed 8: ATT = 0.8856, SE = 0.8391, p = 0.30177
 SubSubCat_Quetiapine | Seed 9: ATT = 0.7939, SE = 0.8243, p = 0.34513
 SubSubCat_Quetiapine | Seed 10: ATT = 0.8594, SE = 0.7018, p = 0.23265
 Diagnostic plots saved for SubSubCat_Quetiapine
 Best result for SubSubCat_Quetiapine  Seed 10 | SE = 0.7018

 Running XGBoost for SubSubCat_Amitriptyline
 SubSubCat_Amitriptyline | Seed 1: ATT = 3.8183, SE = 2.6899, p = 0.16861
 SubSubCat_Amitriptyline | Seed 2: ATT = 3.7830, SE = 2.8584, p = 0.19815
 SubSubCat_Amitriptyline | Seed 3: ATT = 3.6753, SE = 2.7134, p = 0.18819
 SubSubCat_Amitriptyline | Seed 4: ATT = 3.7052, SE = 2.7016, p = 0.18291
 SubSubCat_Amitriptyline | Seed 5: ATT = 3.9638, SE = 2.5658, p = 0.13547
 SubSubCat_Amitriptyline | Seed 6: ATT = 3.5303, SE = 2.6447, p = 0.19445
 SubSubCat_Amitriptyline | Seed 7: ATT = 3.8263, SE = 2.7481, p = 0.17658
 SubSubCat_Amitriptyline | Seed 8: ATT = 3.8769, SE = 2.5198, p = 0.13699
 SubSubCat_Amitriptyline | Seed 9: ATT = 4.0593, SE = 2.7886, p = 0.15844
 SubSubCat_Amitriptyline | Seed 10: ATT = 3.9017, SE = 3.0781, p = 0.21711
 Diagnostic plots saved for SubSubCat_Amitriptyline
 Best result for SubSubCat_Amitriptyline  Seed 8 | SE = 2.5198

 Running XGBoost for SubSubCat_Venlafaxine
 SubSubCat_Venlafaxine | Seed 1: ATT = 1.8887, SE = 2.1596, p = 0.39049
 SubSubCat_Venlafaxine | Seed 2: ATT = 1.9534, SE = 1.9466, p = 0.32563
 SubSubCat_Venlafaxine | Seed 3: ATT = 1.8756, SE = 1.8518, p = 0.32124
 SubSubCat_Venlafaxine | Seed 4: ATT = 2.2036, SE = 2.3150, p = 0.35064
 SubSubCat_Venlafaxine | Seed 5: ATT = 2.0009, SE = 2.3106, p = 0.39507
 SubSubCat_Venlafaxine | Seed 6: ATT = 1.7504, SE = 1.8684, p = 0.35818
 SubSubCat_Venlafaxine | Seed 7: ATT = 1.7875, SE = 1.8996, p = 0.35608
 SubSubCat_Venlafaxine | Seed 8: ATT = 2.0064, SE = 2.2272, p = 0.37662
 SubSubCat_Venlafaxine | Seed 9: ATT = 1.9795, SE = 1.9983, p = 0.33178
 SubSubCat_Venlafaxine | Seed 10: ATT = 1.8792, SE = 1.8924, p = 0.33059
 Diagnostic plots saved for SubSubCat_Venlafaxine
 Best result for SubSubCat_Venlafaxine  Seed 3 | SE = 1.8518

 Running XGBoost for SubSubCat_Fluoxetine
 SubSubCat_Fluoxetine | Seed 1: ATT = 5.2650, SE = 2.4917, p = 0.04519
 SubSubCat_Fluoxetine | Seed 2: ATT = 5.3348, SE = 2.3388, p = 0.03172
 SubSubCat_Fluoxetine | Seed 3: ATT = 5.1862, SE = 1.9065, p = 0.01194
 SubSubCat_Fluoxetine | Seed 4: ATT = 5.3089, SE = 2.3069, p = 0.03036
 SubSubCat_Fluoxetine | Seed 5: ATT = 5.1091, SE = 2.3360, p = 0.03871
 SubSubCat_Fluoxetine | Seed 6: ATT = 5.1460, SE = 2.3176, p = 0.03609
 SubSubCat_Fluoxetine | Seed 7: ATT = 4.8414, SE = 2.0751, p = 0.02835
 SubSubCat_Fluoxetine | Seed 8: ATT = 5.1239, SE = 2.1040, p = 0.02268
 SubSubCat_Fluoxetine | Seed 9: ATT = 4.9493, SE = 1.9955, p = 0.02054
 SubSubCat_Fluoxetine | Seed 10: ATT = 5.1633, SE = 2.1273, p = 0.02309
 Diagnostic plots saved for SubSubCat_Fluoxetine
 Best result for SubSubCat_Fluoxetine  Seed 3 | SE = 1.9065

 Running XGBoost for SubSubCat_Topiramaat
 SubSubCat_Topiramaat | Seed 1: ATT = 3.4536, SE = 2.7114, p = 0.21495
 SubSubCat_Topiramaat | Seed 2: ATT = 3.0316, SE = 2.6817, p = 0.26945
 SubSubCat_Topiramaat | Seed 3: ATT = 2.5105, SE = 1.9003, p = 0.19893
 SubSubCat_Topiramaat | Seed 4: ATT = 2.7671, SE = 2.1721, p = 0.21489
 SubSubCat_Topiramaat | Seed 5: ATT = 2.8881, SE = 2.3522, p = 0.23142
 SubSubCat_Topiramaat | Seed 6: ATT = 3.1317, SE = 2.7142, p = 0.25994
 SubSubCat_Topiramaat | Seed 7: ATT = 3.2815, SE = 2.6519, p = 0.22790
 SubSubCat_Topiramaat | Seed 8: ATT = 2.9007, SE = 2.3147, p = 0.22221
 SubSubCat_Topiramaat | Seed 9: ATT = 3.3438, SE = 2.4440, p = 0.18394
 SubSubCat_Topiramaat | Seed 10: ATT = 2.6224, SE = 2.1014, p = 0.22410
 Diagnostic plots saved for SubSubCat_Topiramaat
 Best result for SubSubCat_Topiramaat  Seed 3 | SE = 1.9003

 Running XGBoost for SubSubCat_Zopiclon
 SubSubCat_Zopiclon | Seed 1: ATT = 1.2658, SE = 2.0072, p = 0.53423
 SubSubCat_Zopiclon | Seed 2: ATT = 1.0773, SE = 1.4665, p = 0.46971
 SubSubCat_Zopiclon | Seed 3: ATT = 0.8900, SE = 1.7521, p = 0.61613
 SubSubCat_Zopiclon | Seed 4: ATT = 0.6125, SE = 1.5653, p = 0.69903
 SubSubCat_Zopiclon | Seed 5: ATT = 0.7198, SE = 1.7595, p = 0.68610
 SubSubCat_Zopiclon | Seed 6: ATT = 1.0698, SE = 1.3154, p = 0.42404
 SubSubCat_Zopiclon | Seed 7: ATT = 1.0178, SE = 2.3842, p = 0.67326
 SubSubCat_Zopiclon | Seed 8: ATT = 0.9480, SE = 2.2204, p = 0.67324
 SubSubCat_Zopiclon | Seed 9: ATT = 0.8826, SE = 1.7891, p = 0.62627
 SubSubCat_Zopiclon | Seed 10: ATT = 0.9108, SE = 2.0087, p = 0.65430
 Diagnostic plots saved for SubSubCat_Zopiclon
 Best result for SubSubCat_Zopiclon  Seed 6 | SE = 1.3154

 Running XGBoost for SubSubCat_Bupropion
 SubSubCat_Bupropion | Seed 1: ATT = 1.7441, SE = 2.5131, p = 0.49434
 SubSubCat_Bupropion | Seed 2: ATT = 2.0113, SE = 2.6836, p = 0.46084
 SubSubCat_Bupropion | Seed 3: ATT = 1.7098, SE = 2.1201, p = 0.42790
 SubSubCat_Bupropion | Seed 4: ATT = 1.9650, SE = 2.3562, p = 0.41253
 SubSubCat_Bupropion | Seed 5: ATT = 1.9256, SE = 2.4061, p = 0.43139
 SubSubCat_Bupropion | Seed 6: ATT = 1.7390, SE = 2.7015, p = 0.52587
 SubSubCat_Bupropion | Seed 7: ATT = 2.0308, SE = 2.5986, p = 0.44215
 SubSubCat_Bupropion | Seed 8: ATT = 2.1321, SE = 2.7418, p = 0.44438
 SubSubCat_Bupropion | Seed 9: ATT = 2.0010, SE = 2.4898, p = 0.42948
 SubSubCat_Bupropion | Seed 10: ATT = 1.8020, SE = 2.6932, p = 0.50981
 Diagnostic plots saved for SubSubCat_Bupropion
 Best result for SubSubCat_Bupropion  Seed 3 | SE = 2.1201

 Running XGBoost for SubSubCat_Methylfenidaat
 SubSubCat_Methylfenidaat | Seed 1: ATT = -0.2014, SE = 1.7929, p = 0.91148
 SubSubCat_Methylfenidaat | Seed 2: ATT = 0.0694, SE = 1.4281, p = 0.96165
 SubSubCat_Methylfenidaat | Seed 3: ATT = -0.1299, SE = 1.9456, p = 0.94733
 SubSubCat_Methylfenidaat | Seed 4: ATT = 0.1317, SE = 1.7172, p = 0.93953
 SubSubCat_Methylfenidaat | Seed 5: ATT = 0.0261, SE = 2.0624, p = 0.99002
 SubSubCat_Methylfenidaat | Seed 6: ATT = 0.0628, SE = 1.4983, p = 0.96691
 SubSubCat_Methylfenidaat | Seed 7: ATT = -0.3389, SE = 1.7550, p = 0.84850
 SubSubCat_Methylfenidaat | Seed 8: ATT = 0.0324, SE = 1.3920, p = 0.98162
 SubSubCat_Methylfenidaat | Seed 9: ATT = 0.2166, SE = 1.5910, p = 0.89284
 SubSubCat_Methylfenidaat | Seed 10: ATT = 0.1796, SE = 1.5379, p = 0.90799
 Diagnostic plots saved for SubSubCat_Methylfenidaat
 Best result for SubSubCat_Methylfenidaat  Seed 8 | SE = 1.3920

 Running XGBoost for SubSubCat_Olanzapine
 SubSubCat_Olanzapine | Seed 1: ATT = 3.8633, SE = 4.0447, p = 0.34903
 SubSubCat_Olanzapine | Seed 2: ATT = 3.8465, SE = 4.0344, p = 0.34988
 SubSubCat_Olanzapine | Seed 3: ATT = 3.5135, SE = 3.5578, p = 0.33323
 SubSubCat_Olanzapine | Seed 4: ATT = 3.7040, SE = 4.0828, p = 0.37332
 SubSubCat_Olanzapine | Seed 5: ATT = 3.4194, SE = 4.3791, p = 0.44253
 SubSubCat_Olanzapine | Seed 6: ATT = 3.6148, SE = 3.8898, p = 0.36199
 SubSubCat_Olanzapine | Seed 7: ATT = 3.9886, SE = 3.8572, p = 0.31142
 SubSubCat_Olanzapine | Seed 8: ATT = 3.3019, SE = 3.3285, p = 0.33109
 SubSubCat_Olanzapine | Seed 9: ATT = 3.7349, SE = 4.1105, p = 0.37259
 SubSubCat_Olanzapine | Seed 10: ATT = 3.8193, SE = 4.5818, p = 0.41274
 Diagnostic plots saved for SubSubCat_Olanzapine
 Best result for SubSubCat_Olanzapine  Seed 8 | SE = 3.3285

 All summary files saved.
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=fc754ced-c08e-43a5-85c9-fed4eb54c55e">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[176]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Unweighted:</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=a560fef1-7417-4ef6-900a-9af1618ead6a">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[177]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">GradientBoostingRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">r2_score</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">KFold</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">t</span><span class="p">,</span> <span class="n">probplot</span>
<span class="kn">import</span> <span class="nn">xgboost</span> <span class="k">as</span> <span class="nn">xgb</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Configuration</span>
<span class="c1"># -----------------------------</span>
<span class="n">n_repeats</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">seeds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span>
<span class="n">imputations</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">output_folder</span> <span class="o">=</span> <span class="s2">"outputs"</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Diagnostic Plotting Function</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">create_diagnostic_plots</span><span class="p">(</span><span class="n">residuals_data</span><span class="p">,</span> <span class="n">fitted_data</span><span class="p">,</span> <span class="n">group_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Create 4 diagnostic plots for model validation"""</span>
    <span class="n">plots_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"plots"</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">plots_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Flatten the collected data</span>
    <span class="n">all_residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">residuals_data</span><span class="p">)</span>
    <span class="n">all_fitted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">fitted_data</span><span class="p">)</span>
    
    <span class="c1"># Create figure with 2x2 subplots</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Diagnostic Plots - </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">'bold'</span><span class="p">)</span>
    
    <span class="c1"># 1. Residuals vs Fitted</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">all_fitted</span><span class="p">,</span> <span class="n">all_residuals</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Fitted Values'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Residuals'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Residuals vs Fitted'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># 2. QQ Plot</span>
    <span class="n">probplot</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s2">"norm"</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Q-Q Plot (Normal)'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># 3. Residual Histogram</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'skyblue'</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">'black'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Residuals'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Density'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Residual Distribution'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># 4. Scale-Location Plot</span>
    <span class="n">sqrt_abs_residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">))</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">all_fitted</span><span class="p">,</span> <span class="n">sqrt_abs_residuals</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Fitted Values'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'|Residuals|'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Scale-Location Plot'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    
    <span class="c1"># Save plot</span>
    <span class="n">plot_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plots_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s1">_unweighted.png'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_filename</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">'tight'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Diagnostic plots saved for </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Rubin's Rule</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">rubins_pool</span><span class="p">(</span><span class="n">estimates</span><span class="p">,</span> <span class="n">ses</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">estimates</span><span class="p">)</span>
    <span class="n">q_bar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">estimates</span><span class="p">)</span>
    <span class="n">u_bar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">ses</span><span class="p">))</span>
    <span class="n">b_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">estimates</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">total_var</span> <span class="o">=</span> <span class="n">u_bar</span> <span class="o">+</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">b_m</span><span class="p">)</span>
    <span class="n">total_se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">total_var</span><span class="p">)</span>
    <span class="n">ci_lower</span> <span class="o">=</span> <span class="n">q_bar</span> <span class="o">-</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">total_se</span>
    <span class="n">ci_upper</span> <span class="o">=</span> <span class="n">q_bar</span> <span class="o">+</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">total_se</span>
    <span class="n">p_value</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">q_bar</span> <span class="o">/</span> <span class="n">total_se</span><span class="p">),</span> <span class="n">df</span><span class="o">=</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">rounded_p</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">p_value</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">formatted_p</span> <span class="o">=</span> <span class="s2">"&lt; 0.00001"</span> <span class="k">if</span> <span class="n">rounded_p</span> <span class="o">&lt;=</span> <span class="mf">0.00001</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">rounded_p</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">return</span> <span class="n">q_bar</span><span class="p">,</span> <span class="n">total_se</span><span class="p">,</span> <span class="n">ci_lower</span><span class="p">,</span> <span class="n">ci_upper</span><span class="p">,</span> <span class="n">formatted_p</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># SMD + Variance Ratio</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">calculate_smd_vr</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
    <span class="n">treated</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">control</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">smd</span><span class="p">,</span> <span class="n">vr</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m1</span><span class="p">,</span> <span class="n">m0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">treated</span><span class="p">[</span><span class="n">col</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">control</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
            <span class="n">s1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">treated</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
            <span class="n">s0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">control</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
            <span class="n">pooled_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">s1</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">s0</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">smd</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">m1</span> <span class="o">-</span> <span class="n">m0</span><span class="p">)</span> <span class="o">/</span> <span class="n">pooled_sd</span> <span class="k">if</span> <span class="n">pooled_sd</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">vr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s1</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">s0</span><span class="o">**</span><span class="mi">2</span> <span class="k">if</span> <span class="n">s0</span><span class="o">**</span><span class="mi">2</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">smd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">vr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">smd</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">vr</span><span class="p">)</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># XGBoost Main Loop (No DML)</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">run_xgboost_with_trimmed_data</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="p">):</span>
    <span class="n">att_results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">balance_results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">covariates</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Running XGBoost for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">group_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">group_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">best_result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">best_se</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">"inf"</span><span class="p">)</span>
        
        <span class="c1"># Initialize lists to collect residuals and fitted values for diagnostic plots</span>
        <span class="n">group_residuals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">group_fitted</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="n">seeds</span><span class="p">:</span>
            <span class="n">att_list</span><span class="p">,</span> <span class="n">se_list</span><span class="p">,</span> <span class="n">r2_list</span><span class="p">,</span> <span class="n">rmse_list</span><span class="p">,</span> <span class="n">smd_list</span><span class="p">,</span> <span class="n">vr_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">imp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">imputations</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"trimmed_data_imp</span><span class="si">{</span><span class="n">imp</span><span class="si">}</span><span class="s2">.pkl"</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">or</span> <span class="s2">"iptw"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">T</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
                <span class="n">Y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">"caps5_change_baseline"</span><span class="p">]</span>
                <span class="c1">#W = df["iptw"]</span>

                <span class="k">for</span> <span class="n">repeat</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_repeats</span><span class="p">):</span>
                    <span class="n">kf</span> <span class="o">=</span> <span class="n">KFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span> <span class="o">+</span> <span class="n">repeat</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">train_idx</span><span class="p">,</span> <span class="n">test_idx</span> <span class="ow">in</span> <span class="n">kf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">X_train</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">]</span>
                            <span class="n">T_train</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">]</span>
                            <span class="n">Y_train</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">]</span>
                            
                            <span class="c1"># XGBoost regression model</span>
                            <span class="n">model</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
                            
                            <span class="c1"># Add treatment variable to features</span>
                            <span class="n">X_train_with_T</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                            <span class="n">X_train_with_T</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_train</span>
                            
                            <span class="c1"># Fit model</span>
                            <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_with_T</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">)</span>
                            
                            <span class="c1"># Predict outcomes for treated and control groups</span>
                            <span class="n">X_treated</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                            <span class="n">X_treated</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="n">X_control</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                            <span class="n">X_control</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                            
                            <span class="n">Y_pred_treated</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_treated</span><span class="p">)</span>
                            <span class="n">Y_pred_control</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_control</span><span class="p">)</span>
                            
                            <span class="c1"># Calculate ATT (Average Treatment Effect on Treated)</span>
                            <span class="n">treated_mask</span> <span class="o">=</span> <span class="n">T_train</span> <span class="o">==</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">treated_mask</span><span class="p">):</span>
                                <span class="n">att</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Y_pred_treated</span><span class="p">[</span><span class="n">treated_mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">Y_pred_control</span><span class="p">[</span><span class="n">treated_mask</span><span class="p">])</span>
                                
                                <span class="c1"># Calculate standard error (approximate)</span>
                                <span class="n">treatment_effects</span> <span class="o">=</span> <span class="n">Y_pred_treated</span><span class="p">[</span><span class="n">treated_mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">Y_pred_control</span><span class="p">[</span><span class="n">treated_mask</span><span class="p">]</span>
                                <span class="n">residual</span> <span class="o">=</span> <span class="n">treatment_effects</span> <span class="o">-</span> <span class="n">att</span>
                                <span class="n">se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">residual</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">treated_mask</span><span class="p">)</span>
                                <span class="n">att_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">att</span><span class="p">)</span>
                                <span class="n">se_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">se</span><span class="p">)</span>

                            <span class="c1"># Model performance metrics</span>
                            <span class="n">Y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train_with_T</span><span class="p">)</span>
                            <span class="n">residuals</span> <span class="o">=</span> <span class="n">Y_train</span> <span class="o">-</span> <span class="n">Y_pred</span>
                            <span class="n">rmse</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_pred</span><span class="p">,</span> <span class="n">squared</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                            <span class="n">r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_pred</span><span class="p">)</span>
                            <span class="n">r2_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
                            <span class="n">rmse_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rmse</span><span class="p">)</span>
                            
                            <span class="c1"># Collect residuals and fitted values for diagnostic plots</span>
                            <span class="n">group_residuals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">residuals</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                            <span class="n">group_fitted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Y_pred</span><span class="p">)</span>

                            <span class="n">smd</span><span class="p">,</span> <span class="n">vr</span> <span class="o">=</span> <span class="n">calculate_smd_vr</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">T_train</span><span class="p">)</span>
                            <span class="n">smd_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smd</span><span class="p">)</span>
                            <span class="n">vr_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vr</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">, seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">, imp </span><span class="si">{</span><span class="n">imp</span><span class="si">}</span><span class="s2">, rep </span><span class="si">{</span><span class="n">repeat</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">att_list</span><span class="p">:</span>
                <span class="n">att</span><span class="p">,</span> <span class="n">se</span><span class="p">,</span> <span class="n">ci_l</span><span class="p">,</span> <span class="n">ci_u</span><span class="p">,</span> <span class="n">p_val</span> <span class="o">=</span> <span class="n">rubins_pool</span><span class="p">(</span><span class="n">att_list</span><span class="p">,</span> <span class="n">se_list</span><span class="p">)</span>
                <span class="n">avg_r2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">r2_list</span><span class="p">)</span>
                <span class="n">avg_rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rmse_list</span><span class="p">)</span>
                <span class="n">avg_smd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">smd_list</span><span class="p">)</span>
                <span class="n">avg_vr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">vr_list</span><span class="p">)</span>

                <span class="n">balance_results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">"group"</span><span class="p">:</span> <span class="n">group</span><span class="p">,</span> <span class="s2">"seed"</span><span class="p">:</span> <span class="n">seed</span><span class="p">,</span> <span class="s2">"smd"</span><span class="p">:</span> <span class="n">avg_smd</span><span class="p">,</span> <span class="s2">"vr"</span><span class="p">:</span> <span class="n">avg_vr</span>
                <span class="p">})</span>

                <span class="k">if</span> <span class="n">se</span> <span class="o">&lt;</span> <span class="n">best_se</span><span class="p">:</span>
                    <span class="n">best_se</span> <span class="o">=</span> <span class="n">se</span>
                    <span class="n">best_result</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">"group"</span><span class="p">:</span> <span class="n">group</span><span class="p">,</span> <span class="s2">"seed"</span><span class="p">:</span> <span class="n">seed</span><span class="p">,</span> <span class="s2">"att"</span><span class="p">:</span> <span class="n">att</span><span class="p">,</span> <span class="s2">"se"</span><span class="p">:</span> <span class="n">se</span><span class="p">,</span>
                        <span class="s2">"ci_lower"</span><span class="p">:</span> <span class="n">ci_l</span><span class="p">,</span> <span class="s2">"ci_upper"</span><span class="p">:</span> <span class="n">ci_u</span><span class="p">,</span> <span class="s2">"p_value"</span><span class="p">:</span> <span class="n">p_val</span><span class="p">,</span>
                        <span class="s2">"r2"</span><span class="p">:</span> <span class="n">avg_r2</span><span class="p">,</span> <span class="s2">"rmse"</span><span class="p">:</span> <span class="n">avg_rmse</span>
                    <span class="p">}</span>

                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> | Seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">: ATT = </span><span class="si">{</span><span class="n">att</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, SE = </span><span class="si">{</span><span class="n">se</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, p = </span><span class="si">{</span><span class="n">p_val</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No valid results for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> | Seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Create diagnostic plots for this group</span>
        <span class="k">if</span> <span class="n">group_residuals</span> <span class="ow">and</span> <span class="n">group_fitted</span><span class="p">:</span>
            <span class="n">create_diagnostic_plots</span><span class="p">(</span><span class="n">group_residuals</span><span class="p">,</span> <span class="n">group_fitted</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">best_result</span><span class="p">:</span>
            <span class="n">att_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">best_result</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Best result for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">  Seed </span><span class="si">{</span><span class="n">best_result</span><span class="p">[</span><span class="s1">'seed'</span><span class="p">]</span><span class="si">}</span><span class="s2"> | SE = </span><span class="si">{</span><span class="n">best_result</span><span class="p">[</span><span class="s1">'se'</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="c1"># Save final output</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">att_results</span><span class="p">)</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">"xgb_rubin_summary_subsubcats_unweighted.xlsx"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">balance_results</span><span class="p">)</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">"smd_vr_summary_subsubcats_unweighted.xlsx"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> All summary files saved."</span><span class="p">)</span>

<span class="n">run_xgboost_with_trimmed_data</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Running XGBoost for SubSubCat_Oxazepam
 SubSubCat_Oxazepam | Seed 1: ATT = 0.4660, SE = 0.4607, p = 0.32187
 SubSubCat_Oxazepam | Seed 2: ATT = 0.5233, SE = 0.6932, p = 0.45764
 SubSubCat_Oxazepam | Seed 3: ATT = 0.5467, SE = 0.4936, p = 0.27902
 SubSubCat_Oxazepam | Seed 4: ATT = 0.5285, SE = 0.5555, p = 0.35087
 SubSubCat_Oxazepam | Seed 5: ATT = 0.4692, SE = 0.6476, p = 0.47577
 SubSubCat_Oxazepam | Seed 6: ATT = 0.4884, SE = 0.5518, p = 0.38486
 SubSubCat_Oxazepam | Seed 7: ATT = 0.5387, SE = 0.4879, p = 0.28053
 SubSubCat_Oxazepam | Seed 8: ATT = 0.6066, SE = 0.5849, p = 0.31007
 SubSubCat_Oxazepam | Seed 9: ATT = 0.5567, SE = 0.5302, p = 0.30422
 SubSubCat_Oxazepam | Seed 10: ATT = 0.5311, SE = 0.5072, p = 0.30553
 Diagnostic plots saved for SubSubCat_Oxazepam
 Best result for SubSubCat_Oxazepam  Seed 1 | SE = 0.4607

 Running XGBoost for SubSubCat_Diazepam
 SubSubCat_Diazepam | Seed 1: ATT = -0.8232, SE = 1.3515, p = 0.54817
 SubSubCat_Diazepam | Seed 2: ATT = -0.8187, SE = 1.5352, p = 0.59875
 SubSubCat_Diazepam | Seed 3: ATT = -0.6953, SE = 1.7068, p = 0.68734
 SubSubCat_Diazepam | Seed 4: ATT = -0.8220, SE = 1.3285, p = 0.54192
 SubSubCat_Diazepam | Seed 5: ATT = -0.5436, SE = 1.2927, p = 0.67787
 SubSubCat_Diazepam | Seed 6: ATT = -0.8191, SE = 1.5432, p = 0.60045
 SubSubCat_Diazepam | Seed 7: ATT = -0.6657, SE = 1.0640, p = 0.53748
 SubSubCat_Diazepam | Seed 8: ATT = -0.8679, SE = 1.3060, p = 0.51266
 SubSubCat_Diazepam | Seed 9: ATT = -0.7068, SE = 1.5729, p = 0.65721
 SubSubCat_Diazepam | Seed 10: ATT = -0.6608, SE = 1.5755, p = 0.67861
 Diagnostic plots saved for SubSubCat_Diazepam
 Best result for SubSubCat_Diazepam  Seed 7 | SE = 1.0640

 Running XGBoost for SubSubCat_Paracetamol
 SubSubCat_Paracetamol | Seed 1: ATT = 1.9274, SE = 1.8441, p = 0.30635
 SubSubCat_Paracetamol | Seed 2: ATT = 1.5930, SE = 2.0781, p = 0.45080
 SubSubCat_Paracetamol | Seed 3: ATT = 2.0252, SE = 2.2289, p = 0.37258
 SubSubCat_Paracetamol | Seed 4: ATT = 1.9675, SE = 1.7853, p = 0.28137
 SubSubCat_Paracetamol | Seed 5: ATT = 1.8697, SE = 2.2250, p = 0.40902
 SubSubCat_Paracetamol | Seed 6: ATT = 1.8566, SE = 1.8199, p = 0.31783
 SubSubCat_Paracetamol | Seed 7: ATT = 1.6991, SE = 1.6092, p = 0.30154
 SubSubCat_Paracetamol | Seed 8: ATT = 1.8300, SE = 2.1035, p = 0.39293
 SubSubCat_Paracetamol | Seed 9: ATT = 1.7975, SE = 1.8770, p = 0.34779
 SubSubCat_Paracetamol | Seed 10: ATT = 1.6948, SE = 1.8797, p = 0.37621
 Diagnostic plots saved for SubSubCat_Paracetamol
 Best result for SubSubCat_Paracetamol  Seed 7 | SE = 1.6092

 Running XGBoost for SubSubCat_Lorazepam
 SubSubCat_Lorazepam | Seed 1: ATT = -0.1853, SE = 1.5678, p = 0.90690
 SubSubCat_Lorazepam | Seed 2: ATT = -0.0735, SE = 1.6109, p = 0.96400
 SubSubCat_Lorazepam | Seed 3: ATT = -0.0751, SE = 1.5449, p = 0.96163
 SubSubCat_Lorazepam | Seed 4: ATT = -0.1272, SE = 1.3913, p = 0.92792
 SubSubCat_Lorazepam | Seed 5: ATT = -0.1747, SE = 1.4357, p = 0.90417
 SubSubCat_Lorazepam | Seed 6: ATT = 0.0184, SE = 1.6436, p = 0.99115
 SubSubCat_Lorazepam | Seed 7: ATT = -0.2091, SE = 1.2544, p = 0.86901
 SubSubCat_Lorazepam | Seed 8: ATT = -0.2403, SE = 1.2460, p = 0.84868
 SubSubCat_Lorazepam | Seed 9: ATT = 0.0059, SE = 1.3650, p = 0.99656
 SubSubCat_Lorazepam | Seed 10: ATT = -0.3432, SE = 1.4190, p = 0.81096
 Diagnostic plots saved for SubSubCat_Lorazepam
 Best result for SubSubCat_Lorazepam  Seed 8 | SE = 1.2460

 Running XGBoost for SubSubCat_Mirtazapine
 SubSubCat_Mirtazapine | Seed 1: ATT = 6.4565, SE = 2.4512, p = 0.01454
 SubSubCat_Mirtazapine | Seed 2: ATT = 6.5516, SE = 2.2933, p = 0.00870
 SubSubCat_Mirtazapine | Seed 3: ATT = 6.4311, SE = 2.4144, p = 0.01359
 SubSubCat_Mirtazapine | Seed 4: ATT = 6.3216, SE = 2.1506, p = 0.00716
 SubSubCat_Mirtazapine | Seed 5: ATT = 6.4096, SE = 2.0691, p = 0.00491
 SubSubCat_Mirtazapine | Seed 6: ATT = 6.3515, SE = 2.1182, p = 0.00623
 SubSubCat_Mirtazapine | Seed 7: ATT = 6.3119, SE = 2.1546, p = 0.00733
 SubSubCat_Mirtazapine | Seed 8: ATT = 6.4621, SE = 2.2972, p = 0.00963
 SubSubCat_Mirtazapine | Seed 9: ATT = 6.2747, SE = 2.4760, p = 0.01821
 SubSubCat_Mirtazapine | Seed 10: ATT = 6.2497, SE = 2.0790, p = 0.00612
 Diagnostic plots saved for SubSubCat_Mirtazapine
 Best result for SubSubCat_Mirtazapine  Seed 5 | SE = 2.0691

 Running XGBoost for SubSubCat_Escitalopram
 SubSubCat_Escitalopram | Seed 1: ATT = -0.0118, SE = 0.9331, p = 0.99002
 SubSubCat_Escitalopram | Seed 2: ATT = 0.0394, SE = 0.9331, p = 0.96664
 SubSubCat_Escitalopram | Seed 3: ATT = -0.0534, SE = 0.9512, p = 0.95571
 SubSubCat_Escitalopram | Seed 4: ATT = 0.2721, SE = 1.1518, p = 0.81528
 SubSubCat_Escitalopram | Seed 5: ATT = 0.0677, SE = 0.8941, p = 0.94026
 SubSubCat_Escitalopram | Seed 6: ATT = -0.0613, SE = 0.9589, p = 0.94956
 SubSubCat_Escitalopram | Seed 7: ATT = 0.0483, SE = 0.9494, p = 0.95988
 SubSubCat_Escitalopram | Seed 8: ATT = -0.0020, SE = 1.0731, p = 0.99854
 SubSubCat_Escitalopram | Seed 9: ATT = -0.0261, SE = 1.0517, p = 0.98038
 SubSubCat_Escitalopram | Seed 10: ATT = 0.0533, SE = 1.0154, p = 0.95861
 Diagnostic plots saved for SubSubCat_Escitalopram
 Best result for SubSubCat_Escitalopram  Seed 5 | SE = 0.8941

 Running XGBoost for SubSubCat_Sertraline
 SubSubCat_Sertraline | Seed 1: ATT = -0.2846, SE = 0.5948, p = 0.63666
 SubSubCat_Sertraline | Seed 2: ATT = -0.2493, SE = 0.6767, p = 0.71585
 SubSubCat_Sertraline | Seed 3: ATT = -0.2862, SE = 0.7424, p = 0.70328
 SubSubCat_Sertraline | Seed 4: ATT = -0.2314, SE = 0.8453, p = 0.78660
 SubSubCat_Sertraline | Seed 5: ATT = -0.3176, SE = 0.4627, p = 0.49912
 SubSubCat_Sertraline | Seed 6: ATT = -0.3656, SE = 0.6021, p = 0.54944
 SubSubCat_Sertraline | Seed 7: ATT = -0.3009, SE = 0.6936, p = 0.66827
 SubSubCat_Sertraline | Seed 8: ATT = -0.2851, SE = 0.6961, p = 0.68578
 SubSubCat_Sertraline | Seed 9: ATT = -0.3056, SE = 0.9050, p = 0.73856
 SubSubCat_Sertraline | Seed 10: ATT = -0.2972, SE = 0.5978, p = 0.62361
 Diagnostic plots saved for SubSubCat_Sertraline
 Best result for SubSubCat_Sertraline  Seed 5 | SE = 0.4627

 Running XGBoost for SubSubCat_Temazepam
 SubSubCat_Temazepam | Seed 1: ATT = -0.1251, SE = 1.0239, p = 0.90377
 SubSubCat_Temazepam | Seed 2: ATT = -0.1745, SE = 0.9197, p = 0.85115
 SubSubCat_Temazepam | Seed 3: ATT = -0.1086, SE = 1.0850, p = 0.92108
 SubSubCat_Temazepam | Seed 4: ATT = -0.1974, SE = 0.9193, p = 0.83178
 SubSubCat_Temazepam | Seed 5: ATT = -0.1972, SE = 0.8636, p = 0.82135
 SubSubCat_Temazepam | Seed 6: ATT = -0.0524, SE = 0.9444, p = 0.95624
 SubSubCat_Temazepam | Seed 7: ATT = -0.2180, SE = 0.8524, p = 0.80035
 SubSubCat_Temazepam | Seed 8: ATT = -0.2639, SE = 1.2234, p = 0.83105
 SubSubCat_Temazepam | Seed 9: ATT = -0.3106, SE = 0.9365, p = 0.74303
 SubSubCat_Temazepam | Seed 10: ATT = -0.1367, SE = 0.8507, p = 0.87367
 Diagnostic plots saved for SubSubCat_Temazepam
 Best result for SubSubCat_Temazepam  Seed 10 | SE = 0.8507

 Running XGBoost for SubSubCat_Citalopram
 SubSubCat_Citalopram | Seed 1: ATT = -1.8646, SE = 0.8663, p = 0.04165
 SubSubCat_Citalopram | Seed 2: ATT = -1.8829, SE = 0.7035, p = 0.01320
 SubSubCat_Citalopram | Seed 3: ATT = -1.8869, SE = 0.6733, p = 0.00987
 SubSubCat_Citalopram | Seed 4: ATT = -1.9121, SE = 0.8998, p = 0.04408
 SubSubCat_Citalopram | Seed 5: ATT = -1.9358, SE = 1.1283, p = 0.09911
 SubSubCat_Citalopram | Seed 6: ATT = -1.8442, SE = 1.0734, p = 0.09864
 SubSubCat_Citalopram | Seed 7: ATT = -1.8106, SE = 0.7069, p = 0.01713
 SubSubCat_Citalopram | Seed 8: ATT = -1.9784, SE = 0.6993, p = 0.00928
 SubSubCat_Citalopram | Seed 9: ATT = -1.9349, SE = 0.7117, p = 0.01198
 SubSubCat_Citalopram | Seed 10: ATT = -1.9152, SE = 0.6884, p = 0.01035
 Diagnostic plots saved for SubSubCat_Citalopram
 Best result for SubSubCat_Citalopram  Seed 3 | SE = 0.6733

 Running XGBoost for SubSubCat_Quetiapine
 SubSubCat_Quetiapine | Seed 1: ATT = 1.2665, SE = 0.9670, p = 0.20271
 SubSubCat_Quetiapine | Seed 2: ATT = 1.2827, SE = 0.7260, p = 0.08997
 SubSubCat_Quetiapine | Seed 3: ATT = 1.2094, SE = 1.0720, p = 0.27038
 SubSubCat_Quetiapine | Seed 4: ATT = 1.2556, SE = 0.8839, p = 0.16831
 SubSubCat_Quetiapine | Seed 5: ATT = 1.3224, SE = 0.8850, p = 0.14815
 SubSubCat_Quetiapine | Seed 6: ATT = 1.3155, SE = 0.7800, p = 0.10466
 SubSubCat_Quetiapine | Seed 7: ATT = 1.3573, SE = 0.8512, p = 0.12391
 SubSubCat_Quetiapine | Seed 8: ATT = 1.2768, SE = 0.8117, p = 0.12879
 SubSubCat_Quetiapine | Seed 9: ATT = 1.3310, SE = 0.6276, p = 0.04448
 SubSubCat_Quetiapine | Seed 10: ATT = 1.3377, SE = 0.6444, p = 0.04878
 Diagnostic plots saved for SubSubCat_Quetiapine
 Best result for SubSubCat_Quetiapine  Seed 9 | SE = 0.6276

 Running XGBoost for SubSubCat_Amitriptyline
 SubSubCat_Amitriptyline | Seed 1: ATT = 3.1018, SE = 2.2364, p = 0.17820
 SubSubCat_Amitriptyline | Seed 2: ATT = 2.9874, SE = 2.4884, p = 0.24165
 SubSubCat_Amitriptyline | Seed 3: ATT = 2.9090, SE = 2.4124, p = 0.23963
 SubSubCat_Amitriptyline | Seed 4: ATT = 2.8610, SE = 2.3379, p = 0.23291
 SubSubCat_Amitriptyline | Seed 5: ATT = 2.9976, SE = 2.2529, p = 0.19584
 SubSubCat_Amitriptyline | Seed 6: ATT = 2.9277, SE = 2.4384, p = 0.24160
 SubSubCat_Amitriptyline | Seed 7: ATT = 2.8583, SE = 2.0789, p = 0.18186
 SubSubCat_Amitriptyline | Seed 8: ATT = 3.1058, SE = 2.2609, p = 0.18223
 SubSubCat_Amitriptyline | Seed 9: ATT = 3.2415, SE = 2.2029, p = 0.15416
 SubSubCat_Amitriptyline | Seed 10: ATT = 3.1005, SE = 2.5038, p = 0.22758
 Diagnostic plots saved for SubSubCat_Amitriptyline
 Best result for SubSubCat_Amitriptyline  Seed 7 | SE = 2.0789

 Running XGBoost for SubSubCat_Venlafaxine
 SubSubCat_Venlafaxine | Seed 1: ATT = 1.7290, SE = 1.8229, p = 0.35235
 SubSubCat_Venlafaxine | Seed 2: ATT = 1.8714, SE = 1.8832, p = 0.33025
 SubSubCat_Venlafaxine | Seed 3: ATT = 1.7196, SE = 1.6661, p = 0.31230
 SubSubCat_Venlafaxine | Seed 4: ATT = 1.9439, SE = 1.8178, p = 0.29554
 SubSubCat_Venlafaxine | Seed 5: ATT = 1.8039, SE = 1.9653, p = 0.36781
 SubSubCat_Venlafaxine | Seed 6: ATT = 1.7529, SE = 1.7471, p = 0.32572
 SubSubCat_Venlafaxine | Seed 7: ATT = 1.7454, SE = 1.7191, p = 0.32009
 SubSubCat_Venlafaxine | Seed 8: ATT = 1.7849, SE = 1.8625, p = 0.34743
 SubSubCat_Venlafaxine | Seed 9: ATT = 1.7006, SE = 1.6883, p = 0.32385
 SubSubCat_Venlafaxine | Seed 10: ATT = 1.8843, SE = 1.6991, p = 0.27840
 Diagnostic plots saved for SubSubCat_Venlafaxine
 Best result for SubSubCat_Venlafaxine  Seed 3 | SE = 1.6661

 Running XGBoost for SubSubCat_Fluoxetine
 SubSubCat_Fluoxetine | Seed 1: ATT = 5.0924, SE = 1.9797, p = 0.01672
 SubSubCat_Fluoxetine | Seed 2: ATT = 5.1378, SE = 1.9536, p = 0.01467
 SubSubCat_Fluoxetine | Seed 3: ATT = 5.0647, SE = 1.7380, p = 0.00760
 SubSubCat_Fluoxetine | Seed 4: ATT = 5.1351, SE = 1.9817, p = 0.01602
 SubSubCat_Fluoxetine | Seed 5: ATT = 5.1818, SE = 1.9019, p = 0.01182
 SubSubCat_Fluoxetine | Seed 6: ATT = 4.9757, SE = 2.0182, p = 0.02122
 SubSubCat_Fluoxetine | Seed 7: ATT = 4.9657, SE = 1.6205, p = 0.00532
 SubSubCat_Fluoxetine | Seed 8: ATT = 4.9381, SE = 1.7410, p = 0.00912
 SubSubCat_Fluoxetine | Seed 9: ATT = 5.0025, SE = 1.7321, p = 0.00808
 SubSubCat_Fluoxetine | Seed 10: ATT = 5.0827, SE = 1.7466, p = 0.00768
 Diagnostic plots saved for SubSubCat_Fluoxetine
 Best result for SubSubCat_Fluoxetine  Seed 7 | SE = 1.6205

 Running XGBoost for SubSubCat_Topiramaat
 SubSubCat_Topiramaat | Seed 1: ATT = 4.3095, SE = 2.9770, p = 0.16067
 SubSubCat_Topiramaat | Seed 2: ATT = 3.9709, SE = 2.8417, p = 0.17510
 SubSubCat_Topiramaat | Seed 3: ATT = 3.5628, SE = 1.9714, p = 0.08327
 SubSubCat_Topiramaat | Seed 4: ATT = 3.7498, SE = 2.5046, p = 0.14738
 SubSubCat_Topiramaat | Seed 5: ATT = 3.9689, SE = 2.8306, p = 0.17368
 SubSubCat_Topiramaat | Seed 6: ATT = 4.1517, SE = 3.0444, p = 0.18531
 SubSubCat_Topiramaat | Seed 7: ATT = 4.0571, SE = 3.0424, p = 0.19488
 SubSubCat_Topiramaat | Seed 8: ATT = 4.0615, SE = 2.8501, p = 0.16702
 SubSubCat_Topiramaat | Seed 9: ATT = 3.9627, SE = 2.4394, p = 0.11734
 SubSubCat_Topiramaat | Seed 10: ATT = 3.8922, SE = 2.8609, p = 0.18632
 Diagnostic plots saved for SubSubCat_Topiramaat
 Best result for SubSubCat_Topiramaat  Seed 3 | SE = 1.9714

 Running XGBoost for SubSubCat_Zopiclon
 SubSubCat_Zopiclon | Seed 1: ATT = 1.3762, SE = 1.9049, p = 0.47700
 SubSubCat_Zopiclon | Seed 2: ATT = 1.0310, SE = 1.5114, p = 0.50167
 SubSubCat_Zopiclon | Seed 3: ATT = 0.8567, SE = 1.8110, p = 0.64046
 SubSubCat_Zopiclon | Seed 4: ATT = 0.8153, SE = 1.5572, p = 0.60539
 SubSubCat_Zopiclon | Seed 5: ATT = 0.8365, SE = 1.6685, p = 0.62069
 SubSubCat_Zopiclon | Seed 6: ATT = 1.0399, SE = 1.2995, p = 0.43144
 SubSubCat_Zopiclon | Seed 7: ATT = 0.9385, SE = 2.3552, p = 0.69379
 SubSubCat_Zopiclon | Seed 8: ATT = 1.0560, SE = 2.1605, p = 0.62943
 SubSubCat_Zopiclon | Seed 9: ATT = 0.8261, SE = 1.9424, p = 0.67443
 SubSubCat_Zopiclon | Seed 10: ATT = 0.9562, SE = 1.9962, p = 0.63624
 Diagnostic plots saved for SubSubCat_Zopiclon
 Best result for SubSubCat_Zopiclon  Seed 6 | SE = 1.2995

 Running XGBoost for SubSubCat_Bupropion
 SubSubCat_Bupropion | Seed 1: ATT = 1.9689, SE = 2.4976, p = 0.43824
 SubSubCat_Bupropion | Seed 2: ATT = 2.2258, SE = 2.7322, p = 0.42327
 SubSubCat_Bupropion | Seed 3: ATT = 1.9299, SE = 2.4187, p = 0.43276
 SubSubCat_Bupropion | Seed 4: ATT = 2.0894, SE = 2.4268, p = 0.39777
 SubSubCat_Bupropion | Seed 5: ATT = 2.4066, SE = 2.6896, p = 0.37979
 SubSubCat_Bupropion | Seed 6: ATT = 1.9853, SE = 2.6640, p = 0.46336
 SubSubCat_Bupropion | Seed 7: ATT = 2.1240, SE = 2.7283, p = 0.44386
 SubSubCat_Bupropion | Seed 8: ATT = 2.2006, SE = 2.6047, p = 0.40653
 SubSubCat_Bupropion | Seed 9: ATT = 2.1360, SE = 2.3916, p = 0.38065
 SubSubCat_Bupropion | Seed 10: ATT = 2.0239, SE = 2.6591, p = 0.45400
 Diagnostic plots saved for SubSubCat_Bupropion
 Best result for SubSubCat_Bupropion  Seed 9 | SE = 2.3916

 Running XGBoost for SubSubCat_Methylfenidaat
 SubSubCat_Methylfenidaat | Seed 1: ATT = -1.0266, SE = 1.3317, p = 0.44828
 SubSubCat_Methylfenidaat | Seed 2: ATT = -0.8027, SE = 1.3947, p = 0.57029
 SubSubCat_Methylfenidaat | Seed 3: ATT = -0.9997, SE = 1.7284, p = 0.56840
 SubSubCat_Methylfenidaat | Seed 4: ATT = -0.7320, SE = 1.3032, p = 0.57955
 SubSubCat_Methylfenidaat | Seed 5: ATT = -0.8186, SE = 1.6429, p = 0.62282
 SubSubCat_Methylfenidaat | Seed 6: ATT = -0.6955, SE = 1.2789, p = 0.59158
 SubSubCat_Methylfenidaat | Seed 7: ATT = -1.0126, SE = 1.4956, p = 0.50485
 SubSubCat_Methylfenidaat | Seed 8: ATT = -0.8985, SE = 1.2211, p = 0.46894
 SubSubCat_Methylfenidaat | Seed 9: ATT = -0.6849, SE = 1.3566, p = 0.61826
 SubSubCat_Methylfenidaat | Seed 10: ATT = -0.6802, SE = 1.1437, p = 0.55760
 Diagnostic plots saved for SubSubCat_Methylfenidaat
 Best result for SubSubCat_Methylfenidaat  Seed 10 | SE = 1.1437

 Running XGBoost for SubSubCat_Olanzapine
 SubSubCat_Olanzapine | Seed 1: ATT = 2.9606, SE = 3.0100, p = 0.33513
 SubSubCat_Olanzapine | Seed 2: ATT = 3.0630, SE = 3.0861, p = 0.33085
 SubSubCat_Olanzapine | Seed 3: ATT = 2.7056, SE = 2.8892, p = 0.35836
 SubSubCat_Olanzapine | Seed 4: ATT = 2.9493, SE = 2.9180, p = 0.32223
 SubSubCat_Olanzapine | Seed 5: ATT = 2.4097, SE = 3.6342, p = 0.51361
 SubSubCat_Olanzapine | Seed 6: ATT = 3.0241, SE = 2.8665, p = 0.30194
 SubSubCat_Olanzapine | Seed 7: ATT = 3.2479, SE = 2.9850, p = 0.28737
 SubSubCat_Olanzapine | Seed 8: ATT = 2.9072, SE = 2.6809, p = 0.28895
 SubSubCat_Olanzapine | Seed 9: ATT = 2.8861, SE = 3.1007, p = 0.36123
 SubSubCat_Olanzapine | Seed 10: ATT = 3.0888, SE = 3.6664, p = 0.40785
 Diagnostic plots saved for SubSubCat_Olanzapine
 Best result for SubSubCat_Olanzapine  Seed 8 | SE = 2.6809

 All summary files saved.
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=a4934729-7169-4ea1-8dd7-035896f38f54">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[178]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">sem</span><span class="p">,</span> <span class="n">ttest_ind</span>

<span class="c1"># ----------------------------------</span>
<span class="c1"># File paths</span>
<span class="c1"># ----------------------------------</span>
<span class="n">output_base</span> <span class="o">=</span> <span class="s2">"outputs"</span>
<span class="n">att_file</span> <span class="o">=</span> <span class="s2">"xgb_rubin_summary_subsubcats.xlsx"</span>
<span class="n">trimmed_file</span> <span class="o">=</span> <span class="s2">"trimmed_data_imp1.pkl"</span>
<span class="n">auc_file</span> <span class="o">=</span> <span class="s2">"auc_scores.xlsx"</span>  <span class="c1"># NEW</span>

<span class="c1"># ----------------------------------</span>
<span class="c1"># Load ATT Summary</span>
<span class="c1"># ----------------------------------</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">att_file</span><span class="p">):</span>
    <span class="n">att_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">att_file</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">" ATT summary file not found: xgb_rubin_summary_subsubcats.xlsx"</span><span class="p">)</span>

<span class="n">summary_rows</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># ----------------------------------</span>
<span class="c1"># Loop over medication groups</span>
<span class="c1"># ----------------------------------</span>
<span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">medication_groups</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">g</span><span class="p">))]</span>

<span class="k">for</span> <span class="n">med</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">group_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">med</span><span class="p">)</span>

        <span class="c1"># Load trimmed data</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="n">trimmed_file</span><span class="p">))</span>

        <span class="c1"># Detect treatment column</span>
        <span class="n">treatment_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">med</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">treatment_cols</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Treatment column </span><span class="si">{</span><span class="n">med</span><span class="si">}</span><span class="s2"> not found in trimmed data. Skipping."</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">treatment_var</span> <span class="o">=</span> <span class="n">treatment_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Extract treatment and outcome</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">"caps5_change_baseline"</span><span class="p">]</span>

        <span class="c1"># Treated and control stats</span>
        <span class="n">treated</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">control</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>

        <span class="n">mean_treat</span> <span class="o">=</span> <span class="n">treated</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">se_treat</span> <span class="o">=</span> <span class="n">sem</span><span class="p">(</span><span class="n">treated</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">treated</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">mean_ctrl</span> <span class="o">=</span> <span class="n">control</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">se_ctrl</span> <span class="o">=</span> <span class="n">sem</span><span class="p">(</span><span class="n">control</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">control</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Cohen's d (unadjusted)</span>
        <span class="n">pooled_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">treated</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">control</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">cohen_d</span> <span class="o">=</span> <span class="p">(</span><span class="n">mean_treat</span> <span class="o">-</span> <span class="n">mean_ctrl</span><span class="p">)</span> <span class="o">/</span> <span class="n">pooled_sd</span> <span class="k">if</span> <span class="n">pooled_sd</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># E-value (unadjusted)</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">mean_treat</span> <span class="o">-</span> <span class="n">mean_ctrl</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">delta</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">mean_ctrl</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">mean_ctrl</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Unadjusted p-value</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">t_stat</span><span class="p">,</span> <span class="n">p_val</span> <span class="o">=</span> <span class="n">ttest_ind</span><span class="p">(</span><span class="n">treated</span><span class="p">,</span> <span class="n">control</span><span class="p">,</span> <span class="n">equal_var</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nan_policy</span><span class="o">=</span><span class="s2">"omit"</span><span class="p">)</span>
            <span class="n">rounded_p</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">p_val</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="n">formatted_p</span> <span class="o">=</span> <span class="s2">"&lt; 0.00001"</span> <span class="k">if</span> <span class="n">rounded_p</span> <span class="o">&lt;</span> <span class="mf">0.00001</span> <span class="k">else</span> <span class="n">rounded_p</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">formatted_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># AUC from new auc_scores.xlsx file</span>
        <span class="n">auc_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">auc_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="n">auc_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">auc_path</span><span class="p">):</span>
            <span class="n">auc_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">auc_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">"AUC"</span> <span class="ow">in</span> <span class="n">auc_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">auc_val</span> <span class="o">=</span> <span class="n">auc_df</span><span class="p">[</span><span class="s2">"AUC"</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="c1"># Adjusted stats from Rubin summary</span>
        <span class="n">att_row</span> <span class="o">=</span> <span class="n">att_df</span><span class="p">[</span><span class="n">att_df</span><span class="p">[</span><span class="s2">"group"</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">med</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">att_row</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">att</span> <span class="o">=</span> <span class="n">att_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"att"</span><span class="p">]</span>
            <span class="n">att_se</span> <span class="o">=</span> <span class="n">att_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"se"</span><span class="p">]</span>
            <span class="n">att_p_val</span> <span class="o">=</span> <span class="n">att_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"p_value"</span><span class="p">]</span>
            <span class="n">r2</span> <span class="o">=</span> <span class="n">att_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"r2"</span><span class="p">]</span>
            <span class="n">rmse</span> <span class="o">=</span> <span class="n">att_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"rmse"</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">rounded_att_p</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">att_p_val</span><span class="p">),</span> <span class="mi">5</span><span class="p">)</span>
                <span class="n">formatted_att_p</span> <span class="o">=</span> <span class="s2">"&lt; 0.00001"</span> <span class="k">if</span> <span class="n">rounded_att_p</span> <span class="o">&lt;</span> <span class="mf">0.00001</span> <span class="k">else</span> <span class="n">rounded_att_p</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">formatted_att_p</span> <span class="o">=</span> <span class="n">att_p_val</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">att</span><span class="p">,</span> <span class="n">att_se</span><span class="p">,</span> <span class="n">formatted_att_p</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Append full row</span>
        <span class="n">summary_rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">'Medication Group'</span><span class="p">:</span> <span class="n">med</span><span class="p">,</span>
            <span class="s1">'Mean Treated'</span><span class="p">:</span> <span class="n">mean_treat</span><span class="p">,</span>
            <span class="s1">'SE Treated'</span><span class="p">:</span> <span class="n">se_treat</span><span class="p">,</span>
            <span class="s1">'Mean Control'</span><span class="p">:</span> <span class="n">mean_ctrl</span><span class="p">,</span>
            <span class="s1">'SE Control'</span><span class="p">:</span> <span class="n">se_ctrl</span><span class="p">,</span>
            <span class="s1">'Cohen d'</span><span class="p">:</span> <span class="n">cohen_d</span><span class="p">,</span>
            <span class="s1">'E (Unadjusted)'</span><span class="p">:</span> <span class="n">E</span><span class="p">,</span>
            <span class="s1">'n Treated'</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">treated</span><span class="p">),</span>
            <span class="s1">'n Control'</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">control</span><span class="p">),</span>
            <span class="c1">#'Unadjusted p-value': formatted_p,</span>
            <span class="s1">'ATT Estimate'</span><span class="p">:</span> <span class="n">att</span><span class="p">,</span>
            <span class="s1">'ATT SE (Robust)'</span><span class="p">:</span> <span class="n">att_se</span><span class="p">,</span>
            <span class="s1">'ATT p-value'</span><span class="p">:</span> <span class="n">formatted_att_p</span><span class="p">,</span>
            <span class="s1">'R'</span><span class="p">:</span> <span class="n">r2</span><span class="p">,</span>
            <span class="s1">'RMSE'</span><span class="p">:</span> <span class="n">rmse</span><span class="p">,</span>
            <span class="s1">'AUC'</span><span class="p">:</span> <span class="n">auc_val</span>
        <span class="p">})</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error in </span><span class="si">{</span><span class="n">med</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># ----------------------------------</span>
<span class="c1"># Save final summary</span>
<span class="c1"># ----------------------------------</span>
<span class="n">summary_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">summary_rows</span><span class="p">)</span>
<span class="n">summary_df</span> <span class="o">=</span> <span class="n">summary_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">"Medication Group"</span><span class="p">)</span>
<span class="n">summary_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">"Final_ATT_Summary_SubSubCat.xlsx"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">" Final_ATT_Summary_SubSubCat saved.xlsx"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre> Final_ATT_Summary_SubSubCat saved.xlsx
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=d9fc6c9a-6722-4950-bc5c-eae4aca6bc4b">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[179]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.backends.backend_pdf</span> <span class="kn">import</span> <span class="n">PdfPages</span>

<span class="c1">#  Load the final summary table</span>
<span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s2">"Final_ATT_Summary_SubSubCat.xlsx"</span><span class="p">)</span>

<span class="c1">#  Parse DML p-values (handle "&lt; 0.00001")</span>
<span class="k">def</span> <span class="nf">parse_pval</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">"&lt;"</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.000001</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

<span class="n">final_df</span><span class="p">[</span><span class="s1">'ATT p-value'</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="s1">'ATT p-value'</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">parse_pval</span><span class="p">)</span>

<span class="c1">#  Plot settings</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>

<span class="c1">#  Plotting function for a single medication group</span>
<span class="k">def</span> <span class="nf">plot_single_group</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    
    <span class="n">bars1</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="o">-</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">'Mean Control'</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> 
                   <span class="n">yerr</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">'SE Control'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">'Control'</span><span class="p">,</span> <span class="n">hatch</span><span class="o">=</span><span class="s1">'//'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">bars2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="o">+</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">'Mean Treated'</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> 
                   <span class="n">yerr</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">'SE Treated'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">'Treated'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'steelblue'</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

    <span class="n">label</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">"ATT = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'ATT Estimate'</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span>
        <span class="sa">f</span><span class="s2">"d = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'Cohen d'</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, p = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'ATT p-value'</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span>
        <span class="sa">f</span><span class="s2">"nT = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'n Treated'</span><span class="p">]</span><span class="si">}</span><span class="s2">, nC = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'n Control'</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span>
        <span class="sa">f</span><span class="s2">"E = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'E (Unadjusted)'</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%"</span>
    <span class="p">)</span>
    <span class="n">max_y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">'Mean Control'</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">'Mean Treated'</span><span class="p">])</span> <span class="o">+</span> <span class="mf">1.5</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_y</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">'center'</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">'bottom'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'#FFD700'</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'black'</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="o">-</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">+</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">'Control'</span><span class="p">,</span> <span class="s1">'Treated'</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Group: </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'Medication Group'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">'bold'</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"CAPS5 Change Score"</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="n">max_y</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">fig</span>

<span class="c1">#  Generate and save all plots into a multi-page PDF</span>
<span class="k">with</span> <span class="n">PdfPages</span><span class="p">(</span><span class="s2">"dml_att_barplot_subsubcat.pdf"</span><span class="p">)</span> <span class="k">as</span> <span class="n">pdf</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">final_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_single_group</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="n">pdf</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">'tight'</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">" dml_att_barplot_subsubcat saved.xlsx"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre> dml_att_barplot_subsubcat saved.xlsx
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=3fb20a16-342a-43ce-a51f-2a9d7e47c07e">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[180]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Love plot:</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=fb55a5b1-1691-474a-a290-ba7b2e229dc3">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[181]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="c1"># ----------------------------------------</span>
<span class="c1"># Functions to calculate balance</span>
<span class="c1"># ----------------------------------------</span>
<span class="k">def</span> <span class="nf">calculate_smd</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">w1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">w2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">weighted_mean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span> <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">weighted_var</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">m</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
    
    <span class="n">m1</span> <span class="o">=</span> <span class="n">weighted_mean</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">w1</span><span class="p">)</span> <span class="k">if</span> <span class="n">w1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
    <span class="n">m2</span> <span class="o">=</span> <span class="n">weighted_mean</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span> <span class="k">if</span> <span class="n">w2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">weighted_var</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">w1</span><span class="p">)</span> <span class="k">if</span> <span class="n">w1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">weighted_var</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span> <span class="k">if</span> <span class="n">w2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">pooled_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">v1</span> <span class="o">+</span> <span class="n">v2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">m1</span> <span class="o">-</span> <span class="n">m2</span><span class="p">)</span> <span class="o">/</span> <span class="n">pooled_sd</span> <span class="k">if</span> <span class="n">pooled_sd</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">variance_ratio</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">w1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">w2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">weighted_var</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">m</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
    
    <span class="n">v1</span> <span class="o">=</span> <span class="n">weighted_var</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">w1</span><span class="p">)</span> <span class="k">if</span> <span class="n">w1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">weighted_var</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span> <span class="k">if</span> <span class="n">w2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">v1</span> <span class="o">/</span> <span class="n">v2</span><span class="p">,</span> <span class="n">v2</span> <span class="o">/</span> <span class="n">v1</span><span class="p">)</span> <span class="k">if</span> <span class="n">v1</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">v2</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>

<span class="c1"># ----------------------------------------</span>
<span class="c1"># Setup</span>
<span class="c1"># ----------------------------------------</span>
<span class="n">output_base</span> <span class="o">=</span> <span class="s2">"outputs"</span>
<span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">output_base</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">g</span><span class="p">))]</span>

<span class="c1"># Create a case-insensitive mapping</span>
<span class="n">final_covariates_map_lower</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="c1"># ----------------------------------------</span>
<span class="c1"># Main Loop</span>
<span class="c1"># ----------------------------------------</span>
<span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">group</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_covariates_map_lower</span><span class="p">:</span>
        <span class="k">continue</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Processing </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">..."</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">group_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">covariates</span> <span class="o">=</span> <span class="n">final_covariates_map_lower</span><span class="p">[</span><span class="n">group</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        
        <span class="n">column_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="s2">"trimmed_data_imp1.pkl"</span><span class="p">))</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">group</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">column_name</span> <span class="o">=</span> <span class="n">col</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">column_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Column not found for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">, skipping."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">smd_unw_all</span><span class="p">,</span> <span class="n">smd_w_all</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">vr_unw_all</span><span class="p">,</span> <span class="n">vr_w_all</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
            <span class="n">df_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"trimmed_data_imp</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.pkl"</span><span class="p">)</span>
            <span class="n">iptw_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="s2">"iptw_weights.xlsx"</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">df_path</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">iptw_path</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Missing data for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> imp</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, skipping."</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">df_path</span><span class="p">)</span>
            <span class="n">iptw_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">iptw_path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span>
            <span class="n">W</span> <span class="o">=</span> <span class="n">iptw_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s2">"iptw_mean"</span><span class="p">]</span>

            <span class="n">smd_unw_i</span><span class="p">,</span> <span class="n">smd_w_i</span><span class="p">,</span> <span class="n">vr_unw_i</span><span class="p">,</span> <span class="n">vr_w_i</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">cov</span> <span class="ow">in</span> <span class="n">covariates</span><span class="p">:</span>
                <span class="n">x1</span><span class="p">,</span> <span class="n">x0</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cov</span><span class="p">],</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cov</span><span class="p">]</span>
                <span class="n">w1</span><span class="p">,</span> <span class="n">w0</span> <span class="o">=</span> <span class="n">W</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">],</span> <span class="n">W</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>

                <span class="n">su</span> <span class="o">=</span> <span class="n">calculate_smd</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x0</span><span class="p">)</span>
                <span class="n">sw</span> <span class="o">=</span> <span class="n">calculate_smd</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">w0</span><span class="p">)</span>

                <span class="n">vu</span> <span class="o">=</span> <span class="n">variance_ratio</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x0</span><span class="p">)</span> <span class="k">if</span> <span class="n">cov</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">]</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">vw</span> <span class="o">=</span> <span class="n">variance_ratio</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">w0</span><span class="p">)</span> <span class="k">if</span> <span class="n">cov</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">]</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

                <span class="n">smd_unw_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">su</span><span class="p">)</span>
                <span class="n">smd_w_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sw</span><span class="p">)</span>
                <span class="n">vr_unw_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vu</span><span class="p">)</span>
                <span class="n">vr_w_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vw</span><span class="p">)</span>

            <span class="n">smd_unw_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smd_unw_i</span><span class="p">)</span>
            <span class="n">smd_w_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smd_w_i</span><span class="p">)</span>
            <span class="n">vr_unw_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vr_unw_i</span><span class="p">)</span>
            <span class="n">vr_w_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vr_w_i</span><span class="p">)</span>

        <span class="n">smd_unw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">smd_unw_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">smd_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">smd_w_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">vr_unw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">vr_unw_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">vr_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">vr_w_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">severity</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sw</span> <span class="ow">in</span> <span class="n">smd_w</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sw</span> <span class="o">&lt;=</span> <span class="mf">0.1</span><span class="p">:</span>
                <span class="n">severity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"Good"</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">sw</span> <span class="o">&lt;=</span> <span class="mf">0.2</span><span class="p">:</span>
                <span class="n">severity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"Moderate"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">severity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"Poor"</span><span class="p">)</span>

        <span class="n">covariate_names</span> <span class="o">=</span> <span class="n">covariates</span>
        <span class="n">numeric_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s2">"Covariate"</span><span class="p">:</span> <span class="n">covariate_names</span><span class="p">,</span>
            <span class="s2">"SMD_Unweighted"</span><span class="p">:</span> <span class="n">smd_unw</span><span class="p">,</span>
            <span class="s2">"SMD_Weighted"</span><span class="p">:</span> <span class="n">smd_w</span><span class="p">,</span>
            <span class="s2">"Imbalance_Severity"</span><span class="p">:</span> <span class="n">severity</span><span class="p">,</span>
            <span class="s2">"VR_Unweighted"</span><span class="p">:</span> <span class="n">vr_unw</span><span class="p">,</span>
            <span class="s2">"VR_Weighted"</span><span class="p">:</span> <span class="n">vr_w</span>
        <span class="p">})</span>

        <span class="n">numeric_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"covariate_balance_table_</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">.xlsx"</span><span class="p">)</span>
        <span class="n">numeric_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">numeric_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Exported numeric summary to: </span><span class="si">{</span><span class="n">numeric_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># -------------------------</span>
        <span class="c1"># Plot</span>
        <span class="c1"># -------------------------</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">covariates</span>
        <span class="n">y_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.45</span><span class="p">))</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">smd_unw</span><span class="p">,</span> <span class="n">y_pos</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Unweighted"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">smd_w</span><span class="p">,</span> <span class="n">y_pos</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'blue'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Weighted"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Threshold 0.1"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'black'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Threshold 0.2"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">smd_unw</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">smd_w</span><span class="p">),</span> <span class="mf">0.25</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">y_pos</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Standardized Mean Differences (SMD)"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">"upper right"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">vr_mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">cov</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">]</span> <span class="k">for</span> <span class="n">cov</span> <span class="ow">in</span> <span class="n">covariates</span><span class="p">]</span>
        <span class="n">filtered_y</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vr_mask</span><span class="p">)</span> <span class="k">if</span> <span class="n">b</span><span class="p">]</span>
        <span class="n">filtered_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">filtered_y</span><span class="p">]</span>
        <span class="n">filtered_vr_unw</span> <span class="o">=</span> <span class="p">[</span><span class="n">vr_unw</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">filtered_y</span><span class="p">]</span>
        <span class="n">filtered_vr_w</span> <span class="o">=</span> <span class="p">[</span><span class="n">vr_w</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">filtered_y</span><span class="p">]</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">filtered_vr_unw</span><span class="p">,</span> <span class="n">filtered_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'blue'</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">'o'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Unweighted"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">filtered_vr_w</span><span class="p">,</span> <span class="n">filtered_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">'x'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Weighted"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">filtered_vr_unw</span> <span class="o">+</span> <span class="n">filtered_vr_w</span> <span class="o">+</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">])</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">filtered_y</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">filtered_labels</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Variance Ratio (VR)"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Covariate Balance for </span><span class="si">{</span><span class="n">group</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'CAT_'</span><span class="p">,</span><span class="w"> </span><span class="s1">''</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">'bold'</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.96</span><span class="p">])</span>
        <span class="n">plot_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"love_plot_</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">.pdf"</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Saved love plot: </span><span class="si">{</span><span class="n">plot_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Max weighted SMD for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">smd_w</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Processing SUBSUBCAT_Amitriptyline...
 Exported numeric summary to: outputs\SUBSUBCAT_Amitriptyline\covariate_balance_table_SUBSUBCAT_Amitriptyline.xlsx
 Saved love plot: outputs\SUBSUBCAT_Amitriptyline\love_plot_SUBSUBCAT_Amitriptyline.pdf
 Max weighted SMD for SUBSUBCAT_Amitriptyline: 0.457

 Processing SUBSUBCAT_Bupropion...
 Exported numeric summary to: outputs\SUBSUBCAT_Bupropion\covariate_balance_table_SUBSUBCAT_Bupropion.xlsx
 Saved love plot: outputs\SUBSUBCAT_Bupropion\love_plot_SUBSUBCAT_Bupropion.pdf
 Max weighted SMD for SUBSUBCAT_Bupropion: 0.256

 Processing SUBSUBCAT_Citalopram...
 Exported numeric summary to: outputs\SUBSUBCAT_Citalopram\covariate_balance_table_SUBSUBCAT_Citalopram.xlsx
 Saved love plot: outputs\SUBSUBCAT_Citalopram\love_plot_SUBSUBCAT_Citalopram.pdf
 Max weighted SMD for SUBSUBCAT_Citalopram: 0.285

 Processing SUBSUBCAT_Diazepam...
 Exported numeric summary to: outputs\SUBSUBCAT_Diazepam\covariate_balance_table_SUBSUBCAT_Diazepam.xlsx
 Saved love plot: outputs\SUBSUBCAT_Diazepam\love_plot_SUBSUBCAT_Diazepam.pdf
 Max weighted SMD for SUBSUBCAT_Diazepam: 0.492

 Processing SUBSUBCAT_Escitalopram...
 Exported numeric summary to: outputs\SUBSUBCAT_Escitalopram\covariate_balance_table_SUBSUBCAT_Escitalopram.xlsx
 Saved love plot: outputs\SUBSUBCAT_Escitalopram\love_plot_SUBSUBCAT_Escitalopram.pdf
 Max weighted SMD for SUBSUBCAT_Escitalopram: 0.224

 Processing SUBSUBCAT_Fluoxetine...
 Exported numeric summary to: outputs\SUBSUBCAT_Fluoxetine\covariate_balance_table_SUBSUBCAT_Fluoxetine.xlsx
 Saved love plot: outputs\SUBSUBCAT_Fluoxetine\love_plot_SUBSUBCAT_Fluoxetine.pdf
 Max weighted SMD for SUBSUBCAT_Fluoxetine: 0.269

 Processing SUBSUBCAT_Lorazepam...
 Exported numeric summary to: outputs\SUBSUBCAT_Lorazepam\covariate_balance_table_SUBSUBCAT_Lorazepam.xlsx
 Saved love plot: outputs\SUBSUBCAT_Lorazepam\love_plot_SUBSUBCAT_Lorazepam.pdf
 Max weighted SMD for SUBSUBCAT_Lorazepam: 0.403

 Processing SUBSUBCAT_Methylfenidaat...
 Exported numeric summary to: outputs\SUBSUBCAT_Methylfenidaat\covariate_balance_table_SUBSUBCAT_Methylfenidaat.xlsx
 Saved love plot: outputs\SUBSUBCAT_Methylfenidaat\love_plot_SUBSUBCAT_Methylfenidaat.pdf
 Max weighted SMD for SUBSUBCAT_Methylfenidaat: 0.379

 Processing SUBSUBCAT_Mirtazapine...
 Exported numeric summary to: outputs\SUBSUBCAT_Mirtazapine\covariate_balance_table_SUBSUBCAT_Mirtazapine.xlsx
 Saved love plot: outputs\SUBSUBCAT_Mirtazapine\love_plot_SUBSUBCAT_Mirtazapine.pdf
 Max weighted SMD for SUBSUBCAT_Mirtazapine: 0.270

 Processing SUBSUBCAT_Olanzapine...
 Exported numeric summary to: outputs\SUBSUBCAT_Olanzapine\covariate_balance_table_SUBSUBCAT_Olanzapine.xlsx
 Saved love plot: outputs\SUBSUBCAT_Olanzapine\love_plot_SUBSUBCAT_Olanzapine.pdf
 Max weighted SMD for SUBSUBCAT_Olanzapine: 0.342

 Processing SUBSUBCAT_Oxazepam...
 Exported numeric summary to: outputs\SUBSUBCAT_Oxazepam\covariate_balance_table_SUBSUBCAT_Oxazepam.xlsx
 Saved love plot: outputs\SUBSUBCAT_Oxazepam\love_plot_SUBSUBCAT_Oxazepam.pdf
 Max weighted SMD for SUBSUBCAT_Oxazepam: 0.104

 Processing SUBSUBCAT_Paracetamol...
 Exported numeric summary to: outputs\SUBSUBCAT_Paracetamol\covariate_balance_table_SUBSUBCAT_Paracetamol.xlsx
 Saved love plot: outputs\SUBSUBCAT_Paracetamol\love_plot_SUBSUBCAT_Paracetamol.pdf
 Max weighted SMD for SUBSUBCAT_Paracetamol: 0.349

 Processing SUBSUBCAT_Quetiapine...
 Exported numeric summary to: outputs\SUBSUBCAT_Quetiapine\covariate_balance_table_SUBSUBCAT_Quetiapine.xlsx
 Saved love plot: outputs\SUBSUBCAT_Quetiapine\love_plot_SUBSUBCAT_Quetiapine.pdf
 Max weighted SMD for SUBSUBCAT_Quetiapine: 0.215

 Processing SUBSUBCAT_Sertraline...
 Exported numeric summary to: outputs\SUBSUBCAT_Sertraline\covariate_balance_table_SUBSUBCAT_Sertraline.xlsx
 Saved love plot: outputs\SUBSUBCAT_Sertraline\love_plot_SUBSUBCAT_Sertraline.pdf
 Max weighted SMD for SUBSUBCAT_Sertraline: 0.171

 Processing SUBSUBCAT_Temazepam...
 Exported numeric summary to: outputs\SUBSUBCAT_Temazepam\covariate_balance_table_SUBSUBCAT_Temazepam.xlsx
 Saved love plot: outputs\SUBSUBCAT_Temazepam\love_plot_SUBSUBCAT_Temazepam.pdf
 Max weighted SMD for SUBSUBCAT_Temazepam: 0.239

 Processing SUBSUBCAT_Topiramaat...
 Exported numeric summary to: outputs\SUBSUBCAT_Topiramaat\covariate_balance_table_SUBSUBCAT_Topiramaat.xlsx
 Saved love plot: outputs\SUBSUBCAT_Topiramaat\love_plot_SUBSUBCAT_Topiramaat.pdf
 Max weighted SMD for SUBSUBCAT_Topiramaat: 0.548

 Processing SUBSUBCAT_Venlafaxine...
 Exported numeric summary to: outputs\SUBSUBCAT_Venlafaxine\covariate_balance_table_SUBSUBCAT_Venlafaxine.xlsx
 Saved love plot: outputs\SUBSUBCAT_Venlafaxine\love_plot_SUBSUBCAT_Venlafaxine.pdf
 Max weighted SMD for SUBSUBCAT_Venlafaxine: 0.235

 Processing SUBSUBCAT_Zopiclon...
 Exported numeric summary to: outputs\SUBSUBCAT_Zopiclon\covariate_balance_table_SUBSUBCAT_Zopiclon.xlsx
 Saved love plot: outputs\SUBSUBCAT_Zopiclon\love_plot_SUBSUBCAT_Zopiclon.pdf
 Max weighted SMD for SUBSUBCAT_Zopiclon: 0.365
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=ddcdd856-d7d1-4798-a62a-e15111f052d5">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[182]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Heatmap:</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=5954afc7-c558-47c5-8220-2e870f68f38f">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[183]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="c1">#-----------------------------</span>
<span class="c1"># Generate heatmaps</span>
<span class="c1"># -------------------------------</span>
<span class="k">for</span> <span class="n">treatment_var</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">========== Creating Heatmap for </span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s2"> =========="</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">'outputs'</span><span class="p">,</span> <span class="n">treatment_var</span><span class="p">)</span>
        <span class="n">balance_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'covariate_balance_table_</span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s1">.xlsx'</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">balance_path</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Balance file not found: </span><span class="si">{</span><span class="n">balance_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">balance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">balance_path</span><span class="p">)</span>

        <span class="c1">#  Use finalized covariates + 'Propensity Score'</span>
        <span class="n">covariates</span> <span class="o">=</span> <span class="n">final_covariates_map</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">'Propensity Score'</span><span class="p">]</span>
        <span class="n">balance_df</span> <span class="o">=</span> <span class="n">balance_df</span><span class="p">[</span><span class="n">balance_df</span><span class="p">[</span><span class="s1">'Covariate'</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">covariates</span><span class="p">)]</span>

        <span class="c1">#  Check for CAPS5score_baseline</span>
        <span class="n">highlight_caps</span> <span class="o">=</span> <span class="s1">'CAPS5score_baseline'</span> <span class="ow">in</span> <span class="n">balance_df</span><span class="p">[</span><span class="s1">'Covariate'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="c1">#  Format for heatmap</span>
        <span class="n">heatmap_df</span> <span class="o">=</span> <span class="n">balance_df</span><span class="p">[[</span><span class="s1">'Covariate'</span><span class="p">,</span> <span class="s1">'SMD_Unweighted'</span><span class="p">,</span> <span class="s1">'SMD_Weighted'</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">heatmap_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'Covariate'</span><span class="p">,</span> <span class="s1">'Unweighted'</span><span class="p">,</span> <span class="s1">'Weighted'</span><span class="p">]</span>
        <span class="n">heatmap_df</span> <span class="o">=</span> <span class="n">heatmap_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">'Covariate'</span><span class="p">)</span>
        <span class="n">heatmap_df</span> <span class="o">=</span> <span class="n">heatmap_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">'Unweighted'</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1">#  Plot</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">heatmap_df</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.35</span><span class="p">)))</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span>
            <span class="n">heatmap_df</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="s2">"coolwarm"</span><span class="p">,</span>
            <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">fmt</span><span class="o">=</span><span class="s2">".2f"</span><span class="p">,</span>
            <span class="n">linewidths</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
            <span class="n">linecolor</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span>
            <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">"label"</span><span class="p">:</span> <span class="s2">"Standardized Mean Difference"</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Covariate Balance Heatmap (Rubin IPTW)</span><span class="se">\n</span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">'bold'</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Condition"</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"Covariate"</span><span class="p">)</span>

        <span class="c1">#  Bold CAPS5score_baseline if present</span>
        <span class="k">if</span> <span class="n">highlight_caps</span><span class="p">:</span>
            <span class="n">ylabels</span> <span class="o">=</span> <span class="p">[</span><span class="n">label</span><span class="o">.</span><span class="n">get_text</span><span class="p">()</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span>
                <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2"> "</span> <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="s1">'CAPS5score_baseline'</span> <span class="k">else</span> <span class="n">label</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ylabels</span>
            <span class="p">])</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="c1">#  Save image</span>
        <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'heatmap_smd_</span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s1">.png'</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Heatmap saved: </span><span class="si">{</span><span class="n">save_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error processing </span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
========== Creating Heatmap for SubSubCat_Oxazepam ==========
 Heatmap saved: outputs\SubSubCat_Oxazepam\heatmap_smd_SubSubCat_Oxazepam.png

========== Creating Heatmap for SubSubCat_Diazepam ==========
 Heatmap saved: outputs\SubSubCat_Diazepam\heatmap_smd_SubSubCat_Diazepam.png

========== Creating Heatmap for SubSubCat_Paracetamol ==========
 Heatmap saved: outputs\SubSubCat_Paracetamol\heatmap_smd_SubSubCat_Paracetamol.png

========== Creating Heatmap for SubSubCat_Lorazepam ==========
 Heatmap saved: outputs\SubSubCat_Lorazepam\heatmap_smd_SubSubCat_Lorazepam.png

========== Creating Heatmap for SubSubCat_Mirtazapine ==========
 Heatmap saved: outputs\SubSubCat_Mirtazapine\heatmap_smd_SubSubCat_Mirtazapine.png

========== Creating Heatmap for SubSubCat_Escitalopram ==========
 Heatmap saved: outputs\SubSubCat_Escitalopram\heatmap_smd_SubSubCat_Escitalopram.png

========== Creating Heatmap for SubSubCat_Sertraline ==========
 Heatmap saved: outputs\SubSubCat_Sertraline\heatmap_smd_SubSubCat_Sertraline.png

========== Creating Heatmap for SubSubCat_Temazepam ==========
 Heatmap saved: outputs\SubSubCat_Temazepam\heatmap_smd_SubSubCat_Temazepam.png

========== Creating Heatmap for SubSubCat_Citalopram ==========
 Heatmap saved: outputs\SubSubCat_Citalopram\heatmap_smd_SubSubCat_Citalopram.png

========== Creating Heatmap for SubSubCat_Quetiapine ==========
 Heatmap saved: outputs\SubSubCat_Quetiapine\heatmap_smd_SubSubCat_Quetiapine.png

========== Creating Heatmap for SubSubCat_Amitriptyline ==========
 Heatmap saved: outputs\SubSubCat_Amitriptyline\heatmap_smd_SubSubCat_Amitriptyline.png

========== Creating Heatmap for SubSubCat_Venlafaxine ==========
 Heatmap saved: outputs\SubSubCat_Venlafaxine\heatmap_smd_SubSubCat_Venlafaxine.png

========== Creating Heatmap for SubSubCat_Fluoxetine ==========
 Heatmap saved: outputs\SubSubCat_Fluoxetine\heatmap_smd_SubSubCat_Fluoxetine.png

========== Creating Heatmap for SubSubCat_Topiramaat ==========
 Heatmap saved: outputs\SubSubCat_Topiramaat\heatmap_smd_SubSubCat_Topiramaat.png

========== Creating Heatmap for SubSubCat_Zopiclon ==========
 Heatmap saved: outputs\SubSubCat_Zopiclon\heatmap_smd_SubSubCat_Zopiclon.png

========== Creating Heatmap for SubSubCat_Bupropion ==========
 Heatmap saved: outputs\SubSubCat_Bupropion\heatmap_smd_SubSubCat_Bupropion.png

========== Creating Heatmap for SubSubCat_Methylfenidaat ==========
 Heatmap saved: outputs\SubSubCat_Methylfenidaat\heatmap_smd_SubSubCat_Methylfenidaat.png

========== Creating Heatmap for SubSubCat_Olanzapine ==========
 Heatmap saved: outputs\SubSubCat_Olanzapine\heatmap_smd_SubSubCat_Olanzapine.png
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=41205247-e0b5-4fbc-ba3e-6aef9f0db831">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span> 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=c2fa40d9-c5d4-4d72-b2bb-c7fc640070bd">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h4 id="Linear:">Linear:<a class="anchor-link" href="#Linear:"></a></h4>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=603b1f68-ffa1-4f34-af91-6e956a00dbea">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[184]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">"ignore"</span><span class="p">)</span>  <span class="c1"># optional</span>

<span class="c1"># Option 1 (recommended)</span>
<span class="n">new_path</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">"D:\Work\PTSD_Followup\Linear"</span>

<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">new_path</span><span class="p">)</span>  <span class="c1"># Change working directory</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Changed to:"</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Changed to: D:\Work\PTSD_Followup\Linear
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=d71fe1e9-9097-47b9-a5ae-72f9408705de">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[185]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">r</span><span class="s2">"data_baseline.csv"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=fde047be-55f7-4cad-b980-cf121cf7ec5e">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="CAT-analysis:">CAT analysis:<a class="anchor-link" href="#CAT-analysis:"></a></h3>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=2be65d52-1c12-486c-9558-a1eecf3d9b8b">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[186]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Import all necessary packages</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="c1"># For visualization and future steps</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="kn">from</span> <span class="nn">sklearn.experimental</span> <span class="kn">import</span> <span class="n">enable_iterative_imputer</span>  <span class="c1"># Needed to enable the experimental feature</span>
<span class="kn">from</span> <span class="nn">sklearn.impute</span> <span class="kn">import</span> <span class="n">IterativeImputer</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=e4e72b91-21f3-4b13-bdfc-d027fb163745">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[187]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Check basic structure</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Shape of dataset:"</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Sample columns:"</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[:</span><span class="mi">10</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Missing values:</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>

<span class="c1"># Remove duplicate rows</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>

<span class="c1"># Confirm shape after removing duplicates</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Shape after removing duplicates:"</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Shape of dataset: (6125, 465)

Sample columns: ['CIN5', 'StartDatum', 'BEH_MOD', 'BEHDAGEN_GEPLAND', 'AANTAL_PCL', 'TOESTWO', 'BEH_AFG', 'TK', 'MM_CAPS_IN', 'MM_CAPS_TK']

Missing values:
 instrument_SDV_IN    6125
Eaantal_TK           6125
Dcriterium_FU        6125
Cernst_FU            6125
Caantal_FU           6125
Ccriterium_FU        6125
Bernst_FU            6125
Baantal_FU           6125
Bcriterium_FU        6125
Eernst_TK            6125
dtype: int64
Shape after removing duplicates: (6125, 465)
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=34494260-4db2-4e0e-9415-bd65ce18a0da">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[188]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pyreadstat</span>

<span class="c1"># Load gender info</span>
<span class="n">gender_df</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">pyreadstat</span><span class="o">.</span><span class="n">read_sav</span><span class="p">(</span><span class="s2">"SDV_IN_Gender_2019_2024.sav"</span><span class="p">)</span>

<span class="c1"># Just extract SDV_SEXE column and append to df</span>
<span class="n">df</span><span class="p">[</span><span class="s2">"SDV_SEXE"</span><span class="p">]</span> <span class="o">=</span> <span class="n">gender_df</span><span class="p">[</span><span class="s2">"SDV_SEXE"</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Optional: map to labels</span>
<span class="n">gender_map</span> <span class="o">=</span> <span class="p">{</span><span class="mf">1.0</span><span class="p">:</span> <span class="s2">"Male"</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">:</span> <span class="s2">"Female"</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">:</span> <span class="s2">"Other"</span><span class="p">}</span>
<span class="n">df</span><span class="p">[</span><span class="s2">"gender_label"</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">"SDV_SEXE"</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">gender_map</span><span class="p">)</span>

<span class="c1"># Done! Check a sample</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s2">"SDV_SEXE"</span><span class="p">,</span> <span class="s2">"gender_label"</span><span class="p">]]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>SDV_SEXE  gender_label
2.0       Female          4602
1.0       Male            1475
3.0       Other             48
Name: count, dtype: int64
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=f8c8ee38-b998-4ab6-9123-8dbc00c7014b">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[189]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Gender dummy variables</span>
<span class="n">df</span><span class="p">[</span><span class="s1">'gender_1'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">'gender'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">'gender_2'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">'gender'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># SDV_SEXE dummy variables</span>
<span class="n">df</span><span class="p">[</span><span class="s1">'SDV_SEXE_1'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">'SDV_SEXE'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">'SDV_SEXE_2'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">'SDV_SEXE'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">'SDV_SEXE_3'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">'SDV_SEXE'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># Create binary columns</span>
<span class="n">df</span><span class="p">[</span><span class="s1">'ethnicity_Dutch'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">'ethnicity'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">'ethnicity_other'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">'ethnicity'</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=39916736-26ad-496b-aad5-ad8971ebd97e">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[190]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Columns manually identified for removal (example set from the R script)</span>
<span class="n">cols_to_drop</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'gender'</span><span class="p">,</span> <span class="s1">'ethnicity'</span><span class="p">,</span> <span class="s1">'CIN5'</span><span class="p">,</span> <span class="s1">'SDV_SEXE'</span><span class="p">,</span> <span class="s1">'StartDatum'</span><span class="p">,</span> <span class="s1">'STARTDATUM'</span><span class="p">,</span> <span class="s1">'DROPOUT_EARLYCOMPLETER'</span><span class="p">,</span> <span class="s1">'TOEST_WO'</span><span class="p">,</span>
    <span class="s1">'depressie_IN'</span><span class="p">,</span> <span class="s1">'TERUGKOMER'</span><span class="p">,</span> <span class="s1">'VROEGK_ST'</span><span class="p">,</span> <span class="s1">'gender_label'</span><span class="p">,</span>
    <span class="s1">'depr_m_psychose_huid'</span><span class="p">,</span> <span class="s1">'depr_z_psychose_huid'</span><span class="p">,</span> <span class="s1">'depr_z_psychose_verl'</span><span class="p">,</span>
    <span class="s1">'depr_m_psychose_verl'</span><span class="p">,</span> <span class="s1">'CAPS5score_followup'</span><span class="p">,</span> <span class="s1">'CAPS5_DAT_IN'</span>
<span class="p">]</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols_to_drop</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Remaining columns:"</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Remaining columns: 458
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=64d8554a-5a61-4e93-aad3-cccbb21e91ac">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[191]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="k">if</span> <span class="s1">'BEH_DAGEN'</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">'BEH_DAGEN'</span><span class="p">:</span> <span class="s1">'treatmentdurationdays'</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=13ecc924-a101-4aa2-8bda-6ccb35757f5e">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[192]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Clean and standardize column names</span>
<span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
    <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s2">"\.+"</span><span class="p">,</span> <span class="s2">"_"</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s2">"[^a-zA-Z0-9_]"</span><span class="p">,</span> <span class="s2">""</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">" "</span><span class="p">,</span> <span class="s2">"_"</span><span class="p">)</span>
    <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=5cbcc1fe-29a8-487d-83e7-89ebc407d9df">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[193]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Preview key outcome variables</span>
<span class="n">outcome_vars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'CAPS5Score_TK'</span><span class="p">]</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">outcome_vars</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2"> missing"</span><span class="p">)</span>

<span class="c1"># Calculate change score</span>
<span class="k">if</span> <span class="s1">'CAPS5score_baseline'</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s1">'CAPS5Score_TK'</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">'caps5_change_baseline'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">'CAPS5Score_TK'</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">'CAPS5score_baseline'</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>CAPS5score_baseline: 0 missing
CAPS5Score_TK: 0 missing
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=b6b826fa-2bcc-47be-b765-b9e0ec65d2a2">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[194]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Define exceptions to keep</span>
<span class="n">protected_cols</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">"DIAGNOSIS_ANXIETY_OCD"</span><span class="p">,</span>
    <span class="s2">"DIAGNOSIS_PSYCHOTIC"</span><span class="p">,</span>
    <span class="s2">"DIAGNOSIS_EATING_DISORDER"</span><span class="p">,</span>
    <span class="s2">"DIAGNOSIS_SUBSTANCE_DISORDER"</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"EB_NON_TF_THERAPY"</span><span class="p">,</span> <span class="s2">"OTHER_TREATM_APPROACH"</span><span class="p">,</span> <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s1">'SUBCAT_Selectieve_immunosuppresiva'</span><span class="p">,</span> <span class="s1">'treatmentdurationdays'</span><span class="p">,</span>
<span class="s1">'SUBCAT_Corticosteroiden'</span><span class="p">,</span>
<span class="s1">'SUBCAT_Immunomodulerend_Coxibs'</span><span class="p">,</span>
<span class="s1">'SUBCAT_Aminosalicylaten'</span><span class="p">,</span>
<span class="s1">'SUBCAT_calcineurineremmers'</span><span class="p">,</span>
<span class="s1">'SUBCAT_Anti_epileptica_Benzodiazepine'</span><span class="p">,</span>
<span class="s1">'SUBCAT_Paracetamol_overig_combinatie'</span><span class="p">,</span> <span class="s1">'SUBCAT_MAO_remmers'</span><span class="p">,</span> <span class="s1">'SUBCAT_psychostimulans_overige'</span><span class="p">,</span> <span class="s1">'SUBCAT_Interleukine_remmers'</span>

<span class="p">]</span>


<span class="c1"># ----------------------------------------</span>
<span class="c1"># 1. Drop columns with &gt;95% missing values (except protected)</span>
<span class="n">thresh_missing</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.95</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
<span class="n">missing_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">-</span> <span class="n">thresh_missing</span><span class="p">)]</span>
<span class="n">missing_cols_to_drop</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">missing_cols</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">protected_cols</span><span class="p">]</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">missing_cols_to_drop</span><span class="p">)</span>

<span class="c1"># ----------------------------------------</span>
<span class="c1"># 2. Drop near-zero variance columns (except protected)</span>
<span class="n">low_variance_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">(</span><span class="n">dropna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">protected_cols</span><span class="p">]</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">low_variance_cols</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=7ce9cb46-a001-4a67-a879-12609fe04975">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[195]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">"cleaned_data_baseline.csv"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">" Step 1 Complete: Cleaned dataset saved."</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre> Step 1 Complete: Cleaned dataset saved.
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=efec01fd-23a3-422f-a48f-2c743d1a95b5">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[196]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Target variables:</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=3d2cb15a-68ac-48dc-950d-468a617fa482">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[197]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.impute</span> <span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span> <span class="nn">fancyimpute</span> <span class="kn">import</span> <span class="n">IterativeImputer</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">LabelEncoder</span><span class="p">,</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span> <span class="nn">sklearn.compose</span> <span class="kn">import</span> <span class="n">ColumnTransformer</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=961b11fc-d3ff-48fe-8f66-8f376dc1f989">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[198]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Load the cleaned dataset from Step 1</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">"cleaned_data_baseline.csv"</span><span class="p">)</span>

<span class="c1"># Quick check</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>(6125, 204)
DIAGNOSIS_ANXIETY_OCD           float64
DIAGNOSIS_SMOKING               float64
DIAGNOSIS_EATING_DISORDER       float64
DIAGNOSIS_SUBSTANCE_DISORDER    float64
DIAGNOSIS_PSYCHOTIC             float64
DIAGNOSIS_SUICIDALITY           float64
DIAGNOSIS_SEXUAL_TRAUMA         float64
DIAGNOSIS_CHILDHOOD_TRAUMA        int64
DIAGNOSIS_CPTSD                 float64
treatmentdurationdays           float64
dtype: object
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=4d323534-760c-4cbe-bd3d-b5f256772198">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[199]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Separate Numerical and Categorical Variables</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=06098718-4825-4c06-9b9c-31c5299ec0e9">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[200]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Identify numerical and categorical columns</span>
<span class="n">numerical_cols</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">'float64'</span><span class="p">,</span> <span class="s1">'int64'</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">categorical_cols</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">'object'</span><span class="p">,</span> <span class="s1">'category'</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Numerical Columns: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">numerical_cols</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Categorical Columns: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">categorical_cols</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Numerical Columns: 204
Categorical Columns: 0
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=4ded6f4e-93b5-4070-80e3-f49c67f60ff3">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[201]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># Check missing values for each variable</span>
<span class="n">missing_summary</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC_missing'</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD_missing'</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
    <span class="s1">'Bipolar_and_Mood_disorder_missing'</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">'Bipolar_and_Mood_disorder'</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER_missing'</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
    <span class="s1">'total_rows'</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"Missing values summary:"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">missing_summary</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Missing values summary:
DIAGNOSIS_PSYCHOTIC_missing: 2484
DIAGNOSIS_ANXIETY_OCD_missing: 2484
Bipolar_and_Mood_disorder_missing: 2484
DIAGNOSIS_EATING_DISORDER_missing: 2484
total_rows: 6125
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=504c0817-ce8c-480a-9c95-84cccf05af8e">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[202]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Define the mental health variables</span>
<span class="n">mental_health_vars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span> 
                      <span class="s1">'Bipolar_and_Mood_disorder'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">]</span>

<span class="c1"># Check patients with missing data on any of the 4 variables</span>
<span class="n">df</span><span class="p">[</span><span class="s1">'has_missing'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">mental_health_vars</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Summary of missing pattern</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Missing data pattern:"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">'has_missing'</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Patients with missing data: </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="s1">'has_missing'</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Patients with complete data: </span><span class="si">{</span><span class="p">(</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s1">'has_missing'</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
Missing data pattern:
has_missing
False    3641
True     2484
Name: count, dtype: int64
Patients with missing data: 2484
Patients with complete data: 3641
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=5eeef0d4-84c0-4015-b9c9-d7717beca3de">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[203]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Store original count before filtering</span>
<span class="n">original_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="c1"># Filter to keep only complete cases (this modifies df)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">mental_health_vars</span><span class="p">)</span>

<span class="c1"># Get the count after filtering</span>
<span class="n">complete_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="c1"># Calculate excluded count</span>
<span class="n">excluded_count</span> <span class="o">=</span> <span class="n">original_count</span> <span class="o">-</span> <span class="n">complete_count</span>

<span class="c1"># Verify the counts</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Dataset summary:"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Original dataset: </span><span class="si">{</span><span class="n">original_count</span><span class="si">}</span><span class="s2"> observations"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Complete cases: </span><span class="si">{</span><span class="n">complete_count</span><span class="si">}</span><span class="s2"> observations"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Excluded (missing): </span><span class="si">{</span><span class="n">excluded_count</span><span class="si">}</span><span class="s2"> observations"</span><span class="p">)</span>

<span class="c1"># Remove the temporary column (if it exists)</span>
<span class="k">if</span> <span class="s1">'has_missing'</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">'has_missing'</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
Dataset summary:
Original dataset: 6125 observations
Complete cases: 3641 observations
Excluded (missing): 2484 observations
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=9e6f3da8-9252-40e9-9816-402ddc5c3033">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[204]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Check the 4 variables you filtered on (should be 0 missing)</span>
<span class="n">mental_health_vars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span> 
                      <span class="s1">'Bipolar_and_Mood_disorder'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Missing values in mental health variables:"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">mental_health_vars</span><span class="p">:</span>
    <span class="n">missing</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
Missing values in mental health variables:
DIAGNOSIS_PSYCHOTIC: 0
DIAGNOSIS_ANXIETY_OCD: 0
Bipolar_and_Mood_disorder: 0
DIAGNOSIS_EATING_DISORDER: 0
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=975828d9-69eb-4e4f-9d85-274ae2afaadc">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[205]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>&lt;class 'pandas.core.frame.DataFrame'&gt;
Index: 3641 entries, 0 to 6124
Columns: 204 entries, DIAGNOSIS_ANXIETY_OCD to ethnicity_other
dtypes: float64(10), int64(194)
memory usage: 5.7 MB
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=3dff8ed0-c7ad-4031-8c73-56704d132a8b">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[206]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Save the fully prepared data</span>
<span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">"final_prepared_data.csv"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">" Step 2 Complete: Final prepared dataset saved as 'final_prepared_data.csv'."</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre> Step 2 Complete: Final prepared dataset saved as 'final_prepared_data.csv'.
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=9213b96c-1f3e-4537-9881-1cf57f1cae8c">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[207]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.experimental</span> <span class="kn">import</span> <span class="n">enable_iterative_imputer</span>  <span class="c1"># noqa</span>
<span class="kn">from</span> <span class="nn">sklearn.impute</span> <span class="kn">import</span> <span class="n">IterativeImputer</span>

<span class="c1"># ========== CONFIG ==========</span>
<span class="n">save_folder</span> <span class="o">=</span> <span class="s2">"imputed_data"</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">n_imputations</span> <span class="o">=</span> <span class="mi">5</span>

<span class="c1"># ========== LOAD ==========</span>
<span class="c1"># Ensure df is already defined</span>
<span class="k">assert</span> <span class="s1">'df'</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">(),</span> <span class="s2">"Please load the original DataFrame as `df` before running this script."</span>

<span class="c1"># ========== IDENTIFY NUMERIC COLUMNS ==========</span>
<span class="n">numeric_cols</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">'float64'</span><span class="p">,</span> <span class="s1">'int64'</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="c1"># ========== STEP 1: MICE IMPUTATION ==========</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"="</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"STEP 1: MICE IMPUTATION"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"="</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>

<span class="n">imputed_dfs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_imputations</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">=== Running MICE Imputation: Dataset </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> ==="</span><span class="p">)</span>
    <span class="c1">#  NEW instance with different seed AND sample_posterior=True for randomness</span>
    <span class="n">mice_imputer</span> <span class="o">=</span> <span class="n">IterativeImputer</span><span class="p">(</span>
        <span class="n">max_iter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="o">+</span><span class="n">i</span><span class="p">,</span>  <span class="c1"># Different base to avoid low numbers</span>
        <span class="n">sample_posterior</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1">#  KEY: This adds randomness!</span>
        <span class="n">n_nearest_features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">initial_strategy</span><span class="o">=</span><span class="s1">'mean'</span>
    <span class="p">)</span>
    <span class="c1"># Fit-transform on numeric columns</span>
    <span class="n">imputed_array</span> <span class="o">=</span> <span class="n">mice_imputer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">numeric_cols</span><span class="p">])</span>
    <span class="c1"># Replace numeric columns in a copy of the original df</span>
    <span class="n">df_imputed</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df_imputed</span><span class="p">[</span><span class="n">numeric_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">imputed_array</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">numeric_cols</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="c1"># Append to list</span>
    <span class="n">imputed_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_imputed</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Completed imputation </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># ========== STEP 2: ROUNDING ==========</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"="</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"STEP 2: ROUNDING NUMERIC COLUMNS"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"="</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">round_all_numeric_columns_all_imputations</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">rounded_dfs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
        <span class="n">df_copy</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">numeric_cols</span> <span class="o">=</span> <span class="n">df_copy</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span>
        <span class="n">df_copy</span><span class="p">[</span><span class="n">numeric_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_copy</span><span class="p">[</span><span class="n">numeric_cols</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">decimals</span><span class="p">)</span>
        <span class="n">rounded_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_copy</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Imputation </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: Rounded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">numeric_cols</span><span class="p">)</span><span class="si">}</span><span class="s2"> numeric columns to </span><span class="si">{</span><span class="n">decimals</span><span class="si">}</span><span class="s2"> decimal place(s)."</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rounded_dfs</span>

<span class="c1"># Apply rounding to all imputed datasets</span>
<span class="n">imputed_dfs</span> <span class="o">=</span> <span class="n">round_all_numeric_columns_all_imputations</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">)</span>

<span class="c1"># ========== STEP 3: SAVE FINAL DATASETS ==========</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"="</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"STEP 3: SAVING FINAL DATASETS"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"="</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df_imputed</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
    <span class="c1"># Save outputs</span>
    <span class="n">pkl_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">save_folder</span><span class="si">}</span><span class="s2">/df_imputed_final_imp</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.pkl"</span>
    <span class="n">csv_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">save_folder</span><span class="si">}</span><span class="s2">/df_imputed_final_imp</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.csv"</span>
    <span class="n">excel_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">save_folder</span><span class="si">}</span><span class="s2">/df_imputed_final_imp</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.xlsx"</span>
    
    <span class="n">df_imputed</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="n">pkl_path</span><span class="p">)</span>
    <span class="n">df_imputed</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">df_imputed</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">excel_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Saved files for imputation </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">:"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"    </span><span class="si">{</span><span class="n">pkl_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"    </span><span class="si">{</span><span class="n">csv_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"    </span><span class="si">{</span><span class="n">excel_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># ========== STEP 4: VERIFY DATASETS ARE DIFFERENT ==========</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"="</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"STEP 4: VERIFYING DATASET DIFFERENCES"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"="</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">check_imputation_differences</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Check if imputed datasets are actually different from each other"""</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"  Only one dataset - cannot check differences"</span><span class="p">)</span>
        <span class="k">return</span>
    
    <span class="c1"># Get numeric columns that had missing values originally</span>
    <span class="n">numeric_cols</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span>
    <span class="n">missing_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">numeric_cols</span> <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()]</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">missing_cols</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"  No missing values found in original data"</span><span class="p">)</span>
        <span class="k">return</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Checking differences in </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">missing_cols</span><span class="p">)</span><span class="si">}</span><span class="s2"> columns that had missing values..."</span><span class="p">)</span>
    
    <span class="n">differences_found</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">missing_cols</span><span class="p">[:</span><span class="mi">3</span><span class="p">]:</span>  <span class="c1"># Check first 3 columns with missing values</span>
        <span class="c1"># Compare first two datasets for this column</span>
        <span class="n">values_1</span> <span class="o">=</span> <span class="n">imputed_dfs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">values_2</span> <span class="o">=</span> <span class="n">imputed_dfs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">values_1</span><span class="p">,</span> <span class="n">values_2</span><span class="p">):</span>
            <span class="n">differences_found</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># Count how many values are different</span>
            <span class="n">diff_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">values_1</span> <span class="o">!=</span> <span class="n">values_2</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Column '</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">': </span><span class="si">{</span><span class="n">diff_count</span><span class="si">}</span><span class="s2"> different values between datasets 1 &amp; 2"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Column '</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">': IDENTICAL values between datasets 1 &amp; 2"</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">differences_found</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> SUCCESS: Datasets show proper variability!"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">  WARNING: Datasets appear identical - check random_state implementation"</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">differences_found</span>

<span class="c1"># Run the check</span>
<span class="n">check_imputation_differences</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"="</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">" MICE IMPUTATION COMPLETE!"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"="</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Created </span><span class="si">{</span><span class="n">n_imputations</span><span class="si">}</span><span class="s2"> imputed datasets"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Applied rounding to all numeric columns"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Saved files in: </span><span class="si">{</span><span class="n">save_folder</span><span class="si">}</span><span class="s2">/"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"="</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>==================================================
STEP 1: MICE IMPUTATION
==================================================

=== Running MICE Imputation: Dataset 1 ===
 Completed imputation 1

=== Running MICE Imputation: Dataset 2 ===
 Completed imputation 2

=== Running MICE Imputation: Dataset 3 ===
 Completed imputation 3

=== Running MICE Imputation: Dataset 4 ===
 Completed imputation 4

=== Running MICE Imputation: Dataset 5 ===
 Completed imputation 5

==================================================
STEP 2: ROUNDING NUMERIC COLUMNS
==================================================
 Imputation 1: Rounded 204 numeric columns to 0 decimal place(s).
 Imputation 2: Rounded 204 numeric columns to 0 decimal place(s).
 Imputation 3: Rounded 204 numeric columns to 0 decimal place(s).
 Imputation 4: Rounded 204 numeric columns to 0 decimal place(s).
 Imputation 5: Rounded 204 numeric columns to 0 decimal place(s).

==================================================
STEP 3: SAVING FINAL DATASETS
==================================================
 Saved files for imputation 1:
    imputed_data/df_imputed_final_imp1.pkl
    imputed_data/df_imputed_final_imp1.csv
    imputed_data/df_imputed_final_imp1.xlsx
 Saved files for imputation 2:
    imputed_data/df_imputed_final_imp2.pkl
    imputed_data/df_imputed_final_imp2.csv
    imputed_data/df_imputed_final_imp2.xlsx
 Saved files for imputation 3:
    imputed_data/df_imputed_final_imp3.pkl
    imputed_data/df_imputed_final_imp3.csv
    imputed_data/df_imputed_final_imp3.xlsx
 Saved files for imputation 4:
    imputed_data/df_imputed_final_imp4.pkl
    imputed_data/df_imputed_final_imp4.csv
    imputed_data/df_imputed_final_imp4.xlsx
 Saved files for imputation 5:
    imputed_data/df_imputed_final_imp5.pkl
    imputed_data/df_imputed_final_imp5.csv
    imputed_data/df_imputed_final_imp5.xlsx

==================================================
STEP 4: VERIFYING DATASET DIFFERENCES
==================================================
 Checking differences in 4 columns that had missing values...
 Column 'DIAGNOSIS_SMOKING': 34 different values between datasets 1 &amp; 2
 Column 'DIAGNOSIS_SEXUAL_TRAUMA': 11 different values between datasets 1 &amp; 2
 Column 'DIAGNOSIS_CPTSD': 21 different values between datasets 1 &amp; 2

 SUCCESS: Datasets show proper variability!

==================================================
 MICE IMPUTATION COMPLETE!
==================================================
 Created 5 imputed datasets
 Applied rounding to all numeric columns
 Saved files in: imputed_data/
==================================================
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=c137e3fd-a734-4ec2-ba57-fb0c19225709">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[208]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># ========== METHOD 1: QUICK CHECK - Compare first 2 datasets ==========</span>
<span class="k">def</span> <span class="nf">quick_difference_check</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Quick check to see if first two datasets are different"""</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Need at least 2 datasets to compare"</span><span class="p">)</span>
        <span class="k">return</span>
    
    <span class="n">df1</span> <span class="o">=</span> <span class="n">imputed_dfs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">df2</span> <span class="o">=</span> <span class="n">imputed_dfs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="c1"># Check if dataframes are identical</span>
    <span class="n">are_identical</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">df2</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Dataset 1 vs Dataset 2: </span><span class="si">{</span><span class="s1">'IDENTICAL '</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">are_identical</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">'DIFFERENT '</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">are_identical</span><span class="p">:</span>
        <span class="c1"># Count different values</span>
        <span class="n">numeric_cols</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span>
        <span class="n">total_diff</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">numeric_cols</span><span class="p">:</span>
            <span class="n">diff_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">!=</span> <span class="n">df2</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">diff_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">total_diff</span> <span class="o">+=</span> <span class="n">diff_count</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  '</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">': </span><span class="si">{</span><span class="n">diff_count</span><span class="si">}</span><span class="s2"> different values"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Total different values: </span><span class="si">{</span><span class="n">total_diff</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># ========== METHOD 2: DETAILED CHECK - All pairwise comparisons ==========</span>
<span class="k">def</span> <span class="nf">detailed_difference_check</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Check differences between all pairs of datasets"""</span>
    <span class="n">n_datasets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">=== Checking all </span><span class="si">{</span><span class="n">n_datasets</span><span class="si">}</span><span class="s2"> datasets ==="</span><span class="p">)</span>
    
    <span class="n">numeric_cols</span> <span class="o">=</span> <span class="n">imputed_dfs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_datasets</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_datasets</span><span class="p">):</span>
            <span class="n">are_identical</span> <span class="o">=</span> <span class="n">imputed_dfs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Dataset </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> vs Dataset </span><span class="si">{</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="s1">'IDENTICAL '</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">are_identical</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">'DIFFERENT '</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># ========== METHOD 3: FOCUS ON ORIGINALLY MISSING VALUES ==========</span>
<span class="k">def</span> <span class="nf">check_missing_value_differences</span><span class="p">(</span><span class="n">original_df</span><span class="p">,</span> <span class="n">imputed_dfs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Check differences only in originally missing positions"""</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">=== Checking differences in originally missing positions ==="</span><span class="p">)</span>
    
    <span class="n">numeric_cols</span> <span class="o">=</span> <span class="n">original_df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span>
    
    <span class="n">differences_found</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">numeric_cols</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">original_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">missing_mask</span> <span class="o">=</span> <span class="n">original_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Column '</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">' (</span><span class="si">{</span><span class="n">missing_mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2"> missing values):"</span><span class="p">)</span>
            
            <span class="c1"># Compare imputed values at missing positions</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">imp1_values</span> <span class="o">=</span> <span class="n">imputed_dfs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">missing_mask</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span>
                <span class="n">imp2_values</span> <span class="o">=</span> <span class="n">imputed_dfs</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">missing_mask</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span>
                
                <span class="n">are_same</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">imp1_values</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">imp2_values</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">are_same</span><span class="p">:</span>
                    <span class="n">differences_found</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">diff_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">imp1_values</span><span class="o">.</span><span class="n">values</span> <span class="o">!=</span> <span class="n">imp2_values</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Dataset </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">diff_count</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">imp1_values</span><span class="p">)</span><span class="si">}</span><span class="s2"> different imputed values "</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Dataset </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="si">}</span><span class="s2">: IDENTICAL imputed values "</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">differences_found</span>

<span class="c1"># ========== METHOD 4: SAMPLE VALUES FROM EACH DATASET ==========</span>
<span class="k">def</span> <span class="nf">show_sample_imputed_values</span><span class="p">(</span><span class="n">original_df</span><span class="p">,</span> <span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Show sample imputed values from each dataset"""</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">=== Sample imputed values (first </span><span class="si">{</span><span class="n">n_samples</span><span class="si">}</span><span class="s2"> missing positions) ==="</span><span class="p">)</span>
    
    <span class="n">numeric_cols</span> <span class="o">=</span> <span class="n">original_df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span>
    
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">numeric_cols</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">original_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">missing_positions</span> <span class="o">=</span> <span class="n">original_df</span><span class="p">[</span><span class="n">original_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="n">n_samples</span><span class="p">]</span>
            
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Column '</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">' at positions </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">missing_positions</span><span class="p">)</span><span class="si">}</span><span class="s2">:"</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df_imp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
                <span class="n">values</span> <span class="o">=</span> <span class="n">df_imp</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">missing_positions</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Dataset </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">values</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># ========== RUN ALL CHECKS ==========</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"="</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"CHECKING IMPUTATION DIFFERENCES"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"="</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>

<span class="c1"># Method 1: Quick check</span>
<span class="n">quick_difference_check</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">)</span>

<span class="c1"># Method 2: All pairwise comparisons  </span>
<span class="n">detailed_difference_check</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">)</span>

<span class="c1"># Method 3: Focus on originally missing values (assumes 'df' is your original dataframe)</span>
<span class="k">if</span> <span class="s1">'df'</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
    <span class="n">differences_found</span> <span class="o">=</span> <span class="n">check_missing_value_differences</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">imputed_dfs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">differences_found</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> SUCCESS: Found differences in imputed values!"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> WARNING: No differences found in imputed values!"</span><span class="p">)</span>

<span class="c1"># Method 4: Show sample values</span>
<span class="k">if</span> <span class="s1">'df'</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
    <span class="n">show_sample_imputed_values</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>============================================================
CHECKING IMPUTATION DIFFERENCES
============================================================
Dataset 1 vs Dataset 2: DIFFERENT 
  'DIAGNOSIS_SMOKING': 34 different values
  'DIAGNOSIS_SEXUAL_TRAUMA': 11 different values
  'DIAGNOSIS_CPTSD': 21 different values
  'treatmentdurationdays': 1127 different values
  Total different values: 1193

=== Checking all 5 datasets ===
Dataset 1 vs Dataset 2: DIFFERENT 
Dataset 1 vs Dataset 3: DIFFERENT 
Dataset 1 vs Dataset 4: DIFFERENT 
Dataset 1 vs Dataset 5: DIFFERENT 
Dataset 2 vs Dataset 3: DIFFERENT 
Dataset 2 vs Dataset 4: DIFFERENT 
Dataset 2 vs Dataset 5: DIFFERENT 
Dataset 3 vs Dataset 4: DIFFERENT 
Dataset 3 vs Dataset 5: DIFFERENT 
Dataset 4 vs Dataset 5: DIFFERENT 

=== Checking differences in originally missing positions ===

Column 'DIAGNOSIS_SMOKING' (64 missing values):
  Dataset 1 vs 2: 34/64 different imputed values 
  Dataset 2 vs 3: 35/64 different imputed values 
  Dataset 3 vs 4: 33/64 different imputed values 
  Dataset 4 vs 5: 35/64 different imputed values 

Column 'DIAGNOSIS_SEXUAL_TRAUMA' (29 missing values):
  Dataset 1 vs 2: 11/29 different imputed values 
  Dataset 2 vs 3: 14/29 different imputed values 
  Dataset 3 vs 4: 16/29 different imputed values 
  Dataset 4 vs 5: 17/29 different imputed values 

Column 'DIAGNOSIS_CPTSD' (51 missing values):
  Dataset 1 vs 2: 21/51 different imputed values 
  Dataset 2 vs 3: 24/51 different imputed values 
  Dataset 3 vs 4: 29/51 different imputed values 
  Dataset 4 vs 5: 22/51 different imputed values 

Column 'treatmentdurationdays' (1412 missing values):
  Dataset 1 vs 2: 1127/1412 different imputed values 
  Dataset 2 vs 3: 1151/1412 different imputed values 
  Dataset 3 vs 4: 1175/1412 different imputed values 
  Dataset 4 vs 5: 1146/1412 different imputed values 

 SUCCESS: Found differences in imputed values!

=== Sample imputed values (first 3 missing positions) ===

Column 'DIAGNOSIS_SMOKING' at positions [5, 8, 65]:
  Dataset 1: [-1.  0.  1.]
  Dataset 2: [ 0. -1.  1.]
  Dataset 3: [ 0. -0.  1.]
  Dataset 4: [ 1. -1.  1.]
  Dataset 5: [0. 0. 0.]

Column 'DIAGNOSIS_SEXUAL_TRAUMA' at positions [34, 35, 36]:
  Dataset 1: [1. 1. 1.]
  Dataset 2: [1. 1. 1.]
  Dataset 3: [1. 2. 0.]
  Dataset 4: [ 0.  1. -0.]
  Dataset 5: [0. 1. 1.]

Column 'DIAGNOSIS_CPTSD' at positions [8, 65, 248]:
  Dataset 1: [0. 1. 1.]
  Dataset 2: [1. 1. 1.]
  Dataset 3: [1. 1. 1.]
  Dataset 4: [0. 1. 1.]
  Dataset 5: [0. 1. 1.]

Column 'treatmentdurationdays' at positions [0, 1, 6]:
  Dataset 1: [3. 5. 2.]
  Dataset 2: [3. 4. 5.]
  Dataset 3: [3. 3. 3.]
  Dataset 4: [3. 4. 4.]
  Dataset 5: [5. 4. 1.]
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=24870e2f-65b4-4d77-b866-6c0ccdc2e409">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[209]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">imputed_folder</span> <span class="o">=</span> <span class="s2">"imputed_data"</span>
<span class="n">n_imputations</span> <span class="o">=</span> <span class="mi">5</span>

<span class="c1"># Lists to hold DataFrames and Y vectors</span>
<span class="n">imputed_dfs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">Y_list</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_imputations</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">imputed_folder</span><span class="si">}</span><span class="s2">/df_imputed_final_imp</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.pkl"</span>
    
    <span class="c1"># Load imputed DataFrame</span>
    <span class="n">df_imp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
    <span class="n">imputed_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_imp</span><span class="p">)</span>

    <span class="c1"># Define Y for this imputation</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="s2">"caps5_change_baseline"</span><span class="p">]</span>
    <span class="n">Y_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Y for imputation </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> defined. Sample values:"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Y for imputation 1 defined. Sample values:
0   -41.0
1   -15.0
2   -46.0
3   -41.0
4   -20.0
Name: caps5_change_baseline, dtype: float64
Y for imputation 2 defined. Sample values:
0   -41.0
1   -15.0
2   -46.0
3   -41.0
4   -20.0
Name: caps5_change_baseline, dtype: float64
Y for imputation 3 defined. Sample values:
0   -41.0
1   -15.0
2   -46.0
3   -41.0
4   -20.0
Name: caps5_change_baseline, dtype: float64
Y for imputation 4 defined. Sample values:
0   -41.0
1   -15.0
2   -46.0
3   -41.0
4   -20.0
Name: caps5_change_baseline, dtype: float64
Y for imputation 5 defined. Sample values:
0   -41.0
1   -15.0
2   -46.0
3   -41.0
4   -20.0
Name: caps5_change_baseline, dtype: float64
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=34bb8f95-ea33-4ba5-89eb-708abf2aa238">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[210]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># Load imputed DataFrames from saved files</span>
<span class="n">imputed_folder</span> <span class="o">=</span> <span class="s2">"imputed_data"</span>
<span class="n">n_imputations</span> <span class="o">=</span> <span class="mi">5</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_imputations</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">=== Imputed Dataset </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> ==="</span><span class="p">)</span>

    <span class="c1"># Load each imputed dataset</span>
    <span class="n">df_imp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">imputed_folder</span><span class="si">}</span><span class="s2">/df_imputed_final_imp</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.pkl"</span><span class="p">)</span>

    <span class="c1"># Get all CAT_* columns</span>
    <span class="n">cat_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df_imp</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'CAT_'</span><span class="p">)]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">"Medication Groups:"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">cat_columns</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Total Medication Groups Found:"</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cat_columns</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
=== Imputed Dataset 1 ===
Medication Groups:
['CAT_Antidepressiva', 'CAT_Benzodiazepine', 'CAT_Anti_epileptica', 'CAT_Antihistaminica', 'CAT_Opioden', 'CAT_Antipsychotica', 'CAT_Aceetanilidederivaten', 'CAT_Antihypertensiva', 'CAT_Salicylaat', 'CAT_NSAIDs', 'CAT_Migrainemiddelen', 'CAT_ADHD', 'CAT_Anticonceptiva', 'CAT_Z_drugs', 'CAT_Spierrelaxantia', 'CAT_Immunomodulerende_middelen', 'CAT_Alcoholverslaving', 'CAT_Stemmingsstabilisatoren', 'CAT_Parkinson', 'CAT_ALL', 'CAT_ALL_PSYCHOTROPICS', 'CAT_ALL_PSYCHOTROPICS_EXCL_BENZO', 'CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS']
Total Medication Groups Found: 23

=== Imputed Dataset 2 ===
Medication Groups:
['CAT_Antidepressiva', 'CAT_Benzodiazepine', 'CAT_Anti_epileptica', 'CAT_Antihistaminica', 'CAT_Opioden', 'CAT_Antipsychotica', 'CAT_Aceetanilidederivaten', 'CAT_Antihypertensiva', 'CAT_Salicylaat', 'CAT_NSAIDs', 'CAT_Migrainemiddelen', 'CAT_ADHD', 'CAT_Anticonceptiva', 'CAT_Z_drugs', 'CAT_Spierrelaxantia', 'CAT_Immunomodulerende_middelen', 'CAT_Alcoholverslaving', 'CAT_Stemmingsstabilisatoren', 'CAT_Parkinson', 'CAT_ALL', 'CAT_ALL_PSYCHOTROPICS', 'CAT_ALL_PSYCHOTROPICS_EXCL_BENZO', 'CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS']
Total Medication Groups Found: 23

=== Imputed Dataset 3 ===
Medication Groups:
['CAT_Antidepressiva', 'CAT_Benzodiazepine', 'CAT_Anti_epileptica', 'CAT_Antihistaminica', 'CAT_Opioden', 'CAT_Antipsychotica', 'CAT_Aceetanilidederivaten', 'CAT_Antihypertensiva', 'CAT_Salicylaat', 'CAT_NSAIDs', 'CAT_Migrainemiddelen', 'CAT_ADHD', 'CAT_Anticonceptiva', 'CAT_Z_drugs', 'CAT_Spierrelaxantia', 'CAT_Immunomodulerende_middelen', 'CAT_Alcoholverslaving', 'CAT_Stemmingsstabilisatoren', 'CAT_Parkinson', 'CAT_ALL', 'CAT_ALL_PSYCHOTROPICS', 'CAT_ALL_PSYCHOTROPICS_EXCL_BENZO', 'CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS']
Total Medication Groups Found: 23

=== Imputed Dataset 4 ===
Medication Groups:
['CAT_Antidepressiva', 'CAT_Benzodiazepine', 'CAT_Anti_epileptica', 'CAT_Antihistaminica', 'CAT_Opioden', 'CAT_Antipsychotica', 'CAT_Aceetanilidederivaten', 'CAT_Antihypertensiva', 'CAT_Salicylaat', 'CAT_NSAIDs', 'CAT_Migrainemiddelen', 'CAT_ADHD', 'CAT_Anticonceptiva', 'CAT_Z_drugs', 'CAT_Spierrelaxantia', 'CAT_Immunomodulerende_middelen', 'CAT_Alcoholverslaving', 'CAT_Stemmingsstabilisatoren', 'CAT_Parkinson', 'CAT_ALL', 'CAT_ALL_PSYCHOTROPICS', 'CAT_ALL_PSYCHOTROPICS_EXCL_BENZO', 'CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS']
Total Medication Groups Found: 23

=== Imputed Dataset 5 ===
Medication Groups:
['CAT_Antidepressiva', 'CAT_Benzodiazepine', 'CAT_Anti_epileptica', 'CAT_Antihistaminica', 'CAT_Opioden', 'CAT_Antipsychotica', 'CAT_Aceetanilidederivaten', 'CAT_Antihypertensiva', 'CAT_Salicylaat', 'CAT_NSAIDs', 'CAT_Migrainemiddelen', 'CAT_ADHD', 'CAT_Anticonceptiva', 'CAT_Z_drugs', 'CAT_Spierrelaxantia', 'CAT_Immunomodulerende_middelen', 'CAT_Alcoholverslaving', 'CAT_Stemmingsstabilisatoren', 'CAT_Parkinson', 'CAT_ALL', 'CAT_ALL_PSYCHOTROPICS', 'CAT_ALL_PSYCHOTROPICS_EXCL_BENZO', 'CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS']
Total Medication Groups Found: 23
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=1dfbe506-f470-4787-9bda-417a090be3c4">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[211]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">covariates_CAT_ADHD</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'CAT_Anti_epileptica'</span><span class="p">,</span> <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span> <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span> <span class="s1">'CAT_Opioden'</span><span class="p">,</span>
    <span class="s1">'CAT_Z_drugs'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SMOKING'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span>
    <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"EB_NON_TF_THERAPY"</span><span class="p">,</span> <span class="s2">"OTHER_TREATM_APPROACH"</span><span class="p">,</span> <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_CAT_Aceetanilidederivaten</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'CAT_Anti_epileptica'</span><span class="p">,</span> <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span> <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span> <span class="s1">'CAT_Opioden'</span><span class="p">,</span> <span class="s1">'CAT_Z_drugs'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SMOKING'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"EB_NON_TF_THERAPY"</span><span class="p">,</span> <span class="s2">"OTHER_TREATM_APPROACH"</span><span class="p">,</span> <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_CAT_Z_drugs</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'CAT_Anti_epileptica'</span><span class="p">,</span> <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span> <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span> <span class="s1">'CAT_Opioden'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SMOKING'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"EB_NON_TF_THERAPY"</span><span class="p">,</span> <span class="s2">"OTHER_TREATM_APPROACH"</span><span class="p">,</span> <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_CAT_Opioden</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'CAT_Anti_epileptica'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span> <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span> <span class="s1">'CAT_Z_drugs'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SMOKING'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"EB_NON_TF_THERAPY"</span><span class="p">,</span> <span class="s2">"OTHER_TREATM_APPROACH"</span><span class="p">,</span> <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_CAT_NSAIDs</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'CAT_Anti_epileptica'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span> <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span> <span class="s1">'CAT_Opioden'</span><span class="p">,</span> <span class="s1">'CAT_Z_drugs'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SMOKING'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"EB_NON_TF_THERAPY"</span><span class="p">,</span> <span class="s2">"OTHER_TREATM_APPROACH"</span><span class="p">,</span> <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>



<span class="n">covariates_CAT_Benzodiazepine</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'CAT_Anti_epileptica'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span> <span class="s1">'CAT_Opioden'</span><span class="p">,</span> <span class="s1">'CAT_Z_drugs'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SMOKING'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"EB_NON_TF_THERAPY"</span><span class="p">,</span> <span class="s2">"OTHER_TREATM_APPROACH"</span><span class="p">,</span> <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_CAT_Antihypertensiva</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'CAT_Anti_epileptica'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span> <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span> <span class="s1">'CAT_Opioden'</span><span class="p">,</span> <span class="s1">'CAT_Z_drugs'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SMOKING'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"EB_NON_TF_THERAPY"</span><span class="p">,</span> <span class="s2">"OTHER_TREATM_APPROACH"</span><span class="p">,</span> <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_CAT_Antihistaminica</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'CAT_Anti_epileptica'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span> <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span> <span class="s1">'CAT_Opioden'</span><span class="p">,</span> <span class="s1">'CAT_Z_drugs'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SMOKING'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"EB_NON_TF_THERAPY"</span><span class="p">,</span> <span class="s2">"OTHER_TREATM_APPROACH"</span><span class="p">,</span> <span class="s2">"Bipolar_and_Mood_disorder"</span>
<span class="p">]</span>


<span class="n">covariates_CAT_Anti_epileptica</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span> <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span> <span class="s1">'CAT_Opioden'</span><span class="p">,</span> <span class="s1">'CAT_Z_drugs'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SMOKING'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"EB_NON_TF_THERAPY"</span><span class="p">,</span> <span class="s2">"OTHER_TREATM_APPROACH"</span><span class="p">,</span> <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_CAT_Antidepressiva</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'CAT_Anti_epileptica'</span><span class="p">,</span> <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span> <span class="s1">'CAT_Opioden'</span><span class="p">,</span> <span class="s1">'CAT_Z_drugs'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SMOKING'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"EB_NON_TF_THERAPY"</span><span class="p">,</span> <span class="s2">"OTHER_TREATM_APPROACH"</span><span class="p">,</span> <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_CAT_Antipsychotica</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'CAT_Anti_epileptica'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span> <span class="s1">'CAT_Opioden'</span><span class="p">,</span> <span class="s1">'CAT_Z_drugs'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SMOKING'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"EB_NON_TF_THERAPY"</span><span class="p">,</span> <span class="s2">"OTHER_TREATM_APPROACH"</span><span class="p">,</span> <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_CAT_ALL_PSYCHOTROPICS_EXCL_BENZO</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span> <span class="s1">'CAT_Anticonceptiva'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SMOKING'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"EB_NON_TF_THERAPY"</span><span class="p">,</span> <span class="s2">"OTHER_TREATM_APPROACH"</span><span class="p">,</span> <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span> <span class="s1">'CAT_Z_drugs'</span><span class="p">,</span> <span class="s1">'CAT_Anticonceptiva'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SMOKING'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"EB_NON_TF_THERAPY"</span><span class="p">,</span> <span class="s2">"OTHER_TREATM_APPROACH"</span><span class="p">,</span> <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_CAT_ALL_PSYCHOTROPICS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SMOKING'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"EB_NON_TF_THERAPY"</span><span class="p">,</span> <span class="s2">"OTHER_TREATM_APPROACH"</span><span class="p">,</span> <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_CAT_ALL</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SMOKING'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span>
    <span class="s1">'age'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"EB_NON_TF_THERAPY"</span><span class="p">,</span> <span class="s2">"OTHER_TREATM_APPROACH"</span><span class="p">,</span> <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=85b6d585-f09c-4502-b467-7a8c20a8fe8a">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[212]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="c1"># This finds all variables that start with covariates_CAT_ or covariates_cat_</span>
<span class="n">final_covariates_map</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<span class="n">final_covariates_map</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
    <span class="n">var</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"covariates_"</span><span class="p">,</span> <span class="s2">""</span><span class="p">):</span> <span class="n">val</span>
    <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"covariates_cat_"</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
<span class="p">})</span>

<span class="c1"># Show detected group names</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Groups found:"</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
<span class="n">medication_groups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">medication_groups</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Groups found: ['CAT_ADHD', 'CAT_Aceetanilidederivaten', 'CAT_Z_drugs', 'CAT_Opioden', 'CAT_NSAIDs', 'CAT_Benzodiazepine', 'CAT_Antihypertensiva', 'CAT_Antihistaminica', 'CAT_Anti_epileptica', 'CAT_Antidepressiva', 'CAT_Antipsychotica', 'CAT_ALL_PSYCHOTROPICS_EXCL_BENZO', 'CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS', 'CAT_ALL_PSYCHOTROPICS', 'CAT_ALL']
['CAT_ADHD', 'CAT_Aceetanilidederivaten', 'CAT_Z_drugs', 'CAT_Opioden', 'CAT_NSAIDs', 'CAT_Benzodiazepine', 'CAT_Antihypertensiva', 'CAT_Antihistaminica', 'CAT_Anti_epileptica', 'CAT_Antidepressiva', 'CAT_Antipsychotica', 'CAT_ALL_PSYCHOTROPICS_EXCL_BENZO', 'CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS', 'CAT_ALL_PSYCHOTROPICS', 'CAT_ALL']
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=a5d938d8-9224-4db0-b753-03d15061db06">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[213]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>


<span class="k">def</span> <span class="nf">run_all_CAT_group_models</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Runs downstream analysis for each CAT medication group using imputed datasets.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - imputed_dfs: list of 5 imputed DataFrames (from df_imputed_final_imp1.pkl ... imp5.pkl)</span>
<span class="sd">    </span>
<span class="sd">    Notes:</span>
<span class="sd">    - Covariate lists must be defined as global variables: covariates_cat_&lt;group&gt;</span>
<span class="sd">    - Outputs are saved in: outputs/CAT_&lt;GROUP&gt;/</span>
<span class="sd">    """</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">" Starting analysis for all CAT groups"</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">var_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"covariates_cat_"</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">globals</span><span class="p">()[</span><span class="n">var_name</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">group_name</span> <span class="o">=</span> <span class="n">var_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"covariates_"</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
            <span class="n">group_name</span> <span class="o">=</span> <span class="n">group_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"_"</span><span class="p">,</span> <span class="s2">" "</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">" "</span><span class="p">,</span> <span class="s2">"_"</span><span class="p">)</span>  <span class="c1"># e.g., cat_z_drugs  Cat_Z_Drugs</span>
            <span class="n">group_name</span> <span class="o">=</span> <span class="n">group_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"Cat_"</span><span class="p">,</span> <span class="s2">"CAT_"</span><span class="p">)</span>  <span class="c1"># force prefix to uppercase</span>

            <span class="n">covariates</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()[</span><span class="n">var_name</span><span class="p">]</span>
            <span class="n">output_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"outputs/</span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">"</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Processing </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">..."</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">df_imp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   Using imputation </span><span class="si">{</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

                <span class="c1"># Define X and Y</span>
                <span class="n">X</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span>
                <span class="n">Y</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="s2">"caps5_change_baseline"</span><span class="p">]</span>

                <span class="c1"># === Save X and Y as placeholder (replace with modeling later)</span>
                <span class="n">X</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/X_imp</span><span class="si">{</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.csv"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">Y</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"Y"</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/Y_imp</span><span class="si">{</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.csv"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Done: </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> All CAT group analyses complete."</span><span class="p">)</span>

<span class="c1"># ========= STEP 4: Execute ========= #</span>
<span class="n">run_all_CAT_group_models</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre> Starting analysis for all CAT groups

 Processing CAT_Adhd...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: CAT_Adhd

 Processing CAT_Aceetanilidederivaten...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: CAT_Aceetanilidederivaten

 Processing CAT_Z_Drugs...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: CAT_Z_Drugs

 Processing CAT_Opioden...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: CAT_Opioden

 Processing CAT_Nsaids...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: CAT_Nsaids

 Processing CAT_Benzodiazepine...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: CAT_Benzodiazepine

 Processing CAT_Antihypertensiva...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: CAT_Antihypertensiva

 Processing CAT_Antihistaminica...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: CAT_Antihistaminica

 Processing CAT_Anti_Epileptica...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: CAT_Anti_Epileptica

 Processing CAT_Antidepressiva...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: CAT_Antidepressiva

 Processing CAT_Antipsychotica...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: CAT_Antipsychotica

 Processing CAT_All_Psychotropics_Excl_Benzo...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: CAT_All_Psychotropics_Excl_Benzo

 Processing CAT_All_Psychotropics_Excl_Sedatives_Hypnotics...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: CAT_All_Psychotropics_Excl_Sedatives_Hypnotics

 Processing CAT_All_Psychotropics...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: CAT_All_Psychotropics

 Processing CAT_All...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: CAT_All

 All CAT group analyses complete.
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=6241fae9-50ab-4dfa-a004-474392a4f6ec">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[214]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">treatment_var</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">treatment_var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Imp </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">:  Not found in columns."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">treated</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">control</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Imp </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: Treated = </span><span class="si">{</span><span class="n">treated</span><span class="si">}</span><span class="s2">, Control = </span><span class="si">{</span><span class="n">control</span><span class="si">}</span><span class="s2">, Missing = </span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 CAT_ADHD
  Imp 1: Treated = 56, Control = 3585, Missing = 0
  Imp 2: Treated = 56, Control = 3585, Missing = 0
  Imp 3: Treated = 56, Control = 3585, Missing = 0
  Imp 4: Treated = 56, Control = 3585, Missing = 0
  Imp 5: Treated = 56, Control = 3585, Missing = 0

 CAT_Aceetanilidederivaten
  Imp 1: Treated = 50, Control = 3591, Missing = 0
  Imp 2: Treated = 50, Control = 3591, Missing = 0
  Imp 3: Treated = 50, Control = 3591, Missing = 0
  Imp 4: Treated = 50, Control = 3591, Missing = 0
  Imp 5: Treated = 50, Control = 3591, Missing = 0

 CAT_Z_drugs
  Imp 1: Treated = 57, Control = 3584, Missing = 0
  Imp 2: Treated = 57, Control = 3584, Missing = 0
  Imp 3: Treated = 57, Control = 3584, Missing = 0
  Imp 4: Treated = 57, Control = 3584, Missing = 0
  Imp 5: Treated = 57, Control = 3584, Missing = 0

 CAT_Opioden
  Imp 1: Treated = 54, Control = 3587, Missing = 0
  Imp 2: Treated = 54, Control = 3587, Missing = 0
  Imp 3: Treated = 54, Control = 3587, Missing = 0
  Imp 4: Treated = 54, Control = 3587, Missing = 0
  Imp 5: Treated = 54, Control = 3587, Missing = 0

 CAT_NSAIDs
  Imp 1: Treated = 37, Control = 3604, Missing = 0
  Imp 2: Treated = 37, Control = 3604, Missing = 0
  Imp 3: Treated = 37, Control = 3604, Missing = 0
  Imp 4: Treated = 37, Control = 3604, Missing = 0
  Imp 5: Treated = 37, Control = 3604, Missing = 0

 CAT_Benzodiazepine
  Imp 1: Treated = 396, Control = 3245, Missing = 0
  Imp 2: Treated = 396, Control = 3245, Missing = 0
  Imp 3: Treated = 396, Control = 3245, Missing = 0
  Imp 4: Treated = 396, Control = 3245, Missing = 0
  Imp 5: Treated = 396, Control = 3245, Missing = 0

 CAT_Antihypertensiva
  Imp 1: Treated = 45, Control = 3596, Missing = 0
  Imp 2: Treated = 45, Control = 3596, Missing = 0
  Imp 3: Treated = 45, Control = 3596, Missing = 0
  Imp 4: Treated = 45, Control = 3596, Missing = 0
  Imp 5: Treated = 45, Control = 3596, Missing = 0

 CAT_Antihistaminica
  Imp 1: Treated = 56, Control = 3585, Missing = 0
  Imp 2: Treated = 56, Control = 3585, Missing = 0
  Imp 3: Treated = 56, Control = 3585, Missing = 0
  Imp 4: Treated = 56, Control = 3585, Missing = 0
  Imp 5: Treated = 56, Control = 3585, Missing = 0

 CAT_Anti_epileptica
  Imp 1: Treated = 84, Control = 3557, Missing = 0
  Imp 2: Treated = 84, Control = 3557, Missing = 0
  Imp 3: Treated = 84, Control = 3557, Missing = 0
  Imp 4: Treated = 84, Control = 3557, Missing = 0
  Imp 5: Treated = 84, Control = 3557, Missing = 0

 CAT_Antidepressiva
  Imp 1: Treated = 636, Control = 3005, Missing = 0
  Imp 2: Treated = 636, Control = 3005, Missing = 0
  Imp 3: Treated = 636, Control = 3005, Missing = 0
  Imp 4: Treated = 636, Control = 3005, Missing = 0
  Imp 5: Treated = 636, Control = 3005, Missing = 0

 CAT_Antipsychotica
  Imp 1: Treated = 268, Control = 3373, Missing = 0
  Imp 2: Treated = 268, Control = 3373, Missing = 0
  Imp 3: Treated = 268, Control = 3373, Missing = 0
  Imp 4: Treated = 268, Control = 3373, Missing = 0
  Imp 5: Treated = 268, Control = 3373, Missing = 0

 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO
  Imp 1: Treated = 869, Control = 2772, Missing = 0
  Imp 2: Treated = 869, Control = 2772, Missing = 0
  Imp 3: Treated = 869, Control = 2772, Missing = 0
  Imp 4: Treated = 869, Control = 2772, Missing = 0
  Imp 5: Treated = 869, Control = 2772, Missing = 0

 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS
  Imp 1: Treated = 846, Control = 2795, Missing = 0
  Imp 2: Treated = 846, Control = 2795, Missing = 0
  Imp 3: Treated = 846, Control = 2795, Missing = 0
  Imp 4: Treated = 846, Control = 2795, Missing = 0
  Imp 5: Treated = 846, Control = 2795, Missing = 0

 CAT_ALL_PSYCHOTROPICS
  Imp 1: Treated = 1031, Control = 2610, Missing = 0
  Imp 2: Treated = 1031, Control = 2610, Missing = 0
  Imp 3: Treated = 1031, Control = 2610, Missing = 0
  Imp 4: Treated = 1031, Control = 2610, Missing = 0
  Imp 5: Treated = 1031, Control = 2610, Missing = 0

 CAT_ALL
  Imp 1: Treated = 1072, Control = 2569, Missing = 0
  Imp 2: Treated = 1072, Control = 2569, Missing = 0
  Imp 3: Treated = 1072, Control = 2569, Missing = 0
  Imp 4: Treated = 1072, Control = 2569, Missing = 0
  Imp 5: Treated = 1072, Control = 2569, Missing = 0
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=42eeaea9-4e28-4afc-9c6d-201f5af8a3be">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[215]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">from</span> <span class="nn">statsmodels.stats.outliers_influence</span> <span class="kn">import</span> <span class="n">variance_inflation_factor</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="c1">#  VIF computation function</span>
<span class="k">def</span> <span class="nf">compute_vif</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">has_constant</span><span class="o">=</span><span class="s1">'add'</span><span class="p">)</span>
    <span class="n">vif_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">vif_df</span><span class="p">[</span><span class="s2">"variable"</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span>
    <span class="n">vif_df</span><span class="p">[</span><span class="s2">"VIF"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">variance_inflation_factor</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
    <span class="k">return</span> <span class="n">vif_df</span>

<span class="c1">#  Process each group</span>
<span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Processing VIF for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  No covariates found for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
        <span class="k">continue</span>

    <span class="n">covariates</span> <span class="o">=</span> <span class="n">final_covariates_map</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
    <span class="n">vif_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df_imp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">vif_df</span> <span class="o">=</span> <span class="n">compute_vif</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="n">vif_df</span><span class="p">[</span><span class="s2">"imputation"</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">vif_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vif_df</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"    Failed on imputation </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">vif_list</span><span class="p">:</span>
        <span class="n">all_vif</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">vif_list</span><span class="p">)</span>
        <span class="n">pooled_vif</span> <span class="o">=</span> <span class="n">all_vif</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">"variable"</span><span class="p">)[</span><span class="s2">"VIF"</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">pooled_vif</span> <span class="o">=</span> <span class="n">pooled_vif</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">"VIF"</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"outputs"</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">pooled_vif</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"pooled_vif.csv"</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Saved: </span><span class="si">{</span><span class="n">output_folder</span><span class="si">}</span><span class="s2">/pooled_vif.csv"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Skipped </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: No valid imputations."</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Processing VIF for CAT_ADHD
  Saved: outputs\CAT_ADHD/pooled_vif.csv

 Processing VIF for CAT_Aceetanilidederivaten
  Saved: outputs\CAT_Aceetanilidederivaten/pooled_vif.csv

 Processing VIF for CAT_Z_drugs
  Saved: outputs\CAT_Z_drugs/pooled_vif.csv

 Processing VIF for CAT_Opioden
  Saved: outputs\CAT_Opioden/pooled_vif.csv

 Processing VIF for CAT_NSAIDs
  Saved: outputs\CAT_NSAIDs/pooled_vif.csv

 Processing VIF for CAT_Benzodiazepine
  Saved: outputs\CAT_Benzodiazepine/pooled_vif.csv

 Processing VIF for CAT_Antihypertensiva
  Saved: outputs\CAT_Antihypertensiva/pooled_vif.csv

 Processing VIF for CAT_Antihistaminica
  Saved: outputs\CAT_Antihistaminica/pooled_vif.csv

 Processing VIF for CAT_Anti_epileptica
  Saved: outputs\CAT_Anti_epileptica/pooled_vif.csv

 Processing VIF for CAT_Antidepressiva
  Saved: outputs\CAT_Antidepressiva/pooled_vif.csv

 Processing VIF for CAT_Antipsychotica
  Saved: outputs\CAT_Antipsychotica/pooled_vif.csv

 Processing VIF for CAT_ALL_PSYCHOTROPICS_EXCL_BENZO
  Saved: outputs\CAT_ALL_PSYCHOTROPICS_EXCL_BENZO/pooled_vif.csv

 Processing VIF for CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS
  Saved: outputs\CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS/pooled_vif.csv

 Processing VIF for CAT_ALL_PSYCHOTROPICS
  Saved: outputs\CAT_ALL_PSYCHOTROPICS/pooled_vif.csv

 Processing VIF for CAT_ALL
  Saved: outputs\CAT_ALL/pooled_vif.csv
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=dc6c0f67-a42e-4156-8916-137f0284544a">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[216]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">roc_curve</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>

<span class="c1"># ---------- PS Estimation Function ----------</span>
<span class="k">def</span> <span class="nf">run_logistic_ps_modeling</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Running PS estimation for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No covariates found for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"outputs"</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">covariates</span> <span class="o">=</span> <span class="n">final_covariates_map</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
        <span class="n">ps_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">auc_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df_imp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_imp</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> not found in imputed dataset </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">X</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>

            <span class="c1"># Drop missing treatment rows</span>
            <span class="n">valid_idx</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">index</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>

            <span class="c1"># Train-test split for ROC</span>
            <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">T_train</span><span class="p">,</span> <span class="n">T_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
                <span class="n">X</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
            <span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
                <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">T_train</span><span class="p">)</span>

                <span class="n">ps_scores</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">ps_matrix</span><span class="p">[</span><span class="sa">f</span><span class="s2">"ps_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">ps_scores</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">valid_idx</span><span class="p">)</span>

                <span class="c1"># ROC &amp; AUC</span>
                <span class="n">auc</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">T_test</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">auc_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">auc</span><span class="p">)</span>

                <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">T_test</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">"AUC = </span><span class="si">{</span><span class="n">auc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'k--'</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"False Positive Rate"</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"True Positive Rate"</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"ROC Curve - </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> (Imp </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">)"</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"roc_curve_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.png"</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   Imp </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: AUC = </span><span class="si">{</span><span class="n">auc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, ROC saved."</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> (imp </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Save AUCs and Composite PS</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ps_matrix</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="c1"># Fill NaN rows (from dropped subjects in some imputations) with mean</span>
            <span class="n">ps_matrix</span><span class="p">[</span><span class="s2">"composite_ps"</span><span class="p">]</span> <span class="o">=</span> <span class="n">ps_matrix</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ps_matrix</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"propensity_scores.xlsx"</span><span class="p">))</span>

            <span class="n">auc_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s2">"imputation"</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">"imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">auc_list</span><span class="p">))],</span>
                <span class="s2">"AUC"</span><span class="p">:</span> <span class="n">auc_list</span>
            <span class="p">})</span>
            <span class="n">auc_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">auc_df</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"mean"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">auc_list</span><span class="p">)</span> <span class="k">if</span> <span class="n">auc_list</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span>
            <span class="n">auc_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"auc_scores.xlsx"</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Composite PS + AUC saved for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No valid PS scores generated for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># ---------- Run ----------</span>
<span class="n">run_logistic_ps_modeling</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre> Running PS estimation for CAT_ADHD
   Imp 1: AUC = 0.643, ROC saved.
   Imp 2: AUC = 0.644, ROC saved.
   Imp 3: AUC = 0.633, ROC saved.
   Imp 4: AUC = 0.651, ROC saved.
   Imp 5: AUC = 0.639, ROC saved.
 Composite PS + AUC saved for CAT_ADHD
 Running PS estimation for CAT_Aceetanilidederivaten
   Imp 1: AUC = 0.849, ROC saved.
   Imp 2: AUC = 0.852, ROC saved.
   Imp 3: AUC = 0.846, ROC saved.
   Imp 4: AUC = 0.852, ROC saved.
   Imp 5: AUC = 0.859, ROC saved.
 Composite PS + AUC saved for CAT_Aceetanilidederivaten
 Running PS estimation for CAT_Z_drugs
   Imp 1: AUC = 0.732, ROC saved.
   Imp 2: AUC = 0.734, ROC saved.
   Imp 3: AUC = 0.732, ROC saved.
   Imp 4: AUC = 0.729, ROC saved.
   Imp 5: AUC = 0.727, ROC saved.
 Composite PS + AUC saved for CAT_Z_drugs
 Running PS estimation for CAT_Opioden
   Imp 1: AUC = 0.873, ROC saved.
   Imp 2: AUC = 0.873, ROC saved.
   Imp 3: AUC = 0.874, ROC saved.
   Imp 4: AUC = 0.873, ROC saved.
   Imp 5: AUC = 0.871, ROC saved.
 Composite PS + AUC saved for CAT_Opioden
 Running PS estimation for CAT_NSAIDs
   Imp 1: AUC = 0.827, ROC saved.
   Imp 2: AUC = 0.811, ROC saved.
   Imp 3: AUC = 0.799, ROC saved.
   Imp 4: AUC = 0.840, ROC saved.
   Imp 5: AUC = 0.837, ROC saved.
 Composite PS + AUC saved for CAT_NSAIDs
 Running PS estimation for CAT_Benzodiazepine
   Imp 1: AUC = 0.811, ROC saved.
   Imp 2: AUC = 0.811, ROC saved.
   Imp 3: AUC = 0.810, ROC saved.
   Imp 4: AUC = 0.809, ROC saved.
   Imp 5: AUC = 0.810, ROC saved.
 Composite PS + AUC saved for CAT_Benzodiazepine
 Running PS estimation for CAT_Antihypertensiva
   Imp 1: AUC = 0.777, ROC saved.
   Imp 2: AUC = 0.806, ROC saved.
   Imp 3: AUC = 0.776, ROC saved.
   Imp 4: AUC = 0.782, ROC saved.
   Imp 5: AUC = 0.783, ROC saved.
 Composite PS + AUC saved for CAT_Antihypertensiva
 Running PS estimation for CAT_Antihistaminica
   Imp 1: AUC = 0.759, ROC saved.
   Imp 2: AUC = 0.757, ROC saved.
   Imp 3: AUC = 0.751, ROC saved.
   Imp 4: AUC = 0.751, ROC saved.
   Imp 5: AUC = 0.762, ROC saved.
 Composite PS + AUC saved for CAT_Antihistaminica
 Running PS estimation for CAT_Anti_epileptica
   Imp 1: AUC = 0.818, ROC saved.
   Imp 2: AUC = 0.835, ROC saved.
   Imp 3: AUC = 0.833, ROC saved.
   Imp 4: AUC = 0.825, ROC saved.
   Imp 5: AUC = 0.826, ROC saved.
 Composite PS + AUC saved for CAT_Anti_epileptica
 Running PS estimation for CAT_Antidepressiva
   Imp 1: AUC = 0.826, ROC saved.
   Imp 2: AUC = 0.825, ROC saved.
   Imp 3: AUC = 0.826, ROC saved.
   Imp 4: AUC = 0.827, ROC saved.
   Imp 5: AUC = 0.827, ROC saved.
 Composite PS + AUC saved for CAT_Antidepressiva
 Running PS estimation for CAT_Antipsychotica
   Imp 1: AUC = 0.870, ROC saved.
   Imp 2: AUC = 0.871, ROC saved.
   Imp 3: AUC = 0.869, ROC saved.
   Imp 4: AUC = 0.868, ROC saved.
   Imp 5: AUC = 0.869, ROC saved.
 Composite PS + AUC saved for CAT_Antipsychotica
 Running PS estimation for CAT_ALL_PSYCHOTROPICS_EXCL_BENZO
   Imp 1: AUC = 0.814, ROC saved.
   Imp 2: AUC = 0.816, ROC saved.
   Imp 3: AUC = 0.816, ROC saved.
   Imp 4: AUC = 0.815, ROC saved.
   Imp 5: AUC = 0.818, ROC saved.
 Composite PS + AUC saved for CAT_ALL_PSYCHOTROPICS_EXCL_BENZO
 Running PS estimation for CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS
   Imp 1: AUC = 0.825, ROC saved.
   Imp 2: AUC = 0.825, ROC saved.
   Imp 3: AUC = 0.825, ROC saved.
   Imp 4: AUC = 0.826, ROC saved.
   Imp 5: AUC = 0.827, ROC saved.
 Composite PS + AUC saved for CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS
 Running PS estimation for CAT_ALL_PSYCHOTROPICS
   Imp 1: AUC = 0.819, ROC saved.
   Imp 2: AUC = 0.819, ROC saved.
   Imp 3: AUC = 0.820, ROC saved.
   Imp 4: AUC = 0.819, ROC saved.
   Imp 5: AUC = 0.821, ROC saved.
 Composite PS + AUC saved for CAT_ALL_PSYCHOTROPICS
 Running PS estimation for CAT_ALL
   Imp 1: AUC = 0.819, ROC saved.
   Imp 2: AUC = 0.820, ROC saved.
   Imp 3: AUC = 0.819, ROC saved.
   Imp 4: AUC = 0.819, ROC saved.
   Imp 5: AUC = 0.822, ROC saved.
 Composite PS + AUC saved for CAT_ALL
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=44cdd960-01e8-4562-ae13-a8e282fcd019">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[217]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>

<span class="k">def</span> <span class="nf">compute_feature_importance</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Computing feature importance for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No covariates found for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">covariates</span> <span class="o">=</span> <span class="n">final_covariates_map</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
        <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"outputs"</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">importance_df_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df_imp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_imp</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> not in imputed dataset </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">X</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>

            <span class="c1"># Drop NaNs in treatment</span>
            <span class="n">valid_idx</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">index</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
                <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>

                <span class="c1"># Get feature importance (absolute coefficients)</span>
                <span class="n">importances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">importance_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">importances</span><span class="p">))</span>
                <span class="n">df_feat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">importance_dict</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">'index'</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">"imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">])</span>
                <span class="n">df_feat</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">'feature'</span>
                <span class="n">importance_df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_feat</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   Error during modeling: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">importance_df_list</span><span class="p">:</span>
            <span class="c1"># Combine and average</span>
            <span class="n">all_feat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">importance_df_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">all_feat</span><span class="p">[</span><span class="s2">"mean_importance"</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_feat</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Filter top 30 non-zero</span>
            <span class="n">non_zero</span> <span class="o">=</span> <span class="n">all_feat</span><span class="p">[</span><span class="n">all_feat</span><span class="p">[</span><span class="s2">"mean_importance"</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">top30</span> <span class="o">=</span> <span class="n">non_zero</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">"mean_importance"</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>

            <span class="c1"># Save to CSV</span>
            <span class="n">top30</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"feature_importance.csv"</span><span class="p">))</span>

            <span class="c1"># Plot</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top30</span><span class="o">.</span><span class="n">index</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">top30</span><span class="p">[</span><span class="s2">"mean_importance"</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># plot top  bottom</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Mean Gain Importance"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Top 30 Feature Importance - </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"feature_importance_top30.png"</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Saved feature importance plot and CSV for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No valid models for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1">#  Run</span>
<span class="n">compute_feature_importance</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Computing feature importance for CAT_ADHD
 Saved feature importance plot and CSV for CAT_ADHD

 Computing feature importance for CAT_Aceetanilidederivaten
 Saved feature importance plot and CSV for CAT_Aceetanilidederivaten

 Computing feature importance for CAT_Z_drugs
 Saved feature importance plot and CSV for CAT_Z_drugs

 Computing feature importance for CAT_Opioden
 Saved feature importance plot and CSV for CAT_Opioden

 Computing feature importance for CAT_NSAIDs
 Saved feature importance plot and CSV for CAT_NSAIDs

 Computing feature importance for CAT_Benzodiazepine
 Saved feature importance plot and CSV for CAT_Benzodiazepine

 Computing feature importance for CAT_Antihypertensiva
 Saved feature importance plot and CSV for CAT_Antihypertensiva

 Computing feature importance for CAT_Antihistaminica
 Saved feature importance plot and CSV for CAT_Antihistaminica

 Computing feature importance for CAT_Anti_epileptica
 Saved feature importance plot and CSV for CAT_Anti_epileptica

 Computing feature importance for CAT_Antidepressiva
 Saved feature importance plot and CSV for CAT_Antidepressiva

 Computing feature importance for CAT_Antipsychotica
 Saved feature importance plot and CSV for CAT_Antipsychotica

 Computing feature importance for CAT_ALL_PSYCHOTROPICS_EXCL_BENZO
 Saved feature importance plot and CSV for CAT_ALL_PSYCHOTROPICS_EXCL_BENZO

 Computing feature importance for CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS
 Saved feature importance plot and CSV for CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS

 Computing feature importance for CAT_ALL_PSYCHOTROPICS
 Saved feature importance plot and CSV for CAT_ALL_PSYCHOTROPICS

 Computing feature importance for CAT_ALL
 Saved feature importance plot and CSV for CAT_ALL
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=229b8d60-d190-472b-8594-d2b70c09a2a4">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[218]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="k">def</span> <span class="nf">compute_trimmed_clipped_iptw</span><span class="p">(</span><span class="n">ps_df</span><span class="p">,</span> <span class="n">treatment</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">clip_max</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">keep_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">ps_df</span> <span class="o">&gt;</span> <span class="n">lower</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ps_df</span> <span class="o">&lt;</span> <span class="n">upper</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ps_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">ps</span> <span class="o">=</span> <span class="n">ps_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">lower</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">1e-6</span><span class="p">)</span>  <span class="c1"># avoid div by zero</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">keep_mask</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">ps</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="n">w</span><span class="p">[</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">treatment</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">ps</span><span class="p">[</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">treatment</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="n">w</span><span class="p">[</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">treatment</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ps</span><span class="p">[</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">treatment</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)])</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">upper</span><span class="o">=</span><span class="n">clip_max</span><span class="p">)</span>
        <span class="n">weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">apply_rubins_rule_to_iptw</span><span class="p">(</span><span class="n">iptw_matrix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Given an IPTW matrix (n rows  M imputations), return Rubins rule pooled mean, SD, SE.</span>
<span class="sd">    """</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">q_bar</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">u_bar</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">total_var</span> <span class="o">=</span> <span class="n">u_bar</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">M</span><span class="p">)</span> <span class="o">*</span> <span class="n">B</span>
    <span class="n">total_se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">total_var</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">q_bar</span><span class="p">,</span> <span class="n">u_bar</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">total_se</span>


<span class="k">def</span> <span class="nf">run_trim_clip_save_all</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Processing IPTW + trimming + clipping for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"outputs"</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">ps_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"propensity_scores.xlsx"</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ps_path</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Missing PS file: </span><span class="si">{</span><span class="n">ps_path</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ps_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">ps_path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">ps_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">ps_all</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"ps_imp"</span><span class="p">)]</span>
            <span class="n">composite_index</span> <span class="o">=</span> <span class="n">ps_all</span><span class="o">.</span><span class="n">index</span>

            <span class="c1"># Get treatment from one imputed dataset</span>
            <span class="n">T_full</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">imputed_dfs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">T_full</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">composite_index</span><span class="p">,</span> <span class="n">group</span><span class="p">]</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="n">T_full</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Treatment column </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> not found in any imputed dataset."</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Compute IPTW matrix (shape: n  M)</span>
            <span class="n">iptw_matrix</span> <span class="o">=</span> <span class="n">compute_trimmed_clipped_iptw</span><span class="p">(</span><span class="n">ps_all</span><span class="p">[</span><span class="n">ps_cols</span><span class="p">],</span> <span class="n">T_full</span><span class="p">)</span>
            <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">"iptw_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iptw_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>

            <span class="c1"># Apply Rubins Rule for mean, SD, SE</span>
            <span class="n">iptw_matrix</span><span class="p">[</span><span class="s2">"iptw_mean"</span><span class="p">],</span> <span class="n">iptw_matrix</span><span class="p">[</span><span class="s2">"iptw_sd"</span><span class="p">],</span> <span class="n">iptw_matrix</span><span class="p">[</span><span class="s2">"iptw_se"</span><span class="p">]</span> <span class="o">=</span> <span class="n">apply_rubins_rule_to_iptw</span><span class="p">(</span>
                <span class="n">iptw_matrix</span><span class="p">[[</span><span class="sa">f</span><span class="s2">"iptw_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iptw_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]]</span>
            <span class="p">)</span>

            <span class="c1"># Save IPTW matrix separately</span>
            <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"iptw_weights.xlsx"</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Saved IPTW weights for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

            <span class="c1"># Save trimmed &amp; clipped imputed datasets with IPTW</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">imputed_dfs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">trimmed_idx</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="n">needed_cols</span> <span class="o">=</span> <span class="n">final_covariates_map</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">group</span><span class="p">,</span> <span class="s2">"caps5_change_baseline"</span><span class="p">]</span>

                <span class="c1"># Select only necessary columns</span>
                <span class="n">df_trimmed</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">trimmed_idx</span><span class="p">,</span> <span class="n">needed_cols</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">df_trimmed</span><span class="p">[</span><span class="s2">"iptw"</span><span class="p">]</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="p">[</span><span class="sa">f</span><span class="s2">"iptw_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">trimmed_idx</span><span class="p">]</span>

                <span class="c1">#  DROP rows with missing IPTW values</span>
                <span class="n">before</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_trimmed</span><span class="p">)</span>
                <span class="n">df_trimmed</span> <span class="o">=</span> <span class="n">df_trimmed</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">"iptw"</span><span class="p">])</span>
                <span class="n">after</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_trimmed</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"     Retained </span><span class="si">{</span><span class="n">after</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">before</span><span class="si">}</span><span class="s2"> rows after IPTW NaN drop."</span><span class="p">)</span>

                <span class="c1"># Save to .pkl</span>
                <span class="n">df_trimmed</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"trimmed_data_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.pkl"</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   Saved trimmed dataset: </span><span class="si">{</span><span class="n">output_folder</span><span class="si">}</span><span class="s2">/trimmed_data_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.*"</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>


<span class="n">run_trim_clip_save_all</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Processing IPTW + trimming + clipping for CAT_ADHD
 Saved IPTW weights for CAT_ADHD
     Retained 156/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ADHD/trimmed_data_imp1.*
     Retained 157/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ADHD/trimmed_data_imp2.*
     Retained 160/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ADHD/trimmed_data_imp3.*
     Retained 168/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ADHD/trimmed_data_imp4.*
     Retained 163/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ADHD/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for CAT_Aceetanilidederivaten
 Saved IPTW weights for CAT_Aceetanilidederivaten
     Retained 136/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Aceetanilidederivaten/trimmed_data_imp1.*
     Retained 132/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Aceetanilidederivaten/trimmed_data_imp2.*
     Retained 131/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Aceetanilidederivaten/trimmed_data_imp3.*
     Retained 134/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Aceetanilidederivaten/trimmed_data_imp4.*
     Retained 138/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Aceetanilidederivaten/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for CAT_Z_drugs
 Saved IPTW weights for CAT_Z_drugs
     Retained 250/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Z_drugs/trimmed_data_imp1.*
     Retained 248/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Z_drugs/trimmed_data_imp2.*
     Retained 250/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Z_drugs/trimmed_data_imp3.*
     Retained 257/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Z_drugs/trimmed_data_imp4.*
     Retained 255/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Z_drugs/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for CAT_Opioden
 Saved IPTW weights for CAT_Opioden
     Retained 234/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Opioden/trimmed_data_imp1.*
     Retained 235/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Opioden/trimmed_data_imp2.*
     Retained 228/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Opioden/trimmed_data_imp3.*
     Retained 226/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Opioden/trimmed_data_imp4.*
     Retained 236/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Opioden/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for CAT_NSAIDs
 Saved IPTW weights for CAT_NSAIDs
     Retained 140/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_NSAIDs/trimmed_data_imp1.*
     Retained 144/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_NSAIDs/trimmed_data_imp2.*
     Retained 134/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_NSAIDs/trimmed_data_imp3.*
     Retained 143/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_NSAIDs/trimmed_data_imp4.*
     Retained 141/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_NSAIDs/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for CAT_Benzodiazepine
 Saved IPTW weights for CAT_Benzodiazepine
     Retained 1971/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Benzodiazepine/trimmed_data_imp1.*
     Retained 1959/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Benzodiazepine/trimmed_data_imp2.*
     Retained 1962/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Benzodiazepine/trimmed_data_imp3.*
     Retained 1960/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Benzodiazepine/trimmed_data_imp4.*
     Retained 1969/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Benzodiazepine/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for CAT_Antihypertensiva
 Saved IPTW weights for CAT_Antihypertensiva
     Retained 166/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antihypertensiva/trimmed_data_imp1.*
     Retained 172/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antihypertensiva/trimmed_data_imp2.*
     Retained 168/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antihypertensiva/trimmed_data_imp3.*
     Retained 169/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antihypertensiva/trimmed_data_imp4.*
     Retained 170/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antihypertensiva/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for CAT_Antihistaminica
 Saved IPTW weights for CAT_Antihistaminica
     Retained 202/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antihistaminica/trimmed_data_imp1.*
     Retained 197/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antihistaminica/trimmed_data_imp2.*
     Retained 196/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antihistaminica/trimmed_data_imp3.*
     Retained 198/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antihistaminica/trimmed_data_imp4.*
     Retained 195/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antihistaminica/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for CAT_Anti_epileptica
 Saved IPTW weights for CAT_Anti_epileptica
     Retained 402/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Anti_epileptica/trimmed_data_imp1.*
     Retained 397/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Anti_epileptica/trimmed_data_imp2.*
     Retained 395/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Anti_epileptica/trimmed_data_imp3.*
     Retained 408/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Anti_epileptica/trimmed_data_imp4.*
     Retained 405/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Anti_epileptica/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for CAT_Antidepressiva
 Saved IPTW weights for CAT_Antidepressiva
     Retained 2836/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antidepressiva/trimmed_data_imp1.*
     Retained 2872/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antidepressiva/trimmed_data_imp2.*
     Retained 2866/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antidepressiva/trimmed_data_imp3.*
     Retained 2865/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antidepressiva/trimmed_data_imp4.*
     Retained 2825/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antidepressiva/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for CAT_Antipsychotica
 Saved IPTW weights for CAT_Antipsychotica
     Retained 1284/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antipsychotica/trimmed_data_imp1.*
     Retained 1289/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antipsychotica/trimmed_data_imp2.*
     Retained 1287/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antipsychotica/trimmed_data_imp3.*
     Retained 1284/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antipsychotica/trimmed_data_imp4.*
     Retained 1299/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_Antipsychotica/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for CAT_ALL_PSYCHOTROPICS_EXCL_BENZO
 Saved IPTW weights for CAT_ALL_PSYCHOTROPICS_EXCL_BENZO
     Retained 3433/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL_PSYCHOTROPICS_EXCL_BENZO/trimmed_data_imp1.*
     Retained 3446/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL_PSYCHOTROPICS_EXCL_BENZO/trimmed_data_imp2.*
     Retained 3440/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL_PSYCHOTROPICS_EXCL_BENZO/trimmed_data_imp3.*
     Retained 3443/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL_PSYCHOTROPICS_EXCL_BENZO/trimmed_data_imp4.*
     Retained 3435/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL_PSYCHOTROPICS_EXCL_BENZO/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS
 Saved IPTW weights for CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS
     Retained 3323/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS/trimmed_data_imp1.*
     Retained 3332/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS/trimmed_data_imp2.*
     Retained 3303/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS/trimmed_data_imp3.*
     Retained 3304/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS/trimmed_data_imp4.*
     Retained 3304/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for CAT_ALL_PSYCHOTROPICS
 Saved IPTW weights for CAT_ALL_PSYCHOTROPICS
     Retained 3596/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL_PSYCHOTROPICS/trimmed_data_imp1.*
     Retained 3597/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL_PSYCHOTROPICS/trimmed_data_imp2.*
     Retained 3590/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL_PSYCHOTROPICS/trimmed_data_imp3.*
     Retained 3586/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL_PSYCHOTROPICS/trimmed_data_imp4.*
     Retained 3588/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL_PSYCHOTROPICS/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for CAT_ALL
 Saved IPTW weights for CAT_ALL
     Retained 3568/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL/trimmed_data_imp1.*
     Retained 3569/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL/trimmed_data_imp2.*
     Retained 3564/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL/trimmed_data_imp3.*
     Retained 3571/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL/trimmed_data_imp4.*
     Retained 3563/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\CAT_ALL/trimmed_data_imp5.*
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=045e9079-9f4c-4aa3-aefe-5235be369d24">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[219]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="k">def</span> <span class="nf">plot_ps_overlap_all_groups</span><span class="p">(</span><span class="n">medication_groups</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Plotting PS overlap for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="n">folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"outputs"</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">ps_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">"propensity_scores.xlsx"</span><span class="p">)</span>
        <span class="n">iptw_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">"iptw_weights.xlsx"</span><span class="p">)</span>
        <span class="n">trimmed_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">"trimmed_data_imp1.pkl"</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ps_file</span><span class="p">,</span> <span class="n">iptw_file</span><span class="p">,</span> <span class="n">trimmed_file</span><span class="p">]):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Missing required files for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ps_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">ps_file</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">iptw_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">iptw_file</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">trimmed_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">trimmed_file</span><span class="p">)</span>

            <span class="c1"># Extract</span>
            <span class="n">ps</span> <span class="o">=</span> <span class="n">ps_df</span><span class="p">[</span><span class="s2">"composite_ps"</span><span class="p">]</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">trimmed_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">iptw_df</span><span class="p">[</span><span class="s2">"iptw_mean"</span><span class="p">]</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">trimmed_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">trimmed_df</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>

            <span class="c1"># Masks to remove NaNs</span>
            <span class="n">treated_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ps</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">w</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
            <span class="n">control_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ps</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">w</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>

            <span class="n">treated</span> <span class="o">=</span> <span class="n">ps</span><span class="p">[</span><span class="n">treated_mask</span><span class="p">]</span>
            <span class="n">treated_w</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="n">treated_mask</span><span class="p">]</span>

            <span class="n">control</span> <span class="o">=</span> <span class="n">ps</span><span class="p">[</span><span class="n">control_mask</span><span class="p">]</span>
            <span class="n">control_w</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="n">control_mask</span><span class="p">]</span>

            <span class="c1"># === Unweighted Plot ===</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">([</span><span class="n">treated</span><span class="p">,</span> <span class="n">control</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="p">[</span><span class="s2">"Treated"</span><span class="p">,</span> <span class="s2">"Control"</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Unweighted PS Overlap - </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Composite Propensity Score"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"Count"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">"ps_overlap_unweighted.png"</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="c1"># === Weighted Plot ===</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">([</span><span class="n">treated</span><span class="p">,</span> <span class="n">control</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="p">[</span><span class="n">treated_w</span><span class="p">,</span> <span class="n">control_w</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="p">[</span><span class="s2">"Treated"</span><span class="p">,</span> <span class="s2">"Control"</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Weighted PS Overlap - </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Composite Propensity Score"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"Weighted Count"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">"ps_overlap_weighted.png"</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Saved unweighted and weighted PS plots for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error processing </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1">#  Run</span>
<span class="n">plot_ps_overlap_all_groups</span><span class="p">(</span><span class="n">medication_groups</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Plotting PS overlap for CAT_ADHD
 Saved unweighted and weighted PS plots for CAT_ADHD

 Plotting PS overlap for CAT_Aceetanilidederivaten
 Saved unweighted and weighted PS plots for CAT_Aceetanilidederivaten

 Plotting PS overlap for CAT_Z_drugs
 Saved unweighted and weighted PS plots for CAT_Z_drugs

 Plotting PS overlap for CAT_Opioden
 Saved unweighted and weighted PS plots for CAT_Opioden

 Plotting PS overlap for CAT_NSAIDs
 Saved unweighted and weighted PS plots for CAT_NSAIDs

 Plotting PS overlap for CAT_Benzodiazepine
 Saved unweighted and weighted PS plots for CAT_Benzodiazepine

 Plotting PS overlap for CAT_Antihypertensiva
 Saved unweighted and weighted PS plots for CAT_Antihypertensiva

 Plotting PS overlap for CAT_Antihistaminica
 Saved unweighted and weighted PS plots for CAT_Antihistaminica

 Plotting PS overlap for CAT_Anti_epileptica
 Saved unweighted and weighted PS plots for CAT_Anti_epileptica

 Plotting PS overlap for CAT_Antidepressiva
 Saved unweighted and weighted PS plots for CAT_Antidepressiva

 Plotting PS overlap for CAT_Antipsychotica
 Saved unweighted and weighted PS plots for CAT_Antipsychotica

 Plotting PS overlap for CAT_ALL_PSYCHOTROPICS_EXCL_BENZO
 Saved unweighted and weighted PS plots for CAT_ALL_PSYCHOTROPICS_EXCL_BENZO

 Plotting PS overlap for CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS
 Saved unweighted and weighted PS plots for CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS

 Plotting PS overlap for CAT_ALL_PSYCHOTROPICS
 Saved unweighted and weighted PS plots for CAT_ALL_PSYCHOTROPICS

 Plotting PS overlap for CAT_ALL
 Saved unweighted and weighted PS plots for CAT_ALL
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=a63f995d-519c-4bdc-a3e2-c1abe92c4c2e">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[220]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># Set up base output folder</span>
<span class="n">output_base</span> <span class="o">=</span> <span class="s2">"outputs"</span>
<span class="n">ps_file</span> <span class="o">=</span> <span class="s2">"propensity_scores.xlsx"</span>
<span class="n">iptw_file</span> <span class="o">=</span> <span class="s2">"iptw_weights.xlsx"</span>
<span class="n">trimmed_data_file</span> <span class="o">=</span> <span class="s2">"trimmed_data_imp1.pkl"</span>

<span class="c1"># Collect all treatment group folders</span>
<span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">medication_groups</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">g</span><span class="p">))]</span>

<span class="c1"># Generate 4-panel overlap plots</span>
<span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
    <span class="n">group_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Load trimmed treatment info</span>
        <span class="n">trimmed_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="n">trimmed_data_file</span><span class="p">))</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">trimmed_df</span><span class="o">.</span><span class="n">index</span>

        <span class="c1"># Fix: case-insensitive match for treatment variable</span>
        <span class="n">possible_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">trimmed_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">group</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">possible_cols</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Treatment variable </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> not found in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">, skipping."</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">treatment_var</span> <span class="o">=</span> <span class="n">possible_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">trimmed_df</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span>

        <span class="c1"># Load composite PS (aligned to trimmed_df index)</span>
        <span class="n">ps_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="n">ps_file</span><span class="p">),</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">'composite_ps'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ps_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Composite column missing in </span><span class="si">{</span><span class="n">ps_file</span><span class="si">}</span><span class="s2">, skipping </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">."</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">ps</span> <span class="o">=</span> <span class="n">ps_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s1">'composite_ps'</span><span class="p">]</span>

        <span class="c1"># Load IPTW weights (aligned to trimmed_df index)</span>
        <span class="n">weights_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="n">iptw_file</span><span class="p">),</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">'iptw_mean'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">weights_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" IPTW weight column missing in </span><span class="si">{</span><span class="n">iptw_file</span><span class="si">}</span><span class="s2">, skipping </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">."</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">weights_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s1">'iptw_mean'</span><span class="p">]</span>

        <span class="c1"># Prepare 4 datasets</span>
        <span class="n">raw_treated</span> <span class="o">=</span> <span class="n">ps</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">raw_control</span> <span class="o">=</span> <span class="n">ps</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">weighted_treated</span> <span class="o">=</span> <span class="p">(</span><span class="n">ps</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">],</span> <span class="n">weights</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">weighted_control</span> <span class="o">=</span> <span class="p">(</span><span class="n">ps</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">],</span> <span class="n">weights</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Create plot</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Propensity Score Distribution - </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">raw_treated</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'blue'</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Raw Treated"</span><span class="p">)</span>

        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">raw_control</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'green'</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Raw Control"</span><span class="p">)</span>

        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">weighted_treated</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weighted_treated</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'blue'</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Weighted Treated"</span><span class="p">)</span>

        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">weighted_control</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weighted_control</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'green'</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Weighted Control"</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="o">.</span><span class="n">flat</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Propensity Score"</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Count"</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">])</span>

        <span class="c1"># Save figure</span>
        <span class="n">plot_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"four_panel_overlap_</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">.png"</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_path</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Saved: </span><span class="si">{</span><span class="n">plot_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>  Saved: outputs\CAT_ADHD\four_panel_overlap_CAT_ADHD.png
  Saved: outputs\CAT_Aceetanilidederivaten\four_panel_overlap_CAT_Aceetanilidederivaten.png
  Saved: outputs\CAT_Z_drugs\four_panel_overlap_CAT_Z_drugs.png
  Saved: outputs\CAT_Opioden\four_panel_overlap_CAT_Opioden.png
  Saved: outputs\CAT_NSAIDs\four_panel_overlap_CAT_NSAIDs.png
  Saved: outputs\CAT_Benzodiazepine\four_panel_overlap_CAT_Benzodiazepine.png
  Saved: outputs\CAT_Antihypertensiva\four_panel_overlap_CAT_Antihypertensiva.png
  Saved: outputs\CAT_Antihistaminica\four_panel_overlap_CAT_Antihistaminica.png
  Saved: outputs\CAT_Anti_epileptica\four_panel_overlap_CAT_Anti_epileptica.png
  Saved: outputs\CAT_Antidepressiva\four_panel_overlap_CAT_Antidepressiva.png
  Saved: outputs\CAT_Antipsychotica\four_panel_overlap_CAT_Antipsychotica.png
  Saved: outputs\CAT_ALL_PSYCHOTROPICS_EXCL_BENZO\four_panel_overlap_CAT_ALL_PSYCHOTROPICS_EXCL_BENZO.png
  Saved: outputs\CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS\four_panel_overlap_CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS.png
  Saved: outputs\CAT_ALL_PSYCHOTROPICS\four_panel_overlap_CAT_ALL_PSYCHOTROPICS.png
  Saved: outputs\CAT_ALL\four_panel_overlap_CAT_ALL.png
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=9ae9b6b5-f873-4db1-a724-174b17b565c7">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[221]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># ATT calculation:</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=0d8ec178-4c5a-4efb-8a0b-7af1743d12fe">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[222]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Weighted:</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=385e2c8c-d84f-413c-97ac-97aaacfd3190">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[223]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">GradientBoostingRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">r2_score</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">KFold</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">t</span><span class="p">,</span> <span class="n">probplot</span>
<span class="kn">import</span> <span class="nn">xgboost</span> <span class="k">as</span> <span class="nn">xgb</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Configuration</span>
<span class="c1"># -----------------------------</span>
<span class="n">seeds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span>
<span class="n">imputations</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">output_folder</span> <span class="o">=</span> <span class="s2">"outputs"</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Diagnostic Plotting Function</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">create_diagnostic_plots</span><span class="p">(</span><span class="n">residuals_data</span><span class="p">,</span> <span class="n">fitted_data</span><span class="p">,</span> <span class="n">group_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Create 4 diagnostic plots for model validation"""</span>
    <span class="n">plots_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"plots"</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">plots_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Flatten the collected data</span>
    <span class="n">all_residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">residuals_data</span><span class="p">)</span>
    <span class="n">all_fitted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">fitted_data</span><span class="p">)</span>
    
    <span class="c1"># Create figure with 2x2 subplots</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Diagnostic Plots - </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">'bold'</span><span class="p">)</span>
    
    <span class="c1"># 1. Residuals vs Fitted</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">all_fitted</span><span class="p">,</span> <span class="n">all_residuals</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Fitted Values'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Residuals'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Residuals vs Fitted'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># 2. QQ Plot</span>
    <span class="n">probplot</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s2">"norm"</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Q-Q Plot (Normal)'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># 3. Residual Histogram</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'skyblue'</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">'black'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Residuals'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Density'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Residual Distribution'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># 4. Scale-Location Plot</span>
    <span class="n">sqrt_abs_residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">))</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">all_fitted</span><span class="p">,</span> <span class="n">sqrt_abs_residuals</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Fitted Values'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'|Residuals|'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Scale-Location Plot'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    
    <span class="c1"># Save plot</span>
    <span class="n">plot_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plots_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s1">.png'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_filename</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">'tight'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Diagnostic plots saved for </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Rubin's Rule</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">rubins_pool</span><span class="p">(</span><span class="n">estimates</span><span class="p">,</span> <span class="n">ses</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">estimates</span><span class="p">)</span>
    <span class="n">q_bar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">estimates</span><span class="p">)</span>
    <span class="n">u_bar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">ses</span><span class="p">))</span>
    <span class="n">b_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">estimates</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">total_var</span> <span class="o">=</span> <span class="n">u_bar</span> <span class="o">+</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">b_m</span><span class="p">)</span>
    <span class="n">total_se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">total_var</span><span class="p">)</span>
    <span class="n">ci_lower</span> <span class="o">=</span> <span class="n">q_bar</span> <span class="o">-</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">total_se</span>
    <span class="n">ci_upper</span> <span class="o">=</span> <span class="n">q_bar</span> <span class="o">+</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">total_se</span>
    <span class="n">p_value</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">q_bar</span> <span class="o">/</span> <span class="n">total_se</span><span class="p">),</span> <span class="n">df</span><span class="o">=</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">rounded_p</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">p_value</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">formatted_p</span> <span class="o">=</span> <span class="s2">"&lt; 0.00001"</span> <span class="k">if</span> <span class="n">rounded_p</span> <span class="o">&lt;=</span> <span class="mf">0.00001</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">rounded_p</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">return</span> <span class="n">q_bar</span><span class="p">,</span> <span class="n">total_se</span><span class="p">,</span> <span class="n">ci_lower</span><span class="p">,</span> <span class="n">ci_upper</span><span class="p">,</span> <span class="n">formatted_p</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># SMD + Variance Ratio</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">calculate_smd_vr</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
    <span class="n">treated</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">control</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">w_treated</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">w_control</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">smd</span><span class="p">,</span> <span class="n">vr</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m1</span><span class="p">,</span> <span class="n">m0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">treated</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">w_treated</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">control</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">w_control</span><span class="p">)</span>
            <span class="n">s1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">((</span><span class="n">treated</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">-</span> <span class="n">m1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w_treated</span><span class="p">))</span>
            <span class="n">s0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">((</span><span class="n">control</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">-</span> <span class="n">m0</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w_control</span><span class="p">))</span>
            <span class="n">pooled_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">s1</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">s0</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">smd</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">m1</span> <span class="o">-</span> <span class="n">m0</span><span class="p">)</span> <span class="o">/</span> <span class="n">pooled_sd</span> <span class="k">if</span> <span class="n">pooled_sd</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">vr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s1</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">s0</span><span class="o">**</span><span class="mi">2</span> <span class="k">if</span> <span class="n">s0</span><span class="o">**</span><span class="mi">2</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">smd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">vr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">smd</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">vr</span><span class="p">)</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># OLS Main Loop</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">run_dml_with_trimmed_data</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="p">):</span>
    <span class="n">att_results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">balance_results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">covariates</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Running OLS for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">group_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">group_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">best_result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">best_se</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">"inf"</span><span class="p">)</span>
        
        <span class="c1"># Initialize lists to collect residuals and fitted values for diagnostic plots</span>
        <span class="n">group_residuals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">group_fitted</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="n">seeds</span><span class="p">:</span>
            <span class="c1"># Set random seed for this iteration</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
            
            <span class="n">att_list</span><span class="p">,</span> <span class="n">se_list</span><span class="p">,</span> <span class="n">r2_list</span><span class="p">,</span> <span class="n">rmse_list</span><span class="p">,</span> <span class="n">smd_list</span><span class="p">,</span> <span class="n">vr_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">imp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">imputations</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"trimmed_data_imp</span><span class="si">{</span><span class="n">imp</span><span class="si">}</span><span class="s2">.pkl"</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">or</span> <span class="s2">"iptw"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># Add bootstrap sampling with seed-based randomization</span>
                <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                <span class="n">bootstrap_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">df_bootstrap</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">bootstrap_idx</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="n">X</span> <span class="o">=</span> <span class="n">df_bootstrap</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">T</span> <span class="o">=</span> <span class="n">df_bootstrap</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
                <span class="n">Y</span> <span class="o">=</span> <span class="n">df_bootstrap</span><span class="p">[</span><span class="s2">"caps5_change_baseline"</span><span class="p">]</span>
                <span class="n">W</span> <span class="o">=</span> <span class="n">df_bootstrap</span><span class="p">[</span><span class="s2">"iptw"</span><span class="p">]</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Create design matrix with treatment variable and covariates</span>
                    <span class="n">X_ols</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">T</span><span class="p">,</span> <span class="n">X</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">X_ols</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">X_ols</span><span class="p">)</span>
                    
                    <span class="c1"># Fit weighted OLS with robust standard errors</span>
                    <span class="n">ols_model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">WLS</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">X_ols</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">W</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">cov_type</span><span class="o">=</span><span class="s1">'HC1'</span><span class="p">)</span>
                    
                    <span class="c1"># Extract treatment effect (coefficient of treatment variable)</span>
                    <span class="n">att</span> <span class="o">=</span> <span class="n">ols_model</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>  <span class="c1"># Treatment coefficient</span>
                    <span class="n">se</span> <span class="o">=</span> <span class="n">ols_model</span><span class="o">.</span><span class="n">bse</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>  <span class="c1"># Robust standard error for treatment</span>
                    
                    <span class="n">att_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">att</span><span class="p">)</span>
                    <span class="n">se_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">se</span><span class="p">)</span>

                    <span class="c1"># Calculate model fit statistics</span>
                    <span class="n">Y_pred</span> <span class="o">=</span> <span class="n">ols_model</span><span class="o">.</span><span class="n">fittedvalues</span>
                    <span class="n">residuals</span> <span class="o">=</span> <span class="n">ols_model</span><span class="o">.</span><span class="n">resid</span>
                    <span class="n">rmse</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">Y_pred</span><span class="p">,</span> <span class="n">squared</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">r2</span> <span class="o">=</span> <span class="n">ols_model</span><span class="o">.</span><span class="n">rsquared</span>
                    <span class="n">r2_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
                    <span class="n">rmse_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rmse</span><span class="p">)</span>
                    
                    <span class="c1"># Collect residuals and fitted values for diagnostic plots</span>
                    <span class="n">group_residuals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">residuals</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                    <span class="n">group_fitted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Y_pred</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

                    <span class="n">smd</span><span class="p">,</span> <span class="n">vr</span> <span class="o">=</span> <span class="n">calculate_smd_vr</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span>
                    <span class="n">smd_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smd</span><span class="p">)</span>
                    <span class="n">vr_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vr</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">, seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">, imp </span><span class="si">{</span><span class="n">imp</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">att_list</span><span class="p">:</span>
                <span class="n">att</span><span class="p">,</span> <span class="n">se</span><span class="p">,</span> <span class="n">ci_l</span><span class="p">,</span> <span class="n">ci_u</span><span class="p">,</span> <span class="n">p_val</span> <span class="o">=</span> <span class="n">rubins_pool</span><span class="p">(</span><span class="n">att_list</span><span class="p">,</span> <span class="n">se_list</span><span class="p">)</span>
                <span class="n">avg_r2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">r2_list</span><span class="p">)</span>
                <span class="n">avg_rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rmse_list</span><span class="p">)</span>
                <span class="n">avg_smd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">smd_list</span><span class="p">)</span>
                <span class="n">avg_vr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">vr_list</span><span class="p">)</span>

                <span class="n">balance_results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">"group"</span><span class="p">:</span> <span class="n">group</span><span class="p">,</span> <span class="s2">"seed"</span><span class="p">:</span> <span class="n">seed</span><span class="p">,</span> <span class="s2">"smd"</span><span class="p">:</span> <span class="n">avg_smd</span><span class="p">,</span> <span class="s2">"vr"</span><span class="p">:</span> <span class="n">avg_vr</span>
                <span class="p">})</span>

                <span class="k">if</span> <span class="n">se</span> <span class="o">&lt;</span> <span class="n">best_se</span><span class="p">:</span>
                    <span class="n">best_se</span> <span class="o">=</span> <span class="n">se</span>
                    <span class="n">best_result</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">"group"</span><span class="p">:</span> <span class="n">group</span><span class="p">,</span> <span class="s2">"seed"</span><span class="p">:</span> <span class="n">seed</span><span class="p">,</span> <span class="s2">"att"</span><span class="p">:</span> <span class="n">att</span><span class="p">,</span> <span class="s2">"se"</span><span class="p">:</span> <span class="n">se</span><span class="p">,</span>
                        <span class="s2">"ci_lower"</span><span class="p">:</span> <span class="n">ci_l</span><span class="p">,</span> <span class="s2">"ci_upper"</span><span class="p">:</span> <span class="n">ci_u</span><span class="p">,</span> <span class="s2">"p_value"</span><span class="p">:</span> <span class="n">p_val</span><span class="p">,</span>
                        <span class="s2">"r2"</span><span class="p">:</span> <span class="n">avg_r2</span><span class="p">,</span> <span class="s2">"rmse"</span><span class="p">:</span> <span class="n">avg_rmse</span>
                    <span class="p">}</span>

                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> | Seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">: ATT = </span><span class="si">{</span><span class="n">att</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, SE = </span><span class="si">{</span><span class="n">se</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, p = </span><span class="si">{</span><span class="n">p_val</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No valid results for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> | Seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Create diagnostic plots for this group</span>
        <span class="k">if</span> <span class="n">group_residuals</span> <span class="ow">and</span> <span class="n">group_fitted</span><span class="p">:</span>
            <span class="n">create_diagnostic_plots</span><span class="p">(</span><span class="n">group_residuals</span><span class="p">,</span> <span class="n">group_fitted</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">best_result</span><span class="p">:</span>
            <span class="n">att_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">best_result</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Best result for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">  Seed </span><span class="si">{</span><span class="n">best_result</span><span class="p">[</span><span class="s1">'seed'</span><span class="p">]</span><span class="si">}</span><span class="s2"> | SE = </span><span class="si">{</span><span class="n">best_result</span><span class="p">[</span><span class="s1">'se'</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="c1"># Save final output</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">att_results</span><span class="p">)</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">"ols_rubin_summary_cats.xlsx"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">balance_results</span><span class="p">)</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">"smd_vr_summary_cats.xlsx"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> All summary files saved."</span><span class="p">)</span>

<span class="n">run_dml_with_trimmed_data</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Running OLS for CAT_ADHD
 CAT_ADHD | Seed 1: ATT = 2.2169, SE = 4.6029, p = 0.65523
 CAT_ADHD | Seed 2: ATT = 4.2091, SE = 3.6719, p = 0.31559
 CAT_ADHD | Seed 3: ATT = 0.8551, SE = 5.3635, p = 0.88106
 CAT_ADHD | Seed 4: ATT = 0.7429, SE = 4.1065, p = 0.86524
 CAT_ADHD | Seed 5: ATT = 0.6460, SE = 5.5854, p = 0.91350
 CAT_ADHD | Seed 6: ATT = 0.3525, SE = 4.0702, p = 0.93514
 CAT_ADHD | Seed 7: ATT = -0.5100, SE = 6.0831, p = 0.93721
 CAT_ADHD | Seed 8: ATT = -0.1210, SE = 5.6935, p = 0.98407
 CAT_ADHD | Seed 9: ATT = 1.0282, SE = 6.8455, p = 0.88787
 CAT_ADHD | Seed 10: ATT = -0.3066, SE = 5.1878, p = 0.95571
 Diagnostic plots saved for CAT_ADHD
 Best result for CAT_ADHD  Seed 2 | SE = 3.6719

 Running OLS for CAT_Aceetanilidederivaten
 CAT_Aceetanilidederivaten | Seed 1: ATT = -0.6440, SE = 4.5879, p = 0.89515
 CAT_Aceetanilidederivaten | Seed 2: ATT = 0.2526, SE = 8.5349, p = 0.97781
 CAT_Aceetanilidederivaten | Seed 3: ATT = -0.0429, SE = 5.2668, p = 0.99389
 CAT_Aceetanilidederivaten | Seed 4: ATT = -2.4911, SE = 4.4843, p = 0.60815
 CAT_Aceetanilidederivaten | Seed 5: ATT = 0.1025, SE = 4.4687, p = 0.98280
 CAT_Aceetanilidederivaten | Seed 6: ATT = -1.8631, SE = 4.6953, p = 0.71178
 CAT_Aceetanilidederivaten | Seed 7: ATT = -2.2572, SE = 5.5077, p = 0.70293
 CAT_Aceetanilidederivaten | Seed 8: ATT = 1.8612, SE = 6.9384, p = 0.80177
 CAT_Aceetanilidederivaten | Seed 9: ATT = 0.3798, SE = 5.9300, p = 0.95200
 CAT_Aceetanilidederivaten | Seed 10: ATT = -3.3899, SE = 4.6838, p = 0.50928
 Diagnostic plots saved for CAT_Aceetanilidederivaten
 Best result for CAT_Aceetanilidederivaten  Seed 5 | SE = 4.4687

 Running OLS for CAT_Z_drugs
 CAT_Z_drugs | Seed 1: ATT = 6.1797, SE = 2.7047, p = 0.08434
 CAT_Z_drugs | Seed 2: ATT = 5.1670, SE = 3.9584, p = 0.26180
 CAT_Z_drugs | Seed 3: ATT = 4.0703, SE = 3.0996, p = 0.25939
 CAT_Z_drugs | Seed 4: ATT = 2.7699, SE = 3.6537, p = 0.49060
 CAT_Z_drugs | Seed 5: ATT = 3.5578, SE = 2.4924, p = 0.22663
 CAT_Z_drugs | Seed 6: ATT = 5.6613, SE = 3.4580, p = 0.17694
 CAT_Z_drugs | Seed 7: ATT = 3.4740, SE = 3.2419, p = 0.34426
 CAT_Z_drugs | Seed 8: ATT = 4.0807, SE = 3.4523, p = 0.30267
 CAT_Z_drugs | Seed 9: ATT = 5.8440, SE = 2.8994, p = 0.11407
 CAT_Z_drugs | Seed 10: ATT = 7.3256, SE = 2.6726, p = 0.05185
 Diagnostic plots saved for CAT_Z_drugs
 Best result for CAT_Z_drugs  Seed 5 | SE = 2.4924

 Running OLS for CAT_Opioden
 CAT_Opioden | Seed 1: ATT = 3.2050, SE = 5.9956, p = 0.62129
 CAT_Opioden | Seed 2: ATT = 5.4001, SE = 6.0424, p = 0.42199
 CAT_Opioden | Seed 3: ATT = 5.3883, SE = 5.5618, p = 0.38750
 CAT_Opioden | Seed 4: ATT = 2.4019, SE = 5.3635, p = 0.67746
 CAT_Opioden | Seed 5: ATT = 6.3656, SE = 5.8048, p = 0.33440
 CAT_Opioden | Seed 6: ATT = 4.5452, SE = 3.9373, p = 0.31261
 CAT_Opioden | Seed 7: ATT = 5.0385, SE = 5.4301, p = 0.40598
 CAT_Opioden | Seed 8: ATT = 4.9308, SE = 4.4942, p = 0.33419
 CAT_Opioden | Seed 9: ATT = 6.3893, SE = 8.4199, p = 0.49021
 CAT_Opioden | Seed 10: ATT = 4.0434, SE = 4.1348, p = 0.38350
 Diagnostic plots saved for CAT_Opioden
 Best result for CAT_Opioden  Seed 6 | SE = 3.9373

 Running OLS for CAT_NSAIDs
 CAT_NSAIDs | Seed 1: ATT = -0.4325, SE = 8.9497, p = 0.96377
 CAT_NSAIDs | Seed 2: ATT = -4.3579, SE = 9.9025, p = 0.68261
 CAT_NSAIDs | Seed 3: ATT = -1.4121, SE = 10.4341, p = 0.89888
 CAT_NSAIDs | Seed 4: ATT = -6.3255, SE = 6.9858, p = 0.41642
 CAT_NSAIDs | Seed 5: ATT = -1.1666, SE = 7.6042, p = 0.88550
 CAT_NSAIDs | Seed 6: ATT = -1.9540, SE = 7.4685, p = 0.80652
 CAT_NSAIDs | Seed 7: ATT = 2.7988, SE = 8.6579, p = 0.76269
 CAT_NSAIDs | Seed 8: ATT = -7.6175, SE = 6.9415, p = 0.33409
 CAT_NSAIDs | Seed 9: ATT = -3.6687, SE = 7.3124, p = 0.64223
 CAT_NSAIDs | Seed 10: ATT = -2.2783, SE = 11.0861, p = 0.84721
 Diagnostic plots saved for CAT_NSAIDs
 Best result for CAT_NSAIDs  Seed 8 | SE = 6.9415

 Running OLS for CAT_Benzodiazepine
 CAT_Benzodiazepine | Seed 1: ATT = 2.3278, SE = 0.9835, p = 0.07709
 CAT_Benzodiazepine | Seed 2: ATT = 1.6416, SE = 1.6544, p = 0.37721
 CAT_Benzodiazepine | Seed 3: ATT = 1.6255, SE = 1.2087, p = 0.24987
 CAT_Benzodiazepine | Seed 4: ATT = 1.4059, SE = 1.1063, p = 0.27268
 CAT_Benzodiazepine | Seed 5: ATT = 2.0990, SE = 1.2480, p = 0.16789
 CAT_Benzodiazepine | Seed 6: ATT = 1.1903, SE = 1.1803, p = 0.37029
 CAT_Benzodiazepine | Seed 7: ATT = 1.4139, SE = 1.3083, p = 0.34062
 CAT_Benzodiazepine | Seed 8: ATT = 1.4961, SE = 1.5910, p = 0.40029
 CAT_Benzodiazepine | Seed 9: ATT = 1.8980, SE = 1.4048, p = 0.24802
 CAT_Benzodiazepine | Seed 10: ATT = 2.6565, SE = 1.3289, p = 0.11625
 Diagnostic plots saved for CAT_Benzodiazepine
 Best result for CAT_Benzodiazepine  Seed 1 | SE = 0.9835

 Running OLS for CAT_Antihypertensiva
 CAT_Antihypertensiva | Seed 1: ATT = 0.7929, SE = 6.5678, p = 0.90973
 CAT_Antihypertensiva | Seed 2: ATT = 4.2476, SE = 3.3312, p = 0.27131
 CAT_Antihypertensiva | Seed 3: ATT = 2.7274, SE = 5.1191, p = 0.62241
 CAT_Antihypertensiva | Seed 4: ATT = 0.0992, SE = 3.3127, p = 0.97754
 CAT_Antihypertensiva | Seed 5: ATT = -1.7421, SE = 6.7532, p = 0.80917
 CAT_Antihypertensiva | Seed 6: ATT = 0.2603, SE = 6.5054, p = 0.97000
 CAT_Antihypertensiva | Seed 7: ATT = 0.2249, SE = 6.4078, p = 0.97368
 CAT_Antihypertensiva | Seed 8: ATT = 0.9812, SE = 3.9302, p = 0.81516
 CAT_Antihypertensiva | Seed 9: ATT = -1.1019, SE = 7.1206, p = 0.88451
 CAT_Antihypertensiva | Seed 10: ATT = 1.0659, SE = 5.3797, p = 0.85260
 Diagnostic plots saved for CAT_Antihypertensiva
 Best result for CAT_Antihypertensiva  Seed 4 | SE = 3.3127

 Running OLS for CAT_Antihistaminica
 CAT_Antihistaminica | Seed 1: ATT = 5.0258, SE = 5.9689, p = 0.44719
 CAT_Antihistaminica | Seed 2: ATT = 2.6380, SE = 5.0951, p = 0.63195
 CAT_Antihistaminica | Seed 3: ATT = 4.3770, SE = 4.4199, p = 0.37809
 CAT_Antihistaminica | Seed 4: ATT = 3.1103, SE = 5.0543, p = 0.57159
 CAT_Antihistaminica | Seed 5: ATT = 7.4493, SE = 5.3393, p = 0.23544
 CAT_Antihistaminica | Seed 6: ATT = 4.0274, SE = 3.8740, p = 0.35723
 CAT_Antihistaminica | Seed 7: ATT = 2.2920, SE = 4.0579, p = 0.60237
 CAT_Antihistaminica | Seed 8: ATT = 3.8791, SE = 4.6369, p = 0.44990
 CAT_Antihistaminica | Seed 9: ATT = 5.2151, SE = 5.2170, p = 0.37406
 CAT_Antihistaminica | Seed 10: ATT = 6.0494, SE = 3.5325, p = 0.16196
 Diagnostic plots saved for CAT_Antihistaminica
 Best result for CAT_Antihistaminica  Seed 10 | SE = 3.5325

 Running OLS for CAT_Anti_epileptica
 CAT_Anti_epileptica | Seed 1: ATT = 5.4193, SE = 3.7903, p = 0.22600
 CAT_Anti_epileptica | Seed 2: ATT = 5.5635, SE = 3.0343, p = 0.14065
 CAT_Anti_epileptica | Seed 3: ATT = 6.6231, SE = 2.8413, p = 0.08016
 CAT_Anti_epileptica | Seed 4: ATT = 6.0262, SE = 4.3799, p = 0.24087
 CAT_Anti_epileptica | Seed 5: ATT = 7.2976, SE = 2.3841, p = 0.03763
 CAT_Anti_epileptica | Seed 6: ATT = 6.6857, SE = 4.0112, p = 0.17089
 CAT_Anti_epileptica | Seed 7: ATT = 5.8138, SE = 2.8892, p = 0.11450
 CAT_Anti_epileptica | Seed 8: ATT = 5.7980, SE = 3.7942, p = 0.20121
 CAT_Anti_epileptica | Seed 9: ATT = 6.9598, SE = 3.3618, p = 0.10720
 CAT_Anti_epileptica | Seed 10: ATT = 4.0946, SE = 3.3782, p = 0.29218
 Diagnostic plots saved for CAT_Anti_epileptica
 Best result for CAT_Anti_epileptica  Seed 5 | SE = 2.3841

 Running OLS for CAT_Antidepressiva
 CAT_Antidepressiva | Seed 1: ATT = 0.8556, SE = 0.9284, p = 0.40892
 CAT_Antidepressiva | Seed 2: ATT = 1.3691, SE = 1.0197, p = 0.25052
 CAT_Antidepressiva | Seed 3: ATT = 1.4959, SE = 1.0636, p = 0.23230
 CAT_Antidepressiva | Seed 4: ATT = 1.0568, SE = 1.0018, p = 0.35100
 CAT_Antidepressiva | Seed 5: ATT = 1.2913, SE = 0.9251, p = 0.23524
 CAT_Antidepressiva | Seed 6: ATT = 1.0525, SE = 1.0069, p = 0.35492
 CAT_Antidepressiva | Seed 7: ATT = 1.5072, SE = 0.9092, p = 0.17271
 CAT_Antidepressiva | Seed 8: ATT = 1.3595, SE = 0.7575, p = 0.14716
 CAT_Antidepressiva | Seed 9: ATT = 1.3901, SE = 1.0321, p = 0.24928
 CAT_Antidepressiva | Seed 10: ATT = 1.8554, SE = 1.2041, p = 0.19820
 Diagnostic plots saved for CAT_Antidepressiva
 Best result for CAT_Antidepressiva  Seed 8 | SE = 0.7575

 Running OLS for CAT_Antipsychotica
 CAT_Antipsychotica | Seed 1: ATT = 1.1885, SE = 1.6182, p = 0.50342
 CAT_Antipsychotica | Seed 2: ATT = 1.5434, SE = 1.4324, p = 0.34190
 CAT_Antipsychotica | Seed 3: ATT = 1.8718, SE = 1.3398, p = 0.23490
 CAT_Antipsychotica | Seed 4: ATT = 1.6171, SE = 1.8164, p = 0.42361
 CAT_Antipsychotica | Seed 5: ATT = 2.3424, SE = 1.9373, p = 0.29321
 CAT_Antipsychotica | Seed 6: ATT = 1.0168, SE = 1.5986, p = 0.55930
 CAT_Antipsychotica | Seed 7: ATT = 1.8399, SE = 1.4822, p = 0.28229
 CAT_Antipsychotica | Seed 8: ATT = 2.1019, SE = 2.2632, p = 0.40559
 CAT_Antipsychotica | Seed 9: ATT = 1.9104, SE = 1.6938, p = 0.32243
 CAT_Antipsychotica | Seed 10: ATT = 1.0726, SE = 1.7089, p = 0.56429
 Diagnostic plots saved for CAT_Antipsychotica
 Best result for CAT_Antipsychotica  Seed 3 | SE = 1.3398

 Running OLS for CAT_ALL_PSYCHOTROPICS_EXCL_BENZO
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 1: ATT = 1.8701, SE = 0.9522, p = 0.12099
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 2: ATT = 2.4707, SE = 1.3608, p = 0.14360
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 3: ATT = 2.5358, SE = 1.1970, p = 0.10152
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 4: ATT = 2.1184, SE = 1.0246, p = 0.10754
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 5: ATT = 2.5901, SE = 0.8851, p = 0.04297
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 6: ATT = 2.5750, SE = 1.1623, p = 0.09108
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 7: ATT = 2.0797, SE = 0.8456, p = 0.06973
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 8: ATT = 2.0897, SE = 0.9267, p = 0.08716
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 9: ATT = 2.2678, SE = 1.3382, p = 0.16539
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 10: ATT = 2.2203, SE = 0.9688, p = 0.08370
 Diagnostic plots saved for CAT_ALL_PSYCHOTROPICS_EXCL_BENZO
 Best result for CAT_ALL_PSYCHOTROPICS_EXCL_BENZO  Seed 7 | SE = 0.8456

 Running OLS for CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 1: ATT = 2.5033, SE = 1.4557, p = 0.16063
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 2: ATT = 1.6925, SE = 1.1990, p = 0.23090
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 3: ATT = 2.2284, SE = 0.9363, p = 0.07599
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 4: ATT = 2.0073, SE = 0.7327, p = 0.05192
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 5: ATT = 2.6700, SE = 1.0198, p = 0.05891
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 6: ATT = 2.2008, SE = 0.9016, p = 0.07114
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 7: ATT = 1.8029, SE = 1.1577, p = 0.19441
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 8: ATT = 2.2019, SE = 1.3430, p = 0.17645
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 9: ATT = 2.2857, SE = 1.0287, p = 0.09041
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 10: ATT = 2.0574, SE = 0.8811, p = 0.07982
 Diagnostic plots saved for CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS
 Best result for CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS  Seed 4 | SE = 0.7327

 Running OLS for CAT_ALL_PSYCHOTROPICS
 CAT_ALL_PSYCHOTROPICS | Seed 1: ATT = 2.8905, SE = 0.6677, p = 0.01236
 CAT_ALL_PSYCHOTROPICS | Seed 2: ATT = 2.5281, SE = 0.8508, p = 0.04108
 CAT_ALL_PSYCHOTROPICS | Seed 3: ATT = 3.0217, SE = 0.8514, p = 0.02382
 CAT_ALL_PSYCHOTROPICS | Seed 4: ATT = 2.4606, SE = 0.8693, p = 0.04732
 CAT_ALL_PSYCHOTROPICS | Seed 5: ATT = 2.5126, SE = 0.9002, p = 0.04926
 CAT_ALL_PSYCHOTROPICS | Seed 6: ATT = 2.8232, SE = 0.8627, p = 0.03072
 CAT_ALL_PSYCHOTROPICS | Seed 7: ATT = 2.8804, SE = 0.9171, p = 0.03482
 CAT_ALL_PSYCHOTROPICS | Seed 8: ATT = 2.4046, SE = 0.9179, p = 0.05882
 CAT_ALL_PSYCHOTROPICS | Seed 9: ATT = 3.3355, SE = 0.8359, p = 0.01626
 CAT_ALL_PSYCHOTROPICS | Seed 10: ATT = 2.6314, SE = 0.7274, p = 0.02240
 Diagnostic plots saved for CAT_ALL_PSYCHOTROPICS
 Best result for CAT_ALL_PSYCHOTROPICS  Seed 1 | SE = 0.6677

 Running OLS for CAT_ALL
 CAT_ALL | Seed 1: ATT = 2.9530, SE = 0.9007, p = 0.03054
 CAT_ALL | Seed 2: ATT = 2.9655, SE = 0.6171, p = 0.00861
 CAT_ALL | Seed 3: ATT = 3.3278, SE = 0.8525, p = 0.01749
 CAT_ALL | Seed 4: ATT = 2.6706, SE = 0.8098, p = 0.03000
 CAT_ALL | Seed 5: ATT = 3.4366, SE = 1.1991, p = 0.04565
 CAT_ALL | Seed 6: ATT = 3.1041, SE = 0.6530, p = 0.00895
 CAT_ALL | Seed 7: ATT = 2.7380, SE = 0.6692, p = 0.01496
 CAT_ALL | Seed 8: ATT = 3.2569, SE = 0.6618, p = 0.00792
 CAT_ALL | Seed 9: ATT = 3.2541, SE = 0.9901, p = 0.03031
 CAT_ALL | Seed 10: ATT = 2.9626, SE = 0.9123, p = 0.03145
 Diagnostic plots saved for CAT_ALL
 Best result for CAT_ALL  Seed 2 | SE = 0.6171

 All summary files saved.
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=711869a8-2bfe-485e-aff1-ce2d761df39d">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[224]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Unweighted:</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=354cb95e-628a-4234-b37a-085d0fd153ea">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[225]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">GradientBoostingRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">r2_score</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">KFold</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">t</span><span class="p">,</span> <span class="n">probplot</span>
<span class="kn">import</span> <span class="nn">xgboost</span> <span class="k">as</span> <span class="nn">xgb</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Configuration</span>
<span class="c1"># -----------------------------</span>
<span class="n">seeds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span>
<span class="n">imputations</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">output_folder</span> <span class="o">=</span> <span class="s2">"outputs"</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Diagnostic Plotting Function</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">create_diagnostic_plots</span><span class="p">(</span><span class="n">residuals_data</span><span class="p">,</span> <span class="n">fitted_data</span><span class="p">,</span> <span class="n">group_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Create 4 diagnostic plots for model validation"""</span>
    <span class="n">plots_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"plots"</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">plots_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Flatten the collected data</span>
    <span class="n">all_residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">residuals_data</span><span class="p">)</span>
    <span class="n">all_fitted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">fitted_data</span><span class="p">)</span>
    
    <span class="c1"># Create figure with 2x2 subplots</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Diagnostic Plots - </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">'bold'</span><span class="p">)</span>
    
    <span class="c1"># 1. Residuals vs Fitted</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">all_fitted</span><span class="p">,</span> <span class="n">all_residuals</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Fitted Values'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Residuals'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Residuals vs Fitted'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># 2. QQ Plot</span>
    <span class="n">probplot</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s2">"norm"</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Q-Q Plot (Normal)'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># 3. Residual Histogram</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'skyblue'</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">'black'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Residuals'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Density'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Residual Distribution'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># 4. Scale-Location Plot</span>
    <span class="n">sqrt_abs_residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">))</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">all_fitted</span><span class="p">,</span> <span class="n">sqrt_abs_residuals</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Fitted Values'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'|Residuals|'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Scale-Location Plot'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    
    <span class="c1"># Save plot</span>
    <span class="n">plot_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plots_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s1">_unweighted.png'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_filename</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">'tight'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Diagnostic plots saved for </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Rubin's Rule</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">rubins_pool</span><span class="p">(</span><span class="n">estimates</span><span class="p">,</span> <span class="n">ses</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">estimates</span><span class="p">)</span>
    <span class="n">q_bar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">estimates</span><span class="p">)</span>
    <span class="n">u_bar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">ses</span><span class="p">))</span>
    <span class="n">b_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">estimates</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">total_var</span> <span class="o">=</span> <span class="n">u_bar</span> <span class="o">+</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">b_m</span><span class="p">)</span>
    <span class="n">total_se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">total_var</span><span class="p">)</span>
    <span class="n">ci_lower</span> <span class="o">=</span> <span class="n">q_bar</span> <span class="o">-</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">total_se</span>
    <span class="n">ci_upper</span> <span class="o">=</span> <span class="n">q_bar</span> <span class="o">+</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">total_se</span>
    <span class="n">p_value</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">q_bar</span> <span class="o">/</span> <span class="n">total_se</span><span class="p">),</span> <span class="n">df</span><span class="o">=</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">rounded_p</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">p_value</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">formatted_p</span> <span class="o">=</span> <span class="s2">"&lt; 0.00001"</span> <span class="k">if</span> <span class="n">rounded_p</span> <span class="o">&lt;=</span> <span class="mf">0.00001</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">rounded_p</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">return</span> <span class="n">q_bar</span><span class="p">,</span> <span class="n">total_se</span><span class="p">,</span> <span class="n">ci_lower</span><span class="p">,</span> <span class="n">ci_upper</span><span class="p">,</span> <span class="n">formatted_p</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># SMD + Variance Ratio</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">calculate_smd_vr</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
    <span class="n">treated</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">control</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">smd</span><span class="p">,</span> <span class="n">vr</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m1</span><span class="p">,</span> <span class="n">m0</span> <span class="o">=</span> <span class="n">treated</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">control</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">s1</span> <span class="o">=</span> <span class="n">treated</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
            <span class="n">s0</span> <span class="o">=</span> <span class="n">control</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
            <span class="n">pooled_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">s1</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">s0</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">smd</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">m1</span> <span class="o">-</span> <span class="n">m0</span><span class="p">)</span> <span class="o">/</span> <span class="n">pooled_sd</span> <span class="k">if</span> <span class="n">pooled_sd</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">vr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s1</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">s0</span><span class="o">**</span><span class="mi">2</span> <span class="k">if</span> <span class="n">s0</span><span class="o">**</span><span class="mi">2</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">smd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">vr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">smd</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">vr</span><span class="p">)</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># OLS Main Loop</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">run_dml_with_trimmed_data</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="p">):</span>
    <span class="n">att_results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">balance_results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">covariates</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Running OLS for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">group_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">group_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">best_result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">best_se</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">"inf"</span><span class="p">)</span>
        
        <span class="c1"># Initialize lists to collect residuals and fitted values for diagnostic plots</span>
        <span class="n">group_residuals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">group_fitted</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="n">seeds</span><span class="p">:</span>
            <span class="c1"># Set random seed for this iteration</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
            
            <span class="n">att_list</span><span class="p">,</span> <span class="n">se_list</span><span class="p">,</span> <span class="n">r2_list</span><span class="p">,</span> <span class="n">rmse_list</span><span class="p">,</span> <span class="n">smd_list</span><span class="p">,</span> <span class="n">vr_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">imp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">imputations</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"trimmed_data_imp</span><span class="si">{</span><span class="n">imp</span><span class="si">}</span><span class="s2">.pkl"</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">or</span> <span class="s2">"iptw"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># Add bootstrap sampling with seed-based randomization</span>
                <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                <span class="n">bootstrap_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">df_bootstrap</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">bootstrap_idx</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="n">X</span> <span class="o">=</span> <span class="n">df_bootstrap</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">T</span> <span class="o">=</span> <span class="n">df_bootstrap</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
                <span class="n">Y</span> <span class="o">=</span> <span class="n">df_bootstrap</span><span class="p">[</span><span class="s2">"caps5_change_baseline"</span><span class="p">]</span>
                <span class="c1">#W = df_bootstrap["iptw"]</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Create design matrix with treatment variable and covariates</span>
                    <span class="n">X_ols</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">T</span><span class="p">,</span> <span class="n">X</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">X_ols</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">X_ols</span><span class="p">)</span>
                    
                    <span class="c1"># Fit OLS with robust standard errors (unweighted)</span>
                    <span class="n">ols_model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">X_ols</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">cov_type</span><span class="o">=</span><span class="s1">'HC1'</span><span class="p">)</span>
                    
                    <span class="c1"># Extract treatment effect (coefficient of treatment variable)</span>
                    <span class="n">att</span> <span class="o">=</span> <span class="n">ols_model</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>  <span class="c1"># Treatment coefficient</span>
                    <span class="n">se</span> <span class="o">=</span> <span class="n">ols_model</span><span class="o">.</span><span class="n">bse</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>  <span class="c1"># Robust standard error for treatment</span>
                    
                    <span class="n">att_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">att</span><span class="p">)</span>
                    <span class="n">se_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">se</span><span class="p">)</span>

                    <span class="c1"># Calculate model fit statistics</span>
                    <span class="n">Y_pred</span> <span class="o">=</span> <span class="n">ols_model</span><span class="o">.</span><span class="n">fittedvalues</span>
                    <span class="n">residuals</span> <span class="o">=</span> <span class="n">ols_model</span><span class="o">.</span><span class="n">resid</span>
                    <span class="n">rmse</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">Y_pred</span><span class="p">,</span> <span class="n">squared</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">r2</span> <span class="o">=</span> <span class="n">ols_model</span><span class="o">.</span><span class="n">rsquared</span>
                    <span class="n">r2_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
                    <span class="n">rmse_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rmse</span><span class="p">)</span>
                    
                    <span class="c1"># Collect residuals and fitted values for diagnostic plots</span>
                    <span class="n">group_residuals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">residuals</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                    <span class="n">group_fitted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Y_pred</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

                    <span class="n">smd</span><span class="p">,</span> <span class="n">vr</span> <span class="o">=</span> <span class="n">calculate_smd_vr</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
                    <span class="n">smd_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smd</span><span class="p">)</span>
                    <span class="n">vr_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vr</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">, seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">, imp </span><span class="si">{</span><span class="n">imp</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">att_list</span><span class="p">:</span>
                <span class="n">att</span><span class="p">,</span> <span class="n">se</span><span class="p">,</span> <span class="n">ci_l</span><span class="p">,</span> <span class="n">ci_u</span><span class="p">,</span> <span class="n">p_val</span> <span class="o">=</span> <span class="n">rubins_pool</span><span class="p">(</span><span class="n">att_list</span><span class="p">,</span> <span class="n">se_list</span><span class="p">)</span>
                <span class="n">avg_r2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">r2_list</span><span class="p">)</span>
                <span class="n">avg_rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rmse_list</span><span class="p">)</span>
                <span class="n">avg_smd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">smd_list</span><span class="p">)</span>
                <span class="n">avg_vr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">vr_list</span><span class="p">)</span>

                <span class="n">balance_results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">"group"</span><span class="p">:</span> <span class="n">group</span><span class="p">,</span> <span class="s2">"seed"</span><span class="p">:</span> <span class="n">seed</span><span class="p">,</span> <span class="s2">"smd"</span><span class="p">:</span> <span class="n">avg_smd</span><span class="p">,</span> <span class="s2">"vr"</span><span class="p">:</span> <span class="n">avg_vr</span>
                <span class="p">})</span>

                <span class="k">if</span> <span class="n">se</span> <span class="o">&lt;</span> <span class="n">best_se</span><span class="p">:</span>
                    <span class="n">best_se</span> <span class="o">=</span> <span class="n">se</span>
                    <span class="n">best_result</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">"group"</span><span class="p">:</span> <span class="n">group</span><span class="p">,</span> <span class="s2">"seed"</span><span class="p">:</span> <span class="n">seed</span><span class="p">,</span> <span class="s2">"att"</span><span class="p">:</span> <span class="n">att</span><span class="p">,</span> <span class="s2">"se"</span><span class="p">:</span> <span class="n">se</span><span class="p">,</span>
                        <span class="s2">"ci_lower"</span><span class="p">:</span> <span class="n">ci_l</span><span class="p">,</span> <span class="s2">"ci_upper"</span><span class="p">:</span> <span class="n">ci_u</span><span class="p">,</span> <span class="s2">"p_value"</span><span class="p">:</span> <span class="n">p_val</span><span class="p">,</span>
                        <span class="s2">"r2"</span><span class="p">:</span> <span class="n">avg_r2</span><span class="p">,</span> <span class="s2">"rmse"</span><span class="p">:</span> <span class="n">avg_rmse</span>
                    <span class="p">}</span>

                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> | Seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">: ATT = </span><span class="si">{</span><span class="n">att</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, SE = </span><span class="si">{</span><span class="n">se</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, p = </span><span class="si">{</span><span class="n">p_val</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No valid results for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> | Seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Create diagnostic plots for this group</span>
        <span class="k">if</span> <span class="n">group_residuals</span> <span class="ow">and</span> <span class="n">group_fitted</span><span class="p">:</span>
            <span class="n">create_diagnostic_plots</span><span class="p">(</span><span class="n">group_residuals</span><span class="p">,</span> <span class="n">group_fitted</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">best_result</span><span class="p">:</span>
            <span class="n">att_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">best_result</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Best result for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">  Seed </span><span class="si">{</span><span class="n">best_result</span><span class="p">[</span><span class="s1">'seed'</span><span class="p">]</span><span class="si">}</span><span class="s2"> | SE = </span><span class="si">{</span><span class="n">best_result</span><span class="p">[</span><span class="s1">'se'</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="c1"># Save final output</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">att_results</span><span class="p">)</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">"ols_rubin_summary_cats_unweighted.xlsx"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">balance_results</span><span class="p">)</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">"smd_vr_summary_cats_unweighted.xlsx"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> All summary files saved."</span><span class="p">)</span>

<span class="n">run_dml_with_trimmed_data</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Running OLS for CAT_ADHD
 CAT_ADHD | Seed 1: ATT = 1.3674, SE = 5.4795, p = 0.81522
 CAT_ADHD | Seed 2: ATT = 2.6991, SE = 5.1155, p = 0.62567
 CAT_ADHD | Seed 3: ATT = 0.3165, SE = 7.0745, p = 0.96646
 CAT_ADHD | Seed 4: ATT = 1.0238, SE = 6.8883, p = 0.88904
 CAT_ADHD | Seed 5: ATT = 0.8215, SE = 7.8247, p = 0.92144
 CAT_ADHD | Seed 6: ATT = 0.2706, SE = 5.7255, p = 0.96457
 CAT_ADHD | Seed 7: ATT = -0.1040, SE = 7.2635, p = 0.98926
 CAT_ADHD | Seed 8: ATT = -1.8000, SE = 7.6022, p = 0.82447
 CAT_ADHD | Seed 9: ATT = 0.9549, SE = 7.1465, p = 0.90016
 CAT_ADHD | Seed 10: ATT = -1.3080, SE = 5.5137, p = 0.82413
 Diagnostic plots saved for CAT_ADHD
 Best result for CAT_ADHD  Seed 2 | SE = 5.1155

 Running OLS for CAT_Aceetanilidederivaten
 CAT_Aceetanilidederivaten | Seed 1: ATT = 1.8247, SE = 4.8795, p = 0.72742
 CAT_Aceetanilidederivaten | Seed 2: ATT = 1.9373, SE = 9.4798, p = 0.84805
 CAT_Aceetanilidederivaten | Seed 3: ATT = 2.7035, SE = 6.1414, p = 0.68252
 CAT_Aceetanilidederivaten | Seed 4: ATT = -0.0039, SE = 6.4825, p = 0.99955
 CAT_Aceetanilidederivaten | Seed 5: ATT = 1.8825, SE = 4.6162, p = 0.70430
 CAT_Aceetanilidederivaten | Seed 6: ATT = 0.4054, SE = 5.6780, p = 0.94651
 CAT_Aceetanilidederivaten | Seed 7: ATT = -0.0293, SE = 5.3483, p = 0.99589
 CAT_Aceetanilidederivaten | Seed 8: ATT = 3.1005, SE = 6.8913, p = 0.67608
 CAT_Aceetanilidederivaten | Seed 9: ATT = 1.7500, SE = 6.0199, p = 0.78573
 CAT_Aceetanilidederivaten | Seed 10: ATT = -1.5583, SE = 4.5800, p = 0.75079
 Diagnostic plots saved for CAT_Aceetanilidederivaten
 Best result for CAT_Aceetanilidederivaten  Seed 10 | SE = 4.5800

 Running OLS for CAT_Z_drugs
 CAT_Z_drugs | Seed 1: ATT = 7.1080, SE = 3.3952, p = 0.10441
 CAT_Z_drugs | Seed 2: ATT = 7.2580, SE = 4.7459, p = 0.20092
 CAT_Z_drugs | Seed 3: ATT = 5.2818, SE = 3.7763, p = 0.23447
 CAT_Z_drugs | Seed 4: ATT = 4.1408, SE = 5.0653, p = 0.45954
 CAT_Z_drugs | Seed 5: ATT = 4.9129, SE = 2.8076, p = 0.15504
 CAT_Z_drugs | Seed 6: ATT = 6.2276, SE = 3.8765, p = 0.18344
 CAT_Z_drugs | Seed 7: ATT = 3.8605, SE = 3.6826, p = 0.35365
 CAT_Z_drugs | Seed 8: ATT = 4.2235, SE = 3.7479, p = 0.32281
 CAT_Z_drugs | Seed 9: ATT = 6.6835, SE = 3.7577, p = 0.14993
 CAT_Z_drugs | Seed 10: ATT = 7.8847, SE = 3.3103, p = 0.07584
 Diagnostic plots saved for CAT_Z_drugs
 Best result for CAT_Z_drugs  Seed 5 | SE = 2.8076

 Running OLS for CAT_Opioden
 CAT_Opioden | Seed 1: ATT = 3.0347, SE = 6.3785, p = 0.65906
 CAT_Opioden | Seed 2: ATT = 4.7794, SE = 7.0895, p = 0.53717
 CAT_Opioden | Seed 3: ATT = 5.2488, SE = 6.6041, p = 0.47123
 CAT_Opioden | Seed 4: ATT = 1.8597, SE = 6.9393, p = 0.80195
 CAT_Opioden | Seed 5: ATT = 5.9853, SE = 5.8068, p = 0.36090
 CAT_Opioden | Seed 6: ATT = 5.1217, SE = 4.2494, p = 0.29453
 CAT_Opioden | Seed 7: ATT = 5.4775, SE = 5.3218, p = 0.36153
 CAT_Opioden | Seed 8: ATT = 3.8273, SE = 5.4837, p = 0.52366
 CAT_Opioden | Seed 9: ATT = 5.6116, SE = 8.1080, p = 0.52695
 CAT_Opioden | Seed 10: ATT = 3.3666, SE = 5.6117, p = 0.58088
 Diagnostic plots saved for CAT_Opioden
 Best result for CAT_Opioden  Seed 6 | SE = 4.2494

 Running OLS for CAT_NSAIDs
 CAT_NSAIDs | Seed 1: ATT = -3.3895, SE = 7.0812, p = 0.65717
 CAT_NSAIDs | Seed 2: ATT = -5.0673, SE = 8.6143, p = 0.58797
 CAT_NSAIDs | Seed 3: ATT = -2.7267, SE = 8.1605, p = 0.75506
 CAT_NSAIDs | Seed 4: ATT = -6.4394, SE = 5.9080, p = 0.33700
 CAT_NSAIDs | Seed 5: ATT = -4.7776, SE = 6.3354, p = 0.49274
 CAT_NSAIDs | Seed 6: ATT = -3.4963, SE = 7.3435, p = 0.65884
 CAT_NSAIDs | Seed 7: ATT = 0.9708, SE = 7.1104, p = 0.89800
 CAT_NSAIDs | Seed 8: ATT = -8.1215, SE = 7.0493, p = 0.31345
 CAT_NSAIDs | Seed 9: ATT = -5.2280, SE = 5.8817, p = 0.42430
 CAT_NSAIDs | Seed 10: ATT = -1.9005, SE = 9.4774, p = 0.85085
 Diagnostic plots saved for CAT_NSAIDs
 Best result for CAT_NSAIDs  Seed 9 | SE = 5.8817

 Running OLS for CAT_Benzodiazepine
 CAT_Benzodiazepine | Seed 1: ATT = 1.5091, SE = 0.9870, p = 0.20100
 CAT_Benzodiazepine | Seed 2: ATT = 1.0167, SE = 1.6003, p = 0.55975
 CAT_Benzodiazepine | Seed 3: ATT = 1.0736, SE = 1.1273, p = 0.39483
 CAT_Benzodiazepine | Seed 4: ATT = 0.9334, SE = 1.1768, p = 0.47208
 CAT_Benzodiazepine | Seed 5: ATT = 1.2678, SE = 1.2763, p = 0.37676
 CAT_Benzodiazepine | Seed 6: ATT = 0.6155, SE = 1.2824, p = 0.65631
 CAT_Benzodiazepine | Seed 7: ATT = 0.9700, SE = 1.3386, p = 0.50879
 CAT_Benzodiazepine | Seed 8: ATT = 0.5778, SE = 1.4120, p = 0.70333
 CAT_Benzodiazepine | Seed 9: ATT = 1.4036, SE = 1.2957, p = 0.33962
 CAT_Benzodiazepine | Seed 10: ATT = 1.9171, SE = 1.4012, p = 0.24307
 Diagnostic plots saved for CAT_Benzodiazepine
 Best result for CAT_Benzodiazepine  Seed 1 | SE = 0.9870

 Running OLS for CAT_Antihypertensiva
 CAT_Antihypertensiva | Seed 1: ATT = 0.6450, SE = 8.8973, p = 0.94569
 CAT_Antihypertensiva | Seed 2: ATT = 4.8985, SE = 5.2041, p = 0.39986
 CAT_Antihypertensiva | Seed 3: ATT = 1.8370, SE = 5.7236, p = 0.76431
 CAT_Antihypertensiva | Seed 4: ATT = -1.3299, SE = 4.9545, p = 0.80164
 CAT_Antihypertensiva | Seed 5: ATT = -1.6827, SE = 8.1739, p = 0.84695
 CAT_Antihypertensiva | Seed 6: ATT = -1.2178, SE = 6.9573, p = 0.86955
 CAT_Antihypertensiva | Seed 7: ATT = 1.2332, SE = 7.5808, p = 0.87867
 CAT_Antihypertensiva | Seed 8: ATT = 1.4916, SE = 6.0337, p = 0.81692
 CAT_Antihypertensiva | Seed 9: ATT = -2.4365, SE = 6.7421, p = 0.73609
 CAT_Antihypertensiva | Seed 10: ATT = 0.8974, SE = 7.1372, p = 0.90600
 Diagnostic plots saved for CAT_Antihypertensiva
 Best result for CAT_Antihypertensiva  Seed 4 | SE = 4.9545

 Running OLS for CAT_Antihistaminica
 CAT_Antihistaminica | Seed 1: ATT = 4.2477, SE = 5.9296, p = 0.51337
 CAT_Antihistaminica | Seed 2: ATT = 2.6100, SE = 5.4271, p = 0.65570
 CAT_Antihistaminica | Seed 3: ATT = 4.5370, SE = 4.6262, p = 0.38226
 CAT_Antihistaminica | Seed 4: ATT = 2.7854, SE = 4.5665, p = 0.57484
 CAT_Antihistaminica | Seed 5: ATT = 6.7092, SE = 6.4402, p = 0.35634
 CAT_Antihistaminica | Seed 6: ATT = 3.8065, SE = 5.0956, p = 0.49657
 CAT_Antihistaminica | Seed 7: ATT = 0.7275, SE = 5.2567, p = 0.89661
 CAT_Antihistaminica | Seed 8: ATT = 2.6282, SE = 5.2009, p = 0.63990
 CAT_Antihistaminica | Seed 9: ATT = 2.3122, SE = 7.1649, p = 0.76307
 CAT_Antihistaminica | Seed 10: ATT = 3.7702, SE = 4.4615, p = 0.44567
 Diagnostic plots saved for CAT_Antihistaminica
 Best result for CAT_Antihistaminica  Seed 10 | SE = 4.4615

 Running OLS for CAT_Anti_epileptica
 CAT_Anti_epileptica | Seed 1: ATT = 4.2509, SE = 4.2763, p = 0.37646
 CAT_Anti_epileptica | Seed 2: ATT = 4.9216, SE = 3.5516, p = 0.23808
 CAT_Anti_epileptica | Seed 3: ATT = 5.9294, SE = 4.4070, p = 0.24969
 CAT_Anti_epileptica | Seed 4: ATT = 5.8176, SE = 5.2034, p = 0.32617
 CAT_Anti_epileptica | Seed 5: ATT = 5.9474, SE = 3.1433, p = 0.13143
 CAT_Anti_epileptica | Seed 6: ATT = 7.0798, SE = 4.4433, p = 0.18629
 CAT_Anti_epileptica | Seed 7: ATT = 5.3288, SE = 3.6890, p = 0.22211
 CAT_Anti_epileptica | Seed 8: ATT = 6.0822, SE = 3.9659, p = 0.19991
 CAT_Anti_epileptica | Seed 9: ATT = 5.2901, SE = 2.8291, p = 0.13484
 CAT_Anti_epileptica | Seed 10: ATT = 3.5347, SE = 3.7795, p = 0.40261
 Diagnostic plots saved for CAT_Anti_epileptica
 Best result for CAT_Anti_epileptica  Seed 9 | SE = 2.8291

 Running OLS for CAT_Antidepressiva
 CAT_Antidepressiva | Seed 1: ATT = 0.6549, SE = 0.7111, p = 0.40924
 CAT_Antidepressiva | Seed 2: ATT = 1.1262, SE = 1.0048, p = 0.32510
 CAT_Antidepressiva | Seed 3: ATT = 1.2191, SE = 1.2372, p = 0.38023
 CAT_Antidepressiva | Seed 4: ATT = 0.5422, SE = 1.2407, p = 0.68464
 CAT_Antidepressiva | Seed 5: ATT = 1.1236, SE = 0.7998, p = 0.23274
 CAT_Antidepressiva | Seed 6: ATT = 0.8411, SE = 0.7861, p = 0.34489
 CAT_Antidepressiva | Seed 7: ATT = 1.2725, SE = 0.8333, p = 0.20145
 CAT_Antidepressiva | Seed 8: ATT = 0.8750, SE = 0.7859, p = 0.32791
 CAT_Antidepressiva | Seed 9: ATT = 1.1545, SE = 0.7986, p = 0.22182
 CAT_Antidepressiva | Seed 10: ATT = 1.5842, SE = 0.9788, p = 0.18086
 Diagnostic plots saved for CAT_Antidepressiva
 Best result for CAT_Antidepressiva  Seed 1 | SE = 0.7111

 Running OLS for CAT_Antipsychotica
 CAT_Antipsychotica | Seed 1: ATT = 1.2385, SE = 1.5067, p = 0.45725
 CAT_Antipsychotica | Seed 2: ATT = 2.2315, SE = 1.4236, p = 0.19206
 CAT_Antipsychotica | Seed 3: ATT = 2.1980, SE = 1.1960, p = 0.13994
 CAT_Antipsychotica | Seed 4: ATT = 2.0843, SE = 1.9261, p = 0.34007
 CAT_Antipsychotica | Seed 5: ATT = 2.6614, SE = 2.1630, p = 0.28595
 CAT_Antipsychotica | Seed 6: ATT = 1.3491, SE = 1.4291, p = 0.39861
 CAT_Antipsychotica | Seed 7: ATT = 1.7779, SE = 1.3276, p = 0.25154
 CAT_Antipsychotica | Seed 8: ATT = 2.5474, SE = 2.4616, p = 0.35920
 CAT_Antipsychotica | Seed 9: ATT = 2.0266, SE = 2.0567, p = 0.38024
 CAT_Antipsychotica | Seed 10: ATT = 1.5249, SE = 1.8564, p = 0.45754
 Diagnostic plots saved for CAT_Antipsychotica
 Best result for CAT_Antipsychotica  Seed 3 | SE = 1.1960

 Running OLS for CAT_ALL_PSYCHOTROPICS_EXCL_BENZO
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 1: ATT = 1.5200, SE = 0.7950, p = 0.12847
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 2: ATT = 1.7677, SE = 1.0916, p = 0.18069
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 3: ATT = 1.7991, SE = 1.1224, p = 0.18423
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 4: ATT = 1.5653, SE = 0.8373, p = 0.13493
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 5: ATT = 1.8810, SE = 0.8550, p = 0.09265
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 6: ATT = 1.9707, SE = 0.8923, p = 0.09177
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 7: ATT = 1.5271, SE = 0.7572, p = 0.11393
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 8: ATT = 1.5620, SE = 0.8343, p = 0.13447
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 9: ATT = 1.6017, SE = 1.1791, p = 0.24590
 CAT_ALL_PSYCHOTROPICS_EXCL_BENZO | Seed 10: ATT = 1.5587, SE = 1.0668, p = 0.21777
 Diagnostic plots saved for CAT_ALL_PSYCHOTROPICS_EXCL_BENZO
 Best result for CAT_ALL_PSYCHOTROPICS_EXCL_BENZO  Seed 7 | SE = 0.7572

 Running OLS for CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 1: ATT = 1.8726, SE = 1.1399, p = 0.17578
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 2: ATT = 1.3208, SE = 1.0163, p = 0.26358
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 3: ATT = 1.7783, SE = 0.7958, p = 0.08916
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 4: ATT = 1.5569, SE = 0.8055, p = 0.12540
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 5: ATT = 1.9906, SE = 0.7638, p = 0.05965
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 6: ATT = 1.6622, SE = 0.7230, p = 0.08302
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 7: ATT = 1.2438, SE = 0.9422, p = 0.25729
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 8: ATT = 1.6433, SE = 1.2625, p = 0.26296
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 9: ATT = 1.8436, SE = 0.8545, p = 0.09717
 CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS | Seed 10: ATT = 1.3570, SE = 0.9965, p = 0.24492
 Diagnostic plots saved for CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS
 Best result for CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS  Seed 6 | SE = 0.7230

 Running OLS for CAT_ALL_PSYCHOTROPICS
 CAT_ALL_PSYCHOTROPICS | Seed 1: ATT = 2.5486, SE = 0.6561, p = 0.01778
 CAT_ALL_PSYCHOTROPICS | Seed 2: ATT = 2.0259, SE = 0.9169, p = 0.09166
 CAT_ALL_PSYCHOTROPICS | Seed 3: ATT = 2.6001, SE = 0.6942, p = 0.02003
 CAT_ALL_PSYCHOTROPICS | Seed 4: ATT = 2.0357, SE = 0.7480, p = 0.05290
 CAT_ALL_PSYCHOTROPICS | Seed 5: ATT = 2.1731, SE = 0.6480, p = 0.02848
 CAT_ALL_PSYCHOTROPICS | Seed 6: ATT = 2.2232, SE = 1.0012, p = 0.09057
 CAT_ALL_PSYCHOTROPICS | Seed 7: ATT = 2.3756, SE = 0.8146, p = 0.04340
 CAT_ALL_PSYCHOTROPICS | Seed 8: ATT = 2.0080, SE = 0.9903, p = 0.11250
 CAT_ALL_PSYCHOTROPICS | Seed 9: ATT = 2.9438, SE = 0.8370, p = 0.02452
 CAT_ALL_PSYCHOTROPICS | Seed 10: ATT = 2.1550, SE = 0.6563, p = 0.03040
 Diagnostic plots saved for CAT_ALL_PSYCHOTROPICS
 Best result for CAT_ALL_PSYCHOTROPICS  Seed 5 | SE = 0.6480

 Running OLS for CAT_ALL
 CAT_ALL | Seed 1: ATT = 2.4103, SE = 0.8579, p = 0.04834
 CAT_ALL | Seed 2: ATT = 2.5950, SE = 0.5891, p = 0.01165
 CAT_ALL | Seed 3: ATT = 2.7852, SE = 0.8240, p = 0.02778
 CAT_ALL | Seed 4: ATT = 2.3153, SE = 0.7133, p = 0.03150
 CAT_ALL | Seed 5: ATT = 2.8674, SE = 1.0873, p = 0.05776
 CAT_ALL | Seed 6: ATT = 2.7560, SE = 0.6394, p = 0.01254
 CAT_ALL | Seed 7: ATT = 2.5181, SE = 0.7003, p = 0.02284
 CAT_ALL | Seed 8: ATT = 2.8622, SE = 0.6927, p = 0.01447
 CAT_ALL | Seed 9: ATT = 2.8696, SE = 0.9629, p = 0.04073
 CAT_ALL | Seed 10: ATT = 2.4701, SE = 0.8080, p = 0.03777
 Diagnostic plots saved for CAT_ALL
 Best result for CAT_ALL  Seed 2 | SE = 0.5891

 All summary files saved.
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=fc4dc9d3-d7a4-48e4-9c44-8c3e1c375a6e">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[226]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">sem</span><span class="p">,</span> <span class="n">ttest_ind</span>

<span class="c1"># ----------------------------------</span>
<span class="c1"># File paths</span>
<span class="c1"># ----------------------------------</span>
<span class="n">output_base</span> <span class="o">=</span> <span class="s2">"outputs"</span>
<span class="n">att_file</span> <span class="o">=</span> <span class="s2">"ols_rubin_summary_cats.xlsx"</span>
<span class="n">trimmed_file</span> <span class="o">=</span> <span class="s2">"trimmed_data_imp1.pkl"</span>
<span class="n">auc_file</span> <span class="o">=</span> <span class="s2">"auc_scores.xlsx"</span>  <span class="c1"># NEW</span>

<span class="c1"># ----------------------------------</span>
<span class="c1"># Load ATT Summary</span>
<span class="c1"># ----------------------------------</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">att_file</span><span class="p">):</span>
    <span class="n">att_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">att_file</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">" ATT summary file not found: ols_rubin_summary_cats.xlsx"</span><span class="p">)</span>

<span class="n">summary_rows</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># ----------------------------------</span>
<span class="c1"># Loop over medication groups</span>
<span class="c1"># ----------------------------------</span>
<span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">medication_groups</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">g</span><span class="p">))]</span>

<span class="k">for</span> <span class="n">med</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">group_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">med</span><span class="p">)</span>

        <span class="c1"># Load trimmed data</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="n">trimmed_file</span><span class="p">))</span>

        <span class="c1"># Detect treatment column</span>
        <span class="n">treatment_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">med</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">treatment_cols</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Treatment column </span><span class="si">{</span><span class="n">med</span><span class="si">}</span><span class="s2"> not found in trimmed data. Skipping."</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">treatment_var</span> <span class="o">=</span> <span class="n">treatment_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Extract treatment and outcome</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">"caps5_change_baseline"</span><span class="p">]</span>

        <span class="c1"># Treated and control stats</span>
        <span class="n">treated</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">control</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>

        <span class="n">mean_treat</span> <span class="o">=</span> <span class="n">treated</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">se_treat</span> <span class="o">=</span> <span class="n">sem</span><span class="p">(</span><span class="n">treated</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">treated</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">mean_ctrl</span> <span class="o">=</span> <span class="n">control</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">se_ctrl</span> <span class="o">=</span> <span class="n">sem</span><span class="p">(</span><span class="n">control</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">control</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Cohen's d (unadjusted)</span>
        <span class="n">pooled_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">treated</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">control</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">cohen_d</span> <span class="o">=</span> <span class="p">(</span><span class="n">mean_treat</span> <span class="o">-</span> <span class="n">mean_ctrl</span><span class="p">)</span> <span class="o">/</span> <span class="n">pooled_sd</span> <span class="k">if</span> <span class="n">pooled_sd</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># E-value (unadjusted)</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">mean_treat</span> <span class="o">-</span> <span class="n">mean_ctrl</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">delta</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">mean_ctrl</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">mean_ctrl</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Unadjusted p-value</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">t_stat</span><span class="p">,</span> <span class="n">p_val</span> <span class="o">=</span> <span class="n">ttest_ind</span><span class="p">(</span><span class="n">treated</span><span class="p">,</span> <span class="n">control</span><span class="p">,</span> <span class="n">equal_var</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nan_policy</span><span class="o">=</span><span class="s2">"omit"</span><span class="p">)</span>
            <span class="n">rounded_p</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">p_val</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="n">formatted_p</span> <span class="o">=</span> <span class="s2">"&lt; 0.00001"</span> <span class="k">if</span> <span class="n">rounded_p</span> <span class="o">&lt;</span> <span class="mf">0.00001</span> <span class="k">else</span> <span class="n">rounded_p</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">formatted_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># AUC from new auc_scores.xlsx file</span>
        <span class="n">auc_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">auc_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="n">auc_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">auc_path</span><span class="p">):</span>
            <span class="n">auc_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">auc_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">"AUC"</span> <span class="ow">in</span> <span class="n">auc_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">auc_val</span> <span class="o">=</span> <span class="n">auc_df</span><span class="p">[</span><span class="s2">"AUC"</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="c1"># Adjusted stats from Rubin summary</span>
        <span class="n">att_row</span> <span class="o">=</span> <span class="n">att_df</span><span class="p">[</span><span class="n">att_df</span><span class="p">[</span><span class="s2">"group"</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">med</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">att_row</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">att</span> <span class="o">=</span> <span class="n">att_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"att"</span><span class="p">]</span>
            <span class="n">att_se</span> <span class="o">=</span> <span class="n">att_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"se"</span><span class="p">]</span>
            <span class="n">att_p_val</span> <span class="o">=</span> <span class="n">att_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"p_value"</span><span class="p">]</span>
            <span class="n">r2</span> <span class="o">=</span> <span class="n">att_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"r2"</span><span class="p">]</span>
            <span class="n">rmse</span> <span class="o">=</span> <span class="n">att_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"rmse"</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">rounded_att_p</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">att_p_val</span><span class="p">),</span> <span class="mi">5</span><span class="p">)</span>
                <span class="n">formatted_att_p</span> <span class="o">=</span> <span class="s2">"&lt; 0.00001"</span> <span class="k">if</span> <span class="n">rounded_att_p</span> <span class="o">&lt;</span> <span class="mf">0.00001</span> <span class="k">else</span> <span class="n">rounded_att_p</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">formatted_att_p</span> <span class="o">=</span> <span class="n">att_p_val</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">att</span><span class="p">,</span> <span class="n">att_se</span><span class="p">,</span> <span class="n">formatted_att_p</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Append full row</span>
        <span class="n">summary_rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">'Medication Group'</span><span class="p">:</span> <span class="n">med</span><span class="p">,</span>
            <span class="s1">'Mean Treated'</span><span class="p">:</span> <span class="n">mean_treat</span><span class="p">,</span>
            <span class="s1">'SE Treated'</span><span class="p">:</span> <span class="n">se_treat</span><span class="p">,</span>
            <span class="s1">'Mean Control'</span><span class="p">:</span> <span class="n">mean_ctrl</span><span class="p">,</span>
            <span class="s1">'SE Control'</span><span class="p">:</span> <span class="n">se_ctrl</span><span class="p">,</span>
            <span class="s1">'Cohen d'</span><span class="p">:</span> <span class="n">cohen_d</span><span class="p">,</span>
            <span class="s1">'E (Unadjusted)'</span><span class="p">:</span> <span class="n">E</span><span class="p">,</span>
            <span class="s1">'n Treated'</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">treated</span><span class="p">),</span>
            <span class="s1">'n Control'</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">control</span><span class="p">),</span>
            <span class="c1">#'Unadjusted p-value': formatted_p,</span>
            <span class="s1">'ATT Estimate'</span><span class="p">:</span> <span class="n">att</span><span class="p">,</span>
            <span class="s1">'ATT SE (Robust)'</span><span class="p">:</span> <span class="n">att_se</span><span class="p">,</span>
            <span class="s1">'ATT p-value'</span><span class="p">:</span> <span class="n">formatted_att_p</span><span class="p">,</span>
            <span class="s1">'R'</span><span class="p">:</span> <span class="n">r2</span><span class="p">,</span>
            <span class="s1">'RMSE'</span><span class="p">:</span> <span class="n">rmse</span><span class="p">,</span>
            <span class="s1">'AUC'</span><span class="p">:</span> <span class="n">auc_val</span>
        <span class="p">})</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error in </span><span class="si">{</span><span class="n">med</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># ----------------------------------</span>
<span class="c1"># Save final summary</span>
<span class="c1"># ----------------------------------</span>
<span class="n">summary_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">summary_rows</span><span class="p">)</span>
<span class="n">summary_df</span> <span class="o">=</span> <span class="n">summary_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">"Medication Group"</span><span class="p">)</span>
<span class="n">summary_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">"Final_ATT_Summary_Cat.xlsx"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">" Final_ATT_Summary_Cat saved"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre> Final_ATT_Summary_Cat saved
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=98d3f0ff-8ebf-4379-b380-afb212a49f8f">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[227]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.backends.backend_pdf</span> <span class="kn">import</span> <span class="n">PdfPages</span>

<span class="c1">#  Load the final summary table</span>
<span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s2">"Final_ATT_Summary_Cat.xlsx"</span><span class="p">)</span>

<span class="c1">#  Parse DML p-values (handle "&lt; 0.00001")</span>
<span class="k">def</span> <span class="nf">parse_pval</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">"&lt;"</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.000001</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

<span class="n">final_df</span><span class="p">[</span><span class="s1">'ATT p-value'</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="s1">'ATT p-value'</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">parse_pval</span><span class="p">)</span>

<span class="c1">#  Plot settings</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>

<span class="c1">#  Plotting function for a single medication group</span>
<span class="k">def</span> <span class="nf">plot_single_group</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    
    <span class="n">bars1</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="o">-</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">'Mean Control'</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> 
                   <span class="n">yerr</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">'SE Control'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">'Control'</span><span class="p">,</span> <span class="n">hatch</span><span class="o">=</span><span class="s1">'//'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">bars2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="o">+</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">'Mean Treated'</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> 
                   <span class="n">yerr</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">'SE Treated'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">'Treated'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'steelblue'</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

    <span class="n">label</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">"ATT = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'ATT Estimate'</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span>
        <span class="sa">f</span><span class="s2">"d = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'Cohen d'</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, p = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'ATT p-value'</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span>
        <span class="sa">f</span><span class="s2">"nT = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'n Treated'</span><span class="p">]</span><span class="si">}</span><span class="s2">, nC = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'n Control'</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span>
        <span class="sa">f</span><span class="s2">"E = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'E (Unadjusted)'</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%"</span>
    <span class="p">)</span>
    <span class="n">max_y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">'Mean Control'</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">'Mean Treated'</span><span class="p">])</span> <span class="o">+</span> <span class="mf">1.5</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_y</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">'center'</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">'bottom'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'#FFD700'</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'black'</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="o">-</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">+</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">'Control'</span><span class="p">,</span> <span class="s1">'Treated'</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Group: </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'Medication Group'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">'bold'</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"CAPS5 Change Score"</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="n">max_y</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">fig</span>

<span class="c1">#  Generate and save all plots into a multi-page PDF</span>
<span class="k">with</span> <span class="n">PdfPages</span><span class="p">(</span><span class="s2">"ols_att_barplot_cat.pdf"</span><span class="p">)</span> <span class="k">as</span> <span class="n">pdf</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">final_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_single_group</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="n">pdf</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">'tight'</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">" ols_att_barplot_cat saved"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre> ols_att_barplot_cat saved
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=a3e741d8-2d5c-4c48-997c-a50d1f651061">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[228]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Love plot:</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=47b4d0de-9bff-4bf7-a497-ead963faa064">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[229]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="c1"># ----------------------------------------</span>
<span class="c1"># Functions to calculate balance</span>
<span class="c1"># ----------------------------------------</span>
<span class="k">def</span> <span class="nf">calculate_smd</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">w1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">w2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">weighted_mean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span> <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">weighted_var</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">m</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
    
    <span class="n">m1</span> <span class="o">=</span> <span class="n">weighted_mean</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">w1</span><span class="p">)</span> <span class="k">if</span> <span class="n">w1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
    <span class="n">m2</span> <span class="o">=</span> <span class="n">weighted_mean</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span> <span class="k">if</span> <span class="n">w2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">weighted_var</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">w1</span><span class="p">)</span> <span class="k">if</span> <span class="n">w1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">weighted_var</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span> <span class="k">if</span> <span class="n">w2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">pooled_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">v1</span> <span class="o">+</span> <span class="n">v2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">m1</span> <span class="o">-</span> <span class="n">m2</span><span class="p">)</span> <span class="o">/</span> <span class="n">pooled_sd</span> <span class="k">if</span> <span class="n">pooled_sd</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">variance_ratio</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">w1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">w2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">weighted_var</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">m</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
    
    <span class="n">v1</span> <span class="o">=</span> <span class="n">weighted_var</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">w1</span><span class="p">)</span> <span class="k">if</span> <span class="n">w1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">weighted_var</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span> <span class="k">if</span> <span class="n">w2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">v1</span> <span class="o">/</span> <span class="n">v2</span><span class="p">,</span> <span class="n">v2</span> <span class="o">/</span> <span class="n">v1</span><span class="p">)</span> <span class="k">if</span> <span class="n">v1</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">v2</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>

<span class="c1"># ----------------------------------------</span>
<span class="c1"># Setup</span>
<span class="c1"># ----------------------------------------</span>
<span class="n">output_base</span> <span class="o">=</span> <span class="s2">"outputs"</span>
<span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">output_base</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">g</span><span class="p">))]</span>

<span class="c1"># Create a case-insensitive mapping</span>
<span class="n">final_covariates_map_lower</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="c1"># ----------------------------------------</span>
<span class="c1"># Main Loop</span>
<span class="c1"># ----------------------------------------</span>
<span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">group</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_covariates_map_lower</span><span class="p">:</span>
        <span class="k">continue</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Processing </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">..."</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">group_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">covariates</span> <span class="o">=</span> <span class="n">final_covariates_map_lower</span><span class="p">[</span><span class="n">group</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        
        <span class="n">column_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="s2">"trimmed_data_imp1.pkl"</span><span class="p">))</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">group</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">column_name</span> <span class="o">=</span> <span class="n">col</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">column_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Column not found for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">, skipping."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">smd_unw_all</span><span class="p">,</span> <span class="n">smd_w_all</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">vr_unw_all</span><span class="p">,</span> <span class="n">vr_w_all</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
            <span class="n">df_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"trimmed_data_imp</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.pkl"</span><span class="p">)</span>
            <span class="n">iptw_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="s2">"iptw_weights.xlsx"</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">df_path</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">iptw_path</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Missing data for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> imp</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, skipping."</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">df_path</span><span class="p">)</span>
            <span class="n">iptw_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">iptw_path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span>
            <span class="n">W</span> <span class="o">=</span> <span class="n">iptw_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s2">"iptw_mean"</span><span class="p">]</span>

            <span class="n">smd_unw_i</span><span class="p">,</span> <span class="n">smd_w_i</span><span class="p">,</span> <span class="n">vr_unw_i</span><span class="p">,</span> <span class="n">vr_w_i</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">cov</span> <span class="ow">in</span> <span class="n">covariates</span><span class="p">:</span>
                <span class="n">x1</span><span class="p">,</span> <span class="n">x0</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cov</span><span class="p">],</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cov</span><span class="p">]</span>
                <span class="n">w1</span><span class="p">,</span> <span class="n">w0</span> <span class="o">=</span> <span class="n">W</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">],</span> <span class="n">W</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>

                <span class="n">su</span> <span class="o">=</span> <span class="n">calculate_smd</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x0</span><span class="p">)</span>
                <span class="n">sw</span> <span class="o">=</span> <span class="n">calculate_smd</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">w0</span><span class="p">)</span>

                <span class="n">vu</span> <span class="o">=</span> <span class="n">variance_ratio</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x0</span><span class="p">)</span> <span class="k">if</span> <span class="n">cov</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">]</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">vw</span> <span class="o">=</span> <span class="n">variance_ratio</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">w0</span><span class="p">)</span> <span class="k">if</span> <span class="n">cov</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">]</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

                <span class="n">smd_unw_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">su</span><span class="p">)</span>
                <span class="n">smd_w_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sw</span><span class="p">)</span>
                <span class="n">vr_unw_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vu</span><span class="p">)</span>
                <span class="n">vr_w_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vw</span><span class="p">)</span>

            <span class="n">smd_unw_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smd_unw_i</span><span class="p">)</span>
            <span class="n">smd_w_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smd_w_i</span><span class="p">)</span>
            <span class="n">vr_unw_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vr_unw_i</span><span class="p">)</span>
            <span class="n">vr_w_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vr_w_i</span><span class="p">)</span>

        <span class="n">smd_unw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">smd_unw_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">smd_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">smd_w_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">vr_unw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">vr_unw_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">vr_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">vr_w_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">severity</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sw</span> <span class="ow">in</span> <span class="n">smd_w</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sw</span> <span class="o">&lt;=</span> <span class="mf">0.1</span><span class="p">:</span>
                <span class="n">severity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"Good"</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">sw</span> <span class="o">&lt;=</span> <span class="mf">0.2</span><span class="p">:</span>
                <span class="n">severity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"Moderate"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">severity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"Poor"</span><span class="p">)</span>

        <span class="n">covariate_names</span> <span class="o">=</span> <span class="n">covariates</span>
        <span class="n">numeric_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s2">"Covariate"</span><span class="p">:</span> <span class="n">covariate_names</span><span class="p">,</span>
            <span class="s2">"SMD_Unweighted"</span><span class="p">:</span> <span class="n">smd_unw</span><span class="p">,</span>
            <span class="s2">"SMD_Weighted"</span><span class="p">:</span> <span class="n">smd_w</span><span class="p">,</span>
            <span class="s2">"Imbalance_Severity"</span><span class="p">:</span> <span class="n">severity</span><span class="p">,</span>
            <span class="s2">"VR_Unweighted"</span><span class="p">:</span> <span class="n">vr_unw</span><span class="p">,</span>
            <span class="s2">"VR_Weighted"</span><span class="p">:</span> <span class="n">vr_w</span>
        <span class="p">})</span>

        <span class="n">numeric_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"covariate_balance_table_</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">.xlsx"</span><span class="p">)</span>
        <span class="n">numeric_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">numeric_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Exported numeric summary to: </span><span class="si">{</span><span class="n">numeric_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># -------------------------</span>
        <span class="c1"># Plot</span>
        <span class="c1"># -------------------------</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">covariates</span>
        <span class="n">y_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.45</span><span class="p">))</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">smd_unw</span><span class="p">,</span> <span class="n">y_pos</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Unweighted"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">smd_w</span><span class="p">,</span> <span class="n">y_pos</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'blue'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Weighted"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Threshold 0.1"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'black'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Threshold 0.2"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">smd_unw</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">smd_w</span><span class="p">),</span> <span class="mf">0.25</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">y_pos</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Standardized Mean Differences (SMD)"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">"upper right"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">vr_mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">cov</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">]</span> <span class="k">for</span> <span class="n">cov</span> <span class="ow">in</span> <span class="n">covariates</span><span class="p">]</span>
        <span class="n">filtered_y</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vr_mask</span><span class="p">)</span> <span class="k">if</span> <span class="n">b</span><span class="p">]</span>
        <span class="n">filtered_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">filtered_y</span><span class="p">]</span>
        <span class="n">filtered_vr_unw</span> <span class="o">=</span> <span class="p">[</span><span class="n">vr_unw</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">filtered_y</span><span class="p">]</span>
        <span class="n">filtered_vr_w</span> <span class="o">=</span> <span class="p">[</span><span class="n">vr_w</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">filtered_y</span><span class="p">]</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">filtered_vr_unw</span><span class="p">,</span> <span class="n">filtered_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'blue'</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">'o'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Unweighted"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">filtered_vr_w</span><span class="p">,</span> <span class="n">filtered_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">'x'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Weighted"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">filtered_vr_unw</span> <span class="o">+</span> <span class="n">filtered_vr_w</span> <span class="o">+</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">])</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">filtered_y</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">filtered_labels</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Variance Ratio (VR)"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Covariate Balance for </span><span class="si">{</span><span class="n">group</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'CAT_'</span><span class="p">,</span><span class="w"> </span><span class="s1">''</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">'bold'</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.96</span><span class="p">])</span>
        <span class="n">plot_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"love_plot_</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">.pdf"</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Saved love plot: </span><span class="si">{</span><span class="n">plot_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Max weighted SMD for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">smd_w</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Processing CAT_Aceetanilidederivaten...
 Exported numeric summary to: outputs\CAT_Aceetanilidederivaten\covariate_balance_table_CAT_Aceetanilidederivaten.xlsx
 Saved love plot: outputs\CAT_Aceetanilidederivaten\love_plot_CAT_Aceetanilidederivaten.pdf
 Max weighted SMD for CAT_Aceetanilidederivaten: 0.599

 Processing CAT_Adhd...
 Exported numeric summary to: outputs\CAT_Adhd\covariate_balance_table_CAT_Adhd.xlsx
 Saved love plot: outputs\CAT_Adhd\love_plot_CAT_Adhd.pdf
 Max weighted SMD for CAT_Adhd: 0.520

 Processing CAT_All...
 Exported numeric summary to: outputs\CAT_All\covariate_balance_table_CAT_All.xlsx
 Saved love plot: outputs\CAT_All\love_plot_CAT_All.pdf
 Max weighted SMD for CAT_All: 0.076

 Processing CAT_All_Psychotropics...
 Exported numeric summary to: outputs\CAT_All_Psychotropics\covariate_balance_table_CAT_All_Psychotropics.xlsx
 Saved love plot: outputs\CAT_All_Psychotropics\love_plot_CAT_All_Psychotropics.pdf
 Max weighted SMD for CAT_All_Psychotropics: 0.121

 Processing CAT_All_Psychotropics_Excl_Benzo...
 Exported numeric summary to: outputs\CAT_All_Psychotropics_Excl_Benzo\covariate_balance_table_CAT_All_Psychotropics_Excl_Benzo.xlsx
 Saved love plot: outputs\CAT_All_Psychotropics_Excl_Benzo\love_plot_CAT_All_Psychotropics_Excl_Benzo.pdf
 Max weighted SMD for CAT_All_Psychotropics_Excl_Benzo: 0.157

 Processing CAT_All_Psychotropics_Excl_Sedatives_Hypnotics...
 Exported numeric summary to: outputs\CAT_All_Psychotropics_Excl_Sedatives_Hypnotics\covariate_balance_table_CAT_All_Psychotropics_Excl_Sedatives_Hypnotics.xlsx
 Saved love plot: outputs\CAT_All_Psychotropics_Excl_Sedatives_Hypnotics\love_plot_CAT_All_Psychotropics_Excl_Sedatives_Hypnotics.pdf
 Max weighted SMD for CAT_All_Psychotropics_Excl_Sedatives_Hypnotics: 0.158

 Processing CAT_Antidepressiva...
 Exported numeric summary to: outputs\CAT_Antidepressiva\covariate_balance_table_CAT_Antidepressiva.xlsx
 Saved love plot: outputs\CAT_Antidepressiva\love_plot_CAT_Antidepressiva.pdf
 Max weighted SMD for CAT_Antidepressiva: 0.205

 Processing CAT_Antihistaminica...
 Exported numeric summary to: outputs\CAT_Antihistaminica\covariate_balance_table_CAT_Antihistaminica.xlsx
 Saved love plot: outputs\CAT_Antihistaminica\love_plot_CAT_Antihistaminica.pdf
 Max weighted SMD for CAT_Antihistaminica: 0.535

 Processing CAT_Antihypertensiva...
 Exported numeric summary to: outputs\CAT_Antihypertensiva\covariate_balance_table_CAT_Antihypertensiva.xlsx
 Saved love plot: outputs\CAT_Antihypertensiva\love_plot_CAT_Antihypertensiva.pdf
 Max weighted SMD for CAT_Antihypertensiva: 0.629

 Processing CAT_Antipsychotica...
 Exported numeric summary to: outputs\CAT_Antipsychotica\covariate_balance_table_CAT_Antipsychotica.xlsx
 Saved love plot: outputs\CAT_Antipsychotica\love_plot_CAT_Antipsychotica.pdf
 Max weighted SMD for CAT_Antipsychotica: 0.145

 Processing CAT_Anti_Epileptica...
 Exported numeric summary to: outputs\CAT_Anti_Epileptica\covariate_balance_table_CAT_Anti_Epileptica.xlsx
 Saved love plot: outputs\CAT_Anti_Epileptica\love_plot_CAT_Anti_Epileptica.pdf
 Max weighted SMD for CAT_Anti_Epileptica: 0.194

 Processing CAT_Benzodiazepine...
 Exported numeric summary to: outputs\CAT_Benzodiazepine\covariate_balance_table_CAT_Benzodiazepine.xlsx
 Saved love plot: outputs\CAT_Benzodiazepine\love_plot_CAT_Benzodiazepine.pdf
 Max weighted SMD for CAT_Benzodiazepine: 0.126

 Processing CAT_Nsaids...
 Exported numeric summary to: outputs\CAT_Nsaids\covariate_balance_table_CAT_Nsaids.xlsx
 Saved love plot: outputs\CAT_Nsaids\love_plot_CAT_Nsaids.pdf
 Max weighted SMD for CAT_Nsaids: 0.647

 Processing CAT_Opioden...
 Exported numeric summary to: outputs\CAT_Opioden\covariate_balance_table_CAT_Opioden.xlsx
 Saved love plot: outputs\CAT_Opioden\love_plot_CAT_Opioden.pdf
 Max weighted SMD for CAT_Opioden: 0.315

 Processing CAT_Z_Drugs...
 Exported numeric summary to: outputs\CAT_Z_Drugs\covariate_balance_table_CAT_Z_Drugs.xlsx
 Saved love plot: outputs\CAT_Z_Drugs\love_plot_CAT_Z_Drugs.pdf
 Max weighted SMD for CAT_Z_Drugs: 0.259
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=70cac837-729f-49b1-b10d-d0ef9c0992a7">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[230]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Heatmap:</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=fbcc8601-6f31-421d-bdf4-6da70b6d6101">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[231]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="c1">#-----------------------------</span>
<span class="c1"># Generate heatmaps</span>
<span class="c1"># -------------------------------</span>
<span class="k">for</span> <span class="n">treatment_var</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">========== Creating Heatmap for </span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s2"> =========="</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">'outputs'</span><span class="p">,</span> <span class="n">treatment_var</span><span class="p">)</span>
        <span class="n">balance_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'covariate_balance_table_</span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s1">.xlsx'</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">balance_path</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Balance file not found: </span><span class="si">{</span><span class="n">balance_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">balance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">balance_path</span><span class="p">)</span>

        <span class="c1">#  Use finalized covariates + 'Propensity Score'</span>
        <span class="n">covariates</span> <span class="o">=</span> <span class="n">final_covariates_map</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">'Propensity Score'</span><span class="p">]</span>
        <span class="n">balance_df</span> <span class="o">=</span> <span class="n">balance_df</span><span class="p">[</span><span class="n">balance_df</span><span class="p">[</span><span class="s1">'Covariate'</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">covariates</span><span class="p">)]</span>

        <span class="c1">#  Check for CAPS5score_baseline</span>
        <span class="n">highlight_caps</span> <span class="o">=</span> <span class="s1">'CAPS5score_baseline'</span> <span class="ow">in</span> <span class="n">balance_df</span><span class="p">[</span><span class="s1">'Covariate'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="c1">#  Format for heatmap</span>
        <span class="n">heatmap_df</span> <span class="o">=</span> <span class="n">balance_df</span><span class="p">[[</span><span class="s1">'Covariate'</span><span class="p">,</span> <span class="s1">'SMD_Unweighted'</span><span class="p">,</span> <span class="s1">'SMD_Weighted'</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">heatmap_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'Covariate'</span><span class="p">,</span> <span class="s1">'Unweighted'</span><span class="p">,</span> <span class="s1">'Weighted'</span><span class="p">]</span>
        <span class="n">heatmap_df</span> <span class="o">=</span> <span class="n">heatmap_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">'Covariate'</span><span class="p">)</span>
        <span class="n">heatmap_df</span> <span class="o">=</span> <span class="n">heatmap_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">'Unweighted'</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1">#  Plot</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">heatmap_df</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.35</span><span class="p">)))</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span>
            <span class="n">heatmap_df</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="s2">"coolwarm"</span><span class="p">,</span>
            <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">fmt</span><span class="o">=</span><span class="s2">".2f"</span><span class="p">,</span>
            <span class="n">linewidths</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
            <span class="n">linecolor</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span>
            <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">"label"</span><span class="p">:</span> <span class="s2">"Standardized Mean Difference"</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Covariate Balance Heatmap (Rubin IPTW)</span><span class="se">\n</span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">'bold'</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Condition"</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"Covariate"</span><span class="p">)</span>

        <span class="c1">#  Bold CAPS5score_baseline if present</span>
        <span class="k">if</span> <span class="n">highlight_caps</span><span class="p">:</span>
            <span class="n">ylabels</span> <span class="o">=</span> <span class="p">[</span><span class="n">label</span><span class="o">.</span><span class="n">get_text</span><span class="p">()</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span>
                <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2"> "</span> <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="s1">'CAPS5score_baseline'</span> <span class="k">else</span> <span class="n">label</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ylabels</span>
            <span class="p">])</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="c1">#  Save image</span>
        <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'heatmap_smd_</span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s1">.png'</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Heatmap saved: </span><span class="si">{</span><span class="n">save_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error processing </span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
========== Creating Heatmap for CAT_ADHD ==========
 Heatmap saved: outputs\CAT_ADHD\heatmap_smd_CAT_ADHD.png

========== Creating Heatmap for CAT_Aceetanilidederivaten ==========
 Heatmap saved: outputs\CAT_Aceetanilidederivaten\heatmap_smd_CAT_Aceetanilidederivaten.png

========== Creating Heatmap for CAT_Z_drugs ==========
 Heatmap saved: outputs\CAT_Z_drugs\heatmap_smd_CAT_Z_drugs.png

========== Creating Heatmap for CAT_Opioden ==========
 Heatmap saved: outputs\CAT_Opioden\heatmap_smd_CAT_Opioden.png

========== Creating Heatmap for CAT_NSAIDs ==========
 Heatmap saved: outputs\CAT_NSAIDs\heatmap_smd_CAT_NSAIDs.png

========== Creating Heatmap for CAT_Benzodiazepine ==========
 Heatmap saved: outputs\CAT_Benzodiazepine\heatmap_smd_CAT_Benzodiazepine.png

========== Creating Heatmap for CAT_Antihypertensiva ==========
 Heatmap saved: outputs\CAT_Antihypertensiva\heatmap_smd_CAT_Antihypertensiva.png

========== Creating Heatmap for CAT_Antihistaminica ==========
 Heatmap saved: outputs\CAT_Antihistaminica\heatmap_smd_CAT_Antihistaminica.png

========== Creating Heatmap for CAT_Anti_epileptica ==========
 Heatmap saved: outputs\CAT_Anti_epileptica\heatmap_smd_CAT_Anti_epileptica.png

========== Creating Heatmap for CAT_Antidepressiva ==========
 Heatmap saved: outputs\CAT_Antidepressiva\heatmap_smd_CAT_Antidepressiva.png

========== Creating Heatmap for CAT_Antipsychotica ==========
 Heatmap saved: outputs\CAT_Antipsychotica\heatmap_smd_CAT_Antipsychotica.png

========== Creating Heatmap for CAT_ALL_PSYCHOTROPICS_EXCL_BENZO ==========
 Heatmap saved: outputs\CAT_ALL_PSYCHOTROPICS_EXCL_BENZO\heatmap_smd_CAT_ALL_PSYCHOTROPICS_EXCL_BENZO.png

========== Creating Heatmap for CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS ==========
 Heatmap saved: outputs\CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS\heatmap_smd_CAT_ALL_PSYCHOTROPICS_EXCL_SEDATIVES_HYPNOTICS.png

========== Creating Heatmap for CAT_ALL_PSYCHOTROPICS ==========
 Heatmap saved: outputs\CAT_ALL_PSYCHOTROPICS\heatmap_smd_CAT_ALL_PSYCHOTROPICS.png

========== Creating Heatmap for CAT_ALL ==========
 Heatmap saved: outputs\CAT_ALL\heatmap_smd_CAT_ALL.png
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=8f20d353-a1a6-41d1-a07e-d83cd907131e">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Subcat-analysis:">Subcat analysis:<a class="anchor-link" href="#Subcat-analysis:"></a></h3>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=74cf789e-8d11-46b8-9fc6-4c93ac6375d4">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[232]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">covariates_SUBCAT_Antipsychotica_atypisch</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span> <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SUBCAT_TCA</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SUBCAT_SSRI</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SUBCAT_SNRI</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_SUBCAT_Tetracyclische_antidepressiva</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SUBCAT_Antidepressiva_overige</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SUBCAT_Systemische_antihistaminica</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span> <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_SUBCAT_anxiolytica_Benzodiazepine</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SUBCAT_hypnotica_Benzodiazepine</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_SUBCAT_Amfetaminen</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span> <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span>
    <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_SUBCAT_Paracetamol_mono</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span> <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_SUBCAT_Anti_epileptica_stemmingsstabilisatoren</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span> 
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SUBCAT_Opioden</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SUBCAT_Z_drugs</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span> <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SUBCAT_NSAIDs</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=0a20737a-265c-405f-ad41-e29a7dca8e23">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[233]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="c1"># This finds all variables that start with covariates_SUBCAT_</span>
<span class="n">final_covariates_map</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<span class="n">final_covariates_map</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
    <span class="n">var</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"covariates_"</span><span class="p">,</span> <span class="s2">""</span><span class="p">):</span> <span class="n">val</span>
    <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"covariates_subcat_"</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
<span class="p">})</span>

<span class="c1"># Show detected group names</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Groups found:"</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
<span class="n">medication_groups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">medication_groups</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Groups found: ['SUBCAT_Antipsychotica_atypisch', 'SUBCAT_TCA', 'SUBCAT_SSRI', 'SUBCAT_SNRI', 'SUBCAT_Tetracyclische_antidepressiva', 'SUBCAT_Antidepressiva_overige', 'SUBCAT_Systemische_antihistaminica', 'SUBCAT_anxiolytica_Benzodiazepine', 'SUBCAT_hypnotica_Benzodiazepine', 'SUBCAT_Amfetaminen', 'SUBCAT_Paracetamol_mono', 'SUBCAT_Anti_epileptica_stemmingsstabilisatoren', 'SUBCAT_Opioden', 'SUBCAT_Z_drugs', 'SUBCAT_NSAIDs']
['SUBCAT_Antipsychotica_atypisch', 'SUBCAT_TCA', 'SUBCAT_SSRI', 'SUBCAT_SNRI', 'SUBCAT_Tetracyclische_antidepressiva', 'SUBCAT_Antidepressiva_overige', 'SUBCAT_Systemische_antihistaminica', 'SUBCAT_anxiolytica_Benzodiazepine', 'SUBCAT_hypnotica_Benzodiazepine', 'SUBCAT_Amfetaminen', 'SUBCAT_Paracetamol_mono', 'SUBCAT_Anti_epileptica_stemmingsstabilisatoren', 'SUBCAT_Opioden', 'SUBCAT_Z_drugs', 'SUBCAT_NSAIDs']
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=0c5d1b8a-3cb1-4a30-af1a-a414bccd3b5d">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[234]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>


<span class="k">def</span> <span class="nf">run_all_SUBCAT_group_models</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Runs downstream analysis for each SUBCAT medisubcation group using imputed datasets.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - imputed_dfs: list of 5 imputed DataFrames (from df_imputed_final_imp1.pkl ... imp5.pkl)</span>
<span class="sd">    </span>
<span class="sd">    Notes:</span>
<span class="sd">    - Covariate lists must be defined as global variables: covariates_subcat_&lt;group&gt;</span>
<span class="sd">    - Outputs are saved in: outputs/SUBCAT_&lt;GROUP&gt;/</span>
<span class="sd">    """</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">" Starting analysis for all SUBCAT groups"</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">var_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"covariates_subcat_"</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">globals</span><span class="p">()[</span><span class="n">var_name</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">group_name</span> <span class="o">=</span> <span class="n">var_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"covariates_"</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
            <span class="n">group_name</span> <span class="o">=</span> <span class="n">group_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"_"</span><span class="p">,</span> <span class="s2">" "</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">" "</span><span class="p">,</span> <span class="s2">"_"</span><span class="p">)</span>  <span class="c1"># e.g., subcat_z_drugs  Subcat_Z_Drugs</span>
            <span class="n">group_name</span> <span class="o">=</span> <span class="n">group_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"Subcat_"</span><span class="p">,</span> <span class="s2">"SUBCAT_"</span><span class="p">)</span>  <span class="c1"># force prefix to uppercase</span>

            <span class="n">covariates</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()[</span><span class="n">var_name</span><span class="p">]</span>
            <span class="n">output_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"outputs/</span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">"</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Processing </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">..."</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">df_imp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   Using imputation </span><span class="si">{</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

                <span class="c1"># Define X and Y</span>
                <span class="n">X</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span>
                <span class="n">Y</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="s2">"caps5_change_baseline"</span><span class="p">]</span>

                <span class="c1"># === Save X and Y as placeholder (replace with modeling later)</span>
                <span class="n">X</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/X_imp</span><span class="si">{</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.csv"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">Y</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"Y"</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/Y_imp</span><span class="si">{</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.csv"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Done: </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> All SUBCAT group analyses complete."</span><span class="p">)</span>

<span class="c1"># ========= STEP 4: Execute ========= #</span>
<span class="n">run_all_SUBCAT_group_models</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre> Starting analysis for all SUBCAT groups

 Processing SUBCAT_Antipsychotica_Atypisch...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBCAT_Antipsychotica_Atypisch

 Processing SUBCAT_Tca...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBCAT_Tca

 Processing SUBCAT_Ssri...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBCAT_Ssri

 Processing SUBCAT_Snri...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBCAT_Snri

 Processing SUBCAT_Tetracyclische_Antidepressiva...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBCAT_Tetracyclische_Antidepressiva

 Processing SUBCAT_Antidepressiva_Overige...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBCAT_Antidepressiva_Overige

 Processing SUBCAT_Systemische_Antihistaminica...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBCAT_Systemische_Antihistaminica

 Processing SUBCAT_Anxiolytica_Benzodiazepine...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBCAT_Anxiolytica_Benzodiazepine

 Processing SUBCAT_Hypnotica_Benzodiazepine...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBCAT_Hypnotica_Benzodiazepine

 Processing SUBCAT_Amfetaminen...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBCAT_Amfetaminen

 Processing SUBCAT_Paracetamol_Mono...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBCAT_Paracetamol_Mono

 Processing SUBCAT_Anti_Epileptica_Stemmingsstabilisatoren...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBCAT_Anti_Epileptica_Stemmingsstabilisatoren

 Processing SUBCAT_Opioden...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBCAT_Opioden

 Processing SUBCAT_Z_Drugs...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBCAT_Z_Drugs

 Processing SUBCAT_Nsaids...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBCAT_Nsaids

 All SUBCAT group analyses complete.
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=675d93ec-45cf-4e6d-ae5e-c44c514bf83d">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[235]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">treatment_var</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">treatment_var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Imp </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">:  Not found in columns."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">treated</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">control</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Imp </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: Treated = </span><span class="si">{</span><span class="n">treated</span><span class="si">}</span><span class="s2">, Control = </span><span class="si">{</span><span class="n">control</span><span class="si">}</span><span class="s2">, Missing = </span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 SUBCAT_Antipsychotica_atypisch
  Imp 1: Treated = 256, Control = 3385, Missing = 0
  Imp 2: Treated = 256, Control = 3385, Missing = 0
  Imp 3: Treated = 256, Control = 3385, Missing = 0
  Imp 4: Treated = 256, Control = 3385, Missing = 0
  Imp 5: Treated = 256, Control = 3385, Missing = 0

 SUBCAT_TCA
  Imp 1: Treated = 86, Control = 3555, Missing = 0
  Imp 2: Treated = 86, Control = 3555, Missing = 0
  Imp 3: Treated = 86, Control = 3555, Missing = 0
  Imp 4: Treated = 86, Control = 3555, Missing = 0
  Imp 5: Treated = 86, Control = 3555, Missing = 0

 SUBCAT_SSRI
  Imp 1: Treated = 396, Control = 3245, Missing = 0
  Imp 2: Treated = 396, Control = 3245, Missing = 0
  Imp 3: Treated = 396, Control = 3245, Missing = 0
  Imp 4: Treated = 396, Control = 3245, Missing = 0
  Imp 5: Treated = 396, Control = 3245, Missing = 0

 SUBCAT_SNRI
  Imp 1: Treated = 82, Control = 3559, Missing = 0
  Imp 2: Treated = 82, Control = 3559, Missing = 0
  Imp 3: Treated = 82, Control = 3559, Missing = 0
  Imp 4: Treated = 82, Control = 3559, Missing = 0
  Imp 5: Treated = 82, Control = 3559, Missing = 0

 SUBCAT_Tetracyclische_antidepressiva
  Imp 1: Treated = 87, Control = 3554, Missing = 0
  Imp 2: Treated = 87, Control = 3554, Missing = 0
  Imp 3: Treated = 87, Control = 3554, Missing = 0
  Imp 4: Treated = 87, Control = 3554, Missing = 0
  Imp 5: Treated = 87, Control = 3554, Missing = 0

 SUBCAT_Antidepressiva_overige
  Imp 1: Treated = 42, Control = 3599, Missing = 0
  Imp 2: Treated = 42, Control = 3599, Missing = 0
  Imp 3: Treated = 42, Control = 3599, Missing = 0
  Imp 4: Treated = 42, Control = 3599, Missing = 0
  Imp 5: Treated = 42, Control = 3599, Missing = 0

 SUBCAT_Systemische_antihistaminica
  Imp 1: Treated = 56, Control = 3585, Missing = 0
  Imp 2: Treated = 56, Control = 3585, Missing = 0
  Imp 3: Treated = 56, Control = 3585, Missing = 0
  Imp 4: Treated = 56, Control = 3585, Missing = 0
  Imp 5: Treated = 56, Control = 3585, Missing = 0

 SUBCAT_anxiolytica_Benzodiazepine
  Imp 1: Treated = 311, Control = 3330, Missing = 0
  Imp 2: Treated = 311, Control = 3330, Missing = 0
  Imp 3: Treated = 311, Control = 3330, Missing = 0
  Imp 4: Treated = 311, Control = 3330, Missing = 0
  Imp 5: Treated = 311, Control = 3330, Missing = 0

 SUBCAT_hypnotica_Benzodiazepine
  Imp 1: Treated = 132, Control = 3509, Missing = 0
  Imp 2: Treated = 132, Control = 3509, Missing = 0
  Imp 3: Treated = 132, Control = 3509, Missing = 0
  Imp 4: Treated = 132, Control = 3509, Missing = 0
  Imp 5: Treated = 132, Control = 3509, Missing = 0

 SUBCAT_Amfetaminen
  Imp 1: Treated = 52, Control = 3589, Missing = 0
  Imp 2: Treated = 52, Control = 3589, Missing = 0
  Imp 3: Treated = 52, Control = 3589, Missing = 0
  Imp 4: Treated = 52, Control = 3589, Missing = 0
  Imp 5: Treated = 52, Control = 3589, Missing = 0

 SUBCAT_Paracetamol_mono
  Imp 1: Treated = 43, Control = 3598, Missing = 0
  Imp 2: Treated = 43, Control = 3598, Missing = 0
  Imp 3: Treated = 43, Control = 3598, Missing = 0
  Imp 4: Treated = 43, Control = 3598, Missing = 0
  Imp 5: Treated = 43, Control = 3598, Missing = 0

 SUBCAT_Anti_epileptica_stemmingsstabilisatoren
  Imp 1: Treated = 57, Control = 3584, Missing = 0
  Imp 2: Treated = 57, Control = 3584, Missing = 0
  Imp 3: Treated = 57, Control = 3584, Missing = 0
  Imp 4: Treated = 57, Control = 3584, Missing = 0
  Imp 5: Treated = 57, Control = 3584, Missing = 0

 SUBCAT_Opioden
  Imp 1: Treated = 54, Control = 3587, Missing = 0
  Imp 2: Treated = 54, Control = 3587, Missing = 0
  Imp 3: Treated = 54, Control = 3587, Missing = 0
  Imp 4: Treated = 54, Control = 3587, Missing = 0
  Imp 5: Treated = 54, Control = 3587, Missing = 0

 SUBCAT_Z_drugs
  Imp 1: Treated = 57, Control = 3584, Missing = 0
  Imp 2: Treated = 57, Control = 3584, Missing = 0
  Imp 3: Treated = 57, Control = 3584, Missing = 0
  Imp 4: Treated = 57, Control = 3584, Missing = 0
  Imp 5: Treated = 57, Control = 3584, Missing = 0

 SUBCAT_NSAIDs
  Imp 1: Treated = 37, Control = 3604, Missing = 0
  Imp 2: Treated = 37, Control = 3604, Missing = 0
  Imp 3: Treated = 37, Control = 3604, Missing = 0
  Imp 4: Treated = 37, Control = 3604, Missing = 0
  Imp 5: Treated = 37, Control = 3604, Missing = 0
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=56242839-e5b1-4303-b947-ddf075afb59d">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[236]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">from</span> <span class="nn">statsmodels.stats.outliers_influence</span> <span class="kn">import</span> <span class="n">variance_inflation_factor</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="c1">#  VIF computation function</span>
<span class="k">def</span> <span class="nf">compute_vif</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">has_constant</span><span class="o">=</span><span class="s1">'add'</span><span class="p">)</span>
    <span class="n">vif_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">vif_df</span><span class="p">[</span><span class="s2">"variable"</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span>
    <span class="n">vif_df</span><span class="p">[</span><span class="s2">"VIF"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">variance_inflation_factor</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
    <span class="k">return</span> <span class="n">vif_df</span>

<span class="c1">#  Process each group</span>
<span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Processing VIF for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  No covariates found for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
        <span class="k">continue</span>

    <span class="n">covariates</span> <span class="o">=</span> <span class="n">final_covariates_map</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
    <span class="n">vif_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df_imp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">vif_df</span> <span class="o">=</span> <span class="n">compute_vif</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="n">vif_df</span><span class="p">[</span><span class="s2">"imputation"</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">vif_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vif_df</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"    Failed on imputation </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">vif_list</span><span class="p">:</span>
        <span class="n">all_vif</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">vif_list</span><span class="p">)</span>
        <span class="n">pooled_vif</span> <span class="o">=</span> <span class="n">all_vif</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">"variable"</span><span class="p">)[</span><span class="s2">"VIF"</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">pooled_vif</span> <span class="o">=</span> <span class="n">pooled_vif</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">"VIF"</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"outputs"</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">pooled_vif</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"pooled_vif.csv"</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Saved: </span><span class="si">{</span><span class="n">output_folder</span><span class="si">}</span><span class="s2">/pooled_vif.csv"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Skipped </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: No valid imputations."</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Processing VIF for SUBCAT_Antipsychotica_atypisch
  Saved: outputs\SUBCAT_Antipsychotica_atypisch/pooled_vif.csv

 Processing VIF for SUBCAT_TCA
  Saved: outputs\SUBCAT_TCA/pooled_vif.csv

 Processing VIF for SUBCAT_SSRI
  Saved: outputs\SUBCAT_SSRI/pooled_vif.csv

 Processing VIF for SUBCAT_SNRI
  Saved: outputs\SUBCAT_SNRI/pooled_vif.csv

 Processing VIF for SUBCAT_Tetracyclische_antidepressiva
  Saved: outputs\SUBCAT_Tetracyclische_antidepressiva/pooled_vif.csv

 Processing VIF for SUBCAT_Antidepressiva_overige
  Saved: outputs\SUBCAT_Antidepressiva_overige/pooled_vif.csv

 Processing VIF for SUBCAT_Systemische_antihistaminica
  Saved: outputs\SUBCAT_Systemische_antihistaminica/pooled_vif.csv

 Processing VIF for SUBCAT_anxiolytica_Benzodiazepine
  Saved: outputs\SUBCAT_anxiolytica_Benzodiazepine/pooled_vif.csv

 Processing VIF for SUBCAT_hypnotica_Benzodiazepine
  Saved: outputs\SUBCAT_hypnotica_Benzodiazepine/pooled_vif.csv

 Processing VIF for SUBCAT_Amfetaminen
  Saved: outputs\SUBCAT_Amfetaminen/pooled_vif.csv

 Processing VIF for SUBCAT_Paracetamol_mono
  Saved: outputs\SUBCAT_Paracetamol_mono/pooled_vif.csv

 Processing VIF for SUBCAT_Anti_epileptica_stemmingsstabilisatoren
  Saved: outputs\SUBCAT_Anti_epileptica_stemmingsstabilisatoren/pooled_vif.csv

 Processing VIF for SUBCAT_Opioden
  Saved: outputs\SUBCAT_Opioden/pooled_vif.csv

 Processing VIF for SUBCAT_Z_drugs
  Saved: outputs\SUBCAT_Z_drugs/pooled_vif.csv

 Processing VIF for SUBCAT_NSAIDs
  Saved: outputs\SUBCAT_NSAIDs/pooled_vif.csv
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=ca4774b3-375f-4f4f-af16-075947427200">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[237]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">roc_curve</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>

<span class="c1"># ---------- PS Estimation Function ----------</span>
<span class="k">def</span> <span class="nf">run_logistic_ps_modeling</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Running PS estimation for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No covariates found for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"outputs"</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">covariates</span> <span class="o">=</span> <span class="n">final_covariates_map</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
        <span class="n">ps_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">auc_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df_imp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_imp</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> not found in imputed dataset </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">X</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>

            <span class="c1"># Drop missing treatment rows</span>
            <span class="n">valid_idx</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">index</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>

            <span class="c1"># Train-test split for ROC</span>
            <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">T_train</span><span class="p">,</span> <span class="n">T_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
                <span class="n">X</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
            <span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
                <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">T_train</span><span class="p">)</span>

                <span class="n">ps_scores</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">ps_matrix</span><span class="p">[</span><span class="sa">f</span><span class="s2">"ps_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">ps_scores</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">valid_idx</span><span class="p">)</span>

                <span class="c1"># ROC &amp; AUC</span>
                <span class="n">auc</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">T_test</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">auc_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">auc</span><span class="p">)</span>

                <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">T_test</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">"AUC = </span><span class="si">{</span><span class="n">auc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'k--'</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"False Positive Rate"</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"True Positive Rate"</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"ROC Curve - </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> (Imp </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">)"</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"roc_curve_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.png"</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   Imp </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: AUC = </span><span class="si">{</span><span class="n">auc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, ROC saved."</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> (imp </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Save AUCs and Composite PS</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ps_matrix</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="c1"># Fill NaN rows (from dropped subjects in some imputations) with mean</span>
            <span class="n">ps_matrix</span><span class="p">[</span><span class="s2">"composite_ps"</span><span class="p">]</span> <span class="o">=</span> <span class="n">ps_matrix</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ps_matrix</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"propensity_scores.xlsx"</span><span class="p">))</span>

            <span class="n">auc_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s2">"imputation"</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">"imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">auc_list</span><span class="p">))],</span>
                <span class="s2">"AUC"</span><span class="p">:</span> <span class="n">auc_list</span>
            <span class="p">})</span>
            <span class="n">auc_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">auc_df</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"mean"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">auc_list</span><span class="p">)</span> <span class="k">if</span> <span class="n">auc_list</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span>
            <span class="n">auc_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"auc_scores.xlsx"</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Composite PS + AUC saved for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No valid PS scores generated for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># ---------- Run ----------</span>
<span class="n">run_logistic_ps_modeling</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre> Running PS estimation for SUBCAT_Antipsychotica_atypisch
   Imp 1: AUC = 0.998, ROC saved.
   Imp 2: AUC = 0.998, ROC saved.
   Imp 3: AUC = 0.998, ROC saved.
   Imp 4: AUC = 0.998, ROC saved.
   Imp 5: AUC = 0.998, ROC saved.
 Composite PS + AUC saved for SUBCAT_Antipsychotica_atypisch
 Running PS estimation for SUBCAT_TCA
   Imp 1: AUC = 0.717, ROC saved.
   Imp 2: AUC = 0.716, ROC saved.
   Imp 3: AUC = 0.717, ROC saved.
   Imp 4: AUC = 0.713, ROC saved.
   Imp 5: AUC = 0.713, ROC saved.
 Composite PS + AUC saved for SUBCAT_TCA
 Running PS estimation for SUBCAT_SSRI
   Imp 1: AUC = 0.769, ROC saved.
   Imp 2: AUC = 0.770, ROC saved.
   Imp 3: AUC = 0.768, ROC saved.
   Imp 4: AUC = 0.770, ROC saved.
   Imp 5: AUC = 0.767, ROC saved.
 Composite PS + AUC saved for SUBCAT_SSRI
 Running PS estimation for SUBCAT_SNRI
   Imp 1: AUC = 0.654, ROC saved.
   Imp 2: AUC = 0.621, ROC saved.
   Imp 3: AUC = 0.636, ROC saved.
   Imp 4: AUC = 0.612, ROC saved.
   Imp 5: AUC = 0.634, ROC saved.
 Composite PS + AUC saved for SUBCAT_SNRI
 Running PS estimation for SUBCAT_Tetracyclische_antidepressiva
   Imp 1: AUC = 0.681, ROC saved.
   Imp 2: AUC = 0.698, ROC saved.
   Imp 3: AUC = 0.682, ROC saved.
   Imp 4: AUC = 0.688, ROC saved.
   Imp 5: AUC = 0.699, ROC saved.
 Composite PS + AUC saved for SUBCAT_Tetracyclische_antidepressiva
 Running PS estimation for SUBCAT_Antidepressiva_overige
   Imp 1: AUC = 0.561, ROC saved.
   Imp 2: AUC = 0.646, ROC saved.
   Imp 3: AUC = 0.629, ROC saved.
   Imp 4: AUC = 0.601, ROC saved.
   Imp 5: AUC = 0.632, ROC saved.
 Composite PS + AUC saved for SUBCAT_Antidepressiva_overige
 Running PS estimation for SUBCAT_Systemische_antihistaminica
   Imp 1: AUC = 0.681, ROC saved.
   Imp 2: AUC = 0.682, ROC saved.
   Imp 3: AUC = 0.668, ROC saved.
   Imp 4: AUC = 0.677, ROC saved.
   Imp 5: AUC = 0.681, ROC saved.
 Composite PS + AUC saved for SUBCAT_Systemische_antihistaminica
 Running PS estimation for SUBCAT_anxiolytica_Benzodiazepine
   Imp 1: AUC = 0.783, ROC saved.
   Imp 2: AUC = 0.782, ROC saved.
   Imp 3: AUC = 0.784, ROC saved.
   Imp 4: AUC = 0.783, ROC saved.
   Imp 5: AUC = 0.778, ROC saved.
 Composite PS + AUC saved for SUBCAT_anxiolytica_Benzodiazepine
 Running PS estimation for SUBCAT_hypnotica_Benzodiazepine
   Imp 1: AUC = 0.711, ROC saved.
   Imp 2: AUC = 0.714, ROC saved.
   Imp 3: AUC = 0.741, ROC saved.
   Imp 4: AUC = 0.740, ROC saved.
   Imp 5: AUC = 0.727, ROC saved.
 Composite PS + AUC saved for SUBCAT_hypnotica_Benzodiazepine
 Running PS estimation for SUBCAT_Amfetaminen
   Imp 1: AUC = 0.616, ROC saved.
   Imp 2: AUC = 0.619, ROC saved.
   Imp 3: AUC = 0.592, ROC saved.
   Imp 4: AUC = 0.620, ROC saved.
   Imp 5: AUC = 0.626, ROC saved.
 Composite PS + AUC saved for SUBCAT_Amfetaminen
 Running PS estimation for SUBCAT_Paracetamol_mono
   Imp 1: AUC = 0.735, ROC saved.
   Imp 2: AUC = 0.744, ROC saved.
   Imp 3: AUC = 0.737, ROC saved.
   Imp 4: AUC = 0.748, ROC saved.
   Imp 5: AUC = 0.752, ROC saved.
 Composite PS + AUC saved for SUBCAT_Paracetamol_mono
 Running PS estimation for SUBCAT_Anti_epileptica_stemmingsstabilisatoren
   Imp 1: AUC = 0.767, ROC saved.
   Imp 2: AUC = 0.783, ROC saved.
   Imp 3: AUC = 0.777, ROC saved.
   Imp 4: AUC = 0.781, ROC saved.
   Imp 5: AUC = 0.784, ROC saved.
 Composite PS + AUC saved for SUBCAT_Anti_epileptica_stemmingsstabilisatoren
 Running PS estimation for SUBCAT_Opioden
   Imp 1: AUC = 0.788, ROC saved.
   Imp 2: AUC = 0.787, ROC saved.
   Imp 3: AUC = 0.788, ROC saved.
   Imp 4: AUC = 0.789, ROC saved.
   Imp 5: AUC = 0.777, ROC saved.
 Composite PS + AUC saved for SUBCAT_Opioden
 Running PS estimation for SUBCAT_Z_drugs
   Imp 1: AUC = 0.639, ROC saved.
   Imp 2: AUC = 0.659, ROC saved.
   Imp 3: AUC = 0.649, ROC saved.
   Imp 4: AUC = 0.645, ROC saved.
   Imp 5: AUC = 0.645, ROC saved.
 Composite PS + AUC saved for SUBCAT_Z_drugs
 Running PS estimation for SUBCAT_NSAIDs
   Imp 1: AUC = 0.748, ROC saved.
   Imp 2: AUC = 0.738, ROC saved.
   Imp 3: AUC = 0.717, ROC saved.
   Imp 4: AUC = 0.767, ROC saved.
   Imp 5: AUC = 0.757, ROC saved.
 Composite PS + AUC saved for SUBCAT_NSAIDs
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=38f7f379-7ca4-4f21-8cdc-767c8814a4ca">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[238]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>

<span class="k">def</span> <span class="nf">compute_feature_importance</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Computing feature importance for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No covariates found for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">covariates</span> <span class="o">=</span> <span class="n">final_covariates_map</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
        <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"outputs"</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">importance_df_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df_imp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_imp</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> not in imputed dataset </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">X</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>

            <span class="c1"># Drop NaNs in treatment</span>
            <span class="n">valid_idx</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">index</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
                <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>

                <span class="c1"># Get feature importance (absolute coefficients)</span>
                <span class="n">importances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">importance_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">importances</span><span class="p">))</span>
                <span class="n">df_feat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">importance_dict</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">'index'</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">"imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">])</span>
                <span class="n">df_feat</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">'feature'</span>
                <span class="n">importance_df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_feat</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   Error during modeling: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">importance_df_list</span><span class="p">:</span>
            <span class="c1"># Combine and average</span>
            <span class="n">all_feat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">importance_df_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">all_feat</span><span class="p">[</span><span class="s2">"mean_importance"</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_feat</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Filter top 30 non-zero</span>
            <span class="n">non_zero</span> <span class="o">=</span> <span class="n">all_feat</span><span class="p">[</span><span class="n">all_feat</span><span class="p">[</span><span class="s2">"mean_importance"</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">top30</span> <span class="o">=</span> <span class="n">non_zero</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">"mean_importance"</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>

            <span class="c1"># Save to CSV</span>
            <span class="n">top30</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"feature_importance.csv"</span><span class="p">))</span>

            <span class="c1"># Plot</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top30</span><span class="o">.</span><span class="n">index</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">top30</span><span class="p">[</span><span class="s2">"mean_importance"</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># plot top  bottom</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Mean Gain Importance"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Top 30 Feature Importance - </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"feature_importance_top30.png"</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Saved feature importance plot and CSV for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No valid models for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1">#  Run</span>
<span class="n">compute_feature_importance</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Computing feature importance for SUBCAT_Antipsychotica_atypisch
 Saved feature importance plot and CSV for SUBCAT_Antipsychotica_atypisch

 Computing feature importance for SUBCAT_TCA
 Saved feature importance plot and CSV for SUBCAT_TCA

 Computing feature importance for SUBCAT_SSRI
 Saved feature importance plot and CSV for SUBCAT_SSRI

 Computing feature importance for SUBCAT_SNRI
 Saved feature importance plot and CSV for SUBCAT_SNRI

 Computing feature importance for SUBCAT_Tetracyclische_antidepressiva
 Saved feature importance plot and CSV for SUBCAT_Tetracyclische_antidepressiva

 Computing feature importance for SUBCAT_Antidepressiva_overige
 Saved feature importance plot and CSV for SUBCAT_Antidepressiva_overige

 Computing feature importance for SUBCAT_Systemische_antihistaminica
 Saved feature importance plot and CSV for SUBCAT_Systemische_antihistaminica

 Computing feature importance for SUBCAT_anxiolytica_Benzodiazepine
 Saved feature importance plot and CSV for SUBCAT_anxiolytica_Benzodiazepine

 Computing feature importance for SUBCAT_hypnotica_Benzodiazepine
 Saved feature importance plot and CSV for SUBCAT_hypnotica_Benzodiazepine

 Computing feature importance for SUBCAT_Amfetaminen
 Saved feature importance plot and CSV for SUBCAT_Amfetaminen

 Computing feature importance for SUBCAT_Paracetamol_mono
 Saved feature importance plot and CSV for SUBCAT_Paracetamol_mono

 Computing feature importance for SUBCAT_Anti_epileptica_stemmingsstabilisatoren
 Saved feature importance plot and CSV for SUBCAT_Anti_epileptica_stemmingsstabilisatoren

 Computing feature importance for SUBCAT_Opioden
 Saved feature importance plot and CSV for SUBCAT_Opioden

 Computing feature importance for SUBCAT_Z_drugs
 Saved feature importance plot and CSV for SUBCAT_Z_drugs

 Computing feature importance for SUBCAT_NSAIDs
 Saved feature importance plot and CSV for SUBCAT_NSAIDs
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=61c1cc1f-9ec7-402b-a19a-534d28c833ae">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[239]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="k">def</span> <span class="nf">compute_trimmed_clipped_iptw</span><span class="p">(</span><span class="n">ps_df</span><span class="p">,</span> <span class="n">treatment</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">clip_max</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">keep_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">ps_df</span> <span class="o">&gt;</span> <span class="n">lower</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ps_df</span> <span class="o">&lt;</span> <span class="n">upper</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ps_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">ps</span> <span class="o">=</span> <span class="n">ps_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">lower</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">1e-6</span><span class="p">)</span>  <span class="c1"># avoid div by zero</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">keep_mask</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">ps</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="n">w</span><span class="p">[</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">treatment</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">ps</span><span class="p">[</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">treatment</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="n">w</span><span class="p">[</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">treatment</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ps</span><span class="p">[</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">treatment</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)])</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">upper</span><span class="o">=</span><span class="n">clip_max</span><span class="p">)</span>
        <span class="n">weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">apply_rubins_rule_to_iptw</span><span class="p">(</span><span class="n">iptw_matrix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Given an IPTW matrix (n rows  M imputations), return Rubins rule pooled mean, SD, SE.</span>
<span class="sd">    """</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">q_bar</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">u_bar</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">total_var</span> <span class="o">=</span> <span class="n">u_bar</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">M</span><span class="p">)</span> <span class="o">*</span> <span class="n">B</span>
    <span class="n">total_se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">total_var</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">q_bar</span><span class="p">,</span> <span class="n">u_bar</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">total_se</span>


<span class="k">def</span> <span class="nf">run_trim_clip_save_all</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Processing IPTW + trimming + clipping for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"outputs"</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">ps_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"propensity_scores.xlsx"</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ps_path</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Missing PS file: </span><span class="si">{</span><span class="n">ps_path</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ps_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">ps_path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">ps_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">ps_all</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"ps_imp"</span><span class="p">)]</span>
            <span class="n">composite_index</span> <span class="o">=</span> <span class="n">ps_all</span><span class="o">.</span><span class="n">index</span>

            <span class="c1"># Get treatment from one imputed dataset</span>
            <span class="n">T_full</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">imputed_dfs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">T_full</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">composite_index</span><span class="p">,</span> <span class="n">group</span><span class="p">]</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="n">T_full</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Treatment column </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> not found in any imputed dataset."</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Compute IPTW matrix (shape: n  M)</span>
            <span class="n">iptw_matrix</span> <span class="o">=</span> <span class="n">compute_trimmed_clipped_iptw</span><span class="p">(</span><span class="n">ps_all</span><span class="p">[</span><span class="n">ps_cols</span><span class="p">],</span> <span class="n">T_full</span><span class="p">)</span>
            <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">"iptw_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iptw_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>

            <span class="c1"># Apply Rubins Rule for mean, SD, SE</span>
            <span class="n">iptw_matrix</span><span class="p">[</span><span class="s2">"iptw_mean"</span><span class="p">],</span> <span class="n">iptw_matrix</span><span class="p">[</span><span class="s2">"iptw_sd"</span><span class="p">],</span> <span class="n">iptw_matrix</span><span class="p">[</span><span class="s2">"iptw_se"</span><span class="p">]</span> <span class="o">=</span> <span class="n">apply_rubins_rule_to_iptw</span><span class="p">(</span>
                <span class="n">iptw_matrix</span><span class="p">[[</span><span class="sa">f</span><span class="s2">"iptw_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iptw_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]]</span>
            <span class="p">)</span>

            <span class="c1"># Save IPTW matrix separately</span>
            <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"iptw_weights.xlsx"</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Saved IPTW weights for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

            <span class="c1"># Save trimmed &amp; clipped imputed datasets with IPTW</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">imputed_dfs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">trimmed_idx</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="n">needed_cols</span> <span class="o">=</span> <span class="n">final_covariates_map</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">group</span><span class="p">,</span> <span class="s2">"caps5_change_baseline"</span><span class="p">]</span>

                <span class="c1"># Select only necessary columns</span>
                <span class="n">df_trimmed</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">trimmed_idx</span><span class="p">,</span> <span class="n">needed_cols</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">df_trimmed</span><span class="p">[</span><span class="s2">"iptw"</span><span class="p">]</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="p">[</span><span class="sa">f</span><span class="s2">"iptw_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">trimmed_idx</span><span class="p">]</span>

                <span class="c1">#  DROP rows with missing IPTW values</span>
                <span class="n">before</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_trimmed</span><span class="p">)</span>
                <span class="n">df_trimmed</span> <span class="o">=</span> <span class="n">df_trimmed</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">"iptw"</span><span class="p">])</span>
                <span class="n">after</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_trimmed</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"     Retained </span><span class="si">{</span><span class="n">after</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">before</span><span class="si">}</span><span class="s2"> rows after IPTW NaN drop."</span><span class="p">)</span>

                <span class="c1"># Save to .pkl</span>
                <span class="n">df_trimmed</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"trimmed_data_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.pkl"</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   Saved trimmed dataset: </span><span class="si">{</span><span class="n">output_folder</span><span class="si">}</span><span class="s2">/trimmed_data_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.*"</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>


<span class="n">run_trim_clip_save_all</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Processing IPTW + trimming + clipping for SUBCAT_Antipsychotica_atypisch
 Saved IPTW weights for SUBCAT_Antipsychotica_atypisch
     Retained 183/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Antipsychotica_atypisch/trimmed_data_imp1.*
     Retained 185/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Antipsychotica_atypisch/trimmed_data_imp2.*
     Retained 189/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Antipsychotica_atypisch/trimmed_data_imp3.*
     Retained 188/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Antipsychotica_atypisch/trimmed_data_imp4.*
     Retained 187/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Antipsychotica_atypisch/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SUBCAT_TCA
 Saved IPTW weights for SUBCAT_TCA
     Retained 387/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_TCA/trimmed_data_imp1.*
     Retained 392/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_TCA/trimmed_data_imp2.*
     Retained 385/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_TCA/trimmed_data_imp3.*
     Retained 395/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_TCA/trimmed_data_imp4.*
     Retained 401/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_TCA/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SUBCAT_SSRI
 Saved IPTW weights for SUBCAT_SSRI
     Retained 2526/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_SSRI/trimmed_data_imp1.*
     Retained 2512/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_SSRI/trimmed_data_imp2.*
     Retained 2493/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_SSRI/trimmed_data_imp3.*
     Retained 2513/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_SSRI/trimmed_data_imp4.*
     Retained 2503/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_SSRI/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SUBCAT_SNRI
 Saved IPTW weights for SUBCAT_SNRI
     Retained 377/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_SNRI/trimmed_data_imp1.*
     Retained 394/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_SNRI/trimmed_data_imp2.*
     Retained 392/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_SNRI/trimmed_data_imp3.*
     Retained 370/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_SNRI/trimmed_data_imp4.*
     Retained 390/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_SNRI/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SUBCAT_Tetracyclische_antidepressiva
 Saved IPTW weights for SUBCAT_Tetracyclische_antidepressiva
     Retained 409/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Tetracyclische_antidepressiva/trimmed_data_imp1.*
     Retained 419/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Tetracyclische_antidepressiva/trimmed_data_imp2.*
     Retained 406/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Tetracyclische_antidepressiva/trimmed_data_imp3.*
     Retained 417/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Tetracyclische_antidepressiva/trimmed_data_imp4.*
     Retained 410/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Tetracyclische_antidepressiva/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SUBCAT_Antidepressiva_overige
 Saved IPTW weights for SUBCAT_Antidepressiva_overige
     Retained 86/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Antidepressiva_overige/trimmed_data_imp1.*
     Retained 67/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Antidepressiva_overige/trimmed_data_imp2.*
     Retained 77/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Antidepressiva_overige/trimmed_data_imp3.*
     Retained 93/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Antidepressiva_overige/trimmed_data_imp4.*
     Retained 73/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Antidepressiva_overige/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SUBCAT_Systemische_antihistaminica
 Saved IPTW weights for SUBCAT_Systemische_antihistaminica
     Retained 154/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Systemische_antihistaminica/trimmed_data_imp1.*
     Retained 154/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Systemische_antihistaminica/trimmed_data_imp2.*
     Retained 152/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Systemische_antihistaminica/trimmed_data_imp3.*
     Retained 155/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Systemische_antihistaminica/trimmed_data_imp4.*
     Retained 150/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Systemische_antihistaminica/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SUBCAT_anxiolytica_Benzodiazepine
 Saved IPTW weights for SUBCAT_anxiolytica_Benzodiazepine
     Retained 1748/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_anxiolytica_Benzodiazepine/trimmed_data_imp1.*
     Retained 1748/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_anxiolytica_Benzodiazepine/trimmed_data_imp2.*
     Retained 1748/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_anxiolytica_Benzodiazepine/trimmed_data_imp3.*
     Retained 1754/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_anxiolytica_Benzodiazepine/trimmed_data_imp4.*
     Retained 1748/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_anxiolytica_Benzodiazepine/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SUBCAT_hypnotica_Benzodiazepine
 Saved IPTW weights for SUBCAT_hypnotica_Benzodiazepine
     Retained 760/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_hypnotica_Benzodiazepine/trimmed_data_imp1.*
     Retained 773/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_hypnotica_Benzodiazepine/trimmed_data_imp2.*
     Retained 759/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_hypnotica_Benzodiazepine/trimmed_data_imp3.*
     Retained 773/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_hypnotica_Benzodiazepine/trimmed_data_imp4.*
     Retained 772/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_hypnotica_Benzodiazepine/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SUBCAT_Amfetaminen
 Saved IPTW weights for SUBCAT_Amfetaminen
     Retained 60/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Amfetaminen/trimmed_data_imp1.*
     Retained 57/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Amfetaminen/trimmed_data_imp2.*
     Retained 59/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Amfetaminen/trimmed_data_imp3.*
     Retained 87/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Amfetaminen/trimmed_data_imp4.*
     Retained 62/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Amfetaminen/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SUBCAT_Paracetamol_mono
 Saved IPTW weights for SUBCAT_Paracetamol_mono
     Retained 110/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Paracetamol_mono/trimmed_data_imp1.*
     Retained 99/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Paracetamol_mono/trimmed_data_imp2.*
     Retained 98/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Paracetamol_mono/trimmed_data_imp3.*
     Retained 100/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Paracetamol_mono/trimmed_data_imp4.*
     Retained 106/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Paracetamol_mono/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SUBCAT_Anti_epileptica_stemmingsstabilisatoren
 Saved IPTW weights for SUBCAT_Anti_epileptica_stemmingsstabilisatoren
     Retained 241/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Anti_epileptica_stemmingsstabilisatoren/trimmed_data_imp1.*
     Retained 240/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Anti_epileptica_stemmingsstabilisatoren/trimmed_data_imp2.*
     Retained 241/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Anti_epileptica_stemmingsstabilisatoren/trimmed_data_imp3.*
     Retained 243/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Anti_epileptica_stemmingsstabilisatoren/trimmed_data_imp4.*
     Retained 240/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Anti_epileptica_stemmingsstabilisatoren/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SUBCAT_Opioden
 Saved IPTW weights for SUBCAT_Opioden
     Retained 231/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Opioden/trimmed_data_imp1.*
     Retained 231/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Opioden/trimmed_data_imp2.*
     Retained 230/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Opioden/trimmed_data_imp3.*
     Retained 232/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Opioden/trimmed_data_imp4.*
     Retained 233/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Opioden/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SUBCAT_Z_drugs
 Saved IPTW weights for SUBCAT_Z_drugs
     Retained 208/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Z_drugs/trimmed_data_imp1.*
     Retained 210/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Z_drugs/trimmed_data_imp2.*
     Retained 215/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Z_drugs/trimmed_data_imp3.*
     Retained 212/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Z_drugs/trimmed_data_imp4.*
     Retained 210/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_Z_drugs/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SUBCAT_NSAIDs
 Saved IPTW weights for SUBCAT_NSAIDs
     Retained 127/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_NSAIDs/trimmed_data_imp1.*
     Retained 138/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_NSAIDs/trimmed_data_imp2.*
     Retained 139/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_NSAIDs/trimmed_data_imp3.*
     Retained 131/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_NSAIDs/trimmed_data_imp4.*
     Retained 129/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SUBCAT_NSAIDs/trimmed_data_imp5.*
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=2e57891b-20aa-401e-b95e-019da87c3dc5">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[240]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="k">def</span> <span class="nf">plot_ps_overlap_all_groups</span><span class="p">(</span><span class="n">medication_groups</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Plotting PS overlap for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="n">folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"outputs"</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">ps_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">"propensity_scores.xlsx"</span><span class="p">)</span>
        <span class="n">iptw_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">"iptw_weights.xlsx"</span><span class="p">)</span>
        <span class="n">trimmed_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">"trimmed_data_imp1.pkl"</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ps_file</span><span class="p">,</span> <span class="n">iptw_file</span><span class="p">,</span> <span class="n">trimmed_file</span><span class="p">]):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Missing required files for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ps_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">ps_file</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">iptw_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">iptw_file</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">trimmed_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">trimmed_file</span><span class="p">)</span>

            <span class="c1"># Extract</span>
            <span class="n">ps</span> <span class="o">=</span> <span class="n">ps_df</span><span class="p">[</span><span class="s2">"composite_ps"</span><span class="p">]</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">trimmed_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">iptw_df</span><span class="p">[</span><span class="s2">"iptw_mean"</span><span class="p">]</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">trimmed_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">trimmed_df</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>

            <span class="c1"># Masks to remove NaNs</span>
            <span class="n">treated_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ps</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">w</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
            <span class="n">control_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ps</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">w</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>

            <span class="n">treated</span> <span class="o">=</span> <span class="n">ps</span><span class="p">[</span><span class="n">treated_mask</span><span class="p">]</span>
            <span class="n">treated_w</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="n">treated_mask</span><span class="p">]</span>

            <span class="n">control</span> <span class="o">=</span> <span class="n">ps</span><span class="p">[</span><span class="n">control_mask</span><span class="p">]</span>
            <span class="n">control_w</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="n">control_mask</span><span class="p">]</span>

            <span class="c1"># === Unweighted Plot ===</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">([</span><span class="n">treated</span><span class="p">,</span> <span class="n">control</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="p">[</span><span class="s2">"Treated"</span><span class="p">,</span> <span class="s2">"Control"</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Unweighted PS Overlap - </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Composite Propensity Score"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"Count"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">"ps_overlap_unweighted.png"</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="c1"># === Weighted Plot ===</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">([</span><span class="n">treated</span><span class="p">,</span> <span class="n">control</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="p">[</span><span class="n">treated_w</span><span class="p">,</span> <span class="n">control_w</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="p">[</span><span class="s2">"Treated"</span><span class="p">,</span> <span class="s2">"Control"</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Weighted PS Overlap - </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Composite Propensity Score"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"Weighted Count"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">"ps_overlap_weighted.png"</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Saved unweighted and weighted PS plots for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error processing </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1">#  Run</span>
<span class="n">plot_ps_overlap_all_groups</span><span class="p">(</span><span class="n">medication_groups</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Plotting PS overlap for SUBCAT_Antipsychotica_atypisch
 Saved unweighted and weighted PS plots for SUBCAT_Antipsychotica_atypisch

 Plotting PS overlap for SUBCAT_TCA
 Saved unweighted and weighted PS plots for SUBCAT_TCA

 Plotting PS overlap for SUBCAT_SSRI
 Saved unweighted and weighted PS plots for SUBCAT_SSRI

 Plotting PS overlap for SUBCAT_SNRI
 Saved unweighted and weighted PS plots for SUBCAT_SNRI

 Plotting PS overlap for SUBCAT_Tetracyclische_antidepressiva
 Saved unweighted and weighted PS plots for SUBCAT_Tetracyclische_antidepressiva

 Plotting PS overlap for SUBCAT_Antidepressiva_overige
 Saved unweighted and weighted PS plots for SUBCAT_Antidepressiva_overige

 Plotting PS overlap for SUBCAT_Systemische_antihistaminica
 Saved unweighted and weighted PS plots for SUBCAT_Systemische_antihistaminica

 Plotting PS overlap for SUBCAT_anxiolytica_Benzodiazepine
 Saved unweighted and weighted PS plots for SUBCAT_anxiolytica_Benzodiazepine

 Plotting PS overlap for SUBCAT_hypnotica_Benzodiazepine
 Saved unweighted and weighted PS plots for SUBCAT_hypnotica_Benzodiazepine

 Plotting PS overlap for SUBCAT_Amfetaminen
 Saved unweighted and weighted PS plots for SUBCAT_Amfetaminen

 Plotting PS overlap for SUBCAT_Paracetamol_mono
 Saved unweighted and weighted PS plots for SUBCAT_Paracetamol_mono

 Plotting PS overlap for SUBCAT_Anti_epileptica_stemmingsstabilisatoren
 Saved unweighted and weighted PS plots for SUBCAT_Anti_epileptica_stemmingsstabilisatoren

 Plotting PS overlap for SUBCAT_Opioden
 Saved unweighted and weighted PS plots for SUBCAT_Opioden

 Plotting PS overlap for SUBCAT_Z_drugs
 Saved unweighted and weighted PS plots for SUBCAT_Z_drugs

 Plotting PS overlap for SUBCAT_NSAIDs
 Saved unweighted and weighted PS plots for SUBCAT_NSAIDs
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=1ff6b954-c0fd-4644-b88b-4d5e3073188a">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[241]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># Set up base output folder</span>
<span class="n">output_base</span> <span class="o">=</span> <span class="s2">"outputs"</span>
<span class="n">ps_file</span> <span class="o">=</span> <span class="s2">"propensity_scores.xlsx"</span>
<span class="n">iptw_file</span> <span class="o">=</span> <span class="s2">"iptw_weights.xlsx"</span>
<span class="n">trimmed_data_file</span> <span class="o">=</span> <span class="s2">"trimmed_data_imp1.pkl"</span>

<span class="c1"># Collect all treatment group folders</span>
<span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">medication_groups</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">g</span><span class="p">))]</span>


<span class="c1"># Generate 4-panel overlap plots</span>
<span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
    <span class="n">group_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Load trimmed treatment info</span>
        <span class="n">trimmed_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="n">trimmed_data_file</span><span class="p">))</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">trimmed_df</span><span class="o">.</span><span class="n">index</span>

        <span class="c1"># Fix: case-insensitive match for treatment variable</span>
        <span class="n">possible_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">trimmed_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">group</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">possible_cols</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Treatment variable </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> not found in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">, skipping."</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">treatment_var</span> <span class="o">=</span> <span class="n">possible_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">trimmed_df</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span>

        <span class="c1"># Load composite PS (aligned to trimmed_df index)</span>
        <span class="n">ps_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="n">ps_file</span><span class="p">),</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">'composite_ps'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ps_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Composite column missing in </span><span class="si">{</span><span class="n">ps_file</span><span class="si">}</span><span class="s2">, skipping </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">."</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">ps</span> <span class="o">=</span> <span class="n">ps_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s1">'composite_ps'</span><span class="p">]</span>

        <span class="c1"># Load IPTW weights (aligned to trimmed_df index)</span>
        <span class="n">weights_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="n">iptw_file</span><span class="p">),</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">'iptw_mean'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">weights_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" IPTW weight column missing in </span><span class="si">{</span><span class="n">iptw_file</span><span class="si">}</span><span class="s2">, skipping </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">."</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">weights_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s1">'iptw_mean'</span><span class="p">]</span>

        <span class="c1"># Prepare 4 datasets</span>
        <span class="n">raw_treated</span> <span class="o">=</span> <span class="n">ps</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">raw_control</span> <span class="o">=</span> <span class="n">ps</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">weighted_treated</span> <span class="o">=</span> <span class="p">(</span><span class="n">ps</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">],</span> <span class="n">weights</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">weighted_control</span> <span class="o">=</span> <span class="p">(</span><span class="n">ps</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">],</span> <span class="n">weights</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Create plot</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Propensity Score Distribution - </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">raw_treated</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'blue'</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Raw Treated"</span><span class="p">)</span>

        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">raw_control</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'green'</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Raw Control"</span><span class="p">)</span>

        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">weighted_treated</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weighted_treated</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'blue'</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Weighted Treated"</span><span class="p">)</span>

        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">weighted_control</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weighted_control</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'green'</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Weighted Control"</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="o">.</span><span class="n">flat</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Propensity Score"</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Count"</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">])</span>

        <span class="c1"># Save figure</span>
        <span class="n">plot_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"four_panel_overlap_</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">.png"</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_path</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Saved: </span><span class="si">{</span><span class="n">plot_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>  Saved: outputs\SUBCAT_Antipsychotica_atypisch\four_panel_overlap_SUBCAT_Antipsychotica_atypisch.png
  Saved: outputs\SUBCAT_TCA\four_panel_overlap_SUBCAT_TCA.png
  Saved: outputs\SUBCAT_SSRI\four_panel_overlap_SUBCAT_SSRI.png
  Saved: outputs\SUBCAT_SNRI\four_panel_overlap_SUBCAT_SNRI.png
  Saved: outputs\SUBCAT_Tetracyclische_antidepressiva\four_panel_overlap_SUBCAT_Tetracyclische_antidepressiva.png
  Saved: outputs\SUBCAT_Antidepressiva_overige\four_panel_overlap_SUBCAT_Antidepressiva_overige.png
  Saved: outputs\SUBCAT_Systemische_antihistaminica\four_panel_overlap_SUBCAT_Systemische_antihistaminica.png
  Saved: outputs\SUBCAT_anxiolytica_Benzodiazepine\four_panel_overlap_SUBCAT_anxiolytica_Benzodiazepine.png
  Saved: outputs\SUBCAT_hypnotica_Benzodiazepine\four_panel_overlap_SUBCAT_hypnotica_Benzodiazepine.png
  Saved: outputs\SUBCAT_Amfetaminen\four_panel_overlap_SUBCAT_Amfetaminen.png
  Saved: outputs\SUBCAT_Paracetamol_mono\four_panel_overlap_SUBCAT_Paracetamol_mono.png
  Saved: outputs\SUBCAT_Anti_epileptica_stemmingsstabilisatoren\four_panel_overlap_SUBCAT_Anti_epileptica_stemmingsstabilisatoren.png
  Saved: outputs\SUBCAT_Opioden\four_panel_overlap_SUBCAT_Opioden.png
  Saved: outputs\SUBCAT_Z_drugs\four_panel_overlap_SUBCAT_Z_drugs.png
  Saved: outputs\SUBCAT_NSAIDs\four_panel_overlap_SUBCAT_NSAIDs.png
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=69b56397-7cf3-4956-94f0-b657d5eab983">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[242]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># ATT calculation:</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=3e629fc1-6c45-4ea9-b8a0-b6491f004f31">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[243]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Weighted:</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=2580922c-2fd5-49b1-8083-ee1ddbfa0cfd">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[244]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">GradientBoostingRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">r2_score</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">KFold</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">t</span><span class="p">,</span> <span class="n">probplot</span>
<span class="kn">import</span> <span class="nn">xgboost</span> <span class="k">as</span> <span class="nn">xgb</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Configuration</span>
<span class="c1"># -----------------------------</span>
<span class="n">seeds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span>
<span class="n">imputations</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">output_folder</span> <span class="o">=</span> <span class="s2">"outputs"</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Diagnostic Plotting Function</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">create_diagnostic_plots</span><span class="p">(</span><span class="n">residuals_data</span><span class="p">,</span> <span class="n">fitted_data</span><span class="p">,</span> <span class="n">group_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Create 4 diagnostic plots for model validation"""</span>
    <span class="n">plots_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"plots"</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">plots_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Flatten the collected data</span>
    <span class="n">all_residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">residuals_data</span><span class="p">)</span>
    <span class="n">all_fitted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">fitted_data</span><span class="p">)</span>
    
    <span class="c1"># Create figure with 2x2 subplots</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Diagnostic Plots - </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">'bold'</span><span class="p">)</span>
    
    <span class="c1"># 1. Residuals vs Fitted</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">all_fitted</span><span class="p">,</span> <span class="n">all_residuals</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Fitted Values'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Residuals'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Residuals vs Fitted'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># 2. QQ Plot</span>
    <span class="n">probplot</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s2">"norm"</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Q-Q Plot (Normal)'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># 3. Residual Histogram</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'skyblue'</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">'black'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Residuals'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Density'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Residual Distribution'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># 4. Scale-Location Plot</span>
    <span class="n">sqrt_abs_residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">))</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">all_fitted</span><span class="p">,</span> <span class="n">sqrt_abs_residuals</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Fitted Values'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'|Residuals|'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Scale-Location Plot'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    
    <span class="c1"># Save plot</span>
    <span class="n">plot_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plots_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s1">.png'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_filename</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">'tight'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Diagnostic plots saved for </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Rubin's Rule</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">rubins_pool</span><span class="p">(</span><span class="n">estimates</span><span class="p">,</span> <span class="n">ses</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">estimates</span><span class="p">)</span>
    <span class="n">q_bar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">estimates</span><span class="p">)</span>
    <span class="n">u_bar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">ses</span><span class="p">))</span>
    <span class="n">b_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">estimates</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">total_var</span> <span class="o">=</span> <span class="n">u_bar</span> <span class="o">+</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">b_m</span><span class="p">)</span>
    <span class="n">total_se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">total_var</span><span class="p">)</span>
    <span class="n">ci_lower</span> <span class="o">=</span> <span class="n">q_bar</span> <span class="o">-</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">total_se</span>
    <span class="n">ci_upper</span> <span class="o">=</span> <span class="n">q_bar</span> <span class="o">+</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">total_se</span>
    <span class="n">p_value</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">q_bar</span> <span class="o">/</span> <span class="n">total_se</span><span class="p">),</span> <span class="n">df</span><span class="o">=</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">rounded_p</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">p_value</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">formatted_p</span> <span class="o">=</span> <span class="s2">"&lt; 0.00001"</span> <span class="k">if</span> <span class="n">rounded_p</span> <span class="o">&lt;=</span> <span class="mf">0.00001</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">rounded_p</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">return</span> <span class="n">q_bar</span><span class="p">,</span> <span class="n">total_se</span><span class="p">,</span> <span class="n">ci_lower</span><span class="p">,</span> <span class="n">ci_upper</span><span class="p">,</span> <span class="n">formatted_p</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># SMD + Variance Ratio</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">calculate_smd_vr</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
    <span class="n">treated</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">control</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">w_treated</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">w_control</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">smd</span><span class="p">,</span> <span class="n">vr</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m1</span><span class="p">,</span> <span class="n">m0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">treated</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">w_treated</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">control</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">w_control</span><span class="p">)</span>
            <span class="n">s1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">((</span><span class="n">treated</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">-</span> <span class="n">m1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w_treated</span><span class="p">))</span>
            <span class="n">s0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">((</span><span class="n">control</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">-</span> <span class="n">m0</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w_control</span><span class="p">))</span>
            <span class="n">pooled_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">s1</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">s0</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">smd</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">m1</span> <span class="o">-</span> <span class="n">m0</span><span class="p">)</span> <span class="o">/</span> <span class="n">pooled_sd</span> <span class="k">if</span> <span class="n">pooled_sd</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">vr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s1</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">s0</span><span class="o">**</span><span class="mi">2</span> <span class="k">if</span> <span class="n">s0</span><span class="o">**</span><span class="mi">2</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">smd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">vr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">smd</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">vr</span><span class="p">)</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># OLS Main Loop</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">run_dml_with_trimmed_data</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="p">):</span>
    <span class="n">att_results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">balance_results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">covariates</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Running OLS for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">group_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">group_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">best_result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">best_se</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">"inf"</span><span class="p">)</span>
        
        <span class="c1"># Initialize lists to collect residuals and fitted values for diagnostic plots</span>
        <span class="n">group_residuals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">group_fitted</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="n">seeds</span><span class="p">:</span>
            <span class="c1"># Set random seed for this iteration</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
            
            <span class="n">att_list</span><span class="p">,</span> <span class="n">se_list</span><span class="p">,</span> <span class="n">r2_list</span><span class="p">,</span> <span class="n">rmse_list</span><span class="p">,</span> <span class="n">smd_list</span><span class="p">,</span> <span class="n">vr_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">imp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">imputations</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"trimmed_data_imp</span><span class="si">{</span><span class="n">imp</span><span class="si">}</span><span class="s2">.pkl"</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">or</span> <span class="s2">"iptw"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># Add bootstrap sampling with seed-based randomization</span>
                <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                <span class="n">bootstrap_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">df_bootstrap</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">bootstrap_idx</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="n">X</span> <span class="o">=</span> <span class="n">df_bootstrap</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">T</span> <span class="o">=</span> <span class="n">df_bootstrap</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
                <span class="n">Y</span> <span class="o">=</span> <span class="n">df_bootstrap</span><span class="p">[</span><span class="s2">"caps5_change_baseline"</span><span class="p">]</span>
                <span class="n">W</span> <span class="o">=</span> <span class="n">df_bootstrap</span><span class="p">[</span><span class="s2">"iptw"</span><span class="p">]</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Create design matrix with treatment variable and covariates</span>
                    <span class="n">X_ols</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">T</span><span class="p">,</span> <span class="n">X</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">X_ols</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">X_ols</span><span class="p">)</span>
                    
                    <span class="c1"># Fit weighted OLS with robust standard errors</span>
                    <span class="n">ols_model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">WLS</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">X_ols</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">W</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">cov_type</span><span class="o">=</span><span class="s1">'HC1'</span><span class="p">)</span>
                    
                    <span class="c1"># Extract treatment effect (coefficient of treatment variable)</span>
                    <span class="n">att</span> <span class="o">=</span> <span class="n">ols_model</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>  <span class="c1"># Treatment coefficient</span>
                    <span class="n">se</span> <span class="o">=</span> <span class="n">ols_model</span><span class="o">.</span><span class="n">bse</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>  <span class="c1"># Robust standard error for treatment</span>
                    
                    <span class="n">att_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">att</span><span class="p">)</span>
                    <span class="n">se_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">se</span><span class="p">)</span>

                    <span class="c1"># Calculate model fit statistics</span>
                    <span class="n">Y_pred</span> <span class="o">=</span> <span class="n">ols_model</span><span class="o">.</span><span class="n">fittedvalues</span>
                    <span class="n">residuals</span> <span class="o">=</span> <span class="n">ols_model</span><span class="o">.</span><span class="n">resid</span>
                    <span class="n">rmse</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">Y_pred</span><span class="p">,</span> <span class="n">squared</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">r2</span> <span class="o">=</span> <span class="n">ols_model</span><span class="o">.</span><span class="n">rsquared</span>
                    <span class="n">r2_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
                    <span class="n">rmse_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rmse</span><span class="p">)</span>
                    
                    <span class="c1"># Collect residuals and fitted values for diagnostic plots</span>
                    <span class="n">group_residuals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">residuals</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                    <span class="n">group_fitted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Y_pred</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

                    <span class="n">smd</span><span class="p">,</span> <span class="n">vr</span> <span class="o">=</span> <span class="n">calculate_smd_vr</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span>
                    <span class="n">smd_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smd</span><span class="p">)</span>
                    <span class="n">vr_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vr</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">, seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">, imp </span><span class="si">{</span><span class="n">imp</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">att_list</span><span class="p">:</span>
                <span class="n">att</span><span class="p">,</span> <span class="n">se</span><span class="p">,</span> <span class="n">ci_l</span><span class="p">,</span> <span class="n">ci_u</span><span class="p">,</span> <span class="n">p_val</span> <span class="o">=</span> <span class="n">rubins_pool</span><span class="p">(</span><span class="n">att_list</span><span class="p">,</span> <span class="n">se_list</span><span class="p">)</span>
                <span class="n">avg_r2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">r2_list</span><span class="p">)</span>
                <span class="n">avg_rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rmse_list</span><span class="p">)</span>
                <span class="n">avg_smd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">smd_list</span><span class="p">)</span>
                <span class="n">avg_vr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">vr_list</span><span class="p">)</span>

                <span class="n">balance_results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">"group"</span><span class="p">:</span> <span class="n">group</span><span class="p">,</span> <span class="s2">"seed"</span><span class="p">:</span> <span class="n">seed</span><span class="p">,</span> <span class="s2">"smd"</span><span class="p">:</span> <span class="n">avg_smd</span><span class="p">,</span> <span class="s2">"vr"</span><span class="p">:</span> <span class="n">avg_vr</span>
                <span class="p">})</span>

                <span class="k">if</span> <span class="n">se</span> <span class="o">&lt;</span> <span class="n">best_se</span><span class="p">:</span>
                    <span class="n">best_se</span> <span class="o">=</span> <span class="n">se</span>
                    <span class="n">best_result</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">"group"</span><span class="p">:</span> <span class="n">group</span><span class="p">,</span> <span class="s2">"seed"</span><span class="p">:</span> <span class="n">seed</span><span class="p">,</span> <span class="s2">"att"</span><span class="p">:</span> <span class="n">att</span><span class="p">,</span> <span class="s2">"se"</span><span class="p">:</span> <span class="n">se</span><span class="p">,</span>
                        <span class="s2">"ci_lower"</span><span class="p">:</span> <span class="n">ci_l</span><span class="p">,</span> <span class="s2">"ci_upper"</span><span class="p">:</span> <span class="n">ci_u</span><span class="p">,</span> <span class="s2">"p_value"</span><span class="p">:</span> <span class="n">p_val</span><span class="p">,</span>
                        <span class="s2">"r2"</span><span class="p">:</span> <span class="n">avg_r2</span><span class="p">,</span> <span class="s2">"rmse"</span><span class="p">:</span> <span class="n">avg_rmse</span>
                    <span class="p">}</span>

                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> | Seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">: ATT = </span><span class="si">{</span><span class="n">att</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, SE = </span><span class="si">{</span><span class="n">se</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, p = </span><span class="si">{</span><span class="n">p_val</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No valid results for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> | Seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Create diagnostic plots for this group</span>
        <span class="k">if</span> <span class="n">group_residuals</span> <span class="ow">and</span> <span class="n">group_fitted</span><span class="p">:</span>
            <span class="n">create_diagnostic_plots</span><span class="p">(</span><span class="n">group_residuals</span><span class="p">,</span> <span class="n">group_fitted</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">best_result</span><span class="p">:</span>
            <span class="n">att_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">best_result</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Best result for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">  Seed </span><span class="si">{</span><span class="n">best_result</span><span class="p">[</span><span class="s1">'seed'</span><span class="p">]</span><span class="si">}</span><span class="s2"> | SE = </span><span class="si">{</span><span class="n">best_result</span><span class="p">[</span><span class="s1">'se'</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="c1"># Save final output</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">att_results</span><span class="p">)</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">"ols_summary_subcats.xlsx"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">balance_results</span><span class="p">)</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">"smd_vr_summary_subcats.xlsx"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> All summary files saved."</span><span class="p">)</span>

<span class="n">run_dml_with_trimmed_data</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Running OLS for SUBCAT_Antipsychotica_atypisch
 SUBCAT_Antipsychotica_atypisch | Seed 1: ATT = -2.2716, SE = 7.1258, p = 0.76584
 SUBCAT_Antipsychotica_atypisch | Seed 2: ATT = -3.1746, SE = 5.0999, p = 0.56736
 SUBCAT_Antipsychotica_atypisch | Seed 3: ATT = -3.2868, SE = 6.3732, p = 0.63324
 SUBCAT_Antipsychotica_atypisch | Seed 4: ATT = -1.1870, SE = 8.8228, p = 0.89948
 SUBCAT_Antipsychotica_atypisch | Seed 5: ATT = -1.6513, SE = 4.8367, p = 0.74997
 SUBCAT_Antipsychotica_atypisch | Seed 6: ATT = -0.0522, SE = 5.9896, p = 0.99346
 SUBCAT_Antipsychotica_atypisch | Seed 7: ATT = 1.1671, SE = 7.8934, p = 0.88961
 SUBCAT_Antipsychotica_atypisch | Seed 8: ATT = -5.1265, SE = 6.1668, p = 0.45254
 SUBCAT_Antipsychotica_atypisch | Seed 9: ATT = 0.3893, SE = 4.8967, p = 0.94044
 SUBCAT_Antipsychotica_atypisch | Seed 10: ATT = -3.2036, SE = 7.1742, p = 0.67831
 Diagnostic plots saved for SUBCAT_Antipsychotica_atypisch
 Best result for SUBCAT_Antipsychotica_atypisch  Seed 5 | SE = 4.8367

 Running OLS for SUBCAT_TCA
 SUBCAT_TCA | Seed 1: ATT = 3.1494, SE = 3.5376, p = 0.42362
 SUBCAT_TCA | Seed 2: ATT = 3.9006, SE = 3.0718, p = 0.27300
 SUBCAT_TCA | Seed 3: ATT = 2.4119, SE = 3.6551, p = 0.54540
 SUBCAT_TCA | Seed 4: ATT = 3.0393, SE = 3.6565, p = 0.45259
 SUBCAT_TCA | Seed 5: ATT = 4.9404, SE = 4.0017, p = 0.28455
 SUBCAT_TCA | Seed 6: ATT = 5.1357, SE = 2.8726, p = 0.14832
 SUBCAT_TCA | Seed 7: ATT = 2.4870, SE = 3.3430, p = 0.49824
 SUBCAT_TCA | Seed 8: ATT = 2.5741, SE = 4.0323, p = 0.55796
 SUBCAT_TCA | Seed 9: ATT = 4.8225, SE = 4.0660, p = 0.30124
 SUBCAT_TCA | Seed 10: ATT = 5.5655, SE = 3.7028, p = 0.20725
 Diagnostic plots saved for SUBCAT_TCA
 Best result for SUBCAT_TCA  Seed 6 | SE = 2.8726

 Running OLS for SUBCAT_SSRI
 SUBCAT_SSRI | Seed 1: ATT = -0.2947, SE = 1.4557, p = 0.84946
 SUBCAT_SSRI | Seed 2: ATT = -0.9005, SE = 1.0364, p = 0.43396
 SUBCAT_SSRI | Seed 3: ATT = -0.6645, SE = 1.2062, p = 0.61102
 SUBCAT_SSRI | Seed 4: ATT = -0.8358, SE = 0.7968, p = 0.35340
 SUBCAT_SSRI | Seed 5: ATT = -0.8953, SE = 0.9802, p = 0.41270
 SUBCAT_SSRI | Seed 6: ATT = -0.3726, SE = 0.7735, p = 0.65516
 SUBCAT_SSRI | Seed 7: ATT = -0.1703, SE = 1.0110, p = 0.87439
 SUBCAT_SSRI | Seed 8: ATT = -0.2298, SE = 0.8488, p = 0.79998
 SUBCAT_SSRI | Seed 9: ATT = 0.0029, SE = 1.0465, p = 0.99790
 SUBCAT_SSRI | Seed 10: ATT = -0.5503, SE = 1.2029, p = 0.67106
 Diagnostic plots saved for SUBCAT_SSRI
 Best result for SUBCAT_SSRI  Seed 6 | SE = 0.7735

 Running OLS for SUBCAT_SNRI
 SUBCAT_SNRI | Seed 1: ATT = 3.5705, SE = 4.1131, p = 0.43434
 SUBCAT_SNRI | Seed 2: ATT = 6.0262, SE = 2.5691, p = 0.07889
 SUBCAT_SNRI | Seed 3: ATT = 4.1610, SE = 4.1420, p = 0.37194
 SUBCAT_SNRI | Seed 4: ATT = 3.5050, SE = 4.2681, p = 0.45765
 SUBCAT_SNRI | Seed 5: ATT = 5.5518, SE = 3.9036, p = 0.22802
 SUBCAT_SNRI | Seed 6: ATT = 5.9646, SE = 3.0803, p = 0.12489
 SUBCAT_SNRI | Seed 7: ATT = 3.8839, SE = 4.4995, p = 0.43672
 SUBCAT_SNRI | Seed 8: ATT = 4.4335, SE = 5.4604, p = 0.46238
 SUBCAT_SNRI | Seed 9: ATT = 3.5807, SE = 3.8532, p = 0.40535
 SUBCAT_SNRI | Seed 10: ATT = 3.8440, SE = 4.2303, p = 0.41491
 Diagnostic plots saved for SUBCAT_SNRI
 Best result for SUBCAT_SNRI  Seed 2 | SE = 2.5691

 Running OLS for SUBCAT_Tetracyclische_antidepressiva
 SUBCAT_Tetracyclische_antidepressiva | Seed 1: ATT = 6.9180, SE = 3.8928, p = 0.15019
 SUBCAT_Tetracyclische_antidepressiva | Seed 2: ATT = 4.3887, SE = 2.8790, p = 0.20209
 SUBCAT_Tetracyclische_antidepressiva | Seed 3: ATT = 4.1892, SE = 2.8107, p = 0.21036
 SUBCAT_Tetracyclische_antidepressiva | Seed 4: ATT = 8.0667, SE = 3.7243, p = 0.09625
 SUBCAT_Tetracyclische_antidepressiva | Seed 5: ATT = 6.3377, SE = 3.8143, p = 0.17194
 SUBCAT_Tetracyclische_antidepressiva | Seed 6: ATT = 4.5574, SE = 3.2788, p = 0.23690
 SUBCAT_Tetracyclische_antidepressiva | Seed 7: ATT = 4.8109, SE = 4.4817, p = 0.34351
 SUBCAT_Tetracyclische_antidepressiva | Seed 8: ATT = 4.6645, SE = 3.1718, p = 0.21534
 SUBCAT_Tetracyclische_antidepressiva | Seed 9: ATT = 4.6274, SE = 2.4839, p = 0.13594
 SUBCAT_Tetracyclische_antidepressiva | Seed 10: ATT = 6.1023, SE = 4.1983, p = 0.21975
 Diagnostic plots saved for SUBCAT_Tetracyclische_antidepressiva
 Best result for SUBCAT_Tetracyclische_antidepressiva  Seed 9 | SE = 2.4839

 Running OLS for SUBCAT_Antidepressiva_overige
 SUBCAT_Antidepressiva_overige | Seed 1: ATT = 9.1526, SE = 6.6929, p = 0.24327
 SUBCAT_Antidepressiva_overige | Seed 2: ATT = 1.2106, SE = 8.3845, p = 0.89218
 SUBCAT_Antidepressiva_overige | Seed 3: ATT = 11.7248, SE = 14.5061, p = 0.46426
 SUBCAT_Antidepressiva_overige | Seed 4: ATT = 9.5748, SE = 12.3129, p = 0.48022
 SUBCAT_Antidepressiva_overige | Seed 5: ATT = 13.5947, SE = 12.5638, p = 0.34010
 SUBCAT_Antidepressiva_overige | Seed 6: ATT = 10.7605, SE = 9.7988, p = 0.33380
 SUBCAT_Antidepressiva_overige | Seed 7: ATT = 6.5177, SE = 9.7541, p = 0.54058
 SUBCAT_Antidepressiva_overige | Seed 8: ATT = 10.4978, SE = 9.6072, p = 0.33592
 SUBCAT_Antidepressiva_overige | Seed 9: ATT = 2.4292, SE = 11.8268, p = 0.84729
 SUBCAT_Antidepressiva_overige | Seed 10: ATT = 7.9512, SE = 9.1784, p = 0.43520
 Diagnostic plots saved for SUBCAT_Antidepressiva_overige
 Best result for SUBCAT_Antidepressiva_overige  Seed 1 | SE = 6.6929

 Running OLS for SUBCAT_Systemische_antihistaminica
 SUBCAT_Systemische_antihistaminica | Seed 1: ATT = 4.3101, SE = 4.5236, p = 0.39464
 SUBCAT_Systemische_antihistaminica | Seed 2: ATT = 3.9731, SE = 3.6765, p = 0.34066
 SUBCAT_Systemische_antihistaminica | Seed 3: ATT = 7.9089, SE = 4.8430, p = 0.17780
 SUBCAT_Systemische_antihistaminica | Seed 4: ATT = 9.8883, SE = 4.2782, p = 0.08191
 SUBCAT_Systemische_antihistaminica | Seed 5: ATT = 4.2591, SE = 6.4156, p = 0.54308
 SUBCAT_Systemische_antihistaminica | Seed 6: ATT = 7.0666, SE = 6.9782, p = 0.36850
 SUBCAT_Systemische_antihistaminica | Seed 7: ATT = 5.2280, SE = 4.5131, p = 0.31115
 SUBCAT_Systemische_antihistaminica | Seed 8: ATT = 9.0331, SE = 5.0683, p = 0.14929
 SUBCAT_Systemische_antihistaminica | Seed 9: ATT = 6.4804, SE = 6.5276, p = 0.37702
 SUBCAT_Systemische_antihistaminica | Seed 10: ATT = 6.8974, SE = 4.1278, p = 0.17005
 Diagnostic plots saved for SUBCAT_Systemische_antihistaminica
 Best result for SUBCAT_Systemische_antihistaminica  Seed 2 | SE = 3.6765

 Running OLS for SUBCAT_anxiolytica_Benzodiazepine
 SUBCAT_anxiolytica_Benzodiazepine | Seed 1: ATT = 1.2919, SE = 1.6237, p = 0.47081
 SUBCAT_anxiolytica_Benzodiazepine | Seed 2: ATT = 0.6791, SE = 1.1835, p = 0.59680
 SUBCAT_anxiolytica_Benzodiazepine | Seed 3: ATT = 0.3856, SE = 1.7039, p = 0.83208
 SUBCAT_anxiolytica_Benzodiazepine | Seed 4: ATT = 0.8551, SE = 1.0258, p = 0.45142
 SUBCAT_anxiolytica_Benzodiazepine | Seed 5: ATT = 1.1942, SE = 1.3174, p = 0.41598
 SUBCAT_anxiolytica_Benzodiazepine | Seed 6: ATT = 1.6841, SE = 1.5246, p = 0.33131
 SUBCAT_anxiolytica_Benzodiazepine | Seed 7: ATT = 0.8469, SE = 1.6945, p = 0.64347
 SUBCAT_anxiolytica_Benzodiazepine | Seed 8: ATT = 0.4546, SE = 1.1857, p = 0.72094
 SUBCAT_anxiolytica_Benzodiazepine | Seed 9: ATT = 0.6249, SE = 1.2290, p = 0.63788
 SUBCAT_anxiolytica_Benzodiazepine | Seed 10: ATT = 0.8127, SE = 1.1328, p = 0.51280
 Diagnostic plots saved for SUBCAT_anxiolytica_Benzodiazepine
 Best result for SUBCAT_anxiolytica_Benzodiazepine  Seed 4 | SE = 1.0258

 Running OLS for SUBCAT_hypnotica_Benzodiazepine
 SUBCAT_hypnotica_Benzodiazepine | Seed 1: ATT = -0.3818, SE = 1.9967, p = 0.85768
 SUBCAT_hypnotica_Benzodiazepine | Seed 2: ATT = -0.2156, SE = 2.5864, p = 0.93758
 SUBCAT_hypnotica_Benzodiazepine | Seed 3: ATT = 1.0157, SE = 2.9714, p = 0.74969
 SUBCAT_hypnotica_Benzodiazepine | Seed 4: ATT = -0.6285, SE = 2.4390, p = 0.80936
 SUBCAT_hypnotica_Benzodiazepine | Seed 5: ATT = -1.0986, SE = 2.5673, p = 0.69074
 SUBCAT_hypnotica_Benzodiazepine | Seed 6: ATT = 0.6628, SE = 2.5038, p = 0.80430
 SUBCAT_hypnotica_Benzodiazepine | Seed 7: ATT = 0.1270, SE = 2.8331, p = 0.96640
 SUBCAT_hypnotica_Benzodiazepine | Seed 8: ATT = 0.0457, SE = 2.7367, p = 0.98749
 SUBCAT_hypnotica_Benzodiazepine | Seed 9: ATT = 0.6978, SE = 3.2913, p = 0.84247
 SUBCAT_hypnotica_Benzodiazepine | Seed 10: ATT = 0.3493, SE = 3.3810, p = 0.92268
 Diagnostic plots saved for SUBCAT_hypnotica_Benzodiazepine
 Best result for SUBCAT_hypnotica_Benzodiazepine  Seed 1 | SE = 1.9967

 Running OLS for SUBCAT_Amfetaminen
 SUBCAT_Amfetaminen | Seed 1: ATT = 4.7398, SE = 12.8867, p = 0.73165
 SUBCAT_Amfetaminen | Seed 2: ATT = 5.0397, SE = 9.2567, p = 0.61507
 SUBCAT_Amfetaminen | Seed 3: ATT = 7.1846, SE = 4.7428, p = 0.20439
 SUBCAT_Amfetaminen | Seed 4: ATT = -4.4134, SE = 14.4245, p = 0.77490
 SUBCAT_Amfetaminen | Seed 5: ATT = -4.3009, SE = 11.6962, p = 0.73172
 SUBCAT_Amfetaminen | Seed 6: ATT = -0.9758, SE = 7.8814, p = 0.90744
 SUBCAT_Amfetaminen | Seed 7: ATT = -3.7897, SE = 24.0512, p = 0.88243
 SUBCAT_Amfetaminen | Seed 8: ATT = 3.1204, SE = 6.8249, p = 0.67125
 SUBCAT_Amfetaminen | Seed 9: ATT = -0.8252, SE = 10.2184, p = 0.93952
 SUBCAT_Amfetaminen | Seed 10: ATT = -1.9017, SE = 14.9000, p = 0.90460
 Diagnostic plots saved for SUBCAT_Amfetaminen
 Best result for SUBCAT_Amfetaminen  Seed 3 | SE = 4.7428

 Running OLS for SUBCAT_Paracetamol_mono
 SUBCAT_Paracetamol_mono | Seed 1: ATT = 2.9156, SE = 11.6018, p = 0.81396
 SUBCAT_Paracetamol_mono | Seed 2: ATT = 9.3936, SE = 10.1495, p = 0.40708
 SUBCAT_Paracetamol_mono | Seed 3: ATT = 5.2962, SE = 11.4557, p = 0.66788
 SUBCAT_Paracetamol_mono | Seed 4: ATT = 10.2770, SE = 10.6850, p = 0.39061
 SUBCAT_Paracetamol_mono | Seed 5: ATT = 1.4535, SE = 10.4121, p = 0.89572
 SUBCAT_Paracetamol_mono | Seed 6: ATT = -2.2843, SE = 12.6554, p = 0.86553
 SUBCAT_Paracetamol_mono | Seed 7: ATT = -0.9634, SE = 5.8716, p = 0.87763
 SUBCAT_Paracetamol_mono | Seed 8: ATT = 8.8461, SE = 14.9161, p = 0.58505
 SUBCAT_Paracetamol_mono | Seed 9: ATT = 6.1999, SE = 5.5280, p = 0.32484
 SUBCAT_Paracetamol_mono | Seed 10: ATT = 7.3336, SE = 12.3353, p = 0.58416
 Diagnostic plots saved for SUBCAT_Paracetamol_mono
 Best result for SUBCAT_Paracetamol_mono  Seed 9 | SE = 5.5280

 Running OLS for SUBCAT_Anti_epileptica_stemmingsstabilisatoren
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 1: ATT = 9.6708, SE = 3.7045, p = 0.05939
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 2: ATT = 8.1325, SE = 3.2230, p = 0.06513
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 3: ATT = 8.5645, SE = 5.7114, p = 0.20811
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 4: ATT = 8.9345, SE = 6.0253, p = 0.21226
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 5: ATT = 9.3182, SE = 6.2617, p = 0.21094
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 6: ATT = 8.4425, SE = 5.4160, p = 0.19405
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 7: ATT = 12.1103, SE = 8.6894, p = 0.23586
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 8: ATT = 9.1248, SE = 8.5726, p = 0.34713
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 9: ATT = 7.9425, SE = 8.6475, p = 0.41034
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 10: ATT = 12.0269, SE = 3.8691, p = 0.03592
 Diagnostic plots saved for SUBCAT_Anti_epileptica_stemmingsstabilisatoren
 Best result for SUBCAT_Anti_epileptica_stemmingsstabilisatoren  Seed 2 | SE = 3.2230

 Running OLS for SUBCAT_Opioden
 SUBCAT_Opioden | Seed 1: ATT = 0.0849, SE = 6.9953, p = 0.99089
 SUBCAT_Opioden | Seed 2: ATT = -0.3443, SE = 5.5783, p = 0.95374
 SUBCAT_Opioden | Seed 3: ATT = -2.1501, SE = 5.6914, p = 0.72478
 SUBCAT_Opioden | Seed 4: ATT = -1.3219, SE = 5.0212, p = 0.80535
 SUBCAT_Opioden | Seed 5: ATT = -2.3189, SE = 5.2592, p = 0.68205
 SUBCAT_Opioden | Seed 6: ATT = -2.8233, SE = 3.9296, p = 0.51220
 SUBCAT_Opioden | Seed 7: ATT = -2.5104, SE = 5.0557, p = 0.64555
 SUBCAT_Opioden | Seed 8: ATT = -4.7592, SE = 3.5811, p = 0.25459
 SUBCAT_Opioden | Seed 9: ATT = -2.3809, SE = 4.9162, p = 0.65350
 SUBCAT_Opioden | Seed 10: ATT = 2.3357, SE = 4.9425, p = 0.66114
 Diagnostic plots saved for SUBCAT_Opioden
 Best result for SUBCAT_Opioden  Seed 8 | SE = 3.5811

 Running OLS for SUBCAT_Z_drugs
 SUBCAT_Z_drugs | Seed 1: ATT = 12.5377, SE = 4.6117, p = 0.05306
 SUBCAT_Z_drugs | Seed 2: ATT = 13.0552, SE = 5.7957, p = 0.08740
 SUBCAT_Z_drugs | Seed 3: ATT = 8.5675, SE = 5.3241, p = 0.18286
 SUBCAT_Z_drugs | Seed 4: ATT = 13.9728, SE = 5.0175, p = 0.04957
 SUBCAT_Z_drugs | Seed 5: ATT = 11.1974, SE = 5.3233, p = 0.10325
 SUBCAT_Z_drugs | Seed 6: ATT = 10.9362, SE = 3.6806, p = 0.04109
 SUBCAT_Z_drugs | Seed 7: ATT = 8.7653, SE = 3.5058, p = 0.06675
 SUBCAT_Z_drugs | Seed 8: ATT = 10.9447, SE = 5.8368, p = 0.13404
 SUBCAT_Z_drugs | Seed 9: ATT = 11.5570, SE = 4.0836, p = 0.04734
 SUBCAT_Z_drugs | Seed 10: ATT = 15.2423, SE = 4.4240, p = 0.02616
 Diagnostic plots saved for SUBCAT_Z_drugs
 Best result for SUBCAT_Z_drugs  Seed 7 | SE = 3.5058

 Running OLS for SUBCAT_NSAIDs
 SUBCAT_NSAIDs | Seed 1: ATT = 3.5478, SE = 7.6752, p = 0.66793
 SUBCAT_NSAIDs | Seed 2: ATT = -1.4150, SE = 7.2747, p = 0.85526
 SUBCAT_NSAIDs | Seed 3: ATT = -9.6453, SE = 7.8294, p = 0.28544
 SUBCAT_NSAIDs | Seed 4: ATT = -3.0747, SE = 9.3299, p = 0.75827
 SUBCAT_NSAIDs | Seed 5: ATT = -3.6434, SE = 10.3055, p = 0.74153
 SUBCAT_NSAIDs | Seed 6: ATT = -1.8107, SE = 9.1219, p = 0.85234
 SUBCAT_NSAIDs | Seed 7: ATT = -1.3110, SE = 8.3416, p = 0.88273
 SUBCAT_NSAIDs | Seed 8: ATT = -9.9619, SE = 7.1343, p = 0.23511
 SUBCAT_NSAIDs | Seed 9: ATT = 5.9558, SE = 7.2480, p = 0.45739
 SUBCAT_NSAIDs | Seed 10: ATT = 2.1345, SE = 12.5931, p = 0.87363
 Diagnostic plots saved for SUBCAT_NSAIDs
 Best result for SUBCAT_NSAIDs  Seed 8 | SE = 7.1343

 All summary files saved.
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=77b5527d-29d9-44b7-8752-8a6b09a1f2bf">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[245]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Unweighted:</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=7516480b-1b75-46c0-ba11-ddb32e50c668">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[246]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">GradientBoostingRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">r2_score</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">KFold</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">t</span><span class="p">,</span> <span class="n">probplot</span>
<span class="kn">import</span> <span class="nn">xgboost</span> <span class="k">as</span> <span class="nn">xgb</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Configuration</span>
<span class="c1"># -----------------------------</span>
<span class="n">seeds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span>
<span class="n">imputations</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">output_folder</span> <span class="o">=</span> <span class="s2">"outputs"</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Diagnostic Plotting Function</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">create_diagnostic_plots</span><span class="p">(</span><span class="n">residuals_data</span><span class="p">,</span> <span class="n">fitted_data</span><span class="p">,</span> <span class="n">group_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Create 4 diagnostic plots for model validation"""</span>
    <span class="n">plots_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"plots"</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">plots_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Flatten the collected data</span>
    <span class="n">all_residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">residuals_data</span><span class="p">)</span>
    <span class="n">all_fitted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">fitted_data</span><span class="p">)</span>
    
    <span class="c1"># Create figure with 2x2 subplots</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Diagnostic Plots - </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">'bold'</span><span class="p">)</span>
    
    <span class="c1"># 1. Residuals vs Fitted</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">all_fitted</span><span class="p">,</span> <span class="n">all_residuals</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Fitted Values'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Residuals'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Residuals vs Fitted'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># 2. QQ Plot</span>
    <span class="n">probplot</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s2">"norm"</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Q-Q Plot (Normal)'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># 3. Residual Histogram</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'skyblue'</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">'black'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Residuals'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Density'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Residual Distribution'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># 4. Scale-Location Plot</span>
    <span class="n">sqrt_abs_residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">))</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">all_fitted</span><span class="p">,</span> <span class="n">sqrt_abs_residuals</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Fitted Values'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'|Residuals|'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Scale-Location Plot'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    
    <span class="c1"># Save plot</span>
    <span class="n">plot_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plots_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s1">_unweighted.png'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_filename</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">'tight'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Diagnostic plots saved for </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Rubin's Rule</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">rubins_pool</span><span class="p">(</span><span class="n">estimates</span><span class="p">,</span> <span class="n">ses</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">estimates</span><span class="p">)</span>
    <span class="n">q_bar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">estimates</span><span class="p">)</span>
    <span class="n">u_bar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">ses</span><span class="p">))</span>
    <span class="n">b_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">estimates</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">total_var</span> <span class="o">=</span> <span class="n">u_bar</span> <span class="o">+</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">b_m</span><span class="p">)</span>
    <span class="n">total_se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">total_var</span><span class="p">)</span>
    <span class="n">ci_lower</span> <span class="o">=</span> <span class="n">q_bar</span> <span class="o">-</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">total_se</span>
    <span class="n">ci_upper</span> <span class="o">=</span> <span class="n">q_bar</span> <span class="o">+</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">total_se</span>
    <span class="n">p_value</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">q_bar</span> <span class="o">/</span> <span class="n">total_se</span><span class="p">),</span> <span class="n">df</span><span class="o">=</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">rounded_p</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">p_value</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">formatted_p</span> <span class="o">=</span> <span class="s2">"&lt; 0.00001"</span> <span class="k">if</span> <span class="n">rounded_p</span> <span class="o">&lt;=</span> <span class="mf">0.00001</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">rounded_p</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">return</span> <span class="n">q_bar</span><span class="p">,</span> <span class="n">total_se</span><span class="p">,</span> <span class="n">ci_lower</span><span class="p">,</span> <span class="n">ci_upper</span><span class="p">,</span> <span class="n">formatted_p</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># SMD + Variance Ratio</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">calculate_smd_vr</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
    <span class="n">treated</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">control</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">smd</span><span class="p">,</span> <span class="n">vr</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m1</span><span class="p">,</span> <span class="n">m0</span> <span class="o">=</span> <span class="n">treated</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">control</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">s1</span> <span class="o">=</span> <span class="n">treated</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
            <span class="n">s0</span> <span class="o">=</span> <span class="n">control</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
            <span class="n">pooled_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">s1</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">s0</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">smd</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">m1</span> <span class="o">-</span> <span class="n">m0</span><span class="p">)</span> <span class="o">/</span> <span class="n">pooled_sd</span> <span class="k">if</span> <span class="n">pooled_sd</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">vr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s1</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">s0</span><span class="o">**</span><span class="mi">2</span> <span class="k">if</span> <span class="n">s0</span><span class="o">**</span><span class="mi">2</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">smd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">vr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">smd</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">vr</span><span class="p">)</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># OLS Main Loop</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">run_dml_with_trimmed_data</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="p">):</span>
    <span class="n">att_results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">balance_results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">covariates</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Running OLS for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">group_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">group_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">best_result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">best_se</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">"inf"</span><span class="p">)</span>
        
        <span class="c1"># Initialize lists to collect residuals and fitted values for diagnostic plots</span>
        <span class="n">group_residuals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">group_fitted</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="n">seeds</span><span class="p">:</span>
            <span class="c1"># Set random seed for this iteration</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
            
            <span class="n">att_list</span><span class="p">,</span> <span class="n">se_list</span><span class="p">,</span> <span class="n">r2_list</span><span class="p">,</span> <span class="n">rmse_list</span><span class="p">,</span> <span class="n">smd_list</span><span class="p">,</span> <span class="n">vr_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">imp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">imputations</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"trimmed_data_imp</span><span class="si">{</span><span class="n">imp</span><span class="si">}</span><span class="s2">.pkl"</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">or</span> <span class="s2">"iptw"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># Add bootstrap sampling with seed-based randomization</span>
                <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                <span class="n">bootstrap_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">df_bootstrap</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">bootstrap_idx</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="n">X</span> <span class="o">=</span> <span class="n">df_bootstrap</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">T</span> <span class="o">=</span> <span class="n">df_bootstrap</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
                <span class="n">Y</span> <span class="o">=</span> <span class="n">df_bootstrap</span><span class="p">[</span><span class="s2">"caps5_change_baseline"</span><span class="p">]</span>
                <span class="c1">#W = df_bootstrap["iptw"]</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Create design matrix with treatment variable and covariates</span>
                    <span class="n">X_ols</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">T</span><span class="p">,</span> <span class="n">X</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">X_ols</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">X_ols</span><span class="p">)</span>
                    
                    <span class="c1"># Fit OLS with robust standard errors (unweighted)</span>
                    <span class="n">ols_model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">X_ols</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">cov_type</span><span class="o">=</span><span class="s1">'HC1'</span><span class="p">)</span>
                    
                    <span class="c1"># Extract treatment effect (coefficient of treatment variable)</span>
                    <span class="n">att</span> <span class="o">=</span> <span class="n">ols_model</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>  <span class="c1"># Treatment coefficient</span>
                    <span class="n">se</span> <span class="o">=</span> <span class="n">ols_model</span><span class="o">.</span><span class="n">bse</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>  <span class="c1"># Robust standard error for treatment</span>
                    
                    <span class="n">att_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">att</span><span class="p">)</span>
                    <span class="n">se_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">se</span><span class="p">)</span>

                    <span class="c1"># Calculate model fit statistics</span>
                    <span class="n">Y_pred</span> <span class="o">=</span> <span class="n">ols_model</span><span class="o">.</span><span class="n">fittedvalues</span>
                    <span class="n">residuals</span> <span class="o">=</span> <span class="n">ols_model</span><span class="o">.</span><span class="n">resid</span>
                    <span class="n">rmse</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">Y_pred</span><span class="p">,</span> <span class="n">squared</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">r2</span> <span class="o">=</span> <span class="n">ols_model</span><span class="o">.</span><span class="n">rsquared</span>
                    <span class="n">r2_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
                    <span class="n">rmse_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rmse</span><span class="p">)</span>
                    
                    <span class="c1"># Collect residuals and fitted values for diagnostic plots</span>
                    <span class="n">group_residuals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">residuals</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                    <span class="n">group_fitted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Y_pred</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

                    <span class="n">smd</span><span class="p">,</span> <span class="n">vr</span> <span class="o">=</span> <span class="n">calculate_smd_vr</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
                    <span class="n">smd_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smd</span><span class="p">)</span>
                    <span class="n">vr_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vr</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">, seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">, imp </span><span class="si">{</span><span class="n">imp</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">att_list</span><span class="p">:</span>
                <span class="n">att</span><span class="p">,</span> <span class="n">se</span><span class="p">,</span> <span class="n">ci_l</span><span class="p">,</span> <span class="n">ci_u</span><span class="p">,</span> <span class="n">p_val</span> <span class="o">=</span> <span class="n">rubins_pool</span><span class="p">(</span><span class="n">att_list</span><span class="p">,</span> <span class="n">se_list</span><span class="p">)</span>
                <span class="n">avg_r2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">r2_list</span><span class="p">)</span>
                <span class="n">avg_rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rmse_list</span><span class="p">)</span>
                <span class="n">avg_smd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">smd_list</span><span class="p">)</span>
                <span class="n">avg_vr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">vr_list</span><span class="p">)</span>

                <span class="n">balance_results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">"group"</span><span class="p">:</span> <span class="n">group</span><span class="p">,</span> <span class="s2">"seed"</span><span class="p">:</span> <span class="n">seed</span><span class="p">,</span> <span class="s2">"smd"</span><span class="p">:</span> <span class="n">avg_smd</span><span class="p">,</span> <span class="s2">"vr"</span><span class="p">:</span> <span class="n">avg_vr</span>
                <span class="p">})</span>

                <span class="k">if</span> <span class="n">se</span> <span class="o">&lt;</span> <span class="n">best_se</span><span class="p">:</span>
                    <span class="n">best_se</span> <span class="o">=</span> <span class="n">se</span>
                    <span class="n">best_result</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">"group"</span><span class="p">:</span> <span class="n">group</span><span class="p">,</span> <span class="s2">"seed"</span><span class="p">:</span> <span class="n">seed</span><span class="p">,</span> <span class="s2">"att"</span><span class="p">:</span> <span class="n">att</span><span class="p">,</span> <span class="s2">"se"</span><span class="p">:</span> <span class="n">se</span><span class="p">,</span>
                        <span class="s2">"ci_lower"</span><span class="p">:</span> <span class="n">ci_l</span><span class="p">,</span> <span class="s2">"ci_upper"</span><span class="p">:</span> <span class="n">ci_u</span><span class="p">,</span> <span class="s2">"p_value"</span><span class="p">:</span> <span class="n">p_val</span><span class="p">,</span>
                        <span class="s2">"r2"</span><span class="p">:</span> <span class="n">avg_r2</span><span class="p">,</span> <span class="s2">"rmse"</span><span class="p">:</span> <span class="n">avg_rmse</span>
                    <span class="p">}</span>

                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> | Seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">: ATT = </span><span class="si">{</span><span class="n">att</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, SE = </span><span class="si">{</span><span class="n">se</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, p = </span><span class="si">{</span><span class="n">p_val</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No valid results for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> | Seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Create diagnostic plots for this group</span>
        <span class="k">if</span> <span class="n">group_residuals</span> <span class="ow">and</span> <span class="n">group_fitted</span><span class="p">:</span>
            <span class="n">create_diagnostic_plots</span><span class="p">(</span><span class="n">group_residuals</span><span class="p">,</span> <span class="n">group_fitted</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">best_result</span><span class="p">:</span>
            <span class="n">att_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">best_result</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Best result for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">  Seed </span><span class="si">{</span><span class="n">best_result</span><span class="p">[</span><span class="s1">'seed'</span><span class="p">]</span><span class="si">}</span><span class="s2"> | SE = </span><span class="si">{</span><span class="n">best_result</span><span class="p">[</span><span class="s1">'se'</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="c1"># Save final output</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">att_results</span><span class="p">)</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">"ols_rubin_summary_subcats_unweighted.xlsx"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">balance_results</span><span class="p">)</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">"smd_vr_summary_subcats_unweighted.xlsx"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> All summary files saved."</span><span class="p">)</span>

<span class="n">run_dml_with_trimmed_data</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Running OLS for SUBCAT_Antipsychotica_atypisch
 SUBCAT_Antipsychotica_atypisch | Seed 1: ATT = -0.0374, SE = 8.1953, p = 0.99658
 SUBCAT_Antipsychotica_atypisch | Seed 2: ATT = 0.0678, SE = 7.0955, p = 0.99284
 SUBCAT_Antipsychotica_atypisch | Seed 3: ATT = -1.3636, SE = 7.3444, p = 0.86174
 SUBCAT_Antipsychotica_atypisch | Seed 4: ATT = 0.6255, SE = 10.5174, p = 0.95543
 SUBCAT_Antipsychotica_atypisch | Seed 5: ATT = 0.3015, SE = 6.2969, p = 0.96411
 SUBCAT_Antipsychotica_atypisch | Seed 6: ATT = 3.0491, SE = 7.6157, p = 0.70934
 SUBCAT_Antipsychotica_atypisch | Seed 7: ATT = 4.8450, SE = 8.5345, p = 0.60059
 SUBCAT_Antipsychotica_atypisch | Seed 8: ATT = -3.4059, SE = 8.3208, p = 0.70327
 SUBCAT_Antipsychotica_atypisch | Seed 9: ATT = 3.7405, SE = 6.9034, p = 0.61670
 SUBCAT_Antipsychotica_atypisch | Seed 10: ATT = -0.7554, SE = 10.1639, p = 0.94433
 Diagnostic plots saved for SUBCAT_Antipsychotica_atypisch
 Best result for SUBCAT_Antipsychotica_atypisch  Seed 5 | SE = 6.2969

 Running OLS for SUBCAT_TCA
 SUBCAT_TCA | Seed 1: ATT = 3.8290, SE = 3.8979, p = 0.38155
 SUBCAT_TCA | Seed 2: ATT = 3.6143, SE = 3.2360, p = 0.32660
 SUBCAT_TCA | Seed 3: ATT = 1.8528, SE = 3.7999, p = 0.65135
 SUBCAT_TCA | Seed 4: ATT = 2.8772, SE = 3.7464, p = 0.48531
 SUBCAT_TCA | Seed 5: ATT = 5.5370, SE = 4.8451, p = 0.31688
 SUBCAT_TCA | Seed 6: ATT = 5.7017, SE = 3.1529, p = 0.14482
 SUBCAT_TCA | Seed 7: ATT = 2.1365, SE = 3.5967, p = 0.58447
 SUBCAT_TCA | Seed 8: ATT = 3.0918, SE = 4.0854, p = 0.49131
 SUBCAT_TCA | Seed 9: ATT = 5.0538, SE = 4.4190, p = 0.31656
 SUBCAT_TCA | Seed 10: ATT = 5.0093, SE = 3.7725, p = 0.25494
 Diagnostic plots saved for SUBCAT_TCA
 Best result for SUBCAT_TCA  Seed 6 | SE = 3.1529

 Running OLS for SUBCAT_SSRI
 SUBCAT_SSRI | Seed 1: ATT = -0.4442, SE = 1.4815, p = 0.77925
 SUBCAT_SSRI | Seed 2: ATT = -1.0641, SE = 1.2035, p = 0.42653
 SUBCAT_SSRI | Seed 3: ATT = -0.9062, SE = 1.2372, p = 0.50452
 SUBCAT_SSRI | Seed 4: ATT = -0.9468, SE = 0.8745, p = 0.33985
 SUBCAT_SSRI | Seed 5: ATT = -1.1398, SE = 0.9725, p = 0.30624
 SUBCAT_SSRI | Seed 6: ATT = -0.6221, SE = 0.8915, p = 0.52375
 SUBCAT_SSRI | Seed 7: ATT = -0.2696, SE = 0.9956, p = 0.79993
 SUBCAT_SSRI | Seed 8: ATT = -0.5998, SE = 0.8886, p = 0.53671
 SUBCAT_SSRI | Seed 9: ATT = 0.0432, SE = 1.0017, p = 0.96768
 SUBCAT_SSRI | Seed 10: ATT = -0.8227, SE = 1.1231, p = 0.50445
 Diagnostic plots saved for SUBCAT_SSRI
 Best result for SUBCAT_SSRI  Seed 4 | SE = 0.8745

 Running OLS for SUBCAT_SNRI
 SUBCAT_SNRI | Seed 1: ATT = 3.6044, SE = 3.4895, p = 0.36000
 SUBCAT_SNRI | Seed 2: ATT = 5.5741, SE = 2.7358, p = 0.11127
 SUBCAT_SNRI | Seed 3: ATT = 3.9432, SE = 3.4251, p = 0.31376
 SUBCAT_SNRI | Seed 4: ATT = 3.9164, SE = 4.7980, p = 0.46017
 SUBCAT_SNRI | Seed 5: ATT = 5.7465, SE = 5.3565, p = 0.34377
 SUBCAT_SNRI | Seed 6: ATT = 5.6761, SE = 3.7747, p = 0.20709
 SUBCAT_SNRI | Seed 7: ATT = 4.1889, SE = 5.1039, p = 0.45790
 SUBCAT_SNRI | Seed 8: ATT = 4.8217, SE = 5.0950, p = 0.39756
 SUBCAT_SNRI | Seed 9: ATT = 3.6293, SE = 3.7042, p = 0.38267
 SUBCAT_SNRI | Seed 10: ATT = 3.9736, SE = 5.3368, p = 0.49790
 Diagnostic plots saved for SUBCAT_SNRI
 Best result for SUBCAT_SNRI  Seed 2 | SE = 2.7358

 Running OLS for SUBCAT_Tetracyclische_antidepressiva
 SUBCAT_Tetracyclische_antidepressiva | Seed 1: ATT = 6.5121, SE = 3.9412, p = 0.17381
 SUBCAT_Tetracyclische_antidepressiva | Seed 2: ATT = 4.7696, SE = 3.1218, p = 0.20127
 SUBCAT_Tetracyclische_antidepressiva | Seed 3: ATT = 4.3972, SE = 3.1845, p = 0.23948
 SUBCAT_Tetracyclische_antidepressiva | Seed 4: ATT = 7.8938, SE = 3.9882, p = 0.11889
 SUBCAT_Tetracyclische_antidepressiva | Seed 5: ATT = 5.7658, SE = 4.3955, p = 0.25982
 SUBCAT_Tetracyclische_antidepressiva | Seed 6: ATT = 4.7582, SE = 3.3984, p = 0.23407
 SUBCAT_Tetracyclische_antidepressiva | Seed 7: ATT = 5.1094, SE = 4.0580, p = 0.27646
 SUBCAT_Tetracyclische_antidepressiva | Seed 8: ATT = 4.8028, SE = 3.3776, p = 0.22810
 SUBCAT_Tetracyclische_antidepressiva | Seed 9: ATT = 5.5011, SE = 3.5802, p = 0.19921
 SUBCAT_Tetracyclische_antidepressiva | Seed 10: ATT = 6.0853, SE = 3.9683, p = 0.19994
 Diagnostic plots saved for SUBCAT_Tetracyclische_antidepressiva
 Best result for SUBCAT_Tetracyclische_antidepressiva  Seed 2 | SE = 3.1218

 Running OLS for SUBCAT_Antidepressiva_overige
 SUBCAT_Antidepressiva_overige | Seed 1: ATT = 9.0494, SE = 7.4970, p = 0.29390
 SUBCAT_Antidepressiva_overige | Seed 2: ATT = 0.6556, SE = 8.8554, p = 0.94454
 SUBCAT_Antidepressiva_overige | Seed 3: ATT = 11.4645, SE = 14.8413, p = 0.48294
 SUBCAT_Antidepressiva_overige | Seed 4: ATT = 10.4065, SE = 15.1419, p = 0.52969
 SUBCAT_Antidepressiva_overige | Seed 5: ATT = 12.9605, SE = 12.9235, p = 0.37267
 SUBCAT_Antidepressiva_overige | Seed 6: ATT = 9.8715, SE = 8.7797, p = 0.32377
 SUBCAT_Antidepressiva_overige | Seed 7: ATT = 6.1761, SE = 9.7895, p = 0.56236
 SUBCAT_Antidepressiva_overige | Seed 8: ATT = 8.4328, SE = 8.6810, p = 0.38635
 SUBCAT_Antidepressiva_overige | Seed 9: ATT = 0.5585, SE = 11.9323, p = 0.96491
 SUBCAT_Antidepressiva_overige | Seed 10: ATT = 7.1198, SE = 9.4736, p = 0.49413
 Diagnostic plots saved for SUBCAT_Antidepressiva_overige
 Best result for SUBCAT_Antidepressiva_overige  Seed 1 | SE = 7.4970

 Running OLS for SUBCAT_Systemische_antihistaminica
 SUBCAT_Systemische_antihistaminica | Seed 1: ATT = 4.4678, SE = 4.8536, p = 0.40939
 SUBCAT_Systemische_antihistaminica | Seed 2: ATT = 5.7883, SE = 4.4838, p = 0.26628
 SUBCAT_Systemische_antihistaminica | Seed 3: ATT = 9.5862, SE = 4.8442, p = 0.11895
 SUBCAT_Systemische_antihistaminica | Seed 4: ATT = 11.3715, SE = 4.8892, p = 0.08062
 SUBCAT_Systemische_antihistaminica | Seed 5: ATT = 4.2755, SE = 5.7054, p = 0.49529
 SUBCAT_Systemische_antihistaminica | Seed 6: ATT = 7.4256, SE = 6.7943, p = 0.33583
 SUBCAT_Systemische_antihistaminica | Seed 7: ATT = 8.1938, SE = 4.6324, p = 0.15165
 SUBCAT_Systemische_antihistaminica | Seed 8: ATT = 9.9674, SE = 6.7620, p = 0.21448
 SUBCAT_Systemische_antihistaminica | Seed 9: ATT = 7.4562, SE = 5.9914, p = 0.28126
 SUBCAT_Systemische_antihistaminica | Seed 10: ATT = 7.1639, SE = 5.1927, p = 0.23981
 Diagnostic plots saved for SUBCAT_Systemische_antihistaminica
 Best result for SUBCAT_Systemische_antihistaminica  Seed 2 | SE = 4.4838

 Running OLS for SUBCAT_anxiolytica_Benzodiazepine
 SUBCAT_anxiolytica_Benzodiazepine | Seed 1: ATT = 1.4458, SE = 1.7573, p = 0.45687
 SUBCAT_anxiolytica_Benzodiazepine | Seed 2: ATT = 1.0436, SE = 1.2837, p = 0.46185
 SUBCAT_anxiolytica_Benzodiazepine | Seed 3: ATT = 0.4266, SE = 1.6269, p = 0.80609
 SUBCAT_anxiolytica_Benzodiazepine | Seed 4: ATT = 1.0329, SE = 1.0478, p = 0.38004
 SUBCAT_anxiolytica_Benzodiazepine | Seed 5: ATT = 1.2826, SE = 1.5035, p = 0.44169
 SUBCAT_anxiolytica_Benzodiazepine | Seed 6: ATT = 1.7666, SE = 1.7282, p = 0.36447
 SUBCAT_anxiolytica_Benzodiazepine | Seed 7: ATT = 1.2792, SE = 2.0413, p = 0.56486
 SUBCAT_anxiolytica_Benzodiazepine | Seed 8: ATT = 0.4133, SE = 1.3639, p = 0.77696
 SUBCAT_anxiolytica_Benzodiazepine | Seed 9: ATT = 0.7071, SE = 1.4257, p = 0.64595
 SUBCAT_anxiolytica_Benzodiazepine | Seed 10: ATT = 0.9735, SE = 1.0348, p = 0.40011
 Diagnostic plots saved for SUBCAT_anxiolytica_Benzodiazepine
 Best result for SUBCAT_anxiolytica_Benzodiazepine  Seed 10 | SE = 1.0348

 Running OLS for SUBCAT_hypnotica_Benzodiazepine
 SUBCAT_hypnotica_Benzodiazepine | Seed 1: ATT = -0.4689, SE = 2.3439, p = 0.85120
 SUBCAT_hypnotica_Benzodiazepine | Seed 2: ATT = -0.1242, SE = 2.6738, p = 0.96518
 SUBCAT_hypnotica_Benzodiazepine | Seed 3: ATT = 0.6683, SE = 2.9665, p = 0.83280
 SUBCAT_hypnotica_Benzodiazepine | Seed 4: ATT = -1.3190, SE = 2.0920, p = 0.56260
 SUBCAT_hypnotica_Benzodiazepine | Seed 5: ATT = -1.1758, SE = 2.2465, p = 0.62836
 SUBCAT_hypnotica_Benzodiazepine | Seed 6: ATT = 0.5622, SE = 2.9177, p = 0.85659
 SUBCAT_hypnotica_Benzodiazepine | Seed 7: ATT = -0.1168, SE = 2.6235, p = 0.96663
 SUBCAT_hypnotica_Benzodiazepine | Seed 8: ATT = -0.2708, SE = 2.6139, p = 0.92248
 SUBCAT_hypnotica_Benzodiazepine | Seed 9: ATT = 0.1628, SE = 3.0627, p = 0.96016
 SUBCAT_hypnotica_Benzodiazepine | Seed 10: ATT = -0.1970, SE = 3.3058, p = 0.95535
 Diagnostic plots saved for SUBCAT_hypnotica_Benzodiazepine
 Best result for SUBCAT_hypnotica_Benzodiazepine  Seed 4 | SE = 2.0920

 Running OLS for SUBCAT_Amfetaminen
 SUBCAT_Amfetaminen | Seed 1: ATT = 6.7900, SE = 13.5882, p = 0.64353
 SUBCAT_Amfetaminen | Seed 2: ATT = 8.0151, SE = 9.0479, p = 0.42574
 SUBCAT_Amfetaminen | Seed 3: ATT = 7.4347, SE = 9.0579, p = 0.45786
 SUBCAT_Amfetaminen | Seed 4: ATT = -6.6639, SE = 15.9638, p = 0.69779
 SUBCAT_Amfetaminen | Seed 5: ATT = -6.1166, SE = 12.0698, p = 0.63898
 SUBCAT_Amfetaminen | Seed 6: ATT = -0.9064, SE = 10.7591, p = 0.93691
 SUBCAT_Amfetaminen | Seed 7: ATT = -2.9375, SE = 24.7121, p = 0.91111
 SUBCAT_Amfetaminen | Seed 8: ATT = 3.9972, SE = 8.8214, p = 0.67395
 SUBCAT_Amfetaminen | Seed 9: ATT = -1.1730, SE = 11.1036, p = 0.92095
 SUBCAT_Amfetaminen | Seed 10: ATT = -2.7156, SE = 15.7527, p = 0.87150
 Diagnostic plots saved for SUBCAT_Amfetaminen
 Best result for SUBCAT_Amfetaminen  Seed 8 | SE = 8.8214

 Running OLS for SUBCAT_Paracetamol_mono
 SUBCAT_Paracetamol_mono | Seed 1: ATT = 3.3031, SE = 10.7251, p = 0.77347
 SUBCAT_Paracetamol_mono | Seed 2: ATT = 7.1394, SE = 12.3792, p = 0.59503
 SUBCAT_Paracetamol_mono | Seed 3: ATT = 3.9347, SE = 13.0459, p = 0.77798
 SUBCAT_Paracetamol_mono | Seed 4: ATT = 10.2203, SE = 10.6814, p = 0.39284
 SUBCAT_Paracetamol_mono | Seed 5: ATT = 1.3818, SE = 11.2910, p = 0.90850
 SUBCAT_Paracetamol_mono | Seed 6: ATT = -4.0169, SE = 13.1772, p = 0.77569
 SUBCAT_Paracetamol_mono | Seed 7: ATT = -2.6395, SE = 9.1492, p = 0.78730
 SUBCAT_Paracetamol_mono | Seed 8: ATT = 7.3758, SE = 19.2391, p = 0.72095
 SUBCAT_Paracetamol_mono | Seed 9: ATT = 6.9756, SE = 8.3850, p = 0.45224
 SUBCAT_Paracetamol_mono | Seed 10: ATT = 7.0032, SE = 12.2869, p = 0.59918
 Diagnostic plots saved for SUBCAT_Paracetamol_mono
 Best result for SUBCAT_Paracetamol_mono  Seed 9 | SE = 8.3850

 Running OLS for SUBCAT_Anti_epileptica_stemmingsstabilisatoren
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 1: ATT = 7.6039, SE = 4.4024, p = 0.15920
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 2: ATT = 7.9868, SE = 3.8166, p = 0.10452
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 3: ATT = 7.8009, SE = 4.7949, p = 0.17909
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 4: ATT = 8.0952, SE = 6.1548, p = 0.25875
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 5: ATT = 7.8881, SE = 5.2881, p = 0.21006
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 6: ATT = 7.5652, SE = 5.6098, p = 0.24877
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 7: ATT = 9.7581, SE = 8.9936, p = 0.33894
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 8: ATT = 7.8955, SE = 9.3784, p = 0.44724
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 9: ATT = 5.8963, SE = 7.0395, p = 0.44938
 SUBCAT_Anti_epileptica_stemmingsstabilisatoren | Seed 10: ATT = 9.7091, SE = 3.8871, p = 0.06693
 Diagnostic plots saved for SUBCAT_Anti_epileptica_stemmingsstabilisatoren
 Best result for SUBCAT_Anti_epileptica_stemmingsstabilisatoren  Seed 2 | SE = 3.8166

 Running OLS for SUBCAT_Opioden
 SUBCAT_Opioden | Seed 1: ATT = 1.1661, SE = 6.4414, p = 0.86515
 SUBCAT_Opioden | Seed 2: ATT = -0.1321, SE = 6.9247, p = 0.98569
 SUBCAT_Opioden | Seed 3: ATT = -1.6233, SE = 5.7499, p = 0.79171
 SUBCAT_Opioden | Seed 4: ATT = -1.4490, SE = 5.5293, p = 0.80622
 SUBCAT_Opioden | Seed 5: ATT = -2.5312, SE = 5.3921, p = 0.66322
 SUBCAT_Opioden | Seed 6: ATT = -2.2651, SE = 5.0981, p = 0.67980
 SUBCAT_Opioden | Seed 7: ATT = -2.6959, SE = 5.2764, p = 0.63631
 SUBCAT_Opioden | Seed 8: ATT = -4.8766, SE = 5.0516, p = 0.38904
 SUBCAT_Opioden | Seed 9: ATT = -1.5261, SE = 5.6760, p = 0.80133
 SUBCAT_Opioden | Seed 10: ATT = 1.9728, SE = 5.7942, p = 0.75063
 Diagnostic plots saved for SUBCAT_Opioden
 Best result for SUBCAT_Opioden  Seed 8 | SE = 5.0516

 Running OLS for SUBCAT_Z_drugs
 SUBCAT_Z_drugs | Seed 1: ATT = 12.0955, SE = 5.0010, p = 0.07287
 SUBCAT_Z_drugs | Seed 2: ATT = 11.8018, SE = 5.4476, p = 0.09619
 SUBCAT_Z_drugs | Seed 3: ATT = 9.3867, SE = 6.1566, p = 0.20203
 SUBCAT_Z_drugs | Seed 4: ATT = 15.3194, SE = 4.2236, p = 0.02222
 SUBCAT_Z_drugs | Seed 5: ATT = 11.9978, SE = 5.0929, p = 0.07802
 SUBCAT_Z_drugs | Seed 6: ATT = 10.3334, SE = 6.2779, p = 0.17511
 SUBCAT_Z_drugs | Seed 7: ATT = 9.1757, SE = 4.5978, p = 0.11669
 SUBCAT_Z_drugs | Seed 8: ATT = 10.8570, SE = 6.4279, p = 0.16648
 SUBCAT_Z_drugs | Seed 9: ATT = 10.7536, SE = 5.5213, p = 0.12329
 SUBCAT_Z_drugs | Seed 10: ATT = 15.0622, SE = 5.1895, p = 0.04401
 Diagnostic plots saved for SUBCAT_Z_drugs
 Best result for SUBCAT_Z_drugs  Seed 4 | SE = 4.2236

 Running OLS for SUBCAT_NSAIDs
 SUBCAT_NSAIDs | Seed 1: ATT = 1.6641, SE = 6.7529, p = 0.81748
 SUBCAT_NSAIDs | Seed 2: ATT = -1.2595, SE = 6.3954, p = 0.85348
 SUBCAT_NSAIDs | Seed 3: ATT = -7.2042, SE = 8.8945, p = 0.46339
 SUBCAT_NSAIDs | Seed 4: ATT = -4.0358, SE = 7.7102, p = 0.62833
 SUBCAT_NSAIDs | Seed 5: ATT = -4.5058, SE = 9.7396, p = 0.66768
 SUBCAT_NSAIDs | Seed 6: ATT = -2.4095, SE = 9.1816, p = 0.80595
 SUBCAT_NSAIDs | Seed 7: ATT = -2.9312, SE = 9.7011, p = 0.77759
 SUBCAT_NSAIDs | Seed 8: ATT = -7.8472, SE = 8.8114, p = 0.42348
 SUBCAT_NSAIDs | Seed 9: ATT = 2.9630, SE = 8.2901, p = 0.73884
 SUBCAT_NSAIDs | Seed 10: ATT = 0.5975, SE = 13.6375, p = 0.96715
 Diagnostic plots saved for SUBCAT_NSAIDs
 Best result for SUBCAT_NSAIDs  Seed 2 | SE = 6.3954

 All summary files saved.
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=9e3e1778-8b6a-4db4-915c-c8fc1a7d4992">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[247]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">sem</span><span class="p">,</span> <span class="n">ttest_ind</span>

<span class="c1"># ----------------------------------</span>
<span class="c1"># File paths</span>
<span class="c1"># ----------------------------------</span>
<span class="n">output_base</span> <span class="o">=</span> <span class="s2">"outputs"</span>
<span class="n">att_file</span> <span class="o">=</span> <span class="s2">"ols_summary_subcats.xlsx"</span>
<span class="n">trimmed_file</span> <span class="o">=</span> <span class="s2">"trimmed_data_imp1.pkl"</span>
<span class="n">auc_file</span> <span class="o">=</span> <span class="s2">"auc_scores.xlsx"</span>  

<span class="c1"># ----------------------------------</span>
<span class="c1"># Load ATT Summary</span>
<span class="c1"># ----------------------------------</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">att_file</span><span class="p">):</span>
    <span class="n">att_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">att_file</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">" ATT summary file not found: ols_summary_subcats.xlsx"</span><span class="p">)</span>

<span class="n">summary_rows</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># ----------------------------------</span>
<span class="c1"># Loop over medication groups</span>
<span class="c1"># ----------------------------------</span>
<span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">medication_groups</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">g</span><span class="p">))]</span>

<span class="k">for</span> <span class="n">med</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">group_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">med</span><span class="p">)</span>

        <span class="c1"># Load trimmed data</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="n">trimmed_file</span><span class="p">))</span>

        <span class="c1"># Detect treatment column</span>
        <span class="n">treatment_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">med</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">treatment_cols</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Treatment column </span><span class="si">{</span><span class="n">med</span><span class="si">}</span><span class="s2"> not found in trimmed data. Skipping."</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">treatment_var</span> <span class="o">=</span> <span class="n">treatment_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Extract treatment and outcome</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">"caps5_change_baseline"</span><span class="p">]</span>

        <span class="c1"># Treated and control stats</span>
        <span class="n">treated</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">control</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>

        <span class="n">mean_treat</span> <span class="o">=</span> <span class="n">treated</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">se_treat</span> <span class="o">=</span> <span class="n">sem</span><span class="p">(</span><span class="n">treated</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">treated</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">mean_ctrl</span> <span class="o">=</span> <span class="n">control</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">se_ctrl</span> <span class="o">=</span> <span class="n">sem</span><span class="p">(</span><span class="n">control</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">control</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Cohen's d (unadjusted)</span>
        <span class="n">pooled_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">treated</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">control</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">cohen_d</span> <span class="o">=</span> <span class="p">(</span><span class="n">mean_treat</span> <span class="o">-</span> <span class="n">mean_ctrl</span><span class="p">)</span> <span class="o">/</span> <span class="n">pooled_sd</span> <span class="k">if</span> <span class="n">pooled_sd</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># E-value (unadjusted)</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">mean_treat</span> <span class="o">-</span> <span class="n">mean_ctrl</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">delta</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">mean_ctrl</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">mean_ctrl</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Unadjusted p-value</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">t_stat</span><span class="p">,</span> <span class="n">p_val</span> <span class="o">=</span> <span class="n">ttest_ind</span><span class="p">(</span><span class="n">treated</span><span class="p">,</span> <span class="n">control</span><span class="p">,</span> <span class="n">equal_var</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nan_policy</span><span class="o">=</span><span class="s2">"omit"</span><span class="p">)</span>
            <span class="n">rounded_p</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">p_val</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="n">formatted_p</span> <span class="o">=</span> <span class="s2">"&lt; 0.00001"</span> <span class="k">if</span> <span class="n">rounded_p</span> <span class="o">&lt;</span> <span class="mf">0.00001</span> <span class="k">else</span> <span class="n">rounded_p</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">formatted_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># AUC from new auc_scores.xlsx file</span>
        <span class="n">auc_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">auc_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="n">auc_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">auc_path</span><span class="p">):</span>
            <span class="n">auc_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">auc_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">"AUC"</span> <span class="ow">in</span> <span class="n">auc_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">auc_val</span> <span class="o">=</span> <span class="n">auc_df</span><span class="p">[</span><span class="s2">"AUC"</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="c1"># Adjusted stats from Rubin summary</span>
        <span class="n">att_row</span> <span class="o">=</span> <span class="n">att_df</span><span class="p">[</span><span class="n">att_df</span><span class="p">[</span><span class="s2">"group"</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">med</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">att_row</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">att</span> <span class="o">=</span> <span class="n">att_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"att"</span><span class="p">]</span>
            <span class="n">att_se</span> <span class="o">=</span> <span class="n">att_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"se"</span><span class="p">]</span>
            <span class="n">att_p_val</span> <span class="o">=</span> <span class="n">att_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"p_value"</span><span class="p">]</span>
            <span class="n">r2</span> <span class="o">=</span> <span class="n">att_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"r2"</span><span class="p">]</span>
            <span class="n">rmse</span> <span class="o">=</span> <span class="n">att_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"rmse"</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">rounded_att_p</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">att_p_val</span><span class="p">),</span> <span class="mi">5</span><span class="p">)</span>
                <span class="n">formatted_att_p</span> <span class="o">=</span> <span class="s2">"&lt; 0.00001"</span> <span class="k">if</span> <span class="n">rounded_att_p</span> <span class="o">&lt;</span> <span class="mf">0.00001</span> <span class="k">else</span> <span class="n">rounded_att_p</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">formatted_att_p</span> <span class="o">=</span> <span class="n">att_p_val</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">att</span><span class="p">,</span> <span class="n">att_se</span><span class="p">,</span> <span class="n">formatted_att_p</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Append full row</span>
        <span class="n">summary_rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">'Medication Group'</span><span class="p">:</span> <span class="n">med</span><span class="p">,</span>
            <span class="s1">'Mean Treated'</span><span class="p">:</span> <span class="n">mean_treat</span><span class="p">,</span>
            <span class="s1">'SE Treated'</span><span class="p">:</span> <span class="n">se_treat</span><span class="p">,</span>
            <span class="s1">'Mean Control'</span><span class="p">:</span> <span class="n">mean_ctrl</span><span class="p">,</span>
            <span class="s1">'SE Control'</span><span class="p">:</span> <span class="n">se_ctrl</span><span class="p">,</span>
            <span class="s1">'Cohen d'</span><span class="p">:</span> <span class="n">cohen_d</span><span class="p">,</span>
            <span class="s1">'E (Unadjusted)'</span><span class="p">:</span> <span class="n">E</span><span class="p">,</span>
            <span class="s1">'n Treated'</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">treated</span><span class="p">),</span>
            <span class="s1">'n Control'</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">control</span><span class="p">),</span>
            <span class="c1">#'Unadjusted p-value': formatted_p,</span>
            <span class="s1">'ATT Estimate'</span><span class="p">:</span> <span class="n">att</span><span class="p">,</span>
            <span class="s1">'ATT SE (Robust)'</span><span class="p">:</span> <span class="n">att_se</span><span class="p">,</span>
            <span class="s1">'ATT p-value'</span><span class="p">:</span> <span class="n">formatted_att_p</span><span class="p">,</span>
            <span class="s1">'R'</span><span class="p">:</span> <span class="n">r2</span><span class="p">,</span>
            <span class="s1">'RMSE'</span><span class="p">:</span> <span class="n">rmse</span><span class="p">,</span>
            <span class="s1">'AUC'</span><span class="p">:</span> <span class="n">auc_val</span>
        <span class="p">})</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error in </span><span class="si">{</span><span class="n">med</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># ----------------------------------</span>
<span class="c1"># Save final summary</span>
<span class="c1"># ----------------------------------</span>
<span class="n">summary_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">summary_rows</span><span class="p">)</span>
<span class="n">summary_df</span> <span class="o">=</span> <span class="n">summary_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">"Medication Group"</span><span class="p">)</span>
<span class="n">summary_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">"Final_ATT_Summary_SubCat.xlsx"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">" Final_ATT_Summary_SubCat saved"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre> Final_ATT_Summary_SubCat saved
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=89c085a6-dd36-4cfd-9501-5a4dc75e036a">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[248]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.backends.backend_pdf</span> <span class="kn">import</span> <span class="n">PdfPages</span>

<span class="c1">#  Load the final summary table</span>
<span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s2">"Final_ATT_Summary_SubCat.xlsx"</span><span class="p">)</span>

<span class="c1">#  Parse DML p-values (handle "&lt; 0.00001")</span>
<span class="k">def</span> <span class="nf">parse_pval</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">"&lt;"</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.000001</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

<span class="n">final_df</span><span class="p">[</span><span class="s1">'ATT p-value'</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="s1">'ATT p-value'</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">parse_pval</span><span class="p">)</span>

<span class="c1">#  Plot settings</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>

<span class="c1">#  Plotting function for a single medication group</span>
<span class="k">def</span> <span class="nf">plot_single_group</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    
    <span class="n">bars1</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="o">-</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">'Mean Control'</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> 
                   <span class="n">yerr</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">'SE Control'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">'Control'</span><span class="p">,</span> <span class="n">hatch</span><span class="o">=</span><span class="s1">'//'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">bars2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="o">+</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">'Mean Treated'</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> 
                   <span class="n">yerr</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">'SE Treated'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">'Treated'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'steelblue'</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

    <span class="n">label</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">"ATT = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'ATT Estimate'</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span>
        <span class="sa">f</span><span class="s2">"d = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'Cohen d'</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, p = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'ATT p-value'</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span>
        <span class="sa">f</span><span class="s2">"nT = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'n Treated'</span><span class="p">]</span><span class="si">}</span><span class="s2">, nC = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'n Control'</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span>
        <span class="sa">f</span><span class="s2">"E = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'E (Unadjusted)'</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%"</span>
    <span class="p">)</span>
    <span class="n">max_y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">'Mean Control'</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">'Mean Treated'</span><span class="p">])</span> <span class="o">+</span> <span class="mf">1.5</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_y</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">'center'</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">'bottom'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'#FFD700'</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'black'</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="o">-</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">+</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">'Control'</span><span class="p">,</span> <span class="s1">'Treated'</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Group: </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'Medication Group'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">'bold'</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"CAPS5 Change Score"</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="n">max_y</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">fig</span>

<span class="c1">#  Generate and save all plots into a multi-page PDF</span>
<span class="k">with</span> <span class="n">PdfPages</span><span class="p">(</span><span class="s2">"ols_att_barplot_subcat.pdf"</span><span class="p">)</span> <span class="k">as</span> <span class="n">pdf</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">final_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_single_group</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="n">pdf</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">'tight'</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">" ols_att_barplot_subcat saved"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre> ols_att_barplot_subcat saved
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=8088e735-50ea-4250-913d-d259ae773864">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[249]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Love plot:</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=f84dd49c-2e5e-4323-926a-03c6450de68c">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[250]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="c1"># ----------------------------------------</span>
<span class="c1"># Functions to calculate balance</span>
<span class="c1"># ----------------------------------------</span>
<span class="k">def</span> <span class="nf">calculate_smd</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">w1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">w2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">weighted_mean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span> <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">weighted_var</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">m</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
    
    <span class="n">m1</span> <span class="o">=</span> <span class="n">weighted_mean</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">w1</span><span class="p">)</span> <span class="k">if</span> <span class="n">w1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
    <span class="n">m2</span> <span class="o">=</span> <span class="n">weighted_mean</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span> <span class="k">if</span> <span class="n">w2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">weighted_var</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">w1</span><span class="p">)</span> <span class="k">if</span> <span class="n">w1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">weighted_var</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span> <span class="k">if</span> <span class="n">w2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">pooled_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">v1</span> <span class="o">+</span> <span class="n">v2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">m1</span> <span class="o">-</span> <span class="n">m2</span><span class="p">)</span> <span class="o">/</span> <span class="n">pooled_sd</span> <span class="k">if</span> <span class="n">pooled_sd</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">variance_ratio</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">w1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">w2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">weighted_var</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">m</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
    
    <span class="n">v1</span> <span class="o">=</span> <span class="n">weighted_var</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">w1</span><span class="p">)</span> <span class="k">if</span> <span class="n">w1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">weighted_var</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span> <span class="k">if</span> <span class="n">w2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">v1</span> <span class="o">/</span> <span class="n">v2</span><span class="p">,</span> <span class="n">v2</span> <span class="o">/</span> <span class="n">v1</span><span class="p">)</span> <span class="k">if</span> <span class="n">v1</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">v2</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>

<span class="c1"># ----------------------------------------</span>
<span class="c1"># Setup</span>
<span class="c1"># ----------------------------------------</span>
<span class="n">output_base</span> <span class="o">=</span> <span class="s2">"outputs"</span>
<span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">output_base</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">g</span><span class="p">))]</span>

<span class="c1"># Create a case-insensitive mapping</span>
<span class="n">final_covariates_map_lower</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="c1"># ----------------------------------------</span>
<span class="c1"># Main Loop</span>
<span class="c1"># ----------------------------------------</span>
<span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">group</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_covariates_map_lower</span><span class="p">:</span>
        <span class="k">continue</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Processing </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">..."</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">group_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">covariates</span> <span class="o">=</span> <span class="n">final_covariates_map_lower</span><span class="p">[</span><span class="n">group</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        
        <span class="n">column_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="s2">"trimmed_data_imp1.pkl"</span><span class="p">))</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">group</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">column_name</span> <span class="o">=</span> <span class="n">col</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">column_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Column not found for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">, skipping."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">smd_unw_all</span><span class="p">,</span> <span class="n">smd_w_all</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">vr_unw_all</span><span class="p">,</span> <span class="n">vr_w_all</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
            <span class="n">df_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"trimmed_data_imp</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.pkl"</span><span class="p">)</span>
            <span class="n">iptw_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="s2">"iptw_weights.xlsx"</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">df_path</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">iptw_path</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Missing data for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> imp</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, skipping."</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">df_path</span><span class="p">)</span>
            <span class="n">iptw_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">iptw_path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span>
            <span class="n">W</span> <span class="o">=</span> <span class="n">iptw_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s2">"iptw_mean"</span><span class="p">]</span>

            <span class="n">smd_unw_i</span><span class="p">,</span> <span class="n">smd_w_i</span><span class="p">,</span> <span class="n">vr_unw_i</span><span class="p">,</span> <span class="n">vr_w_i</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">cov</span> <span class="ow">in</span> <span class="n">covariates</span><span class="p">:</span>
                <span class="n">x1</span><span class="p">,</span> <span class="n">x0</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cov</span><span class="p">],</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cov</span><span class="p">]</span>
                <span class="n">w1</span><span class="p">,</span> <span class="n">w0</span> <span class="o">=</span> <span class="n">W</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">],</span> <span class="n">W</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>

                <span class="n">su</span> <span class="o">=</span> <span class="n">calculate_smd</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x0</span><span class="p">)</span>
                <span class="n">sw</span> <span class="o">=</span> <span class="n">calculate_smd</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">w0</span><span class="p">)</span>

                <span class="n">vu</span> <span class="o">=</span> <span class="n">variance_ratio</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x0</span><span class="p">)</span> <span class="k">if</span> <span class="n">cov</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">]</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">vw</span> <span class="o">=</span> <span class="n">variance_ratio</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">w0</span><span class="p">)</span> <span class="k">if</span> <span class="n">cov</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">]</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

                <span class="n">smd_unw_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">su</span><span class="p">)</span>
                <span class="n">smd_w_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sw</span><span class="p">)</span>
                <span class="n">vr_unw_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vu</span><span class="p">)</span>
                <span class="n">vr_w_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vw</span><span class="p">)</span>

            <span class="n">smd_unw_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smd_unw_i</span><span class="p">)</span>
            <span class="n">smd_w_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smd_w_i</span><span class="p">)</span>
            <span class="n">vr_unw_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vr_unw_i</span><span class="p">)</span>
            <span class="n">vr_w_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vr_w_i</span><span class="p">)</span>

        <span class="n">smd_unw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">smd_unw_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">smd_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">smd_w_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">vr_unw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">vr_unw_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">vr_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">vr_w_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">severity</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sw</span> <span class="ow">in</span> <span class="n">smd_w</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sw</span> <span class="o">&lt;=</span> <span class="mf">0.1</span><span class="p">:</span>
                <span class="n">severity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"Good"</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">sw</span> <span class="o">&lt;=</span> <span class="mf">0.2</span><span class="p">:</span>
                <span class="n">severity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"Moderate"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">severity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"Poor"</span><span class="p">)</span>

        <span class="n">covariate_names</span> <span class="o">=</span> <span class="n">covariates</span>
        <span class="n">numeric_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s2">"Covariate"</span><span class="p">:</span> <span class="n">covariate_names</span><span class="p">,</span>
            <span class="s2">"SMD_Unweighted"</span><span class="p">:</span> <span class="n">smd_unw</span><span class="p">,</span>
            <span class="s2">"SMD_Weighted"</span><span class="p">:</span> <span class="n">smd_w</span><span class="p">,</span>
            <span class="s2">"Imbalance_Severity"</span><span class="p">:</span> <span class="n">severity</span><span class="p">,</span>
            <span class="s2">"VR_Unweighted"</span><span class="p">:</span> <span class="n">vr_unw</span><span class="p">,</span>
            <span class="s2">"VR_Weighted"</span><span class="p">:</span> <span class="n">vr_w</span>
        <span class="p">})</span>

        <span class="n">numeric_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"covariate_balance_table_</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">.xlsx"</span><span class="p">)</span>
        <span class="n">numeric_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">numeric_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Exported numeric summary to: </span><span class="si">{</span><span class="n">numeric_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># -------------------------</span>
        <span class="c1"># Plot</span>
        <span class="c1"># -------------------------</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">covariates</span>
        <span class="n">y_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.45</span><span class="p">))</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">smd_unw</span><span class="p">,</span> <span class="n">y_pos</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Unweighted"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">smd_w</span><span class="p">,</span> <span class="n">y_pos</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'blue'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Weighted"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Threshold 0.1"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'black'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Threshold 0.2"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">smd_unw</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">smd_w</span><span class="p">),</span> <span class="mf">0.25</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">y_pos</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Standardized Mean Differences (SMD)"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">"upper right"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">vr_mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">cov</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">]</span> <span class="k">for</span> <span class="n">cov</span> <span class="ow">in</span> <span class="n">covariates</span><span class="p">]</span>
        <span class="n">filtered_y</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vr_mask</span><span class="p">)</span> <span class="k">if</span> <span class="n">b</span><span class="p">]</span>
        <span class="n">filtered_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">filtered_y</span><span class="p">]</span>
        <span class="n">filtered_vr_unw</span> <span class="o">=</span> <span class="p">[</span><span class="n">vr_unw</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">filtered_y</span><span class="p">]</span>
        <span class="n">filtered_vr_w</span> <span class="o">=</span> <span class="p">[</span><span class="n">vr_w</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">filtered_y</span><span class="p">]</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">filtered_vr_unw</span><span class="p">,</span> <span class="n">filtered_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'blue'</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">'o'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Unweighted"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">filtered_vr_w</span><span class="p">,</span> <span class="n">filtered_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">'x'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Weighted"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">filtered_vr_unw</span> <span class="o">+</span> <span class="n">filtered_vr_w</span> <span class="o">+</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">])</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">filtered_y</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">filtered_labels</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Variance Ratio (VR)"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Covariate Balance for </span><span class="si">{</span><span class="n">group</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'CAT_'</span><span class="p">,</span><span class="w"> </span><span class="s1">''</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">'bold'</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.96</span><span class="p">])</span>
        <span class="n">plot_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"love_plot_</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">.pdf"</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Saved love plot: </span><span class="si">{</span><span class="n">plot_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Max weighted SMD for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">smd_w</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Processing SUBCAT_Amfetaminen...
 Exported numeric summary to: outputs\SUBCAT_Amfetaminen\covariate_balance_table_SUBCAT_Amfetaminen.xlsx
 Saved love plot: outputs\SUBCAT_Amfetaminen\love_plot_SUBCAT_Amfetaminen.pdf
 Max weighted SMD for SUBCAT_Amfetaminen: 0.705

 Processing SUBCAT_Antidepressiva_Overige...
 Exported numeric summary to: outputs\SUBCAT_Antidepressiva_Overige\covariate_balance_table_SUBCAT_Antidepressiva_Overige.xlsx
 Saved love plot: outputs\SUBCAT_Antidepressiva_Overige\love_plot_SUBCAT_Antidepressiva_Overige.pdf
 Max weighted SMD for SUBCAT_Antidepressiva_Overige: 0.949

 Processing SUBCAT_Antipsychotica_Atypisch...
 Exported numeric summary to: outputs\SUBCAT_Antipsychotica_Atypisch\covariate_balance_table_SUBCAT_Antipsychotica_Atypisch.xlsx
 Saved love plot: outputs\SUBCAT_Antipsychotica_Atypisch\love_plot_SUBCAT_Antipsychotica_Atypisch.pdf
 Max weighted SMD for SUBCAT_Antipsychotica_Atypisch: 0.679

 Processing SUBCAT_Anti_Epileptica_Stemmingsstabilisatoren...
 Exported numeric summary to: outputs\SUBCAT_Anti_Epileptica_Stemmingsstabilisatoren\covariate_balance_table_SUBCAT_Anti_Epileptica_Stemmingsstabilisatoren.xlsx
 Saved love plot: outputs\SUBCAT_Anti_Epileptica_Stemmingsstabilisatoren\love_plot_SUBCAT_Anti_Epileptica_Stemmingsstabilisatoren.pdf
 Max weighted SMD for SUBCAT_Anti_Epileptica_Stemmingsstabilisatoren: 0.232

 Processing SUBCAT_Anxiolytica_Benzodiazepine...
 Exported numeric summary to: outputs\SUBCAT_Anxiolytica_Benzodiazepine\covariate_balance_table_SUBCAT_Anxiolytica_Benzodiazepine.xlsx
 Saved love plot: outputs\SUBCAT_Anxiolytica_Benzodiazepine\love_plot_SUBCAT_Anxiolytica_Benzodiazepine.pdf
 Max weighted SMD for SUBCAT_Anxiolytica_Benzodiazepine: 0.197

 Processing SUBCAT_Hypnotica_Benzodiazepine...
 Exported numeric summary to: outputs\SUBCAT_Hypnotica_Benzodiazepine\covariate_balance_table_SUBCAT_Hypnotica_Benzodiazepine.xlsx
 Saved love plot: outputs\SUBCAT_Hypnotica_Benzodiazepine\love_plot_SUBCAT_Hypnotica_Benzodiazepine.pdf
 Max weighted SMD for SUBCAT_Hypnotica_Benzodiazepine: 0.166

 Processing SUBCAT_Nsaids...
 Exported numeric summary to: outputs\SUBCAT_Nsaids\covariate_balance_table_SUBCAT_Nsaids.xlsx
 Saved love plot: outputs\SUBCAT_Nsaids\love_plot_SUBCAT_Nsaids.pdf
 Max weighted SMD for SUBCAT_Nsaids: 0.520

 Processing SUBCAT_Opioden...
 Exported numeric summary to: outputs\SUBCAT_Opioden\covariate_balance_table_SUBCAT_Opioden.xlsx
 Saved love plot: outputs\SUBCAT_Opioden\love_plot_SUBCAT_Opioden.pdf
 Max weighted SMD for SUBCAT_Opioden: 0.484

 Processing SUBCAT_Paracetamol_Mono...
 Exported numeric summary to: outputs\SUBCAT_Paracetamol_Mono\covariate_balance_table_SUBCAT_Paracetamol_Mono.xlsx
 Saved love plot: outputs\SUBCAT_Paracetamol_Mono\love_plot_SUBCAT_Paracetamol_Mono.pdf
 Max weighted SMD for SUBCAT_Paracetamol_Mono: 0.664

 Processing SUBCAT_Snri...
 Exported numeric summary to: outputs\SUBCAT_Snri\covariate_balance_table_SUBCAT_Snri.xlsx
 Saved love plot: outputs\SUBCAT_Snri\love_plot_SUBCAT_Snri.pdf
 Max weighted SMD for SUBCAT_Snri: 0.323

 Processing SUBCAT_Ssri...
 Exported numeric summary to: outputs\SUBCAT_Ssri\covariate_balance_table_SUBCAT_Ssri.xlsx
 Saved love plot: outputs\SUBCAT_Ssri\love_plot_SUBCAT_Ssri.pdf
 Max weighted SMD for SUBCAT_Ssri: 0.240

 Processing SUBCAT_Systemische_Antihistaminica...
 Exported numeric summary to: outputs\SUBCAT_Systemische_Antihistaminica\covariate_balance_table_SUBCAT_Systemische_Antihistaminica.xlsx
 Saved love plot: outputs\SUBCAT_Systemische_Antihistaminica\love_plot_SUBCAT_Systemische_Antihistaminica.pdf
 Max weighted SMD for SUBCAT_Systemische_Antihistaminica: 0.465

 Processing SUBCAT_Tca...
 Exported numeric summary to: outputs\SUBCAT_Tca\covariate_balance_table_SUBCAT_Tca.xlsx
 Saved love plot: outputs\SUBCAT_Tca\love_plot_SUBCAT_Tca.pdf
 Max weighted SMD for SUBCAT_Tca: 0.307

 Processing SUBCAT_Tetracyclische_Antidepressiva...
 Exported numeric summary to: outputs\SUBCAT_Tetracyclische_Antidepressiva\covariate_balance_table_SUBCAT_Tetracyclische_Antidepressiva.xlsx
 Saved love plot: outputs\SUBCAT_Tetracyclische_Antidepressiva\love_plot_SUBCAT_Tetracyclische_Antidepressiva.pdf
 Max weighted SMD for SUBCAT_Tetracyclische_Antidepressiva: 0.314

 Processing SUBCAT_Z_Drugs...
 Exported numeric summary to: outputs\SUBCAT_Z_Drugs\covariate_balance_table_SUBCAT_Z_Drugs.xlsx
 Saved love plot: outputs\SUBCAT_Z_Drugs\love_plot_SUBCAT_Z_Drugs.pdf
 Max weighted SMD for SUBCAT_Z_Drugs: 0.367
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=633fd988-7a59-468d-895b-e92529e96f0b">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[251]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Heatmap:</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=e954a5bc-a137-481e-a44f-92ed766c8abf">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[252]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="c1">#-----------------------------</span>
<span class="c1"># Generate heatmaps</span>
<span class="c1"># -------------------------------</span>
<span class="k">for</span> <span class="n">treatment_var</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">========== Creating Heatmap for </span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s2"> =========="</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">'outputs'</span><span class="p">,</span> <span class="n">treatment_var</span><span class="p">)</span>
        <span class="n">balance_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'covariate_balance_table_</span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s1">.xlsx'</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">balance_path</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Balance file not found: </span><span class="si">{</span><span class="n">balance_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">balance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">balance_path</span><span class="p">)</span>

        <span class="c1">#  Use finalized covariates + 'Propensity Score'</span>
        <span class="n">covariates</span> <span class="o">=</span> <span class="n">final_covariates_map</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">'Propensity Score'</span><span class="p">]</span>
        <span class="n">balance_df</span> <span class="o">=</span> <span class="n">balance_df</span><span class="p">[</span><span class="n">balance_df</span><span class="p">[</span><span class="s1">'Covariate'</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">covariates</span><span class="p">)]</span>

        <span class="c1">#  Check for CAPS5score_baseline</span>
        <span class="n">highlight_caps</span> <span class="o">=</span> <span class="s1">'CAPS5score_baseline'</span> <span class="ow">in</span> <span class="n">balance_df</span><span class="p">[</span><span class="s1">'Covariate'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="c1">#  Format for heatmap</span>
        <span class="n">heatmap_df</span> <span class="o">=</span> <span class="n">balance_df</span><span class="p">[[</span><span class="s1">'Covariate'</span><span class="p">,</span> <span class="s1">'SMD_Unweighted'</span><span class="p">,</span> <span class="s1">'SMD_Weighted'</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">heatmap_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'Covariate'</span><span class="p">,</span> <span class="s1">'Unweighted'</span><span class="p">,</span> <span class="s1">'Weighted'</span><span class="p">]</span>
        <span class="n">heatmap_df</span> <span class="o">=</span> <span class="n">heatmap_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">'Covariate'</span><span class="p">)</span>
        <span class="n">heatmap_df</span> <span class="o">=</span> <span class="n">heatmap_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">'Unweighted'</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1">#  Plot</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">heatmap_df</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.35</span><span class="p">)))</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span>
            <span class="n">heatmap_df</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="s2">"coolwarm"</span><span class="p">,</span>
            <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">fmt</span><span class="o">=</span><span class="s2">".2f"</span><span class="p">,</span>
            <span class="n">linewidths</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
            <span class="n">linecolor</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span>
            <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">"label"</span><span class="p">:</span> <span class="s2">"Standardized Mean Difference"</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Covariate Balance Heatmap (Rubin IPTW)</span><span class="se">\n</span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">'bold'</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Condition"</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"Covariate"</span><span class="p">)</span>

        <span class="c1">#  Bold CAPS5score_baseline if present</span>
        <span class="k">if</span> <span class="n">highlight_caps</span><span class="p">:</span>
            <span class="n">ylabels</span> <span class="o">=</span> <span class="p">[</span><span class="n">label</span><span class="o">.</span><span class="n">get_text</span><span class="p">()</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span>
                <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2"> "</span> <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="s1">'CAPS5score_baseline'</span> <span class="k">else</span> <span class="n">label</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ylabels</span>
            <span class="p">])</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="c1">#  Save image</span>
        <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'heatmap_smd_</span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s1">.png'</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Heatmap saved: </span><span class="si">{</span><span class="n">save_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error processing </span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
========== Creating Heatmap for SUBCAT_Antipsychotica_atypisch ==========
 Heatmap saved: outputs\SUBCAT_Antipsychotica_atypisch\heatmap_smd_SUBCAT_Antipsychotica_atypisch.png

========== Creating Heatmap for SUBCAT_TCA ==========
 Heatmap saved: outputs\SUBCAT_TCA\heatmap_smd_SUBCAT_TCA.png

========== Creating Heatmap for SUBCAT_SSRI ==========
 Heatmap saved: outputs\SUBCAT_SSRI\heatmap_smd_SUBCAT_SSRI.png

========== Creating Heatmap for SUBCAT_SNRI ==========
 Heatmap saved: outputs\SUBCAT_SNRI\heatmap_smd_SUBCAT_SNRI.png

========== Creating Heatmap for SUBCAT_Tetracyclische_antidepressiva ==========
 Heatmap saved: outputs\SUBCAT_Tetracyclische_antidepressiva\heatmap_smd_SUBCAT_Tetracyclische_antidepressiva.png

========== Creating Heatmap for SUBCAT_Antidepressiva_overige ==========
 Heatmap saved: outputs\SUBCAT_Antidepressiva_overige\heatmap_smd_SUBCAT_Antidepressiva_overige.png

========== Creating Heatmap for SUBCAT_Systemische_antihistaminica ==========
 Heatmap saved: outputs\SUBCAT_Systemische_antihistaminica\heatmap_smd_SUBCAT_Systemische_antihistaminica.png

========== Creating Heatmap for SUBCAT_anxiolytica_Benzodiazepine ==========
 Heatmap saved: outputs\SUBCAT_anxiolytica_Benzodiazepine\heatmap_smd_SUBCAT_anxiolytica_Benzodiazepine.png

========== Creating Heatmap for SUBCAT_hypnotica_Benzodiazepine ==========
 Heatmap saved: outputs\SUBCAT_hypnotica_Benzodiazepine\heatmap_smd_SUBCAT_hypnotica_Benzodiazepine.png

========== Creating Heatmap for SUBCAT_Amfetaminen ==========
 Heatmap saved: outputs\SUBCAT_Amfetaminen\heatmap_smd_SUBCAT_Amfetaminen.png

========== Creating Heatmap for SUBCAT_Paracetamol_mono ==========
 Heatmap saved: outputs\SUBCAT_Paracetamol_mono\heatmap_smd_SUBCAT_Paracetamol_mono.png

========== Creating Heatmap for SUBCAT_Anti_epileptica_stemmingsstabilisatoren ==========
 Heatmap saved: outputs\SUBCAT_Anti_epileptica_stemmingsstabilisatoren\heatmap_smd_SUBCAT_Anti_epileptica_stemmingsstabilisatoren.png

========== Creating Heatmap for SUBCAT_Opioden ==========
 Heatmap saved: outputs\SUBCAT_Opioden\heatmap_smd_SUBCAT_Opioden.png

========== Creating Heatmap for SUBCAT_Z_drugs ==========
 Heatmap saved: outputs\SUBCAT_Z_drugs\heatmap_smd_SUBCAT_Z_drugs.png

========== Creating Heatmap for SUBCAT_NSAIDs ==========
 Heatmap saved: outputs\SUBCAT_NSAIDs\heatmap_smd_SUBCAT_NSAIDs.png
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=03725ea3-1967-48cf-a8ae-acabff5ac054">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span> 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=feef0543-716d-47ca-a887-00fcb78c5521">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="SubSubCat-Analysis:">SubSubCat Analysis:<a class="anchor-link" href="#SubSubCat-Analysis:"></a></h3>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=384b36ab-32ce-40e7-a2ad-4ea810f87841">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[253]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">covariates_SubSubCat_Oxazepam</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span> <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SubSubCat_Diazepam</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span> <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_SubSubCat_Paracetamol</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SubSubCat_Lorazepam</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span> <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SubSubCat_Mirtazapine</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SubSubCat_Escitalopram</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_SubSubCat_Sertraline</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SubSubCat_Temazepam</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span> <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SubSubCat_Citalopram</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SubSubCat_Quetiapine</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>




<span class="n">covariates_SubSubCat_Amitriptyline</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>


<span class="n">covariates_SubSubCat_Venlafaxine</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SubSubCat_Fluoxetine</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SubSubCat_Topiramaat</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>




<span class="n">covariates_SubSubCat_Zopiclon</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>










<span class="n">covariates_SubSubCat_Bupropion</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SubSubCat_Methylfenidaat</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span>
    <span class="s1">'CAT_Antipsychotica'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span>
    <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>

<span class="n">covariates_SubSubCat_Olanzapine</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span>
    <span class="s1">'CAT_Antidepressiva'</span><span class="p">,</span>
    <span class="s1">'CAT_Benzodiazepine'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_CHILDHOOD_TRAUMA'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_CPTSD'</span><span class="p">,</span> <span class="s1">'DIAGNOSIS_SEXUAL_TRAUMA'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUICIDALITY'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_ANXIETY_OCD'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_PSYCHOTIC'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_EATING_DISORDER'</span><span class="p">,</span>
    <span class="s1">'DIAGNOSIS_SUBSTANCE_DISORDER'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_1'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_2'</span><span class="p">,</span> <span class="s1">'SDV_SEXE_3'</span><span class="p">,</span> <span class="s2">"EB_TRAUMA_FOCUSED_THERAPY"</span><span class="p">,</span>
    <span class="s2">"Bipolar_and_Mood_disorder"</span><span class="p">,</span> <span class="s2">"ethnicity_Dutch"</span><span class="p">,</span> <span class="s2">"ethnicity_other"</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=7be2d6fd-69da-43e9-b686-89d57f72036d">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[254]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="c1"># This finds all variables that start with covariates_SUbSubCAT_ or covariates_SubSubcat_</span>
<span class="n">final_covariates_map</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<span class="n">final_covariates_map</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
    <span class="n">var</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"covariates_"</span><span class="p">,</span> <span class="s2">""</span><span class="p">):</span> <span class="n">val</span>
    <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"covariates_subsubcat_"</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
<span class="p">})</span>

<span class="c1"># Show detected group names</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Groups found:"</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
<span class="n">medication_groups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">medication_groups</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Groups found: ['SubSubCat_Oxazepam', 'SubSubCat_Diazepam', 'SubSubCat_Paracetamol', 'SubSubCat_Lorazepam', 'SubSubCat_Mirtazapine', 'SubSubCat_Escitalopram', 'SubSubCat_Sertraline', 'SubSubCat_Temazepam', 'SubSubCat_Citalopram', 'SubSubCat_Quetiapine', 'SubSubCat_Amitriptyline', 'SubSubCat_Venlafaxine', 'SubSubCat_Fluoxetine', 'SubSubCat_Topiramaat', 'SubSubCat_Zopiclon', 'SubSubCat_Bupropion', 'SubSubCat_Methylfenidaat', 'SubSubCat_Olanzapine']
['SubSubCat_Oxazepam', 'SubSubCat_Diazepam', 'SubSubCat_Paracetamol', 'SubSubCat_Lorazepam', 'SubSubCat_Mirtazapine', 'SubSubCat_Escitalopram', 'SubSubCat_Sertraline', 'SubSubCat_Temazepam', 'SubSubCat_Citalopram', 'SubSubCat_Quetiapine', 'SubSubCat_Amitriptyline', 'SubSubCat_Venlafaxine', 'SubSubCat_Fluoxetine', 'SubSubCat_Topiramaat', 'SubSubCat_Zopiclon', 'SubSubCat_Bupropion', 'SubSubCat_Methylfenidaat', 'SubSubCat_Olanzapine']
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=8407653a-734f-44e5-bc41-aeea94992c95">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[255]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>


<span class="k">def</span> <span class="nf">run_all_SUBSUBCAT_group_models</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Runs downstream analysis for each SUBSUBCAT medisubsubcation group using imputed datasets.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - imputed_dfs: list of 5 imputed DataFrames (from df_imputed_final_imp1.pkl ... imp5.pkl)</span>
<span class="sd">    </span>
<span class="sd">    Notes:</span>
<span class="sd">    - Covariate lists must be defined as global variables: covariates_subsubcat_&lt;group&gt;</span>
<span class="sd">    - Outputs are saved in: outputs/SUBSUBCAT_&lt;GROUP&gt;/</span>
<span class="sd">    """</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">" Starting analysis for all SUBSUBCAT groups"</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">var_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"covariates_subsubcat_"</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">globals</span><span class="p">()[</span><span class="n">var_name</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">group_name</span> <span class="o">=</span> <span class="n">var_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"covariates_"</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
            <span class="n">group_name</span> <span class="o">=</span> <span class="n">group_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"_"</span><span class="p">,</span> <span class="s2">" "</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">" "</span><span class="p">,</span> <span class="s2">"_"</span><span class="p">)</span>  <span class="c1"># e.g., subsubcat_z_drugs  Subsubcat_Z_Drugs</span>
            <span class="n">group_name</span> <span class="o">=</span> <span class="n">group_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"Subsubcat_"</span><span class="p">,</span> <span class="s2">"SUBSUBCAT_"</span><span class="p">)</span>  <span class="c1"># force prefix to uppercase</span>

            <span class="n">covariates</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()[</span><span class="n">var_name</span><span class="p">]</span>
            <span class="n">output_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"outputs/</span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">"</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Processing </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">..."</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">df_imp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   Using imputation </span><span class="si">{</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

                <span class="c1"># Define X and Y</span>
                <span class="n">X</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span>
                <span class="n">Y</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="s2">"caps5_change_baseline"</span><span class="p">]</span>

                <span class="c1"># === Save X and Y as placeholder (replace with modeling later)</span>
                <span class="n">X</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/X_imp</span><span class="si">{</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.csv"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">Y</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"Y"</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/Y_imp</span><span class="si">{</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.csv"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Done: </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> All SUBSUBCAT group analyses complete."</span><span class="p">)</span>

<span class="c1"># ========= STEP 4: Execute ========= #</span>
<span class="n">run_all_SUBSUBCAT_group_models</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre> Starting analysis for all SUBSUBCAT groups

 Processing SUBSUBCAT_Oxazepam...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Oxazepam

 Processing SUBSUBCAT_Diazepam...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Diazepam

 Processing SUBSUBCAT_Paracetamol...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Paracetamol

 Processing SUBSUBCAT_Lorazepam...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Lorazepam

 Processing SUBSUBCAT_Mirtazapine...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Mirtazapine

 Processing SUBSUBCAT_Escitalopram...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Escitalopram

 Processing SUBSUBCAT_Sertraline...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Sertraline

 Processing SUBSUBCAT_Temazepam...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Temazepam

 Processing SUBSUBCAT_Citalopram...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Citalopram

 Processing SUBSUBCAT_Quetiapine...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Quetiapine

 Processing SUBSUBCAT_Amitriptyline...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Amitriptyline

 Processing SUBSUBCAT_Venlafaxine...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Venlafaxine

 Processing SUBSUBCAT_Fluoxetine...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Fluoxetine

 Processing SUBSUBCAT_Topiramaat...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Topiramaat

 Processing SUBSUBCAT_Zopiclon...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Zopiclon

 Processing SUBSUBCAT_Bupropion...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Bupropion

 Processing SUBSUBCAT_Methylfenidaat...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Methylfenidaat

 Processing SUBSUBCAT_Olanzapine...
   Using imputation 1
   Using imputation 2
   Using imputation 3
   Using imputation 4
   Using imputation 5
 Done: SUBSUBCAT_Olanzapine

 All SUBSUBCAT group analyses complete.
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=a3f192e5-b4a6-42ed-98ee-0183e20212b1">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[256]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">treatment_var</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">treatment_var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Imp </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">:  Not found in columns."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">treated</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">control</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Imp </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: Treated = </span><span class="si">{</span><span class="n">treated</span><span class="si">}</span><span class="s2">, Control = </span><span class="si">{</span><span class="n">control</span><span class="si">}</span><span class="s2">, Missing = </span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 SubSubCat_Oxazepam
  Imp 1: Treated = 206, Control = 3435, Missing = 0
  Imp 2: Treated = 206, Control = 3435, Missing = 0
  Imp 3: Treated = 206, Control = 3435, Missing = 0
  Imp 4: Treated = 206, Control = 3435, Missing = 0
  Imp 5: Treated = 206, Control = 3435, Missing = 0

 SubSubCat_Diazepam
  Imp 1: Treated = 42, Control = 3599, Missing = 0
  Imp 2: Treated = 42, Control = 3599, Missing = 0
  Imp 3: Treated = 42, Control = 3599, Missing = 0
  Imp 4: Treated = 42, Control = 3599, Missing = 0
  Imp 5: Treated = 42, Control = 3599, Missing = 0

 SubSubCat_Paracetamol
  Imp 1: Treated = 43, Control = 3598, Missing = 0
  Imp 2: Treated = 43, Control = 3598, Missing = 0
  Imp 3: Treated = 43, Control = 3598, Missing = 0
  Imp 4: Treated = 43, Control = 3598, Missing = 0
  Imp 5: Treated = 43, Control = 3598, Missing = 0

 SubSubCat_Lorazepam
  Imp 1: Treated = 67, Control = 3574, Missing = 0
  Imp 2: Treated = 67, Control = 3574, Missing = 0
  Imp 3: Treated = 67, Control = 3574, Missing = 0
  Imp 4: Treated = 67, Control = 3574, Missing = 0
  Imp 5: Treated = 67, Control = 3574, Missing = 0

 SubSubCat_Mirtazapine
  Imp 1: Treated = 87, Control = 3554, Missing = 0
  Imp 2: Treated = 87, Control = 3554, Missing = 0
  Imp 3: Treated = 87, Control = 3554, Missing = 0
  Imp 4: Treated = 87, Control = 3554, Missing = 0
  Imp 5: Treated = 87, Control = 3554, Missing = 0

 SubSubCat_Escitalopram
  Imp 1: Treated = 69, Control = 3572, Missing = 0
  Imp 2: Treated = 69, Control = 3572, Missing = 0
  Imp 3: Treated = 69, Control = 3572, Missing = 0
  Imp 4: Treated = 69, Control = 3572, Missing = 0
  Imp 5: Treated = 69, Control = 3572, Missing = 0

 SubSubCat_Sertraline
  Imp 1: Treated = 102, Control = 3539, Missing = 0
  Imp 2: Treated = 102, Control = 3539, Missing = 0
  Imp 3: Treated = 102, Control = 3539, Missing = 0
  Imp 4: Treated = 102, Control = 3539, Missing = 0
  Imp 5: Treated = 102, Control = 3539, Missing = 0

 SubSubCat_Temazepam
  Imp 1: Treated = 93, Control = 3548, Missing = 0
  Imp 2: Treated = 93, Control = 3548, Missing = 0
  Imp 3: Treated = 93, Control = 3548, Missing = 0
  Imp 4: Treated = 93, Control = 3548, Missing = 0
  Imp 5: Treated = 93, Control = 3548, Missing = 0

 SubSubCat_Citalopram
  Imp 1: Treated = 125, Control = 3516, Missing = 0
  Imp 2: Treated = 125, Control = 3516, Missing = 0
  Imp 3: Treated = 125, Control = 3516, Missing = 0
  Imp 4: Treated = 125, Control = 3516, Missing = 0
  Imp 5: Treated = 125, Control = 3516, Missing = 0

 SubSubCat_Quetiapine
  Imp 1: Treated = 203, Control = 3438, Missing = 0
  Imp 2: Treated = 203, Control = 3438, Missing = 0
  Imp 3: Treated = 203, Control = 3438, Missing = 0
  Imp 4: Treated = 203, Control = 3438, Missing = 0
  Imp 5: Treated = 203, Control = 3438, Missing = 0

 SubSubCat_Amitriptyline
  Imp 1: Treated = 52, Control = 3589, Missing = 0
  Imp 2: Treated = 52, Control = 3589, Missing = 0
  Imp 3: Treated = 52, Control = 3589, Missing = 0
  Imp 4: Treated = 52, Control = 3589, Missing = 0
  Imp 5: Treated = 52, Control = 3589, Missing = 0

 SubSubCat_Venlafaxine
  Imp 1: Treated = 59, Control = 3582, Missing = 0
  Imp 2: Treated = 59, Control = 3582, Missing = 0
  Imp 3: Treated = 59, Control = 3582, Missing = 0
  Imp 4: Treated = 59, Control = 3582, Missing = 0
  Imp 5: Treated = 59, Control = 3582, Missing = 0

 SubSubCat_Fluoxetine
  Imp 1: Treated = 71, Control = 3570, Missing = 0
  Imp 2: Treated = 71, Control = 3570, Missing = 0
  Imp 3: Treated = 71, Control = 3570, Missing = 0
  Imp 4: Treated = 71, Control = 3570, Missing = 0
  Imp 5: Treated = 71, Control = 3570, Missing = 0

 SubSubCat_Topiramaat
  Imp 1: Treated = 41, Control = 3600, Missing = 0
  Imp 2: Treated = 41, Control = 3600, Missing = 0
  Imp 3: Treated = 41, Control = 3600, Missing = 0
  Imp 4: Treated = 41, Control = 3600, Missing = 0
  Imp 5: Treated = 41, Control = 3600, Missing = 0

 SubSubCat_Zopiclon
  Imp 1: Treated = 32, Control = 3609, Missing = 0
  Imp 2: Treated = 32, Control = 3609, Missing = 0
  Imp 3: Treated = 32, Control = 3609, Missing = 0
  Imp 4: Treated = 32, Control = 3609, Missing = 0
  Imp 5: Treated = 32, Control = 3609, Missing = 0

 SubSubCat_Bupropion
  Imp 1: Treated = 34, Control = 3607, Missing = 0
  Imp 2: Treated = 34, Control = 3607, Missing = 0
  Imp 3: Treated = 34, Control = 3607, Missing = 0
  Imp 4: Treated = 34, Control = 3607, Missing = 0
  Imp 5: Treated = 34, Control = 3607, Missing = 0

 SubSubCat_Methylfenidaat
  Imp 1: Treated = 38, Control = 3603, Missing = 0
  Imp 2: Treated = 38, Control = 3603, Missing = 0
  Imp 3: Treated = 38, Control = 3603, Missing = 0
  Imp 4: Treated = 38, Control = 3603, Missing = 0
  Imp 5: Treated = 38, Control = 3603, Missing = 0

 SubSubCat_Olanzapine
  Imp 1: Treated = 33, Control = 3608, Missing = 0
  Imp 2: Treated = 33, Control = 3608, Missing = 0
  Imp 3: Treated = 33, Control = 3608, Missing = 0
  Imp 4: Treated = 33, Control = 3608, Missing = 0
  Imp 5: Treated = 33, Control = 3608, Missing = 0
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=1735200e-f051-4982-b69a-62345955e88e">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[257]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">from</span> <span class="nn">statsmodels.stats.outliers_influence</span> <span class="kn">import</span> <span class="n">variance_inflation_factor</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="c1">#  VIF computation function</span>
<span class="k">def</span> <span class="nf">compute_vif</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">has_constant</span><span class="o">=</span><span class="s1">'add'</span><span class="p">)</span>
    <span class="n">vif_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">vif_df</span><span class="p">[</span><span class="s2">"variable"</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span>
    <span class="n">vif_df</span><span class="p">[</span><span class="s2">"VIF"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">variance_inflation_factor</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
    <span class="k">return</span> <span class="n">vif_df</span>

<span class="c1">#  Process each group</span>
<span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Processing VIF for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  No covariates found for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
        <span class="k">continue</span>

    <span class="n">covariates</span> <span class="o">=</span> <span class="n">final_covariates_map</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
    <span class="n">vif_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df_imp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">vif_df</span> <span class="o">=</span> <span class="n">compute_vif</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="n">vif_df</span><span class="p">[</span><span class="s2">"imputation"</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">vif_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vif_df</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"    Failed on imputation </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">vif_list</span><span class="p">:</span>
        <span class="n">all_vif</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">vif_list</span><span class="p">)</span>
        <span class="n">pooled_vif</span> <span class="o">=</span> <span class="n">all_vif</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">"variable"</span><span class="p">)[</span><span class="s2">"VIF"</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">pooled_vif</span> <span class="o">=</span> <span class="n">pooled_vif</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">"VIF"</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"outputs"</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">pooled_vif</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"pooled_vif.csv"</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Saved: </span><span class="si">{</span><span class="n">output_folder</span><span class="si">}</span><span class="s2">/pooled_vif.csv"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Skipped </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: No valid imputations."</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Processing VIF for SubSubCat_Oxazepam
  Saved: outputs\SubSubCat_Oxazepam/pooled_vif.csv

 Processing VIF for SubSubCat_Diazepam
  Saved: outputs\SubSubCat_Diazepam/pooled_vif.csv

 Processing VIF for SubSubCat_Paracetamol
  Saved: outputs\SubSubCat_Paracetamol/pooled_vif.csv

 Processing VIF for SubSubCat_Lorazepam
  Saved: outputs\SubSubCat_Lorazepam/pooled_vif.csv

 Processing VIF for SubSubCat_Mirtazapine
  Saved: outputs\SubSubCat_Mirtazapine/pooled_vif.csv

 Processing VIF for SubSubCat_Escitalopram
  Saved: outputs\SubSubCat_Escitalopram/pooled_vif.csv

 Processing VIF for SubSubCat_Sertraline
  Saved: outputs\SubSubCat_Sertraline/pooled_vif.csv

 Processing VIF for SubSubCat_Temazepam
  Saved: outputs\SubSubCat_Temazepam/pooled_vif.csv

 Processing VIF for SubSubCat_Citalopram
  Saved: outputs\SubSubCat_Citalopram/pooled_vif.csv

 Processing VIF for SubSubCat_Quetiapine
  Saved: outputs\SubSubCat_Quetiapine/pooled_vif.csv

 Processing VIF for SubSubCat_Amitriptyline
  Saved: outputs\SubSubCat_Amitriptyline/pooled_vif.csv

 Processing VIF for SubSubCat_Venlafaxine
  Saved: outputs\SubSubCat_Venlafaxine/pooled_vif.csv

 Processing VIF for SubSubCat_Fluoxetine
  Saved: outputs\SubSubCat_Fluoxetine/pooled_vif.csv

 Processing VIF for SubSubCat_Topiramaat
  Saved: outputs\SubSubCat_Topiramaat/pooled_vif.csv

 Processing VIF for SubSubCat_Zopiclon
  Saved: outputs\SubSubCat_Zopiclon/pooled_vif.csv

 Processing VIF for SubSubCat_Bupropion
  Saved: outputs\SubSubCat_Bupropion/pooled_vif.csv

 Processing VIF for SubSubCat_Methylfenidaat
  Saved: outputs\SubSubCat_Methylfenidaat/pooled_vif.csv

 Processing VIF for SubSubCat_Olanzapine
  Saved: outputs\SubSubCat_Olanzapine/pooled_vif.csv
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=528186ed-26e4-4988-83b8-14883f9d0c3f">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[258]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">roc_curve</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>

<span class="c1"># ---------- PS Estimation Function ----------</span>
<span class="k">def</span> <span class="nf">run_logistic_ps_modeling</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Running PS estimation for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No covariates found for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"outputs"</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">covariates</span> <span class="o">=</span> <span class="n">final_covariates_map</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
        <span class="n">ps_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">auc_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df_imp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_imp</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> not found in imputed dataset </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">X</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>

            <span class="c1"># Drop missing treatment rows</span>
            <span class="n">valid_idx</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">index</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>

            <span class="c1"># Train-test split for ROC</span>
            <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">T_train</span><span class="p">,</span> <span class="n">T_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
                <span class="n">X</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
            <span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
                <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">T_train</span><span class="p">)</span>

                <span class="n">ps_scores</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">ps_matrix</span><span class="p">[</span><span class="sa">f</span><span class="s2">"ps_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">ps_scores</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">valid_idx</span><span class="p">)</span>

                <span class="c1"># ROC &amp; AUC</span>
                <span class="n">auc</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">T_test</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">auc_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">auc</span><span class="p">)</span>

                <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">T_test</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">"AUC = </span><span class="si">{</span><span class="n">auc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'k--'</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"False Positive Rate"</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"True Positive Rate"</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"ROC Curve - </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> (Imp </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">)"</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"roc_curve_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.png"</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   Imp </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: AUC = </span><span class="si">{</span><span class="n">auc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, ROC saved."</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> (imp </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Save AUCs and Composite PS</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ps_matrix</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="c1"># Fill NaN rows (from dropped subjects in some imputations) with mean</span>
            <span class="n">ps_matrix</span><span class="p">[</span><span class="s2">"composite_ps"</span><span class="p">]</span> <span class="o">=</span> <span class="n">ps_matrix</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ps_matrix</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"propensity_scores.xlsx"</span><span class="p">))</span>

            <span class="n">auc_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s2">"imputation"</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">"imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">auc_list</span><span class="p">))],</span>
                <span class="s2">"AUC"</span><span class="p">:</span> <span class="n">auc_list</span>
            <span class="p">})</span>
            <span class="n">auc_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">auc_df</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"mean"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">auc_list</span><span class="p">)</span> <span class="k">if</span> <span class="n">auc_list</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span>
            <span class="n">auc_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"auc_scores.xlsx"</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Composite PS + AUC saved for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No valid PS scores generated for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># ---------- Run ----------</span>
<span class="n">run_logistic_ps_modeling</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre> Running PS estimation for SubSubCat_Oxazepam
   Imp 1: AUC = 0.750, ROC saved.
   Imp 2: AUC = 0.749, ROC saved.
   Imp 3: AUC = 0.747, ROC saved.
   Imp 4: AUC = 0.753, ROC saved.
   Imp 5: AUC = 0.753, ROC saved.
 Composite PS + AUC saved for SubSubCat_Oxazepam
 Running PS estimation for SubSubCat_Diazepam
   Imp 1: AUC = 0.755, ROC saved.
   Imp 2: AUC = 0.746, ROC saved.
   Imp 3: AUC = 0.762, ROC saved.
   Imp 4: AUC = 0.765, ROC saved.
   Imp 5: AUC = 0.747, ROC saved.
 Composite PS + AUC saved for SubSubCat_Diazepam
 Running PS estimation for SubSubCat_Paracetamol
   Imp 1: AUC = 0.743, ROC saved.
   Imp 2: AUC = 0.761, ROC saved.
   Imp 3: AUC = 0.747, ROC saved.
   Imp 4: AUC = 0.759, ROC saved.
   Imp 5: AUC = 0.758, ROC saved.
 Composite PS + AUC saved for SubSubCat_Paracetamol
 Running PS estimation for SubSubCat_Lorazepam
   Imp 1: AUC = 0.815, ROC saved.
   Imp 2: AUC = 0.817, ROC saved.
   Imp 3: AUC = 0.838, ROC saved.
   Imp 4: AUC = 0.794, ROC saved.
   Imp 5: AUC = 0.802, ROC saved.
 Composite PS + AUC saved for SubSubCat_Lorazepam
 Running PS estimation for SubSubCat_Mirtazapine
   Imp 1: AUC = 0.736, ROC saved.
   Imp 2: AUC = 0.738, ROC saved.
   Imp 3: AUC = 0.728, ROC saved.
   Imp 4: AUC = 0.735, ROC saved.
   Imp 5: AUC = 0.740, ROC saved.
 Composite PS + AUC saved for SubSubCat_Mirtazapine
 Running PS estimation for SubSubCat_Escitalopram
   Imp 1: AUC = 0.553, ROC saved.
   Imp 2: AUC = 0.552, ROC saved.
   Imp 3: AUC = 0.553, ROC saved.
   Imp 4: AUC = 0.558, ROC saved.
   Imp 5: AUC = 0.564, ROC saved.
 Composite PS + AUC saved for SubSubCat_Escitalopram
 Running PS estimation for SubSubCat_Sertraline
   Imp 1: AUC = 0.780, ROC saved.
   Imp 2: AUC = 0.781, ROC saved.
   Imp 3: AUC = 0.781, ROC saved.
   Imp 4: AUC = 0.782, ROC saved.
   Imp 5: AUC = 0.783, ROC saved.
 Composite PS + AUC saved for SubSubCat_Sertraline
 Running PS estimation for SubSubCat_Temazepam
   Imp 1: AUC = 0.606, ROC saved.
   Imp 2: AUC = 0.606, ROC saved.
   Imp 3: AUC = 0.604, ROC saved.
   Imp 4: AUC = 0.606, ROC saved.
   Imp 5: AUC = 0.604, ROC saved.
 Composite PS + AUC saved for SubSubCat_Temazepam
 Running PS estimation for SubSubCat_Citalopram
   Imp 1: AUC = 0.715, ROC saved.
   Imp 2: AUC = 0.726, ROC saved.
   Imp 3: AUC = 0.723, ROC saved.
   Imp 4: AUC = 0.687, ROC saved.
   Imp 5: AUC = 0.724, ROC saved.
 Composite PS + AUC saved for SubSubCat_Citalopram
 Running PS estimation for SubSubCat_Quetiapine
   Imp 1: AUC = 0.825, ROC saved.
   Imp 2: AUC = 0.824, ROC saved.
   Imp 3: AUC = 0.826, ROC saved.
   Imp 4: AUC = 0.826, ROC saved.
   Imp 5: AUC = 0.822, ROC saved.
 Composite PS + AUC saved for SubSubCat_Quetiapine
 Running PS estimation for SubSubCat_Amitriptyline
   Imp 1: AUC = 0.678, ROC saved.
   Imp 2: AUC = 0.679, ROC saved.
   Imp 3: AUC = 0.686, ROC saved.
   Imp 4: AUC = 0.652, ROC saved.
   Imp 5: AUC = 0.687, ROC saved.
 Composite PS + AUC saved for SubSubCat_Amitriptyline
 Running PS estimation for SubSubCat_Venlafaxine
   Imp 1: AUC = 0.760, ROC saved.
   Imp 2: AUC = 0.744, ROC saved.
   Imp 3: AUC = 0.739, ROC saved.
   Imp 4: AUC = 0.711, ROC saved.
   Imp 5: AUC = 0.760, ROC saved.
 Composite PS + AUC saved for SubSubCat_Venlafaxine
 Running PS estimation for SubSubCat_Fluoxetine
   Imp 1: AUC = 0.726, ROC saved.
   Imp 2: AUC = 0.723, ROC saved.
   Imp 3: AUC = 0.728, ROC saved.
   Imp 4: AUC = 0.724, ROC saved.
   Imp 5: AUC = 0.718, ROC saved.
 Composite PS + AUC saved for SubSubCat_Fluoxetine
 Running PS estimation for SubSubCat_Topiramaat
   Imp 1: AUC = 0.908, ROC saved.
   Imp 2: AUC = 0.913, ROC saved.
   Imp 3: AUC = 0.901, ROC saved.
   Imp 4: AUC = 0.909, ROC saved.
   Imp 5: AUC = 0.912, ROC saved.
 Composite PS + AUC saved for SubSubCat_Topiramaat
 Running PS estimation for SubSubCat_Zopiclon
   Imp 1: AUC = 0.569, ROC saved.
   Imp 2: AUC = 0.548, ROC saved.
   Imp 3: AUC = 0.568, ROC saved.
   Imp 4: AUC = 0.554, ROC saved.
   Imp 5: AUC = 0.550, ROC saved.
 Composite PS + AUC saved for SubSubCat_Zopiclon
 Running PS estimation for SubSubCat_Bupropion
   Imp 1: AUC = 0.563, ROC saved.
   Imp 2: AUC = 0.563, ROC saved.
   Imp 3: AUC = 0.567, ROC saved.
   Imp 4: AUC = 0.584, ROC saved.
   Imp 5: AUC = 0.572, ROC saved.
 Composite PS + AUC saved for SubSubCat_Bupropion
 Running PS estimation for SubSubCat_Methylfenidaat
   Imp 1: AUC = 0.708, ROC saved.
   Imp 2: AUC = 0.702, ROC saved.
   Imp 3: AUC = 0.676, ROC saved.
   Imp 4: AUC = 0.730, ROC saved.
   Imp 5: AUC = 0.706, ROC saved.
 Composite PS + AUC saved for SubSubCat_Methylfenidaat
 Running PS estimation for SubSubCat_Olanzapine
   Imp 1: AUC = 0.708, ROC saved.
   Imp 2: AUC = 0.704, ROC saved.
   Imp 3: AUC = 0.709, ROC saved.
   Imp 4: AUC = 0.726, ROC saved.
   Imp 5: AUC = 0.698, ROC saved.
 Composite PS + AUC saved for SubSubCat_Olanzapine
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=b29752b0-b189-4d0c-92bf-17cbcf7a96d1">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[259]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>

<span class="k">def</span> <span class="nf">compute_feature_importance</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Computing feature importance for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No covariates found for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">covariates</span> <span class="o">=</span> <span class="n">final_covariates_map</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
        <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"outputs"</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">importance_df_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df_imp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_imp</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> not in imputed dataset </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">X</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">df_imp</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>

            <span class="c1"># Drop NaNs in treatment</span>
            <span class="n">valid_idx</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">index</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
                <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>

                <span class="c1"># Get feature importance (absolute coefficients)</span>
                <span class="n">importances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">importance_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">importances</span><span class="p">))</span>
                <span class="n">df_feat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">importance_dict</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">'index'</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">"imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">])</span>
                <span class="n">df_feat</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">'feature'</span>
                <span class="n">importance_df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_feat</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   Error during modeling: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">importance_df_list</span><span class="p">:</span>
            <span class="c1"># Combine and average</span>
            <span class="n">all_feat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">importance_df_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">all_feat</span><span class="p">[</span><span class="s2">"mean_importance"</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_feat</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Filter top 30 non-zero</span>
            <span class="n">non_zero</span> <span class="o">=</span> <span class="n">all_feat</span><span class="p">[</span><span class="n">all_feat</span><span class="p">[</span><span class="s2">"mean_importance"</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">top30</span> <span class="o">=</span> <span class="n">non_zero</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">"mean_importance"</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>

            <span class="c1"># Save to CSV</span>
            <span class="n">top30</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"feature_importance.csv"</span><span class="p">))</span>

            <span class="c1"># Plot</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top30</span><span class="o">.</span><span class="n">index</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">top30</span><span class="p">[</span><span class="s2">"mean_importance"</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># plot top  bottom</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Mean Gain Importance"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Top 30 Feature Importance - </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"feature_importance_top30.png"</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Saved feature importance plot and CSV for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No valid models for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1">#  Run</span>
<span class="n">compute_feature_importance</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Computing feature importance for SubSubCat_Oxazepam
 Saved feature importance plot and CSV for SubSubCat_Oxazepam

 Computing feature importance for SubSubCat_Diazepam
 Saved feature importance plot and CSV for SubSubCat_Diazepam

 Computing feature importance for SubSubCat_Paracetamol
 Saved feature importance plot and CSV for SubSubCat_Paracetamol

 Computing feature importance for SubSubCat_Lorazepam
 Saved feature importance plot and CSV for SubSubCat_Lorazepam

 Computing feature importance for SubSubCat_Mirtazapine
 Saved feature importance plot and CSV for SubSubCat_Mirtazapine

 Computing feature importance for SubSubCat_Escitalopram
 Saved feature importance plot and CSV for SubSubCat_Escitalopram

 Computing feature importance for SubSubCat_Sertraline
 Saved feature importance plot and CSV for SubSubCat_Sertraline

 Computing feature importance for SubSubCat_Temazepam
 Saved feature importance plot and CSV for SubSubCat_Temazepam

 Computing feature importance for SubSubCat_Citalopram
 Saved feature importance plot and CSV for SubSubCat_Citalopram

 Computing feature importance for SubSubCat_Quetiapine
 Saved feature importance plot and CSV for SubSubCat_Quetiapine

 Computing feature importance for SubSubCat_Amitriptyline
 Saved feature importance plot and CSV for SubSubCat_Amitriptyline

 Computing feature importance for SubSubCat_Venlafaxine
 Saved feature importance plot and CSV for SubSubCat_Venlafaxine

 Computing feature importance for SubSubCat_Fluoxetine
 Saved feature importance plot and CSV for SubSubCat_Fluoxetine

 Computing feature importance for SubSubCat_Topiramaat
 Saved feature importance plot and CSV for SubSubCat_Topiramaat

 Computing feature importance for SubSubCat_Zopiclon
 Saved feature importance plot and CSV for SubSubCat_Zopiclon

 Computing feature importance for SubSubCat_Bupropion
 Saved feature importance plot and CSV for SubSubCat_Bupropion

 Computing feature importance for SubSubCat_Methylfenidaat
 Saved feature importance plot and CSV for SubSubCat_Methylfenidaat

 Computing feature importance for SubSubCat_Olanzapine
 Saved feature importance plot and CSV for SubSubCat_Olanzapine
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=aec84d68-8957-4d30-b509-c6fe2224a9f9">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[260]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="k">def</span> <span class="nf">compute_trimmed_clipped_iptw</span><span class="p">(</span><span class="n">ps_df</span><span class="p">,</span> <span class="n">treatment</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">clip_max</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">keep_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">ps_df</span> <span class="o">&gt;</span> <span class="n">lower</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ps_df</span> <span class="o">&lt;</span> <span class="n">upper</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ps_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">ps</span> <span class="o">=</span> <span class="n">ps_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">lower</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">1e-6</span><span class="p">)</span>  <span class="c1"># avoid div by zero</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">keep_mask</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">ps</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="n">w</span><span class="p">[</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">treatment</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">ps</span><span class="p">[</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">treatment</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="n">w</span><span class="p">[</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">treatment</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ps</span><span class="p">[</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">treatment</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)])</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">upper</span><span class="o">=</span><span class="n">clip_max</span><span class="p">)</span>
        <span class="n">weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">apply_rubins_rule_to_iptw</span><span class="p">(</span><span class="n">iptw_matrix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Given an IPTW matrix (n rows  M imputations), return Rubins rule pooled mean, SD, SE.</span>
<span class="sd">    """</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">q_bar</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">u_bar</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">total_var</span> <span class="o">=</span> <span class="n">u_bar</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">M</span><span class="p">)</span> <span class="o">*</span> <span class="n">B</span>
    <span class="n">total_se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">total_var</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">q_bar</span><span class="p">,</span> <span class="n">u_bar</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">total_se</span>


<span class="k">def</span> <span class="nf">run_trim_clip_save_all</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Processing IPTW + trimming + clipping for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"outputs"</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">ps_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"propensity_scores.xlsx"</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ps_path</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Missing PS file: </span><span class="si">{</span><span class="n">ps_path</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ps_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">ps_path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">ps_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">ps_all</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"ps_imp"</span><span class="p">)]</span>
            <span class="n">composite_index</span> <span class="o">=</span> <span class="n">ps_all</span><span class="o">.</span><span class="n">index</span>

            <span class="c1"># Get treatment from one imputed dataset</span>
            <span class="n">T_full</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">imputed_dfs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">T_full</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">composite_index</span><span class="p">,</span> <span class="n">group</span><span class="p">]</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="n">T_full</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Treatment column </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> not found in any imputed dataset."</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Compute IPTW matrix (shape: n  M)</span>
            <span class="n">iptw_matrix</span> <span class="o">=</span> <span class="n">compute_trimmed_clipped_iptw</span><span class="p">(</span><span class="n">ps_all</span><span class="p">[</span><span class="n">ps_cols</span><span class="p">],</span> <span class="n">T_full</span><span class="p">)</span>
            <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">"iptw_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iptw_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>

            <span class="c1"># Apply Rubins Rule for mean, SD, SE</span>
            <span class="n">iptw_matrix</span><span class="p">[</span><span class="s2">"iptw_mean"</span><span class="p">],</span> <span class="n">iptw_matrix</span><span class="p">[</span><span class="s2">"iptw_sd"</span><span class="p">],</span> <span class="n">iptw_matrix</span><span class="p">[</span><span class="s2">"iptw_se"</span><span class="p">]</span> <span class="o">=</span> <span class="n">apply_rubins_rule_to_iptw</span><span class="p">(</span>
                <span class="n">iptw_matrix</span><span class="p">[[</span><span class="sa">f</span><span class="s2">"iptw_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iptw_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]]</span>
            <span class="p">)</span>

            <span class="c1"># Save IPTW matrix separately</span>
            <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"iptw_weights.xlsx"</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Saved IPTW weights for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

            <span class="c1"># Save trimmed &amp; clipped imputed datasets with IPTW</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">imputed_dfs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">trimmed_idx</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="n">needed_cols</span> <span class="o">=</span> <span class="n">final_covariates_map</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">group</span><span class="p">,</span> <span class="s2">"caps5_change_baseline"</span><span class="p">]</span>

                <span class="c1"># Select only necessary columns</span>
                <span class="n">df_trimmed</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">trimmed_idx</span><span class="p">,</span> <span class="n">needed_cols</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">df_trimmed</span><span class="p">[</span><span class="s2">"iptw"</span><span class="p">]</span> <span class="o">=</span> <span class="n">iptw_matrix</span><span class="p">[</span><span class="sa">f</span><span class="s2">"iptw_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">trimmed_idx</span><span class="p">]</span>

                <span class="c1">#  DROP rows with missing IPTW values</span>
                <span class="n">before</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_trimmed</span><span class="p">)</span>
                <span class="n">df_trimmed</span> <span class="o">=</span> <span class="n">df_trimmed</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">"iptw"</span><span class="p">])</span>
                <span class="n">after</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_trimmed</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"     Retained </span><span class="si">{</span><span class="n">after</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">before</span><span class="si">}</span><span class="s2"> rows after IPTW NaN drop."</span><span class="p">)</span>

                <span class="c1"># Save to .pkl</span>
                <span class="n">df_trimmed</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"trimmed_data_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.pkl"</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"   Saved trimmed dataset: </span><span class="si">{</span><span class="n">output_folder</span><span class="si">}</span><span class="s2">/trimmed_data_imp</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.*"</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>


<span class="n">run_trim_clip_save_all</span><span class="p">(</span><span class="n">imputed_dfs</span><span class="p">,</span> <span class="n">medication_groups</span><span class="p">,</span> <span class="n">final_covariates_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Processing IPTW + trimming + clipping for SubSubCat_Oxazepam
 Saved IPTW weights for SubSubCat_Oxazepam
     Retained 1251/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Oxazepam/trimmed_data_imp1.*
     Retained 1249/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Oxazepam/trimmed_data_imp2.*
     Retained 1251/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Oxazepam/trimmed_data_imp3.*
     Retained 1265/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Oxazepam/trimmed_data_imp4.*
     Retained 1260/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Oxazepam/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SubSubCat_Diazepam
 Saved IPTW weights for SubSubCat_Diazepam
     Retained 90/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Diazepam/trimmed_data_imp1.*
     Retained 95/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Diazepam/trimmed_data_imp2.*
     Retained 88/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Diazepam/trimmed_data_imp3.*
     Retained 94/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Diazepam/trimmed_data_imp4.*
     Retained 101/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Diazepam/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SubSubCat_Paracetamol
 Saved IPTW weights for SubSubCat_Paracetamol
     Retained 131/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Paracetamol/trimmed_data_imp1.*
     Retained 115/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Paracetamol/trimmed_data_imp2.*
     Retained 120/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Paracetamol/trimmed_data_imp3.*
     Retained 116/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Paracetamol/trimmed_data_imp4.*
     Retained 114/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Paracetamol/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SubSubCat_Lorazepam
 Saved IPTW weights for SubSubCat_Lorazepam
     Retained 284/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Lorazepam/trimmed_data_imp1.*
     Retained 282/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Lorazepam/trimmed_data_imp2.*
     Retained 284/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Lorazepam/trimmed_data_imp3.*
     Retained 289/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Lorazepam/trimmed_data_imp4.*
     Retained 279/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Lorazepam/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SubSubCat_Mirtazapine
 Saved IPTW weights for SubSubCat_Mirtazapine
     Retained 391/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Mirtazapine/trimmed_data_imp1.*
     Retained 395/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Mirtazapine/trimmed_data_imp2.*
     Retained 388/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Mirtazapine/trimmed_data_imp3.*
     Retained 397/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Mirtazapine/trimmed_data_imp4.*
     Retained 399/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Mirtazapine/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SubSubCat_Escitalopram
 Saved IPTW weights for SubSubCat_Escitalopram
     Retained 219/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Escitalopram/trimmed_data_imp1.*
     Retained 223/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Escitalopram/trimmed_data_imp2.*
     Retained 222/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Escitalopram/trimmed_data_imp3.*
     Retained 221/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Escitalopram/trimmed_data_imp4.*
     Retained 218/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Escitalopram/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SubSubCat_Sertraline
 Saved IPTW weights for SubSubCat_Sertraline
     Retained 490/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Sertraline/trimmed_data_imp1.*
     Retained 500/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Sertraline/trimmed_data_imp2.*
     Retained 499/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Sertraline/trimmed_data_imp3.*
     Retained 483/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Sertraline/trimmed_data_imp4.*
     Retained 502/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Sertraline/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SubSubCat_Temazepam
 Saved IPTW weights for SubSubCat_Temazepam
     Retained 398/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Temazepam/trimmed_data_imp1.*
     Retained 396/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Temazepam/trimmed_data_imp2.*
     Retained 398/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Temazepam/trimmed_data_imp3.*
     Retained 396/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Temazepam/trimmed_data_imp4.*
     Retained 399/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Temazepam/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SubSubCat_Citalopram
 Saved IPTW weights for SubSubCat_Citalopram
     Retained 666/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Citalopram/trimmed_data_imp1.*
     Retained 675/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Citalopram/trimmed_data_imp2.*
     Retained 686/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Citalopram/trimmed_data_imp3.*
     Retained 680/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Citalopram/trimmed_data_imp4.*
     Retained 678/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Citalopram/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SubSubCat_Quetiapine
 Saved IPTW weights for SubSubCat_Quetiapine
     Retained 1023/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Quetiapine/trimmed_data_imp1.*
     Retained 1031/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Quetiapine/trimmed_data_imp2.*
     Retained 1010/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Quetiapine/trimmed_data_imp3.*
     Retained 1020/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Quetiapine/trimmed_data_imp4.*
     Retained 1022/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Quetiapine/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SubSubCat_Amitriptyline
 Saved IPTW weights for SubSubCat_Amitriptyline
     Retained 86/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Amitriptyline/trimmed_data_imp1.*
     Retained 82/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Amitriptyline/trimmed_data_imp2.*
     Retained 80/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Amitriptyline/trimmed_data_imp3.*
     Retained 70/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Amitriptyline/trimmed_data_imp4.*
     Retained 73/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Amitriptyline/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SubSubCat_Venlafaxine
 Saved IPTW weights for SubSubCat_Venlafaxine
     Retained 208/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Venlafaxine/trimmed_data_imp1.*
     Retained 201/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Venlafaxine/trimmed_data_imp2.*
     Retained 224/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Venlafaxine/trimmed_data_imp3.*
     Retained 219/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Venlafaxine/trimmed_data_imp4.*
     Retained 217/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Venlafaxine/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SubSubCat_Fluoxetine
 Saved IPTW weights for SubSubCat_Fluoxetine
     Retained 287/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Fluoxetine/trimmed_data_imp1.*
     Retained 275/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Fluoxetine/trimmed_data_imp2.*
     Retained 264/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Fluoxetine/trimmed_data_imp3.*
     Retained 270/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Fluoxetine/trimmed_data_imp4.*
     Retained 268/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Fluoxetine/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SubSubCat_Topiramaat
 Saved IPTW weights for SubSubCat_Topiramaat
     Retained 168/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Topiramaat/trimmed_data_imp1.*
     Retained 169/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Topiramaat/trimmed_data_imp2.*
     Retained 160/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Topiramaat/trimmed_data_imp3.*
     Retained 168/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Topiramaat/trimmed_data_imp4.*
     Retained 169/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Topiramaat/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SubSubCat_Zopiclon
 Saved IPTW weights for SubSubCat_Zopiclon
     Retained 127/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Zopiclon/trimmed_data_imp1.*
     Retained 114/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Zopiclon/trimmed_data_imp2.*
     Retained 127/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Zopiclon/trimmed_data_imp3.*
     Retained 137/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Zopiclon/trimmed_data_imp4.*
     Retained 121/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Zopiclon/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SubSubCat_Bupropion
 Saved IPTW weights for SubSubCat_Bupropion
     Retained 53/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Bupropion/trimmed_data_imp1.*
     Retained 51/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Bupropion/trimmed_data_imp2.*
     Retained 52/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Bupropion/trimmed_data_imp3.*
     Retained 68/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Bupropion/trimmed_data_imp4.*
     Retained 55/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Bupropion/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SubSubCat_Methylfenidaat
 Saved IPTW weights for SubSubCat_Methylfenidaat
     Retained 71/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Methylfenidaat/trimmed_data_imp1.*
     Retained 66/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Methylfenidaat/trimmed_data_imp2.*
     Retained 71/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Methylfenidaat/trimmed_data_imp3.*
     Retained 67/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Methylfenidaat/trimmed_data_imp4.*
     Retained 69/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Methylfenidaat/trimmed_data_imp5.*

 Processing IPTW + trimming + clipping for SubSubCat_Olanzapine
 Saved IPTW weights for SubSubCat_Olanzapine
     Retained 111/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Olanzapine/trimmed_data_imp1.*
     Retained 102/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Olanzapine/trimmed_data_imp2.*
     Retained 107/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Olanzapine/trimmed_data_imp3.*
     Retained 99/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Olanzapine/trimmed_data_imp4.*
     Retained 107/3641 rows after IPTW NaN drop.
   Saved trimmed dataset: outputs\SubSubCat_Olanzapine/trimmed_data_imp5.*
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=0fc51d56-a7dc-4735-b9a7-9f1645bd811f">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[261]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="k">def</span> <span class="nf">plot_ps_overlap_all_groups</span><span class="p">(</span><span class="n">medication_groups</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Plotting PS overlap for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="n">folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"outputs"</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">ps_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">"propensity_scores.xlsx"</span><span class="p">)</span>
        <span class="n">iptw_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">"iptw_weights.xlsx"</span><span class="p">)</span>
        <span class="n">trimmed_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">"trimmed_data_imp1.pkl"</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ps_file</span><span class="p">,</span> <span class="n">iptw_file</span><span class="p">,</span> <span class="n">trimmed_file</span><span class="p">]):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Missing required files for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">. Skipping."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ps_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">ps_file</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">iptw_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">iptw_file</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">trimmed_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">trimmed_file</span><span class="p">)</span>

            <span class="c1"># Extract</span>
            <span class="n">ps</span> <span class="o">=</span> <span class="n">ps_df</span><span class="p">[</span><span class="s2">"composite_ps"</span><span class="p">]</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">trimmed_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">iptw_df</span><span class="p">[</span><span class="s2">"iptw_mean"</span><span class="p">]</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">trimmed_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">trimmed_df</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>

            <span class="c1"># Masks to remove NaNs</span>
            <span class="n">treated_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ps</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">w</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
            <span class="n">control_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ps</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">w</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>

            <span class="n">treated</span> <span class="o">=</span> <span class="n">ps</span><span class="p">[</span><span class="n">treated_mask</span><span class="p">]</span>
            <span class="n">treated_w</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="n">treated_mask</span><span class="p">]</span>

            <span class="n">control</span> <span class="o">=</span> <span class="n">ps</span><span class="p">[</span><span class="n">control_mask</span><span class="p">]</span>
            <span class="n">control_w</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="n">control_mask</span><span class="p">]</span>

            <span class="c1"># === Unweighted Plot ===</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">([</span><span class="n">treated</span><span class="p">,</span> <span class="n">control</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="p">[</span><span class="s2">"Treated"</span><span class="p">,</span> <span class="s2">"Control"</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Unweighted PS Overlap - </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Composite Propensity Score"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"Count"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">"ps_overlap_unweighted.png"</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="c1"># === Weighted Plot ===</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">([</span><span class="n">treated</span><span class="p">,</span> <span class="n">control</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="p">[</span><span class="n">treated_w</span><span class="p">,</span> <span class="n">control_w</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="p">[</span><span class="s2">"Treated"</span><span class="p">,</span> <span class="s2">"Control"</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Weighted PS Overlap - </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Composite Propensity Score"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"Weighted Count"</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">"ps_overlap_weighted.png"</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Saved unweighted and weighted PS plots for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error processing </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1">#  Run</span>
<span class="n">plot_ps_overlap_all_groups</span><span class="p">(</span><span class="n">medication_groups</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Plotting PS overlap for SubSubCat_Oxazepam
 Saved unweighted and weighted PS plots for SubSubCat_Oxazepam

 Plotting PS overlap for SubSubCat_Diazepam
 Saved unweighted and weighted PS plots for SubSubCat_Diazepam

 Plotting PS overlap for SubSubCat_Paracetamol
 Saved unweighted and weighted PS plots for SubSubCat_Paracetamol

 Plotting PS overlap for SubSubCat_Lorazepam
 Saved unweighted and weighted PS plots for SubSubCat_Lorazepam

 Plotting PS overlap for SubSubCat_Mirtazapine
 Saved unweighted and weighted PS plots for SubSubCat_Mirtazapine

 Plotting PS overlap for SubSubCat_Escitalopram
 Saved unweighted and weighted PS plots for SubSubCat_Escitalopram

 Plotting PS overlap for SubSubCat_Sertraline
 Saved unweighted and weighted PS plots for SubSubCat_Sertraline

 Plotting PS overlap for SubSubCat_Temazepam
 Saved unweighted and weighted PS plots for SubSubCat_Temazepam

 Plotting PS overlap for SubSubCat_Citalopram
 Saved unweighted and weighted PS plots for SubSubCat_Citalopram

 Plotting PS overlap for SubSubCat_Quetiapine
 Saved unweighted and weighted PS plots for SubSubCat_Quetiapine

 Plotting PS overlap for SubSubCat_Amitriptyline
 Saved unweighted and weighted PS plots for SubSubCat_Amitriptyline

 Plotting PS overlap for SubSubCat_Venlafaxine
 Saved unweighted and weighted PS plots for SubSubCat_Venlafaxine

 Plotting PS overlap for SubSubCat_Fluoxetine
 Saved unweighted and weighted PS plots for SubSubCat_Fluoxetine

 Plotting PS overlap for SubSubCat_Topiramaat
 Saved unweighted and weighted PS plots for SubSubCat_Topiramaat

 Plotting PS overlap for SubSubCat_Zopiclon
 Saved unweighted and weighted PS plots for SubSubCat_Zopiclon

 Plotting PS overlap for SubSubCat_Bupropion
 Saved unweighted and weighted PS plots for SubSubCat_Bupropion

 Plotting PS overlap for SubSubCat_Methylfenidaat
 Saved unweighted and weighted PS plots for SubSubCat_Methylfenidaat

 Plotting PS overlap for SubSubCat_Olanzapine
 Saved unweighted and weighted PS plots for SubSubCat_Olanzapine
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=9b3cfb7d-89a3-4646-a30c-59dfd41f5c51">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[262]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># Set up base output folder</span>
<span class="n">output_base</span> <span class="o">=</span> <span class="s2">"outputs"</span>
<span class="n">ps_file</span> <span class="o">=</span> <span class="s2">"propensity_scores.xlsx"</span>
<span class="n">iptw_file</span> <span class="o">=</span> <span class="s2">"iptw_weights.xlsx"</span>
<span class="n">trimmed_data_file</span> <span class="o">=</span> <span class="s2">"trimmed_data_imp1.pkl"</span>

<span class="c1"># Collect all treatment group folders</span>
<span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">medication_groups</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">g</span><span class="p">))]</span>

<span class="c1"># Generate 4-panel overlap plots</span>
<span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
    <span class="n">group_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Load trimmed treatment info</span>
        <span class="n">trimmed_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="n">trimmed_data_file</span><span class="p">))</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">trimmed_df</span><span class="o">.</span><span class="n">index</span>

        <span class="c1"># Fix: case-insensitive match for treatment variable</span>
        <span class="n">possible_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">trimmed_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">group</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">possible_cols</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Treatment variable </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> not found in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">, skipping."</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">treatment_var</span> <span class="o">=</span> <span class="n">possible_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">trimmed_df</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span>

        <span class="c1"># Load composite PS (aligned to trimmed_df index)</span>
        <span class="n">ps_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="n">ps_file</span><span class="p">),</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">'composite_ps'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ps_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Composite column missing in </span><span class="si">{</span><span class="n">ps_file</span><span class="si">}</span><span class="s2">, skipping </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">."</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">ps</span> <span class="o">=</span> <span class="n">ps_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s1">'composite_ps'</span><span class="p">]</span>

        <span class="c1"># Load IPTW weights (aligned to trimmed_df index)</span>
        <span class="n">weights_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="n">iptw_file</span><span class="p">),</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">'iptw_mean'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">weights_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" IPTW weight column missing in </span><span class="si">{</span><span class="n">iptw_file</span><span class="si">}</span><span class="s2">, skipping </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">."</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">weights_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s1">'iptw_mean'</span><span class="p">]</span>

        <span class="c1"># Prepare 4 datasets</span>
        <span class="n">raw_treated</span> <span class="o">=</span> <span class="n">ps</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">raw_control</span> <span class="o">=</span> <span class="n">ps</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">weighted_treated</span> <span class="o">=</span> <span class="p">(</span><span class="n">ps</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">],</span> <span class="n">weights</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">weighted_control</span> <span class="o">=</span> <span class="p">(</span><span class="n">ps</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">],</span> <span class="n">weights</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Create plot</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Propensity Score Distribution - </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">raw_treated</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'blue'</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Raw Treated"</span><span class="p">)</span>

        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">raw_control</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'green'</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Raw Control"</span><span class="p">)</span>

        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">weighted_treated</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weighted_treated</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'blue'</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Weighted Treated"</span><span class="p">)</span>

        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">weighted_control</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weighted_control</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'green'</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Weighted Control"</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="o">.</span><span class="n">flat</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Propensity Score"</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Count"</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">])</span>

        <span class="c1"># Save figure</span>
        <span class="n">plot_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"four_panel_overlap_</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">.png"</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_path</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Saved: </span><span class="si">{</span><span class="n">plot_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>  Saved: outputs\SubSubCat_Oxazepam\four_panel_overlap_SubSubCat_Oxazepam.png
  Saved: outputs\SubSubCat_Diazepam\four_panel_overlap_SubSubCat_Diazepam.png
  Saved: outputs\SubSubCat_Paracetamol\four_panel_overlap_SubSubCat_Paracetamol.png
  Saved: outputs\SubSubCat_Lorazepam\four_panel_overlap_SubSubCat_Lorazepam.png
  Saved: outputs\SubSubCat_Mirtazapine\four_panel_overlap_SubSubCat_Mirtazapine.png
  Saved: outputs\SubSubCat_Escitalopram\four_panel_overlap_SubSubCat_Escitalopram.png
  Saved: outputs\SubSubCat_Sertraline\four_panel_overlap_SubSubCat_Sertraline.png
  Saved: outputs\SubSubCat_Temazepam\four_panel_overlap_SubSubCat_Temazepam.png
  Saved: outputs\SubSubCat_Citalopram\four_panel_overlap_SubSubCat_Citalopram.png
  Saved: outputs\SubSubCat_Quetiapine\four_panel_overlap_SubSubCat_Quetiapine.png
  Saved: outputs\SubSubCat_Amitriptyline\four_panel_overlap_SubSubCat_Amitriptyline.png
  Saved: outputs\SubSubCat_Venlafaxine\four_panel_overlap_SubSubCat_Venlafaxine.png
  Saved: outputs\SubSubCat_Fluoxetine\four_panel_overlap_SubSubCat_Fluoxetine.png
  Saved: outputs\SubSubCat_Topiramaat\four_panel_overlap_SubSubCat_Topiramaat.png
  Saved: outputs\SubSubCat_Zopiclon\four_panel_overlap_SubSubCat_Zopiclon.png
  Saved: outputs\SubSubCat_Bupropion\four_panel_overlap_SubSubCat_Bupropion.png
  Saved: outputs\SubSubCat_Methylfenidaat\four_panel_overlap_SubSubCat_Methylfenidaat.png
  Saved: outputs\SubSubCat_Olanzapine\four_panel_overlap_SubSubCat_Olanzapine.png
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=859bca6c-231a-474e-a286-a502ad718a32">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[263]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># ATT calculation:</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=f6a37efb-712b-4a73-aaa2-b62ca84f289c">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[264]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Weighted:</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=4214a077-9e99-4d3e-b9c6-12cf0486f5d9">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[265]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">GradientBoostingRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">r2_score</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">KFold</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">t</span><span class="p">,</span> <span class="n">probplot</span>
<span class="kn">import</span> <span class="nn">xgboost</span> <span class="k">as</span> <span class="nn">xgb</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Configuration</span>
<span class="c1"># -----------------------------</span>
<span class="n">seeds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span>
<span class="n">imputations</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">output_folder</span> <span class="o">=</span> <span class="s2">"outputs"</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Diagnostic Plotting Function</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">create_diagnostic_plots</span><span class="p">(</span><span class="n">residuals_data</span><span class="p">,</span> <span class="n">fitted_data</span><span class="p">,</span> <span class="n">group_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Create 4 diagnostic plots for model validation"""</span>
    <span class="n">plots_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"plots"</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">plots_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Flatten the collected data</span>
    <span class="n">all_residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">residuals_data</span><span class="p">)</span>
    <span class="n">all_fitted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">fitted_data</span><span class="p">)</span>
    
    <span class="c1"># Create figure with 2x2 subplots</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Diagnostic Plots - </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">'bold'</span><span class="p">)</span>
    
    <span class="c1"># 1. Residuals vs Fitted</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">all_fitted</span><span class="p">,</span> <span class="n">all_residuals</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Fitted Values'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Residuals'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Residuals vs Fitted'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># 2. QQ Plot</span>
    <span class="n">probplot</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s2">"norm"</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Q-Q Plot (Normal)'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># 3. Residual Histogram</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'skyblue'</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">'black'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Residuals'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Density'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Residual Distribution'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># 4. Scale-Location Plot</span>
    <span class="n">sqrt_abs_residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">))</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">all_fitted</span><span class="p">,</span> <span class="n">sqrt_abs_residuals</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Fitted Values'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'|Residuals|'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Scale-Location Plot'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    
    <span class="c1"># Save plot</span>
    <span class="n">plot_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plots_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s1">.png'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_filename</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">'tight'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Diagnostic plots saved for </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Rubin's Rule</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">rubins_pool</span><span class="p">(</span><span class="n">estimates</span><span class="p">,</span> <span class="n">ses</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">estimates</span><span class="p">)</span>
    <span class="n">q_bar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">estimates</span><span class="p">)</span>
    <span class="n">u_bar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">ses</span><span class="p">))</span>
    <span class="n">b_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">estimates</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">total_var</span> <span class="o">=</span> <span class="n">u_bar</span> <span class="o">+</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">b_m</span><span class="p">)</span>
    <span class="n">total_se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">total_var</span><span class="p">)</span>
    <span class="n">ci_lower</span> <span class="o">=</span> <span class="n">q_bar</span> <span class="o">-</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">total_se</span>
    <span class="n">ci_upper</span> <span class="o">=</span> <span class="n">q_bar</span> <span class="o">+</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">total_se</span>
    <span class="n">p_value</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">q_bar</span> <span class="o">/</span> <span class="n">total_se</span><span class="p">),</span> <span class="n">df</span><span class="o">=</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">rounded_p</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">p_value</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">formatted_p</span> <span class="o">=</span> <span class="s2">"&lt; 0.00001"</span> <span class="k">if</span> <span class="n">rounded_p</span> <span class="o">&lt;=</span> <span class="mf">0.00001</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">rounded_p</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">return</span> <span class="n">q_bar</span><span class="p">,</span> <span class="n">total_se</span><span class="p">,</span> <span class="n">ci_lower</span><span class="p">,</span> <span class="n">ci_upper</span><span class="p">,</span> <span class="n">formatted_p</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># SMD + Variance Ratio</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">calculate_smd_vr</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
    <span class="n">treated</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">control</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">w_treated</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">w_control</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">smd</span><span class="p">,</span> <span class="n">vr</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m1</span><span class="p">,</span> <span class="n">m0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">treated</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">w_treated</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">control</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">w_control</span><span class="p">)</span>
            <span class="n">s1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">((</span><span class="n">treated</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">-</span> <span class="n">m1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w_treated</span><span class="p">))</span>
            <span class="n">s0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">((</span><span class="n">control</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">-</span> <span class="n">m0</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w_control</span><span class="p">))</span>
            <span class="n">pooled_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">s1</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">s0</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">smd</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">m1</span> <span class="o">-</span> <span class="n">m0</span><span class="p">)</span> <span class="o">/</span> <span class="n">pooled_sd</span> <span class="k">if</span> <span class="n">pooled_sd</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">vr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s1</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">s0</span><span class="o">**</span><span class="mi">2</span> <span class="k">if</span> <span class="n">s0</span><span class="o">**</span><span class="mi">2</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">smd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">vr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">smd</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">vr</span><span class="p">)</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># OLS Main Loop</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">run_dml_with_trimmed_data</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="p">):</span>
    <span class="n">att_results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">balance_results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">covariates</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Running OLS for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">group_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">group_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">best_result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">best_se</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">"inf"</span><span class="p">)</span>
        
        <span class="c1"># Initialize lists to collect residuals and fitted values for diagnostic plots</span>
        <span class="n">group_residuals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">group_fitted</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="n">seeds</span><span class="p">:</span>
            <span class="c1"># Set random seed for this iteration</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
            
            <span class="n">att_list</span><span class="p">,</span> <span class="n">se_list</span><span class="p">,</span> <span class="n">r2_list</span><span class="p">,</span> <span class="n">rmse_list</span><span class="p">,</span> <span class="n">smd_list</span><span class="p">,</span> <span class="n">vr_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">imp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">imputations</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"trimmed_data_imp</span><span class="si">{</span><span class="n">imp</span><span class="si">}</span><span class="s2">.pkl"</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">or</span> <span class="s2">"iptw"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># Add bootstrap sampling with seed-based randomization</span>
                <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                <span class="n">bootstrap_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">df_bootstrap</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">bootstrap_idx</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="n">X</span> <span class="o">=</span> <span class="n">df_bootstrap</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">T</span> <span class="o">=</span> <span class="n">df_bootstrap</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
                <span class="n">Y</span> <span class="o">=</span> <span class="n">df_bootstrap</span><span class="p">[</span><span class="s2">"caps5_change_baseline"</span><span class="p">]</span>
                <span class="n">W</span> <span class="o">=</span> <span class="n">df_bootstrap</span><span class="p">[</span><span class="s2">"iptw"</span><span class="p">]</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Create design matrix with treatment variable and covariates</span>
                    <span class="n">X_ols</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">T</span><span class="p">,</span> <span class="n">X</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">X_ols</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">X_ols</span><span class="p">)</span>
                    
                    <span class="c1"># Fit weighted OLS with robust standard errors</span>
                    <span class="n">ols_model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">WLS</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">X_ols</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">W</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">cov_type</span><span class="o">=</span><span class="s1">'HC1'</span><span class="p">)</span>
                    
                    <span class="c1"># Extract treatment effect (coefficient of treatment variable)</span>
                    <span class="n">att</span> <span class="o">=</span> <span class="n">ols_model</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>  <span class="c1"># Treatment coefficient</span>
                    <span class="n">se</span> <span class="o">=</span> <span class="n">ols_model</span><span class="o">.</span><span class="n">bse</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>  <span class="c1"># Robust standard error for treatment</span>
                    
                    <span class="n">att_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">att</span><span class="p">)</span>
                    <span class="n">se_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">se</span><span class="p">)</span>

                    <span class="c1"># Calculate model fit statistics</span>
                    <span class="n">Y_pred</span> <span class="o">=</span> <span class="n">ols_model</span><span class="o">.</span><span class="n">fittedvalues</span>
                    <span class="n">residuals</span> <span class="o">=</span> <span class="n">ols_model</span><span class="o">.</span><span class="n">resid</span>
                    <span class="n">rmse</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">Y_pred</span><span class="p">,</span> <span class="n">squared</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">r2</span> <span class="o">=</span> <span class="n">ols_model</span><span class="o">.</span><span class="n">rsquared</span>
                    <span class="n">r2_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
                    <span class="n">rmse_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rmse</span><span class="p">)</span>
                    
                    <span class="c1"># Collect residuals and fitted values for diagnostic plots</span>
                    <span class="n">group_residuals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">residuals</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                    <span class="n">group_fitted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Y_pred</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

                    <span class="n">smd</span><span class="p">,</span> <span class="n">vr</span> <span class="o">=</span> <span class="n">calculate_smd_vr</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span>
                    <span class="n">smd_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smd</span><span class="p">)</span>
                    <span class="n">vr_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vr</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">, seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">, imp </span><span class="si">{</span><span class="n">imp</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">att_list</span><span class="p">:</span>
                <span class="n">att</span><span class="p">,</span> <span class="n">se</span><span class="p">,</span> <span class="n">ci_l</span><span class="p">,</span> <span class="n">ci_u</span><span class="p">,</span> <span class="n">p_val</span> <span class="o">=</span> <span class="n">rubins_pool</span><span class="p">(</span><span class="n">att_list</span><span class="p">,</span> <span class="n">se_list</span><span class="p">)</span>
                <span class="n">avg_r2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">r2_list</span><span class="p">)</span>
                <span class="n">avg_rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rmse_list</span><span class="p">)</span>
                <span class="n">avg_smd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">smd_list</span><span class="p">)</span>
                <span class="n">avg_vr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">vr_list</span><span class="p">)</span>

                <span class="n">balance_results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">"group"</span><span class="p">:</span> <span class="n">group</span><span class="p">,</span> <span class="s2">"seed"</span><span class="p">:</span> <span class="n">seed</span><span class="p">,</span> <span class="s2">"smd"</span><span class="p">:</span> <span class="n">avg_smd</span><span class="p">,</span> <span class="s2">"vr"</span><span class="p">:</span> <span class="n">avg_vr</span>
                <span class="p">})</span>

                <span class="k">if</span> <span class="n">se</span> <span class="o">&lt;</span> <span class="n">best_se</span><span class="p">:</span>
                    <span class="n">best_se</span> <span class="o">=</span> <span class="n">se</span>
                    <span class="n">best_result</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">"group"</span><span class="p">:</span> <span class="n">group</span><span class="p">,</span> <span class="s2">"seed"</span><span class="p">:</span> <span class="n">seed</span><span class="p">,</span> <span class="s2">"att"</span><span class="p">:</span> <span class="n">att</span><span class="p">,</span> <span class="s2">"se"</span><span class="p">:</span> <span class="n">se</span><span class="p">,</span>
                        <span class="s2">"ci_lower"</span><span class="p">:</span> <span class="n">ci_l</span><span class="p">,</span> <span class="s2">"ci_upper"</span><span class="p">:</span> <span class="n">ci_u</span><span class="p">,</span> <span class="s2">"p_value"</span><span class="p">:</span> <span class="n">p_val</span><span class="p">,</span>
                        <span class="s2">"r2"</span><span class="p">:</span> <span class="n">avg_r2</span><span class="p">,</span> <span class="s2">"rmse"</span><span class="p">:</span> <span class="n">avg_rmse</span>
                    <span class="p">}</span>

                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> | Seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">: ATT = </span><span class="si">{</span><span class="n">att</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, SE = </span><span class="si">{</span><span class="n">se</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, p = </span><span class="si">{</span><span class="n">p_val</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No valid results for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> | Seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Create diagnostic plots for this group</span>
        <span class="k">if</span> <span class="n">group_residuals</span> <span class="ow">and</span> <span class="n">group_fitted</span><span class="p">:</span>
            <span class="n">create_diagnostic_plots</span><span class="p">(</span><span class="n">group_residuals</span><span class="p">,</span> <span class="n">group_fitted</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">best_result</span><span class="p">:</span>
            <span class="n">att_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">best_result</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Best result for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">  Seed </span><span class="si">{</span><span class="n">best_result</span><span class="p">[</span><span class="s1">'seed'</span><span class="p">]</span><span class="si">}</span><span class="s2"> | SE = </span><span class="si">{</span><span class="n">best_result</span><span class="p">[</span><span class="s1">'se'</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="c1"># Save final output</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">att_results</span><span class="p">)</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">"ols_rubin_summary_subsubcats.xlsx"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">balance_results</span><span class="p">)</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">"smd_vr_summary_subsubcats.xlsx"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> All summary files saved."</span><span class="p">)</span>

<span class="n">run_dml_with_trimmed_data</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Running OLS for SubSubCat_Oxazepam
 SubSubCat_Oxazepam | Seed 1: ATT = 0.5705, SE = 1.8107, p = 0.76845
 SubSubCat_Oxazepam | Seed 2: ATT = 0.7490, SE = 1.7494, p = 0.69060
 SubSubCat_Oxazepam | Seed 3: ATT = 1.6505, SE = 1.4800, p = 0.32722
 SubSubCat_Oxazepam | Seed 4: ATT = 1.2022, SE = 2.0133, p = 0.58259
 SubSubCat_Oxazepam | Seed 5: ATT = 0.8220, SE = 2.1818, p = 0.72549
 SubSubCat_Oxazepam | Seed 6: ATT = 0.5920, SE = 1.3018, p = 0.67286
 SubSubCat_Oxazepam | Seed 7: ATT = 1.2967, SE = 1.8697, p = 0.52616
 SubSubCat_Oxazepam | Seed 8: ATT = 1.2093, SE = 1.7328, p = 0.52370
 SubSubCat_Oxazepam | Seed 9: ATT = 0.8009, SE = 1.9111, p = 0.69669
 SubSubCat_Oxazepam | Seed 10: ATT = -0.3863, SE = 1.4669, p = 0.80530
 Diagnostic plots saved for SubSubCat_Oxazepam
 Best result for SubSubCat_Oxazepam  Seed 6 | SE = 1.3018

 Running OLS for SubSubCat_Diazepam
 SubSubCat_Diazepam | Seed 1: ATT = -6.1380, SE = 7.3974, p = 0.45332
 SubSubCat_Diazepam | Seed 2: ATT = 0.9681, SE = 8.2068, p = 0.91179
 SubSubCat_Diazepam | Seed 3: ATT = -4.3587, SE = 8.1900, p = 0.62278
 SubSubCat_Diazepam | Seed 4: ATT = -2.5692, SE = 8.1805, p = 0.76917
 SubSubCat_Diazepam | Seed 5: ATT = -2.5094, SE = 8.8732, p = 0.79135
 SubSubCat_Diazepam | Seed 6: ATT = -5.7700, SE = 7.5991, p = 0.48995
 SubSubCat_Diazepam | Seed 7: ATT = 3.5049, SE = 12.5775, p = 0.79432
 SubSubCat_Diazepam | Seed 8: ATT = 1.9492, SE = 6.0938, p = 0.76508
 SubSubCat_Diazepam | Seed 9: ATT = -9.8212, SE = 8.4282, p = 0.30866
 SubSubCat_Diazepam | Seed 10: ATT = -7.3670, SE = 7.9282, p = 0.40537
 Diagnostic plots saved for SubSubCat_Diazepam
 Best result for SubSubCat_Diazepam  Seed 8 | SE = 6.0938

 Running OLS for SubSubCat_Paracetamol
 SubSubCat_Paracetamol | Seed 1: ATT = 4.3479, SE = 6.6863, p = 0.55098
 SubSubCat_Paracetamol | Seed 2: ATT = 3.4811, SE = 7.6491, p = 0.67265
 SubSubCat_Paracetamol | Seed 3: ATT = 7.0887, SE = 5.7274, p = 0.28352
 SubSubCat_Paracetamol | Seed 4: ATT = 7.8227, SE = 7.9350, p = 0.38002
 SubSubCat_Paracetamol | Seed 5: ATT = -0.4082, SE = 8.5642, p = 0.96427
 SubSubCat_Paracetamol | Seed 6: ATT = 6.2839, SE = 6.3933, p = 0.38131
 SubSubCat_Paracetamol | Seed 7: ATT = 7.0241, SE = 9.3139, p = 0.49272
 SubSubCat_Paracetamol | Seed 8: ATT = 9.8257, SE = 8.4484, p = 0.30947
 SubSubCat_Paracetamol | Seed 9: ATT = 8.0598, SE = 8.0673, p = 0.37430
 SubSubCat_Paracetamol | Seed 10: ATT = 2.1051, SE = 5.4026, p = 0.71666
 Diagnostic plots saved for SubSubCat_Paracetamol
 Best result for SubSubCat_Paracetamol  Seed 10 | SE = 5.4026

 Running OLS for SubSubCat_Lorazepam
 SubSubCat_Lorazepam | Seed 1: ATT = 2.3966, SE = 4.2419, p = 0.60227
 SubSubCat_Lorazepam | Seed 2: ATT = -0.2551, SE = 3.4701, p = 0.94492
 SubSubCat_Lorazepam | Seed 3: ATT = 3.2795, SE = 3.7647, p = 0.43285
 SubSubCat_Lorazepam | Seed 4: ATT = 2.1366, SE = 3.4397, p = 0.56814
 SubSubCat_Lorazepam | Seed 5: ATT = 2.5855, SE = 4.4971, p = 0.59613
 SubSubCat_Lorazepam | Seed 6: ATT = 2.4847, SE = 4.8994, p = 0.63874
 SubSubCat_Lorazepam | Seed 7: ATT = 3.1741, SE = 4.1209, p = 0.48413
 SubSubCat_Lorazepam | Seed 8: ATT = 2.4791, SE = 4.4064, p = 0.60373
 SubSubCat_Lorazepam | Seed 9: ATT = 2.7829, SE = 3.8606, p = 0.51088
 SubSubCat_Lorazepam | Seed 10: ATT = 1.8781, SE = 5.3657, p = 0.74398
 Diagnostic plots saved for SubSubCat_Lorazepam
 Best result for SubSubCat_Lorazepam  Seed 4 | SE = 3.4397

 Running OLS for SubSubCat_Mirtazapine
 SubSubCat_Mirtazapine | Seed 1: ATT = 5.1510, SE = 2.7075, p = 0.12986
 SubSubCat_Mirtazapine | Seed 2: ATT = 4.9517, SE = 3.0263, p = 0.17713
 SubSubCat_Mirtazapine | Seed 3: ATT = 5.5364, SE = 3.1248, p = 0.15113
 SubSubCat_Mirtazapine | Seed 4: ATT = 5.7170, SE = 4.2858, p = 0.25311
 SubSubCat_Mirtazapine | Seed 5: ATT = 7.6247, SE = 2.3852, p = 0.03301
 SubSubCat_Mirtazapine | Seed 6: ATT = 5.6583, SE = 2.9773, p = 0.13017
 SubSubCat_Mirtazapine | Seed 7: ATT = 4.3473, SE = 4.0152, p = 0.33984
 SubSubCat_Mirtazapine | Seed 8: ATT = 6.1535, SE = 3.2703, p = 0.13303
 SubSubCat_Mirtazapine | Seed 9: ATT = 4.1287, SE = 2.9237, p = 0.23076
 SubSubCat_Mirtazapine | Seed 10: ATT = 5.0135, SE = 3.4511, p = 0.21996
 Diagnostic plots saved for SubSubCat_Mirtazapine
 Best result for SubSubCat_Mirtazapine  Seed 5 | SE = 2.3852

 Running OLS for SubSubCat_Escitalopram
 SubSubCat_Escitalopram | Seed 1: ATT = 2.0006, SE = 5.1085, p = 0.71531
 SubSubCat_Escitalopram | Seed 2: ATT = -2.1152, SE = 6.1816, p = 0.74944
 SubSubCat_Escitalopram | Seed 3: ATT = 2.9470, SE = 9.0683, p = 0.76148
 SubSubCat_Escitalopram | Seed 4: ATT = 1.2518, SE = 6.0206, p = 0.84545
 SubSubCat_Escitalopram | Seed 5: ATT = -0.8450, SE = 4.1666, p = 0.84919
 SubSubCat_Escitalopram | Seed 6: ATT = -5.6372, SE = 5.0772, p = 0.32912
 SubSubCat_Escitalopram | Seed 7: ATT = 1.6135, SE = 8.2699, p = 0.85482
 SubSubCat_Escitalopram | Seed 8: ATT = 0.2543, SE = 4.9470, p = 0.96147
 SubSubCat_Escitalopram | Seed 9: ATT = 2.1222, SE = 6.7297, p = 0.76826
 SubSubCat_Escitalopram | Seed 10: ATT = -0.4981, SE = 5.7597, p = 0.93524
 Diagnostic plots saved for SubSubCat_Escitalopram
 Best result for SubSubCat_Escitalopram  Seed 5 | SE = 4.1666

 Running OLS for SubSubCat_Sertraline
 SubSubCat_Sertraline | Seed 1: ATT = 2.1943, SE = 2.7749, p = 0.47333
 SubSubCat_Sertraline | Seed 2: ATT = 2.7300, SE = 2.4941, p = 0.33520
 SubSubCat_Sertraline | Seed 3: ATT = 1.4738, SE = 2.3564, p = 0.56561
 SubSubCat_Sertraline | Seed 4: ATT = 0.9172, SE = 2.0530, p = 0.67816
 SubSubCat_Sertraline | Seed 5: ATT = 1.3151, SE = 3.6143, p = 0.73438
 SubSubCat_Sertraline | Seed 6: ATT = 2.0012, SE = 2.4636, p = 0.46219
 SubSubCat_Sertraline | Seed 7: ATT = 2.0722, SE = 2.5869, p = 0.46800
 SubSubCat_Sertraline | Seed 8: ATT = 1.8514, SE = 2.4216, p = 0.48716
 SubSubCat_Sertraline | Seed 9: ATT = 1.9080, SE = 2.8059, p = 0.53382
 SubSubCat_Sertraline | Seed 10: ATT = 1.7975, SE = 3.3008, p = 0.61498
 Diagnostic plots saved for SubSubCat_Sertraline
 Best result for SubSubCat_Sertraline  Seed 4 | SE = 2.0530

 Running OLS for SubSubCat_Temazepam
 SubSubCat_Temazepam | Seed 1: ATT = 2.1404, SE = 3.3895, p = 0.56202
 SubSubCat_Temazepam | Seed 2: ATT = 0.8039, SE = 6.1645, p = 0.90253
 SubSubCat_Temazepam | Seed 3: ATT = 2.5048, SE = 2.9737, p = 0.44702
 SubSubCat_Temazepam | Seed 4: ATT = 2.8596, SE = 3.8447, p = 0.49833
 SubSubCat_Temazepam | Seed 5: ATT = 0.6666, SE = 3.5214, p = 0.85908
 SubSubCat_Temazepam | Seed 6: ATT = 2.9586, SE = 5.0104, p = 0.58661
 SubSubCat_Temazepam | Seed 7: ATT = 1.5688, SE = 3.5180, p = 0.67872
 SubSubCat_Temazepam | Seed 8: ATT = -0.3590, SE = 3.6388, p = 0.92616
 SubSubCat_Temazepam | Seed 9: ATT = -0.0663, SE = 4.5517, p = 0.98908
 SubSubCat_Temazepam | Seed 10: ATT = 1.3157, SE = 5.4979, p = 0.82263
 Diagnostic plots saved for SubSubCat_Temazepam
 Best result for SubSubCat_Temazepam  Seed 3 | SE = 2.9737

 Running OLS for SubSubCat_Citalopram
 SubSubCat_Citalopram | Seed 1: ATT = -4.9014, SE = 2.8854, p = 0.16461
 SubSubCat_Citalopram | Seed 2: ATT = -5.6934, SE = 4.1169, p = 0.23887
 SubSubCat_Citalopram | Seed 3: ATT = -5.3239, SE = 2.8093, p = 0.13098
 SubSubCat_Citalopram | Seed 4: ATT = -6.0628, SE = 3.1417, p = 0.12585
 SubSubCat_Citalopram | Seed 5: ATT = -6.6588, SE = 2.3803, p = 0.04893
 SubSubCat_Citalopram | Seed 6: ATT = -6.2465, SE = 3.0361, p = 0.10877
 SubSubCat_Citalopram | Seed 7: ATT = -4.4764, SE = 3.0917, p = 0.22121
 SubSubCat_Citalopram | Seed 8: ATT = -5.2916, SE = 3.7714, p = 0.23325
 SubSubCat_Citalopram | Seed 9: ATT = -6.1751, SE = 2.2440, p = 0.05128
 SubSubCat_Citalopram | Seed 10: ATT = -5.4228, SE = 3.0485, p = 0.14988
 Diagnostic plots saved for SubSubCat_Citalopram
 Best result for SubSubCat_Citalopram  Seed 9 | SE = 2.2440

 Running OLS for SubSubCat_Quetiapine
 SubSubCat_Quetiapine | Seed 1: ATT = 1.6633, SE = 2.0325, p = 0.45912
 SubSubCat_Quetiapine | Seed 2: ATT = 2.6943, SE = 3.2174, p = 0.44947
 SubSubCat_Quetiapine | Seed 3: ATT = 2.8620, SE = 1.7735, p = 0.18187
 SubSubCat_Quetiapine | Seed 4: ATT = 2.4702, SE = 1.9903, p = 0.28238
 SubSubCat_Quetiapine | Seed 5: ATT = 1.6341, SE = 1.8924, p = 0.43655
 SubSubCat_Quetiapine | Seed 6: ATT = 2.2101, SE = 2.3446, p = 0.39923
 SubSubCat_Quetiapine | Seed 7: ATT = 3.6096, SE = 2.6248, p = 0.24107
 SubSubCat_Quetiapine | Seed 8: ATT = 2.5999, SE = 2.1560, p = 0.29430
 SubSubCat_Quetiapine | Seed 9: ATT = 2.1167, SE = 2.5932, p = 0.46018
 SubSubCat_Quetiapine | Seed 10: ATT = 1.9602, SE = 1.5887, p = 0.28480
 Diagnostic plots saved for SubSubCat_Quetiapine
 Best result for SubSubCat_Quetiapine  Seed 10 | SE = 1.5887

 Running OLS for SubSubCat_Amitriptyline
 SubSubCat_Amitriptyline | Seed 1: ATT = 8.9202, SE = 14.5075, p = 0.57190
 SubSubCat_Amitriptyline | Seed 2: ATT = 13.6574, SE = 10.3958, p = 0.25921
 SubSubCat_Amitriptyline | Seed 3: ATT = 4.9053, SE = 9.1230, p = 0.61931
 SubSubCat_Amitriptyline | Seed 4: ATT = 6.9302, SE = 13.4728, p = 0.63410
 SubSubCat_Amitriptyline | Seed 5: ATT = 8.0432, SE = 9.2966, p = 0.43575
 SubSubCat_Amitriptyline | Seed 6: ATT = 8.0343, SE = 19.1134, p = 0.69583
 SubSubCat_Amitriptyline | Seed 7: ATT = 16.8473, SE = 9.0377, p = 0.13575
 SubSubCat_Amitriptyline | Seed 8: ATT = 11.2124, SE = 14.8612, p = 0.49255
 SubSubCat_Amitriptyline | Seed 9: ATT = 21.7959, SE = 12.9526, p = 0.16771
 SubSubCat_Amitriptyline | Seed 10: ATT = 10.2286, SE = 11.8773, p = 0.43770
 Diagnostic plots saved for SubSubCat_Amitriptyline
 Best result for SubSubCat_Amitriptyline  Seed 7 | SE = 9.0377

 Running OLS for SubSubCat_Venlafaxine
 SubSubCat_Venlafaxine | Seed 1: ATT = 1.1061, SE = 5.2774, p = 0.84424
 SubSubCat_Venlafaxine | Seed 2: ATT = -4.0363, SE = 7.1882, p = 0.60442
 SubSubCat_Venlafaxine | Seed 3: ATT = 1.6356, SE = 8.1763, p = 0.85120
 SubSubCat_Venlafaxine | Seed 4: ATT = 2.0992, SE = 7.3097, p = 0.78823
 SubSubCat_Venlafaxine | Seed 5: ATT = -1.0891, SE = 3.6995, p = 0.78310
 SubSubCat_Venlafaxine | Seed 6: ATT = 2.0199, SE = 6.2257, p = 0.76186
 SubSubCat_Venlafaxine | Seed 7: ATT = 0.9724, SE = 5.1240, p = 0.85873
 SubSubCat_Venlafaxine | Seed 8: ATT = 5.1916, SE = 9.3818, p = 0.60948
 SubSubCat_Venlafaxine | Seed 9: ATT = 0.5753, SE = 6.1339, p = 0.92979
 SubSubCat_Venlafaxine | Seed 10: ATT = -2.2502, SE = 6.8010, p = 0.75736
 Diagnostic plots saved for SubSubCat_Venlafaxine
 Best result for SubSubCat_Venlafaxine  Seed 5 | SE = 3.6995

 Running OLS for SubSubCat_Fluoxetine
 SubSubCat_Fluoxetine | Seed 1: ATT = 8.0300, SE = 4.8536, p = 0.17338
 SubSubCat_Fluoxetine | Seed 2: ATT = 7.0745, SE = 5.5404, p = 0.27073
 SubSubCat_Fluoxetine | Seed 3: ATT = 11.3230, SE = 3.7723, p = 0.03988
 SubSubCat_Fluoxetine | Seed 4: ATT = 10.4765, SE = 3.9700, p = 0.05765
 SubSubCat_Fluoxetine | Seed 5: ATT = 7.8891, SE = 4.9089, p = 0.18331
 SubSubCat_Fluoxetine | Seed 6: ATT = 9.8655, SE = 5.4607, p = 0.14511
 SubSubCat_Fluoxetine | Seed 7: ATT = 12.5184, SE = 2.9439, p = 0.01313
 SubSubCat_Fluoxetine | Seed 8: ATT = 8.5876, SE = 5.9673, p = 0.22352
 SubSubCat_Fluoxetine | Seed 9: ATT = 8.7987, SE = 7.6117, p = 0.31205
 SubSubCat_Fluoxetine | Seed 10: ATT = 11.1391, SE = 4.8424, p = 0.08291
 Diagnostic plots saved for SubSubCat_Fluoxetine
 Best result for SubSubCat_Fluoxetine  Seed 7 | SE = 2.9439

 Running OLS for SubSubCat_Topiramaat
 SubSubCat_Topiramaat | Seed 1: ATT = 13.3015, SE = 4.8106, p = 0.05059
 SubSubCat_Topiramaat | Seed 2: ATT = 9.8857, SE = 5.1641, p = 0.12810
 SubSubCat_Topiramaat | Seed 3: ATT = 6.6949, SE = 8.3684, p = 0.46852
 SubSubCat_Topiramaat | Seed 4: ATT = 11.4972, SE = 8.9600, p = 0.26873
 SubSubCat_Topiramaat | Seed 5: ATT = 9.6108, SE = 5.5170, p = 0.15647
 SubSubCat_Topiramaat | Seed 6: ATT = 15.2198, SE = 4.2888, p = 0.02383
 SubSubCat_Topiramaat | Seed 7: ATT = 10.2344, SE = 12.1861, p = 0.44826
 SubSubCat_Topiramaat | Seed 8: ATT = 9.3541, SE = 9.3720, p = 0.37472
 SubSubCat_Topiramaat | Seed 9: ATT = 15.7421, SE = 6.3339, p = 0.06782
 SubSubCat_Topiramaat | Seed 10: ATT = 13.0960, SE = 7.1642, p = 0.14156
 Diagnostic plots saved for SubSubCat_Topiramaat
 Best result for SubSubCat_Topiramaat  Seed 6 | SE = 4.2888

 Running OLS for SubSubCat_Zopiclon
 SubSubCat_Zopiclon | Seed 1: ATT = -3.4034, SE = 7.6118, p = 0.67793
 SubSubCat_Zopiclon | Seed 2: ATT = -8.1172, SE = 4.5400, p = 0.14831
 SubSubCat_Zopiclon | Seed 3: ATT = -5.4354, SE = 5.0071, p = 0.33873
 SubSubCat_Zopiclon | Seed 4: ATT = -3.8715, SE = 6.8900, p = 0.60417
 SubSubCat_Zopiclon | Seed 5: ATT = -5.2040, SE = 5.6908, p = 0.41221
 SubSubCat_Zopiclon | Seed 6: ATT = -5.6876, SE = 5.7538, p = 0.37887
 SubSubCat_Zopiclon | Seed 7: ATT = -7.5110, SE = 4.6776, p = 0.18360
 SubSubCat_Zopiclon | Seed 8: ATT = -6.6062, SE = 5.5988, p = 0.30340
 SubSubCat_Zopiclon | Seed 9: ATT = -8.5229, SE = 5.3016, p = 0.18320
 SubSubCat_Zopiclon | Seed 10: ATT = -4.7696, SE = 6.7115, p = 0.51654
 Diagnostic plots saved for SubSubCat_Zopiclon
 Best result for SubSubCat_Zopiclon  Seed 2 | SE = 4.5400

 Running OLS for SubSubCat_Bupropion
 SubSubCat_Bupropion | Seed 1: ATT = 0.0000, SE = 0.0000, p = 0.65904
 SubSubCat_Bupropion | Seed 2: ATT = 1.9031, SE = 5.0409, p = 0.72496
 SubSubCat_Bupropion | Seed 3: ATT = 2.9147, SE = 7.6319, p = 0.72195
 SubSubCat_Bupropion | Seed 4: ATT = -0.0000, SE = 0.0000, p = 0.56767
 SubSubCat_Bupropion | Seed 5: ATT = 2.6508, SE = 8.6528, p = 0.77462
 SubSubCat_Bupropion | Seed 6: ATT = 3.3167, SE = 9.3741, p = 0.74134
 SubSubCat_Bupropion | Seed 7: ATT = 1.7679, SE = 5.5052, p = 0.76420
 SubSubCat_Bupropion | Seed 8: ATT = 3.3089, SE = 8.5873, p = 0.71961
 SubSubCat_Bupropion | Seed 9: ATT = 1.8492, SE = 5.7064, p = 0.76213
 SubSubCat_Bupropion | Seed 10: ATT = 2.7567, SE = 7.7068, p = 0.73865
 Diagnostic plots saved for SubSubCat_Bupropion
 Best result for SubSubCat_Bupropion  Seed 4 | SE = 0.0000

 Running OLS for SubSubCat_Methylfenidaat
 SubSubCat_Methylfenidaat | Seed 1: ATT = 1.2736, SE = 8.2715, p = 0.88509
 SubSubCat_Methylfenidaat | Seed 2: ATT = 7.2626, SE = 8.1641, p = 0.42396
 SubSubCat_Methylfenidaat | Seed 3: ATT = -2.0394, SE = 14.3236, p = 0.89366
 SubSubCat_Methylfenidaat | Seed 4: ATT = 1.7182, SE = 11.0235, p = 0.88369
 SubSubCat_Methylfenidaat | Seed 5: ATT = 3.9980, SE = 13.4847, p = 0.78161
 SubSubCat_Methylfenidaat | Seed 6: ATT = 5.1151, SE = 11.8197, p = 0.68750
 SubSubCat_Methylfenidaat | Seed 7: ATT = 8.1028, SE = 9.0984, p = 0.42348
 SubSubCat_Methylfenidaat | Seed 8: ATT = 5.4834, SE = 8.6443, p = 0.56033
 SubSubCat_Methylfenidaat | Seed 9: ATT = 16.4400, SE = 17.3895, p = 0.39799
 SubSubCat_Methylfenidaat | Seed 10: ATT = 6.3121, SE = 9.3665, p = 0.53731
 Diagnostic plots saved for SubSubCat_Methylfenidaat
 Best result for SubSubCat_Methylfenidaat  Seed 2 | SE = 8.1641

 Running OLS for SubSubCat_Olanzapine
 SubSubCat_Olanzapine | Seed 1: ATT = -3.6463, SE = 6.9867, p = 0.62931
 SubSubCat_Olanzapine | Seed 2: ATT = 3.5398, SE = 12.4672, p = 0.79056
 SubSubCat_Olanzapine | Seed 3: ATT = 2.6412, SE = 5.5253, p = 0.65758
 SubSubCat_Olanzapine | Seed 4: ATT = 0.7456, SE = 6.2530, p = 0.91084
 SubSubCat_Olanzapine | Seed 5: ATT = 1.8099, SE = 12.9763, p = 0.89582
 SubSubCat_Olanzapine | Seed 6: ATT = 1.0811, SE = 6.7064, p = 0.87975
 SubSubCat_Olanzapine | Seed 7: ATT = 1.4871, SE = 9.4101, p = 0.88209
 SubSubCat_Olanzapine | Seed 8: ATT = -2.5111, SE = 7.4246, p = 0.75221
 SubSubCat_Olanzapine | Seed 9: ATT = -0.1586, SE = 8.5845, p = 0.98614
 SubSubCat_Olanzapine | Seed 10: ATT = 0.3364, SE = 5.1421, p = 0.95098
 Diagnostic plots saved for SubSubCat_Olanzapine
 Best result for SubSubCat_Olanzapine  Seed 10 | SE = 5.1421

 All summary files saved.
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=33707ec9-ca5a-413e-95df-a57b83ae905d">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[266]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Unweighted:</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=52d64785-d493-4aa1-8042-f15bddc87406">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[267]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">GradientBoostingRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">r2_score</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">KFold</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">t</span><span class="p">,</span> <span class="n">probplot</span>
<span class="kn">import</span> <span class="nn">xgboost</span> <span class="k">as</span> <span class="nn">xgb</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Configuration</span>
<span class="c1"># -----------------------------</span>
<span class="n">seeds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span>
<span class="n">imputations</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">output_folder</span> <span class="o">=</span> <span class="s2">"outputs"</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Diagnostic Plotting Function</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">create_diagnostic_plots</span><span class="p">(</span><span class="n">residuals_data</span><span class="p">,</span> <span class="n">fitted_data</span><span class="p">,</span> <span class="n">group_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Create 4 diagnostic plots for model validation"""</span>
    <span class="n">plots_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">"plots"</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">plots_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Flatten the collected data</span>
    <span class="n">all_residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">residuals_data</span><span class="p">)</span>
    <span class="n">all_fitted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">fitted_data</span><span class="p">)</span>
    
    <span class="c1"># Create figure with 2x2 subplots</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Diagnostic Plots - </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">'bold'</span><span class="p">)</span>
    
    <span class="c1"># 1. Residuals vs Fitted</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">all_fitted</span><span class="p">,</span> <span class="n">all_residuals</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Fitted Values'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Residuals'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Residuals vs Fitted'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># 2. QQ Plot</span>
    <span class="n">probplot</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s2">"norm"</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Q-Q Plot (Normal)'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># 3. Residual Histogram</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'skyblue'</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">'black'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Residuals'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Density'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Residual Distribution'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># 4. Scale-Location Plot</span>
    <span class="n">sqrt_abs_residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">all_residuals</span><span class="p">))</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">all_fitted</span><span class="p">,</span> <span class="n">sqrt_abs_residuals</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Fitted Values'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'|Residuals|'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Scale-Location Plot'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    
    <span class="c1"># Save plot</span>
    <span class="n">plot_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plots_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s1">_unweighted.png'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_filename</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">'tight'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Diagnostic plots saved for </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># Rubin's Rule</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">rubins_pool</span><span class="p">(</span><span class="n">estimates</span><span class="p">,</span> <span class="n">ses</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">estimates</span><span class="p">)</span>
    <span class="n">q_bar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">estimates</span><span class="p">)</span>
    <span class="n">u_bar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">ses</span><span class="p">))</span>
    <span class="n">b_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">estimates</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">total_var</span> <span class="o">=</span> <span class="n">u_bar</span> <span class="o">+</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">b_m</span><span class="p">)</span>
    <span class="n">total_se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">total_var</span><span class="p">)</span>
    <span class="n">ci_lower</span> <span class="o">=</span> <span class="n">q_bar</span> <span class="o">-</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">total_se</span>
    <span class="n">ci_upper</span> <span class="o">=</span> <span class="n">q_bar</span> <span class="o">+</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">total_se</span>
    <span class="n">p_value</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">q_bar</span> <span class="o">/</span> <span class="n">total_se</span><span class="p">),</span> <span class="n">df</span><span class="o">=</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">rounded_p</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">p_value</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">formatted_p</span> <span class="o">=</span> <span class="s2">"&lt; 0.00001"</span> <span class="k">if</span> <span class="n">rounded_p</span> <span class="o">&lt;=</span> <span class="mf">0.00001</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">rounded_p</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">return</span> <span class="n">q_bar</span><span class="p">,</span> <span class="n">total_se</span><span class="p">,</span> <span class="n">ci_lower</span><span class="p">,</span> <span class="n">ci_upper</span><span class="p">,</span> <span class="n">formatted_p</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># SMD + Variance Ratio</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">calculate_smd_vr</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
    <span class="n">treated</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">control</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">smd</span><span class="p">,</span> <span class="n">vr</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m1</span><span class="p">,</span> <span class="n">m0</span> <span class="o">=</span> <span class="n">treated</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">control</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">s1</span> <span class="o">=</span> <span class="n">treated</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
            <span class="n">s0</span> <span class="o">=</span> <span class="n">control</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
            <span class="n">pooled_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">s1</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">s0</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">smd</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">m1</span> <span class="o">-</span> <span class="n">m0</span><span class="p">)</span> <span class="o">/</span> <span class="n">pooled_sd</span> <span class="k">if</span> <span class="n">pooled_sd</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">vr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s1</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">s0</span><span class="o">**</span><span class="mi">2</span> <span class="k">if</span> <span class="n">s0</span><span class="o">**</span><span class="mi">2</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">smd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">vr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">smd</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">vr</span><span class="p">)</span>

<span class="c1"># -----------------------------</span>
<span class="c1"># OLS Main Loop</span>
<span class="c1"># -----------------------------</span>
<span class="k">def</span> <span class="nf">run_dml_with_trimmed_data</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="p">):</span>
    <span class="n">att_results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">balance_results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">covariates</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Running OLS for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">group_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">group_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">best_result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">best_se</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">"inf"</span><span class="p">)</span>
        
        <span class="c1"># Initialize lists to collect residuals and fitted values for diagnostic plots</span>
        <span class="n">group_residuals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">group_fitted</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="n">seeds</span><span class="p">:</span>
            <span class="c1"># Set random seed for this iteration</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
            
            <span class="n">att_list</span><span class="p">,</span> <span class="n">se_list</span><span class="p">,</span> <span class="n">r2_list</span><span class="p">,</span> <span class="n">rmse_list</span><span class="p">,</span> <span class="n">smd_list</span><span class="p">,</span> <span class="n">vr_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">imp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">imputations</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"trimmed_data_imp</span><span class="si">{</span><span class="n">imp</span><span class="si">}</span><span class="s2">.pkl"</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">or</span> <span class="s2">"iptw"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># Add bootstrap sampling with seed-based randomization</span>
                <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                <span class="n">bootstrap_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">df_bootstrap</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">bootstrap_idx</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="n">X</span> <span class="o">=</span> <span class="n">df_bootstrap</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">T</span> <span class="o">=</span> <span class="n">df_bootstrap</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
                <span class="n">Y</span> <span class="o">=</span> <span class="n">df_bootstrap</span><span class="p">[</span><span class="s2">"caps5_change_baseline"</span><span class="p">]</span>
                <span class="c1">#W = df_bootstrap["iptw"]</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Create design matrix with treatment variable and covariates</span>
                    <span class="n">X_ols</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">T</span><span class="p">,</span> <span class="n">X</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">X_ols</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">X_ols</span><span class="p">)</span>
                    
                    <span class="c1"># Fit OLS with robust standard errors (unweighted)</span>
                    <span class="n">ols_model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">X_ols</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">cov_type</span><span class="o">=</span><span class="s1">'HC1'</span><span class="p">)</span>
                    
                    <span class="c1"># Extract treatment effect (coefficient of treatment variable)</span>
                    <span class="n">att</span> <span class="o">=</span> <span class="n">ols_model</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>  <span class="c1"># Treatment coefficient</span>
                    <span class="n">se</span> <span class="o">=</span> <span class="n">ols_model</span><span class="o">.</span><span class="n">bse</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>  <span class="c1"># Robust standard error for treatment</span>
                    
                    <span class="n">att_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">att</span><span class="p">)</span>
                    <span class="n">se_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">se</span><span class="p">)</span>

                    <span class="c1"># Calculate model fit statistics</span>
                    <span class="n">Y_pred</span> <span class="o">=</span> <span class="n">ols_model</span><span class="o">.</span><span class="n">fittedvalues</span>
                    <span class="n">residuals</span> <span class="o">=</span> <span class="n">ols_model</span><span class="o">.</span><span class="n">resid</span>
                    <span class="n">rmse</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">Y_pred</span><span class="p">,</span> <span class="n">squared</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">r2</span> <span class="o">=</span> <span class="n">ols_model</span><span class="o">.</span><span class="n">rsquared</span>
                    <span class="n">r2_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
                    <span class="n">rmse_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rmse</span><span class="p">)</span>
                    
                    <span class="c1"># Collect residuals and fitted values for diagnostic plots</span>
                    <span class="n">group_residuals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">residuals</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                    <span class="n">group_fitted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Y_pred</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

                    <span class="n">smd</span><span class="p">,</span> <span class="n">vr</span> <span class="o">=</span> <span class="n">calculate_smd_vr</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
                    <span class="n">smd_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smd</span><span class="p">)</span>
                    <span class="n">vr_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vr</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">, seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">, imp </span><span class="si">{</span><span class="n">imp</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">att_list</span><span class="p">:</span>
                <span class="n">att</span><span class="p">,</span> <span class="n">se</span><span class="p">,</span> <span class="n">ci_l</span><span class="p">,</span> <span class="n">ci_u</span><span class="p">,</span> <span class="n">p_val</span> <span class="o">=</span> <span class="n">rubins_pool</span><span class="p">(</span><span class="n">att_list</span><span class="p">,</span> <span class="n">se_list</span><span class="p">)</span>
                <span class="n">avg_r2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">r2_list</span><span class="p">)</span>
                <span class="n">avg_rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rmse_list</span><span class="p">)</span>
                <span class="n">avg_smd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">smd_list</span><span class="p">)</span>
                <span class="n">avg_vr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">vr_list</span><span class="p">)</span>

                <span class="n">balance_results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">"group"</span><span class="p">:</span> <span class="n">group</span><span class="p">,</span> <span class="s2">"seed"</span><span class="p">:</span> <span class="n">seed</span><span class="p">,</span> <span class="s2">"smd"</span><span class="p">:</span> <span class="n">avg_smd</span><span class="p">,</span> <span class="s2">"vr"</span><span class="p">:</span> <span class="n">avg_vr</span>
                <span class="p">})</span>

                <span class="k">if</span> <span class="n">se</span> <span class="o">&lt;</span> <span class="n">best_se</span><span class="p">:</span>
                    <span class="n">best_se</span> <span class="o">=</span> <span class="n">se</span>
                    <span class="n">best_result</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">"group"</span><span class="p">:</span> <span class="n">group</span><span class="p">,</span> <span class="s2">"seed"</span><span class="p">:</span> <span class="n">seed</span><span class="p">,</span> <span class="s2">"att"</span><span class="p">:</span> <span class="n">att</span><span class="p">,</span> <span class="s2">"se"</span><span class="p">:</span> <span class="n">se</span><span class="p">,</span>
                        <span class="s2">"ci_lower"</span><span class="p">:</span> <span class="n">ci_l</span><span class="p">,</span> <span class="s2">"ci_upper"</span><span class="p">:</span> <span class="n">ci_u</span><span class="p">,</span> <span class="s2">"p_value"</span><span class="p">:</span> <span class="n">p_val</span><span class="p">,</span>
                        <span class="s2">"r2"</span><span class="p">:</span> <span class="n">avg_r2</span><span class="p">,</span> <span class="s2">"rmse"</span><span class="p">:</span> <span class="n">avg_rmse</span>
                    <span class="p">}</span>

                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> | Seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">: ATT = </span><span class="si">{</span><span class="n">att</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, SE = </span><span class="si">{</span><span class="n">se</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, p = </span><span class="si">{</span><span class="n">p_val</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" No valid results for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> | Seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Create diagnostic plots for this group</span>
        <span class="k">if</span> <span class="n">group_residuals</span> <span class="ow">and</span> <span class="n">group_fitted</span><span class="p">:</span>
            <span class="n">create_diagnostic_plots</span><span class="p">(</span><span class="n">group_residuals</span><span class="p">,</span> <span class="n">group_fitted</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">best_result</span><span class="p">:</span>
            <span class="n">att_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">best_result</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Best result for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">  Seed </span><span class="si">{</span><span class="n">best_result</span><span class="p">[</span><span class="s1">'seed'</span><span class="p">]</span><span class="si">}</span><span class="s2"> | SE = </span><span class="si">{</span><span class="n">best_result</span><span class="p">[</span><span class="s1">'se'</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="c1"># Save final output</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">att_results</span><span class="p">)</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">"ols_rubin_summary_subsubcats_unweighted.xlsx"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">balance_results</span><span class="p">)</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">"smd_vr_summary_subsubcats_unweighted.xlsx"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> All summary files saved."</span><span class="p">)</span>

<span class="n">run_dml_with_trimmed_data</span><span class="p">(</span><span class="n">final_covariates_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Running OLS for SubSubCat_Oxazepam
 SubSubCat_Oxazepam | Seed 1: ATT = 0.7187, SE = 1.5172, p = 0.66043
 SubSubCat_Oxazepam | Seed 2: ATT = 0.9364, SE = 1.5441, p = 0.57694
 SubSubCat_Oxazepam | Seed 3: ATT = 1.6006, SE = 1.6439, p = 0.38537
 SubSubCat_Oxazepam | Seed 4: ATT = 1.5106, SE = 2.1499, p = 0.52103
 SubSubCat_Oxazepam | Seed 5: ATT = 0.9480, SE = 2.2452, p = 0.69456
 SubSubCat_Oxazepam | Seed 6: ATT = 0.9398, SE = 1.4529, p = 0.55299
 SubSubCat_Oxazepam | Seed 7: ATT = 1.7766, SE = 1.9929, p = 0.42304
 SubSubCat_Oxazepam | Seed 8: ATT = 1.4453, SE = 1.9797, p = 0.50582
 SubSubCat_Oxazepam | Seed 9: ATT = 0.8379, SE = 1.6719, p = 0.64258
 SubSubCat_Oxazepam | Seed 10: ATT = -0.3180, SE = 1.4388, p = 0.83588
 Diagnostic plots saved for SubSubCat_Oxazepam
 Best result for SubSubCat_Oxazepam  Seed 10 | SE = 1.4388

 Running OLS for SubSubCat_Diazepam
 SubSubCat_Diazepam | Seed 1: ATT = -5.6622, SE = 5.4012, p = 0.35365
 SubSubCat_Diazepam | Seed 2: ATT = -0.7836, SE = 9.6544, p = 0.93921
 SubSubCat_Diazepam | Seed 3: ATT = -5.6317, SE = 7.8372, p = 0.51213
 SubSubCat_Diazepam | Seed 4: ATT = -5.6376, SE = 8.7739, p = 0.55550
 SubSubCat_Diazepam | Seed 5: ATT = -2.5936, SE = 8.9595, p = 0.78660
 SubSubCat_Diazepam | Seed 6: ATT = -7.3513, SE = 8.4688, p = 0.43434
 SubSubCat_Diazepam | Seed 7: ATT = 2.4403, SE = 10.9925, p = 0.83519
 SubSubCat_Diazepam | Seed 8: ATT = 1.5821, SE = 6.7495, p = 0.82618
 SubSubCat_Diazepam | Seed 9: ATT = -8.6176, SE = 8.0247, p = 0.34334
 SubSubCat_Diazepam | Seed 10: ATT = -6.2541, SE = 8.4219, p = 0.49897
 Diagnostic plots saved for SubSubCat_Diazepam
 Best result for SubSubCat_Diazepam  Seed 1 | SE = 5.4012

 Running OLS for SubSubCat_Paracetamol
 SubSubCat_Paracetamol | Seed 1: ATT = 5.6750, SE = 6.7420, p = 0.44732
 SubSubCat_Paracetamol | Seed 2: ATT = 6.6908, SE = 8.4590, p = 0.47322
 SubSubCat_Paracetamol | Seed 3: ATT = 8.1838, SE = 7.0645, p = 0.31114
 SubSubCat_Paracetamol | Seed 4: ATT = 9.2914, SE = 8.8216, p = 0.35164
 SubSubCat_Paracetamol | Seed 5: ATT = 4.4102, SE = 11.0407, p = 0.70997
 SubSubCat_Paracetamol | Seed 6: ATT = 7.1450, SE = 7.3321, p = 0.38500
 SubSubCat_Paracetamol | Seed 7: ATT = 7.8703, SE = 10.7523, p = 0.50476
 SubSubCat_Paracetamol | Seed 8: ATT = 10.6276, SE = 10.6481, p = 0.37473
 SubSubCat_Paracetamol | Seed 9: ATT = 8.5652, SE = 8.7697, p = 0.38403
 SubSubCat_Paracetamol | Seed 10: ATT = 4.3597, SE = 7.6587, p = 0.59963
 Diagnostic plots saved for SubSubCat_Paracetamol
 Best result for SubSubCat_Paracetamol  Seed 1 | SE = 6.7420

 Running OLS for SubSubCat_Lorazepam
 SubSubCat_Lorazepam | Seed 1: ATT = 2.2418, SE = 4.9580, p = 0.67459
 SubSubCat_Lorazepam | Seed 2: ATT = -0.6019, SE = 3.2605, p = 0.86252
 SubSubCat_Lorazepam | Seed 3: ATT = 3.6950, SE = 5.1205, p = 0.51046
 SubSubCat_Lorazepam | Seed 4: ATT = 2.6744, SE = 3.9839, p = 0.53881
 SubSubCat_Lorazepam | Seed 5: ATT = 2.1189, SE = 4.9227, p = 0.68905
 SubSubCat_Lorazepam | Seed 6: ATT = 1.6942, SE = 5.4474, p = 0.77132
 SubSubCat_Lorazepam | Seed 7: ATT = 3.1173, SE = 4.2647, p = 0.50531
 SubSubCat_Lorazepam | Seed 8: ATT = 2.1054, SE = 3.9459, p = 0.62191
 SubSubCat_Lorazepam | Seed 9: ATT = 2.3992, SE = 3.6368, p = 0.54549
 SubSubCat_Lorazepam | Seed 10: ATT = 2.2980, SE = 6.0759, p = 0.72449
 Diagnostic plots saved for SubSubCat_Lorazepam
 Best result for SubSubCat_Lorazepam  Seed 2 | SE = 3.2605

 Running OLS for SubSubCat_Mirtazapine
 SubSubCat_Mirtazapine | Seed 1: ATT = 5.6273, SE = 2.6996, p = 0.10549
 SubSubCat_Mirtazapine | Seed 2: ATT = 5.6228, SE = 3.6015, p = 0.19349
 SubSubCat_Mirtazapine | Seed 3: ATT = 5.2933, SE = 3.3187, p = 0.18594
 SubSubCat_Mirtazapine | Seed 4: ATT = 6.2623, SE = 3.9698, p = 0.18982
 SubSubCat_Mirtazapine | Seed 5: ATT = 7.5136, SE = 2.9204, p = 0.06179
 SubSubCat_Mirtazapine | Seed 6: ATT = 5.7026, SE = 2.9237, p = 0.12288
 SubSubCat_Mirtazapine | Seed 7: ATT = 5.2939, SE = 3.8093, p = 0.23696
 SubSubCat_Mirtazapine | Seed 8: ATT = 6.5266, SE = 3.8255, p = 0.16319
 SubSubCat_Mirtazapine | Seed 9: ATT = 5.4262, SE = 3.2831, p = 0.17372
 SubSubCat_Mirtazapine | Seed 10: ATT = 5.3874, SE = 4.3037, p = 0.27885
 Diagnostic plots saved for SubSubCat_Mirtazapine
 Best result for SubSubCat_Mirtazapine  Seed 1 | SE = 2.6996

 Running OLS for SubSubCat_Escitalopram
 SubSubCat_Escitalopram | Seed 1: ATT = 1.3626, SE = 6.6100, p = 0.84675
 SubSubCat_Escitalopram | Seed 2: ATT = -2.7086, SE = 5.9659, p = 0.67336
 SubSubCat_Escitalopram | Seed 3: ATT = 2.6039, SE = 9.1622, p = 0.79036
 SubSubCat_Escitalopram | Seed 4: ATT = -0.9371, SE = 6.8215, p = 0.89737
 SubSubCat_Escitalopram | Seed 5: ATT = -1.4247, SE = 5.9793, p = 0.82337
 SubSubCat_Escitalopram | Seed 6: ATT = -5.8344, SE = 6.5242, p = 0.42173
 SubSubCat_Escitalopram | Seed 7: ATT = 0.5671, SE = 8.3219, p = 0.94894
 SubSubCat_Escitalopram | Seed 8: ATT = -0.8498, SE = 5.2165, p = 0.87848
 SubSubCat_Escitalopram | Seed 9: ATT = 0.0799, SE = 7.7937, p = 0.99231
 SubSubCat_Escitalopram | Seed 10: ATT = -1.0531, SE = 6.1295, p = 0.87193
 Diagnostic plots saved for SubSubCat_Escitalopram
 Best result for SubSubCat_Escitalopram  Seed 8 | SE = 5.2165

 Running OLS for SubSubCat_Sertraline
 SubSubCat_Sertraline | Seed 1: ATT = 2.5554, SE = 2.8860, p = 0.42594
 SubSubCat_Sertraline | Seed 2: ATT = 2.7575, SE = 3.1607, p = 0.43221
 SubSubCat_Sertraline | Seed 3: ATT = 0.7885, SE = 2.1416, p = 0.73141
 SubSubCat_Sertraline | Seed 4: ATT = 0.3651, SE = 2.3071, p = 0.88194
 SubSubCat_Sertraline | Seed 5: ATT = 0.6895, SE = 3.7874, p = 0.86440
 SubSubCat_Sertraline | Seed 6: ATT = 1.5273, SE = 2.6146, p = 0.59048
 SubSubCat_Sertraline | Seed 7: ATT = 1.3328, SE = 2.9679, p = 0.67664
 SubSubCat_Sertraline | Seed 8: ATT = 1.3411, SE = 2.8546, p = 0.66296
 SubSubCat_Sertraline | Seed 9: ATT = 1.8309, SE = 3.2201, p = 0.60004
 SubSubCat_Sertraline | Seed 10: ATT = 2.3640, SE = 3.2004, p = 0.50111
 Diagnostic plots saved for SubSubCat_Sertraline
 Best result for SubSubCat_Sertraline  Seed 3 | SE = 2.1416

 Running OLS for SubSubCat_Temazepam
 SubSubCat_Temazepam | Seed 1: ATT = 2.0496, SE = 3.2240, p = 0.55950
 SubSubCat_Temazepam | Seed 2: ATT = 0.7698, SE = 6.3993, p = 0.91005
 SubSubCat_Temazepam | Seed 3: ATT = 2.7725, SE = 3.1839, p = 0.43302
 SubSubCat_Temazepam | Seed 4: ATT = 2.3003, SE = 3.9286, p = 0.58963
 SubSubCat_Temazepam | Seed 5: ATT = 0.1424, SE = 3.9233, p = 0.97278
 SubSubCat_Temazepam | Seed 6: ATT = 2.7917, SE = 5.3564, p = 0.62976
 SubSubCat_Temazepam | Seed 7: ATT = 1.2793, SE = 3.5462, p = 0.73653
 SubSubCat_Temazepam | Seed 8: ATT = -0.3347, SE = 3.5303, p = 0.92904
 SubSubCat_Temazepam | Seed 9: ATT = -0.3023, SE = 4.5186, p = 0.94987
 SubSubCat_Temazepam | Seed 10: ATT = 1.5304, SE = 5.3840, p = 0.79033
 Diagnostic plots saved for SubSubCat_Temazepam
 Best result for SubSubCat_Temazepam  Seed 3 | SE = 3.1839

 Running OLS for SubSubCat_Citalopram
 SubSubCat_Citalopram | Seed 1: ATT = -4.6982, SE = 3.4850, p = 0.24890
 SubSubCat_Citalopram | Seed 2: ATT = -5.6106, SE = 4.5588, p = 0.28585
 SubSubCat_Citalopram | Seed 3: ATT = -5.1144, SE = 3.4332, p = 0.21055
 SubSubCat_Citalopram | Seed 4: ATT = -6.4234, SE = 3.1794, p = 0.11345
 SubSubCat_Citalopram | Seed 5: ATT = -6.1142, SE = 2.8352, p = 0.09727
 SubSubCat_Citalopram | Seed 6: ATT = -6.2808, SE = 3.4674, p = 0.14432
 SubSubCat_Citalopram | Seed 7: ATT = -3.8690, SE = 3.3895, p = 0.31737
 SubSubCat_Citalopram | Seed 8: ATT = -4.8892, SE = 3.6717, p = 0.25382
 SubSubCat_Citalopram | Seed 9: ATT = -5.0837, SE = 2.4680, p = 0.10848
 SubSubCat_Citalopram | Seed 10: ATT = -4.7327, SE = 3.4350, p = 0.24033
 Diagnostic plots saved for SubSubCat_Citalopram
 Best result for SubSubCat_Citalopram  Seed 9 | SE = 2.4680

 Running OLS for SubSubCat_Quetiapine
 SubSubCat_Quetiapine | Seed 1: ATT = 1.6904, SE = 1.7761, p = 0.39512
 SubSubCat_Quetiapine | Seed 2: ATT = 2.3149, SE = 2.9305, p = 0.47377
 SubSubCat_Quetiapine | Seed 3: ATT = 2.2541, SE = 1.7689, p = 0.27156
 SubSubCat_Quetiapine | Seed 4: ATT = 2.7038, SE = 2.2318, p = 0.29239
 SubSubCat_Quetiapine | Seed 5: ATT = 1.5479, SE = 2.2916, p = 0.53641
 SubSubCat_Quetiapine | Seed 6: ATT = 1.9809, SE = 2.6817, p = 0.50110
 SubSubCat_Quetiapine | Seed 7: ATT = 3.4291, SE = 2.5843, p = 0.25522
 SubSubCat_Quetiapine | Seed 8: ATT = 2.6223, SE = 2.3029, p = 0.31841
 SubSubCat_Quetiapine | Seed 9: ATT = 2.0119, SE = 2.4199, p = 0.45249
 SubSubCat_Quetiapine | Seed 10: ATT = 1.7767, SE = 1.4068, p = 0.27522
 Diagnostic plots saved for SubSubCat_Quetiapine
 Best result for SubSubCat_Quetiapine  Seed 10 | SE = 1.4068

 Running OLS for SubSubCat_Amitriptyline
 SubSubCat_Amitriptyline | Seed 1: ATT = 11.7404, SE = 16.7821, p = 0.52274
 SubSubCat_Amitriptyline | Seed 2: ATT = 15.6951, SE = 12.1067, p = 0.26457
 SubSubCat_Amitriptyline | Seed 3: ATT = 5.6273, SE = 11.3403, p = 0.64577
 SubSubCat_Amitriptyline | Seed 4: ATT = 7.6439, SE = 15.1075, p = 0.63949
 SubSubCat_Amitriptyline | Seed 5: ATT = 8.4376, SE = 9.6965, p = 0.43332
 SubSubCat_Amitriptyline | Seed 6: ATT = 7.7133, SE = 19.2415, p = 0.70901
 SubSubCat_Amitriptyline | Seed 7: ATT = 17.1304, SE = 12.4555, p = 0.24103
 SubSubCat_Amitriptyline | Seed 8: ATT = 15.6706, SE = 14.1349, p = 0.32975
 SubSubCat_Amitriptyline | Seed 9: ATT = 20.9402, SE = 14.0677, p = 0.21084
 SubSubCat_Amitriptyline | Seed 10: ATT = 10.5706, SE = 12.5536, p = 0.44717
 Diagnostic plots saved for SubSubCat_Amitriptyline
 Best result for SubSubCat_Amitriptyline  Seed 5 | SE = 9.6965

 Running OLS for SubSubCat_Venlafaxine
 SubSubCat_Venlafaxine | Seed 1: ATT = -0.0652, SE = 6.8886, p = 0.99290
 SubSubCat_Venlafaxine | Seed 2: ATT = -6.1866, SE = 9.2762, p = 0.54131
 SubSubCat_Venlafaxine | Seed 3: ATT = 0.8383, SE = 10.6266, p = 0.94091
 SubSubCat_Venlafaxine | Seed 4: ATT = 1.2724, SE = 8.3634, p = 0.88644
 SubSubCat_Venlafaxine | Seed 5: ATT = -1.8611, SE = 5.5204, p = 0.75296
 SubSubCat_Venlafaxine | Seed 6: ATT = 0.0123, SE = 7.6212, p = 0.99879
 SubSubCat_Venlafaxine | Seed 7: ATT = -0.2856, SE = 5.3304, p = 0.95984
 SubSubCat_Venlafaxine | Seed 8: ATT = 4.7558, SE = 10.9343, p = 0.68604
 SubSubCat_Venlafaxine | Seed 9: ATT = 0.3922, SE = 9.4837, p = 0.96899
 SubSubCat_Venlafaxine | Seed 10: ATT = -3.6042, SE = 6.8094, p = 0.62461
 Diagnostic plots saved for SubSubCat_Venlafaxine
 Best result for SubSubCat_Venlafaxine  Seed 7 | SE = 5.3304

 Running OLS for SubSubCat_Fluoxetine
 SubSubCat_Fluoxetine | Seed 1: ATT = 8.3367, SE = 4.9752, p = 0.16912
 SubSubCat_Fluoxetine | Seed 2: ATT = 7.0653, SE = 5.2782, p = 0.25172
 SubSubCat_Fluoxetine | Seed 3: ATT = 9.6790, SE = 4.3898, p = 0.09215
 SubSubCat_Fluoxetine | Seed 4: ATT = 9.3573, SE = 3.5893, p = 0.05961
 SubSubCat_Fluoxetine | Seed 5: ATT = 7.6744, SE = 4.9976, p = 0.19943
 SubSubCat_Fluoxetine | Seed 6: ATT = 8.2564, SE = 5.0144, p = 0.17500
 SubSubCat_Fluoxetine | Seed 7: ATT = 12.3462, SE = 4.0496, p = 0.03808
 SubSubCat_Fluoxetine | Seed 8: ATT = 8.4987, SE = 6.0682, p = 0.23396
 SubSubCat_Fluoxetine | Seed 9: ATT = 7.4001, SE = 8.5954, p = 0.43782
 SubSubCat_Fluoxetine | Seed 10: ATT = 10.1965, SE = 5.6039, p = 0.14295
 Diagnostic plots saved for SubSubCat_Fluoxetine
 Best result for SubSubCat_Fluoxetine  Seed 4 | SE = 3.5893

 Running OLS for SubSubCat_Topiramaat
 SubSubCat_Topiramaat | Seed 1: ATT = 12.6590, SE = 7.2918, p = 0.15756
 SubSubCat_Topiramaat | Seed 2: ATT = 7.9133, SE = 5.7128, p = 0.23824
 SubSubCat_Topiramaat | Seed 3: ATT = 6.0593, SE = 5.1618, p = 0.30557
 SubSubCat_Topiramaat | Seed 4: ATT = 10.8172, SE = 7.8396, p = 0.23975
 SubSubCat_Topiramaat | Seed 5: ATT = 8.5103, SE = 6.9414, p = 0.28743
 SubSubCat_Topiramaat | Seed 6: ATT = 14.0764, SE = 5.6571, p = 0.06761
 SubSubCat_Topiramaat | Seed 7: ATT = 7.9187, SE = 9.3296, p = 0.44382
 SubSubCat_Topiramaat | Seed 8: ATT = 8.0656, SE = 8.0887, p = 0.37513
 SubSubCat_Topiramaat | Seed 9: ATT = 12.7322, SE = 7.0997, p = 0.14738
 SubSubCat_Topiramaat | Seed 10: ATT = 11.0649, SE = 7.6758, p = 0.22288
 Diagnostic plots saved for SubSubCat_Topiramaat
 Best result for SubSubCat_Topiramaat  Seed 3 | SE = 5.1618

 Running OLS for SubSubCat_Zopiclon
 SubSubCat_Zopiclon | Seed 1: ATT = -4.5978, SE = 9.3252, p = 0.64782
 SubSubCat_Zopiclon | Seed 2: ATT = -9.0664, SE = 5.1847, p = 0.15525
 SubSubCat_Zopiclon | Seed 3: ATT = -6.0705, SE = 6.3214, p = 0.39128
 SubSubCat_Zopiclon | Seed 4: ATT = -4.2508, SE = 7.4912, p = 0.60074
 SubSubCat_Zopiclon | Seed 5: ATT = -6.1300, SE = 6.1917, p = 0.37821
 SubSubCat_Zopiclon | Seed 6: ATT = -6.8818, SE = 7.1915, p = 0.39279
 SubSubCat_Zopiclon | Seed 7: ATT = -7.2118, SE = 5.5583, p = 0.26424
 SubSubCat_Zopiclon | Seed 8: ATT = -6.5212, SE = 7.2382, p = 0.41856
 SubSubCat_Zopiclon | Seed 9: ATT = -9.1053, SE = 5.5709, p = 0.17751
 SubSubCat_Zopiclon | Seed 10: ATT = -5.9644, SE = 6.8506, p = 0.43308
 Diagnostic plots saved for SubSubCat_Zopiclon
 Best result for SubSubCat_Zopiclon  Seed 2 | SE = 5.1847

 Running OLS for SubSubCat_Bupropion
 SubSubCat_Bupropion | Seed 1: ATT = 0.0000, SE = 0.0000, p = 0.74100
 SubSubCat_Bupropion | Seed 2: ATT = 1.6658, SE = 4.6406, p = 0.73776
 SubSubCat_Bupropion | Seed 3: ATT = 2.8825, SE = 7.5473, p = 0.72194
 SubSubCat_Bupropion | Seed 4: ATT = 0.0000, SE = 0.0000, p = 0.59583
 SubSubCat_Bupropion | Seed 5: ATT = 2.6649, SE = 8.6822, p = 0.77421
 SubSubCat_Bupropion | Seed 6: ATT = 3.3188, SE = 9.3804, p = 0.74135
 SubSubCat_Bupropion | Seed 7: ATT = 1.6194, SE = 5.3799, p = 0.77840
 SubSubCat_Bupropion | Seed 8: ATT = 3.2901, SE = 8.5426, p = 0.71974
 SubSubCat_Bupropion | Seed 9: ATT = 2.0273, SE = 6.1831, p = 0.75945
 SubSubCat_Bupropion | Seed 10: ATT = 2.5955, SE = 7.5069, p = 0.74695
 Diagnostic plots saved for SubSubCat_Bupropion
 Best result for SubSubCat_Bupropion  Seed 4 | SE = 0.0000

 Running OLS for SubSubCat_Methylfenidaat
 SubSubCat_Methylfenidaat | Seed 1: ATT = 0.5565, SE = 8.4860, p = 0.95086
 SubSubCat_Methylfenidaat | Seed 2: ATT = 7.0260, SE = 8.5873, p = 0.45919
 SubSubCat_Methylfenidaat | Seed 3: ATT = -1.7596, SE = 14.6986, p = 0.91049
 SubSubCat_Methylfenidaat | Seed 4: ATT = 1.7681, SE = 11.4598, p = 0.88485
 SubSubCat_Methylfenidaat | Seed 5: ATT = 3.9116, SE = 13.9259, p = 0.79273
 SubSubCat_Methylfenidaat | Seed 6: ATT = 3.8593, SE = 11.6069, p = 0.75621
 SubSubCat_Methylfenidaat | Seed 7: ATT = 8.5847, SE = 9.6469, p = 0.42381
 SubSubCat_Methylfenidaat | Seed 8: ATT = 5.4399, SE = 10.5747, p = 0.63407
 SubSubCat_Methylfenidaat | Seed 9: ATT = 16.0336, SE = 18.0344, p = 0.42421
 SubSubCat_Methylfenidaat | Seed 10: ATT = 6.3929, SE = 10.5520, p = 0.57732
 Diagnostic plots saved for SubSubCat_Methylfenidaat
 Best result for SubSubCat_Methylfenidaat  Seed 1 | SE = 8.4860

 Running OLS for SubSubCat_Olanzapine
 SubSubCat_Olanzapine | Seed 1: ATT = -3.6856, SE = 7.3057, p = 0.64045
 SubSubCat_Olanzapine | Seed 2: ATT = 4.9211, SE = 11.6277, p = 0.69390
 SubSubCat_Olanzapine | Seed 3: ATT = 1.3447, SE = 5.9286, p = 0.83169
 SubSubCat_Olanzapine | Seed 4: ATT = 0.0228, SE = 7.0031, p = 0.99755
 SubSubCat_Olanzapine | Seed 5: ATT = 2.5935, SE = 9.9952, p = 0.80808
 SubSubCat_Olanzapine | Seed 6: ATT = 1.2520, SE = 6.7536, p = 0.86195
 SubSubCat_Olanzapine | Seed 7: ATT = 0.0785, SE = 9.4068, p = 0.99374
 SubSubCat_Olanzapine | Seed 8: ATT = -4.4360, SE = 9.2460, p = 0.65644
 SubSubCat_Olanzapine | Seed 9: ATT = -0.1102, SE = 9.6211, p = 0.99141
 SubSubCat_Olanzapine | Seed 10: ATT = -0.1043, SE = 6.1361, p = 0.98726
 Diagnostic plots saved for SubSubCat_Olanzapine
 Best result for SubSubCat_Olanzapine  Seed 3 | SE = 5.9286

 All summary files saved.
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=23e02efd-519d-4712-b990-4d017532db01">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[268]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">sem</span><span class="p">,</span> <span class="n">ttest_ind</span>

<span class="c1"># ----------------------------------</span>
<span class="c1"># File paths</span>
<span class="c1"># ----------------------------------</span>
<span class="n">output_base</span> <span class="o">=</span> <span class="s2">"outputs"</span>
<span class="n">att_file</span> <span class="o">=</span> <span class="s2">"ols_rubin_summary_subsubcats.xlsx"</span>
<span class="n">trimmed_file</span> <span class="o">=</span> <span class="s2">"trimmed_data_imp1.pkl"</span>
<span class="n">auc_file</span> <span class="o">=</span> <span class="s2">"auc_scores.xlsx"</span>  <span class="c1"># NEW</span>

<span class="c1"># ----------------------------------</span>
<span class="c1"># Load ATT Summary</span>
<span class="c1"># ----------------------------------</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">att_file</span><span class="p">):</span>
    <span class="n">att_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">att_file</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">" ATT summary file not found: ols_summary_subsubcats.xlsx"</span><span class="p">)</span>

<span class="n">summary_rows</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># ----------------------------------</span>
<span class="c1"># Loop over medication groups</span>
<span class="c1"># ----------------------------------</span>
<span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">medication_groups</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">g</span><span class="p">))]</span>

<span class="k">for</span> <span class="n">med</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">group_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">med</span><span class="p">)</span>

        <span class="c1"># Load trimmed data</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="n">trimmed_file</span><span class="p">))</span>

        <span class="c1"># Detect treatment column</span>
        <span class="n">treatment_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">med</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">treatment_cols</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Treatment column </span><span class="si">{</span><span class="n">med</span><span class="si">}</span><span class="s2"> not found in trimmed data. Skipping."</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">treatment_var</span> <span class="o">=</span> <span class="n">treatment_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Extract treatment and outcome</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">"caps5_change_baseline"</span><span class="p">]</span>

        <span class="c1"># Treated and control stats</span>
        <span class="n">treated</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">control</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>

        <span class="n">mean_treat</span> <span class="o">=</span> <span class="n">treated</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">se_treat</span> <span class="o">=</span> <span class="n">sem</span><span class="p">(</span><span class="n">treated</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">treated</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">mean_ctrl</span> <span class="o">=</span> <span class="n">control</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">se_ctrl</span> <span class="o">=</span> <span class="n">sem</span><span class="p">(</span><span class="n">control</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">control</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Cohen's d (unadjusted)</span>
        <span class="n">pooled_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">treated</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">control</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">cohen_d</span> <span class="o">=</span> <span class="p">(</span><span class="n">mean_treat</span> <span class="o">-</span> <span class="n">mean_ctrl</span><span class="p">)</span> <span class="o">/</span> <span class="n">pooled_sd</span> <span class="k">if</span> <span class="n">pooled_sd</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># E-value (unadjusted)</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">mean_treat</span> <span class="o">-</span> <span class="n">mean_ctrl</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">delta</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">mean_ctrl</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">mean_ctrl</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Unadjusted p-value</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">t_stat</span><span class="p">,</span> <span class="n">p_val</span> <span class="o">=</span> <span class="n">ttest_ind</span><span class="p">(</span><span class="n">treated</span><span class="p">,</span> <span class="n">control</span><span class="p">,</span> <span class="n">equal_var</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nan_policy</span><span class="o">=</span><span class="s2">"omit"</span><span class="p">)</span>
            <span class="n">rounded_p</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">p_val</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="n">formatted_p</span> <span class="o">=</span> <span class="s2">"&lt; 0.00001"</span> <span class="k">if</span> <span class="n">rounded_p</span> <span class="o">&lt;</span> <span class="mf">0.00001</span> <span class="k">else</span> <span class="n">rounded_p</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">formatted_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># AUC from new auc_scores.xlsx file</span>
        <span class="n">auc_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">auc_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="n">auc_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">auc_path</span><span class="p">):</span>
            <span class="n">auc_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">auc_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">"AUC"</span> <span class="ow">in</span> <span class="n">auc_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">auc_val</span> <span class="o">=</span> <span class="n">auc_df</span><span class="p">[</span><span class="s2">"AUC"</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="c1"># Adjusted stats from Rubin summary</span>
        <span class="n">att_row</span> <span class="o">=</span> <span class="n">att_df</span><span class="p">[</span><span class="n">att_df</span><span class="p">[</span><span class="s2">"group"</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">med</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">att_row</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">att</span> <span class="o">=</span> <span class="n">att_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"att"</span><span class="p">]</span>
            <span class="n">att_se</span> <span class="o">=</span> <span class="n">att_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"se"</span><span class="p">]</span>
            <span class="n">att_p_val</span> <span class="o">=</span> <span class="n">att_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"p_value"</span><span class="p">]</span>
            <span class="n">r2</span> <span class="o">=</span> <span class="n">att_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"r2"</span><span class="p">]</span>
            <span class="n">rmse</span> <span class="o">=</span> <span class="n">att_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"rmse"</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">rounded_att_p</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">att_p_val</span><span class="p">),</span> <span class="mi">5</span><span class="p">)</span>
                <span class="n">formatted_att_p</span> <span class="o">=</span> <span class="s2">"&lt; 0.00001"</span> <span class="k">if</span> <span class="n">rounded_att_p</span> <span class="o">&lt;</span> <span class="mf">0.00001</span> <span class="k">else</span> <span class="n">rounded_att_p</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">formatted_att_p</span> <span class="o">=</span> <span class="n">att_p_val</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">att</span><span class="p">,</span> <span class="n">att_se</span><span class="p">,</span> <span class="n">formatted_att_p</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Append full row</span>
        <span class="n">summary_rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">'Medication Group'</span><span class="p">:</span> <span class="n">med</span><span class="p">,</span>
            <span class="s1">'Mean Treated'</span><span class="p">:</span> <span class="n">mean_treat</span><span class="p">,</span>
            <span class="s1">'SE Treated'</span><span class="p">:</span> <span class="n">se_treat</span><span class="p">,</span>
            <span class="s1">'Mean Control'</span><span class="p">:</span> <span class="n">mean_ctrl</span><span class="p">,</span>
            <span class="s1">'SE Control'</span><span class="p">:</span> <span class="n">se_ctrl</span><span class="p">,</span>
            <span class="s1">'Cohen d'</span><span class="p">:</span> <span class="n">cohen_d</span><span class="p">,</span>
            <span class="s1">'E (Unadjusted)'</span><span class="p">:</span> <span class="n">E</span><span class="p">,</span>
            <span class="s1">'n Treated'</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">treated</span><span class="p">),</span>
            <span class="s1">'n Control'</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">control</span><span class="p">),</span>
            <span class="c1">#'Unadjusted p-value': formatted_p,</span>
            <span class="s1">'ATT Estimate'</span><span class="p">:</span> <span class="n">att</span><span class="p">,</span>
            <span class="s1">'ATT SE (Robust)'</span><span class="p">:</span> <span class="n">att_se</span><span class="p">,</span>
            <span class="s1">'ATT p-value'</span><span class="p">:</span> <span class="n">formatted_att_p</span><span class="p">,</span>
            <span class="s1">'R'</span><span class="p">:</span> <span class="n">r2</span><span class="p">,</span>
            <span class="s1">'RMSE'</span><span class="p">:</span> <span class="n">rmse</span><span class="p">,</span>
            <span class="s1">'AUC'</span><span class="p">:</span> <span class="n">auc_val</span>
        <span class="p">})</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error in </span><span class="si">{</span><span class="n">med</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># ----------------------------------</span>
<span class="c1"># Save final summary</span>
<span class="c1"># ----------------------------------</span>
<span class="n">summary_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">summary_rows</span><span class="p">)</span>
<span class="n">summary_df</span> <span class="o">=</span> <span class="n">summary_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">"Medication Group"</span><span class="p">)</span>
<span class="n">summary_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">"Final_ATT_Summary_SubSubCat.xlsx"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">" Final_ATT_Summary_SubSubCat saved"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre> Final_ATT_Summary_SubSubCat saved
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=fb3090fc-bcf4-4134-ba0e-4aebd0c93537">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[269]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.backends.backend_pdf</span> <span class="kn">import</span> <span class="n">PdfPages</span>

<span class="c1">#  Load the final summary table</span>
<span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s2">"Final_ATT_Summary_SubSubCat.xlsx"</span><span class="p">)</span>

<span class="c1">#  Parse DML p-values (handle "&lt; 0.00001")</span>
<span class="k">def</span> <span class="nf">parse_pval</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">"&lt;"</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.000001</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

<span class="n">final_df</span><span class="p">[</span><span class="s1">'ATT p-value'</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="s1">'ATT p-value'</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">parse_pval</span><span class="p">)</span>

<span class="c1">#  Plot settings</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>

<span class="c1">#  Plotting function for a single medication group</span>
<span class="k">def</span> <span class="nf">plot_single_group</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    
    <span class="n">bars1</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="o">-</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">'Mean Control'</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> 
                   <span class="n">yerr</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">'SE Control'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">'Control'</span><span class="p">,</span> <span class="n">hatch</span><span class="o">=</span><span class="s1">'//'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">bars2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="o">+</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">'Mean Treated'</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> 
                   <span class="n">yerr</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">'SE Treated'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">'Treated'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'steelblue'</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

    <span class="n">label</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">"ATT = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'ATT Estimate'</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span>
        <span class="sa">f</span><span class="s2">"d = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'Cohen d'</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, p = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'ATT p-value'</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span>
        <span class="sa">f</span><span class="s2">"nT = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'n Treated'</span><span class="p">]</span><span class="si">}</span><span class="s2">, nC = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'n Control'</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span>
        <span class="sa">f</span><span class="s2">"E = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'E (Unadjusted)'</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%"</span>
    <span class="p">)</span>
    <span class="n">max_y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">'Mean Control'</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">'Mean Treated'</span><span class="p">])</span> <span class="o">+</span> <span class="mf">1.5</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_y</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">'center'</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">'bottom'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'#FFD700'</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'black'</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="o">-</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">+</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">'Control'</span><span class="p">,</span> <span class="s1">'Treated'</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Group: </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">'Medication Group'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">'bold'</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"CAPS5 Change Score"</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="n">max_y</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">fig</span>

<span class="c1">#  Generate and save all plots into a multi-page PDF</span>
<span class="k">with</span> <span class="n">PdfPages</span><span class="p">(</span><span class="s2">"ols_att_barplot_subsubcat.pdf"</span><span class="p">)</span> <span class="k">as</span> <span class="n">pdf</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">final_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_single_group</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="n">pdf</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">'tight'</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">" ols_att_barplot_subsubcat saved"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre> ols_att_barplot_subsubcat saved
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=1ca0cd05-2cb6-4516-b20d-55a74f23e2d4">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[270]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Love plot:</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=bf7bf994-5ff3-4c95-8be8-2903b37e2f15">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[271]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="c1"># ----------------------------------------</span>
<span class="c1"># Functions to calculate balance</span>
<span class="c1"># ----------------------------------------</span>
<span class="k">def</span> <span class="nf">calculate_smd</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">w1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">w2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">weighted_mean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span> <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">weighted_var</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">m</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
    
    <span class="n">m1</span> <span class="o">=</span> <span class="n">weighted_mean</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">w1</span><span class="p">)</span> <span class="k">if</span> <span class="n">w1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
    <span class="n">m2</span> <span class="o">=</span> <span class="n">weighted_mean</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span> <span class="k">if</span> <span class="n">w2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">weighted_var</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">w1</span><span class="p">)</span> <span class="k">if</span> <span class="n">w1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">weighted_var</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span> <span class="k">if</span> <span class="n">w2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">pooled_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">v1</span> <span class="o">+</span> <span class="n">v2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">m1</span> <span class="o">-</span> <span class="n">m2</span><span class="p">)</span> <span class="o">/</span> <span class="n">pooled_sd</span> <span class="k">if</span> <span class="n">pooled_sd</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">variance_ratio</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">w1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">w2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">weighted_var</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">m</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
    
    <span class="n">v1</span> <span class="o">=</span> <span class="n">weighted_var</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">w1</span><span class="p">)</span> <span class="k">if</span> <span class="n">w1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">weighted_var</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span> <span class="k">if</span> <span class="n">w2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">v1</span> <span class="o">/</span> <span class="n">v2</span><span class="p">,</span> <span class="n">v2</span> <span class="o">/</span> <span class="n">v1</span><span class="p">)</span> <span class="k">if</span> <span class="n">v1</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">v2</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>

<span class="c1"># ----------------------------------------</span>
<span class="c1"># Setup</span>
<span class="c1"># ----------------------------------------</span>
<span class="n">output_base</span> <span class="o">=</span> <span class="s2">"outputs"</span>
<span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">output_base</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">g</span><span class="p">))]</span>

<span class="c1"># Create a case-insensitive mapping</span>
<span class="n">final_covariates_map_lower</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">final_covariates_map</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="c1"># ----------------------------------------</span>
<span class="c1"># Main Loop</span>
<span class="c1"># ----------------------------------------</span>
<span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">group</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_covariates_map_lower</span><span class="p">:</span>
        <span class="k">continue</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2"> Processing </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">..."</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">group_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_base</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">covariates</span> <span class="o">=</span> <span class="n">final_covariates_map_lower</span><span class="p">[</span><span class="n">group</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        
        <span class="n">column_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="s2">"trimmed_data_imp1.pkl"</span><span class="p">))</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">group</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">column_name</span> <span class="o">=</span> <span class="n">col</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">column_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Column not found for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">, skipping."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">smd_unw_all</span><span class="p">,</span> <span class="n">smd_w_all</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">vr_unw_all</span><span class="p">,</span> <span class="n">vr_w_all</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
            <span class="n">df_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"trimmed_data_imp</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.pkl"</span><span class="p">)</span>
            <span class="n">iptw_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="s2">"iptw_weights.xlsx"</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">df_path</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">iptw_path</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Missing data for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> imp</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, skipping."</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">df_path</span><span class="p">)</span>
            <span class="n">iptw_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">iptw_path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span>
            <span class="n">W</span> <span class="o">=</span> <span class="n">iptw_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s2">"iptw_mean"</span><span class="p">]</span>

            <span class="n">smd_unw_i</span><span class="p">,</span> <span class="n">smd_w_i</span><span class="p">,</span> <span class="n">vr_unw_i</span><span class="p">,</span> <span class="n">vr_w_i</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">cov</span> <span class="ow">in</span> <span class="n">covariates</span><span class="p">:</span>
                <span class="n">x1</span><span class="p">,</span> <span class="n">x0</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cov</span><span class="p">],</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cov</span><span class="p">]</span>
                <span class="n">w1</span><span class="p">,</span> <span class="n">w0</span> <span class="o">=</span> <span class="n">W</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">1</span><span class="p">],</span> <span class="n">W</span><span class="p">[</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>

                <span class="n">su</span> <span class="o">=</span> <span class="n">calculate_smd</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x0</span><span class="p">)</span>
                <span class="n">sw</span> <span class="o">=</span> <span class="n">calculate_smd</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">w0</span><span class="p">)</span>

                <span class="n">vu</span> <span class="o">=</span> <span class="n">variance_ratio</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x0</span><span class="p">)</span> <span class="k">if</span> <span class="n">cov</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">]</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">vw</span> <span class="o">=</span> <span class="n">variance_ratio</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">w0</span><span class="p">)</span> <span class="k">if</span> <span class="n">cov</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">]</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

                <span class="n">smd_unw_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">su</span><span class="p">)</span>
                <span class="n">smd_w_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sw</span><span class="p">)</span>
                <span class="n">vr_unw_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vu</span><span class="p">)</span>
                <span class="n">vr_w_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vw</span><span class="p">)</span>

            <span class="n">smd_unw_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smd_unw_i</span><span class="p">)</span>
            <span class="n">smd_w_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smd_w_i</span><span class="p">)</span>
            <span class="n">vr_unw_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vr_unw_i</span><span class="p">)</span>
            <span class="n">vr_w_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vr_w_i</span><span class="p">)</span>

        <span class="n">smd_unw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">smd_unw_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">smd_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">smd_w_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">vr_unw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">vr_unw_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">vr_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">vr_w_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">severity</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sw</span> <span class="ow">in</span> <span class="n">smd_w</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sw</span> <span class="o">&lt;=</span> <span class="mf">0.1</span><span class="p">:</span>
                <span class="n">severity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"Good"</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">sw</span> <span class="o">&lt;=</span> <span class="mf">0.2</span><span class="p">:</span>
                <span class="n">severity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"Moderate"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">severity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"Poor"</span><span class="p">)</span>

        <span class="n">covariate_names</span> <span class="o">=</span> <span class="n">covariates</span>
        <span class="n">numeric_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s2">"Covariate"</span><span class="p">:</span> <span class="n">covariate_names</span><span class="p">,</span>
            <span class="s2">"SMD_Unweighted"</span><span class="p">:</span> <span class="n">smd_unw</span><span class="p">,</span>
            <span class="s2">"SMD_Weighted"</span><span class="p">:</span> <span class="n">smd_w</span><span class="p">,</span>
            <span class="s2">"Imbalance_Severity"</span><span class="p">:</span> <span class="n">severity</span><span class="p">,</span>
            <span class="s2">"VR_Unweighted"</span><span class="p">:</span> <span class="n">vr_unw</span><span class="p">,</span>
            <span class="s2">"VR_Weighted"</span><span class="p">:</span> <span class="n">vr_w</span>
        <span class="p">})</span>

        <span class="n">numeric_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"covariate_balance_table_</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">.xlsx"</span><span class="p">)</span>
        <span class="n">numeric_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">numeric_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Exported numeric summary to: </span><span class="si">{</span><span class="n">numeric_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># -------------------------</span>
        <span class="c1"># Plot</span>
        <span class="c1"># -------------------------</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">covariates</span>
        <span class="n">y_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.45</span><span class="p">))</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">smd_unw</span><span class="p">,</span> <span class="n">y_pos</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Unweighted"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">smd_w</span><span class="p">,</span> <span class="n">y_pos</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'blue'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Weighted"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Threshold 0.1"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'black'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Threshold 0.2"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">smd_unw</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">smd_w</span><span class="p">),</span> <span class="mf">0.25</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">y_pos</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Standardized Mean Differences (SMD)"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">"upper right"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">vr_mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">cov</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'treatmentdurationdays'</span><span class="p">,</span> <span class="s1">'CAPS5score_baseline'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">]</span> <span class="k">for</span> <span class="n">cov</span> <span class="ow">in</span> <span class="n">covariates</span><span class="p">]</span>
        <span class="n">filtered_y</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vr_mask</span><span class="p">)</span> <span class="k">if</span> <span class="n">b</span><span class="p">]</span>
        <span class="n">filtered_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">filtered_y</span><span class="p">]</span>
        <span class="n">filtered_vr_unw</span> <span class="o">=</span> <span class="p">[</span><span class="n">vr_unw</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">filtered_y</span><span class="p">]</span>
        <span class="n">filtered_vr_w</span> <span class="o">=</span> <span class="p">[</span><span class="n">vr_w</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">filtered_y</span><span class="p">]</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">filtered_vr_unw</span><span class="p">,</span> <span class="n">filtered_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'blue'</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">'o'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Unweighted"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">filtered_vr_w</span><span class="p">,</span> <span class="n">filtered_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">'x'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Weighted"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">filtered_vr_unw</span> <span class="o">+</span> <span class="n">filtered_vr_w</span> <span class="o">+</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">])</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">filtered_y</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">filtered_labels</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Variance Ratio (VR)"</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Covariate Balance for </span><span class="si">{</span><span class="n">group</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'CAT_'</span><span class="p">,</span><span class="w"> </span><span class="s1">''</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">'bold'</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.96</span><span class="p">])</span>
        <span class="n">plot_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"love_plot_</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">.pdf"</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Saved love plot: </span><span class="si">{</span><span class="n">plot_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Max weighted SMD for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">smd_w</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
 Processing SUBSUBCAT_Amitriptyline...
 Exported numeric summary to: outputs\SUBSUBCAT_Amitriptyline\covariate_balance_table_SUBSUBCAT_Amitriptyline.xlsx
 Saved love plot: outputs\SUBSUBCAT_Amitriptyline\love_plot_SUBSUBCAT_Amitriptyline.pdf
 Max weighted SMD for SUBSUBCAT_Amitriptyline: 0.917

 Processing SUBSUBCAT_Bupropion...
 Error in SUBSUBCAT_Bupropion: Weights sum to zero, can't be normalized

 Processing SUBSUBCAT_Citalopram...
 Exported numeric summary to: outputs\SUBSUBCAT_Citalopram\covariate_balance_table_SUBSUBCAT_Citalopram.xlsx
 Saved love plot: outputs\SUBSUBCAT_Citalopram\love_plot_SUBSUBCAT_Citalopram.pdf
 Max weighted SMD for SUBSUBCAT_Citalopram: 0.133

 Processing SUBSUBCAT_Diazepam...
 Exported numeric summary to: outputs\SUBSUBCAT_Diazepam\covariate_balance_table_SUBSUBCAT_Diazepam.xlsx
 Saved love plot: outputs\SUBSUBCAT_Diazepam\love_plot_SUBSUBCAT_Diazepam.pdf
 Max weighted SMD for SUBSUBCAT_Diazepam: 0.599

 Processing SUBSUBCAT_Escitalopram...
 Exported numeric summary to: outputs\SUBSUBCAT_Escitalopram\covariate_balance_table_SUBSUBCAT_Escitalopram.xlsx
 Saved love plot: outputs\SUBSUBCAT_Escitalopram\love_plot_SUBSUBCAT_Escitalopram.pdf
 Max weighted SMD for SUBSUBCAT_Escitalopram: 0.423

 Processing SUBSUBCAT_Fluoxetine...
 Exported numeric summary to: outputs\SUBSUBCAT_Fluoxetine\covariate_balance_table_SUBSUBCAT_Fluoxetine.xlsx
 Saved love plot: outputs\SUBSUBCAT_Fluoxetine\love_plot_SUBSUBCAT_Fluoxetine.pdf
 Max weighted SMD for SUBSUBCAT_Fluoxetine: 0.496

 Processing SUBSUBCAT_Lorazepam...
 Exported numeric summary to: outputs\SUBSUBCAT_Lorazepam\covariate_balance_table_SUBSUBCAT_Lorazepam.xlsx
 Saved love plot: outputs\SUBSUBCAT_Lorazepam\love_plot_SUBSUBCAT_Lorazepam.pdf
 Max weighted SMD for SUBSUBCAT_Lorazepam: 0.270

 Processing SUBSUBCAT_Methylfenidaat...
 Exported numeric summary to: outputs\SUBSUBCAT_Methylfenidaat\covariate_balance_table_SUBSUBCAT_Methylfenidaat.xlsx
 Saved love plot: outputs\SUBSUBCAT_Methylfenidaat\love_plot_SUBSUBCAT_Methylfenidaat.pdf
 Max weighted SMD for SUBSUBCAT_Methylfenidaat: 0.746

 Processing SUBSUBCAT_Mirtazapine...
 Exported numeric summary to: outputs\SUBSUBCAT_Mirtazapine\covariate_balance_table_SUBSUBCAT_Mirtazapine.xlsx
 Saved love plot: outputs\SUBSUBCAT_Mirtazapine\love_plot_SUBSUBCAT_Mirtazapine.pdf
 Max weighted SMD for SUBSUBCAT_Mirtazapine: 0.218

 Processing SUBSUBCAT_Olanzapine...
 Exported numeric summary to: outputs\SUBSUBCAT_Olanzapine\covariate_balance_table_SUBSUBCAT_Olanzapine.xlsx
 Saved love plot: outputs\SUBSUBCAT_Olanzapine\love_plot_SUBSUBCAT_Olanzapine.pdf
 Max weighted SMD for SUBSUBCAT_Olanzapine: 0.819

 Processing SUBSUBCAT_Oxazepam...
 Exported numeric summary to: outputs\SUBSUBCAT_Oxazepam\covariate_balance_table_SUBSUBCAT_Oxazepam.xlsx
 Saved love plot: outputs\SUBSUBCAT_Oxazepam\love_plot_SUBSUBCAT_Oxazepam.pdf
 Max weighted SMD for SUBSUBCAT_Oxazepam: 0.204

 Processing SUBSUBCAT_Paracetamol...
 Exported numeric summary to: outputs\SUBSUBCAT_Paracetamol\covariate_balance_table_SUBSUBCAT_Paracetamol.xlsx
 Saved love plot: outputs\SUBSUBCAT_Paracetamol\love_plot_SUBSUBCAT_Paracetamol.pdf
 Max weighted SMD for SUBSUBCAT_Paracetamol: 0.466

 Processing SUBSUBCAT_Quetiapine...
 Exported numeric summary to: outputs\SUBSUBCAT_Quetiapine\covariate_balance_table_SUBSUBCAT_Quetiapine.xlsx
 Saved love plot: outputs\SUBSUBCAT_Quetiapine\love_plot_SUBSUBCAT_Quetiapine.pdf
 Max weighted SMD for SUBSUBCAT_Quetiapine: 0.201

 Processing SUBSUBCAT_Sertraline...
 Exported numeric summary to: outputs\SUBSUBCAT_Sertraline\covariate_balance_table_SUBSUBCAT_Sertraline.xlsx
 Saved love plot: outputs\SUBSUBCAT_Sertraline\love_plot_SUBSUBCAT_Sertraline.pdf
 Max weighted SMD for SUBSUBCAT_Sertraline: 0.281

 Processing SUBSUBCAT_Temazepam...
 Exported numeric summary to: outputs\SUBSUBCAT_Temazepam\covariate_balance_table_SUBSUBCAT_Temazepam.xlsx
 Saved love plot: outputs\SUBSUBCAT_Temazepam\love_plot_SUBSUBCAT_Temazepam.pdf
 Max weighted SMD for SUBSUBCAT_Temazepam: 0.291

 Processing SUBSUBCAT_Topiramaat...
 Exported numeric summary to: outputs\SUBSUBCAT_Topiramaat\covariate_balance_table_SUBSUBCAT_Topiramaat.xlsx
 Saved love plot: outputs\SUBSUBCAT_Topiramaat\love_plot_SUBSUBCAT_Topiramaat.pdf
 Max weighted SMD for SUBSUBCAT_Topiramaat: 0.415

 Processing SUBSUBCAT_Venlafaxine...
 Exported numeric summary to: outputs\SUBSUBCAT_Venlafaxine\covariate_balance_table_SUBSUBCAT_Venlafaxine.xlsx
 Saved love plot: outputs\SUBSUBCAT_Venlafaxine\love_plot_SUBSUBCAT_Venlafaxine.pdf
 Max weighted SMD for SUBSUBCAT_Venlafaxine: 0.631

 Processing SUBSUBCAT_Zopiclon...
 Exported numeric summary to: outputs\SUBSUBCAT_Zopiclon\covariate_balance_table_SUBSUBCAT_Zopiclon.xlsx
 Saved love plot: outputs\SUBSUBCAT_Zopiclon\love_plot_SUBSUBCAT_Zopiclon.pdf
 Max weighted SMD for SUBSUBCAT_Zopiclon: 0.692
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=351cdcc2-c480-437b-a023-c81a95efbb47">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[272]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Heatmap:</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=1f2a0c4e-78d3-42d2-b3f4-7aa21c575faa">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[273]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="c1">#-----------------------------</span>
<span class="c1"># Generate heatmaps</span>
<span class="c1"># -------------------------------</span>
<span class="k">for</span> <span class="n">treatment_var</span> <span class="ow">in</span> <span class="n">medication_groups</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">========== Creating Heatmap for </span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s2"> =========="</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">'outputs'</span><span class="p">,</span> <span class="n">treatment_var</span><span class="p">)</span>
        <span class="n">balance_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'covariate_balance_table_</span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s1">.xlsx'</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">balance_path</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Balance file not found: </span><span class="si">{</span><span class="n">balance_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">balance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">balance_path</span><span class="p">)</span>

        <span class="c1">#  Use finalized covariates + 'Propensity Score'</span>
        <span class="n">covariates</span> <span class="o">=</span> <span class="n">final_covariates_map</span><span class="p">[</span><span class="n">treatment_var</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">'Propensity Score'</span><span class="p">]</span>
        <span class="n">balance_df</span> <span class="o">=</span> <span class="n">balance_df</span><span class="p">[</span><span class="n">balance_df</span><span class="p">[</span><span class="s1">'Covariate'</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">covariates</span><span class="p">)]</span>

        <span class="c1">#  Check for CAPS5score_baseline</span>
        <span class="n">highlight_caps</span> <span class="o">=</span> <span class="s1">'CAPS5score_baseline'</span> <span class="ow">in</span> <span class="n">balance_df</span><span class="p">[</span><span class="s1">'Covariate'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="c1">#  Format for heatmap</span>
        <span class="n">heatmap_df</span> <span class="o">=</span> <span class="n">balance_df</span><span class="p">[[</span><span class="s1">'Covariate'</span><span class="p">,</span> <span class="s1">'SMD_Unweighted'</span><span class="p">,</span> <span class="s1">'SMD_Weighted'</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">heatmap_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'Covariate'</span><span class="p">,</span> <span class="s1">'Unweighted'</span><span class="p">,</span> <span class="s1">'Weighted'</span><span class="p">]</span>
        <span class="n">heatmap_df</span> <span class="o">=</span> <span class="n">heatmap_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">'Covariate'</span><span class="p">)</span>
        <span class="n">heatmap_df</span> <span class="o">=</span> <span class="n">heatmap_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">'Unweighted'</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1">#  Plot</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">heatmap_df</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.35</span><span class="p">)))</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span>
            <span class="n">heatmap_df</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="s2">"coolwarm"</span><span class="p">,</span>
            <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">fmt</span><span class="o">=</span><span class="s2">".2f"</span><span class="p">,</span>
            <span class="n">linewidths</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
            <span class="n">linecolor</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span>
            <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">"label"</span><span class="p">:</span> <span class="s2">"Standardized Mean Difference"</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Covariate Balance Heatmap (Rubin IPTW)</span><span class="se">\n</span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">'bold'</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Condition"</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"Covariate"</span><span class="p">)</span>

        <span class="c1">#  Bold CAPS5score_baseline if present</span>
        <span class="k">if</span> <span class="n">highlight_caps</span><span class="p">:</span>
            <span class="n">ylabels</span> <span class="o">=</span> <span class="p">[</span><span class="n">label</span><span class="o">.</span><span class="n">get_text</span><span class="p">()</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span>
                <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2"> "</span> <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="s1">'CAPS5score_baseline'</span> <span class="k">else</span> <span class="n">label</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ylabels</span>
            <span class="p">])</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="c1">#  Save image</span>
        <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'heatmap_smd_</span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s1">.png'</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Heatmap saved: </span><span class="si">{</span><span class="n">save_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Error processing </span><span class="si">{</span><span class="n">treatment_var</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>
========== Creating Heatmap for SubSubCat_Oxazepam ==========
 Heatmap saved: outputs\SubSubCat_Oxazepam\heatmap_smd_SubSubCat_Oxazepam.png

========== Creating Heatmap for SubSubCat_Diazepam ==========
 Heatmap saved: outputs\SubSubCat_Diazepam\heatmap_smd_SubSubCat_Diazepam.png

========== Creating Heatmap for SubSubCat_Paracetamol ==========
 Heatmap saved: outputs\SubSubCat_Paracetamol\heatmap_smd_SubSubCat_Paracetamol.png

========== Creating Heatmap for SubSubCat_Lorazepam ==========
 Heatmap saved: outputs\SubSubCat_Lorazepam\heatmap_smd_SubSubCat_Lorazepam.png

========== Creating Heatmap for SubSubCat_Mirtazapine ==========
 Heatmap saved: outputs\SubSubCat_Mirtazapine\heatmap_smd_SubSubCat_Mirtazapine.png

========== Creating Heatmap for SubSubCat_Escitalopram ==========
 Heatmap saved: outputs\SubSubCat_Escitalopram\heatmap_smd_SubSubCat_Escitalopram.png

========== Creating Heatmap for SubSubCat_Sertraline ==========
 Heatmap saved: outputs\SubSubCat_Sertraline\heatmap_smd_SubSubCat_Sertraline.png

========== Creating Heatmap for SubSubCat_Temazepam ==========
 Heatmap saved: outputs\SubSubCat_Temazepam\heatmap_smd_SubSubCat_Temazepam.png

========== Creating Heatmap for SubSubCat_Citalopram ==========
 Heatmap saved: outputs\SubSubCat_Citalopram\heatmap_smd_SubSubCat_Citalopram.png

========== Creating Heatmap for SubSubCat_Quetiapine ==========
 Heatmap saved: outputs\SubSubCat_Quetiapine\heatmap_smd_SubSubCat_Quetiapine.png

========== Creating Heatmap for SubSubCat_Amitriptyline ==========
 Heatmap saved: outputs\SubSubCat_Amitriptyline\heatmap_smd_SubSubCat_Amitriptyline.png

========== Creating Heatmap for SubSubCat_Venlafaxine ==========
 Heatmap saved: outputs\SubSubCat_Venlafaxine\heatmap_smd_SubSubCat_Venlafaxine.png

========== Creating Heatmap for SubSubCat_Fluoxetine ==========
 Heatmap saved: outputs\SubSubCat_Fluoxetine\heatmap_smd_SubSubCat_Fluoxetine.png

========== Creating Heatmap for SubSubCat_Topiramaat ==========
 Heatmap saved: outputs\SubSubCat_Topiramaat\heatmap_smd_SubSubCat_Topiramaat.png

========== Creating Heatmap for SubSubCat_Zopiclon ==========
 Heatmap saved: outputs\SubSubCat_Zopiclon\heatmap_smd_SubSubCat_Zopiclon.png

========== Creating Heatmap for SubSubCat_Bupropion ==========
 Balance file not found: outputs\SubSubCat_Bupropion\covariate_balance_table_SubSubCat_Bupropion.xlsx

========== Creating Heatmap for SubSubCat_Methylfenidaat ==========
 Heatmap saved: outputs\SubSubCat_Methylfenidaat\heatmap_smd_SubSubCat_Methylfenidaat.png

========== Creating Heatmap for SubSubCat_Olanzapine ==========
 Heatmap saved: outputs\SubSubCat_Olanzapine\heatmap_smd_SubSubCat_Olanzapine.png
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=e91c1872-86ad-4dd6-9015-795fe70a59d4">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span> 
</pre></div>
</div>
</div>
</div>
</div>
</div>
</main>
</body>
</html>
